+ [author](http://nsddd.top)

# 第13节 go context 上下文

<div><a href = '12.md' style='float:left'>⬆️上一节🔗  </a><a href = '14.md' style='float: right'>  ⬇️下一节🔗</a></div>
<br>

> ❤️💕💕记录[sealos](https://github.com/3293172751/sealos)开源项目的学习过程。[k8s,docker和云原生的学习](https://github.com/3293172751/sealos)。Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## context

针对项目中进程出现的 context 学习

::: tip 参考

+ https://segmentfault.com/a/1190000040917752



:::

::: warning  控制并发的方式
控制并发的方式有两种：

1. WaitGroup
2. context

:::



## 我们需要它

::: tip 
WaitGroup 很容易实现，我们两个协程需要控制一个协程执行完毕，再执行另一个协程。

但是有一个问题，我可能需要去通知这个 job 去停止，需要主动通知停止？

很容易想到 [Channel (channel + select)](https://go.nsddd.top/markdown/19.html) 解决问题。

但是我们可以想到一个问题，如果我们有多个 goroutine ，或者 goroutine 中有 goruntime 我们该怎么样去解决问题？

⚡ 使用 context
:::



我们在之前的 各个协程（函数）返回中知道了，协程可以嵌套，甚至可以不断调用下去。

context 或许可以等待一个时间，一段时间后无论有多少协程，统统结束掉。

**第一层超时，后面全部超时**

::: tip
 `context`可以用来在`goroutine`之间传递上下文信息，相同的`context`可以传递给运行在不同`goroutine`中的函数，上下文对于多个`goroutine`同时使用是安全的，`context`包定义了上下文类型，可以使用`background`、`TODO`创建一个上下文，在函数调用链之间传播`context`，也可以使用`WithDeadline`、`WithTimeout`、`WithCancel` 或 `WithValue` 创建的修改副本替换它，听起来有点绕，其实总结起就是一句话：`context`的作用就是在不同的`goroutine`之间同步请求特定的数据、取消信号以及处理请求的截止日期。

目前我们常用的一些库都是支持`context`的，例如`gin`、`database/sql`等库都是支持`context`的，这样更方便我们做并发控制了，只要在服务器入口创建一个`context`上下文，不断透传下去即可。
:::

## 创建`context`

`context`包主要提供了两种方式创建`context`:

+ `context.Backgroud()`
+ `context.TODO()`



这两个函数其实只是互为别名，没有差别，官方给的定义是：

+ `context.Background` 是上下文的默认值，所有其他的上下文都应该从它衍生（Derived）出来(最上层的）。
+ `context.TODO` 应该只在不确定应该使用哪种上下文时使用；



上面的两种方式是创建根`context`，不具备任何功能，具体实践还是要依靠`context`包提供的`With`系列函数来进行派生：

```go
func WithCancel(parent Context) (ctx Context, cancel CancelFunc)
func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)
func WithValue(parent Context, key, val interface{}) Context
```







## END 链接

<ul><li><div><a href = '12.md' style='float:left'>⬆️上一节🔗  </a><a href = '14.md' style='float: right'>  ️下一节🔗</a></div></li></ul>

+ [Ⓜ️回到目录🏠](../README.md)

+ [**🫵参与贡献💞❤️‍🔥💖**](https://nsddd.top/archives/contributors))

+ ✴️版权声明 &copy; ：本书所有内容遵循[CC-BY-SA 3.0协议（署名-相同方式共享）&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0协议文本) 

