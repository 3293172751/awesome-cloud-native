+ [author](http://nsddd.top)

# 第14节 调试方式

<div><a href = '13.md' style='float:left'>⬆️上一节🔗  </a><a href = '15.md' style='float: right'>  ⬇️下一节🔗</a></div>
<br>

> ❤️💕💕记录[sealos](https://github.com/3293172751/sealos)开源项目的学习过程。[k8s,docker和云原生的学习](https://github.com/3293172751/sealos)。Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## 调试Go工程

::: tip 
prepare：

+ vscode
+ golang 1.92

:::



### demo

```
go mod init test
```



In `main.go` file 

```go
package main

import (
	"fmt"
)

// Swap functions
func swap(x, y *string) (string, string) {
	//XOR exchange
	*x, *y = *y, *x
}

func main() {
	fmt.Println("Hello, world!")
	//Swap functions
	for i := 0; i < 10; i++ {
		a := "a"
		b := "b"
		swap(&a, &b)
		fmt.Println(a, b)
	}
}
```



## vscode一键生成测试

```
>gotest for package/function
```

::: tip 
分别是为包生成测试单元，为函数生成测试单元。
:::



**生成如下：**

```go
package main

import (
	"testing"
)

func Test_main(t *testing.T) {
	tests := []struct {
		name string
	}{
		// TODO: Add test cases.
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			main()
		})
	}
}

func Test_swap(t *testing.T) {
	type args struct {
		x *string
		y *string
	}
	tests := []struct {
		name  string
		args  args
		want  string
		want1 string
	}{
		// TODO: Add test cases.
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got, got1 := swap(tt.args.x, tt.args.y)
			if got != tt.want {
				t.Errorf("swap() got = %v, want %v", got, tt.want)
			}
			if got1 != tt.want1 {
				t.Errorf("swap() got1 = %v, want %v", got1, tt.want1)
			}
		})
	}
}

```



**我们在 `TODO: Add test cases.` 那边给出测试就好了：**

也有快捷键，我们先加入一个 `{}`：

```
>go:file struct
```

 生成：

```go
package main

import (
	"testing"
)

func Test_main(t *testing.T) {
	tests := []struct {
		name string
	}{
		// TODO: Add test cases.
		{
			name: "test",
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			main()
		})
	}
}

func Test_swap(t *testing.T) {
	type args struct {
		x *string
		y *string
	}
	tests := []struct {
		name  string
		args  args
		want  string
		want1 string
	}{
		// TODO: Add test cases.
		{
		name: "afsdfwe",
		args: args{
			x: 12,
			y: 214,
		},
		want:  "shabi",
		want1: "wangshan ",
	},
	{
		name: "23asdfs",
		args: args{
			x: 1254,
			y: 421,
		},
		want:  "afswedwe",
		want1: "3erasfdsa",
	},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got, got1 := swap(tt.args.x, tt.args.y)
			if got != tt.want {
				t.Errorf("swap() got = %v, want %v", got, tt.want)
			}
			if got1 != tt.want1 {
				t.Errorf("swap() got1 = %v, want %v", got1, tt.want1)
			}
		})
	}
}

```





## vscode 远程调试

**创建 `.vscode` 文件夹（mod rootfs目录），并在下面创建：**

+ 创建`settings.json`

+ 创建 `launch.json` 写入

  ```json
  {
      //Use IntelliSense to learn about related properties.
      //Hover to see a description of an existing property.
      //For more information, please visit: https://go.microsoft.com/fwlink/?linkid=830387
      "version": "0.2.0",
      "configurations": [
          {
              "name": "Connect to server",
              "type": "go",
              "request": "attach",
              "mode": "remote",
              "remotePath": "/workspace/sealer",
              "port": 22,
              "host": "192.168.71.130"
          },
          {
              "name": "Launch file",
              "type": "go",
              "request": "launch",
              "mode": "debug",
              "program": "${file}"
          }
      ]
  }
  ```



::: warning 
方便起见可以直接在调试窗口一键创建

:::



## 安装 dlv

```bash
git clone https://github.com/go-delve/delve.git $GOPATH/src/github.com/go-delve/delve
cd $GOPATH/src/github.com/go-delve/delve
make install
export PATH=$PATH:$GOPATH/bin

dlv version
```

**或者使用 get：**

```bash
go get github.com/derekparker/delve/cmd/dlv
```



## 添加debug方案

另外，需要给Visual Code添加对应的debug方案（debug configuration）。在Visual Code的菜单栏上，通过Debug->Open Configurations打开launch.json的编辑界面。在configurations数组中，加入以下内容后，保存文件。

```json
{
    "name": "Launch remote",
    "type": "go",
    "request": "launch",
    "mode": "remote",
    "remotePath": "/root/go/src/hello",
    "port": 2345,
    "host": "192.168.33.123",
    "program": "${fileDirname}",
    "env": {}
}
```



### 执行方法

dlv的debug远程调试需要远端和近端都持有全部的源代码文件。为了方便，这里就不改变GOPATH，在远端直接将整个项目，扔到 `$GOPATH/src` 里面。

源代码文件路径为 `$GOPATH/src/hello/main.go`

在近端，直接创建 `hello`目录，就把源代码文件直接放在里面。

```bash
dlv debug --headless --listen ":2345" --log --api-version 2
```

画面显示以下内容则说明dlv服务端已经就绪。

```bash
API server listening at: [::]:2345
INFO[0004] launching process with args: [/root/go/src/hello/debug]  layer=debugger
```

然后，回到Visual Code进入debug界面，选择“Launch remote”方案后，点击启动来进行go debugger，就能启动远程调试。大部分的操作和本地调试无异，堆栈、变量、watch都能正常使用。



## 总结

通过Visual Code+dlv来进行go程序的远程调试，对“开发用Windows，生产用Linux”之类的场合下，调试与系统相关的问题非常有帮助。而且，Visual Code的图形界面和代码提示实在是相当方便。

但是debug这个做法有两点不完善的地方。第一个是它原理上需要远端对源代码进行编译，局限了它在除了开发测试环境外的使用场景，也使得每次调试都得等它编译；另一个是因为远端和近端都得有相同的源代码，无论是dlv还是 Visual Code的Go插件，目前都没法自动将本地改动过的代码上传到远端去。



## END 链接
<ul><li><div><a href = '13.md' style='float:left'>⬆️上一节🔗  </a><a href = '15.md' style='float: right'>  ️下一节🔗</a></div></li></ul>

+ [Ⓜ️回到目录🏠](../README.md)

+ [**🫵参与贡献💞❤️‍🔥💖**](https://nsddd.top/archives/contributors))

+ ✴️版权声明 &copy; ：本书所有内容遵循[CC-BY-SA 3.0协议（署名-相同方式共享）&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0协议文本) 

