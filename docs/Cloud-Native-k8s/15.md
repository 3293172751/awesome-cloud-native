+ [author](http://nsddd.top)

# 第15节 k3s 补充

<div><a href = '14.md' style='float:left'>⬆️上一节🔗  </a><a href = '16.md' style='float: right'>  ⬇️下一节🔗</a></div>
<br>

> ❤️💕💕新时代拥抱云原生，云原生具有环境统一、按需付费、即开即用、稳定性强特点。Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[toc]]

[TOC]

::: danger 
页面内容太多卡顿，新开后半部分补充~

+ [k3s vs k0s](https://docker.nsddd.top/Cloud-Native/7.html)

:::



## 资源分析

资源占用率低是 k3s 突出的特点，针对 k3s 特性，分析资源的占用：



**影响资源利用率的因素：**

- `K3s server`：K3s server 的利用率数据主要是由支持 Kubernetes 数据存储（kine 或 etcd）、API Server、Controller-Manager 和 Scheduler 控制。 **创建/修改/删除** 资源将导致暂时的利用率上升。大量使用 Kubernetes 数据存储的 operators 或应用程序也将增加 server 的资源需求。

- `K3s agent`：管理镜像、提供 **存储或创建/销毁容器** 的操作将导致利用率的暂时上升，拉取镜像通常会影响 CPU 和 IO，因为它们涉及将镜像内容解压到磁盘。如果可能的话，工作负载存储(pod 临时存储和卷)应该与 agent 组件(/var/lib/rancher/k3s/agent)隔离，以确保不会出现资源冲突。



**防止 agent 和工作负载干扰集群数据存储：**

+ 在 `server` 节点运行工作负载 pod 时，应确保 `agent` 和工作负载 `IOPS` 不干扰数据存储。

+ 将 `server` 组件（/var/lib/rancher/k3s/server）与 `agent` 组件（/var/lib/rancher/k3s/agent）放在不同的存储介质上，后者包括 containerd 镜像存储。

+ 工作负载存储（pod 临时存储和卷）也应该与数据存储隔离。



### /usr/local/bin 重要二进制

::: tip 
后面的测试都是和 `/usr/local/bin` 息息相关，就比如说每一次测试删除：

```bash
/usr/local/bin/k3s-uninstall.sh 
```

**同样的还有停止 k3s：**

为了在升级期间实现高可用性，K3s 容器在 K3s 服务停止时会继续运行。

```bash
/usr/local/bin/k3s-killall.sh
```

killall 脚本能清理容器、K3s 目录和网络组件，同时还能删除 iptables 链以及所有相关规则。集群数据不会被删除。

 🏄‍♂️ 同样可以使用 `systemctl start k3s` ，目前发现效果一样，如果你觉得不一样，联系下我~

**当然 k3s 都是围绕着 k3s 脚本为中心的：**

:::



## 脚本安装选项

::: tip 
我们现在已经知道了关于脚本的选项两种方式，**环境变量** 或者 **标志** 。

⚠️ 注意，如果你选择 **下载install.sh** 使用 https://ghproxy.com ，后面的所有脚本我都是使用：

```bash
INSTALL_K3S_MIRROR=cn   INSTALL_K3S_SYMLINK=skip  sh install.sh
```

以 "K3S_"开头的环境变量将被保留，供 systemd 和 openrc 服务使用。

在没有明确设置 exec 命令的情况下设置`K3S_URL`，会将命令默认为 "agent"。

运行 agent 时还必须设置`K3S_TOKEN`。

:::



`INSTALL_K3S_SKIP_DOWNLOAD` -- (用于离线安装) 如果设置为 "true "将不会下载 K3s 的哈希值或二进制。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
    INSTALL_K3S_SKIP_DOWNLOAD=true \
    sh -
```



`INSTALL_K3S_SYMLINK` -- 默认情况下，如果路径中不存在命令，将为 `kubectl`、`crictl` 和 `ctr` 二进制文件创建符号链接。如果设置为 `'skip'` 将不会创建符号链接，而 `'force'` 将覆盖。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SYMLINK=skip \
  sh -
```

> **测试(默认情况）：**
>
> ```bash
> root@etcnode01:/usr/local/bin# ls -al
> total 66164
> drwxr-xr-x  2 root root     4096 Nov 26 09:40 .
> drwxr-xr-x 10 root root     4096 Aug 31 06:52 ..
> lrwxrwxrwx  1 root root        3 Nov 26 06:19 crictl -> k3s
> -rwxr-xr-x  1 root root 67735552 Nov 26 06:19 k3s
> -rwxr-xr-x  1 root root     1433 Nov 26 06:19 k3s-agent-uninstall.sh
> -rwxr-xr-x  1 root root     2026 Nov 26 06:19 k3s-killall.sh
> lrwxrwxrwx  1 root root        3 Nov 26 06:19 kubectl -> k3s
> ```
>
> 
>
> **测试（指定环境变量）：**
>
> ```bash
> root@cubmaster01:/usr/local/bin# ls -al
> total 66168
> drwxr-xr-x  2 root root     4096 Nov 26 11:16 .
> drwxr-xr-x 10 root root     4096 Aug 31 06:52 ..
> -rwxr-xr-x  1 root root 67735552 Nov 26 11:16 k3s
> -rwxr-xr-x  1 root root     2026 Nov 26 11:16 k3s-killall.sh
> -rwxr-xr-x  1 root root     1397 Nov 26 11:16 k3s-uninstall.sh
> ```

::: warning 注意
⚠️ 我在上一节介绍了使用 **别名** ，它可以派上用场了。
:::

 

`INSTALL_K3S_SKIP_ENABLE` -- 如果设置为 "true"，将不启用或启动 K3s 服务。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_ENABLE=true \
  sh -
```

> **开启：**
>
> ```bash
> systemctl start k3s
> kubectl get nodes
> ```



`INSTALL_K3S_SKIP_START` -- 如果设置为 "true "将不会启动 K3s 服务。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_START=true \
  sh -
```



`INSTALL_K3S_VERSION` -- 从 Github 下载 K3s 的版本。如果没有指定，将尝试从"stable"频道下载。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_VERSION="v1.19.9+k3s1" \
  sh -
```

> 注意后面是 `+`



`INSTALL_K3S_BIN_DIR` -- 安装 K3s 二进制文件、链接和卸载脚本的目录，或者使用 `/usr/local/bin` 作为默认目录。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_BIN_DIR=/opt/bin \
  sh -
```



`INSTALL_K3S_BIN_DIR_READ_ONLY` -- 如果设置为 true 将不会把文件写入INSTALL_K3S_BIN_DIR，强制设置INSTALL_K3S_SKIP_DOWNLOAD=true。

`INSTALL_K3S_SKIP_DOWNLOAD` 会创建 `kubectl/crictl/ctr` 等，而 `INSTALL_K3S_BIN_DIR_READ_ONLY` 不创建。

```
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_BIN_DIR_READ_ONLY=true \
  sh -
```



`INSTALL_K3S_SYSTEMD_DIR` -- 安装 systemd 服务和环境文件的目录，或者使用/etc/systemd/system 作为默认目录。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SYSTEMD_DIR=/opt/systemd \
  sh -
```

::: tip 测试

```bash
root@cubmaster01:/workspces/runtime# INSTALL_K3S_MIRROR=cn   INSTALL_K3S_SYSTEMD_DIR=/opt/systemd sh install.sh 
root@cubmaster01:/opt/systemd# ls -al
total 12
drwxr-xr-x 2 root root 4096 Nov 26 11:53 .
drwxr-xr-x 6 root root 4096 Nov 26 11:51 ..
-rw-r--r-- 1 root root  829 Nov 26 11:53 k3s.service
-rw------- 1 root root    0 Nov 26 11:53 k3s.service.env
```

:::





`INSTALL_K3S_EXEC` -- 带有标志的命令，用于在服务中启动 K3s。**如果未指定命令，并且设置了 K3S_URL，它将默认为“agent”。如果未设置 K3S_URL，它将默认为“server”。**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--docker" \
  sh -
```

**最后的 systemd 命令解析为这个环境变量和脚本参数的组合。**为了说明这一点，以下命令的结果与注册一个没有 flannel 的 server 的行为相同：

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--flannel-backend none" sh -s -
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --flannel-backend none" sh -s -
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server" sh -s - --flannel-backend none
curl -sfL https://get.k3s.io | sh -s - server --flannel-backend none
curl -sfL https://get.k3s.io | sh -s - --flannel-backend none
```



`INSTALL_K3S_NAME` -- 要创建的 `systemd` 服务名称，如果以服务器方式运行 k3s，则默认为 `'k3s'`；如果以 `agent` 方式运行 `k3s`，则默认为 `'k3s-agent'` 。如果指定了服务名，则服务名将以 `'k3s-'` 为前缀。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_NAME="seal" \
  sh -
```



`INSTALL_K3S_TYPE` -- 要创建的 systemd 服务类型，默认为 notify

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_TYPE="exec" \
  sh -
```



`INSTALL_K3S_SKIP_SELINUX_RPM` -- 如果设置为 `"true "` 将跳过 `k3s RPM` 的自动安装。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_SELINUX_RPM=true \
  sh -
```

::: tip K3s RPM
[安全增强的 Linux（SELinux）](https://en.wikipedia.org/wiki/Security-Enhanced_Linux)是对 Linux 的安全增强。

它由 Red Hat 开发，是 Linux 上强制性访问控制（MAC）的一个实现。强制性访问控制允许系统管理员定义应用程序和用户如何访问不同的资源，如文件、设备、网络和进程间通信。SELinux 还通过使操作系统在默认情况下具有限制性而增强了安全性。

在历史上被政府机构使用后，SELinux 现在是行业标准，在 CentOS 7 和 8 上默认启用。要检查 SELinux 是否在你的系统上启用和执行，请使用`getenforce`。

```bash
getenforce
Enforcing
```

:::



`INSTALL_K3S_CHANNEL_URL` -- 用于获取 K3s 下载网址的频道 URL。默认为 https://update.k3s.io/v1-release/channels 。

`INSTALL_K3S_CHANNEL` -- 用于获取 K3s 下载 URL 的通道。默认值为 "stable"。选项包括：`stable`, `latest`, `testing`。

```
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_CHANNEL="latest" \
  sh -
```



`K3S_CONFIG_FILE` -- 指定配置文件的位置。默认目录为`/etc/rancher/k3s/config.yaml`。

::: tip 我们先指定下文件：

```bash
cat >> /opt/config.yaml <<-EOF
node-label:
- "foo=bar"
- "something=amazing"
EOF
```

:::

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_CONFIG_FILE=/opt/config.yaml \
  sh -
```

![image-20221126211751303](http://sm.nsddd.top/smimage-20221126211751303.png)





`K3S_TOKEN` -- 用于将 server 或 agent 加入集群的共享 secret。

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_TOKEN=rancher-k3s \
  sh -
```

::: tip 希望你可以找到它的位置

```bash
cat /var/lib/rancher/k3s/server/token
K1042465c14be8de6a57c482b4162f673addcb652acb13c8119a9900b5d27c234f7::server:rancher-k3s
```

:::



`K3S_TOKEN_FILE` -- 指定 `cluster-secret`,`token` 的文件目录。

::: tip 我们需要先指定文件

```bash
cat >> /opt/token.txt <<-EOF
rancher-k3s
EOF
```

:::

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_TOKEN_FILE=/opt/token.txt \
  sh -
```

::: tip 希望你可以找到它的位置

```bash
root@cubmaster01:/workspces/runtime# cat /var/lib/rancher/k3s/server/token
K10fbe884032e42976a1dd419e5d171b9bc38d50e13dc852afbc97ffb99c765f06e::server:rancher-k3s
```

:::





### 总结

::: tip

1. 以 "K3S\_"开头的环境变量将被保留，供 systemd 和 openrc 服务使用。
2. 在没有明确设置 exec 命令的情况下设置 K3S_URL，会将命令默认为 "agent"。
3. 运行 agent 时还必须设置 K3S_TOKEN。

:::



##  对二进制的安装高级补充

安装脚本主要是配置 K3s 作为服务运行。如果你选择不使用脚本，你可以通过 [发布页面](https://github.com/rancher/k3s/releases/latest)下载二进制文件，将其放在你的环境变量路径上，然后执行它来运行 K3s。K3s 二进制支持以下命令：

`k3s server` -- 运行 K3s server，它还将启动 Kubernetes control-plane 组件，如 API server, controller-manager, 和 scheduler。

> 和 kubernetes 的控制层面很类似~

```bash
root@cubmaster01:/workspces/runtime# k3s server
INFO[0000] Acquiring lock file /var/lib/rancher/k3s/data/.lock 
INFO[0000] Preparing data dir /var/lib/rancher/k3s/data/2ef87ff954adbb390309ce4dc07500f29c319f84feec1719bfb5059c8808ec6a 
INFO[0000] Starting k3s v1.25.3+k3s1 (f2585c16)         
INFO[0000] Configuring sqlite3 database connection pooling: maxIdleConns=2, maxOpenConns=0, connMaxLifetime=0s 
INFO[0000] Configuring database table schema and indexes, this may take a moment... 
INFO[0000] Database tables and indexes are up to date   
INFO[0000] Kine available at unix://kine.sock 
......
```



`k3s agent` -- 运行 K3s agent 节点。这将使 K3s 作为工作节点运行，启动 Kubernetes 节点服务 kubelet 和 kube-proxy。

```
root@etcnode01:~# k3s agent --server https://192.168.71.130:6443 --token K10fcaced71fc70ca6b77921a7e374dc03c34fdd1fb11973d69a2a8e937b61beb22::server:82c397ed440c496f5448ec3c4b11c112
INFO[0000] Starting k3s agent v1.25.4+k3s1 (0dc63334)   
INFO[0000] Running load balancer k3s-agent-load-balancer 127.0.0.1:6444 -> [192.168.71.130:6443] 
ERRO[0004] failed to get CA certs: Get "https://127.0.0.1:6444/cacerts": read tcp 127.0.0.1:60386->127.0.0.1:6444: read: connection reset by peer 
......
```

> ```bash
> root@cubmaster01:/opt# k3s kubectl get nodes
> NAME          STATUS   ROLES                  AGE   VERSION
> cubmaster01   Ready    control-plane,master   96m   v1.25.3+k3s1
> cubnode02     Ready    <none>                 52m   v1.25.4+k3s1
> etcnode01     Ready    <none>                 67m   v1.25.4+k3s1
> ```



`k3s kubectl` -- 运行嵌入式 kubectl CLI。如果没有设置 KUBECONFIG 环境变量，当启动 K3s 服务器节点时，将自动尝试使用在`/etc/rancher/k3s/k3s.yaml` 创建的配置文件。

```bash
root@k3s1:~# k3s kubectl get nodes
NAME   STATUS   ROLES                  AGE     VERSION
k3s1   Ready    control-plane,master   8m14s   v1.20.5+k3s1
k3s2   Ready    <none                11s     v1.20.5+k3s1
```



`k3s crictl` -- 运行一个嵌入式 crictl。这是一个用于与 Kubernetes 的容器运行时接口（CRI）交互的 CLI。对调试很有用。

```bash
root@k3s1:~# k3s crictl ps
CONTAINER           IMAGE               CREATED             STATE               NAME                     ATTEMPT             POD ID
9ceb610df16c7       aa764f7db3051       8 minutes ago       Running             traefik                  0                   373c79416fa65
cadceb62ae08d       897ce3c5fc8ff       8 minutes ago       Running             lb-port-443              0                   f8a0ecfe56562
a26a49be485ac       897ce3c5fc8ff       8 minutes ago       Running             lb-port-80               0                   f8a0ecfe56562
01894072f2298       148c192562719       8 minutes ago       Running             local-path-provisioner   1                   b9d55e63f632f
5ccd6ed05120f       296a6d5035e2d       9 minutes ago       Running             coredns                  0                   2bae007d8e486
be0765e77a703       9dd718864ce61       9 minutes ago       Running             metrics-server           0                   53ab949c026ce
```



`k3s ctr` -- 运行一个嵌入式的 ctr。这是为 containerd（K3s 使用的容器守护进程）提供的 CLI。对调试很有用。

```bash
root@k3s1:~# k3s ctr container ls
CONTAINER                                                           IMAGE                                                                                                               RUNTIME
01894072f2298208f3c109f9fb1d5e12e677d11cd5d0b0a3a66f550ae38644e4    docker.io/rancher/local-path-provisioner:v0.0.19                                                                    io.containerd.runc.v2
2bae007d8e486afffbbf1ffb88e97b92d367aff4b06842217de4fb5d22ecf1b9    docker.io/rancher/pause:3.1
```

`k3s server` 和 `k3s agent` 命令有额外的配置选项，可以通过 `k3s server --help` 或 `k3s agent --help` 查看。



## 通过配置文件启动 K3s

除了使用环境变量和 CLI 参数来配置 K3s，K3s 还可以使用配置文件。默认目录位于 `/etc/rancher/k3s/config.yaml`（或者是 `k3s.yaml` 文件）

::: warning 提示
如果同时使用配置文件和 CLI 参数。 在这种情况下，值将从两个来源加载，但 CLI 参数优先级更高。 对于可重复的参数，如--node-label，CLI 参数将覆盖列表中的所有值。
:::



## K3s Server/Agent 配置

**`write-kubeconfig` -- 将管理客户端的 kubeconfig 写入这个文件**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_KUBECONFIG_OUTPUT=/root/.kube/config \
  sh -
```



**使用 docker 作为容器运行时**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--docker" \
  sh -
```

::: tip 测试

```bash
root@cubmaster01:/workspces/runtime# docker ps
CONTAINER ID   IMAGE                              COMMAND                  CREATED              STATUS              PORTS     NAMES
9e9e8cd5eb22   rancher/mirrored-library-traefik   "/entrypoint.sh --gl…"   14 seconds ago       Up 12 seconds                 k8s_traefik_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
8fb6d8f2c3dc   dbd43b6716a0                       "entry"                  32 seconds ago       Up 31 seconds                 k8s_lb-tcp-443_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6033d7ecc824   dbd43b6716a0                       "entry"                  32 seconds ago       Up 31 seconds                 k8s_lb-tcp-80_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6b95dbafc4ee   rancher/mirrored-pause:3.6         "/pause"                 32 seconds ago       Up 31 seconds                 k8s_POD_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
b13f33df38d9   rancher/mirrored-pause:3.6         "/pause"                 33 seconds ago       Up 31 seconds                 k8s_POD_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
5e8ce9d7d95e   rancher/mirrored-coredns-coredns   "/coredns -conf /etc…"   51 seconds ago       Up 50 seconds                 k8s_coredns_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_1
03db38691203   rancher/local-path-provisioner     "local-path-provisio…"   56 seconds ago       Up 55 seconds                 k8s_local-path-provisioner_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_1
9b087eb2f2d0   e57a417f15d3                       "/metrics-server --c…"   About a minute ago   Up About a minute             k8s_metrics-server_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_1
a1ead6d83564   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_0
7a1020d7a01f   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_0
cd0e940354a9   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_0

```

:::



**针对多网卡主机安装 K3s 集群**

**k3s server:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
INSTALL_K3S_EXEC="--node-ip=192.168.99.211" \
sh -
```



**K3s agent:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
K3S_URL=https://192.168.99.211:6443 \
K3S_TOKEN=9077b8e6f3b67b5f3e4a7723a96b199d \
INSTALL_K3S_EXEC="--node-ip=192.168.99.212" \
sh -
```



**--tls-san -- 在 TLS 证书中添加其他主机名或 IP 作为主题备用名称**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--tls-san 3.97.6.45"  \
  sh -
```



修改`kube-apiserver`、`kube-scheduler` 、`kube-controller-manager`、 `kube-cloud-controller-manager`、 `kubelet`、 `kube-proxy` 参数

**kubelet-arg：**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kubelet-arg=max-pods=200' \
  sh -
```



**kube-apiserver：**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kube-apiserver-arg=service-node-port-range=40000-50000' \
  sh -
```



**kube-proxy-arg：**

```bash
 curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kube-proxy-arg=proxy-mode=ipvs' \
  sh -
```



**`--data-dir -- K3s` 数据存储目录，默认为 `/var/lib/rancher/k3s` 或 `${HOME}/.rancher/k3s`(如果不是 root 用户)**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--data-dir=/opt/k3s-data' \
  sh -
```

::: tip 
这就有点意思了，我们默认的安装迁移了：

```bash
root@cubmaster01:/opt/k3s-data/server# cd /opt/k3s-data/;ls
agent  server
```

**当然，我们自己设计目录结构的时候或许可以用到~**

:::



**禁用组件 --disable：**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--disable traefik' \
  sh -
```



::: tip
**禁用前：**

```bash
[root@VM-4-6-centos k3s]# ls /var/lib/rancher/k3s/server/manifests
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml  traefik.yaml
```



**禁用后：**

```bash
root@cubmaster01:/workspces/runtime# ls /var/lib/rancher/k3s/server/manifests
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml
root@cubmaster01:/workspces/runtime# kubectl get pods -A | grep traefik
```

:::



**添加 label 和 taint:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--node-label foo=bar,hello=world --node-taint key1=value1:NoExecute' \
  sh -
```



## 网络选项

默认情况下，`K3s` 将以 `flannel` 作为 `CNI` 运行，使用 `VXLAN` 作为默认后端。`CNI`和默认后端都可以通过参数修改。

### Flannel 选项

Flannel 的默认后端是 VXLAN。要启用加密，请使用下面的 IPSec（Internet Protocol Security）或 WireGuard 选项。

| CLI Flag 和 Value             | 描述                                                         |
| :---------------------------- | :----------------------------------------------------------- |
| `--flannel-backend=vxlan`     | (默认) 使用 VXLAN 后端。                                     |
| `--flannel-backend=ipsec`     | 使用 IPSEC 后端，对网络流量进行加密。                        |
| `--flannel-backend=host-gw`   | 使用 host-gw 后端。                                          |
| `--flannel-backend=wireguard` | 使用 WireGuard 后端，对网络流量进行加密。可能需要额外的内核模块和配置。 |



### flannel-backend 使用 `host-gw`

```bash
# K3s master
root@k3s1:~# curl -sfL https://get.k3s.io | \
        INSTALL_K3S_EXEC="--flannel-backend=host-gw" \
        INSTALL_K3S_MIRROR=cn sh -

# K3s agent 
root@k3s2:~# curl -sfL https://get.k3s.io | \
        INSTALL_K3S_MIRROR=cn K3S_URL=https://172.16.64.6:6443 \
        K3S_TOKEN=85892cbfef2177603f25be30344dbcd0 sh -
```

::: tip 

```bash
root@k3s1:~# cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json
{
	"Network": "10.42.0.0/16",
	"Backend": {
		"Type": "host-gw"
	}
}

root@k3s1:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.16.64.1     0.0.0.0         UG    100    0        0 enp0s2
10.42.0.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0
10.42.1.0       172.16.64.9     255.255.255.0   UG    0      0        0 enp0s2
172.16.64.0     0.0.0.0         255.255.255.0   U     0      0        0 enp0s2
172.16.64.1     0.0.0.0         255.255.255.255 UH    100    0        0 enp0s2
```

:::



### 启用 Directrouting

当主机在同一子网时，启用 direct routes(如host-gw)。`vxlan` 只用于将数据包封装到不同子网的主机上，同子网的主机之间使用 `host-gw`。默认值为 `false`。

```bash
# K3s master 和 agent
cat >> /etc/net-conf.json <<EOF 
{
        "Network": "10.42.0.0/16",
        "Backend": {
            "Type": "vxlan",
            "Directrouting": true
	}
}
EOF

# K3s master
curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \
        INSTALL_K3S_EXEC="--flannel-conf=/etc/net-conf.json" \
        INSTALL_K3S_MIRROR=cn sh -
```



## 自定义 CNI

使用 `--flannel-backend=none` 运行 K3s，然后在安装你选择的 CNI。



#### Calico

按照[Calico CNI 插件指南](https://docs.projectcalico.org/master/reference/cni-plugin/configuration)。修改 Calico YAML，在 container_settings 部分中允许 IP 转发，例如：

```
"container_settings": {
              "allow_ip_forwarding": true
          }
```

> 如不配置 `"allow_ip_forwarding": true`， `svclb-traefik` 将会报错：`/usr/bin/entry: line 6: can't create /proc/sys/net/ipv4/ip_forward: Read-only file system`

```bash
root@k3s1:~# curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \
        INSTALL_K3S_MIRROR=cn \
        INSTALL_K3S_EXEC="--flannel-backend=none \
        --cluster-cidr=192.168.200.0/24" \
        sh -
root@k3s1:~# kubectl apply -f https://raw.githubusercontent.com/kingsd041/k3s-tutorial/main/05-安装-网络选项/calico.yaml
```

**参考：**https://docs.projectcalico.org/getting-started/kubernetes/k3s/quickstart



## 使用外部数据库实现高可用安装

::: tip 
单节点 k3s server 集群可以满足各种用例，但是对于需要 Kubernetes control-plane 稳定运行的重要环境，您可以在 HA 配置中运行 K3s。一个 K3s HA 集群由以下几个部分组成：

- 两个或多个`server 节点`，将为 Kubernetes API 提供服务并运行其他 control-plane 服务。
- 零个或多个`agent 节点`，用于运行您的应用和服务。
- `外部数据存储` (与单个 k3s server 设置中使用的嵌入式 SQLite 数据存储相反)
- `固定的注册地址`，位于 server 节点的前面，以允许 agent 节点向集群注册

> Agent 通过固定的注册地址进行注册，但注册后直接与其中一个 server 节点建立连接。这是一个由 k3s agent 进程发起的 websocket 连接，并由作为 agent 进程一部分运行的客户端负载均衡器维护。

:::

 ### 环境准备

::: warning 提醒
个人比较倾向于 etcd，Dqlite 已经被抛弃了，嵌入式 etcd 才是 yyds

:::



















+ **适用场景**

> 资源有限的地方，如边缘计算、雾计算、物联网的接入网关等

+ **脚本-在线安装**

> \1. master节点 指定安装版本,不指定安装最新稳定版本

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# curl -sfL https://get.k3s.io | sh -
```

> \2. 所有worker节点 token来源于master节点，目录/var/lib/rancher/k3s/server/node-token

```text
# export INSTALL_K3S_VERSION=v1.18.9
# curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=XXX sh -
```


*等价于*

> \1. master节点

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
```

> \2. 所有worker节点 指定版本，master，还有从master获取的token

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
```

+ **脚本-离线安装**

> 1.先在有网络的地方下载k3s安装脚本和二进制文件

```text
脚本：https://get.k3s.io
选择对应版本的二进制文件: https://github.com/rancher/k3s/releases
```

> 2.将k3s安装脚本放在任意位置，二进制文件拷贝到目标主机的/usr/local/bin目录
> 3.添加环境变量

```text
# export INSTALL_K3S_SKIP_DOWNLOAD=true
跳过二进制文件下载
```

> 4.在master节点运行安装脚本 这里的版本要和上面下载的二进制文件版本一致

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
```

> 5.在所有worker节点运行安装脚本 所有worker节点 指定版本，master，还有从master获取的token

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
```



+ **无脚本-纯手动安装**

> 1.下载k3s二进制文件

[地址github.com/rancher/k3s/releases/latest](https://link.zhihu.com/?target=https%3A//github.com/rancher/k3s/releases/latest)

> 2.启动master和worker

```text
> 没有脚本启动方便，需要自己指定启动参数，如server、agent等

# sudo k3s server &
> Kubeconfig is written to /etc/rancher/k3s/k3s.yaml
# sudo k3s kubectl get nodes

> On a different node run the below. NODE_TOKEN comes from
> /var/lib/rancher/k3s/server/node-token on your server
# sudo k3s agent --server https://myserver:6443 --token ${NODE_TOKEN}
```

+ **k3s默认用的containerd，如果要用docker替换containerd，则在安装k3s前安装docker**

> 1.安装docker

```text
# yum install -y yum-utils 
# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# yum makecache fast 
# yum list docker-ce --showduplicates | sort -r
# yum install -y docker-ce-19.03.8-3.el7
# systemctl start docker
# systemctl enable docker
```

> 2.安装k3s master

```text
# export INSTALL_K3S_VERSION=v1.18.9
# export INSTALL_K3S_EXEC="--docker --write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16"
# sh k3s.sh
```

> 3.安装k3s worker

```text
# 所有worker节点 指定版本，master，还有从master获取的token
# export INSTALL_K3S_VERSION=v1.18.9
# export K3S_URL=https://master_ip:6443 
# export K3S_TOKEN=K103b676c8815cc4fb467cb5564527c3a5b0d3415915c9a15e195ff6069589bf508::server:97d3d89ac68de226f5003869fe676718
# sh k3s.sh
```





## END 链接

<ul><li><div><a href = '14.md' style='float:left'>⬆️上一节🔗  </a><a href = '16.md' style='float: right'>  ️下一节🔗</a></div></li></ul>

+ [Ⓜ️回到目录🏠](../README.md)

+ [**🫵参与贡献💞❤️‍🔥💖**](https://nsddd.top/archives/contributors))

+ ✴️版权声明 &copy; ：本书所有内容遵循[CC-BY-SA 3.0协议（署名-相同方式共享）&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0协议文本) 

