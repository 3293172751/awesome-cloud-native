+ [author](http://nsddd.top)

# 第34节 Kubernetes 开发之旅

<div><a href = '33.md' style='float:left'>⬆️上一节🔗  </a><a href = '35.md' style='float: right'>  ⬇️下一节🔗</a></div>
<br>

> ❤️💕💕新时代拥抱云原生，云原生具有环境统一、按需付费、即开即用、稳定性强特点。Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## 💡它很重要

它就像是数据库一样重要，缺了它，我们什么都没办法实现，但是相比较控制器，它又不是我们核心。

但是我们作为第一步，我希望可以从它开始学习~



## 三个重要的 API 名词

### API Object

是 Kubernetes 内部管理的基本元素，是 Kubernetes 在 ETCD 中信息存储单元。

例如 Deployment，Pod，Service，都是 API Object。内部代码常用 `API` 称呼。



### API  Group

一组 API Object 组成的一个具有共有性质的对象集合。

例如：apps 这个 group ，它由 Deployment，ReplicaSet，StatefulSet。



### Legacy API Object

绝大多数的 API Object 都被归在 API Group 下面，特别是新版中引入的一定非遵从这一原则。

但是在 Kubernetes 项目项目初始化阶段所引入的 API Object 没有显示定义在 API Group 下面，例如 Pod，Event，Node等等，在代码中有时也称呼他们为 `core` 、API Object



## API Server 在 cobra 的实现

`API Server`：

```go
func main() {
	command := app.NewAPIServerCommand()	
	code := cli.Run(command)	//跑 command
	os.Exit(code)	//一直跑，除非调用 code 
}
```

> 很简洁的主程序~



## server chain

**构建过程 从右向左； 请求流向 从左向右：**

链表结构，



## Master 中转载 API

API Server 的内容 是 API Object 

通过 Restful 服务对外提供操作 API Object 的能力。





## 详解 Scheme 机制

::: warning 定义
Scheme 是一个接口体，内含处理外部 Version 之间的转换， GVK 和 Go Type之间的转换之用的数据和方法。

:::



 Scheme 定义了资源序列化和反序列化的方法以及资源类型和版本的对应关系；这里我们可以理解成一张纪录表。定义在 [k8s.io/apimachinery/pkg/runtime/scheme.go](https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apimachinery/pkg/runtime/scheme.go) 中。需要关注的 `gvkToTypeype` 和 `typeToGVK` 字段

```go
// Schemes are not expected to change at runtime and are only threadsafe after
// registration is complete.
type Scheme struct {
	// gvkToType allows one to figure out the go type of an object with
	// the given version and name.
	gvkToType map[schema.GroupVersionKind]reflect.Type

	// typeToGVK allows one to find metadata for a given go object.
	// The reflect.Type we index by should *not* be a pointer.
	typeToGVK map[reflect.Type][]schema.GroupVersionKind

	// unversionedTypes are transformed without conversion in ConvertToVersion.
	unversionedTypes map[reflect.Type]schema.GroupVersionKind

	// unversionedKinds are the names of kinds that can be created in the context of any group
	// or version
	// TODO: resolve the status of unversioned types.
	unversionedKinds map[string]reflect.Type

	// Map from version and resource to the corresponding func to convert
	// resource field labels in that version to internal version.
	fieldLabelConversionFuncs map[schema.GroupVersionKind]FieldLabelConversionFunc

	// defaulterFuncs is a map to funcs to be called with an object to provide defaulting
	// the provided object must be a pointer.
	defaulterFuncs map[reflect.Type]func(interface{})

	// converter stores all registered conversion functions. It also has
	// default converting behavior.
	converter *conversion.Converter

	// versionPriority is a map of groups to ordered lists of versions for those groups indicating the
	// default priorities of these versions as registered in the scheme
	versionPriority map[string][]string

	// observedVersions keeps track of the order we've seen versions during type registration
	observedVersions []schema.GroupVersion

	// schemeName is the name of this scheme.  If you don't specify a name, the stack of the NewScheme caller will be used.
	// This is useful for error reporting to indicate the origin of the scheme.
	schemeName string
}
```

和 API Server 通信的时候能够处理新的 types 类型就需要知道有新的types类型，AddToScheme 会利用到反射，新定义的 types 类型的结构体的命名必须和自定义的 Kind 的命名一致，否则找不到对应的kind





## Version

每一个 API Group 都会有很多 version，每一个 version 包含很多个 kind （一个 KInd会出现在多个 version 下）

这些 Version 又称为 External Version ，它们面向 API Server 外部，Internal Version 是 API Server 在内部程序中处理数据时 API Object 的实际类型。



## GVK

Group，Version，Kind 。这三元组确定了一个 Kind，当然并不是缺一不可。GVK 理解为一个字符串，是三者拼接的结果。





## Type

代码中常见 "TYPE" 。





## END 链接
<ul><li><div><a href = '33.md' style='float:left'>⬆️上一节🔗  </a><a href = '35.md' style='float: right'>  ️下一节🔗</a></div></li></ul>

+ [Ⓜ️回到目录🏠](../README.md)

+ [**🫵参与贡献💞❤️‍🔥💖**](https://nsddd.top/archives/contributors))

+ ✴️版权声明 &copy; ：本书所有内容遵循[CC-BY-SA 3.0协议（署名-相同方式共享）&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0协议文本) 

