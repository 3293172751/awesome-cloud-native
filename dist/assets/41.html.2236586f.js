import{_ as i,r as o,o as l,c,a as n,b as a,w as u,e as s,d as t}from"./app.b5569805.js";const r={},d={href:"http://nsddd.top",target:"_blank",rel:"noopener noreferrer"},k=s("author"),v=n("h1",{id:"\u7B2C41\u8282-\u901F\u8BFB-horizon-\u6E90\u7801-\u6838\u5FC3\u8BBE\u8BA1\u601D\u60F3",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u7B2C41\u8282-\u901F\u8BFB-horizon-\u6E90\u7801-\u6838\u5FC3\u8BBE\u8BA1\u601D\u60F3","aria-hidden":"true"},"#"),s(" \u7B2C41\u8282 \u901F\u8BFB horizon \u6E90\u7801\uFF0C\u6838\u5FC3\u8BBE\u8BA1\u601D\u60F3")],-1),m=n("div",null,[n("a",{href:"40.md",style:{float:"left"}},"\u2B06\uFE0F\u4E0A\u4E00\u8282\u{1F517} "),n("a",{href:"42.md",style:{float:"right"}}," \u2B07\uFE0F\u4E0B\u4E00\u8282\u{1F517}")],-1),b=n("br",null,null,-1),g=s("\u2764\uFE0F\u{1F495}\u{1F495}\u8BB0\u5F55"),y={href:"https://github.com/3293172751/sealos",target:"_blank",rel:"noopener noreferrer"},h=s("sealos"),f=s("\u5F00\u6E90\u9879\u76EE\u7684\u5B66\u4E60\u8FC7\u7A0B\u3002"),q={href:"https://github.com/3293172751/sealos",target:"_blank",rel:"noopener noreferrer"},_=s("k8s,docker\u548C\u4E91\u539F\u751F\u7684\u5B66\u4E60"),x=s("\u3002Myblog:"),R={href:"http://nsddd.top/",target:"_blank",rel:"noopener noreferrer"},D=s("http://nsddd.top"),A=t(`<hr><p>[TOC]</p><h2 id="\u5F00\u59CB" tabindex="-1"><a class="header-anchor" href="#\u5F00\u59CB" aria-hidden="true">#</a> \u5F00\u59CB</h2><p>\u7531\u4E8E horzon \u9879\u76EE\u7406\u89E3\u7684\u5E76\u6CA1\u6709 sealer\u3001sealos \u6DF1\u5165\uFF0C\u7B97\u662F\u4E00\u4E2A\u4ECE\u96F6\u5F00\u59CB\u5B66\u4E60\u7684\u9879\u76EE\u3002</p><p>\u51C6\u5907\u901F\u8FC7\u4E00\u904D horzon \u7684\u6E90\u7801\uFF0C\u4EE5\u53CA\u90E8\u5206\u7684\u7EC6\u8282\uFF0C\u5148\u770B\u76EE\u5F55\u7ED3\u6784\uFF0C\u5206\u6790\u73B0\u5728\u7684\u57FA\u672C\u529F\u80FD\uFF0C\u518D\u89C2\u5BDF\u7B2C\u4E00\u4E2A PR\uFF0C\u4EE5\u53CA\u6700\u5F00\u59CB\u7684 <code>Important issue</code>\u3002</p><h2 id="\u76EE\u5F55\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#\u76EE\u5F55\u7ED3\u6784" aria-hidden="true">#</a> \u76EE\u5F55\u7ED3\u6784</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F tree <span class="token parameter variable">-L</span> <span class="token number">2</span>
<span class="token builtin class-name">.</span>
\u251C\u2500\u2500 CODE-OF-CONDUCT.md
\u251C\u2500\u2500 CONTRIBUTING.md
\u251C\u2500\u2500 Horizon.svg
\u251C\u2500\u2500 LICENSE
\u251C\u2500\u2500 Makefile
\u251C\u2500\u2500 README.md
\u251C\u2500\u2500 README_ZH-CN.md
\u251C\u2500\u2500 bin
\u2502   \u2514\u2500\u2500 app
\u251C\u2500\u2500 build
\u2502   \u251C\u2500\u2500 build.sh
\u2502   \u251C\u2500\u2500 core
\u2502   \u2514\u2500\u2500 swagger
\u251C\u2500\u2500 build-json-schema.json
\u251C\u2500\u2500 build-ui-schema.json
\u251C\u2500\u2500 config.yaml
\u251C\u2500\u2500 core
\u2502   \u251C\u2500\u2500 cmd
\u2502   \u251C\u2500\u2500 common
\u2502   \u251C\u2500\u2500 config
\u2502   \u251C\u2500\u2500 controller
\u2502   \u251C\u2500\u2500 errors
\u2502   \u251C\u2500\u2500 http
\u2502   \u251C\u2500\u2500 main.go
\u2502   \u2514\u2500\u2500 middleware
\u251C\u2500\u2500 db
\u2502   \u251C\u2500\u2500 20210908_initial_schema.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20211124</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20211125</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220113</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220124</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220330</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220516</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220519</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220712</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220722</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220816</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220823</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220824</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220908</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220920</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20220921</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20221031</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20221110</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20221111</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20221117</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20221121</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20221201</span>.sql
\u2502   \u251C\u2500\u2500 <span class="token number">20230302</span>.sql
\u2502   \u2514\u2500\u2500 migrations
\u251C\u2500\u2500 go.mod
\u251C\u2500\u2500 go.sum
\u251C\u2500\u2500 image
\u2502   \u2514\u2500\u2500 readme
\u251C\u2500\u2500 integrationtest
\u2502   \u2514\u2500\u2500 authpagerender_test.go
\u251C\u2500\u2500 lib
\u2502   \u251C\u2500\u2500 gitlab
\u2502   \u251C\u2500\u2500 orm
\u2502   \u251C\u2500\u2500 q
\u2502   \u2514\u2500\u2500 s3
\u251C\u2500\u2500 mock
\u2502   \u251C\u2500\u2500 lib
\u2502   \u2514\u2500\u2500 pkg
\u251C\u2500\u2500 openapi
\u2502   \u251C\u2500\u2500 v1
\u2502   \u2514\u2500\u2500 v2
\u251C\u2500\u2500 pkg
\u2502   \u251C\u2500\u2500 accesstoken
\u2502   \u251C\u2500\u2500 application
\u2502   \u251C\u2500\u2500 applicationregion
\u2502   \u251C\u2500\u2500 auth
\u2502   \u251C\u2500\u2500 authentication
\u2502   \u251C\u2500\u2500 cluster
\u2502   \u251C\u2500\u2500 common
\u2502   \u251C\u2500\u2500 config
\u2502   \u251C\u2500\u2500 context
\u2502   \u251C\u2500\u2500 environment
\u2502   \u251C\u2500\u2500 environmentregion
\u2502   \u251C\u2500\u2500 errors
\u2502   \u251C\u2500\u2500 event
\u2502   \u251C\u2500\u2500 eventhandler
\u2502   \u251C\u2500\u2500 <span class="token function">git</span>
\u2502   \u251C\u2500\u2500 grafana
\u2502   \u251C\u2500\u2500 group
\u2502   \u251C\u2500\u2500 hook
\u2502   \u251C\u2500\u2500 horizonapp
\u2502   \u251C\u2500\u2500 idp
\u2502   \u251C\u2500\u2500 <span class="token function">jobs</span>
\u2502   \u251C\u2500\u2500 member
\u2502   \u251C\u2500\u2500 oauth
\u2502   \u251C\u2500\u2500 param
\u2502   \u251C\u2500\u2500 pipelinerun
\u2502   \u251C\u2500\u2500 rbac
\u2502   \u251C\u2500\u2500 region
\u2502   \u251C\u2500\u2500 registry
\u2502   \u251C\u2500\u2500 server
\u2502   \u251C\u2500\u2500 tag
\u2502   \u251C\u2500\u2500 template
\u2502   \u251C\u2500\u2500 templaterelease
\u2502   \u251C\u2500\u2500 templaterepo
\u2502   \u251C\u2500\u2500 templateschematag
\u2502   \u251C\u2500\u2500 token
\u2502   \u251C\u2500\u2500 user
\u2502   \u251C\u2500\u2500 userlink
\u2502   \u251C\u2500\u2500 util
\u2502   \u2514\u2500\u2500 webhook
\u251C\u2500\u2500 roles.yaml
\u251C\u2500\u2500 scopes.yaml
\u2514\u2500\u2500 scripts
    \u251C\u2500\u2500 install.sh
    \u251C\u2500\u2500 k3s
    \u2514\u2500\u2500 make-rules
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6CE8\u610F k3s \u548C make-rules \u8FD8\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB\uFF0C\u6211\u4EEC\u{1F4DC} \u5BF9\u4E0A\u9762\u7684\u89E3\u91CA\uFF1A</p><ul><li><code>CODE-OF-CONDUCT.md</code>\uFF1A\u884C\u4E3A\u5B88\u5219\u3002</li><li><code>CONTRIBUTING.md</code>\uFF1A\u8D21\u732E\u6307\u5357\u3002</li><li><code>Horizon.svg</code>\uFF1A\u9879\u76EE\u56FE\u6807\u3002</li><li><code>LICENSE</code>\uFF1A\u5F00\u6E90\u8BB8\u53EF\u8BC1\u3002</li><li><code>Makefile</code>\uFF1A\u6784\u5EFA\u811A\u672C\u3002</li><li><code>README.md</code>\uFF1A\u9879\u76EE\u8BF4\u660E\u6587\u6863\u3002</li><li><code>README_ZH-CN.md</code>\uFF1A\u4E2D\u6587\u8BF4\u660E\u6587\u6863\u3002</li><li><code>bin/app</code>\uFF1A\u4E8C\u8FDB\u5236\u6587\u4EF6\u3002</li><li><code>build/build.sh</code>\uFF1A\u6784\u5EFA\u811A\u672C\u3002</li><li><code>build/core</code>\uFF1A\u6784\u5EFA\u6838\u5FC3\u3002</li><li><code>build/swagger</code>\uFF1A\u6784\u5EFA swagger \u6587\u6863\u3002</li><li><code>build-json-schema.json</code>\uFF1AJSON \u67B6\u6784\u6587\u4EF6\u3002</li><li><code>build-ui-schema.json</code>\uFF1AUI \u67B6\u6784\u6587\u4EF6\u3002</li><li><code>config.yaml</code>\uFF1A\u914D\u7F6E\u6587\u4EF6\u3002</li><li><code>core</code>\uFF1A\u6838\u5FC3\u4EE3\u7801\u3002</li><li><code>db</code>\uFF1A\u6570\u636E\u5E93\u811A\u672C\u3002</li><li><code>go.mod</code> \u548C <code>go.sum</code>\uFF1A\u4F9D\u8D56\u7BA1\u7406\u6587\u4EF6\u3002</li><li><code>image/readme</code>\uFF1A\u955C\u50CF\u8BF4\u660E\u6587\u6863\u3002</li><li><code>integrationtest/authpagerender_test.go</code>\uFF1A\u96C6\u6210\u6D4B\u8BD5\u4EE3\u7801\u3002</li><li><code>lib/gitlab</code>\uFF1AGitLab \u76F8\u5173\u4EE3\u7801\u3002</li><li><code>lib/orm</code>\uFF1AORM \u76F8\u5173\u4EE3\u7801\u3002</li><li><code>lib/q</code>\uFF1A\u67E5\u8BE2\u76F8\u5173\u4EE3\u7801\u3002</li><li><code>lib/s3</code>\uFF1AS3 \u76F8\u5173\u4EE3\u7801\u3002</li><li><code>mock</code>\uFF1A\u6A21\u62DF\u4EE3\u7801\u3002</li><li><code>openapi</code>\uFF1AOpenAPI \u76F8\u5173\u4EE3\u7801\u3002</li><li><code>pkg</code>\uFF1A\u516C\u5171\u5305\u3002</li><li><code>roles.yaml</code>\uFF1A\u89D2\u8272\u914D\u7F6E\u6587\u4EF6\u3002</li><li><code>scopes.yaml</code>\uFF1A\u4F5C\u7528\u57DF\u914D\u7F6E\u6587\u4EF6\u3002</li><li><code>scripts</code>\uFF1A\u811A\u672C\u6587\u4EF6\u3002</li></ul><p>Maybe it can be fix\uFF1A</p><ul><li><code>build</code> \u8FC1\u79FB\u5230 <code>scripts</code> \u4E2D\uFF0CDockerfile \u8FC1\u79FB\u51FA\u6765</li><li><code>core</code> \u76EE\u5F55\u6539\u6210 <code>internal</code> \u76EE\u5F55</li></ul><h2 id="\u7B2C\u4E00\u7248" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E00\u7248" aria-hidden="true">#</a> \u7B2C\u4E00\u7248</h2><p>\u5F88\u53EF\u60DC\u7684\u662F <code>horizon</code> \u5E76\u6CA1\u6709 <code>0.1</code> \u7248\u672C\u7684\uFF0C\u800C\u662F\u4ECE <code>2.0.1</code> \u5F00\u59CB\u5F00\u6E90\u7684\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>v2.0.1
v2.0.10
v2.0.11
v2.0.12
v2.0.2
v2.0.2-rc1
v2.0.3
v2.0.4
v2.0.5
v2.0.6
v2.0.7
v2.0.8
v2.0.9
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u6837\u770B\u7740\u592A\u4E0D\u53CB\u597D\u4E86\uFF0C\u540C\u6837\u5BF9\u4E8E <strong>\u5206\u652F\u7684</strong> \u8BBE\u5B9A\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>dependabot<span class="token operator">/</span>go_modules<span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>prometheus<span class="token operator">/</span>client_golang<span class="token operator">-</span><span class="token number">1.11</span><span class="token number">.1</span>
dependabot<span class="token operator">/</span>go_modules<span class="token operator">/</span>golang<span class="token punctuation">.</span>org<span class="token operator">/</span>x<span class="token operator">/</span>net<span class="token operator">-</span><span class="token number">0.7</span><span class="token number">.0</span>
dependabot<span class="token operator">/</span>go_modules<span class="token operator">/</span>helm<span class="token punctuation">.</span>sh<span class="token operator">/</span>helm<span class="token operator">/</span>v3<span class="token operator">-</span><span class="token number">3.11</span><span class="token number">.1</span>
kilosonc<span class="token operator">-</span>patch<span class="token operator">-</span><span class="token number">1</span>
kilosonc<span class="token operator">-</span>patch<span class="token operator">-</span><span class="token number">2</span>
kilosonc<span class="token operator">-</span>patch<span class="token operator">-</span><span class="token number">3</span>
main
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,16),w=s("\u9879\u76EE\u4E2D\u4E5F\u6CA1\u7528 "),C=n("code",null,"CHANGELOG",-1),I=s(" \u6765\u63CF\u8FF0\u7248\u672C\u4FE1\u606F\u7684\u53D8\u66F4\uFF0C\u8FD9\u91CC\u53EF\u4EE5\u6539\u53D8\u4E0B\uFF0C\u597D\u6709 CHANGELOG \u7528\u6765\u5C55\u793A\u6BCF\u4E2A\u7248\u672C\u4E4B\u95F4\u7684\u53D8\u66F4\u5185\u5BB9\uFF0C\u4F5C\u4E3A Release Note \u7684\u4E00\u90E8\u5206\u3002\u4F46\u662F\uFF0C\u5982\u679C\u6BCF\u6B21\u90FD\u8981\u624B\u52A8\u7F16\u5199 CHANGELOG\uFF0C\u4F1A\u5F88\u9EBB\u70E6\uFF0C\u4E5F\u4E0D\u5BB9\u6613\u575A\u6301\uFF0C\u6240\u4EE5\u8FD9\u91CC\u6211\u4EEC\u53EF\u4EE5\u501F\u52A9"),O={href:"https://github.com/git-chglog/git-chglog",target:"_blank",rel:"noopener noreferrer"},N=s("git-chglogopen in new window"),P=s("\u5DE5\u5177\u6765\u81EA\u52A8\u751F\u6210\u3002"),S=s("\u4E0D\u4EC5\u5982\u6B64\uFF0C\u4E00\u4E2A\u9879\u76EE\u4E5F\u9700\u8981\u6709\u4E00\u4E2A\u7248\u672C\u53F7\uFF0C\u5F53\u524D\u7528\u5F97\u6BD4\u8F83\u591A\u7684\u662F\u8BED\u4E49\u5316\u7248\u672C\u53F7\u89C4\u8303\u3002\u4F46\u5982\u679C\u9760\u5F00\u53D1\u8005\u624B\u52A8\u6253\u7248\u672C\u53F7\uFF0C\u5DE5\u4F5C\u6548\u7387\u4F4E\u4E0D\u8BF4\uFF0C\u7ECF\u5E38\u8FD8\u4F1A\u51FA\u73B0\u6F0F\u6253\u3001\u6253\u7684\u7248\u672C\u53F7\u4E0D\u89C4\u8303\u7B49\u95EE\u9898\u3002\u6240\u4EE5\u6700\u597D\u7684\u529E\u6CD5\u662F\uFF0C\u7248\u672C\u53F7\u4E5F\u901A\u8FC7\u5DE5\u5177\u81EA\u52A8\u751F\u6210\u3002\u5728\u8FD9\u91CC\u6211\u4EEC\u53EF\u4EE5\u91C7\u7528"),B={href:"https://github.com/arnaud-deprez/gsemver",target:"_blank",rel:"noopener noreferrer"},G=s("gsemveropen in new window"),E=s("\u5DE5\u5177\u6765\u81EA\u52A8\u751F\u6210\u7248\u672C\u53F7\u3002"),L=t(`<p>\u6211\u4EEC\u53EF\u4EE5\u5C06\u5176\u653E\u5165\u5230 <code>scripts/ensure_tag.sh</code> \u811A\u672C\u4E2D\uFF0C\u53EF\u4EE5\u901A\u8FC7 Makefile \u548C CI \u6D41\u7A0B\u8FDB\u884C\u8C03\u7528\u3002</p><p>\u9664\u6B64\u4E4B\u5916\uFF0C\u5BF9\u4E8E\u4E00\u4E2A\u4F18\u8D28\u7684\u5F00\u6E90\u9879\u76EE\u6765\u8BF4\uFF0C\u5206\u4E3A\u5F00\u53D1\u9636\u6BB5\u548C\u6D4B\u8BD5\u89E3\u51B3\uFF0C\u8FD9\u4E9B\u90FD\u662F\u53EF\u4EE5\u7528 CICD \u6D41\u7A0B\u8FDB\u884C\u63A7\u5236\u7684\u3002\u5728\u5F00\u53D1\u9636\u6BB5\u751F\u6210\u4EE3\u7801\u3001\u7248\u6743\u68C0\u67E5\u3001\u4EE3\u7801\u683C\u5F0F\u5316\u3001\u9759\u6001\u4EE3\u7801\u68C0\u67E5\u3001\u5355\u5143\u6D4B\u8BD5\u3001\u6784\u5EFA\u7B49\u64CD\u4F5C\u90FD\u662F\u53EF\u4EE5\u5E94\u7528\u5230 Makefile \u548C CICD \u6D41\u7684\u3002</p><p>\u6211\u4EEC \u9605\u8BFB\u4E0B horizon \u6700\u65E9\u7684\u7248\u672C\uFF08\u7531\u4E8E\u5E76\u6CA1\u6709\u5BF9\u5E94\u5408\u9002\u7684 branch \u548C tag\uFF0C\u6211\u4EEC\u9009\u62E9 Frist commit\uFF09\uFF1A</p><p><img src="http://sm.nsddd.top/sm202304161046942.png" alt="image-20230416104617735"></p><p>\u7B2C\u4E00\u4E2A\u7248\u672C\u7684\u63D0\u4EA4\u662F\u5BF9 openAPI \u7684\u89C4\u8303</p><blockquote><p>OpenAPI \u662F\u4E00\u79CD\u89C4\u8303\uFF0C\u7528\u4E8E\u5B9A\u4E49 RESTful API\uFF0C\u5B83\u57FA\u4E8E JSON \u6216 YAML \u683C\u5F0F\uFF0C\u7528\u4E8E\u63CF\u8FF0 API \u7684\u8F93\u5165\u53C2\u6570\u3001\u8F93\u51FA\u7ED3\u679C\u7B49\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u4EE5\u4FBF\u4E8E\u751F\u6210\u5BA2\u6237\u7AEF SDK \u548C API \u6587\u6863\u3002\u5728 Horizon \u9879\u76EE\u4E2D\uFF0Copenapi \u6587\u4EF6\u5939\u5B58\u653E\u7740 OpenAPI \u76F8\u5173\u7684\u4EE3\u7801\u3002</p></blockquote><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">openapi</span><span class="token punctuation">:</span> 3.0.0
<span class="token key atrule">info</span><span class="token punctuation">:</span>
  <span class="token key atrule">title</span><span class="token punctuation">:</span> Horizon Group API
  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    This API</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0
<span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> group
<span class="token key atrule">paths</span><span class="token punctuation">:</span>
  <span class="token key atrule">/groups</span><span class="token punctuation">:</span>
    <span class="token key atrule">get</span><span class="token punctuation">:</span>
      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> listGroups
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> list groups
      <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/parameters/searchParam&quot;</span>
      <span class="token key atrule">responses</span><span class="token punctuation">:</span>
        <span class="token key atrule">&quot;201&quot;</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> null response
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> Unexpected error
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/schemas/error&quot;</span>
  <span class="token key atrule">/group</span><span class="token punctuation">:</span>
    <span class="token key atrule">post</span><span class="token punctuation">:</span>
      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> createGroup
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> create a group
      <span class="token key atrule">requestBody</span><span class="token punctuation">:</span>
        <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">content</span><span class="token punctuation">:</span>
          <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
            <span class="token key atrule">schema</span><span class="token punctuation">:</span>
              <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/schemas/newGroup&quot;</span>
      <span class="token key atrule">responses</span><span class="token punctuation">:</span>
        <span class="token key atrule">&quot;201&quot;</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> null response
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> Unexpected error
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/schemas/error&quot;</span>
  /group/<span class="token punctuation">{</span>group<span class="token punctuation">}</span><span class="token punctuation">:</span>
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/parameters/groupParam&quot;</span>
    <span class="token key atrule">get</span><span class="token punctuation">:</span>
      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> getGroupDetail
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> get the detail of a group
      <span class="token key atrule">responses</span><span class="token punctuation">:</span>
        <span class="token key atrule">&#39;200&#39;</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> Expected response to a valid request
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/schemas/groupDetail&quot;</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> Unexpected error
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/schemas/error&quot;</span>
    <span class="token key atrule">put</span><span class="token punctuation">:</span>
      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> updateGroupDetail
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> update detail of a group
      <span class="token key atrule">requestBody</span><span class="token punctuation">:</span>
        <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">content</span><span class="token punctuation">:</span>
          <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
            <span class="token key atrule">schema</span><span class="token punctuation">:</span>
              <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupDetail&#39;</span>
      <span class="token key atrule">responses</span><span class="token punctuation">:</span>
        <span class="token key atrule">&#39;200&#39;</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> Update result
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupDetail&#39;</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span>  Unexpected error
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/error&#39;</span>
    <span class="token key atrule">delete</span><span class="token punctuation">:</span>
      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> deleteGroup
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> delete an empty group
      <span class="token key atrule">responses</span><span class="token punctuation">:</span>
        <span class="token key atrule">&#39;200&#39;</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> null response
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span>  Unexpected error
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/error&#39;</span>
  /group/<span class="token punctuation">{</span>group<span class="token punctuation">}</span>/subgroups<span class="token punctuation">:</span>
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/parameters/groupParam&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/parameters/searchParam&quot;</span>
    <span class="token key atrule">get</span><span class="token punctuation">:</span>
      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> listSubGroups
      <span class="token key atrule">responses</span><span class="token punctuation">:</span>
        <span class="token key atrule">&#39;200&#39;</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> Return the list of groups
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">type</span><span class="token punctuation">:</span> array
                <span class="token key atrule">items</span><span class="token punctuation">:</span>
                  <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupDetail&#39;</span>
  /group/<span class="token punctuation">{</span>group<span class="token punctuation">}</span>/services<span class="token punctuation">:</span>
    <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/parameters/groupParam&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&quot;#/components/parameters/searchParam&quot;</span>
    <span class="token key atrule">get</span><span class="token punctuation">:</span>
      <span class="token key atrule">operationId</span><span class="token punctuation">:</span> listGroupService
      <span class="token key atrule">responses</span><span class="token punctuation">:</span>
        <span class="token key atrule">&#39;200&#39;</span><span class="token punctuation">:</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> Return the list of service
          <span class="token key atrule">content</span><span class="token punctuation">:</span>
            <span class="token key atrule">application/json</span><span class="token punctuation">:</span>
              <span class="token key atrule">schema</span><span class="token punctuation">:</span>
                <span class="token key atrule">type</span><span class="token punctuation">:</span> array
                <span class="token key atrule">items</span><span class="token punctuation">:</span>
                  <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;service.yaml#/components/schemas/serviceDetail&#39;</span>
<span class="token key atrule">components</span><span class="token punctuation">:</span>
  <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
    <span class="token key atrule">groupParam</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> group
      <span class="token key atrule">in</span><span class="token punctuation">:</span> path
      <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">schema</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> string
    <span class="token key atrule">searchParam</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> search
      <span class="token key atrule">in</span><span class="token punctuation">:</span> query
      <span class="token key atrule">description</span><span class="token punctuation">:</span> Return the list of authorized groups matching the search criteria
      <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">schema</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> string
  <span class="token key atrule">schemas</span><span class="token punctuation">:</span>
    <span class="token key atrule">queryGroup</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> string
      <span class="token key atrule">maxLength</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> param for querying group
    <span class="token key atrule">newGroup</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> object
      <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> name
        <span class="token punctuation">-</span> path
        <span class="token punctuation">-</span> visibilityLevel
      <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupName&#39;</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupPath&#39;</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupDescription&#39;</span>
        <span class="token key atrule">visibilityLevel</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/visibilityLevel&#39;</span>
        <span class="token key atrule">parantId</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupId&#39;</span>

    <span class="token key atrule">groupDetail</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> object
      <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupId&#39;</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupName&#39;</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupPath&#39;</span>
        <span class="token key atrule">description</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/groupDescription&#39;</span>
        <span class="token key atrule">visibilityLevel</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/visibilityLevel&#39;</span>
        <span class="token key atrule">createTime</span><span class="token punctuation">:</span>
          <span class="token key atrule">$ref</span><span class="token punctuation">:</span> <span class="token string">&#39;#/components/schemas/date&#39;</span>
    <span class="token key atrule">date</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> string
      <span class="token key atrule">format</span><span class="token punctuation">:</span> date
      <span class="token key atrule">pattern</span><span class="token punctuation">:</span> full<span class="token punctuation">-</span>date
    <span class="token key atrule">groupId</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> integer
      <span class="token key atrule">format</span><span class="token punctuation">:</span> int64
      <span class="token key atrule">description</span><span class="token punctuation">:</span> the parent id of the subgroup<span class="token punctuation">,</span>if not provided. a root group
    <span class="token key atrule">groupName</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> string
      <span class="token key atrule">maxLength</span><span class="token punctuation">:</span> <span class="token number">64</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> the group Name
    <span class="token key atrule">groupPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> string
      <span class="token key atrule">maxLength</span><span class="token punctuation">:</span> <span class="token number">1024</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> the group path
    <span class="token key atrule">visibilityLevel</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> integer
      <span class="token key atrule">format</span><span class="token punctuation">:</span> int32
      <span class="token key atrule">enum</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> 0 means public(every one can see the group)<span class="token punctuation">,</span> 1 means private one member can see
    <span class="token key atrule">groupDescription</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> string
      <span class="token key atrule">maxLength</span><span class="token punctuation">:</span> <span class="token number">1024</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> the group description
    <span class="token key atrule">error</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> object
      <span class="token key atrule">required</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> code
        <span class="token punctuation">-</span> message
      <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">code</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> integer
          <span class="token key atrule">format</span><span class="token punctuation">:</span> int32
        <span class="token key atrule">message</span><span class="token punctuation">:</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> string

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Swagger \u548C OpenAPI \u7684\u533A\u522B\uFF1A</strong></p>`,8),z={href:"https://k8s-iam.nsddd.top/iam/projects/10.html#%E5%BC%80%E5%A7%8B",target:"_blank",rel:"noopener noreferrer"},U=s("\u6587\u7AE0"),M=s("\u4F18\u5316\uFF1A \u7528 "),j={href:"https://github.com/go-swagger/go-swagger",target:"_blank",rel:"noopener noreferrer"},$=s("go-swagger"),T=s(" \u6765\u751F\u6210 Swagger API \u6587\u6863"),F=n("p",null,"\u4E3A\u4EC0\u4E48\u4E0D\u7528 swag\uFF1F",-1),V=n("ul",null,[n("li",null,[n("strong",null,"go-swagger \u6BD4 swag \u529F\u80FD\u66F4\u5F3A\u5927\uFF1A"),s(" go-swagger \u63D0\u4F9B\u4E86\u66F4\u7075\u6D3B\u3001\u66F4\u591A\u7684\u529F\u80FD\u6765\u63CF\u8FF0\u6211\u4EEC\u7684 API\u3002")]),n("li",null,[n("strong",null,"\u4F7F\u6211\u4EEC\u7684\u4EE3\u7801\u66F4\u6613\u8BFB"),s("\uFF1A\u5982\u679C\u4F7F\u7528 swag\uFF0C\u6211\u4EEC\u6BCF\u4E00\u4E2A API \u90FD\u9700\u8981\u6709\u4E00\u4E2A\u5197\u957F\u7684\u6CE8\u91CA\uFF0C\u6709\u65F6\u5019\u4EE3\u7801\u6CE8\u91CA\u6BD4\u4EE3\u7801\u8FD8\u8981\u957F\uFF0C\u4F46\u662F\u901A\u8FC7 go-swagger \u6211\u4EEC\u53EF\u4EE5\u5C06\u4EE3\u7801\u548C\u6CE8\u91CA\u5206\u5F00\u7F16\u5199\uFF0C\u4E00\u65B9\u9762\u53EF\u4EE5\u4F7F\u6211\u4EEC\u7684\u4EE3\u7801\u4FDD\u6301\u7B80\u6D01\uFF0C\u6E05\u6670\u6613\u8BFB\uFF0C\u53E6\u4E00\u65B9\u9762\u6211\u4EEC\u53EF\u4EE5\u5728\u53E6\u5916\u4E00\u4E2A\u5305\u4E2D\uFF0C\u7EDF\u4E00\u7BA1\u7406\u8FD9\u4E9B Swagger API \u6587\u6863\u5B9A\u4E49\u3002")]),n("li",null,[n("strong",null,"\u66F4\u597D\u7684\u793E\u533A\u652F\u6301"),s("\uFF1Ago-swagger \u76EE\u524D\u6709\u975E\u5E38\u591A\u7684 Github star \u6570\uFF0C\u51FA\u73B0 Bug \u7684\u6982\u7387\u5F88\u5C0F\uFF0C\u5E76\u4E14\u5904\u5728\u4E00\u4E2A\u9891\u7E41\u66F4\u65B0\u7684\u6D3B\u8DC3\u72B6\u6001\u3002")])],-1),H=n("h2",{id:"nocalhost",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#nocalhost","aria-hidden":"true"},"#"),s(" nocalhost")],-1),K={href:"https://nocalhost.dev/zh-CN/docs/quick-start/",target:"_blank",rel:"noopener noreferrer"},J=s("\u5FEB\u901F\u4E0A\u624B"),W=t(`<p><code>nocalhost</code> \u662F\u4E00\u79CD\u57FA\u4E8E Kubernetes \u7684\u672C\u5730\u5F00\u53D1\u5E73\u53F0\uFF0C\u5B83\u53EF\u4EE5\u5E2E\u52A9\u5F00\u53D1\u8005\u5728\u672C\u5730\u5FEB\u901F\u6784\u5EFA\u548C\u6D4B\u8BD5\u5E94\u7528\u7A0B\u5E8F\u3002\u4F7F\u7528 <code>nocalhost</code>\uFF0C\u4F60\u53EF\u4EE5\u8F7B\u677E\u5730\u5728\u672C\u5730\u8FD0\u884C\u5B8C\u6574\u7684 Kubernetes \u73AF\u5883\uFF0C\u5E76\u5728\u5176\u4E2D\u90E8\u7F72\u548C\u6D4B\u8BD5\u5E94\u7528\u7A0B\u5E8F\u3002\u4EE5\u4E0B\u662F <code>nocalhost</code> \u7684\u4E3B\u8981\u529F\u80FD\uFF1A</p><ul><li>\u901A\u8FC7 <code>nocalhost</code>\uFF0C\u4F60\u53EF\u4EE5\u5728\u672C\u5730\u542F\u52A8\u4E00\u4E2A\u5B8C\u6574\u7684 Kubernetes \u73AF\u5883\uFF0C\u5305\u62EC\u6240\u6709\u5FC5\u8981\u7684\u7EC4\u4EF6\u548C\u63D2\u4EF6\u3002</li><li><code>nocalhost</code> \u652F\u6301\u5404\u79CD\u4E0D\u540C\u7C7B\u578B\u7684\u5E94\u7528\u7A0B\u5E8F\uFF0C\u5305\u62EC Java\u3001Node.js\u3001Python \u7B49\u3002</li><li>\u4F60\u53EF\u4EE5\u4F7F\u7528 <code>nocalhost</code> \u5728\u672C\u5730\u6784\u5EFA\u548C\u8FD0\u884C\u5E94\u7528\u7A0B\u5E8F\uFF0C\u4EE5\u4FBF\u4E8E\u5F00\u53D1\u548C\u6D4B\u8BD5\u3002</li><li><code>nocalhost</code> \u8FD8\u63D0\u4F9B\u4E86\u4E00\u4E9B\u6709\u7528\u7684\u5DE5\u5177\u548C\u63D2\u4EF6\uFF0C\u4F8B\u5982\u8C03\u8BD5\u5668\u3001\u65E5\u5FD7\u67E5\u770B\u5668\u3001\u6570\u636E\u5E93\u7BA1\u7406\u5668\u7B49\u3002</li><li><code>nocalhost</code> \u8FD8\u63D0\u4F9B\u4E86\u5B8C\u6574\u7684\u6587\u6863\u548C\u6559\u7A0B\uFF0C\u4EE5\u4FBF\u4E8E\u5F00\u53D1\u8005\u5FEB\u901F\u4E0A\u624B\u3002</li></ul><h2 id="main-\u5165\u53E3" tabindex="-1"><a class="header-anchor" href="#main-\u5165\u53E3" aria-hidden="true">#</a> main \u5165\u53E3</h2><p>\u4ECE main.go \u51FD\u6570\u5F00\u59CB\u9605\u8BFB\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">ParseFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE Run \u51FD\u6570\u5F00\u59CB\u5B9E\u73B0\u903B\u8F91\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Run runs the agent.</span>
<span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>flags <span class="token operator">*</span>Flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ctx<span class="token punctuation">,</span> cancelFunc <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">setTasksBeforeExit</span><span class="token punctuation">(</span>cancelFunc<span class="token punctuation">)</span>
	configs<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">LoadConfig</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// enable pprof</span>
	<span class="token function">runPProfServer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>configs<span class="token punctuation">.</span>PProf<span class="token punctuation">)</span>
	<span class="token comment">// init api</span>
	<span class="token function">Init</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> configs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Run \u51FD\u6570\u5B9E\u73B0\u7684\u903B\u8F91\u5F88\u7B80\u5355\uFF1A</p><ul><li>\u63A5\u53D7\u4E00\u4E2A <code>flags</code> \u53C2\u6570\uFF0C\u5B83\u5305\u542B\u4E86\u4EE3\u7406\u8FD0\u884C\u7684\u4E00\u4E9B\u914D\u7F6E\u4FE1\u606F\u3002</li><li>\u521B\u5EFA\u4E86\u4E00\u4E2A\u4E0A\u4E0B\u6587\uFF08<code>ctx</code>\uFF09\u548C\u4E00\u4E2A\u53D6\u6D88\u51FD\u6570\uFF08<code>cancelFunc</code>\uFF09\u3002\u8FD9\u4E9B\u53D8\u91CF\u7528\u4E8E\u5728\u4EE3\u7406\u8FD0\u884C\u8FC7\u7A0B\u4E2D\u63A7\u5236\u7A0B\u5E8F\u7684\u884C\u4E3A\u3002</li><li>\u8C03\u7528\u4E86 <code>LoadConfig</code> \u51FD\u6570\uFF0C\u8BE5\u51FD\u6570\u7528\u4E8E\u52A0\u8F7D\u4EE3\u7406\u7684\u914D\u7F6E\u4FE1\u606F\u3002\u5982\u679C\u4EE3\u7406\u914D\u7F6E\u4FE1\u606F\u52A0\u8F7D\u5931\u8D25\uFF0C\u5219\u4F1A\u629B\u51FA\u4E00\u4E2A\u5F02\u5E38\u3002</li><li>\u8C03\u7528\u4E86 <code>runPProfServer</code> \u51FD\u6570\uFF0C\u8BE5\u51FD\u6570\u7528\u4E8E\u542F\u52A8 <code>pprof</code> \u670D\u52A1\u5668\uFF0C\u4EE5\u4FBF\u4E8E\u8FDB\u884C\u6027\u80FD\u8C03\u8BD5\u548C\u4F18\u5316\u3002</li><li>\u6700\u540E\uFF0C<code>Run</code> \u51FD\u6570\u8C03\u7528\u4E86 <code>Init</code> \u51FD\u6570\uFF0C\u8BE5\u51FD\u6570\u7528\u4E8E\u521D\u59CB\u5316\u4EE3\u7406\u5E76\u542F\u52A8 API \u670D\u52A1\u3002</li></ul><p>\u67E5\u770B <code>Init()</code> \u51FD\u6570\u7684\u5B9E\u73B0\u903B\u8F91\uFF1A</p><blockquote><p>\u521D\u59CB\u5316\u903B\u8F91\u6709\u4E9B\u590D\u6742\uFF0C\u5B9E\u73B0\u7684\u90E8\u5206\u5E94\u8BE5\u5C3D\u53EF\u80FD\u7684\u653E\u5728 <code>pkg</code> \u6216\u8005 <code>internal</code> \u76EE\u5F55\u4E0B\u9762\u3002</p></blockquote><p>\u5927\u81F4\u7684\u6B65\u9AA4\u5982\u4E0B\uFF1A</p><ol><li>\u521D\u59CB\u5316\u7FA4\u7EC4\u670D\u52A1\u3001\u7BA1\u7406\u5668</li><li>\u521D\u59CB\u5316\u96C6\u7FA4\u670D\u52A1\u3001\u7528\u6237\u670D\u52A1\u3001\u4EE4\u724C\u670D\u52A1\u3001Grafana \u670D\u52A1\u7B49</li><li>\u521B\u5EFA\u4E00\u4E2A\u53C2\u6570\u5BF9\u8C61\uFF0C\u8BE5\u5BF9\u8C61\u5305\u542B\u4E86\u6240\u6709\u670D\u52A1\u548C\u670D\u52A1\u6240\u9700\u7684\u53C2\u6570</li><li>\u521D\u59CB\u5316\u63A7\u5236\u5668\uFF0C\u4F8B\u5982\u6210\u5458\u63A7\u5236\u5668\u3001\u5E94\u7528\u7A0B\u5E8F\u63A7\u5236\u5668\u3001\u73AF\u5883\u6A21\u677F\u63A7\u5236\u5668\u7B49</li><li>\u521D\u59CB\u5316 API\uFF0C\u5305\u62EC v1 API \u548C v2 API\uFF0C\u5E76\u5C06\u5B83\u4EEC\u6CE8\u518C\u5230\u8DEF\u7531\u4E2D</li><li>\u542F\u52A8\u4E91\u4E8B\u4EF6\u670D\u52A1\u5668\uFF0C\u4EE5\u4FBF\u5728\u4E91\u4E2D\u5904\u7406\u4E8B\u4EF6</li><li>\u542F\u52A8 API \u670D\u52A1\u5668\u5E76\u76D1\u542C\u7AEF\u53E3</li></ol><p>\u4F7F\u7528 gorm \u4F5C\u4E3A\u56DE\u8C03\u51FD\u6570\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">RegisterCustomCallbacks</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:before_create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:create&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;add_created_by&quot;</span><span class="token punctuation">,</span> addCreatedByUpdatedByForCreateCallback<span class="token punctuation">)</span>

	<span class="token boolean">_</span> <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:before_update&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:update&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;add_updated_by&quot;</span><span class="token punctuation">,</span> addUpdatedByForUpdateDeleteCallback<span class="token punctuation">)</span>

	<span class="token boolean">_</span> <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:before_delete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span><span class="token string">&quot;gorm:delete&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">&quot;add_updated_by&quot;</span><span class="token punctuation">,</span> addUpdatedByForUpdateDeleteCallback<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E3B\u8981\u662F\u5728\u6267\u884C\u6570\u636E\u5E93\u64CD\u4F5C\u524D\u540E\u6267\u884C\u4E00\u4E9B\u81EA\u5B9A\u4E49\u7684\u903B\u8F91\u3002\u5B83\u5305\u542B\u4E86\u4E09\u4E2A\u56DE\u8C03\u51FD\u6570\uFF1A<code>Create</code>\u3001<code>Update</code> \u548C <code>Delete</code>\u3002\u6BCF\u4E2A\u56DE\u8C03\u51FD\u6570\u90FD\u5728 GORM \u7684\u67D0\u4E2A\u64CD\u4F5C\u4E4B\u524D\u6216\u4E4B\u540E\u88AB\u8C03\u7528\uFF0C\u5E76\u5728\u56DE\u8C03\u51FD\u6570\u4E2D\u6267\u884C\u4E00\u4E9B\u81EA\u5B9A\u4E49\u7684\u903B\u8F91\u3002\u4F8B\u5982\uFF0C\u56DE\u8C03\u51FD\u6570 &quot;add_created_by&quot; \u548C &quot;add_updated_by&quot; \u7528\u4E8E\u5728\u521B\u5EFA\u6216\u66F4\u65B0\u6570\u636E\u65F6\u6DFB\u52A0\u4E00\u4E2A &quot;created_by&quot; \u6216 &quot;updated_by&quot; \u5B57\u6BB5\uFF0C\u7528\u4E8E\u8BB0\u5F55\u6570\u636E\u7684\u521B\u5EFA\u6216\u66F4\u65B0\u8005\u3002\u5176\u4E2D\uFF0C<code>addCreatedByUpdatedByForCreateCallback</code> \u548C <code>addUpdatedByForUpdateDeleteCallback</code> \u662F\u4E24\u4E2A\u81EA\u5B9A\u4E49\u51FD\u6570\uFF0C\u5B83\u4EEC\u5206\u522B\u7528\u4E8E\u521B\u5EFA\u548C\u66F4\u65B0/\u5220\u9664\u64CD\u4F5C\u4E2D\u7684\u56DE\u8C03\u903B\u8F91\u3002\u8BE5\u51FD\u6570\u8FD8\u5305\u62EC\u4E86\u4E00\u4E9B GORM \u7684\u56DE\u8C03\u6CE8\u518C\u903B\u8F91\uFF0C\u7528\u4E8E\u5C06\u81EA\u5B9A\u4E49\u7684\u56DE\u8C03\u51FD\u6570\u6CE8\u518C\u5230 GORM \u4E2D\uFF0C\u4EE5\u4FBF\u5728\u6267\u884C\u6570\u636E\u5E93\u64CD\u4F5C\u65F6\u81EA\u52A8\u8C03\u7528\u8FD9\u4E9B\u56DE\u8C03\u51FD\u6570\u3002</p><h2 id="dao" tabindex="-1"><a class="header-anchor" href="#dao" aria-hidden="true">#</a> dao</h2><p>\u548C Java \u7684\u98CE\u683C\u7C7B\u4F3C\uFF0C horizon \u4E2D\u6709\u5F88\u591A\u90FD\u662F dao \u76EE\u5F55\uFF0Cdao\u76EE\u5F55\u662F\u4E00\u79CD\u5E38\u89C1\u7684\u547D\u540D\u89C4\u8303\uFF0C\u4EE3\u8868\u6570\u636E\u8BBF\u95EE\u5BF9\u8C61\uFF08Data Access Object\uFF09\u3002\u5B83\u901A\u5E38\u7528\u4E8E\u5B58\u50A8\u4E0E\u6570\u636E\u5E93\u4EA4\u4E92\u7684\u4EE3\u7801\u548C\u76F8\u5173\u903B\u8F91\u3002DAO\u6A21\u5F0F\u5206\u79BB\u4E86\u4E1A\u52A1\u903B\u8F91\u548C\u6570\u636E\u8BBF\u95EE\u903B\u8F91\uFF0C\u4F7F\u5F97\u4EE3\u7801\u66F4\u6613\u4E8E\u7EF4\u62A4\u548C\u6269\u5C55\u3002</p><p>\u5728 horizon \u4E2D\uFF0Cdao\u76EE\u5F55\u901A\u5E38\u5305\u542B\u4E00\u4E9B\u6587\u4EF6\uFF0C\u5982dao.go\u7B49\uFF0C\u5176\u4E2D\u5305\u542B\u4E0E\u6570\u636E\u5E93\u4EA4\u4E92\u7684\u65B9\u6CD5\u548C\u51FD\u6570\u3002\u8FD9\u4E9B\u65B9\u6CD5\u548C\u51FD\u6570\u53EF\u4EE5\u5728\u5176\u4ED6\u4EE3\u7801\u4E2D\u88AB\u5F15\u7528\uFF0C\u7528\u4E8E\u6570\u636E\u7684\u8BFB\u53D6\u3001\u5199\u5165\u548C\u66F4\u65B0\u7B49\u64CD\u4F5C\u3002</p><p>\u8FD9\u6837\u53EF\u4EE5\u4FDD\u6301\u4EE3\u7801\u7684\u6E05\u6670\uFF0C\u903B\u8F91\u660E\u786E\u3002</p><p>dao \u7684\u8BBE\u8BA1\u5982\u4E0B\uFF0C\u6211\u4EEC\u4EE5\u5176\u4E2D\u7684 <code>registry</code> \u76EE\u5F55\u4E3A\u4F8B\uFF1A</p><p>\u5305\u542B\u4E86\u63A5\u53E3\u4F5C\u4E3A\u62BD\u8C61\u5C42\uFF0C\u4F9B\u5916\u90E8\u8C03\u7528\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> DAO <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Create a registry</span>
	<span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> registry <span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// UpdateByID update a registry</span>
	<span class="token function">UpdateByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">,</span> registry <span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token comment">// DeleteByID delete a registry by id</span>
	<span class="token function">DeleteByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token comment">// GetByID get by id</span>
	<span class="token function">GetByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// ListAll list all registries</span>
	<span class="token function">ListAll</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>DAO \u63A5\u53E3\u4E2D\u7684 <code>Create</code>\u3001<code>UpdateByID</code>\u3001<code>DeleteByID</code>\u3001<code>GetByID</code> \u548C ListAll \u65B9\u6CD5\u90FD\u662F\u5BF9 registry \u8868\u8FDB\u884C\u4E86\u4E0D\u540C\u7684\u64CD\u4F5C\u3002Create \u65B9\u6CD5\u662F\u7528\u6765\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684 registry\uFF0CUpdateByID \u65B9\u6CD5\u662F\u7528\u6765\u66F4\u65B0 registry \u8868\u4E2D\u6307\u5B9A ID \u7684\u8BB0\u5F55\uFF0CDeleteByID \u65B9\u6CD5\u662F\u7528\u6765\u5220\u9664 registry \u8868\u4E2D\u6307\u5B9A ID \u7684\u8BB0\u5F55\uFF0CGetByID \u65B9\u6CD5\u662F\u7528\u6765\u83B7\u53D6 registry \u8868\u4E2D\u6307\u5B9A ID \u7684\u8BB0\u5F55\uFF0C\u800C ListAll \u65B9\u6CD5\u662F\u7528\u6765\u83B7\u53D6 registry \u8868\u4E2D\u6240\u6709\u8BB0\u5F55\u7684\u5217\u8868\u3002</p><p>DAO \u63A5\u53E3\u5B9A\u4E49\u4E86\u5BF9 registry \u8868\u7684\u589E\u5220\u6539\u67E5\u64CD\u4F5C\uFF0C\u800C dao \u7ED3\u6784\u4F53\u5B9E\u73B0\u4E86\u8FD9\u4E9B\u63A5\u53E3\u3002\u5B83\u90FD\u4F7F\u7528\u4E86 GORM \u5E93\u6765\u64CD\u4F5C\u6570\u636E\u5E93:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> dao <span class="token keyword">struct</span><span class="token punctuation">{</span> db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB <span class="token punctuation">}</span>
<span class="token comment">// NewDAO returns an instance of the default DAO</span>
<span class="token keyword">func</span> <span class="token function">NewDAO</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> DAO <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>dao<span class="token punctuation">{</span>db<span class="token punctuation">:</span> db<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD8\u6709\u4E00\u4E2A <code>NewDAO</code> \u51FD\u6570\uFF0C\u8FD4\u56DE\u7684\u662F\u4E00\u4E2A\u63A5\u53E3\uFF0C\u56E0\u4E3A DAO \u5C06\u6570\u636E\u5C42\u9762\u548C\u4E1A\u52A1\u5C42\u9762\u5265\u5F00\u4E86\u3002</p><p>\u9700\u8981 <code>NewDAO</code> \u51FD\u6570\u7684\u539F\u56E0\u662F\u56E0\u4E3A DAO \u63A5\u53E3\u548C dao \u7ED3\u6784\u4F53\u662F\u5206\u79BB\u7684\u3002DAO \u63A5\u53E3\u53EA\u5B9A\u4E49\u4E86\u5BF9 <code>registry</code> \u8868\u7684\u589E\u5220\u6539\u67E5\u64CD\u4F5C\uFF0C\u800C dao \u7ED3\u6784\u4F53\u5B9E\u73B0\u4E86\u8FD9\u4E9B\u64CD\u4F5C\u3002\u4E3A\u4E86\u65B9\u4FBF\u4F7F\u7528 DAO \u63A5\u53E3\uFF0C\u6211\u4EEC\u9700\u8981\u4E00\u4E2A\u51FD\u6570\u6765\u521B\u5EFA dao \u7ED3\u6784\u4F53\u7684\u5B9E\u4F8B\uFF0C\u8FD9\u4E2A\u5B9E\u4F8B\u53EF\u4EE5\u88AB\u7528\u6765\u8C03\u7528 DAO \u63A5\u53E3\u4E2D\u5B9A\u4E49\u7684\u65B9\u6CD5\u3002</p><p>\u5728 GORM \u4E2D\uFF0C\u6211\u4EEC\u9700\u8981\u4F7F\u7528\u4E00\u4E2A\u6570\u636E\u5E93\u8FDE\u63A5\u6765\u8FDB\u884C\u64CD\u4F5C\u3002\u56E0\u6B64\uFF0CNewDAO \u51FD\u6570\u9700\u8981\u4E00\u4E2A GORM \u6570\u636E\u5E93\u8FDE\u63A5\u4F5C\u4E3A\u53C2\u6570\u3002\u8FD9\u4E2A\u6570\u636E\u5E93\u8FDE\u63A5\u53EF\u4EE5\u901A\u8FC7 GORM \u5E93\u7684 Open \u51FD\u6570\u6765\u521B\u5EFA\uFF0C\u7136\u540E\u518D\u4F20\u9012\u7ED9 NewDAO \u51FD\u6570\u3002\u8FD9\u6837\u5C31\u53EF\u4EE5\u521B\u5EFA\u4E00\u4E2A dao \u7ED3\u6784\u4F53\u7684\u5B9E\u4F8B\uFF0C\u7528\u6765\u5BF9\u6570\u636E\u5E93\u4E2D\u7684 registry \u8868\u8FDB\u884C <code>CURD</code> \u64CD\u4F5C\u4E86\u3002</p><h2 id="manager" tabindex="-1"><a class="header-anchor" href="#manager" aria-hidden="true">#</a> manager</h2><p>\u6211\u4E00\u76F4\u5F88\u597D\u5947\u4E3A\u4EC0\u4E48\u6211\u4EEC\u6709\u4E86 <code>dao</code> \u8FD8\u9700\u8981 <code>manager</code> \uFF0C \u8FD9\u91CC\u4F7F\u7528\u4E86 DAO \u8BBE\u8BA1\u6A21\u5F0F\u548C\u4F9D\u8D56\u6CE8\u5165\uFF08DI\uFF09\u8BBE\u8BA1\u6A21\u5F0F\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> manager

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>

	<span class="token string">&quot;github.com/horizoncd/horizon/pkg/registry/dao&quot;</span>
	<span class="token string">&quot;github.com/horizoncd/horizon/pkg/registry/models&quot;</span>
	<span class="token string">&quot;gorm.io/gorm&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Manager <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Create a registry</span>
	<span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> registry <span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// UpdateByID update a registry</span>
	<span class="token function">UpdateByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">,</span> registry <span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token comment">// DeleteByID delete a registry by id</span>
	<span class="token function">DeleteByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token comment">// GetByID get by id</span>
	<span class="token function">GetByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// ListAll list all registries</span>
	<span class="token function">ListAll</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> manager <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	registryDAO dao<span class="token punctuation">.</span>DAO
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>db <span class="token operator">*</span>gorm<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> Manager <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>manager<span class="token punctuation">{</span>
		registryDAO<span class="token punctuation">:</span> dao<span class="token punctuation">.</span><span class="token function">NewDAO</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m manager<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> registry <span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>registryDAO<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> registry<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m manager<span class="token punctuation">)</span> <span class="token function">GetByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>registryDAO<span class="token punctuation">.</span><span class="token function">GetByID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m manager<span class="token punctuation">)</span> <span class="token function">ListAll</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>registryDAO<span class="token punctuation">.</span><span class="token function">ListAll</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m manager<span class="token punctuation">)</span> <span class="token function">UpdateByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">,</span> registry <span class="token operator">*</span>models<span class="token punctuation">.</span>Registry<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>registryDAO<span class="token punctuation">.</span><span class="token function">UpdateByID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">,</span> registry<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m manager<span class="token punctuation">)</span> <span class="token function">DeleteByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>registryDAO<span class="token punctuation">.</span><span class="token function">DeleteByID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>manager \u76EE\u5F55\u5B9E\u73B0\u4E86 Manager \u63A5\u53E3\u3002Manager \u63A5\u53E3\u662F\u5BF9 <code>DAO</code> \u63A5\u53E3\u7684\u8FDB\u4E00\u6B65\u5C01\u88C5\uFF0C\u63D0\u4F9B\u4E86\u66F4\u9AD8\u5C42\u6B21\u7684\u62BD\u8C61\u3002\u5B83\u5B9A\u4E49\u4E86\u5BF9 registry \u8868\u7684\u589E\u5220\u6539\u67E5\u64CD\u4F5C\uFF0C\u8FD9\u4E9B\u64CD\u4F5C\u662F\u901A\u8FC7 DAO \u63A5\u53E3\u6765\u5B9E\u73B0\u7684\u3002</p><p>\u5B83\u5BF9 DAO \u63A5\u53E3\u8FDB\u884C\u4E86\u8FDB\u4E00\u6B65\u7684\u5C01\u88C5\uFF0C\u63D0\u4F9B\u4E86\u66F4\u9AD8\u5C42\u6B21\u7684\u62BD\u8C61\u3002\u8FD9\u6837\u5C31\u53EF\u4EE5\u5C06 DAO \u63A5\u53E3\u4E0E\u5177\u4F53\u7684\u5B9E\u73B0\u5206\u79BB\uFF0C\u4F7F\u4EE3\u7801\u66F4\u52A0\u6E05\u6670\u6613\u61C2\u3002</p><p>\u5F53\u7136\uFF0C\u5728\u8FD9\u91CC horizon \u5B9E\u73B0\u7684\u529F\u80FD\u5C31\u662F\u8FD9\u4E48\u4E00\u4E9B\uFF0C\u9664\u6B64\u4E4B\u5916\uFF0C\u5B83\u8FD8\u53EF\u4EE5\u5BF9 DAO \u63A5\u53E3\u4E2D\u7684\u65B9\u6CD5\u8FDB\u884C\u7EDF\u4E00\u5904\u7406\uFF0C\u4F8B\u5982\u8FDB\u884C\u9519\u8BEF\u5904\u7406\u548C\u65E5\u5FD7\u8BB0\u5F55\u3002\u8FD9\u6837\u5C31\u53EF\u4EE5\u63D0\u9AD8\u4EE3\u7801\u7684\u53EF\u7EF4\u62A4\u6027\u548C\u53EF\u8BFB\u6027\u3002</p><h2 id="models" tabindex="-1"><a class="header-anchor" href="#models" aria-hidden="true">#</a> models</h2><p>models \u5305\u5B9A\u4E49\u4E86\u4E0E registry \u8868\u76F8\u5173\u7684\u6570\u636E\u7ED3\u6784\u3002\u5B83\u5305\u542B\u4E86\u4E00\u4E2A\u540D\u4E3A Registry \u7684\u7ED3\u6784\u4F53\uFF0C\u7528\u6765\u8868\u793A registry \u8868\u4E2D\u7684\u4E00\u6761\u8BB0\u5F55\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> models

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;github.com/horizoncd/horizon/pkg/server/global&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Registry <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	global<span class="token punctuation">.</span>Model

	Name   <span class="token builtin">string</span>
	Server <span class="token builtin">string</span>
	Path   <span class="token builtin">string</span>
	Token  <span class="token builtin">string</span>
	<span class="token comment">// for delete</span>
	InsecureSkipTLSVerify <span class="token builtin">bool</span> <span class="token string">\`gorm:&quot;column:insecure_skip_tls_verify&quot;\`</span>
	Kind                  <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Registry</code> \u7ED3\u6784\u4F53\u7684\u5B57\u6BB5\u4E0E <code>registry</code> \u8868\u4E2D\u7684\u5B57\u6BB5\u4E00\u4E00\u5BF9\u5E94\u3002\u5B83\u5305\u542B\u4E86 ID\u3001Name\u3001Server\u3001Path\u3001Token\u3001InsecureSkipTLSVerify \u548C Kind \u4E03\u4E2A\u5B57\u6BB5\u3002</p><ul><li>ID\uFF1Aregistry \u8BB0\u5F55\u7684\u552F\u4E00\u6807\u8BC6\u7B26\u3002</li><li>CreatedAt\uFF1Aregistry \u8BB0\u5F55\u7684\u521B\u5EFA\u65F6\u95F4\u3002</li><li>UpdatedAt\uFF1Aregistry \u8BB0\u5F55\u7684\u66F4\u65B0\u65F6\u95F4\u3002</li><li>DeletedAt\uFF1Aregistry \u8BB0\u5F55\u7684\u5220\u9664\u65F6\u95F4\u3002</li><li>Name\uFF1Aregistry \u7684\u540D\u79F0\u3002</li><li>Server\uFF1Aregistry \u7684\u670D\u52A1\u5668\u5730\u5740\u3002</li><li>Path\uFF1Aregistry \u7684\u5730\u5740\u8DEF\u5F84\u3002</li><li>Token\uFF1Aregistry \u7684\u8BBF\u95EE\u4EE4\u724C\u3002</li><li>InsecureSkipTLSVerify\uFF1A\u662F\u5426\u5FFD\u7565 TLS \u9A8C\u8BC1\u3002</li><li>Kind\uFF1Aregistry \u7684\u7C7B\u578B\u3002</li></ul><p>Registry \u7ED3\u6784\u4F53\u8FD8\u5B9A\u4E49\u4E86 TableName \u65B9\u6CD5\uFF0C\u7528\u6765\u6307\u5B9A\u8BE5\u7ED3\u6784\u4F53\u5BF9\u5E94\u7684\u8868\u540D\u3002</p><p>Registry \u7ED3\u6784\u4F53\u4E2D\u7684\u8FD9\u4E9B\u5B57\u6BB5\u90FD\u662F\u901A\u8FC7 GORM \u5E93\u7684 tags \u6765\u6620\u5C04\u5230\u6570\u636E\u5E93\u4E2D\u7684\u8868\u548C\u5217\u7684\u3002\u4F8B\u5982\uFF0CID \u5B57\u6BB5\u6620\u5C04\u5230\u4E86 registry \u8868\u4E2D\u7684 id \u5217\uFF0CName \u5B57\u6BB5\u6620\u5C04\u5230\u4E86 registry \u8868\u4E2D\u7684 name \u5217\u3002</p><p>\u8BE5 models \u5305\u7684\u4F5C\u7528\u662F\u5B9A\u4E49\u4E86\u4E0E registry \u8868\u76F8\u5173\u7684\u6570\u636E\u7ED3\u6784\uFF0C\u7528\u4E8E\u5728 DAO \u548C manager \u4E2D\u8FDB\u884C\u6570\u636E\u7684\u4F20\u9012\u548C\u64CD\u4F5C\u3002</p><h2 id="\u8BBE\u8BA1\u601D\u60F3" tabindex="-1"><a class="header-anchor" href="#\u8BBE\u8BA1\u601D\u60F3" aria-hidden="true">#</a> \u8BBE\u8BA1\u601D\u60F3</h2><p>\u548C registry \u76EE\u5F55\u7C7B\u4F3C\uFF0C\u6211\u4EEC\u4F7F\u7528\u66F4\u52A0\u5F3A\u5927\u7684 user \u76EE\u5F55\u5206\u6790\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>\u276F tree user
user
\u251C\u2500\u2500 dao
\u2502   \u2514\u2500\u2500 dao<span class="token punctuation">.</span><span class="token keyword">go</span>
\u251C\u2500\u2500 manager
\u2502   \u251C\u2500\u2500 manager<span class="token punctuation">.</span><span class="token keyword">go</span>
\u2502   \u2514\u2500\u2500 manager_test<span class="token punctuation">.</span><span class="token keyword">go</span>
\u251C\u2500\u2500 models
\u2502   \u2514\u2500\u2500 user<span class="token punctuation">.</span><span class="token keyword">go</span>
\u251C\u2500\u2500 service
\u2502   \u251C\u2500\u2500 service<span class="token punctuation">.</span><span class="token keyword">go</span>
\u2502   \u2514\u2500\u2500 service_test<span class="token punctuation">.</span><span class="token keyword">go</span>
\u2514\u2500\u2500 util
    \u2514\u2500\u2500 session<span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dao-1" tabindex="-1"><a class="header-anchor" href="#dao-1" aria-hidden="true">#</a> dao</h3><p>dao \u76EE\u5F55\u4E2D\u5305\u542B\u4E86\u4E0E\u7528\u6237\u4FE1\u606F\u76F8\u5173\u7684\u6570\u636E\u8BBF\u95EE\u5BF9\u8C61\uFF08Data Access Object\uFF09\u3002\u5B83\u5B9A\u4E49\u4E86\u4E00\u4E2A DAO \u63A5\u53E3\uFF0C\u7528\u4E8E\u5BF9 user \u8868\u8FDB\u884C\u589E\u5220\u6539\u67E5\u64CD\u4F5C\u3002dao \u76EE\u5F55\u7684\u4E3B\u8981\u4F5C\u7528\u662F\u5C01\u88C5\u4E86\u5BF9\u6570\u636E\u5E93\u7684\u8BBF\u95EE\uFF0C\u4F7F\u5F97\u4E1A\u52A1\u903B\u8F91\u548C\u6570\u636E\u8BBF\u95EE\u903B\u8F91\u5206\u79BB\u5F00\u6765\u3002</p><h3 id="manager-1" tabindex="-1"><a class="header-anchor" href="#manager-1" aria-hidden="true">#</a> manager</h3><p>manager \u76EE\u5F55\u4E2D\u5305\u542B\u4E86\u4E0E\u7528\u6237\u4FE1\u606F\u76F8\u5173\u7684\u4E1A\u52A1\u903B\u8F91\u3002\u5B83\u5B9A\u4E49\u4E86\u4E00\u4E2A Manager \u63A5\u53E3\uFF0C\u7528\u4E8E\u5BF9 user \u8868\u8FDB\u884C\u589E\u5220\u6539\u67E5\u64CD\u4F5C\u3002manager \u76EE\u5F55\u7684\u4E3B\u8981\u4F5C\u7528\u662F\u5C06 DAO \u63A5\u53E3\u8FDB\u4E00\u6B65\u5C01\u88C5\uFF0C\u63D0\u4F9B\u4E86\u66F4\u9AD8\u5C42\u6B21\u7684\u62BD\u8C61\u3002</p><h3 id="models-1" tabindex="-1"><a class="header-anchor" href="#models-1" aria-hidden="true">#</a> models</h3><p>models \u76EE\u5F55\u4E2D\u5B9A\u4E49\u4E86\u4E0E\u7528\u6237\u4FE1\u606F\u76F8\u5173\u7684\u6570\u636E\u7ED3\u6784\u3002\u5B83\u5305\u542B\u4E86\u4E00\u4E2A\u540D\u4E3A User \u7684\u7ED3\u6784\u4F53\uFF0C\u7528\u6765\u8868\u793A user \u8868\u4E2D\u7684\u4E00\u6761\u8BB0\u5F55\u3002User \u7ED3\u6784\u4F53\u7684\u5B57\u6BB5\u4E0E user \u8868\u4E2D\u7684\u5B57\u6BB5\u4E00\u4E00\u5BF9\u5E94\u3002\u5B83\u8FD8\u5B9A\u4E49\u4E86 TableName \u65B9\u6CD5\uFF0C\u7528\u6765\u6307\u5B9A\u8BE5\u7ED3\u6784\u4F53\u5BF9\u5E94\u7684\u8868\u540D\u3002</p><h3 id="service" tabindex="-1"><a class="header-anchor" href="#service" aria-hidden="true">#</a> service</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Service <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// CheckUsersExists check users all exists, if true, return nil</span>
	<span class="token function">CheckUsersExists</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> emails <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> service <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	userManager usermanager<span class="token punctuation">.</span>Manager
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service \u76EE\u5F55\u4E2D\u5305\u542B\u4E86\u4E0E\u7528\u6237\u4FE1\u606F\u76F8\u5173\u7684\u670D\u52A1\u3002\u5B83\u5B9A\u4E49\u4E86\u4E00\u4E2A Service \u63A5\u53E3\uFF0C\u7528\u4E8E\u5BF9 user \u8868\u8FDB\u884C\u589E\u5220\u6539\u67E5\u64CD\u4F5C\u3002service \u76EE\u5F55\u7684\u4E3B\u8981\u4F5C\u7528\u662F\u5C06\u4E1A\u52A1\u903B\u8F91(manager) \u8FDB\u4E00\u6B65\u5C01\u88C5\uFF0C\u63D0\u4F9B\u4E86\u66F4\u9AD8\u5C42\u6B21\u7684\u62BD\u8C61\u3002</p><h3 id="util" tabindex="-1"><a class="header-anchor" href="#util" aria-hidden="true">#</a> util</h3><p>util \u76EE\u5F55\u4E2D\u5305\u542B\u4E86\u4E0E\u7528\u6237\u4FE1\u606F\u76F8\u5173\u7684\u5DE5\u5177\u51FD\u6570\u3002\u5B83\u5B9A\u4E49\u4E86\u4E00\u4E2A\u540D\u4E3A Session \u7684\u7ED3\u6784\u4F53\uFF0C\u7528\u4E8E\u8868\u793A\u7528\u6237\u7684\u4F1A\u8BDD\u4FE1\u606F\u3002Session \u7ED3\u6784\u4F53\u7684\u5B57\u6BB5\u5305\u62EC\u4E86\u7528\u6237\u7684 ID\u3001\u767B\u5F55\u65F6\u95F4\u548C\u8FC7\u671F\u65F6\u95F4\u7B49\u4FE1\u606F\u3002\u5B83\u8FD8\u5305\u542B\u4E86\u4E00\u4E9B\u65B9\u6CD5\uFF0C\u7528\u4E8E\u751F\u6210\u548C\u9A8C\u8BC1\u4F1A\u8BDD\u4FE1\u606F\u3002util \u76EE\u5F55\u7684\u4E3B\u8981\u4F5C\u7528\u662F\u5C01\u88C5\u4E86\u4E0E\u4F1A\u8BDD\u76F8\u5173\u7684\u64CD\u4F5C\u3002</p><p><strong>\u8BBE\u8BA1\u6A21\u5F0F\u7684\u8BBE\u8BA1\u601D\u8DEF\u548C\u65B9\u6CD5</strong>\uFF1A</p><p>DAO \u8BBE\u8BA1\u6A21\u5F0F\u662F\u4E00\u79CD\u7528\u4E8E\u5C06\u6570\u636E\u8BBF\u95EE\u903B\u8F91\u4E0E\u4E1A\u52A1\u903B\u8F91\u5206\u79BB\u7684\u8BBE\u8BA1\u6A21\u5F0F\u3002\u5B83\u7684\u4E3B\u8981\u601D\u60F3\u662F\u5C06\u6570\u636E\u8BBF\u95EE\u903B\u8F91\u5C01\u88C5\u5230\u4E00\u4E2A\u5355\u72EC\u7684\u7C7B\u6216\u63A5\u53E3\u4E2D\uFF0C\u5E76\u7531\u4E00\u4E2A\u6216\u591A\u4E2A\u4E1A\u52A1\u903B\u8F91\u7EC4\u4EF6\u4F7F\u7528\u5B83\u3002\u5728\u8FD9\u4E2A\u6848\u4F8B\u4E2D\uFF0Cdao \u5305\u5B9A\u4E49\u4E86 DAO \u63A5\u53E3\u548C dao \u7ED3\u6784\u4F53\uFF0C\u5B83\u4EEC\u5206\u522B\u7528\u4E8E\u5B9A\u4E49\u548C\u5B9E\u73B0\u5BF9 registry \u8868\u7684\u589E\u5220\u6539\u67E5\u64CD\u4F5C\u3002Manager \u63A5\u53E3\u548C manager \u7ED3\u6784\u4F53\u662F DAO \u63A5\u53E3\u7684\u9AD8\u5C42\u6B21\u5C01\u88C5\uFF0C\u5B83\u4EEC\u8FDB\u4E00\u6B65\u5C06\u6570\u636E\u8BBF\u95EE\u903B\u8F91\u548C\u4E1A\u52A1\u903B\u8F91\u5206\u79BB\u5F00\u6765\u3002\u8FD9\u6837\u5C31\u53EF\u4EE5\u4F7F\u4EE3\u7801\u66F4\u52A0\u6E05\u6670\u6613\u61C2\uFF0C\u5E76\u4E14\u65B9\u4FBF\u7EF4\u62A4\u548C\u6269\u5C55\u3002</p><p>\u4F9D\u8D56\u6CE8\u5165\uFF08DI\uFF09\u8BBE\u8BA1\u6A21\u5F0F\u662F\u4E00\u79CD\u7528\u4E8E\u89E3\u8026\u7EC4\u4EF6\u4E4B\u95F4\u4F9D\u8D56\u5173\u7CFB\u7684\u8BBE\u8BA1\u6A21\u5F0F\u3002\u5B83\u7684\u4E3B\u8981\u601D\u60F3\u662F\u5C06\u4E00\u4E2A\u7EC4\u4EF6\u6240\u4F9D\u8D56\u7684\u5176\u4ED6\u7EC4\u4EF6\u901A\u8FC7\u6784\u9020\u51FD\u6570\u3001\u65B9\u6CD5\u53C2\u6570\u6216\u5C5E\u6027\u6CE8\u5165\u7684\u65B9\u5F0F\u6765\u5B9E\u73B0\u3002\u5728\u8FD9\u4E2A\u6848\u4F8B\u4E2D\uFF0CNewDAO \u51FD\u6570\u4F7F\u7528\u4E86 GORM \u6570\u636E\u5E93\u8FDE\u63A5\u4F5C\u4E3A\u53C2\u6570\uFF0C\u7136\u540E\u5C06\u8FD9\u4E2A\u53C2\u6570\u4F20\u9012\u7ED9 dao.NewDAO \u51FD\u6570\u6765\u521B\u5EFA dao \u7ED3\u6784\u4F53\u7684\u5B9E\u4F8B\u3002\u8FD9\u6837\u5C31\u53EF\u4EE5\u5C06\u6570\u636E\u5E93\u8FDE\u63A5\u4E0E dao \u7ED3\u6784\u4F53\u89E3\u8026\u5F00\u6765\uFF0C\u4F7F\u4EE3\u7801\u66F4\u52A0\u7075\u6D3B\u548C\u53EF\u6269\u5C55\u3002</p><h2 id="rbac-\u76EE\u5F55" tabindex="-1"><a class="header-anchor" href="#rbac-\u76EE\u5F55" aria-hidden="true">#</a> rbac \u76EE\u5F55</h2><p>\u4F5C\u4E3A\u4E00\u4E2A\u8BBF\u95EE\u63A7\u5236\u9897\u7C92\u5EA6\u4EC5\u4EC5\u6B21\u4E8E ABAC \u7684 RBAC\uFF0C\u6211\u4EEC\u770B\u4E00\u4E0B\u5B83\u7684\u6E90\u7801\uFF1A</p><p>\u76EE\u5F55\u7ED3\u6784\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u251C\u2500\u2500 rbac
\u2502   \u251C\u2500\u2500 auth.go
\u2502   \u251C\u2500\u2500 auth_test.go
\u2502   \u251C\u2500\u2500 role
\u2502   \u2502   \u251C\u2500\u2500 roles.go
\u2502   \u2502   \u2514\u2500\u2500 roles_test.go
\u2502   \u2514\u2500\u2500 types
\u2502       \u251C\u2500\u2500 eveluation_helpers.go
\u2502       \u251C\u2500\u2500 types.go
\u2502       \u2514\u2500\u2500 types_test.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u{1F4DC} \u5BF9\u4E0A\u9762\u7684\u89E3\u91CA\uFF1A</p><h2 id="roles" tabindex="-1"><a class="header-anchor" href="#roles" aria-hidden="true">#</a> roles</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> CompResult <span class="token builtin">uint8</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	RoleEqual CompResult <span class="token operator">=</span> <span class="token boolean">iota</span>
	RoleBigger
	RoleSmaller
	RoleCanNotCompare
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	PE         <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;pe&quot;</span>
	Owner      <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;owner&quot;</span>
	Maintainer <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;maintainer&quot;</span>
	Guest      <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;guest&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	ErrorRoleNotFound   <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;role not found&quot;</span><span class="token punctuation">)</span>
	ErrorLoadCheckError <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;load check error&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Service <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// ListRole Lists all the role</span>
	<span class="token function">ListRole</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>types<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// GetRole get role by the role name</span>
	<span class="token function">GetRole</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> roleName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// RoleCompare compare if the role1&#39;s permission is higher than role2</span>
	<span class="token function">RoleCompare</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> role1<span class="token punctuation">,</span> role2 <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>CompResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// GetDefaultRole return the default role(no default role will return nil)</span>
	<span class="token function">GetDefaultRole</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Role
<span class="token punctuation">}</span>

<span class="token keyword">type</span> roleRankMapItem <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	rank <span class="token builtin">int</span>
	role types<span class="token punctuation">.</span>Role
<span class="token punctuation">}</span>
<span class="token keyword">type</span> fileRoleService <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	RolePriorityRankDesc <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	DefaultRoleName      <span class="token builtin">string</span>
	Roles                <span class="token punctuation">[</span><span class="token punctuation">]</span>types<span class="token punctuation">.</span>Role
	DefaultRole          <span class="token operator">*</span>types<span class="token punctuation">.</span>Role
	roleRankMap          <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>roleRankMapItem
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="roles-1" tabindex="-1"><a class="header-anchor" href="#roles-1" aria-hidden="true">#</a> roles</h3><p><code>roles.go</code> \u6587\u4EF6\u5B9A\u4E49\u4E86 <code>Service</code> \u63A5\u53E3\u53CA\u5176\u9ED8\u8BA4\u5B9E\u73B0 <code>fileRoleService</code>\uFF0C\u8FD9\u662F\u4E00\u4E2A\u57FA\u4E8E\u6587\u4EF6\u7684\u89D2\u8272\u670D\u52A1\uFF0C\u5B83\u4ECE JSON \u6587\u4EF6\u4E2D\u8BFB\u53D6\u89D2\u8272\u4FE1\u606F\u3002</p><p><code>Service</code> \u63A5\u53E3\u5B9A\u4E49\u4E86\u4EE5\u4E0B\u65B9\u6CD5\uFF1A</p><ul><li><code>ListRole</code>\uFF1A\u5217\u51FA\u6240\u6709\u89D2\u8272\u3002</li><li><code>GetRole</code>\uFF1A\u6839\u636E\u89D2\u8272\u540D\u79F0\u83B7\u53D6\u89D2\u8272\u4FE1\u606F\u3002</li><li><code>RoleCompare</code>\uFF1A\u6BD4\u8F83\u4E24\u4E2A\u89D2\u8272\u7684\u4F18\u5148\u7EA7\u3002</li><li><code>GetDefaultRole</code>\uFF1A\u83B7\u53D6\u9ED8\u8BA4\u89D2\u8272\u3002</li></ul><p><code>fileRoleService</code> \u7ED3\u6784\u4F53\u5B9E\u73B0\u4E86 <code>Service</code> \u63A5\u53E3 ~</p><ul><li><code>RolePriorityRankDesc</code>\uFF1A\u8868\u793A\u89D2\u8272\u4F18\u5148\u7EA7\u7684\u5B57\u7B26\u4E32\u5207\u7247\u3002</li><li><code>DefaultRoleName</code>\uFF1A\u8868\u793A\u9ED8\u8BA4\u89D2\u8272\u7684\u540D\u79F0\u3002</li><li><code>Roles</code>\uFF1A\u8868\u793A\u6240\u6709\u89D2\u8272\u7684 <code>[]Role</code> \u7C7B\u578B\u7684\u5207\u7247\u3002</li><li><code>DefaultRole</code>\uFF1A\u8868\u793A\u9ED8\u8BA4\u89D2\u8272\u7684 <code>Role</code> \u7C7B\u578B\u3002</li></ul><p>\u8FD9\u4E2A\u7ED3\u6784\u4F53\u8FD8\u5305\u542B\u4E00\u4E2A\u79C1\u6709\u5B57\u6BB5 <code>roleRankMap</code>\uFF0C\u7528\u4E8E\u7F13\u5B58\u89D2\u8272\u7684\u4F18\u5148\u7EA7\u4FE1\u606F\u3002</p><p><code>Roles</code> \u5B57\u6BB5\u4E2D\u5B58\u50A8\u4E86\u6240\u6709\u89D2\u8272\u7684\u4FE1\u606F\uFF0C\u6BCF\u4E2A\u89D2\u8272\u90FD\u662F\u4E00\u4E2A <code>Role</code> \u7ED3\u6784\u4F53\uFF0C\u5305\u542B\u89D2\u8272\u540D\u79F0\u3001\u63CF\u8FF0\u548C\u6743\u9650\u89C4\u5219\u3002\u5176\u4E2D <code>PolicyRules</code> \u5B57\u6BB5\u662F\u4E00\u4E2A <code>[]PolicyRule</code> \u7C7B\u578B\u7684\u5207\u7247\uFF0C\u8868\u793A\u8BE5\u89D2\u8272\u7684\u6240\u6709\u6743\u9650\u89C4\u5219\u3002</p><p><code>GetRole</code> \u65B9\u6CD5\u6839\u636E\u89D2\u8272\u540D\u79F0\u83B7\u53D6\u89D2\u8272\u4FE1\u606F\u3002\u5982\u679C\u6307\u5B9A\u540D\u79F0\u7684\u89D2\u8272\u4E0D\u5B58\u5728\uFF0C\u5219\u8FD4\u56DE\u9519\u8BEF <code>ErrorRoleNotFound</code>\u3002</p><p><code>RoleCompare</code> \u65B9\u6CD5\u6BD4\u8F83\u4E24\u4E2A\u89D2\u8272\u7684\u4F18\u5148\u7EA7\u3002\u5982\u679C\u89D2\u8272 <code>role1</code> \u7684\u6743\u9650\u4F18\u5148\u7EA7\u9AD8\u4E8E <code>role2</code>\uFF0C\u5219\u8FD4\u56DE\u7ED3\u679C <code>RoleBigger</code>\uFF1B\u5982\u679C <code>role1</code> \u7684\u6743\u9650\u4F18\u5148\u7EA7\u4F4E\u4E8E <code>role2</code>\uFF0C\u5219\u8FD4\u56DE\u7ED3\u679C <code>RoleSmaller</code>\u3002\u5982\u679C\u4E24\u4E2A\u89D2\u8272\u7684\u6743\u9650\u4F18\u5148\u7EA7\u76F8\u7B49\uFF0C\u5219\u8FD4\u56DE\u7ED3\u679C <code>RoleEqual</code>\u3002\u5982\u679C\u5176\u4E2D\u4E00\u4E2A\u89D2\u8272\u4E0D\u5B58\u5728\uFF0C\u5219\u8FD4\u56DE\u9519\u8BEF <code>ErrorRoleNotFound</code>\u3002</p><p><code>GetDefaultRole</code> \u65B9\u6CD5\u8FD4\u56DE\u9ED8\u8BA4\u89D2\u8272\u3002\u5982\u679C\u6CA1\u6709\u9ED8\u8BA4\u89D2\u8272\uFF0C\u5219\u8FD4\u56DE <code>nil</code>\u3002</p><h3 id="auth" tabindex="-1"><a class="header-anchor" href="#auth" aria-hidden="true">#</a> auth</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Authorizer use the basic rbac rules to check if the user</span>
<span class="token comment">// have the permissions</span>
<span class="token keyword">type</span> Authorizer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> attributes auth<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> VisitorFunc <span class="token keyword">func</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span>Stringer<span class="token punctuation">,</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>PolicyRule<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>

<span class="token keyword">func</span> <span class="token function">NewAuthorizer</span><span class="token punctuation">(</span>roleservice role<span class="token punctuation">.</span>Service<span class="token punctuation">,</span> memberservice memberservice<span class="token punctuation">.</span>Service<span class="token punctuation">)</span> Authorizer <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>authorizer<span class="token punctuation">{</span>
		roleService<span class="token punctuation">:</span>   roleservice<span class="token punctuation">,</span>
		memberService<span class="token punctuation">:</span> memberservice<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> authorizer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	roleService   role<span class="token punctuation">.</span>Service
	memberService memberservice<span class="token punctuation">.</span>Service
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	NotChecked        <span class="token operator">=</span> <span class="token string">&quot;not checked&quot;</span>
	ResourceFormatErr <span class="token operator">=</span> <span class="token string">&quot;format error&quot;</span>
	AnonymousUser     <span class="token operator">=</span> <span class="token string">&quot;anonymous user&quot;</span>
	InternalError     <span class="token operator">=</span> <span class="token string">&quot;internal error&quot;</span>
	MemberNotExist    <span class="token operator">=</span> <span class="token string">&quot;member not exist&quot;</span>
	RoleNotExist      <span class="token operator">=</span> <span class="token string">&quot;role not exist&quot;</span>
	AdminAllow        <span class="token operator">=</span> <span class="token string">&quot;admin allows everything&quot;</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>auth</code> \u5305\u5B9A\u4E49\u4E86\u7528\u4E8E\u8EAB\u4EFD\u9A8C\u8BC1\u548C\u8BBF\u95EE\u63A7\u5236\u7684\u4EE3\u7801\u3002\u5728\u8FD9\u4E2A\u5305\u4E2D\uFF0C<code>auth.go</code> \u6587\u4EF6\u5B9A\u4E49\u4E86 <code>Authorizer</code> \u63A5\u53E3\u53CA\u5176\u9ED8\u8BA4\u5B9E\u73B0 <code>authorizer</code>\uFF0C\u7528\u4E8E\u68C0\u67E5\u7528\u6237\u662F\u5426\u5177\u6709\u64CD\u4F5C\u8D44\u6E90\u7684\u6743\u9650\u3002</p><p><strong><code>Authorizer</code> \u63A5\u53E3\uFF1A</strong></p><p><code>Authorizer</code> \u63A5\u53E3\u5B9A\u4E49\u4E86\u4E00\u4E2A <code>Authorize</code> \u65B9\u6CD5\uFF0C\u7528\u4E8E\u68C0\u67E5\u7528\u6237\u662F\u5426\u5177\u6709\u64CD\u4F5C\u8D44\u6E90\u7684\u6743\u9650\u3002\u8BE5\u65B9\u6CD5\u63A5\u53D7\u4E00\u4E2A <code>auth.Attributes</code> \u7C7B\u578B\u7684\u53C2\u6570\uFF0C\u8BE5\u53C2\u6570\u5305\u542B\u7528\u6237\u7684\u8EAB\u4EFD\u4FE1\u606F\uFF08\u5982\u7528\u6237\u540D\u3001\u89D2\u8272\u7B49\uFF09\u4EE5\u53CA\u8D44\u6E90\u4FE1\u606F\uFF08\u5982\u8D44\u6E90\u540D\u79F0\u3001\u64CD\u4F5C\u65B9\u5F0F\u7B49\uFF09\u3002\u8BE5\u65B9\u6CD5\u8FD4\u56DE\u4E00\u4E2A <code>auth.Decision</code> \u7C7B\u578B\u7684\u51B3\u7B56\u7ED3\u679C\u3001\u4E00\u4E2A\u5B57\u7B26\u4E32\u7C7B\u578B\u7684\u6D88\u606F\u4EE5\u53CA\u4E00\u4E2A <code>error</code> \u7C7B\u578B\u7684\u9519\u8BEF\u3002\u5176\u4E2D <code>auth.Decision</code> \u7C7B\u578B\u8868\u793A\u51B3\u7B56\u7684\u7ED3\u679C\uFF0C\u53EF\u4EE5\u662F <code>auth.Allow</code>\u3001<code>auth.Deny</code> \u6216 <code>auth.Abstain</code>\u3002</p><p><strong><code>authorizer</code> \u7ED3\u6784\u4F53\uFF1A</strong></p><p><code>authorizer</code> \u7ED3\u6784\u4F53\u5B9E\u73B0\u4E86 <code>Authorizer</code> \u63A5\u53E3\uFF0C\u5B83\u7684\u5B57\u6BB5\u5305\u62EC <code>roleService</code> \u548C <code>memberService</code>\u3002\u5176\u4E2D <code>roleService</code> \u662F\u4E00\u4E2A <code>role.Service</code> \u7C7B\u578B\u7684\u63A5\u53E3\uFF0C\u7528\u4E8E\u83B7\u53D6\u89D2\u8272\u4FE1\u606F\uFF0C<code>memberService</code> \u662F\u4E00\u4E2A <code>memberservice.Service</code> \u7C7B\u578B\u7684\u63A5\u53E3\uFF0C\u7528\u4E8E\u83B7\u53D6\u7528\u6237\u4FE1\u606F\u3002</p><p><code>authorizer</code> \u7ED3\u6784\u4F53\u8FD8\u5305\u542B\u4E00\u4E9B\u5E38\u91CF\uFF0C\u5982 <code>NotChecked</code>\u3001<code>ResourceFormatErr</code>\u3001<code>AnonymousUser</code>\u3001<code>InternalError</code>\u3001<code>MemberNotExist</code> \u548C <code>RoleNotExist</code>\uFF0C\u5206\u522B\u8868\u793A\u672A\u68C0\u67E5\u3001\u8D44\u6E90\u683C\u5F0F\u9519\u8BEF\u3001\u533F\u540D\u7528\u6237\u3001\u5185\u90E8\u9519\u8BEF\u3001\u7528\u6237\u4E0D\u5B58\u5728\u548C\u89D2\u8272\u4E0D\u5B58\u5728\u3002</p><p><code>authorizer</code> \u7ED3\u6784\u4F53\u5B9E\u73B0\u4E86 <code>Authorize</code> \u65B9\u6CD5\uFF0C\u8BE5\u65B9\u6CD5\u9996\u5148\u68C0\u67E5\u8D44\u6E90\u683C\u5F0F\u662F\u5426\u6B63\u786E\uFF0C\u7136\u540E\u83B7\u53D6\u7528\u6237\u548C\u89D2\u8272\u4FE1\u606F\uFF0C\u6700\u540E\u6839\u636E\u89D2\u8272\u548C\u6743\u9650\u89C4\u5219\u5224\u65AD\u7528\u6237\u662F\u5426\u5177\u6709\u64CD\u4F5C\u8D44\u6E90\u7684\u6743\u9650\u3002</p><h3 id="types-\u5305\u8BE6\u89E3" tabindex="-1"><a class="header-anchor" href="#types-\u5305\u8BE6\u89E3" aria-hidden="true">#</a> <code>types</code> \u5305\u8BE6\u89E3</h3><p><code>types</code> \u5305\u5B9A\u4E49\u4E86\u4E0E\u89D2\u8272\u548C\u6743\u9650\u76F8\u5173\u7684\u6570\u636E\u7C7B\u578B\u3002\u5728\u8FD9\u4E2A\u5305\u4E2D\uFF0C<code>types.go</code> \u6587\u4EF6\u5B9A\u4E49\u4E86 <code>Role</code> \u548C <code>PolicyRule</code> \u7ED3\u6784\u4F53\u3002</p><p><strong><code>Role</code> \u7ED3\u6784\u4F53\uFF1A</strong></p><p><code>Role</code> \u7ED3\u6784\u4F53\u8868\u793A\u4E00\u4E2A\u89D2\u8272\uFF0C\u5305\u542B\u89D2\u8272\u7684\u540D\u79F0\u3001\u63CF\u8FF0\u548C\u6743\u9650\u89C4\u5219\u3002\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Role <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name        <span class="token builtin">string</span>       <span class="token string">\`yaml:&quot;name&quot; json:&quot;name&quot;\`</span>
    Desc        <span class="token builtin">string</span>       <span class="token string">\`yaml:&quot;desc&quot; json:&quot;desc&quot;\`</span>
    PolicyRules <span class="token punctuation">[</span><span class="token punctuation">]</span>PolicyRule <span class="token string">\`yaml:&quot;rules&quot; json:&quot;rules&quot;\`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D <code>Name</code> \u5B57\u6BB5\u8868\u793A\u89D2\u8272\u540D\u79F0\uFF0C<code>Desc</code> \u5B57\u6BB5\u8868\u793A\u89D2\u8272\u63CF\u8FF0\uFF0C<code>PolicyRules</code> \u5B57\u6BB5\u662F\u4E00\u4E2A <code>[]PolicyRule</code> \u7C7B\u578B\u7684\u5207\u7247\uFF0C\u8868\u793A\u8BE5\u89D2\u8272\u7684\u6240\u6709\u6743\u9650\u89C4\u5219\u3002</p><p><strong><code>PolicyRule</code> \u7ED3\u6784\u4F53\uFF1A</strong></p><p><code>PolicyRule</code> \u7ED3\u6784\u4F53\u8868\u793A\u4E00\u4E2A\u6743\u9650\u89C4\u5219\uFF0C\u5305\u542B\u6743\u9650\u7684\u8BBF\u95EE\u65B9\u5F0F\u3001\u8D44\u6E90\u3001\u64CD\u4F5C\u8303\u56F4\u7B49\u4FE1\u606F\u3002\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> PolicyRule <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Verbs           <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">\`yaml:&quot;verbs&quot; json:&quot;verbs&quot;\`</span>
    APIGroups       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">\`yaml:&quot;apiGroups&quot; json:&quot;apiGroups&quot;\`</span>
    Resources       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">\`yaml:&quot;resources&quot; json:&quot;resources&quot;\`</span>
    Scopes          <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">\`yaml:&quot;scopes&quot; json:&quot;scopes&quot;\`</span>
    NonResourceURLs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">\`yaml:&quot;nonResourceURLs&quot; json:&quot;nonResourceURLs&quot;\`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D <code>Verbs</code> \u5B57\u6BB5\u662F\u4E00\u4E2A\u5B57\u7B26\u4E32\u5207\u7247\uFF0C\u8868\u793A\u6743\u9650\u7684\u8BBF\u95EE\u65B9\u5F0F\uFF08\u4F8B\u5982 get\u3001list\u3001create\u3001update \u7B49\uFF09\uFF0C<code>APIGroups</code> \u5B57\u6BB5\u662F\u4E00\u4E2A\u5B57\u7B26\u4E32\u5207\u7247\uFF0C\u8868\u793A\u8D44\u6E90\u6240\u5C5E\u7684 API \u7EC4\uFF0C<code>Resources</code> \u5B57\u6BB5\u662F\u4E00\u4E2A\u5B57\u7B26\u4E32\u5207\u7247\uFF0C\u8868\u793A\u8D44\u6E90\u540D\u79F0\uFF0C<code>Scopes</code> \u5B57\u6BB5\u662F\u4E00\u4E2A\u5B57\u7B26\u4E32\u5207\u7247\uFF0C\u8868\u793A\u64CD\u4F5C\u7684\u8303\u56F4\uFF08\u4F8B\u5982 namespace \u7B49\uFF09\uFF0C<code>NonResourceURLs</code> \u5B57\u6BB5\u662F\u4E00\u4E2A\u5B57\u7B26\u4E32\u5207\u7247\uFF0C\u8868\u793A\u975E\u8D44\u6E90 URL\u3002</p><p>\u5728 <code>types.go</code> \u6587\u4EF6\u4E2D\u8FD8\u5B9A\u4E49\u4E86\u4E00\u4E9B\u5E38\u91CF\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
    APIGroupAll    <span class="token operator">=</span> <span class="token string">&quot;*&quot;</span>
    ResourceAll    <span class="token operator">=</span> <span class="token string">&quot;*&quot;</span>
    VerbAll        <span class="token operator">=</span> <span class="token string">&quot;*&quot;</span>
    ScopeAll       <span class="token operator">=</span> <span class="token string">&quot;*&quot;</span>
    NonResourceAll <span class="token operator">=</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D <code>APIGroupAll</code>\u3001<code>ResourceAll</code>\u3001<code>VerbAll</code>\u3001<code>ScopeAll</code>\u3001<code>NonResourceAll</code> \u5206\u522B\u8868\u793A\u6240\u6709 API \u7EC4\u3001\u6240\u6709\u8D44\u6E90\u3001\u6240\u6709\u8BBF\u95EE\u65B9\u5F0F\u3001\u6240\u6709\u64CD\u4F5C\u8303\u56F4\u3001\u6240\u6709\u975E\u8D44\u6E90 URL\u3002</p><h2 id="end-\u94FE\u63A5" tabindex="-1"><a class="header-anchor" href="#end-\u94FE\u63A5" aria-hidden="true">#</a> END \u94FE\u63A5</h2><ul><li><div><a href="40.md" style="float:left;">\u2B06\uFE0F\u4E0A\u4E00\u8282\u{1F517} </a><a href="42.md" style="float:right;"> \uFE0F\u4E0B\u4E00\u8282\u{1F517}</a></div></li></ul>`,102),Y=s("\u24C2\uFE0F\u56DE\u5230\u76EE\u5F55\u{1F3E0}"),Z={href:"https://nsddd.top/archives/contributors",target:"_blank",rel:"noopener noreferrer"},Q=n("strong",null,"\u{1FAF5}\u53C2\u4E0E\u8D21\u732E\u{1F49E}\u2764\uFE0F\u200D\u{1F525}\u{1F496}",-1),X=s(")"),nn=s("\u2734\uFE0F\u7248\u6743\u58F0\u660E \xA9 \uFF1A\u672C\u4E66\u6240\u6709\u5185\u5BB9\u9075\u5FAA"),sn={href:"http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC",target:"_blank",rel:"noopener noreferrer"},an=s("CC-BY-SA 3.0\u534F\u8BAE\uFF08\u7F72\u540D-\u76F8\u540C\u65B9\u5F0F\u5171\u4EAB\uFF09\xA9");function en(tn,on){const e=o("ExternalLinkIcon"),p=o("RouterLink");return l(),c("div",null,[n("ul",null,[n("li",null,[n("a",d,[k,a(e)])])]),v,m,b,n("blockquote",null,[n("p",null,[g,n("a",y,[h,a(e)]),f,n("a",q,[_,a(e)]),x,n("a",R,[D,a(e)])])]),A,n("p",null,[w,C,I,n("a",O,[N,a(e)]),P]),n("p",null,[S,n("a",B,[G,a(e)]),E]),L,n("ul",null,[n("li",null,[n("a",z,[U,a(e)])])]),n("p",null,[M,n("a",j,[$,a(e)]),T]),F,V,H,n("ul",null,[n("li",null,[n("a",K,[J,a(e)])])]),W,n("ul",null,[n("li",null,[n("p",null,[a(p,{to:"/"},{default:u(()=>[Y]),_:1})])]),n("li",null,[n("p",null,[n("a",Z,[Q,a(e)]),X])]),n("li",null,[n("p",null,[nn,n("a",sn,[an,a(e)])])])])])}const ln=i(r,[["render",en],["__file","41.html.vue"]]);export{ln as default};
