import{_ as p,r as o,o as u,c as v,a as s,b as e,w as a,e as n,d as i}from"./app.6a4cbc08.js";const k={},m={href:"http://nsddd.top",target:"_blank",rel:"noopener noreferrer"},b=n("author"),h=s("h1",{id:"\u7B2C14\u8282-k3s",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#\u7B2C14\u8282-k3s","aria-hidden":"true"},"#"),n(" \u7B2C14\u8282 k3s")],-1),g=s("div",null,[s("a",{href:"13.md",style:{float:"left"}},"\u2B06\uFE0F\u4E0A\u4E00\u8282\u{1F517} "),s("a",{href:"15.md",style:{float:"right"}}," \u2B07\uFE0F\u4E0B\u4E00\u8282\u{1F517}")],-1),f=s("br",null,null,-1),_=n("\u2764\uFE0F\u{1F495}\u{1F495}\u65B0\u65F6\u4EE3\u62E5\u62B1\u4E91\u539F\u751F\uFF0C\u4E91\u539F\u751F\u5177\u6709\u73AF\u5883\u7EDF\u4E00\u3001\u6309\u9700\u4ED8\u8D39\u3001\u5373\u5F00\u5373\u7528\u3001\u7A33\u5B9A\u6027\u5F3A\u7279\u70B9\u3002Myblog:"),y={href:"http://nsddd.top/",target:"_blank",rel:"noopener noreferrer"},x=n("http://nsddd.top"),K=s("hr",null,null,-1),S={class:"table-of-contents"},L=n("k3s\u4ECB\u7ECD"),E=n("k3s\u548Ck8s\u533A\u522B"),N=n("\u67B6\u6784"),I=n("Sqlite \u548C Dqlite"),q=n("\u65B0\u7248\u672C\u9ED8\u8BA4\u652F\u6301 etcd"),A=n("\u5728\u7EBF [[docs/Cloud-Native-k8s/15#\u7B2C15\u8282 k3s \u8865\u5145|\u811A\u672C\u5B89\u88C5]] k3s"),C=n("\u5728\u7EBF\u5B89\u88C5\u7684\u89E3\u6790"),w=n("\u5B89\u88C5\u5185\u5BB9"),R=n("\u6267\u884C\u64CD\u4F5C"),T=n("\u6307\u5B9A\u7248\u672C"),O=n("\u6307\u5B9A\u6570\u636E\u5E93"),P=n("\u6307\u5B9A\u5BB9\u5668\u8FD0\u884C\u65F6"),M=n("\u79BB\u7EBF\u5B89\u88C5\u89E3\u91CA"),F=n("\u6B65\u9AA4"),D=n("\u524D\u63D0\u6761\u4EF6"),B=n("Containerd + \u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F"),U=n("Docker + \u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F"),G=n("Containerd + \u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F"),H=n("Containerd + \u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F"),V=n("Docker + \u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F"),$=n("\u5355\u7ED3\u70B9\u9AD8\u53EF\u7528\u79BB\u7EBF\u5B89\u88C5"),X=n("\u4E3Akubelet \u8BBE\u7F6E\u522B\u540D"),W=n("\u6269\u5C55work\u8282\u70B9"),z=n("CRI CNI CSI"),Q=n("\u5D4C\u5165\u5F0F\u6570\u636E\u5E93\u9AD8\u53EF\u7528"),j=n("HA \u90E8\u7F72\u5B9E\u9A8C"),Z=n("\u5378\u8F7Dk3s"),Y=n("\u9488\u5BF9 docker CRI"),J=n("k3s \u7684\u4E00\u4E9B\u91CD\u8981\u76EE\u5F55"),ss=n("/var/lib/rancher/k3s"),ns=n("/etc/rancher"),es=n("/var/run"),as=n("\u955C\u50CF\u52A0\u901F"),ts=n("containerd"),ls=n("\u67B6\u6784\u56FE"),is=n("\u547D\u4EE4"),os=n("containerd\u7684\u914D\u7F6E\u7BA1\u7406"),cs=n("\u4E8C\u8FDB\u5236\u5DE5\u5177"),rs=n("\u8FB9\u7F18\u8BA1\u7B97"),ds=n("\u5355\u8282\u70B9 SQLite \u6269\u5C55\u4E3A etcd \u9AD8\u53EF\u7528"),ps=n("\u5B89\u88C5\u811A\u672C"),us=n("\u7406\u89E3\u5B89\u88C5\u7684\u6B65\u9AA4"),vs=n("\u6807\u5FD7\u548C\u73AF\u5883\u53D8\u91CF"),ks=n("K3s Server/Agent - \u5E38\u7528\u914D\u7F6E"),ms=n("K3s Server/Agent - \u6570\u636E\u5E93\u9009\u9879"),bs=n("K3s \u5B89\u88C5\u4E8B\u9879 - \u7F51\u7EDC\u9009\u9879"),hs=n("\u5916\u90E8\u6570\u636E\u5E93"),gs=n("\u96C6\u7FA4\u6570\u636E\u5B58\u50A8\u9009\u9879"),fs=n("\u79C1\u6709\u955C\u50CF\u4ED3\u5E93"),_s=n("\u5B89\u88C5\u4E8B\u9879 - \u6CE8\u610F\u4E8B\u9879"),ys=n("K3s \u96C6\u7FA4\u5347\u7EA7"),xs=n("K3s \u5907\u4EFD\u6062\u590D"),Ks=n("K3s \u5377\u548C\u5B58\u50A8"),Ss=n("K3s \u7F51\u7EDC\u76F8\u5173"),Ls=n("helm(k3s)"),Es=n("K3s \u9AD8\u7EA7\u9009\u9879"),Ns=n("\u6240\u9047\u5230\u7684\u95EE\u9898"),Is=n("END \u94FE\u63A5"),qs=s("p",null,"[toc]",-1),As=s("h2",{id:"k3s\u4ECB\u7ECD",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#k3s\u4ECB\u7ECD","aria-hidden":"true"},"#"),n(" k3s\u4ECB\u7ECD")],-1),Cs={class:"custom-container tip"},ws=s("p",{class:"custom-container-title"},"k3s \u2014 \u5FAE\u578Bkubernets\u53D1\u884C\u7248",-1),Rs=s("p",null,"k3s\u662F\u7ECFCNCF\u4E00\u81F4\u6027\u8BA4\u8BC1\u7684Kubernetes\u53D1\u884C\u7248\uFF0C\u4E13\u4E3A\u7269\u8054\u7F51\u53CA\u8FB9\u7F18\u8BA1\u7B97\u8BBE\u8BA1\u3002",-1),Ts={href:"https://www.rancher.cn/k3s/",target:"_blank",rel:"noopener noreferrer"},Os=n("\u5B98\u65B9"),Ps={href:"https://docs.rancher.cn/",target:"_blank",rel:"noopener noreferrer"},Ms=n("\u6587\u6863"),Fs={href:"https://github.com/k3s-io/k3s/",target:"_blank",rel:"noopener noreferrer"},Ds=n("\u5F00\u6E90\u5730\u5740"),Bs=i("<p><strong>\u6280\u672F\u4EAE\u70B9\uFF1A</strong></p><ul><li>\u5355\u8FDB\u7A0B\u67B6\u6784\u7B80\u5316\u90E8\u7F72</li><li>\u79FB\u9664\u5404\u79CD\u975E\u5FC5\u8981\u7684\u4EE3\u7801\uFF0C\u51CF\u5C11\u8D44\u6E90\u5360\u7528</li><li><code>TLS</code> \u8BC1\u4E66\u7BA1\u7406</li><li>\u5185\u7F6E <code>Containerd</code></li><li>\u5185\u7F6E\u81EA\u8FD0\u884C <code>rootfs</code></li><li>\u5185\u7F6E <code>Helm Chart</code> \u7BA1\u7406\u673A\u5236</li><li>\u5185\u7F6E <code>L4/L7 LB</code> \u652F\u6301</li></ul><p><strong>\u9002\u5408\u573A\u666F\uFF1A</strong></p><ul><li>\u8FB9\u7F18\u8BA1\u7B97-Edge</li><li>\u7269\u8054\u7F51-IoT</li><li>CI</li><li>Development</li><li>ARM</li><li>\u5D4C\u5165 K8s</li></ul>",4),Us=i('<p><strong>\u67B6\u6784\u56FE\uFF1A</strong></p><p><img src="http://sm.nsddd.top/smhow-it-works-k3s.svg" alt="k3s\u4E0B\u8F7D"></p><h2 id="k3s\u548Ck8s\u533A\u522B" tabindex="-1"><a class="header-anchor" href="#k3s\u548Ck8s\u533A\u522B" aria-hidden="true">#</a> k3s\u548Ck8s\u533A\u522B</h2><div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p>K3s\u662F\u4E00\u4E2A\u72EC\u7ACB\u7684\u670D\u52A1\u5668\uFF0C\u4E0EK8s\u4E0D\u540C\uFF0C\u5B83\u662FKubernetes\u96C6\u7FA4\u7684\u4E00\u90E8\u5206\u3002K8s\u4F9D\u9760CRI-O\u6765\u6574\u5408Kubernetes\u4E0ECRI\uFF08\u5BB9\u5668\u8FD0\u884C\u65F6\u63A5\u53E3\uFF09\uFF0C\u800CK3s\u4F7F\u7528CRI-O\u4E0E\u6240\u6709\u652F\u6301\u7684\u5BB9\u5668\u8FD0\u884C\u65F6\u517C\u5BB9\u3002K8s\u4F7F\u7528kubelet\u6765\u8C03\u5EA6\u5BB9\u5668\uFF0C\u4F46K3s\u4F7F\u7528\u4E3B\u673A\u7684\u8C03\u5EA6\u673A\u5236\u6765\u8C03\u5EA6\u5BB9\u5668\u3002</p></div><p>k3s\u6709\u6BD4k8s\u66F4\u4E25\u683C\u7684\u5B89\u5168\u90E8\u7F72\uFF0C\u56E0\u4E3A\u5176\u653B\u51FB\u9762\u5C0F\u3002k3s\u7684\u53E6\u4E00\u4E2A\u4F18\u52BF\u662F\uFF0C\u5B83\u53EF\u4EE5\u51CF\u5C11\u5B89\u88C5\u3001\u8FD0\u884C\u6216\u66F4\u65B0Kubernetes\u96C6\u7FA4\u6240\u9700\u7684\u4F9D\u8D56\u6027\u548C\u6B65\u9AA4\u3002</p><div class="custom-container warning"><p class="custom-container-title">\u5982\u4F55\u5C01\u88C5 k8s \u2013&gt; k3s \u4E2D</p><p>\u539F\u7406\u5C31\u662F\uFF0C\u5C06 <code>K8S</code> \u7684\u76F8\u5173\u7EC4\u4EF6\u5C01\u88C5\u5230 <code>K3s</code> \u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u4E2D\u53BB\uFF0C\u7136\u540E\u542F\u52A8\u8FD9\u4E8C\u8FDB\u5236\u6587\u4EF6\u5C31\u53EF\u4EE5\u542F\u52A8\u4E00\u4E2A\u6210\u719F\u7684 <code>K8S</code> \u96C6\u7FA4\u3002\u5728\u4E0B\u9762\u{1F53D} \u6211\u4EEC\u53EF\u4EE5\u770B\u5230 <code>K3s</code> \u548C <code>K8S</code> \u7684\u67B6\u6784\u57FA\u672C\u5DEE\u4E0D\u591A\uFF0C\u5176\u4E2D <code>k3s-server</code> \u5BF9\u5E94\u8FD9\u4E2A <code>control-plane</code>\uFF0C\u800C <code>k3s-agent</code> \u5BF9\u5E94\u7740 <code>node</code> \u8282\u70B9\u3002</p><p>\u53EF\u4EE5\u770B\u5230 <code>k3s</code> \u4E2D\u4F7F\u7528\u7684\u9ED8\u8BA4\u5B58\u50A8\u662F <code>SQLite</code>(\u81EA\u5E26)\uFF0C\u4E14\u9ED8\u8BA4\u7684\u7F51\u7EDC\u4F7F\u7528\u7684\u662F <code>Flannel</code>(\u81EA\u5E26)\u3002\u5F53\u670D\u52A1\u7AEF\u548C\u5BA2\u6237\u7AEF\u90FD\u542F\u52A8\u4E4B\u540E\uFF0C\u901A\u8FC7 <code>Tunnel-Proxy</code> \u8FD9\u4E2A\u7EC4\u4EF6\u8FDB\u884C\u901A\u4FE1\uFF0C\u901A\u8FC7\u8FD9\u4E2A\u901A\u9053\u53BB\u7BA1\u7406\u7F51\u7EDC\u6D41\u91CF\u3002\u5728 <code>agent</code> \u8282\u70B9\u4E2D\uFF0C\u901A\u8FC7 <code>kubelet</code> \u64CD\u4F5C <code>contaninerd</code> \u6765\u521B\u5EFA\u5BF9\u5E94 <code>Pod</code>\u3002</p></div><h2 id="\u67B6\u6784" tabindex="-1"><a class="header-anchor" href="#\u67B6\u6784" aria-hidden="true">#</a> \u67B6\u6784</h2><p>k3s\u67B6\u6784\u5C31\u662F\u628Ak8s\u6838\u5FC3\u7EC4\u4EF6\u5C01\u88C5\u6210\u4E8C\u8FDB\u5236~</p><p>k3s\u5206\u4E3A<code>k3s server</code> \u548C <code> k3s agent</code>\uFF1A</p><ul><li>k3s server \u53EA\u6709\u4E00\u4E2A\u8FDB\u7A0B\u4F53</li><li>k3s agent \u5206\u4E3A\u4E24\u4E2A\u8FDB\u7A0B\u4F53\uFF0C\u5176\u4E2D\u4E00\u4E2A\u662F Contrainerd\uFF0C\u8D1F\u8D23\u7BA1\u7406\u8FD0\u884C\u5BB9\u5668</li></ul><blockquote><p>\u5728\u4E0B\u9762\u4E5F\u53EF\u4EE5\u6DF1\u523B\u7406\u89E3\u5230</p></blockquote><p><strong>\u67B6\u6784\u8BE6\u89E3\uFF1A</strong></p>',12),Gs={class:"custom-container details"},Hs=i('<summary>\u67B6\u6784\u8BB2\u89E3</summary><p>k3s\u7B97\u662F\u5BF9k8s\u7684\u67B6\u6784\u548C\u751F\u6001\u8FDB\u884C\u4E00\u90E8\u5206\u7CBE\u534E\u548C\u7F29\u8FDB</p><p><strong>\u5355\u8282\u70B9\u67B6\u6784\uFF1A</strong></p><p>K3s \u5355\u8282\u70B9\u96C6\u7FA4\u7684\u67B6\u6784\u5982\u4E0B\u56FE\u6240\u793A\uFF0C\u8BE5\u96C6\u7FA4\u6709\u4E00\u4E2A\u5185\u5D4C SQLite \u6570\u636E\u5E93\u7684\u5355\u8282\u70B9 <code>K3s server</code> \u3002</p><p>\u5728\u8FD9\u79CD\u914D\u7F6E\u4E2D\uFF0C\u6BCF\u4E2A <code>agent</code> \u8282\u70B9\u90FD\u6CE8\u518C\u5230\u540C\u4E00\u4E2A <code>server</code> \u8282\u70B9\u3002K3s \u7528\u6237\u53EF\u4EE5\u901A\u8FC7\u8C03\u7528 <code>server</code> \u8282\u70B9\u4E0A\u7684 K3s API \u6765\u64CD\u4F5C Kubernetes \u8D44\u6E90\u3002</p><p><strong>\u5355\u8282\u70B9 <code>K3s server</code> \u7684\u67B6\u6784\uFF1A</strong></p><p><img src="http://sm.nsddd.top/sm1660616402558126.png" alt="img"></p><p><strong>\u9AD8\u53EF\u7528\u67B6\u6784\uFF1A</strong></p><p>\u867D\u7136\u5355\u8282\u70B9 k3s \u96C6\u7FA4\u53EF\u4EE5\u6EE1\u8DB3\u5404\u79CD\u7528\u4F8B\uFF0C\u4F46\u5BF9\u4E8E Kubernetes control-plane \u7684\u6B63\u5E38\u8FD0\u884C\u81F3\u5173\u91CD\u8981\u7684\u73AF\u5883\uFF0C\u60A8\u53EF\u4EE5\u5728\u9AD8\u53EF\u7528\u914D\u7F6E\u4E2D\u8FD0\u884C K3s\u3002\u4E00\u4E2A\u9AD8\u53EF\u7528 K3s \u96C6\u7FA4\u7531\u4EE5\u4E0B\u51E0\u4E2A\u90E8\u5206\u7EC4\u6210\uFF1A</p><ul><li><strong><code>K3s server</code> \u8282\u70B9</strong> \uFF1A\u4E24\u4E2A\u6216\u66F4\u591A\u7684<code>server</code>\u8282\u70B9\u5C06\u4E3A Kubernetes API \u63D0\u4F9B\u670D\u52A1\u5E76\u8FD0\u884C\u5176\u4ED6 control-plane \u670D\u52A1</li><li><strong>\u5916\u90E8\u6570\u636E\u5E93</strong> \uFF1A\u4E0E\u5355\u8282\u70B9 k3s \u8BBE\u7F6E\u4E2D\u4F7F\u7528\u7684\u5D4C\u5165\u5F0F <code>SQLite</code> \u6570\u636E\u5B58\u50A8\u76F8\u53CD\uFF0C\u9AD8\u53EF\u7528 K3s \u9700\u8981\u6302\u8F7D\u4E00\u4E2A <code>external database</code> \u5916\u90E8\u6570\u636E\u5E93\u4F5C\u4E3A\u6570\u636E\u5B58\u50A8\u7684\u5A92\u4ECB\u3002</li></ul><p><strong>K3s\u9AD8\u53EF\u7528\u67B6\u6784\uFF08\u975E\u5D4C\u5165\u5F0F\u67B6\u6784\u56FE\uFF09\uFF1A</strong></p><p><img src="http://sm.nsddd.top/sm1660616476551520.png" alt="img"></p><p><strong>\u9AD8\u53EF\u7528\u67B6\u6784\uFF08\u5D4C\u5165\u5F0F\u67B6\u6784\uFF09\uFF1A</strong></p><blockquote><p>\u6CE8\u610F\uFF1A\u9AD8\u53EF\u7528\u7ED3\u6784\u540C\u6837\u53EF\u4EE5\u4F7F\u7528<strong>\u5D4C\u5165\u5F0F\u6570\u636E\u5E93</strong></p><p>\u26A0\uFE0F \u533A\u522B\uFF1A</p><p><strong>\u5D4C\u5165\u6570\u636E\u5E93\u662F\u6307\u6570\u636E\u5728\u5185\u5B58\u4E2D\u6570\u636E\u5E93\uFF0C\u82F1\u6587\u79F0\u4E3A\u2013embedded</strong>\uFF0C\u53C8\u79F0in-memory embedded database\uFF0C\u5982H2, HSQL and Derby databases\u3002</p><p><strong>\u975E\u5D4C\u5165\u5F0F\u6570\u636E\u5E93\u662F\u6307\u6570\u636E\u5728\u78C1\u76D8\u4E2D\u7684\u6570\u636E\u5E93</strong>\uFF0C\u5982MariaDB, MySQL and Oracle\u3002</p></blockquote><p><img src="http://sm.nsddd.top/smimage-20221117173105788.png" alt="image-20221117173105788"></p><p><strong>\u56FA\u5B9A <code>agent</code> \u8282\u70B9\u7684\u6CE8\u518C\u5730\u5740\uFF1A</strong></p><p>\u5728\u9AD8\u53EF\u7528 <code>K3s server</code> \u914D\u7F6E\u4E2D\uFF0C\u6BCF\u4E2A\u8282\u70B9\u8FD8\u5FC5\u987B\u4F7F\u7528\u56FA\u5B9A\u7684\u6CE8\u518C\u5730\u5740\u5411 Kubernetes API \u6CE8\u518C\uFF0C\u6CE8\u518C\u540E\uFF0C <code>agent</code> \u8282\u70B9\u76F4\u63A5\u4E0E\u5176\u4E2D\u4E00\u4E2A <code>server</code> \u8282\u70B9\u5EFA\u7ACB\u8FDE\u63A5\uFF1A</p><img src="http://sm.nsddd.top/sm1660616545857393.svg" alt="k3s-production-setup" style="zoom:25%;"><p><strong>\u6CE8\u518C <code>agent</code> \u8282\u70B9\uFF1A</strong></p><p><code>agent</code> \u8282\u70B9\u7528<code>k3s agent</code>\u8FDB\u7A0B\u53D1\u8D77\u7684 websocket \u8FDE\u63A5\u6CE8\u518C\uFF0C\u8FDE\u63A5\u7531\u4F5C\u4E3A\u4EE3\u7406\u8FDB\u7A0B\u4E00\u90E8\u5206\u8FD0\u884C\u7684\u5BA2\u6237\u7AEF\u8D1F\u8F7D\u5747\u8861\u5668\u7EF4\u62A4\u3002</p><p><code>agent</code> \u5C06\u4F7F\u7528\u8282\u70B9\u96C6\u7FA4 <code>secret</code> \u4EE5\u53CA\u968F\u673A\u751F\u6210\u7684\u8282\u70B9\u5BC6\u7801\u5411 <code>K3s server</code> \u6CE8\u518C\uFF0C\u5BC6\u7801\u5B58\u50A8\u5728 <code>/etc/rancher/node/password</code>\u8DEF\u5F84\u4E0B\u3002 <code>K3s server</code> \u5C06\u628A\u5404\u4E2A\u8282\u70B9\u7684\u5BC6\u7801\u5B58\u50A8\u4E3A <code>Kubernetes secrets</code>\uFF0C\u968F\u540E\u7684\u4EFB\u4F55\u5C1D\u8BD5\u90FD\u5FC5\u987B\u4F7F\u7528\u76F8\u540C\u7684\u5BC6\u7801\u3002\u8282\u70B9\u5BC6\u7801\u79D8\u5BC6\u5B58\u50A8\u5728<code>kube-system</code>\u547D\u540D\u7A7A\u95F4\u4E2D\uFF0C\u540D\u79F0\u4F7F\u7528\u6A21\u677F<code>&lt;host&gt;.node-password.k3s</code>\u3002</p><blockquote><p><strong>\u6CE8\u610F\uFF1A</strong></p><ul><li>\u5728 K3s v1.20.2 \u4E4B\u524D\uFF0C<code> K3s server</code> \u5C06\u5BC6\u7801\u5B58\u50A8\u5728<code>/var/lib/rancher/k3s/server/cred/node-passwd</code>\u7684\u78C1\u76D8\u4E0A\u3002</li><li>\u5982\u679C\u60A8\u5220\u9664\u4E86 <code>agent</code> \u7684<code>/etc/rancher/node</code>\u76EE\u5F55\uFF0C\u5219\u9700\u8981\u4E3A\u8BE5 <code>agent</code> \u91CD\u65B0\u521B\u5EFA\u5BC6\u7801\u6587\u4EF6\uFF0C\u6216\u8005\u4ECE <code>server</code> \u4E2D\u5220\u9664\u8BE5\u6761\u76EE\u3002</li><li>\u901A\u8FC7\u4F7F\u7528<code>--with-node-id</code>\u6807\u5FD7\u542F\u52A8 <code> K3s server</code> \u6216 agent\uFF0C\u53EF\u4EE5\u5C06\u552F\u4E00\u7684\u8282\u70B9 ID \u9644\u52A0\u5230\u4E3B\u673A\u540D\u4E2D\u3002</li></ul></blockquote><p><strong>\u81EA\u52A8\u90E8\u7F72\u7684\u6E05\u5355\uFF1A</strong></p>',23),Vs=n("\u4F4D\u4E8E\u76EE\u5F55\u8DEF\u5F84"),$s=s("code",null,"/var/lib/rancher/k3s/server/manifests",-1),Xs=n(" \u7684\u6E05\u5355\u5728\u6784\u5EFA\u65F6\u88AB\u6346\u7ED1\u5230 K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u4E2D\uFF0C\u5C06\u7531"),Ws={href:"https://github.com/k3s-io/helm-controller#helm-controller",target:"_blank",rel:"noopener noreferrer"},zs=n("rancher/helm-controller"),Qs=n("\u5728\u8FD0\u884C\u65F6\u5B89\u88C5\u3002"),js=s("h2",{id:"sqlite-\u548C-dqlite",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#sqlite-\u548C-dqlite","aria-hidden":"true"},"#"),n(" Sqlite \u548C Dqlite")],-1),Zs=n("\u6211\u8BA4\u4E3A\u6211\u5728\u8FD9\u91CC\u9047\u5230\u4E86\u5F88\u591A\u7591\u60D1\uFF0C\u5173\u4E8E Sqlite \u548C "),Ys={href:"https://github.com/canonical/dqlite/blob/master/README_CH.md",target:"_blank",rel:"noopener noreferrer"},Js=n("Dqlite"),sn=i(`<div class="custom-container tip"><p class="custom-container-title">dqlite</p><p>\u201Cdqlite\u201D\u662F\u201Cdistributed SQLite\u201D\u7684\u7B80\u5199\uFF0C\u5373\u5206\u5E03\u5F0FSQLite\u3002\u610F\u5473\u7740 dqlite \u901A\u8FC7\u7F51\u7EDC\u534F\u8BAE\u6269\u5C55 SQLite \uFF0C\u5C06\u5E94\u7528\u7A0B\u5E8F\u7684\u5404\u4E2A\u5B9E\u4F8B\u8FDE\u63A5\u5728\u4E00\u8D77\uFF0C\u8BA9\u5B83\u4EEC\u4F5C\u4E3A\u4E00\u4E2A\u9AD8\u53EF\u7528\u7684\u96C6\u7FA4\uFF0C\u800C\u4E0D\u4F9D\u8D56\u5916\u90E8\u6570\u636E\u5E93\u3002</p></div><p>\u6211\u5E0C\u671B runtime \u53EF\u4EE5\u5B9E\u73B0 multi-master \uFF0C\u540C\u6837\u652F\u6301\u7684\u5D4C\u5165\u5F0F\u548C\u5916\u90E8DB</p><div class="custom-container danger"><p class="custom-container-title">\u8B66\u544A</p><p>\u5173\u4E8E \u5355\u7ED3\u70B9 \u6269\u5C55\u4E3A \u9AD8\u53EF\u7528 \u72B6\u6001\uFF0C\u6216\u8BB8\u8FD9\u5E76\u4E0D\u662F\u4E00\u4E2A\u5F88\u5BB9\u5668\u5B9E\u73B0\u7684\u5730\u65B9\uFF0C\u6211\u4EEC\u5728\u524D\u9762 details \u4E2D\u770B\u5230\u5355\u7ED3\u70B9\u67B6\u6784\u548C\u9AD8\u53EF\u7528\u67B6\u6784\u7684\u533A\u522B\uFF0C\u6216\u8BB8\u6211\u4EEC\u5E94\u8BE5\u5728\u5236\u4F5C <code>runtime</code> \u6A21\u5757 \u548C <code>rootfs</code> \u7684\u65F6\u5019\u66F4\u503E\u5411\u4E8E\u5B9E\u73B0 \u9AD8\u53EF\u7528\u3002</p></div><h2 id="\u65B0\u7248\u672C\u9ED8\u8BA4\u652F\u6301-etcd" tabindex="-1"><a class="header-anchor" href="#\u65B0\u7248\u672C\u9ED8\u8BA4\u652F\u6301-etcd" aria-hidden="true">#</a> \u65B0\u7248\u672C\u9ED8\u8BA4\u652F\u6301 etcd</h2><div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p>\u4ECE <code>v1.19.5+k3s1</code> \u7248\u672C\u5F00\u59CB\uFF0CK3s \u5DF2\u6DFB\u52A0\u4E86\u5BF9\u5D4C\u5165\u5F0F etcd \u7684\u5B8C\u5168\u652F\u6301\u3002\u4ECE v1.19.1 \u5230 v1.19.4 \u7248\u672C\u53EA\u63D0\u4F9B\u4E86\u5BF9\u5D4C\u5165\u5F0F etcd \u7684\u5B9E\u9A8C\u6027\u652F\u6301\u3002\u5728 K3s v1.19.1 \u7248\u672C\u4E2D\uFF0C\u5D4C\u5165\u5F0F etcd \u53D6\u4EE3\u4E86\u5B9E\u9A8C\u6027\u7684 Dqlite\u3002\u8FD9\u662F\u4E00\u4E2A\u7A81\u7834\u6027\u7684\u53D8\u5316\u3002\u8BF7\u6CE8\u610F\uFF0C\u4E0D\u652F\u6301\u4ECE\u5B9E\u9A8C\u6027 Dqlite \u5347\u7EA7\u5230\u5D4C\u5165\u5F0F etcd\u3002\u5982\u679C\u4F60\u5C1D\u8BD5\u5347\u7EA7\uFF0C\u5347\u7EA7\u5C06\u4E0D\u4F1A\u6210\u529F\uFF0C\u5E76\u4E14\u6570\u636E\u5C06\u4F1A\u4E22\u5931\u3002</p><p>\u5D4C\u5165\u5F0F etcd (HA) \u5728\u901F\u5EA6\u8F83\u6162\u7684\u78C1\u76D8\u4E0A\u53EF\u80FD\u4F1A\u51FA\u73B0\u6027\u80FD\u95EE\u9898\uFF0C\u4F8B\u5982\u4F7F\u7528 SD \u5361\u8FD0\u884C\u7684 Raspberry Pi\u3002</p><p>\u26A0\uFE0F \u6CE8\u610F\uFF0C\u5982\u679C\u4F60\u4F7F\u7528 docker \u4F5C\u4E3Aruntime\uFF0C\u8BF7\u5C0F\u5FC3 docker \u662F\u4E0D\u8BA4\u8BC6 <code>+</code> \uFF0C\u5982\u679C\u4F60\u5E0C\u671B\u7684\u5230\u6307\u5B9A\u7248\u672C\uFF0C\u8BF7\u4F7F\u7528 \uFF1A <code>v1.19.5-k3s1</code></p></div><h2 id="\u5728\u7EBF-docs-cloud-native-k8s-15-\u7B2C15\u8282-k3s-\u8865\u5145-\u811A\u672C\u5B89\u88C5-k3s" tabindex="-1"><a class="header-anchor" href="#\u5728\u7EBF-docs-cloud-native-k8s-15-\u7B2C15\u8282-k3s-\u8865\u5145-\u811A\u672C\u5B89\u88C5-k3s" aria-hidden="true">#</a> \u5728\u7EBF [[docs/Cloud-Native-k8s/15#\u7B2C15\u8282 k3s \u8865\u5145|\u811A\u672C\u5B89\u88C5]] k3s</h2><p><strong>\u5B89\u88C5\u4E4B\u524D\u8BF7\u4FDD\u8BC1 k3s \u7684\u76EE\u5F55\u5E72\u51C0\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc/rancher /var/lib/rancher
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,8),nn={class:"custom-container warning"},en=i(`<p class="custom-container-title">\u542F\u52A8k3s\u6709\u591A\u5FEB\uFF1F</p><p>\u4E00\u884C\u4EE3\u7801\u641E\u5B9A \u2014 \u4EC5\u970030\u79D2\uFF0C\u5373\u53EF\u542F\u52A8k3s\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> -
<span class="token comment"># Check for Ready node, takes maybe 30 seconds</span>
k3s kubectl get <span class="token function">node</span>

<span class="token comment"># if u in china, u can speed up the installation in the following ways</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token function">sh</span> -
<span class="token comment"># -s \u4E0D\u8F93\u51FA\u4EFB\u4F55\u4E1C\u897F  &amp;  -f \u8FDE\u63A5\u5931\u8D25\u65F6\u4E0D\u663E\u793Ahttp\u9519\u8BEF  &amp; -L\u53C2\u6570\u4F1A\u8BA9 HTTP \u8BF7\u6C42\u8DDF\u968F\u670D\u52A1\u5668\u7684\u91CD\u5B9A\u5411\u3002curl \u9ED8\u8BA4\u4E0D\u8DDF\u968F\u91CD\u5B9A\u5411\u3002</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>\u540C\u6837\u4F60\u53EF\u4EE5\u9009\u62E9\u628Ak3s\u90E8\u7F72\u5728docker\u4E2D\uFF0C\u8FD9\u6837\u4F60\u5C31\u53EF\u4EE5\u5F88\u65B9\u4FBF\u7684\u7BA1\u7406k3s</strong></p><p><code>curl -sfL https://get.k3s.io | sh -</code> \u5C06\u5176 <code>server</code> \u548C <code>agent</code> \u90FD\u5B89\u88C5\u4E0A\u4E86\u3002</p><p><strong>\u5982\u4F55\u6269\u5145\u7ED3\u70B9</strong></p></blockquote><p><strong>\u5B89\u88C5\u9009\u9879\uFF1A</strong></p>`,5),an={href:"https://docs.rancher.cn/docs/k3s/installation/install-options/_index#%E4%BD%BF%E7%94%A8%E8%84%9A%E6%9C%AC%E5%AE%89%E8%A3%85%E7%9A%84%E9%80%89%E9%A1%B9",target:"_blank",rel:"noopener noreferrer"},tn=n("\u4F7F\u7528\u811A\u672C\u5B89\u88C5\u7684\u9009\u9879"),ln={href:"https://docs.rancher.cn/docs/k3s/installation/install-options/_index#%E4%BB%8E%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E7%9A%84%E9%80%89%E9%A1%B9",target:"_blank",rel:"noopener noreferrer"},on=n("\u4ECE\u4E8C\u8FDB\u5236\u4E2D\u5B89\u88C5\u7684\u9009\u9879"),cn={href:"https://docs.rancher.cn/docs/k3s/installation/install-options/_index#k3s-server-%E7%9A%84%E6%B3%A8%E5%86%8C%E9%80%89%E9%A1%B9",target:"_blank",rel:"noopener noreferrer"},rn=n("K3s server \u7684\u6CE8\u518C\u9009\u9879"),dn={href:"https://docs.rancher.cn/docs/k3s/installation/install-options/_index#k3s-agent-%E7%9A%84%E6%B3%A8%E5%86%8C%E9%80%89%E9%A1%B9",target:"_blank",rel:"noopener noreferrer"},pn=n("K3s agent \u7684\u6CE8\u518C\u9009\u9879"),un={href:"https://docs.rancher.cn/docs/k3s/installation/install-options/_index#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6",target:"_blank",rel:"noopener noreferrer"},vn=n("\u914D\u7F6E\u6587\u4EF6"),kn=s("p",null,[s("strong",null,"\u79BB\u7EBF\u5B89\u88C5\uFF1A")],-1),mn={href:"https://docs.rancher.cn/docs/k3s/installation/airgap/_index/",target:"_blank",rel:"noopener noreferrer"},bn=n("https://docs.rancher.cn/docs/k3s/installation/airgap/_index/"),hn=i(`<p>\u65E5\u5FD7\u67E5\u770Bk3s\u542F\u52A8\u4FE1\u606F\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/log/syslog
<span class="token comment"># \u6216\u8005</span>
kubectl get all <span class="token parameter variable">-n</span> kube-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),gn=i(`<div class="custom-container danger"><p class="custom-container-title">\u76F8\u6BD4\u8F83\u4E8C\u8FDB\u5236\uFF0C\u63A8\u8350\u811A\u672C\u5B89\u88C5</p><p>\u867D\u7136\u53EF\u4EE5\u901A\u8FC7\u4E0B\u8F7D\u4E8C\u8FDB\u5236\u6587\u4EF6\u8FDB\u884C\u670D\u52A1\u7AEF\u548C\u5DE5\u4F5C\u8282\u70B9\u7684\u8FD0\u884C(<code>./k3s server</code>)\uFF0C\u4F46\u662F\u4E00\u65E6\u6211\u4EEC\u9000\u51FA\u8FDB\u7A0B\uFF0C\u4E4B\u524D\u521B\u5EFA\u7684\u8282\u70B9\u4E5F\u5C31\u7ACB\u5373\u9500\u6BC1\u4E86\uFF0C\u6240\u4EE5\u8FD8\u662F\u5EFA\u8BAE\u4F7F\u7528\u811A\u672C\u8FDB\u884C\u5B89\u88C5\u3002</p><p>\u26A0\uFE0F \u591A\u8BF4\u51E0\u53E5\uFF1A\u4E4B\u524D\u4E0D\u662F\u5F88\u7406\u89E3\uFF0Cxian&#39;z</p></div><h2 id="\u5728\u7EBF\u5B89\u88C5\u7684\u89E3\u6790" tabindex="-1"><a class="header-anchor" href="#\u5728\u7EBF\u5B89\u88C5\u7684\u89E3\u6790" aria-hidden="true">#</a> \u5728\u7EBF\u5B89\u88C5\u7684\u89E3\u6790</h2><h3 id="\u5B89\u88C5\u5185\u5BB9" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5\u5185\u5BB9" aria-hidden="true">#</a> \u5B89\u88C5\u5185\u5BB9</h3><ul><li><code>kubectl</code>\u3001<code>crictl</code>\u3001<code>ctr</code></li><li><code>k3s-killall.sh</code>\u3001<code>k3s-uninstall.sh</code></li></ul><h3 id="\u6267\u884C\u64CD\u4F5C" tabindex="-1"><a class="header-anchor" href="#\u6267\u884C\u64CD\u4F5C" aria-hidden="true">#</a> \u6267\u884C\u64CD\u4F5C</h3><ul><li>\u5C06 <code>kubeconfig</code> \u6587\u4EF6\u5199\u5165\u5230 <code>/etc/rancher/k3s/k3s.yaml</code> \u91CC\u9762</li><li>\u7531 <code>K3s</code> \u5B89\u88C5\u7684 <code>kubectl</code> \u5DE5\u5177\u5C06\u81EA\u52A8\u4F7F\u7528\u8BE5\u6587\u4EF6\u7684\u914D\u7F6E\u6765\u8FD0\u884C</li><li>\u5176\u4ED6\u673A\u5668\u53EF\u4EE5\u901A\u8FC7\u590D\u5236\u8FD9\u4E2A\u914D\u7F6E\u6587\u4EF6\u5E76\u4FEE\u6539 <code>server</code> \u5730\u5740\u6765\u64CD\u4F5C <code>K3s</code> \u96C6\u7FA4</li></ul><h3 id="\u6307\u5B9A\u7248\u672C" tabindex="-1"><a class="header-anchor" href="#\u6307\u5B9A\u7248\u672C" aria-hidden="true">#</a> \u6307\u5B9A\u7248\u672C</h3><p><strong>\u6211\u4EEC\u524D\u9762\u9ED8\u8BA4\u5B89\u88C5\u6700\u65B0\u7248\uFF0C\u6216\u8BB8\u6211\u4EEC\u53EF\u4EE5\u6307\u5B9A\u7248\u672C\u5B89\u88C5\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_VERSION</span><span class="token operator">=</span>v1.25.3 <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u6307\u5B9A\u6570\u636E\u5E93" tabindex="-1"><a class="header-anchor" href="#\u6307\u5B9A\u6570\u636E\u5E93" aria-hidden="true">#</a> \u6307\u5B9A\u6570\u636E\u5E93</h3><div class="custom-container tip"><p class="custom-container-title">\u573A\u666F</p><p><img src="http://sm.nsddd.top/smimage-20221124193104746.png" alt="image-20221124193104746"></p></div><p><strong>\u4EE5MySQL\u4E3A\u4F8B\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server --datastore-endpoint<span class="token operator">=</span><span class="token string">&#39;mysql://admin:Rancher2019k3s@tcp(k3s-mysql.csrskwupj33i.ca-central-1.rds.amazonaws.com:3306)/k3sdb&#39;</span>
<span class="token comment"># \u6CE8\u610Fdatabase name\u4E0D\u8981\u52A0\u7279\u6B8A\u5B57\u7B26</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u4EFB\u610F\u8282\u70B9\u67E5\u770Bnode\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kubectl get no
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u6307\u5B9A\u5BB9\u5668\u8FD0\u884C\u65F6" tabindex="-1"><a class="header-anchor" href="#\u6307\u5B9A\u5BB9\u5668\u8FD0\u884C\u65F6" aria-hidden="true">#</a> \u6307\u5B9A\u5BB9\u5668\u8FD0\u884C\u65F6</h3><p><strong>\u8FD0\u884C\u65F6\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--docker&quot;</span> <span class="token function">sh</span> -

<span class="token comment"># Domestic mirror acceleration</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--docker&quot;</span>  <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u8FD9\u6837\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528 docker \u6765\u7BA1\u7406 k3s</p></blockquote><table><thead><tr><th>Flag</th><th>\u9ED8\u8BA4\u503C</th><th>\u63CF\u8FF0</th></tr></thead><tbody><tr><td><code>--docker</code></td><td>N/A</td><td>\u7528 docker \u4EE3\u66FF containerd</td></tr><tr><td><code>--container-runtime-endpoint</code> value</td><td>N/A</td><td>\u7981\u7528\u5D4C\u5165\u5F0F containerd\uFF0C\u4F7F\u7528\u66FF\u4EE3\u7684 CRI \u5B9E\u73B0\u3002</td></tr><tr><td><code>--pause-image</code> value</td><td>&quot;docker.io/rancher/pause:3.1&quot;</td><td>\u9488\u5BF9 containerd \u6216 Docker \u7684\u81EA\u5B9A\u4E49 pause \u955C\u50CF</td></tr><tr><td><code>--snapshotter</code> value</td><td>N/A</td><td>\u8986\u76D6\u9ED8\u8BA4\u7684 containerd \u5FEB\u7167\u7A0B\u5E8F (\u9ED8\u8BA4: &quot;overlayfs&quot;)</td></tr><tr><td><code>--private-registry</code> value</td><td>&quot;/etc/rancher/k3s/registries.yaml&quot;</td><td>\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u914D\u7F6E\u6587\u4EF6</td></tr></tbody></table><details class="custom-container details"><summary>k3s\u5B89\u88C5\u52A8\u6001</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/sealos<span class="token comment"># curl -fL https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
<span class="token number">100</span> <span class="token number">29713</span>  <span class="token number">100</span> <span class="token number">29713</span>    <span class="token number">0</span>     <span class="token number">0</span>   148k      <span class="token number">0</span> --:--:-- --:--:-- --:--:--  149k
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Finding release <span class="token keyword">for</span> channel stable
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Using v1.25.3+k3s1 as release
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Downloading <span class="token builtin class-name">hash</span> rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/v1.25.3-k3s1/sha256sum-amd64.txt
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Downloading binary rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/v1.25.3-k3s1/k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Verifying binary download
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Installing k3s to /usr/local/bin/k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping installation of SELinux RPM
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating /usr/local/bin/kubectl symlink to k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating /usr/local/bin/crictl symlink to k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping /usr/local/bin/ctr symlink to k3s, <span class="token builtin class-name">command</span> exists <span class="token keyword">in</span> <span class="token environment constant">PATH</span> at /usr/bin/ctr
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating <span class="token function">killall</span> script /usr/local/bin/k3s-killall.sh
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  env: Creating environment <span class="token function">file</span> /etc/systemd/system/k3s.service.env
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Creating <span class="token function">service</span> <span class="token function">file</span> /etc/systemd/system/k3s.service
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service \u2192 /etc/systemd/system/k3s.service.
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Starting k3s
<span class="token comment">################################################################################</span>
root@ubuntu:/sealos<span class="token comment"># k3s</span>
NAME:
   k3s - Kubernetes, but small and simple

USAGE:
   k3s <span class="token punctuation">[</span>global options<span class="token punctuation">]</span> <span class="token builtin class-name">command</span> <span class="token punctuation">[</span>command options<span class="token punctuation">]</span> <span class="token punctuation">[</span>arguments<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

VERSION:
   v1.25.3+k3s1 <span class="token punctuation">(</span>f2585c16<span class="token punctuation">)</span>

COMMANDS:
   server           Run management server
   agent            Run <span class="token function">node</span> agent
   kubectl          Run kubectl
   crictl           Run crictl
   ctr              Run ctr
   check-config     Run config check
   etcd-snapshot    Trigger an immediate etcd snapshot
   secrets-encrypt  Control secrets encryption and keys rotation
   certificate      Certificates management
   completion       Install shell completion script
   help, h          Shows a list of commands or <span class="token builtin class-name">help</span> <span class="token keyword">for</span> one <span class="token builtin class-name">command</span>

GLOBAL OPTIONS:
   <span class="token parameter variable">--debug</span>                     <span class="token punctuation">(</span>logging<span class="token punctuation">)</span> Turn on debug logs <span class="token punctuation">[</span><span class="token variable">$K3S_DEBUG</span><span class="token punctuation">]</span>
   --data-dir value, <span class="token parameter variable">-d</span> value  <span class="token punctuation">(</span>data<span class="token punctuation">)</span> Folder to hold state <span class="token punctuation">(</span>default: /var/lib/rancher/k3s or <span class="token variable">\${<span class="token environment constant">HOME</span>}</span>/.rancher/k3s <span class="token keyword">if</span> not root<span class="token punctuation">)</span>
   --help, <span class="token parameter variable">-h</span>                  show <span class="token builtin class-name">help</span>
   --version, <span class="token parameter variable">-v</span>               print the version

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h2 id="\u79BB\u7EBF\u5B89\u88C5\u89E3\u91CA" tabindex="-1"><a class="header-anchor" href="#\u79BB\u7EBF\u5B89\u88C5\u89E3\u91CA" aria-hidden="true">#</a> \u79BB\u7EBF\u5B89\u88C5\u89E3\u91CA</h2>`,22),fn={class:"custom-container tip"},_n=i(`<p class="custom-container-title">\u63D0\u9192</p><p>\u4E0B\u8F7D\u79BB\u7EBF\u5B89\u88C5\u811A\u672C\uFF1Ahttps://get.k3s.io</p><p>\u4E0B\u8F7D<strong>k3s</strong>\u4E8C\u8FDB\u5236\u6587\u4EF6\uFF1Ak3s</p><p>\u4E0B\u8F7D\u5FC5\u8981\u7684<code>images</code>\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://ghproxy.com/https://github.com/k3s-io/k3s/releases/download/v1.25.3%2Bk3s1/k3s-airgap-images-amd64.tar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,5),yn=n("These files are available in the "),xn={href:"https://github.com/k3s-io/k3s/",target:"_blank",rel:"noopener noreferrer"},Kn=n("GitHub"),Sn=n(" repository"),Ln=s("p",null,[s("img",{src:"http://sm.nsddd.top/smimage-20221109164523589.png",alt:"image-20221109164523589"})],-1),En=i('<h3 id="\u6B65\u9AA4" tabindex="-1"><a class="header-anchor" href="#\u6B65\u9AA4" aria-hidden="true">#</a> \u6B65\u9AA4</h3><p><strong>\u6B65\u9AA4 1</strong>\uFF1A\u90E8\u7F72\u955C\u50CF\uFF0C\u672C\u6587\u63D0\u4F9B\u4E86\u4E24\u79CD\u90E8\u7F72\u65B9\u5F0F\uFF0C\u5206\u522B\u662F<strong>\u90E8\u7F72\u79C1\u6709\u955C\u50CF\u4ED3\u5E93</strong>\u548C<strong>\u624B\u52A8\u90E8\u7F72\u955C\u50CF</strong>\u3002\u8BF7\u5728\u8FD9\u4E24\u79CD\u65B9\u5F0F\u4E2D\u9009\u62E9\u4E00\u79CD\u6267\u884C\u3002</p><p><strong>\u6B65\u9AA4 2</strong>\uFF1A\u5B89\u88C5 K3s\uFF0C\u672C\u6587\u63D0\u4F9B\u4E86\u4E24\u79CD\u5B89\u88C5\u65B9\u5F0F\uFF0C\u5206\u522B\u662F<strong>\u5355\u8282\u70B9\u5B89\u88C5</strong>\u548C<strong>\u9AD8\u53EF\u7528\u5B89\u88C5</strong>\u3002\u5B8C\u6210\u955C\u50CF\u90E8\u7F72\u540E\uFF0C\u8BF7\u5728\u8FD9\u4E24\u79CD\u65B9\u5F0F\u4E2D\u9009\u62E9\u4E00\u79CD\u6267\u884C\u3002</p><p><strong>\u79BB\u7EBF\u5347\u7EA7 K3s \u7248\u672C</strong>\uFF1A\u5B8C\u6210\u79BB\u7EBF\u5B89\u88C5 K3s \u540E\uFF0C\u60A8\u8FD8\u53EF\u4EE5\u901A\u8FC7\u811A\u672C\u5347\u7EA7 K3s \u7248\u672C\uFF0C\u6216\u542F\u7528\u81EA\u52A8\u5347\u7EA7\u529F\u80FD\uFF0C\u4EE5\u4FDD\u6301\u79BB\u7EBF\u73AF\u5883\u4E2D\u7684 K3s \u7248\u672C\u4E0E\u6700\u65B0\u7684 K3s \u7248\u672C\u540C\u6B65\u3002</p><p><strong>\u8BF7\u6309\u7167\u4EE5\u4E0B\u6B65\u9AA4\u51C6\u5907\u955C\u50CF\u76EE\u5F55\u548C K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\uFF1A</strong></p><blockquote><p>\u6211\u8BA4\u4E3A\u79BB\u7EBF\u5B89\u88C5\u7684\u91CD\u70B9\u5728\u4E8E<strong>K3s \u4F9D\u8D56\u7684\u955C\u50CF</strong>\u90E8\u5206\uFF0C\u56E0\u4E3A K3s \u7684&quot;\u5B89\u88C5\u811A\u672C&quot;\u548C&quot;\u4E8C\u8FDB\u5236\u6587\u4EF6&quot;\u53EA\u9700\u8981\u4E0B\u8F7D\u5230\u5BF9\u5E94\u76EE\u5F55\uFF0C\u7136\u540E\u8D4B\u4E88\u76F8\u5E94\u7684\u6743\u9650\u5373\u53EF\uFF0C\u975E\u5E38\u7B80\u5355\u3002\u4F46K3s \u4F9D\u8D56\u7684\u955C\u50CF\u7684\u5B89\u88C5\u65B9\u5F0F\u53D6\u51B3\u4E8E\u4F60\u4F7F\u7528\u7684\u662F\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u8FD8\u662F\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\uFF0C\u4E5F\u53D6\u51B3\u4E8E\u5BB9\u5668\u8FD0\u884C\u65F6\u4F7F\u7528\u7684\u662F <code>containerd</code> \u8FD8\u662F<code>docker</code>\u3002</p><p>\u9488\u5BF9\u4E0D\u540C\u7684\u7EC4\u5408\u5F62\u5F0F\uFF0C\u53EF\u4EE5\u5206\u4E3A\u4EE5\u4E0B\u51E0\u79CD\u5F62\u5F0F\u6765\u5B9E\u73B0\u79BB\u7EBF\u5B89\u88C5\uFF1A</p><ul><li>Containerd + \u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F</li><li>Docker + \u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F</li><li>Containerd + \u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F</li><li>Docker + \u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F</li></ul></blockquote>',6),Nn=n("\u4ECE"),In={href:"https://github.com/rancher/k3s/releases",target:"_blank",rel:"noopener noreferrer"},qn=n("K3s GitHub Release"),An=n("\u9875\u9762\u83B7\u53D6\u4F60\u6240\u8FD0\u884C\u7684 K3s \u7248\u672C\u7684\u955C\u50CF tar \u6587\u4EF6\u3002("),Cn=s("strong",null,"airgap-images",-1),wn=n(")"),Rn=i(`<li><p>\u5C06 tar \u6587\u4EF6\u653E\u5728<code>images</code>\u76EE\u5F55\u4E0B\uFF0C\u4F8B\u5982\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/rancher/k3s/agent/images/
<span class="token function">sudo</span> <span class="token function">cp</span> ./k3s-airgap-images-<span class="token variable">$ARCH</span>.tar /var/lib/rancher/k3s/agent/images/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li>`,1),Tn=n("\u5C06 k3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u653E\u5728 "),On=s("code",null,"/usr/local/bin/k3s",-1),Pn=n("\u8DEF\u5F84\u4E0B\uFF0C\u5E76\u786E\u4FDD\u62E5\u6709\u53EF\u6267\u884C\u6743\u9650\u3002\u5B8C\u6210\u540E\uFF0C\u73B0\u5728\u53EF\u4EE5\u8F6C\u5230\u4E0B\u9762\u7684"),Mn={href:"https://docs.rancher.cn/docs/k3s/installation/airgap/_index#%E5%AE%89%E8%A3%85-k3s",target:"_blank",rel:"noopener noreferrer"},Fn=n("\u5B89\u88C5 K3s"),Dn=n("\u90E8\u5206\uFF0C\u5F00\u59CB\u5B89\u88C5 K3s\u3002"),Bn=s("h3",{id:"\u524D\u63D0\u6761\u4EF6",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#\u524D\u63D0\u6761\u4EF6","aria-hidden":"true"},"#"),n(" \u524D\u63D0\u6761\u4EF6")],-1),Un=n("\u5728\u5B89\u88C5 K3s \u4E4B\u524D\uFF0C\u5B8C\u6210\u4E0A\u9762\u7684"),Gn={href:"https://docs.rancher.cn/docs/k3s/installation/airgap/_index#%E9%83%A8%E7%BD%B2%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93",target:"_blank",rel:"noopener noreferrer"},Hn=n("\u90E8\u7F72\u79C1\u6709\u955C\u50CF\u4ED3\u5E93"),Vn=n("\u6216"),$n={href:"https://docs.rancher.cn/docs/k3s/installation/airgap/_index#%E6%89%8B%E5%8A%A8%E9%83%A8%E7%BD%B2%E9%95%9C%E5%83%8F",target:"_blank",rel:"noopener noreferrer"},Xn=n("\u624B\u52A8\u90E8\u7F72\u955C\u50CF"),Wn=n("\uFF0C\u5BFC\u5165\u5B89\u88C5 K3s \u6240\u9700\u8981\u7684\u955C\u50CF\u3002"),zn=n("\u4ECE "),Qn={href:"https://github.com/rancher/k3s/releases",target:"_blank",rel:"noopener noreferrer"},jn=n("release"),Zn=n(" \u9875\u9762\u4E0B\u8F7D K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\uFF0CK3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u9700\u8981\u4E0E\u79BB\u7EBF\u955C\u50CF\u7684\u7248\u672C\u5339\u914D\u3002\u5C06\u4E8C\u8FDB\u5236\u6587\u4EF6\u653E\u5728\u6BCF\u4E2A\u79BB\u7EBF\u8282\u70B9\u7684 "),Yn=s("code",null,"/usr/local/bin",-1),Jn=n(" \u4E2D\uFF0C\u5E76\u786E\u4FDD\u8FD9\u4E2A\u4E8C\u8FDB\u5236\u6587\u4EF6\u662F\u53EF\u6267\u884C\u7684\u3002"),se=n("\u4E0B\u8F7D K3s \u5B89\u88C5\u811A\u672C\uFF1A"),ne={href:"https://get.k3s.io/",target:"_blank",rel:"noopener noreferrer"},ee=n("https://get.k3s.io"),ae=n(" \u3002\u5C06\u5B89\u88C5\u811A\u672C\u653E\u5728\u6BCF\u4E2A\u79BB\u7EBF\u8282\u70B9\u7684\u4EFB\u610F\u5730\u65B9\uFF0C\u5E76\u547D\u540D\u4E3A "),te=s("code",null,"install.sh",-1),le=n("\u3002"),ie=i(`<p>\u5F53\u4F7F\u7528 <code>INSTALL_K3S_SKIP_DOWNLOAD</code> \u73AF\u5883\u53D8\u91CF\u8FD0\u884C K3s \u811A\u672C\u65F6\uFF0CK3s \u5C06\u4F7F\u7528\u672C\u5730\u7684\u811A\u672C\u548C\u4E8C\u8FDB\u5236\u3002</p><div class="custom-container warning"><p class="custom-container-title">\u63D0\u9192 u</p><p>\u60A8\u53EF\u4EE5\u5728\u79BB\u7EBF\u73AF\u5883\u4E2D\u6267\u884C\u5355\u8282\u70B9\u5B89\u88C5\uFF0C\u5728\u4E00\u4E2A server\uFF08\u8282\u70B9\uFF09\u4E0A\u5B89\u88C5 K3s\uFF0C\u6216\u9AD8\u53EF\u7528\u5B89\u88C5\uFF0C\u5728\u591A\u4E2A server\uFF08\u8282\u70B9\uFF09\u4E0A\u5B89\u88C5 K3s\u3002</p><p>\u5BF9\u5B89\u88C5\u811A\u672C\u8FDB\u884C\u7B80\u5355\u7684\u4FEE\u6539\uFF08ghproxy\uFF09\uFF0C\u5728\u6700\u540E\u53EF\u4EE5\u770B\u5230 \u5B89\u88C5\u811A\u672C~</p></div><h3 id="containerd-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#containerd-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F" aria-hidden="true">#</a> Containerd + \u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F</h3><details class="custom-container details"><summary>\u5C55\u5F00\u67E5\u770B\u6B65\u9AA4</summary><p>\u5047\u8BBE\u4F60\u5DF2\u7ECF\u5C06\u540C\u4E00\u7248\u672C\u7684 K3s \u7684\u5B89\u88C5\u811A\u672C(<code>k3s-install.sh</code>)\u3001K3s \u7684\u4E8C\u8FDB\u5236\u6587\u4EF6(<code>k3s</code>)\u3001K3s \u4F9D\u8D56\u7684\u955C\u50CF(<code>k3s-airgap-images-amd64.tar</code>)\u4E0B\u8F7D\u5230\u4E86<code>/root</code>\u76EE\u5F55\u4E0B\u3002</p><p>\u5982\u679C\u4F60\u4F7F\u7528\u7684\u5BB9\u5668\u8FD0\u884C\u65F6\u4E3Acontainerd\uFF0C\u5728\u542F\u52A8 K3s \u65F6\uFF0C\u5B83\u4F1A\u68C0\u67E5<code>/var/lib/rancher/k3s/agent/images/</code>\u662F\u5426\u5B58\u5728\u53EF\u7528\u7684\u955C\u50CF\u538B\u7F29\u5305\uFF0C\u5982\u679C\u5B58\u5728\uFF0C\u5C31\u5C06\u8BE5\u955C\u50CF\u5BFC\u5165\u5230 <code>containerd</code> \u955C\u50CF\u5217\u8868\u4E2D\u3002\u6240\u4EE5\u6211\u4EEC\u53EA\u9700\u8981\u4E0B\u8F7D <code>K3s</code> \u4F9D\u8D56\u7684\u955C\u50CF\u5230<code>/var/lib/rancher/k3s/agent/images/</code>\u76EE\u5F55\uFF0C\u7136\u540E\u542F\u52A8 <code>K3s</code> \u5373\u53EF\u3002</p><p><strong>1. \u5BFC\u5165\u955C\u50CF\u5230 <code>containerd</code> \u7684\u955C\u50CF\u5217\u8868\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/rancher/k3s/agent/images/
<span class="token function">sudo</span> <span class="token function">cp</span> /root/k3s-airgap-images-amd64.tar /var/lib/rancher/k3s/agent/images/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. \u5C06 K3s \u5B89\u88C5\u811A\u672C\u548C K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u79FB\u52A8\u5230\u5BF9\u5E94\u76EE\u5F55\u5E76\u6388\u4E88\u53EF\u6267\u884C\u6743\u9650</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">chmod</span> a+x /root/k3s /root/k3s-install.sh
<span class="token function">sudo</span> <span class="token function">cp</span> /root/k3s /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. \u5B89\u88C5 K3s</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_SKIP_DOWNLOAD</span><span class="token operator">=</span>true /root/k3s-install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></details><details class="custom-container details"><summary>\u6F14\u793A</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># cp k3s-install.sh /root/k3s-install.sh</span>
<span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># ls </span>
images  k3s  k3s-install.sh  Kubefile  sealer-runtime-demo
<span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># cp k3s  /root/k3s</span>
<span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># sudo chmod a+x /root/k3s /root/k3s-install.sh</span>
<span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># sudo cp /root/k3s /usr/local/bin/</span>
<span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># INSTALL_K3S_SKIP_DOWNLOAD=true /root/k3s-install.sh</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping k3s download and verify
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping installation of SELinux RPM
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping /usr/local/bin/kubectl symlink to k3s, <span class="token builtin class-name">command</span> exists <span class="token keyword">in</span> <span class="token environment constant">PATH</span> at /usr/bin/kubectl
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping /usr/local/bin/crictl symlink to k3s, <span class="token builtin class-name">command</span> exists <span class="token keyword">in</span> <span class="token environment constant">PATH</span> at /usr/bin/crictl
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping /usr/local/bin/ctr symlink to k3s, <span class="token builtin class-name">command</span> exists <span class="token keyword">in</span> <span class="token environment constant">PATH</span> at /usr/bin/ctr
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating <span class="token function">killall</span> script /usr/local/bin/k3s-killall.sh
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  env: Creating environment <span class="token function">file</span> /etc/systemd/system/k3s.service.env
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Creating <span class="token function">service</span> <span class="token function">file</span> /etc/systemd/system/k3s.service
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Enabling k3s unit
Created symlink from /etc/systemd/system/multi-user.target.wants/k3s.service to /etc/systemd/system/k3s.service.
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Starting k3s
Failed to restart k3s.service: Unit is not loaded properly: Invalid argument.
See system logs and <span class="token string">&#39;systemctl status k3s.service&#39;</span> <span class="token keyword">for</span> details.
<span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># k3s</span>
NAME:
   k3s - Kubernetes, but small and simple

USAGE:
   k3s <span class="token punctuation">[</span>global options<span class="token punctuation">]</span> <span class="token builtin class-name">command</span> <span class="token punctuation">[</span>command options<span class="token punctuation">]</span> <span class="token punctuation">[</span>arguments<span class="token punctuation">..</span>.<span class="token punctuation">]</span>

VERSION:
   v1.25.3+k3s1 <span class="token punctuation">(</span>f2585c16<span class="token punctuation">)</span>

COMMANDS:
   server           Run management server
   agent            Run <span class="token function">node</span> agent
   kubectl          Run kubectl
   crictl           Run crictl
   ctr              Run ctr
   check-config     Run config check
   etcd-snapshot    Trigger an immediate etcd snapshot
   secrets-encrypt  Control secrets encryption and keys rotation
   certificate      Certificates management
   completion       Install shell completion script
   help, h          Shows a list of commands or <span class="token builtin class-name">help</span> <span class="token keyword">for</span> one <span class="token builtin class-name">command</span>

GLOBAL OPTIONS:
   <span class="token parameter variable">--debug</span>                     <span class="token punctuation">(</span>logging<span class="token punctuation">)</span> Turn on debug logs <span class="token punctuation">[</span><span class="token variable">$K3S_DEBUG</span><span class="token punctuation">]</span>
   --data-dir value, <span class="token parameter variable">-d</span> value  <span class="token punctuation">(</span>data<span class="token punctuation">)</span> Folder to hold state <span class="token punctuation">(</span>default: /var/lib/rancher/k3s or <span class="token variable">\${<span class="token environment constant">HOME</span>}</span>/.rancher/k3s <span class="token keyword">if</span> not root<span class="token punctuation">)</span>
   --help, <span class="token parameter variable">-h</span>                  show <span class="token builtin class-name">help</span>
   --version, <span class="token parameter variable">-v</span>               print the version

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u9A8C\u8BC1\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># crictl images</span>
WARN<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> image connect using default endpoints: <span class="token punctuation">[</span>unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock<span class="token punctuation">]</span>. As the default settings are now deprecated, you should <span class="token builtin class-name">set</span> the endpoint instead. 
IMAGE                                    TAG                 IMAGE ID            SIZE
k0sproject/k0s                           latest              6adc65a599f7a       253MB
nginx                                    latest              76c69feac34e8       142MB
registry                                 <span class="token number">2.7</span>.1               0d0107588605f       <span class="token number">25</span>.7MB
sea.hub:5000/calico/apiserver            v3.22.1             b7dd079a4ed76       129MB
sea.hub:5000/calico/cni                  v3.22.1             2a8ef6985a3e5       236MB
sea.hub:5000/calico/kube-controllers     v3.22.1             c0c6672a66a59       132MB
sea.hub:5000/calico/node                 v3.22.1             7a71aca7b60fc       198MB
sea.hub:5000/calico/pod2daemon-flexvol   v3.22.1             17300d20daf93       <span class="token number">19</span>.7MB
sea.hub:5000/calico/typha                v3.22.1             f822f80398b9a       127MB
sea.hub:5000/coredns                     <span class="token number">1.7</span>.0               bfe3a36ebd252       <span class="token number">45</span>.2MB
sea.hub:5000/etcd                        <span class="token number">3.4</span>.13-0            0369cf4303ffd       253MB
sea.hub:5000/kube-apiserver              v1.19.8             9ba91a90b7d1b       119MB
sea.hub:5000/kube-controller-manager     v1.19.8             213ae7795128d       111MB
sea.hub:5000/kube-proxy                  v1.19.8             ea03182b84a23       118MB
sea.hub:5000/kube-scheduler              v1.19.8             919a3f36437dc       <span class="token number">46</span>.5MB
sea.hub:5000/pause                       <span class="token number">3.2</span>                 80d28bedfe5de       683kB
sea.hub:5000/tigera/operator             v1.25.3             648350e58702c       128MB
<span class="token punctuation">[</span>root@iZbp1evo5cnwagauz3w188Z k3s-offline<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -A</span>
NAMESPACE          NAME                                              READY   STATUS    RESTARTS   AGE
calico-apiserver   calico-apiserver-64f668766b-dv2xk                 <span class="token number">1</span>/1     Running   <span class="token number">2</span>          4d17h
calico-apiserver   calico-apiserver-64f668766b-k49gx                 <span class="token number">1</span>/1     Running   <span class="token number">2</span>          4d17h
calico-system      calico-kube-controllers-69dfd59986-mq7cv          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
calico-system      calico-node-pg47k                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
calico-system      calico-typha-84f56b949f-t95jk                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
default            myapp                                             <span class="token number">0</span>/3     Pending   <span class="token number">0</span>          4d14h
kube-system        coredns-55bcc669d7-74xb2                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
kube-system        coredns-55bcc669d7-jdkj2                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
kube-system        etcd-izbp1evo5cnwagauz3w188z                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
kube-system        kube-apiserver-izbp1evo5cnwagauz3w188z            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
kube-system        kube-controller-manager-izbp1evo5cnwagauz3w188z   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
kube-system        kube-proxy-ssr6t                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
kube-system        kube-scheduler-izbp1evo5cnwagauz3w188z            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4d17h
tigera-operator    tigera-operator-7cdb76dd8b-ltbbs                  <span class="token number">1</span>/1     Running   <span class="token number">10</span>         4d17h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="docker-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#docker-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F" aria-hidden="true">#</a> Docker + \u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F</h3><details class="custom-container details"><summary>\u5C55\u5F00\u67E5\u770B\u6B65\u9AA4</summary><p>\u5047\u8BBE\u4F60\u5DF2\u7ECF\u5C06\u540C\u4E00\u7248\u672C\u7684 K3s \u7684\u5B89\u88C5\u811A\u672C(<code>k3s-install.sh</code>)\u3001K3s \u7684\u4E8C\u8FDB\u5236\u6587\u4EF6(<code>k3s</code>)\u3001K3s \u4F9D\u8D56\u7684\u955C\u50CF(<code>k3s-airgap-images-amd64.tar</code>)\u4E0B\u8F7D\u5230\u4E86<code>/root</code>\u76EE\u5F55\u4E0B\u3002</p><p>\u4E0E <code>containerd</code> \u4E0D\u540C\uFF0C\u4F7F\u7528 docker \u4F5C\u4E3A\u5BB9\u5668\u8FD0\u884C\u65F6\uFF0C\u542F\u52A8 <code>K3s</code> \u4E0D\u4F1A\u5BFC\u5165 <code>/var/lib/rancher/k3s/agent/images/</code>\u76EE\u5F55\u4E0B\u7684\u955C\u50CF\u3002\u6240\u4EE5\u5728\u542F\u52A8 <code>K3s</code> \u4E4B\u524D\u6211\u4EEC\u9700\u8981\u5C06 <code>K3s</code> \u4F9D\u8D56\u7684\u955C\u50CF\u624B\u52A8\u5BFC\u5165\u5230 <code>docker</code> \u955C\u50CF\u5217\u8868\u4E2D\u3002</p><p><strong>1. \u5BFC\u5165\u955C\u50CF\u5230 <code>docker</code> \u7684\u955C\u50CF\u5217\u8868\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">docker</span> load <span class="token parameter variable">-i</span> /root/k3s-airgap-images-amd64.tar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>2. \u5C06 K3s \u5B89\u88C5\u811A\u672C\u548C K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u79FB\u52A8\u5230\u5BF9\u5E94\u76EE\u5F55\u5E76\u6388\u4E88\u53EF\u6267\u884C\u6743\u9650</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">chmod</span> a+x /root/k3s /root/k3s-install.sh
<span class="token function">sudo</span> <span class="token function">cp</span> /root/k3s /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. \u5B89\u88C5 K3s</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_SKIP_DOWNLOAD</span><span class="token operator">=</span>true <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--docker&#39;</span> /root/k3s-install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></details><h3 id="containerd-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F-1" tabindex="-1"><a class="header-anchor" href="#containerd-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F-1" aria-hidden="true">#</a> Containerd + \u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F</h3><details class="custom-container details"><summary>\u5C55\u5F00\u67E5\u770B\u6B65\u9AA4</summary><p>\u5047\u8BBE\u4F60\u5DF2\u7ECF\u5C06\u540C\u4E00\u7248\u672C\u7684 K3s \u7684\u5B89\u88C5\u811A\u672C(<code>k3s-install.sh</code>)\u3001K3s \u7684\u4E8C\u8FDB\u5236\u6587\u4EF6(<code>k3s</code>)\u3001K3s \u4F9D\u8D56\u7684\u955C\u50CF(<code>k3s-airgap-images-amd64.tar</code>)\u4E0B\u8F7D\u5230\u4E86<code>/root</code>\u76EE\u5F55\u4E0B\u3002</p><p>\u5982\u679C\u4F60\u4F7F\u7528\u7684\u5BB9\u5668\u8FD0\u884C\u65F6\u4E3Acontainerd\uFF0C\u5728\u542F\u52A8 K3s \u65F6\uFF0C\u5B83\u4F1A\u68C0\u67E5<code>/var/lib/rancher/k3s/agent/images/</code>\u662F\u5426\u5B58\u5728\u53EF\u7528\u7684\u955C\u50CF\u538B\u7F29\u5305\uFF0C\u5982\u679C\u5B58\u5728\uFF0C\u5C31\u5C06\u8BE5\u955C\u50CF\u5BFC\u5165\u5230 <code>containerd</code> \u955C\u50CF\u5217\u8868\u4E2D\u3002\u6240\u4EE5\u6211\u4EEC\u53EA\u9700\u8981\u4E0B\u8F7D <code>K3s</code> \u4F9D\u8D56\u7684\u955C\u50CF\u5230<code>/var/lib/rancher/k3s/agent/images/</code>\u76EE\u5F55\uFF0C\u7136\u540E\u542F\u52A8 <code>K3s</code> \u5373\u53EF\u3002</p><p><strong>1. \u5BFC\u5165\u955C\u50CF\u5230 <code>containerd</code> \u7684\u955C\u50CF\u5217\u8868\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/rancher/k3s/agent/images/
<span class="token function">sudo</span> <span class="token function">cp</span> /root/k3s-airgap-images-amd64.tar /var/lib/rancher/k3s/agent/images/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. \u5C06 K3s \u5B89\u88C5\u811A\u672C\u548C K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u79FB\u52A8\u5230\u5BF9\u5E94\u76EE\u5F55\u5E76\u6388\u4E88\u53EF\u6267\u884C\u6743\u9650</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">chmod</span> a+x /root/k3s /root/k3s-install.sh
<span class="token function">sudo</span> <span class="token function">cp</span> /root/k3s /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. \u5B89\u88C5 K3s</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_SKIP_DOWNLOAD</span><span class="token operator">=</span>true /root/k3s-install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></details><h3 id="containerd-\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#containerd-\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F" aria-hidden="true">#</a> Containerd + \u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F</h3>`,10),oe={class:"custom-container details"},ce=i("<summary>\u5C55\u5F00\u67E5\u770B\u8BE6\u7EC6</summary><p>\u5047\u8BBE\u4F60\u5DF2\u7ECF\u5C06\u540C\u4E00\u7248\u672C\u7684 K3s \u7684\u5B89\u88C5\u811A\u672C(<code>k3s-install.sh</code>)\u3001K3s \u7684\u4E8C\u8FDB\u5236\u6587\u4EF6(k3s)\u4E0B\u8F7D\u5230\u4E86<code>/root</code>\u76EE\u5F55\u4E0B\u3002\u5E76\u4E14 <code>K3s</code> \u6240\u9700\u8981\u7684\u955C\u50CF\u5DF2\u7ECF\u4E0A\u4F20\u5230\u4E86\u955C\u50CF\u4ED3\u5E93\uFF08\u672C\u4F8B\u7684\u955C\u50CF\u4ED3\u5E93\u5730\u5740\u4E3A\uFF1Ahttp://192.168.64.44:5000\uFF09\u3002K3s \u6240\u9700\u7684\u955C\u50CF\u5217\u8868\u53EF\u4EE5\u4ECE <code>K3s Release</code>\u9875\u9762\u7684<code>k3s-images.txt</code>\u83B7\u5F97\u3002</p><p><strong>1. \u914D\u7F6E K3s \u955C\u50CF\u4ED3\u5E93</strong></p>",3),re=n("\u542F\u52A8 K3s \u9ED8\u8BA4\u4F1A\u4ECEdocker.io\u62C9\u53D6\u955C\u50CF\u3002\u4F7F\u7528containerd\u5BB9\u5668\u8FD0\u884C\u65F6\u5728\u79BB\u7EBF\u5B89\u88C5\u65F6\uFF0C\u6211\u4EEC\u53EA\u9700\u8981\u5C06\u955C\u50CF\u4ED3\u5E93\u5730\u5740\u914D\u7F6E\u5230docker.io\u4E0B\u7684endpoint\u5373\u53EF\uFF0C\u66F4\u591A\u914D\u7F6E\u8BF4\u660E\u8BF7\u53C2\u8003\u914D\u7F6E containerd \u955C\u50CF\u4ED3\u5E93\u5B8C\u5168\u653B\u7565\u6216"),de={href:"https://docs.rancher.cn/docs/k3s/installation/private-registry/_index/",target:"_blank",rel:"noopener noreferrer"},pe=n("K3s \u5B98\u65B9\u6587\u6863"),ue=n("\uFF1A"),ve=i(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/rancher/k3s
<span class="token function">sudo</span> <span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
&quot;docker.io&quot;:
endpoint:
- &quot;http://192.168.64.44:5000&quot;
- &quot;https://registry-1.docker.io&quot;
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. \u5C06 K3s \u5B89\u88C5\u811A\u672C\u548C K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u79FB\u52A8\u5230\u5BF9\u5E94\u76EE\u5F55\u5E76\u6388\u4E88\u53EF\u6267\u884C\u6743\u9650</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">chmod</span> a+x /root/k3s /root/k3s-install.sh
<span class="token function">sudo</span> <span class="token function">cp</span> /root/k3s /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. \u5B89\u88C5 K3s</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_SKIP_DOWNLOAD</span><span class="token operator">=</span>true /root/k3s-install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>\u7A0D\u7B49\u7247\u523B\uFF0C\u5373\u53EF\u67E5\u770B\u5230 K3s \u5DF2\u7ECF\u6210\u529F\u542F\u52A8\uFF1A</p></blockquote>`,6),ke=i(`<h3 id="docker-\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#docker-\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F" aria-hidden="true">#</a> Docker + \u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F</h3><details class="custom-container details"><summary>\u5C55\u5F00\u67E5\u770B\u8BE6\u7EC6</summary><p>\u5047\u8BBE\u4F60\u5DF2\u7ECF\u5C06\u540C\u4E00\u7248\u672C\u7684 K3s \u7684\u5B89\u88C5\u811A\u672C(k3s-install.sh)\u3001K3s \u7684\u4E8C\u8FDB\u5236\u6587\u4EF6(k3s)\u4E0B\u8F7D\u5230\u4E86/root\u76EE\u5F55\u4E0B\u3002\u5E76\u4E14 K3s \u6240\u9700\u8981\u7684\u955C\u50CF\u5DF2\u7ECF\u4E0A\u4F20\u5230\u4E86\u955C\u50CF\u4ED3\u5E93\uFF08\u672C\u4F8B\u7684\u955C\u50CF\u4ED3\u5E93\u5730\u5740\u4E3A\uFF1Ahttp://192.168.64.44:5000\uFF09\u3002K3s \u6240\u9700\u7684\u955C\u50CF\u5217\u8868\u53EF\u4EE5\u4ECE K3s Release\u9875\u9762\u7684k3s-images.txt\u83B7\u5F97\u3002</p><p><strong>1. \u914D\u7F6E K3s \u955C\u50CF\u4ED3\u5E93</strong></p><p>Docker \u4E0D\u652F\u6301\u50CF containerd \u90A3\u6837\u53EF\u4EE5\u901A\u8FC7\u4FEE\u6539 docker.io \u5BF9\u5E94\u7684 endpoint\uFF08\u9ED8\u8BA4\u4E3A https://registry-1.docker.io\uFF09\u6765\u95F4\u63A5\u4FEE\u6539\u9ED8\u8BA4\u955C\u50CF\u4ED3\u5E93\u7684\u5730\u5740\u3002\u4F46\u5728Docker\u4E2D\u53EF\u4EE5\u901A\u8FC7\u914D\u7F6Eregistry-mirrors\u6765\u5B9E\u73B0\u4ECE\u5176\u4ED6\u955C\u50CF\u4ED3\u5E93\u4E2D\u83B7\u53D6K3s\u955C\u50CF\u3002\u8FD9\u6837\u914D\u7F6E\u4E4B\u540E\uFF0C\u4F1A\u5148\u4ECEregistry-mirrors\u914D\u7F6E\u7684\u5730\u5740\u62C9\u53D6\u955C\u50CF\uFF0C\u5982\u679C\u83B7\u53D6\u4E0D\u5230\u624D\u4F1A\u4ECE\u9ED8\u8BA4\u7684docker.io\u83B7\u53D6\u955C\u50CF\uFF0C\u4ECE\u800C\u6EE1\u8DB3\u4E86\u6211\u4EEC\u7684\u9700\u6C42\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
&quot;registry-mirrors&quot;: [&quot;http://192.168.64.44:5000&quot;]
}
EOF</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2\u3001\u5C06 K3s \u5B89\u88C5\u811A\u672C\u548C K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u79FB\u52A8\u5230\u5BF9\u5E94\u76EE\u5F55\u5E76\u6388\u4E88\u53EF\u6267\u884C\u6743\u9650</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">chmod</span> a+x /root/k3s /root/k3s-install.sh
<span class="token function">sudo</span> <span class="token function">cp</span> /root/k3s /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3. \u5B89\u88C5k3s\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_SKIP_DOWNLOAD</span><span class="token operator">=</span>true <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--docker&#39;</span> /root/k3s-install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></details><h3 id="\u5355\u7ED3\u70B9\u9AD8\u53EF\u7528\u79BB\u7EBF\u5B89\u88C5" tabindex="-1"><a class="header-anchor" href="#\u5355\u7ED3\u70B9\u9AD8\u53EF\u7528\u79BB\u7EBF\u5B89\u88C5" aria-hidden="true">#</a> \u5355\u7ED3\u70B9\u9AD8\u53EF\u7528\u79BB\u7EBF\u5B89\u88C5</h3>`,3),me=n("\u63D0\u4F9B\u8981\u4ECE server \u8282\u70B9\u5378\u8F7D K3s\uFF0C\u548C\u9700\u8981\u4ECEagent\u7ED3\u70B9\u5378\u8F7DK3s\uFF0C\u63A8\u8350\u4F7F\u7528\u9AD8\u53EF\u7528\u5B89\u88C5\uFF0C\u5173\u4E8E\u5355\u7ED3\u70B9\u8FC1\u79FB\u5230\u9AD8\u53EF\u7528\u72B6\u6001\u53EF\u53C2\u8003 "),be={href:"https://mp.weixin.qq.com/s/Yax2m2uFw2d4lo5sybHsCw",target:"_blank",rel:"noopener noreferrer"},he=n("\u{1F9F7} \u8FD9\u7BC7\u6587\u7AE0"),ge=n("\uFF1A"),fe=s("div",{class:"language-bash ext-sh line-numbers-mode"},[s("pre",{class:"language-bash"},[s("code",null,[s("span",{class:"token assign-left variable"},"INSTALL_K3S_SKIP_DOWNLOAD"),s("span",{class:"token operator"},"="),n(`true ./install.sh
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),_e=s("p",null,[n("\u7136\u540E\uFF0C\u8981\u9009\u62E9\u6DFB\u52A0\u5176\u4ED6 agent\uFF0C\u8BF7\u5728\u6BCF\u4E2A agent \u8282\u70B9\u4E0A\u6267\u884C\u4EE5\u4E0B\u64CD\u4F5C\u3002\u6CE8\u610F\u5C06 "),s("code",null,"myserver"),n(" \u66FF\u6362\u4E3A server \u7684 IP \u6216\u6709\u6548\u7684 DNS\uFF0C\u5E76\u5C06 "),s("code",null,"mynodetoken"),n(" \u66FF\u6362 server \u8282\u70B9\u7684 token\uFF0C\u901A\u5E38\u5728"),s("code",null,"/var/lib/rancher/k3s/server/node-token"),n("\u3002")],-1),ye=s("div",{class:"language-bash ext-sh line-numbers-mode"},[s("pre",{class:"language-bash"},[s("code",null,[s("span",{class:"token assign-left variable"},"INSTALL_K3S_SKIP_DOWNLOAD"),s("span",{class:"token operator"},"="),n("true "),s("span",{class:"token assign-left variable"},"K3S_URL"),s("span",{class:"token operator"},"="),n("https://myserver:6443 "),s("span",{class:"token assign-left variable"},"K3S_TOKEN"),s("span",{class:"token operator"},"="),n(`mynodetoken ./install.sh
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),xe=s("div",{class:"language-bash ext-sh line-numbers-mode"},[s("pre",{class:"language-bash"},[s("code",null,[s("span",{class:"token function"},"curl"),n(),s("span",{class:"token parameter variable"},"-sfL"),n(" https://get.k3s.io "),s("span",{class:"token operator"},"|"),n(),s("span",{class:"token function"},"sh"),n(),s("span",{class:"token parameter variable"},"-s"),n(" - server "),s("span",{class:"token punctuation"},"\\"),n(`
  --datastore-endpoint`),s("span",{class:"token operator"},"="),s("span",{class:"token string"},"'mysql://username:password@tcp(hostname:3306)/database-name'"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),Ke=s("p",null,[n("\u60A8\u9700\u8981\u8C03\u6574\u5B89\u88C5\u547D\u4EE4\uFF0C\u4EE5\u4FBF\u6307\u5B9A"),s("code",null,"INSTALL_K3S_SKIP_DOWNLOAD=true"),n("\u5E76\u5728\u672C\u5730\u8FD0\u884C\u5B89\u88C5\u811A\u672C\u3002\u60A8\u8FD8\u5C06\u5229\u7528"),s("code",null,"INSTALL_K3S_EXEC='args'"),n("\u4E3A k3s \u63D0\u4F9B\u5176\u4ED6\u53C2\u6570\u3002")],-1),Se=s("p",null,[n("\u7531\u4E8E\u5728\u79BB\u7EBF\u73AF\u5883\u4E2D\u65E0\u6CD5\u4F7F\u7528"),s("code",null,"curl"),n("\u547D\u4EE4\u8FDB\u884C\u5B89\u88C5\uFF0C\u6240\u4EE5\u60A8\u9700\u8981\u53C2\u8003\u4EE5\u4E0B\u793A\u4F8B\uFF0C\u5C06\u8FD9\u6761\u547D\u4EE4\u884C\u4FEE\u6539\u4E3A\u79BB\u7EBF\u5B89\u88C5\uFF1A")],-1),Le=s("div",{class:"language-bash ext-sh line-numbers-mode"},[s("pre",{class:"language-bash"},[s("code",null,[s("span",{class:"token assign-left variable"},"INSTALL_K3S_SKIP_DOWNLOAD"),s("span",{class:"token operator"},"="),n("true "),s("span",{class:"token assign-left variable"},"INSTALL_K3S_EXEC"),s("span",{class:"token operator"},"="),s("span",{class:"token string"},"'server'"),n(),s("span",{class:"token assign-left variable"},"K3S_DATASTORE_ENDPOINT"),s("span",{class:"token operator"},"="),s("span",{class:"token string"},"'mysql://username:password@tcp(hostname:3306)/database-name'"),n(` ./install.sh
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),Ee=i(`<h2 id="\u4E3Akubelet-\u8BBE\u7F6E\u522B\u540D" tabindex="-1"><a class="header-anchor" href="#\u4E3Akubelet-\u8BBE\u7F6E\u522B\u540D" aria-hidden="true">#</a> \u4E3Akubelet \u8BBE\u7F6E\u522B\u540D</h2><p><code>k3s</code> \u5B89\u88C5\u4E4B\u540E\u5185\u7F6E\u4E86\u4E00\u4E2A <code>kubectl</code> \u7684\u5B50\u547D\u4EE4\uFF0C\u6211\u4EEC\u901A\u8FC7\u6267\u884C <code>k3s kubectl</code> \u547D\u4EE4\u6765\u8C03\u7528\u5B83\uFF0C\u5176\u529F\u80FD\u548C\u4F7F\u7528\u65B9\u5F0F\u90FD\u548C <code>k8s</code> \u7684 <code>kubectl</code> \u547D\u4EE4\u662F\u4E00\u81F4\u3002\u4E3A\u4E86\u6211\u4EEC\u66F4\u52A0\u65B9\u4FBF\u7684\u4F7F\u7528\uFF0C\u53EF\u4EE5\u8BBE\u7F6E\u4E00\u4E2A <code>alias</code> \u522B\u540D\u6216\u8005\u521B\u5EFA\u4E00\u4E2A\u8F6F\u8FDE\u63A5\u8FBE\u5230\u547D\u4EE4\u7684\u65E0\u7F1D\u4F7F\u7528\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u521B\u5EFAalias\u522B\u540D</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">kubectl</span><span class="token operator">=</span><span class="token string">&#39;k3s kubectl&#39;</span>

<span class="token comment"># \u521B\u5EFA\u8F6F\u8FDE\u63A5</span>
<span class="token function">ln</span> <span class="token parameter variable">-sf</span> /usr/bin/kubectl /usr/local/bin/k3s

<span class="token comment"># \u914D\u7F6Ekubectl\u547D\u4EE4\u8865\u5168</span>
<span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">bash</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u914D\u7F6E\u5B8C\u6210\u4E4B\u540E\uFF0C\u5C31\u53EF\u4EE5\u4F7F\u7528 <code>kubectl</code> \u6765\u64CD\u4F5C\u96C6\u7FA4\u673A\u5668\u4E86\u3002\u901A\u8FC7\u8FD0\u884C\u5982\u4E0B\u547D\u4EE4\uFF0C\u53EF\u4EE5\u67E5\u770B <code>kube-system</code> \u540D\u79F0\u7A7A\u95F4\u4E2D\u8FD0\u884C\u7684 <code>pod</code> \u5217\u8868\u3002\u6211\u4EEC\u53D1\u73B0\u5E76\u6CA1\u6709\u8FD0\u884C <code>apiserver</code>\u3001<code>scheduler</code>\u3001<code>kube-proxy</code> \u4EE5\u53CA <code>flannel</code> \u7B49\u7EC4\u4EF6\uFF0C\u56E0\u4E3A\u8FD9\u4E9B\u90FD\u5DF2\u7ECF\u5185\u5D4C\u5230\u4E86 <code>k3s</code> \u8FDB\u7A0B\u4E2D\u4E86\u3002\u53E6\u5916 <code>k3s</code> \u5DF2\u7ECF\u7ED9\u6211\u4EEC\u9ED8\u8BA4\u90E8\u7F72\u8FD0\u884C\u4E86 <code>traefik ingress</code>\u3001<code>metrics-server</code> \u7B49\u670D\u52A1\uFF0C\u4E0D\u9700\u8981\u518D\u989D\u5916\u5B89\u88C5\u4E86\u3002</p><div class="custom-container tip"><p class="custom-container-title">\u4E00\u4E2A\u5F88\u4E0D\u6210\u719F\u7684\u60F3\u6CD5</p><p>\u6216\u8BB8\u4F60\u4E5F\u53EF\u4EE5\u5C06 docker \u4F5C\u4E3A CRI \uFF0C \u6211\u4E0D\u5EFA\u8BAE\u90A3\u4E48\u505A\uFF0C\u6216\u8BB8\u6709\u4E00\u4E2A\u6298\u4E2D\u7684\u65B9\u6CD5\uFF08\u4E5F\u662F\u8BBE\u7F6E\u522B\u540D\uFF09</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u521B\u5EFAalias\u522B\u540D</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">docker</span><span class="token operator">=</span><span class="token string">&#39;k3s crictl&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div><h2 id="\u6269\u5C55work\u8282\u70B9" tabindex="-1"><a class="header-anchor" href="#\u6269\u5C55work\u8282\u70B9" aria-hidden="true">#</a> \u6269\u5C55work\u8282\u70B9</h2>`,6),Ne=n("K3s \u63D0\u4F9B\u4E86\u4E00\u4E2A\u5B89\u88C5\u811A\u672C\uFF0C\u53EF\u4EE5\u65B9\u4FBF\u5730\u5C06\u5176\u4F5C\u4E3A\u670D\u52A1\u5B89\u88C5\u5728\u57FA\u4E8E systemd \u6216 openrc \u7684\u7CFB\u7EDF\u4E0A\u3002\u8BE5\u811A\u672C\u53EF\u5728 "),Ie={href:"https://get.k3s.io/",target:"_blank",rel:"noopener noreferrer"},qe=n("https://get.k3s.io"),Ae=n(" \u83B7\u5F97\u3002\u8981\u4F7F\u7528\u8FD9\u79CD\u65B9\u6CD5\u5B89\u88C5 K3s\uFF0C\u53EA\u9700\u8FD0\u884C\uFF1A"),Ce=i(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8FD0\u884C\u6B64\u5B89\u88C5\u540E\uFF1A</p>`,2),we=s("li",null,"K3s \u670D\u52A1\u5C06\u88AB\u914D\u7F6E\u4E3A\u5728\u8282\u70B9\u91CD\u542F\u540E\u6216\u8FDB\u7A0B\u5D29\u6E83\u6216\u88AB\u6740\u6B7B\u65F6\u81EA\u52A8\u91CD\u542F\u3002",-1),Re=s("li",null,[n("\u5C06\u5B89\u88C5\u5176\u4ED6\u5B9E\u7528\u7A0B\u5E8F\uFF0C\u5305\u62EC "),s("code",null,"kubectl"),n("\u3001"),s("code",null,"crictl"),n("\u3001"),s("code",null,"ctr"),n("\u3001"),s("code",null,"k3s-killall.sh"),n(" \u548C "),s("code",null,"k3s-uninstall.sh"),n("\u3002")],-1),Te={href:"https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/",target:"_blank",rel:"noopener noreferrer"},Oe=n("kubeconfig"),Pe=n(" \u6587\u4EF6\u5C06\u5199\u5165\u5230 "),Me=s("code",null,"/etc/rancher/k3s/k3s.yaml",-1),Fe=n("\uFF0C\u7531 K3s \u5B89\u88C5\u7684 kubectl \u5C06\u81EA\u52A8\u4F7F\u7528\u8BE5\u6587\u4EF6\u3002"),De=i(`<p>\u8981\u5728 Worker \u8282\u70B9\u4E0A\u5B89\u88C5\u5E76\u5C06\u5B83\u4EEC\u6DFB\u52A0\u5230\u96C6\u7FA4\uFF0C\u8BF7\u4F7F\u7528 <code>K3S_URL</code> \u548C <code>K3S_TOKEN</code> \u73AF\u5883\u53D8\u91CF\u8FD0\u884C\u5B89\u88C5\u811A\u672C\u3002\u4EE5\u4E0B\u793A\u4F8B\u6F14\u793A\u4E86\u5982\u4F55\u52A0\u5165 Worker \u8282\u70B9\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://myserver:6443 <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>mynodetoken <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8BBE\u7F6E <code>K3S_URL</code> \u53C2\u6570\u4F1A\u4F7F K3s \u4EE5 Worker \u6A21\u5F0F\u8FD0\u884C\u3002K3s Agent \u5C06\u6CE8\u518C\u5230\u5728 URL \u4E0A\u76D1\u542C\u7684 K3s Server\u3002<code>K3S_TOKEN</code> \u4F7F\u7528\u7684\u503C\u5B58\u50A8\u5728 Server \u8282\u70B9\u4E0A\u7684 <code>/var/lib/rancher/k3s/server/node-token</code> \u4E2D\u3002</p><p>\u6CE8\u610F\uFF1A\u6BCF\u53F0\u4E3B\u673A\u5FC5\u987B\u5177\u6709\u552F\u4E00\u7684\u4E3B\u673A\u540D\u3002\u5982\u679C\u4F60\u7684\u8BA1\u7B97\u673A\u6CA1\u6709\u552F\u4E00\u7684\u4E3B\u673A\u540D\uFF0C\u8BF7\u4F20\u9012 <code>K3S_NODE_NAME</code> \u73AF\u5883\u53D8\u91CF\uFF0C\u5E76\u4E3A\u6BCF\u4E2A\u8282\u70B9\u63D0\u4F9B\u4E00\u4E2A\u6709\u6548\u4E14\u552F\u4E00\u7684\u4E3B\u673A\u540D\u3002</p><h2 id="cri-cni-csi" tabindex="-1"><a class="header-anchor" href="#cri-cni-csi" aria-hidden="true">#</a> CRI CNI CSI</h2><p><strong>\u7F51\u7EDC</strong>\uFF1A</p><ul><li>\u56E0\u4E3A <code>k3s</code> \u5DF2\u7ECF\u5185\u7F6E\u4E86 <code>Traefik</code> \u7EC4\u4EF6\uFF0C\u4E0D\u9700\u8981\u518D\u5355\u72EC\u5B89\u88C5 <code>ingress controller</code> \u4E86\uFF0C\u76F4\u63A5\u521B\u5EFA <code>Ingress</code> \u5373\u53EF\u3002\u5176\u4E2D <code>192.168.xxx.xxx</code> \u4E3A <code>master</code> \u8282\u70B9\u7684 <code>IP</code>\uFF0C\u7531\u4E8E\u6211\u4EEC\u6CA1\u6709 <code>DNS</code> \u89E3\u6790\uFF0C\u56E0\u6B64\u53EF\u4EE5\u901A\u8FC7\u914D\u7F6E <code>/etc/hosts</code> \u6587\u4EF6\u8FDB\u884C\u9759\u6001\u914D\u7F6E\uFF0C\u4E4B\u540E\u5C31\u53EF\u4EE5\u901A\u8FC7\u57DF\u540D\u6765\u8BBF\u95EE\u6211\u4EEC\u7684\u670D\u52A1\u4E86\u3002</li></ul><p><strong>\u7F51\u7EDC\uFF1A</strong></p><ul><li>\u56E0\u4E3A <code>k3s</code> \u5DF2\u7ECF\u5185\u7F6E\u4E86 <code>Flannel</code> \u7F51\u7EDC\u63D2\u4EF6\uFF0C\u9ED8\u8BA4\u4F7F\u7528 <code>VXLAN</code> \u540E\u7AEF\uFF0C\u9ED8\u8BA4 <code>IP</code> \u6BB5\u4E3A <code>10.42.0.0/16</code>\u3002\u5185\u7F6E\u7684 <code>Flannel</code> \u9664\u4E86 <code>VXLAN</code> \u8FD8\u652F\u6301 <code>ipsec</code>\u3001<code>host-gw</code> \u4EE5\u53CA <code>wireguard</code>\u3002\u5F53\u7136\u9664\u4E86\u9ED8\u8BA4\u7684 <code>Flannel</code>\uFF0C<code>k3s</code> \u8FD8\u652F\u6301\u5176\u4ED6 <code>CNI</code>\uFF0C\u5982 <code>Canal</code>\u3001<code>Calico</code> \u7B49\u3002</li></ul><p><strong>\u5B58\u50A8\uFF1A</strong></p><ul><li><code>k3s</code> \u5220\u9664\u4E86 <code>k8s</code> \u5185\u7F6E <code>cloud provider</code> \u4EE5\u53CA <code>storage</code> \u63D2\u4EF6\uFF0C\u5185\u7F6E\u4E86 <code>Local Path Provider</code> \u6765\u63D0\u4F9B\u5B58\u50A8\u3002\u800C\u5185\u7F6E <code>local path</code> \u5B58\u50A8\uFF0C\u53EA\u80FD\u5355\u673A\u4F7F\u7528\uFF0C\u4E0D\u652F\u6301\u8DE8\u4E3B\u673A\u4F7F\u7528\uFF0C\u4E5F\u4E0D\u652F\u6301\u5B58\u50A8\u7684\u9AD8\u53EF\u7528\u3002\u53EF\u4EE5\u901A\u8FC7\u4F7F\u7528\u5916\u90E8\u7684\u5B58\u50A8\u63D2\u4EF6\u89E3\u51B3 k3s \u5B58\u50A8\u95EE\u9898\uFF0C\u6BD4\u5982 <code>Longhorn</code> \u4E91\u539F\u751F\u5206\u5E03\u5F0F\u5757\u5B58\u50A8\u7CFB\u7EDF\u3002</li></ul><h2 id="\u5D4C\u5165\u5F0F\u6570\u636E\u5E93\u9AD8\u53EF\u7528" tabindex="-1"><a class="header-anchor" href="#\u5D4C\u5165\u5F0F\u6570\u636E\u5E93\u9AD8\u53EF\u7528" aria-hidden="true">#</a> \u5D4C\u5165\u5F0F\u6570\u636E\u5E93\u9AD8\u53EF\u7528</h2><blockquote><p>\u5728 K3s v1.19.1 \u4E2D\uFF0C\u5D4C\u5165\u5F0F etcd \u53D6\u4EE3\u4E86\u5B9E\u9A8C\u6027\u7684 <code>Dqlite</code>\u3002\u8FD9\u662F\u4E00\u4E2A\u7A81\u7834\u6027\u7684\u53D8\u5316\u3002\u8BF7\u6CE8\u610F\uFF0C\u4E0D\u652F\u6301\u4ECE\u5B9E\u9A8C\u6027 Dqlite \u5347\u7EA7\u5230\u5D4C\u5165\u5F0F etcd\u3002\u5982\u679C\u4F60\u5C1D\u8BD5\u5347\u7EA7\uFF0C\u5347\u7EA7\u5C06\u4E0D\u4F1A\u6210\u529F\uFF0C\u5E76\u4E14\u6570\u636E\u5C06\u4F1A\u4E22\u5931\u3002</p></blockquote><p>etcd \u4F7F\u7528\u7684\u5171\u8BC6\u7B97\u6CD5\u662F <code>raft</code>\uFF0CHA\u6A21\u5F0F\u4E0B\u4FDD\u8BC1\u4E09\u4E2Anode\u5F00\u59CB~</p><p>\u9996\u5148\uFF0C\u542F\u52A8\u4E00\u4E2A\u5E26\u6709 <code>cluster-init</code> \u6807\u5FD7\u7684 Server \u8282\u70B9\u6765\u542F\u7528\u96C6\u7FA4\u548C\u4E00\u4E2A\u4EE4\u724C\uFF0C\u8BE5\u4EE4\u724C\u5C06\u4F5C\u4E3A\u5171\u4EAB secret\uFF0C\u7528\u4E8E\u5C06\u5176\u4ED6\u670D\u52A1\u5668\u52A0\u5165\u96C6\u7FA4\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>SECRET <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server --cluster-init
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u542F\u52A8\u7B2C\u4E00\u53F0\u670D\u52A1\u5668\u540E\uFF0C\u4F7F\u7528\u5171\u4EAB secret \u5C06\u7B2C\u4E8C\u53F0\u548C\u7B2C\u4E09\u53F0\u670D\u52A1\u5668\u52A0\u5165\u96C6\u7FA4\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>SECRET <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server <span class="token parameter variable">--server</span> https://<span class="token operator">&lt;</span>ip or <span class="token function">hostname</span> of server<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>:6443
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="ha-\u90E8\u7F72\u5B9E\u9A8C" tabindex="-1"><a class="header-anchor" href="#ha-\u90E8\u7F72\u5B9E\u9A8C" aria-hidden="true">#</a> HA \u90E8\u7F72\u5B9E\u9A8C</h2><ul><li><code>192.168.71.130</code> server node</li><li><code>192.168.71.131</code> agent node</li><li><code>192.168.71.132</code> agent node</li></ul><p><strong>\u73AF\u5883\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:/workspces<span class="token comment"># uname -a</span>
Linux cubmaster01 <span class="token number">5.4</span>.0-132-generic <span class="token comment">#148-Ubuntu SMP Mon Oct 17 16:02:06 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>

root@etcnode01:/current<span class="token comment"># uname -a</span>
Linux etcnode01 <span class="token number">5.4</span>.0-132-generic <span class="token comment">#148-Ubuntu SMP Mon Oct 17 16:02:06 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>

root@cubnode02:/tmp<span class="token comment"># uname -a</span>
Linux cubnode02 <span class="token number">5.4</span>.0-132-generic <span class="token comment">#148-Ubuntu SMP Mon Oct 17 16:02:06 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>master\u8282\u70B9(192.168.71.130)\uFF1A</strong></p><blockquote><p>\u5982\u679C\u7F51\u7EDC\u539F\u56E0\uFF0C\u53EF\u4EE5\u76F4\u63A5\u590D\u5236\u811A\u672C\u5728\u672C\u5730 <code>install.sh</code> \u6587\u4EF6\uFF0C\u7136\u540E\u8FD0\u884C\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u66FF\u6362\u6587\u4EF6\u4E2D\u7684 https://github.com --&gt; https://ghproxy.com/https://github.com</span>
<span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_NODE_NAME</span><span class="token operator">=</span>cubmaster01     <span class="token assign-left variable">K3S_KUBECONFIG_OUTPUT</span><span class="token operator">=</span>/home/escape/.kube/config     <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--docker&quot;</span> <span class="token operator">|</span> <span class="token function">sh</span> install.sh 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u6307\u5B9A\u4E86 kubeconfig \u7684\u4F4D\u7F6E</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io  <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_NODE_NAME</span><span class="token operator">=</span>cubmaster01 <span class="token punctuation">\\</span>
    <span class="token assign-left variable">K3S_KUBECONFIG_OUTPUT</span><span class="token operator">=</span>/home/escape/.kube/config <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--docker&quot;</span> <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="custom-container details"><summary>server \u8BE6\u7EC6\u5B89\u88C5\u89E3\u91CA</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u67E5\u627Estable\u5206\u652F\u7248\u672C\u4FE1\u606F</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Finding release <span class="token keyword">for</span> channel stable
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Using v1.23.6+k3s1 as release

<span class="token comment"># \u83B7\u53D6\u56FD\u5185\u955C\u50CF\u7248\u672C\u5730\u5740</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Downloading <span class="token builtin class-name">hash</span> https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/sha256sum-amd64.txt
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Downloading binary https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Verifying binary download

<span class="token comment"># \u5B89\u88C5k3s\u4E8C\u8FDB\u5236\u5DE5\u5177\u5E76\u94FE\u63A5\u76F8\u5173\u5DE5\u5177(\u5185\u7F6E)</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Installing k3s to /usr/local/bin/k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping installation of SELinux RPM
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating /usr/local/bin/kubectl symlink to k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating /usr/local/bin/crictl symlink to k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping /usr/local/bin/ctr symlink to k3s, <span class="token builtin class-name">command</span> exists <span class="token keyword">in</span> <span class="token environment constant">PATH</span> at /usr/bin/ctr

<span class="token comment"># \u5B89\u88C5\u6E05\u9664\u548C\u5378\u8F7Dk3s\u751F\u6210\u7684\u914D\u7F6E\u548C\u5DE5\u5177</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating <span class="token function">killall</span> script /usr/local/bin/k3s-killall.sh
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating uninstall script /usr/local/bin/k3s-uninstall.sh

<span class="token comment"># \u5E38\u89C1\u4E86\u4E24\u4E2Asystemd\u7684\u914D\u7F6E</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  env: Creating environment <span class="token function">file</span> /etc/systemd/system/k3s.service.env
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Creating <span class="token function">service</span> <span class="token function">file</span> /etc/systemd/system/k3s.service
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service \u2192 /etc/systemd/system/k3s.service.

<span class="token comment"># \u542F\u52A8k3s\u670D\u52A1</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Starting k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p><strong>node1\u8282\u70B9(192.168.71.131)\uFF1A</strong></p>`,27),Be={href:"https://docs.rancher.cn/docs/k3s/architecture/_index/#%E6%B3%A8%E5%86%8C-agent-%E8%8A%82%E7%82%B9",target:"_blank",rel:"noopener noreferrer"},Ue=n("\u6CE8\u518C node \u8282\u70B9"),Ge=i(`<blockquote><p><strong>\u67E5\u770Bserver\u7684token\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># mynodetoken</span>
<span class="token function">sudo</span> <span class="token function">cat</span> /var/lib/rancher/k3s/server/token
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u672C\u5730\u52A0\u901F\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_NODE_NAME</span><span class="token operator">=</span>cubnode01     <span class="token assign-left variable">K3S_KUBECONFIG_OUTPUT</span><span class="token operator">=</span>/home/escape/.kube/config     <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://192.168.71.130:6443     <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>K100be446b6ae6fb8f9a551061516fcc2dac8196de80e747026626b9baab34d57be::server:6cf0d1c8342f340cf5e8344e19493cb7  <span class="token function">sh</span> install.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5EFA\u8BAE\u4F7F\u7528\u8FD9\u4E2A\u5B89\u88C5\u547D\u4EE4(\u56FD\u5185\u5316\u4E86)</span>
<span class="token comment"># K3S_URL: \u4F1A\u4F7FK3s\u4EE5worker\u6A21\u5F0F\u8FD0\u884C</span>
<span class="token comment"># K3S_TOKEN: \u4F7F\u7528\u7684\u503C\u5B58\u50A8\u5728\u4F60\u7684\u670D\u52A1\u5668\u8282\u70B9\u4E0A</span>
<span class="token comment"># K3S_NODE_NAME: \u4E3A\u6BCF\u4E2A\u8282\u70B9\u63D0\u4F9B\u4E00\u4E2A\u6709\u6548\u4E14\u552F\u4E00\u7684\u4E3B\u673A\u540D</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_NODE_NAME</span><span class="token operator">=</span>cubnode01 <span class="token punctuation">\\</span>
    <span class="token assign-left variable">K3S_KUBECONFIG_OUTPUT</span><span class="token operator">=</span>/home/escape/.kube/config <span class="token punctuation">\\</span>
    <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://192.168.71.130:6443 <span class="token punctuation">\\</span>
    <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>mynodetoken <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="custom-container details"><summary>agent \u8282\u70B9\u5B89\u88C5\u8BE6\u7EC6\u8BF4\u660E</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u67E5\u627Estable\u5206\u652F\u7248\u672C\u4FE1\u606F</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Finding release <span class="token keyword">for</span> channel stable
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Using v1.23.6+k3s1 as release

<span class="token comment"># \u83B7\u53D6\u56FD\u5185\u955C\u50CF\u7248\u672C\u5730\u5740</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Downloading <span class="token builtin class-name">hash</span> https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/sha256sum-amd64.txt
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Downloading binary https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Verifying binary download

<span class="token comment"># \u5B89\u88C5k3s\u4E8C\u8FDB\u5236\u5DE5\u5177\u5E76\u94FE\u63A5\u76F8\u5173\u5DE5\u5177(\u5185\u7F6E)</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Installing k3s to /usr/local/bin/k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating /usr/local/bin/kubectl symlink to k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating /usr/local/bin/crictl symlink to k3s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Skipping /usr/local/bin/ctr symlink to k3s

<span class="token comment"># \u5B89\u88C5\u6E05\u9664\u548C\u5378\u8F7Dk3s\u751F\u6210\u7684\u914D\u7F6E\u548C\u5DE5\u5177</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating <span class="token function">killall</span> script /usr/local/bin/k3s-agent-killall.sh
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  Creating uninstall script /usr/local/bin/k3s-agent-uninstall.sh

<span class="token comment"># \u5E38\u89C1\u4E86\u4E24\u4E2Asystemd\u7684\u914D\u7F6E</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  env: Creating environment <span class="token function">file</span> /etc/systemd/system/k3s-agent.service.env
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Creating <span class="token function">service</span> <span class="token function">file</span> /etc/systemd/system/k3s-agent.service
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Enabling k3s-agent unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s-agent.service \u2192 /etc/systemd/system/k3s-agent.service.

<span class="token comment"># \u542F\u52A8k3s\u670D\u52A1</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span>  systemd: Starting k3s-agent
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p><strong>node2\u8282\u70B9\uFF1A</strong></p><blockquote><p>node1\u8282\u70B9\u7C7B\u4F3C\u64CD\u4F5C</p></blockquote><h2 id="\u5378\u8F7Dk3s" tabindex="-1"><a class="header-anchor" href="#\u5378\u8F7Dk3s" aria-hidden="true">#</a> \u5378\u8F7Dk3s</h2><p><strong>\u5378\u8F7Dk3s\uFF1A</strong></p><details class="custom-container details"><summary>\u5378\u8F7Dk3s</summary><p>\u5982\u679C\u60A8\u4F7F\u7528\u5B89\u88C5\u811A\u672C\u5B89\u88C5\u4E86 K3s\uFF0C\u90A3\u4E48\u5728\u5B89\u88C5\u8FC7\u7A0B\u4E2D\u4F1A\u751F\u6210\u4E00\u4E2A\u5378\u8F7D K3s \u7684\u811A\u672C\u3002</p><blockquote><p>\u5378\u8F7D K3s \u4F1A\u5220\u9664\u96C6\u7FA4\u6570\u636E\u548C\u6240\u6709\u811A\u672C\u3002\u8981\u4F7F\u7528\u4E0D\u540C\u7684\u5B89\u88C5\u9009\u9879\u91CD\u65B0\u542F\u52A8\u96C6\u7FA4\uFF0C\u8BF7\u4F7F\u7528\u4E0D\u540C\u7684\u6807\u5FD7\u91CD\u65B0\u8FD0\u884C\u5B89\u88C5\u811A\u672C\u3002</p></blockquote></details><p>\u63D0\u4F9B\u8981\u4ECE server \u8282\u70B9\u5378\u8F7D K3s\uFF0C\u548C\u9700\u8981\u4ECEagent\u7ED3\u70B9\u5378\u8F7DK3s\uFF1A</p>`,9),He=s("div",{class:"language-bash ext-sh line-numbers-mode"},[s("pre",{class:"language-bash"},[s("code",null,`/usr/local/bin/k3s-uninstall.sh
`)]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),Ve=s("div",{class:"language-bash ext-sh line-numbers-mode"},[s("pre",{class:"language-bash"},[s("code",null,`/usr/local/bin/k3s-agent-uninstall.sh
`)]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),$e=i(`<p><strong>\u4F18\u79C0\u7684\u4F60\u80AF\u5B9A\u4F1A\u5C06\u4ED6\u6E05\u9664\u5E72\u51C0\u7684\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u6E05\u9664\u5783\u573E\u6587\u4EF6</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc/rancher /var/lib/rancher
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u9488\u5BF9-docker-cri" tabindex="-1"><a class="header-anchor" href="#\u9488\u5BF9-docker-cri" aria-hidden="true">#</a> \u9488\u5BF9 docker CRI</h3><details class="custom-container details"><summary>\u62ECdocker\u7B49\u4FE1\u606F\u4E00\u5E76\u6E05\u7406</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5305\u62ECdocker\u7B49\u4FE1\u606F\u4E00\u5E76\u6E05\u7406</span>
<span class="token comment">#!/bin/bash</span>

<span class="token assign-left variable">KUBE_SVC</span><span class="token operator">=</span><span class="token string">&#39;
kubelet
kube-scheduler
kube-proxy
kube-controller-manager
kube-apiserver
&#39;</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">kube_svc</span> <span class="token keyword">in</span> <span class="token variable">\${KUBE_SVC}</span><span class="token punctuation">;</span>
<span class="token keyword">do</span>
  <span class="token comment"># \u505C\u6B62\u670D\u52A1</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">\`</span>systemctl is-active $<span class="token punctuation">{</span>kube_svc<span class="token punctuation">}</span><span class="token variable">\`</span></span> <span class="token operator">==</span> <span class="token string">&#39;active&#39;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    systemctl stop <span class="token variable">\${kube_svc}</span>
  <span class="token keyword">fi</span>
  <span class="token comment"># \u7981\u6B62\u670D\u52A1\u5F00\u673A\u542F\u52A8</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">\`</span>systemctl is-enabled $<span class="token punctuation">{</span>kube_svc<span class="token punctuation">}</span><span class="token variable">\`</span></span> <span class="token operator">==</span> <span class="token string">&#39;enabled&#39;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    systemctl disable <span class="token variable">\${kube_svc}</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token comment"># \u505C\u6B62\u6240\u6709\u5BB9\u5668</span>
<span class="token function">docker</span> stop <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span>

<span class="token comment"># \u5220\u9664\u6240\u6709\u5BB9\u5668</span>
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-qa</span><span class="token variable">)</span></span>

<span class="token comment"># \u5220\u9664\u6240\u6709\u5BB9\u5668\u5377</span>
<span class="token function">docker</span> volume <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> volume <span class="token function">ls</span> <span class="token parameter variable">-q</span><span class="token variable">)</span></span>

<span class="token comment"># \u5378\u8F7Dmount\u76EE\u5F55</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">mount</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">mount</span> <span class="token operator">|</span> <span class="token function">grep</span> tmpfs <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&#39;/var/lib/kubelet&#39;</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{ print $3 }&#39;</span><span class="token variable">)</span></span> /var/lib/kubelet /var/lib/rancher<span class="token punctuation">;</span>
<span class="token keyword">do</span>
  <span class="token function">umount</span> <span class="token variable">$mount</span><span class="token punctuation">;</span>
<span class="token keyword">done</span>

<span class="token comment"># \u5907\u4EFD\u76EE\u5F55</span>
<span class="token function">mv</span> /etc/kubernetes /etc/kubernetes-bak-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&quot;%Y%m%d%H%M&quot;</span><span class="token variable">)</span></span>
<span class="token function">mv</span> /var/lib/etcd /var/lib/etcd-bak-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&quot;%Y%m%d%H%M&quot;</span><span class="token variable">)</span></span>
<span class="token function">mv</span> /var/lib/rancher /var/lib/rancher-bak-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&quot;%Y%m%d%H%M&quot;</span><span class="token variable">)</span></span>
<span class="token function">mv</span> /opt/rke /opt/rke-bak-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&quot;%Y%m%d%H%M&quot;</span><span class="token variable">)</span></span>

<span class="token comment"># \u5220\u9664\u6B8B\u7559\u8DEF\u5F84</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /etc/ceph <span class="token punctuation">\\</span>
    /etc/cni <span class="token punctuation">\\</span>
    /opt/cni <span class="token punctuation">\\</span>
    /run/secrets/kubernetes.io <span class="token punctuation">\\</span>
    /run/calico <span class="token punctuation">\\</span>
    /run/flannel <span class="token punctuation">\\</span>
    /var/lib/calico <span class="token punctuation">\\</span>
    /var/lib/cni <span class="token punctuation">\\</span>
    /var/lib/kubelet <span class="token punctuation">\\</span>
    /var/log/containers <span class="token punctuation">\\</span>
    /var/log/kube-audit <span class="token punctuation">\\</span>
    /var/log/pods <span class="token punctuation">\\</span>
    /var/run/calico <span class="token punctuation">\\</span>
    /usr/libexec/kubernetes

<span class="token comment"># \u6E05\u7406\u7F51\u7EDC\u63A5\u53E3</span>
<span class="token assign-left variable">no_del_net_inter</span><span class="token operator">=</span><span class="token string">&#39;
lo
docker0
eth
ens
bond
&#39;</span>

<span class="token assign-left variable">network_interface</span><span class="token operator">=</span><span class="token variable"><span class="token variable">\`</span><span class="token function">ls</span> /sys/class/net<span class="token variable">\`</span></span>

<span class="token keyword">for</span> <span class="token for-or-select variable">net_inter</span> <span class="token keyword">in</span> <span class="token variable">$network_interface</span><span class="token punctuation">;</span>
<span class="token keyword">do</span>
  <span class="token keyword">if</span> <span class="token operator">!</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">\${no_del_net_inter}</span>&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-qE</span> <span class="token variable">\${net_inter<span class="token operator">:</span>0<span class="token operator">:</span>3}</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">ip</span> <span class="token function">link</span> delete <span class="token variable">$net_inter</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token comment"># \u6E05\u7406\u6B8B\u7559\u8FDB\u7A0B</span>
<span class="token assign-left variable">port_list</span><span class="token operator">=</span><span class="token string">&#39;
80
443
6443
2376
2379
2380
8472
9099
10250
10254
&#39;</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">port</span> <span class="token keyword">in</span> <span class="token variable">$port_list</span><span class="token punctuation">;</span>
<span class="token keyword">do</span>
  <span class="token assign-left variable">pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">\`</span><span class="token function">netstat</span> <span class="token parameter variable">-atlnup</span> <span class="token operator">|</span> <span class="token function">grep</span> $port <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $7}&#39;</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token parameter variable">-F</span> <span class="token string">&#39;/&#39;</span> <span class="token string">&#39;{print $1}&#39;</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> - <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-rnk2</span> <span class="token operator">|</span> <span class="token function">uniq</span><span class="token variable">\`</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token variable">$pid</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token variable">$pid</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token assign-left variable">kube_pid</span><span class="token operator">=</span><span class="token variable"><span class="token variable">\`</span><span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">grep</span> kube <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span><span class="token variable">\`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token variable">$kube_pid</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token variable">$kube_pid</span>
<span class="token keyword">fi</span>

<span class="token comment"># \u6E05\u7406Iptables\u8868</span>
<span class="token comment">## \u6CE8\u610F\uFF1A\u5982\u679C\u8282\u70B9Iptables\u6709\u7279\u6B8A\u914D\u7F6E\uFF0C\u4EE5\u4E0B\u547D\u4EE4\u8BF7\u8C28\u614E\u64CD\u4F5C</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">--flush</span>
<span class="token function">sudo</span> iptables <span class="token parameter variable">--flush</span> <span class="token parameter variable">--table</span> nat
<span class="token function">sudo</span> iptables <span class="token parameter variable">--flush</span> <span class="token parameter variable">--table</span> filter
<span class="token function">sudo</span> iptables <span class="token parameter variable">--table</span> nat --delete-chain
<span class="token function">sudo</span> iptables <span class="token parameter variable">--table</span> filter --delete-chain
systemctl restart <span class="token function">docker</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h2 id="k3s-\u7684\u4E00\u4E9B\u91CD\u8981\u76EE\u5F55" tabindex="-1"><a class="header-anchor" href="#k3s-\u7684\u4E00\u4E9B\u91CD\u8981\u76EE\u5F55" aria-hidden="true">#</a> k3s \u7684\u4E00\u4E9B\u91CD\u8981\u76EE\u5F55</h2><p>k3s\u662F\u4E00\u79CD\u8F7B\u91CF\u7EA7\u7684Kubernetes\u53D1\u884C\u7248\uFF0C\u5B83\u5728\u5B89\u88C5\u65F6\u4F1A\u521B\u5EFA\u4E00\u4E9B\u91CD\u8981\u7684\u76EE\u5F55\uFF0C\u5177\u4F53\u5982\u4E0B\uFF1A</p><ul><li>/etc/rancher/k3s/\uFF1A\u5305\u542Bk3s\u914D\u7F6E\u6587\u4EF6\u548C\u8BC1\u4E66\u3002</li><li>/var/lib/rancher/k3s/\uFF1A\u5305\u542Bk3s\u6570\u636E\uFF0C\u4F8B\u5982etcd\u6570\u636E\u5E93\u3001\u670D\u52A1\u6CE8\u518C\u8868\u3001DNS\u7F13\u5B58\u548C\u8282\u70B9\u4FE1\u606F\u3002</li><li>/var/log/rancher/k3s/\uFF1A\u5305\u542Bk3s\u670D\u52A1\u7684\u65E5\u5FD7\u6587\u4EF6\u3002</li><li>/usr/local/bin/\uFF1A\u5305\u542Bk3s\u7684\u53EF\u6267\u884C\u6587\u4EF6\uFF0C\u4F8B\u5982kubectl\u548Ck3s\u670D\u52A1\u7BA1\u7406\u5DE5\u5177\u3002</li></ul><p>\u8FD9\u4E9B\u76EE\u5F55\u7684\u4F4D\u7F6E\u53EF\u80FD\u4F1A\u6839\u636E\u60A8\u4F7F\u7528\u7684\u5B89\u88C5\u65B9\u5F0F\u800C\u6709\u6240\u4E0D\u540C\u3002\u4F8B\u5982\uFF0C\u5982\u679C\u60A8\u4F7F\u7528\u7684\u662F\u5185\u7F6E\u7684SQLite\u6570\u636E\u5E93\uFF0C\u90A3\u4E48\u53EF\u80FD\u4F1A\u5C06\u6570\u636E\u5B58\u50A8\u5728 <code>/var/lib/rancher/k3s/data/</code> \u76EE\u5F55\u4E0B\uFF0C\u800C\u4E0D\u662F\u72EC\u7ACB\u7684etcd\u6570\u636E\u5E93\u3002</p><div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p>\u60A8\u53EF\u4EE5\u5C06\u4E3B\u8981\u7684 k3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u653E\u5728\u4EFB\u4F55\u60A8\u60F3\u8981\u7684\u5730\u65B9\u3002\u5B83\u4F1A\u5C06\u5185\u5BB9\u5199\u5165 <code>/var/lib/rancher/k3s</code> \u548C <code>/etc/rancher</code>\uFF0C\u4EE5\u53CA <code>containerd</code> \u548C <code>kubelet</code> \u7528\u4E8E\u975E\u6301\u4E45\u6587\u4EF6\u7684\u6B63\u5E38\u4F4D\u7F6E <code>/var/run</code> \u4E0B\u3002</p><p>\u53EF\u4EE5\u5728 <code>/var/lib/rancher/k3s</code> \u8DEF\u5F84\u4E2D\u627E\u5230 <code>db</code> \u76EE\u5F55\uFF08SQLite\uFF09\u3002</p></div><p><code>/usr/local/bin</code> \u76EE\u5F55\u4E2D\u6709 k3s \u7684\u4E00\u4E9B\u5173\u952E\u76EE\u5F55\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@etcnode01:/usr/local/bin<span class="token comment"># ls -al</span>
total <span class="token number">66164</span>
drwxr-xr-x  <span class="token number">2</span> root root     <span class="token number">4096</span> Nov <span class="token number">25</span> 04:31 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">10</span> root root     <span class="token number">4096</span> Aug <span class="token number">31</span> 06:52 <span class="token punctuation">..</span>
lrwxrwxrwx  <span class="token number">1</span> root root        <span class="token number">3</span> Nov <span class="token number">25</span> 04:31 crictl -<span class="token operator">&gt;</span> k3s
-rwxr-xr-x  <span class="token number">1</span> root root <span class="token number">67735552</span> Nov <span class="token number">25</span> 04:31 k3s
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">1433</span> Nov <span class="token number">25</span> 04:31 k3s-agent-uninstall.sh
-rwxr-xr-x  <span class="token number">1</span> root root     <span class="token number">2026</span> Nov <span class="token number">25</span> 04:31 k3s-killall.sh
lrwxrwxrwx  <span class="token number">1</span> root root        <span class="token number">3</span> Nov <span class="token number">25</span> 04:31 kubectl -<span class="token operator">&gt;</span> k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Linux \u7CFB\u7EDF\u4E0B\u63D0\u4F9B ln \u6307\u4EE4\u6765\u8FDB\u884C\u6587\u4EF6\u94FE\u63A5</p><p>\u6211\u4EEC\u53EF\u4EE5\u770B\u5230\u8FD9\u91CC\u9762\u6709\u5F88\u591A\u7684\u8FDE\u63A5\u6587\u4EF6\uFF0C\u540C\u6837\u7684\uFF0C\u5176\u5B9E\u5728 k3s \u7684 rootfs bin\u76EE\u5F55\u4E0B\u4E5F\u662F\u8FD9\u6837\u7684</p><p>:::detatils \u8F6F\u8FDE\u63A5 &amp; \u786C\u8FDE\u63A5 <code>ln</code> \u6307\u4EE4\u9ED8\u8BA4\u521B\u5EFA\u7684\u662F\u786C\u94FE\u63A5\uFF0C\u5982\u679C\u52A0\u5165\u4E86<code>-s</code>\u53C2\u6570\uFF0C\u5219\u4F1A\u751F\u6210\u4E00\u4E2A\u8F6F\u94FE\u63A5\u3002</p><p><strong>\u786C\u8FDE\u63A5\uFF1A</strong></p><p>\u5728 Linux \u4E2D\uFF0C\u591A\u4E2A\u6587\u4EF6\u540D\u6307\u5411\u540C\u4E00\u7D22\u5F15\u8282\u70B9\u662F\u5B58\u5728\u7684\uFF0C\u6240\u4EE5\u786C\u8FDE\u63A5\u6307\u901A\u8FC7\u7D22\u5F15\u8282\u70B9\u6765\u8FDB\u884C\u7684\u8FDE\u63A5\uFF0C\u5373\u6BCF\u4E00\u4E2A\u786C\u94FE\u63A5\u90FD\u662F\u4E00\u4E2A\u6307\u5411\u5BF9\u5E94\u533A\u57DF\u7684\u6587\u4EF6\u3002</p><p>\u786C\u94FE\u63A5\u7684\u4F5C\u7528\u662F\u5141\u8BB8\u4E00\u4E2A\u6587\u4EF6<strong>\u62E5\u6709\u591A\u4E2A\u6709\u6548\u8DEF\u5F84\u540D</strong>\uFF0C\u8FD9\u6837\u7528\u6237\u5C31\u53EF\u4EE5\u5EFA\u7ACB\u786C\u94FE\u63A5\u5230\u91CD\u8981\u6587\u4EF6,\u4EE5\u9632\u6B62\u201C\u8BEF\u5220\u201D\u7684\u529F\u80FD\u3002</p><p>\u53EA\u5220\u9664\u4E00\u4E2A\u8FDE\u63A5\u5E76\u4E0D\u5F71\u54CD\u7D22\u5F15\u8282\u70B9\u672C\u8EAB\u548C\u5176\u5B83\u7684\u8FDE\u63A5\uFF0C\u53EA\u6709\u5F53\u6700\u540E\u4E00\u4E2A\u94FE\u63A5\u88AB\u5220\u9664\u540E\uFF0C\u6587\u4EF6\u7684\u6570\u636E\u5757\u53CA\u76EE\u5F55\u7684\u8FDE\u63A5\u624D\u4F1A\u88AB\u91CA\u653E\uFF0C\u4E5F\u5C31\u662F\u8BF4\uFF0C\u6587\u4EF6\u624D\u4F1A\u88AB\u771F\u6B63\u5220\u9664\u3002</p><p>\u26A0\uFE0F \u6CE8\u610F\u8FD9\u5E76\u4E0D\u662F <code>cp</code> \uFF0C\u8FD9\u4E0D\u662F\u91CD\u590D\u6587\u4EF6\uFF0C\u6CE8\u610F\uFF01\uFF01\uFF01\u5B83\u4EEC\u53EA\u662F\u6307\u5411\u540C\u4E00\u4E2A\u6587\u4EF6\u7684\u7D22\u5F15\u3002</p><p><strong>\u8F6F\u8FDE\u63A5\uFF1A</strong></p><p><img src="http://sm.nsddd.top/smimage-20221125211941734.png" alt="image-20221125211941734"></p><p>\u8F6F\u94FE\u63A5\u53C8\u53EB\u7B26\u53F7\u94FE\u63A5\uFF0C\u8FD9\u4E2A\u6587\u4EF6\u5305\u542B\u4E86\u53E6\u4E00\u4E2A\u6587\u4EF6\u7684\u8DEF\u5F84\u540D\uFF0C\u4F8B\u5982\u5728\u4E0A\u56FE\u4E2D\uFF0C<code>foo.txt</code> \u5C31\u662F <code>bar.txt</code> \u7684\u8F6F\u8FDE\u63A5\uFF0C<code>bar.txt</code> \u662F\u5B9E\u9645\u7684\u6587\u4EF6\uFF0C<code>foo.txt</code>\u5305\u542B\u7684\u662F\u5BF9\u4E8E <code>bar.txt</code> \u7684 inode \u7684\u8BB0\u5F55\u3002</p><p>\u8F6F\u8FDE\u63A5\u53EF\u4EE5\u662F\u4EFB\u610F\u6587\u4EF6\u6216\u76EE\u5F55\uFF0C\u53EF\u4EE5\u94FE\u63A5\u4E0D\u540C\u6587\u4EF6\u7CFB\u7EDF\u7684\u6587\u4EF6\uFF0C\u5728\u5BF9\u7B26\u53F7\u6587\u4EF6\u8FDB\u884C\u8BFB\u6216\u5199\u64CD\u4F5C\u7684\u65F6\u5019\uFF0C\u7CFB\u7EDF\u4F1A\u81EA\u52A8\u628A\u8BE5\u64CD\u4F5C\u8F6C\u6362\u4E3A\u5BF9\u6E90\u6587\u4EF6\u7684\u64CD\u4F5C\uFF0C\u4F46\u5220\u9664\u94FE\u63A5\u6587\u4EF6\u65F6\uFF0C\u7CFB\u7EDF\u4EC5\u4EC5\u5220\u9664\u94FE\u63A5\u6587\u4EF6\uFF0C\u800C\u4E0D\u5220\u9664\u6E90\u6587\u4EF6\u672C\u8EAB\uFF0C\u8FD9\u4E00\u70B9\u7C7B\u4F3C\u4E8E Windows \u64CD\u4F5C\u7CFB\u7EDF\u4E0B\u7684\u5FEB\u6377\u65B9\u5F0F\u3002</p><blockquote><p>\u8F6F\u94FE\u63A5\u4EE5 <code>l</code> \u5F00\u5934\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>lrwxrwxrwx  <span class="token number">1</span> root root    <span class="token number">1</span> Nov <span class="token number">25</span> <span class="token number">13</span>:21 x1 -<span class="token operator">&gt;</span> x
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></blockquote><p>:::</p><h3 id="var-lib-rancher-k3s" tabindex="-1"><a class="header-anchor" href="#var-lib-rancher-k3s" aria-hidden="true">#</a> <code>/var/lib/rancher/k3s</code></h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[root@VM-4-6-centos k3s]# pwd;ls
/var/lib/rancher/k3s
agent  data  server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,27),Xe={class:"custom-container warning"},We=i(`<p class="custom-container-title">\u76EE\u5F55\u89E3\u91CA</p><p><strong>agent\u4E2D\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:/var/lib/rancher/k3s/agent<span class="token comment"># ls</span>
client-ca.crt              client-kube-proxy.key     pod-manifests
client-k3s-controller.crt  containerd                server-ca.crt
client-k3s-controller.key  etc                       serving-kubelet.crt
client-kubelet.crt         k3scontroller.kubeconfig  serving-kubelet.key
client-kubelet.key         kubelet.kubeconfig
client-kube-proxy.crt      kubeproxy.kubeconfig
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>data\u4E2D\uFF1A</strong></p><p>\u8FD0\u884C\u7684\u5DE5\u4F5C\u76EE\u5F55\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:/var/lib/rancher/k3s/data<span class="token comment"># ls</span>
7c994f47fd344e1637da337b92c51433c255b387d207b30b3e0262779457afe4
current
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>server\u4E2D\uFF1A</strong></p>`,7),ze=s("code",null,"manifests",-1),Qe=n("\uFF1A\u4F4D\u4E8E\u76EE\u5F55\u8DEF\u5F84"),je=s("code",null,"/var/lib/rancher/k3s/server/manifests",-1),Ze=n(" \u7684\u6E05\u5355\u5728\u6784\u5EFA\u65F6\u88AB\u6346\u7ED1\u5230 K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u4E2D\uFF0C\u5C06\u7531"),Ye={href:"https://github.com/rancher/helm-controller#helm-controller",target:"_blank",rel:"noopener noreferrer"},Je=n("rancher/helm-controller"),sa=n("\u5728\u8FD0\u884C\u65F6\u5B89\u88C5\u3002"),na=i(`<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@ubuntu:/var/lib/rancher/k3s/server<span class="token comment"># cd manifests/;ls;pwd</span>
ccm.yaml      local-storage.yaml  rolebindings.yaml
coredns.yaml  metrics-server      traefik.yaml
/var/lib/rancher/k3s/server/manifests
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),ea=i("<li><p><code>tls</code>\uFF1Atls\u8BC1\u4E66\uFF0Ck3s\u8BC1\u4E66\u9ED8\u8BA4\u662F\u4E00\u5E74</p></li><li><p><code>db</code>\uFF1A\u6570\u636E\u5E93</p></li><li><p><code>token\u3001node-token\u3001agent-token</code>\uFF1Atoken</p></li><li><p>\u4E3B\u8282\u70B9\u7684\u5BC6\u7801\u5B58\u50A8\uFF1A<code>/var/lib/rancher/k3s/server/cred/node-passwd</code></p></li>",4),aa=i(`<h3 id="etc-rancher" tabindex="-1"><a class="header-anchor" href="#etc-rancher" aria-hidden="true">#</a> <code>/etc/rancher</code></h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[root@VM-4-6-centos rancher]# pwd;ls
/etc/rancher
k3s  node
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container warning"><p class="custom-container-title">\u76EE\u5F55\u89E3\u91CA</p><p><strong>k3s\u4E2D\uFF1A</strong></p><ul><li><p>k3s.yaml\uFF1Ak3s \u96C6\u7FA4\u7684\u4E00\u4E9B\u5143\u6570\u636E</p></li><li><p>registries.yaml\uFF1A\u6CE8\u518C\u8868\u4E00\u4E9B\u4FE1\u606F\uFF0C\u955C\u50CF\u52A0\u901F</p></li></ul><p><strong>node\uFF1A</strong></p><ul><li><code>password</code>\uFF1AAgent \u5C06\u4F7F\u7528\u8282\u70B9\u96C6\u7FA4 secret \u4EE5\u53CA\u968F\u673A\u751F\u6210\u7684\u8282\u70B9\u5BC6\u7801\u5411 k3s server \u6CE8\u518C\u5B58\u50A8\u5BC6\u7801\u8DEF\u5F84</li></ul><blockquote><p>K3s server \u5C06\u628A\u5404\u4E2A\u8282\u70B9\u7684\u5BC6\u7801\u5B58\u50A8\u4E3A Kubernetes secrets\uFF0C\u968F\u540E\u7684\u4EFB\u4F55\u5C1D\u8BD5\u90FD\u5FC5\u987B\u4F7F\u7528\u76F8\u540C\u7684\u5BC6\u7801\u3002\u8282\u70B9\u5BC6\u7801\u79D8\u5BC6\u5B58\u50A8\u5728<code>kube-system</code>\u547D\u540D\u7A7A\u95F4\u4E2D\uFF0C\u540D\u79F0\u4F7F\u7528\u6A21\u677F<code>&lt;host&gt;.node-password.k3s</code></p></blockquote></div><h3 id="var-run" tabindex="-1"><a class="header-anchor" href="#var-run" aria-hidden="true">#</a> <code>/var/run</code></h3><ul><li><p><code>k3s</code>\uFF1ACRI\uFF08containerd or docker)</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>root@cubmaster01:/var/run/k3s/containerd# ls
containerd.sock            io.containerd.runtime.v1.linux
containerd.sock.ttrpc      io.containerd.runtime.v2.task
io.containerd.grpc.v1.cri
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>containerd</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:/var/run/containerd<span class="token comment"># ls</span>
containerd.sock        io.containerd.runtime.v1.linux  runc
containerd.sock.ttrpc  io.containerd.runtime.v2.task   s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="\u955C\u50CF\u52A0\u901F" tabindex="-1"><a class="header-anchor" href="#\u955C\u50CF\u52A0\u901F" aria-hidden="true">#</a> \u955C\u50CF\u52A0\u901F</h2><p>\u955C\u50CF\u52A0\u901F\u914D\u7F6E\u540E\uFF0C\u91CD\u542F\u670D\u52A1</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  &quot;docker.io&quot;:
    endpoint:
      - &quot;https://fogjl973.mirror.aliyuncs.com&quot;
      - &quot;https://registry-1.docker.io&quot;
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u91CD\u542Fk3s\u4F7F\u914D\u7F6E\u751F\u6548</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u91CD\u542F\u670D\u52A1</span>
<span class="token function">sudo</span> systemctl restart k3s

<span class="token comment"># \u662F\u5426\u751F\u6548</span>
<span class="token function">sudo</span> crictl info <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-A</span> <span class="token number">2</span> <span class="token string">&quot;endpoint&quot;</span>

crictl info<span class="token operator">|</span><span class="token function">grep</span>  <span class="token parameter variable">-A</span> <span class="token number">5</span> registry
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://sm.nsddd.top/smimage-20221031112848849.png" alt="image-20221031112848849"></p><h2 id="containerd" tabindex="-1"><a class="header-anchor" href="#containerd" aria-hidden="true">#</a> containerd</h2>`,12),ta={href:"https://containerd.io/",target:"_blank",rel:"noopener noreferrer"},la=n("https://containerd.io/"),ia=i(`<h3 id="\u67B6\u6784\u56FE" tabindex="-1"><a class="header-anchor" href="#\u67B6\u6784\u56FE" aria-hidden="true">#</a> \u67B6\u6784\u56FE</h3><p><img src="http://sm.nsddd.top/smimage-20221110202936935.png" alt="image-20221110202936935"></p><details class="custom-container details"><summary>\u8865\u5145containerd</summary><p>containerd\u4ECEdocker\u5C31\u5F00\u59CB\u719F\u6089\u7684\uFF0C\u90A3\u4E48\u81EA\u7136\u4ECEdocker\u5F00\u59CB\u4ECB\u7ECD\uFF1A</p><p><img src="https://sm.nsddd.top/sm952033-20180520115357747-1796034956.png" alt="img"></p><blockquote><p>\u5728docker1.8\u4E4B\u524D\u53EF\u4EE5\u4F7F\u7528 <code>docker -d</code>\u3002\u5728\u540E\u9762\u5C31\u662F <code>docker daemon</code> \u30021.11\u4EE5\u540E\uFF1A<code>docker</code>\u3001<code>dockerd</code>\u30022015\u5E74\u540E OCI \u6210\u7ACB\uFF0C<code>runtime-spec</code> \u5236\u5B9A</p><p><code>libcotainer \u2013&gt; runC</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>dockerd <span class="token operator">=</span> <span class="token function">docker</span> engine + containerd + containerd - shim + runC
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u2026\u2026.</p><p>\u540E\u9762 <code>kubelet</code> \u4E0D\u652F\u6301 <code>docker</code> \uFF08\u56E0\u4E3A <code>docker</code> \u4E0D\u652F\u6301 <code>CRI</code>\uFF09\uFF0C<code>kubernetes</code>\u4F7F\u7528 <code>containerd</code>\u3002<code>containerd v1.1</code>\u540E\u9762\u4E5F\u652F\u6301 <code>cri</code> \uFF0C</p></blockquote><p>\u4ECE\u56FE\u4E2D\u53EF\u4EE5\u770B\u51FA\uFF0Cdocker \u5BF9\u5BB9\u5668\u7684\u7BA1\u7406\u548C\u64CD\u4F5C\u57FA\u672C\u90FD\u662F\u901A\u8FC7 containerd \u5B8C\u6210\u7684\u3002 \u90A3\u4E48\uFF0Ccontainerd \u662F\u4EC0\u4E48\u5462\uFF1F</p><blockquote><p><strong>containerd</strong> \u53EF\u7528\u4F5C Linux \u548C Windows \u7684\u5B88\u62A4\u8FDB\u7A0B\u3002\u5B83\u7BA1\u7406\u5176\u4E3B\u673A\u7CFB\u7EDF\u7684\u6574\u4E2A\u5BB9\u5668\u751F\u547D\u5468\u671F\uFF0C\u4ECE\u6620\u50CF\u4F20\u8F93\u548C\u5B58\u50A8\u5230\u5BB9\u5668\u6267\u884C\u548C\u76D1\u7763\uFF0C\u518D\u5230\u4F4E\u7EA7\u5B58\u50A8\uFF0C\u518D\u5230\u7F51\u7EDC\u9644\u4EF6\u7B49\u3002</p></blockquote><p><strong>Containerd \u662F\u4E00\u4E2A\u5DE5\u4E1A\u7EA7\u6807\u51C6\u7684\u5BB9\u5668\u8FD0\u884C\u65F6\uFF0C\u5B83\u5F3A\u8C03\u7B80\u5355\u6027\u3001\u5065\u58EE\u6027\u548C\u53EF\u79FB\u690D\u6027\u3002Containerd \u53EF\u4EE5\u5728\u5BBF\u4E3B\u673A\u4E2D\u7BA1\u7406\u5B8C\u6574\u7684\u5BB9\u5668\u751F\u547D\u5468\u671F\uFF1A\u5BB9\u5668\u955C\u50CF\u7684\u4F20\u8F93\u548C\u5B58\u50A8\u3001\u5BB9\u5668\u7684\u6267\u884C\u548C\u7BA1\u7406\u3001\u5B58\u50A8\u548C\u7F51\u7EDC\u7B49\u3002</strong> \u8BE6\u7EC6\u70B9\u8BF4\uFF0CContainerd \u8D1F\u8D23\u5E72\u4E0B\u9762\u8FD9\u4E9B\u4E8B\u60C5\uFF1A</p><ul><li>\u7BA1\u7406\u5BB9\u5668\u7684\u751F\u547D\u5468\u671F(\u4ECE\u521B\u5EFA\u5BB9\u5668\u5230\u9500\u6BC1\u5BB9\u5668)</li><li>\u62C9\u53D6 / \u63A8\u9001\u5BB9\u5668\u955C\u50CF</li><li>\u5B58\u50A8\u7BA1\u7406(\u7BA1\u7406\u955C\u50CF\u53CA\u5BB9\u5668\u6570\u636E\u7684\u5B58\u50A8)</li><li>\u8C03\u7528 <code>runC</code> \u8FD0\u884C\u5BB9\u5668(\u4E0E <code>runC</code> \u7B49\u5BB9\u5668\u8FD0\u884C\u65F6\u4EA4\u4E92)</li><li>\u7BA1\u7406\u5BB9\u5668\u7F51\u7EDC\u63A5\u53E3\u53CA\u7F51\u7EDC</li></ul><p>\u26A0\uFE0F \u6CE8\u610F\uFF1A<strong>Containerd \u88AB\u8BBE\u8BA1\u6210\u5D4C\u5165\u5230\u4E00\u4E2A\u66F4\u5927\u7684\u7CFB\u7EDF\u4E2D\uFF0C\u800C\u4E0D\u662F\u76F4\u63A5\u7531\u5F00\u53D1\u4EBA\u5458\u6216\u7EC8\u7AEF\u7528\u6237\u4F7F\u7528\u3002</strong></p><p><img src="http://sm.nsddd.top/smimage-20221031142456840.png" alt="image-20221031142456840"></p></details><div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p>\u5728\u4E0A\u9762\u7684\u5B89\u88C5\u6211\u4EEC\u77E5\u9053\u4E86\u53EF\u4EE5\u9009\u62E9\u9ED8\u8BA4\u7684docker\u5B89\u88C5\u3002</p></div><h3 id="\u547D\u4EE4" tabindex="-1"><a class="header-anchor" href="#\u547D\u4EE4" aria-hidden="true">#</a> \u547D\u4EE4</h3><p><img src="http://sm.nsddd.top/smcontainerd-docker-k8s-images" alt="\u67E5\u770B\u6E90\u56FE\u50CF"></p><h3 id="containerd\u7684\u914D\u7F6E\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#containerd\u7684\u914D\u7F6E\u7BA1\u7406" aria-hidden="true">#</a> containerd\u7684\u914D\u7F6E\u7BA1\u7406</h3><div class="custom-container warning"><p class="custom-container-title">\u603B\u7ED3</p><p>k3s \u5B89\u88C5\u540E\u5185\u7F6E\u4EE5\u4E0B containerd \u5BA2\u6237\u7AEF</p><ul><li><code>ctr</code> \uFF1A \u5355\u7EAF\u7684\u5BB9\u5668\u7BA1\u7406</li><li><code>crictl</code>\uFF1A\u4ECE kubernetes \u89C6\u89D2\u89E6\u53D1\uFF0C\u5BF9 POD\uFF0C\u5BB9\u5668\u8FDB\u884C\u7BA1\u7406\u3002</li></ul><p><strong>k3s \u5185\u4FEE\u6539 containerd \u7684\u914D\u7F6E\u6B65\u9AA4\uFF1A</strong></p><ul><li>\u590D\u5236 <code>/var/lib/rancher/k3s/agent/containerd/config.toml</code> \u4E3A\u540C\u76EE\u5F55\u4E0B\u7684\u65B0\u6A21\u677F</li><li>\u4FEE\u6539 <code>config.toml.tmpl</code></li><li>\u91CD\u542F <code>k3s</code> \uFF08systemctl restart k3s) \u6216\u8005 <code>k3s-agent</code>\uFF08systemctl restart k3s-agent\uFF09</li><li>\u68C0\u67E5 <code>/var/lib/rancher/k3s/agent/containerd/config.toml</code></li></ul></div><p><strong>\u65E5\u5FD7\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">tail</span> <span class="token parameter variable">-f</span> /var/lib/rancher/k3s/agent/containerd/containerd.log
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="\u4E8C\u8FDB\u5236\u5DE5\u5177" tabindex="-1"><a class="header-anchor" href="#\u4E8C\u8FDB\u5236\u5DE5\u5177" aria-hidden="true">#</a> \u4E8C\u8FDB\u5236\u5DE5\u5177</h2><p>K3s \u4E8C\u8FDB\u5236\u6587\u4EF6\u5305\u542B\u8BB8\u591A\u5E2E\u52A9\u60A8\u7BA1\u7406\u96C6\u7FA4\u7684\u9644\u52A0\u5DE5\u5177\u3002</p>`,12),oa=s("thead",null,[s("tr",null,[s("th",null,"\u547D\u4EE4"),s("th",null,"\u63CF\u8FF0")])],-1),ca=s("tr",null,[s("td",null,[s("code",null,"k3s server")]),s("td",null,"\u8FD0\u884C K3s \u7BA1\u7406\u670D\u52A1\u5668\uFF0C\u5B83\u8FD8\u5C06\u542F\u52A8 Kubernetes \u63A7\u5236\u5E73\u9762\u7EC4\u4EF6\uFF0C\u4F8B\u5982 API \u670D\u52A1\u5668\u3001\u63A7\u5236\u5668\u7BA1\u7406\u5668\u548C\u8C03\u5EA6\u7A0B\u5E8F\u3002")],-1),ra=s("tr",null,[s("td",null,[s("code",null,"k3s agent")]),s("td",null,[n("\u8FD0\u884C K3s \u8282\u70B9\u4EE3\u7406\u3002\u8FD9\u5C06\u5BFC\u81F4 K3s \u4F5C\u4E3A\u5DE5\u4F5C\u8282\u70B9\u8FD0\u884C\uFF0C\u542F\u52A8 Kubernetes \u8282\u70B9\u670D\u52A1"),s("code",null,"kubelet"),n("\u548C"),s("code",null,"kube-proxy"),n(".")])],-1),da=s("td",null,[s("code",null,"k3s kubectl")],-1),pa=n("\u8FD0\u884C\u5D4C\u5165\u5F0F"),ua={href:"https://kubernetes.io/docs/docs/reference/kubectl/overview/",target:"_blank",rel:"noopener noreferrer"},va=n("kubectl"),ka=n(" CLI\u3002\u5982\u679C"),ma=s("code",null,"KUBECONFIG",-1),ba=n("\u672A\u8BBE\u7F6E\u73AF\u5883\u53D8\u91CF\uFF0C\u8FD9\u5C06\u81EA\u52A8\u5C1D\u8BD5\u4F7F\u7528\u5728"),ha=s("code",null,"/etc/rancher/k3s/k3s.yaml",-1),ga=n("\u542F\u52A8 K3s \u670D\u52A1\u5668\u8282\u70B9\u65F6\u521B\u5EFA\u7684\u914D\u7F6E\u6587\u4EF6\u3002"),fa=s("td",null,[s("code",null,"k3s crictl")],-1),_a=n("\u8FD0\u884C\u5D4C\u5165\u5F0F"),ya={href:"https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md",target:"_blank",rel:"noopener noreferrer"},xa=n("crictl"),Ka=n("\u3002\u8FD9\u662F\u4E00\u4E2A\u7528\u4E8E\u4E0E Kubernetes \u7684\u5BB9\u5668\u8FD0\u884C\u65F6\u63A5\u53E3 (CRI) \u4EA4\u4E92\u7684 CLI\u3002\u5BF9\u8C03\u8BD5\u5F88\u6709\u7528\u3002"),Sa=s("td",null,[s("code",null,"k3s ctr")],-1),La=n("\u8FD0\u884C\u5D4C\u5165\u5F0F"),Ea={href:"https://github.com/projectatomic/containerd/blob/master/docs/cli.md",target:"_blank",rel:"noopener noreferrer"},Na=n("ctr"),Ia=n("\u3002\u8FD9\u662F containerd \u7684 CLI\uFF0CK3s \u4F7F\u7528\u7684\u5BB9\u5668\u5B88\u62A4\u8FDB\u7A0B\u3002\u5BF9\u8C03\u8BD5\u5F88\u6709\u7528\u3002"),qa=s("td",null,[s("code",null,"k3s etcd-snapshot")],-1),Aa=n("\u5BF9 K3s \u96C6\u7FA4\u6570\u636E\u8FDB\u884C\u6309\u9700\u5907\u4EFD\u5E76\u4E0A\u4F20\u5230 S3\u3002\u6709\u5173\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u8BF7\u53C2\u9605"),Ca={href:"https://docs.k3s.io/backup-restore#backup-and-restore-with-embedded-etcd-datastore-experimental",target:"_blank",rel:"noopener noreferrer"},wa=n("\u5907\u4EFD\u548C\u8FD8\u539F"),Ra=n("\u3002"),Ta=s("td",null,[s("code",null,"k3s secrets-encrypt")],-1),Oa=n("\u5C06 K3s \u914D\u7F6E\u4E3A\u5728\u5C06\u673A\u5BC6\u5B58\u50A8\u5728\u96C6\u7FA4\u4E2D\u65F6\u5BF9\u5176\u8FDB\u884C\u52A0\u5BC6\u3002\u6709\u5173\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u8BF7\u53C2\u9605"),Pa={href:"https://docs.k3s.io/security/secrets-encryption",target:"_blank",rel:"noopener noreferrer"},Ma=n("\u79D8\u5BC6\u52A0\u5BC6"),Fa=n("\u3002"),Da=s("tr",null,[s("td",null,[s("code",null,"k3s certificate")]),s("td",null,"\u8BC1\u4E66\u7BA1\u7406")],-1),Ba=s("tr",null,[s("td",null,[s("code",null,"k3s completion")]),s("td",null,"\u4E3A k3s \u751F\u6210 shell \u5B8C\u6210\u811A\u672C")],-1),Ua=s("tr",null,[s("td",null,[s("code",null,"k3s help")]),s("td",null,"\u663E\u793A\u547D\u4EE4\u5217\u8868\u6216\u4E00\u4E2A\u547D\u4EE4\u7684\u5E2E\u52A9")],-1),Ga=i(`<h2 id="\u8FB9\u7F18\u8BA1\u7B97" tabindex="-1"><a class="header-anchor" href="#\u8FB9\u7F18\u8BA1\u7B97" aria-hidden="true">#</a> \u8FB9\u7F18\u8BA1\u7B97</h2><p>k3s \u975E\u5E38\u652F\u6301\u8FB9\u7F18\u8BA1\u7B97\uFF0CCICD \u7684\u90E8\u7F72\uFF0C\u53EF\u4EE5\u7ED9\u6211\u4EEC\u5E26\u6765\u66F4\u597D\u7684\u4F53\u9A8C\u3002</p><div class="custom-container tip"><p class="custom-container-title">\u8FB9\u7F18\u8BA1\u7B97\u662F\u4EC0\u4E48\uFF1F</p><p>\u8FB9\u7F18\u8BA1\u7B97\u662F\u4E3A\u5E94\u7528\u5F00\u53D1\u8005\u548C\u670D\u52A1\u63D0\u4F9B\u5546\u5728\u7F51\u7EDC\u7684\u8FB9\u7F18\u4FA7\u63D0\u4F9B\u4E91\u670D\u52A1\u548CIT\u73AF\u5883\u670D\u52A1\uFF1B\u76EE\u6807\u662F\u5728\u9760\u8FD1\u6570\u636E\u8F93\u5165\u6216\u7528\u6237\u7684\u5730\u65B9\u63D0\u4F9B\u8BA1\u7B97\u3001\u5B58\u50A8\u548C\u7F51\u7EDC\u5E26\u5BBD\u3002</p><p>\u901A\u4FD7\u5730\u8BF4\uFF1A\u8FB9\u7F18\u8BA1\u7B97\u672C\u8D28\u4E0A\u662F\u4E00\u79CD\u670D\u52A1\uFF0C\u5C31\u7C7B\u4F3C\u4E8E\u4E91\u8BA1\u7B97\u3001\u5927\u6570\u636E\u670D\u52A1\uFF0C\u4F46\u8FD9\u79CD\u670D\u52A1\u975E\u5E38\u9760\u8FD1\u7528\u6237\uFF1B\u4E3A\u4EC0\u4E48\u8981\u8FD9\u4E48\u8FD1\uFF1F\u76EE\u7684\u662F\u4E3A\u4E86\u8BA9\u7528\u6237\u611F\u89C9\u5230\u5237\u4EC0\u4E48\u5185\u5BB9\u90FD\u7279\u522B\u5FEB\u3002</p></div><p><strong>\u63D0\u5347\u4E86Quick start\u6210\u529F\u7387\uFF1A</strong></p><p>\u6211\u4EEC\u5728\u4EA4\u4ED8\u8F6F\u4EF6\u7684\u65F6\u5019\uFF0C\u4ECE\u4EE5\u524D\u7684\u7ED9\u4E00\u4E2AJava\u73AF\u5883\u5230\u73B0\u5728\u9700\u8981\u4E00\u4E2Ak8s \u73AF\u5883\uFF0Ck3s\u5219\u96C6\u6210\u4E86\uFF0C\u63D0\u4F9B\u5F00\u7BB1\u5373\u7528\u7684\u4EA4\u4E92\u4F53\u9A8C\uFF0C\u964D\u4F4E\u8F6F\u4EF6\u7684\u8D44\u6E90\u5360\u7528\uFF0C\u5E76\u4E14\u4F7F\u8FD0\u7EF4\u90E8\u7F72\u66F4\u65B9\u4FBF\u3002</p><h2 id="\u5355\u8282\u70B9-sqlite-\u6269\u5C55\u4E3A-etcd-\u9AD8\u53EF\u7528" tabindex="-1"><a class="header-anchor" href="#\u5355\u8282\u70B9-sqlite-\u6269\u5C55\u4E3A-etcd-\u9AD8\u53EF\u7528" aria-hidden="true">#</a> \u5355\u8282\u70B9 SQLite \u6269\u5C55\u4E3A etcd \u9AD8\u53EF\u7528</h2><blockquote><p>\u6CE8\u610F\uFF1Ak3s v1.22.2 \u53CA\u66F4\u65B0\u7248\u672C\u624D\u652F\u6301\u4ECE\u5355\u8282\u70B9 k3s \u96C6\u7FA4\u8F6C\u6362\u4E3A\u5185\u7F6E etcd \u96C6\u7FA4</p></blockquote><p>\u9996\u5148\u4F60\u9700\u8981\u6709\u4E00\u4E2A\u5355\u8282\u70B9\u7684 k3s \u96C6\u7FA4\uFF0C\u672C\u4F8B\u4F7F\u7528 1 master \u8282\u70B9\u30011 worker \u8282\u70B9\u7684 k3s \u96C6\u7FA4\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:~/.kube<span class="token comment"># kubectl get node</span>
NAME          STATUS   ROLES                  AGE    VERSION
cubnode01     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 96m    v1.25.4+k3s1
cubmaster01   Ready    control-plane,master   142m   v1.25.4+k3s1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u9A8C\u8BC1\u96C6\u7FA4\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:~/.kube<span class="token comment"># kubectl get deployment,svc</span>
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/kubernetes   ClusterIP   <span class="token number">10.43</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   145m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5C06\u5355\u8282\u70B9 K3s \u96C6\u7FA4\u8F6C\u6362\u4E3A\u5185\u7F6E etcd \u9AD8\u53EF\u7528\u96C6\u7FA4</strong></p><p>\u9996\u5148\uFF0C\u5148\u505C\u6B62 k3s \u670D\u52A1\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:~/.kube<span class="token comment"># systemctl stop k3s</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u901A\u8FC7\u4F7F\u7528 <code>--cluster-init</code> \u6807\u5FD7\u91CD\u65B0\u542F\u52A8\u4F60\u7684 <code>k3s server</code> \u6765\u5C06\u5176\u8F6C\u6362\u4E3A etcd \u96C6\u7FA4</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment">#  curl -sfL https://get.k3s.io | sh -s - --cluster-init</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u67E5\u770B master \u8282\u70B9\u7684\u89D2\u8272\uFF0C\u6765\u786E\u8BA4\u662F\u5426\u8F6C\u6362\u6210\u529F\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:/workspces/runtime<span class="token comment"># kubectl get nodes</span>
NAME          STATUS   ROLES                       AGE    VERSION
cubmaster01   Ready    control-plane,etcd,master   151m   v1.25.4+k3s1
cubnode01     Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                      105m   v1.25.4+k3s1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u4E0A\u9762 ROLES \u5217\u53EF\u4EE5\u770B\u5230\uFF0Cmaster \u8282\u70B9\u7684\u89D2\u8272\u589E\u52A0\u4E86 etcd\uFF0C\u8BC1\u660E\u5DF2\u7ECF\u901A\u8FC7\u5185\u7F6E etcd \u6570\u636E\u5E93\u91CD\u65B0\u542F\u52A8\u4E86 k3s \u96C6\u7FA4\u3002</p><p><strong>\u9A8C\u8BC1\u96C6\u7FA4\uFF1A</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>root@cubmaster01:/workspces/runtime# kubectl get deployment,svc
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.43.0.1    &lt;none&gt;        443/TCP   159m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6570\u636E\u5E93\u6587\u4EF6\uFF1A</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>root@cubmaster01:/workspces/runtime# ls /var/lib/rancher/k3s/server/db/
etcd  state.db.migrated  state.db-shm  state.db-wal
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5B89\u88C5\u811A\u672C" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5\u811A\u672C" aria-hidden="true">#</a> \u5B89\u88C5\u811A\u672C</h2><details class="custom-container details"><summary>k3s \u5B89\u88C5\u811A\u672C</summary><p>https://get.k3s.io</p><p>Maybe you can try my plan, if you don&#39;t choose the domestic route, but you are affected by the firewall. Then you can use <code>https://ghproxy.com/{github-url}</code></p></details><details class="custom-container details"><summary>\u56FD\u5185\u955C\u50CF\u52A0\u901F~</summary><p>https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>curl -sfL https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></details><h3 id="\u7406\u89E3\u5B89\u88C5\u7684\u6B65\u9AA4" tabindex="-1"><a class="header-anchor" href="#\u7406\u89E3\u5B89\u88C5\u7684\u6B65\u9AA4" aria-hidden="true">#</a> \u7406\u89E3\u5B89\u88C5\u7684\u6B65\u9AA4</h3><p><strong>\u5148\u51B3\u6761\u4EF6\uFF1A</strong></p><ul><li>\u9009\u62E9\u4E0A\uFF0C\u4E24\u4E2A\u8282\u70B9\u4E0D\u80FD\u6709\u76F8\u540C\u7684\u4E3B\u673A\u540D</li><li>\u4E0D\u4FEE\u6539\u4E3B\u673A\u540D\u53EF\u4EE5\u901A\u8FC7\u6DFB\u52A0\u968F\u673A\u540E\u7F00\u6216\u6307\u5B9A\u4E3B\u673A\u540D</li></ul><p><strong>\u786C\u4EF6\u4FE1\u606F\uFF1A</strong></p><ul><li>\u64CD\u4F5C\u7CFB\u7EDF\uFF1A\u53EF\u4EE5\u5728\u5927\u591A\u6570\u73B0\u4EE3 Linux \u7CFB\u7EDF\u4E0A\u8FD0\u884C\uFF08\u6211\u5E0C\u671B\u53EF\u4EE5\u6709\u4E00\u4E2A\u6D4B\u8BD5\uFF0C\u6211\u4EEC\u4E0D\u7528\u518D\u4F9D\u8D56\u4E8E kubernetes \u7684\u6C89\u91CD\u6807\u914D\u4E86\uFF08\u4E0D\u4F4E\u4E8E4 \u6838\uFF09</li><li>\u78C1\u76D8\u8BBE\u5907\uFF1AK3s \u7684\u6027\u80FD\u53D6\u51B3\u4E8E\u6570\u636E\u5E93\u7684\u6027\u80FD(\u5EFA\u8BAE\u4F7F\u7528 SSD \u786C\u76D8)</li><li>\u7F51\u7EDC\u76F8\u5173\uFF1AK3s Server \u8282\u70B9\u7684\u5165\u7AD9\u89C4\u5219\uFF0C\u6240\u6709\u51FA\u7AD9\u6D41\u91CF\u90FD\u662F\u5141\u8BB8\u7684</li></ul><table><thead><tr><th style="text-align:left;">\u534F\u8BAE</th><th style="text-align:left;">\u7AEF\u53E3</th><th style="text-align:left;">\u6E90</th><th style="text-align:left;">\u63CF\u8FF0</th></tr></thead><tbody><tr><td style="text-align:left;">TCP</td><td style="text-align:left;">6443</td><td style="text-align:left;">K3s agent \u8282\u70B9</td><td style="text-align:left;">Kubernetes API Server</td></tr><tr><td style="text-align:left;">UDP</td><td style="text-align:left;">8472</td><td style="text-align:left;">K3s server \u548C agent \u8282\u70B9</td><td style="text-align:left;">\u4EC5\u5BF9 Flannel VXLAN \u9700\u8981</td></tr><tr><td style="text-align:left;">TCP</td><td style="text-align:left;">10250</td><td style="text-align:left;">K3s server \u548C agent \u8282\u70B9</td><td style="text-align:left;">Kubelet metrics</td></tr><tr><td style="text-align:left;">TCP</td><td style="text-align:left;">2379-2380</td><td style="text-align:left;">K3s server \u8282\u70B9</td><td style="text-align:left;">\u53EA\u6709\u5D4C\u5165\u5F0F etcd \u9AD8\u53EF\u7528\u624D\u9700\u8981</td></tr></tbody></table><p><strong>\u5B89\u88C5\u9009\u9879\uFF1A</strong></p>`,33),Ha={href:"https://docs.rancher.cn/docs/k3s/autok3s/_index/",target:"_blank",rel:"noopener noreferrer"},Va=n("\u5B98\u65B9\u5B89\u88C5\u53C2\u6570\u6587\u6863"),$a={href:"https://github.com/kingsd041/k3s-tutorial/blob/main/03-%E5%AE%89%E8%A3%85-%E8%A6%81%E6%B1%82%E5%8F%8A%E9%80%89%E9%A1%B9/README.md",target:"_blank",rel:"noopener noreferrer"},Xa=n("\u5B89\u88C5\u9009\u9879\u793A\u4F8B\u6F14\u793A"),Wa=i(`<table><thead><tr><th style="text-align:left;">Environment Variable</th><th style="text-align:left;">Description</th></tr></thead><tbody><tr><td style="text-align:left;"><code>INSTALL_K3S_EXEC</code></td><td style="text-align:left;">\u7528\u4E8E\u5728\u670D\u52A1\u4E2D\u542F\u52A8 <code>K3s</code> \u7684\u540E\u7EED\u5B50\u547D\u4EE4</td></tr><tr><td style="text-align:left;"><code>K3S_CONFIG_FILE</code></td><td style="text-align:left;">\u6307\u5B9A\u914D\u7F6E\u6587\u4EF6\u7684\u4F4D\u7F6E</td></tr><tr><td style="text-align:left;"><code>K3S_TOKEN</code></td><td style="text-align:left;">\u7528\u4E8E\u5C06 <code>server/agent</code> \u52A0\u5165\u96C6\u7FA4\u7684\u5171\u4EAB <code>secret</code> \u503C</td></tr><tr><td style="text-align:left;"><code>K3S_TOKEN_FILE</code></td><td style="text-align:left;">\u7528\u4E8E\u5C06 <code>server/agent</code> \u52A0\u5165\u96C6\u7FA4\u7684\u5171\u4EAB <code>secret</code> \u6587\u4EF6</td></tr><tr><td style="text-align:left;"><code>INSTALL_K3S_VERSION</code></td><td style="text-align:left;">\u6307\u5B9A\u4E0B\u8F7D <code>K3s</code> \u7684\u7248\u672C</td></tr><tr><td style="text-align:left;"><code>K3S_TOKEN_FILE</code></td><td style="text-align:left;">\u6307\u5B9A <code>cluster-secret</code>/<code>token</code> \u7684\u6587\u4EF6\u76EE\u5F55</td></tr><tr><td style="text-align:left;"><code>INSTALL_K3S_SKIP_START</code></td><td style="text-align:left;">\u5C06\u4E0D\u4F1A\u542F\u52A8 <code>K3s</code> \u670D\u52A1</td></tr><tr><td style="text-align:left;"><code>INSTALL_K3S_SKIP_DOWNLOAD</code></td><td style="text-align:left;">\u7528\u4E8E\u79BB\u7EBF\u5B89\u88C5\uFF1B\u8BBE\u7F6E\u4E4B\u540E\u4E0D\u4F1A\u4E0B\u8F7D\u8FDC\u7A0B\u5DE5\u5177</td></tr></tbody></table><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5176\u5B9E\u5C31\u628A\u5BF9\u5E94\u53C2\u6570\u52A0\u5230systemd\u914D\u7F6E\u6587\u4EF6\u91CC\u9762\u53BB\u4E86</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--docker&quot;</span> <span class="token function">sh</span> -

<span class="token comment"># \u81EA\u52A8\u5316\u90E8\u7F72(\u4E0D\u7528\u83B7\u53D6token\u503C\u4E86)</span>
<span class="token comment"># \u4E3B\u8282\u70B9\u548C\u5DE5\u4F5C\u8282\u70B9\u4F7F\u7528\u6211\u4EEC\u6307\u5B9A\u7684key\u6765\u901A\u4FE1</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>rancher-k3s <span class="token function">sh</span> -
<span class="token function">sudo</span> <span class="token function">cat</span> /var/lib/rancher/k3s/server/token
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5176\u4ED6\u8BF4\u660E</strong></p><ul><li>\u8FD0\u884C <code>agent</code> \u65F6\u8FD8\u5FC5\u987B\u8BBE\u7F6E <code>K3S_TOKEN</code></li><li>\u4EE5 <code>K3S_</code> \u5F00\u5934\u7684\u73AF\u5883\u53D8\u91CF\u5C06\u88AB\u4FDD\u7559\uFF0C\u4F9B <code>systemd/openrc</code> \u4F7F\u7528</li><li>\u6CA1\u6709\u660E\u786E\u8BBE\u7F6E <code>exec</code> \u5E76\u8BBE\u7F6E <code>K3S_URL</code> \u7684\u8BDD\u4F1A\u5C06\u547D\u4EE4\u9ED8\u8BA4\u4E3A\u5DE5\u4F5C\u8282\u70B9</li></ul><h3 id="\u6807\u5FD7\u548C\u73AF\u5883\u53D8\u91CF" tabindex="-1"><a class="header-anchor" href="#\u6807\u5FD7\u548C\u73AF\u5883\u53D8\u91CF" aria-hidden="true">#</a> \u6807\u5FD7\u548C\u73AF\u5883\u53D8\u91CF</h3><p>\u5728\u6574\u4E2A k3s \u6587\u6863\u5B66\u4E60\u4E2D\uFF0C\u4F1A\u770B\u5230\u4E00\u4E9B\u9009\u9879\u53EF\u4EE5\u4F5C\u4E3A\u547D\u4EE4\u6807\u5FD7\u548C\u73AF\u5883\u53D8\u91CF\u4F20\u9012\u8FDB\u6765\uFF0C\u90A3\u8BE5\u5982\u4F55\u4F7F\u7528\u6807\u5FD7\u548C\u73AF\u5883\u53D8\u91CF\u5462\uFF1F</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u4F7F\u7528\u6807\u5FD7</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">K3S_KUBECONFIG_MODE</span><span class="token operator">=</span><span class="token string">&quot;644&quot;</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> -
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - --write-kubeconfig-mode <span class="token number">644</span>

<span class="token comment"># \u73AF\u5883\u53D8\u91CF</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--flannel-backend none&quot;</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> -
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server --flannel-backend none
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="k3s-server-agent-\u5E38\u7528\u914D\u7F6E" tabindex="-1"><a class="header-anchor" href="#k3s-server-agent-\u5E38\u7528\u914D\u7F6E" aria-hidden="true">#</a> K3s Server/Agent - \u5E38\u7528\u914D\u7F6E</h3><details class="custom-container details"><summary>\u5C55\u5F00\u67E5\u770B</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># write-kubeconfig</span>
<span class="token comment"># \u5C06\u7BA1\u7406\u5BA2\u6237\u7AEF\u7684kubeconfig\u5199\u5165\u8FD9\u4E2A\u6587\u4EF6</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">K3S_KUBECONFIG_OUTPUT</span><span class="token operator">=</span>/root/.kube/config <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u4F7F\u7528docker\u4F5C\u4E3A\u5BB9\u5668\u8FD0\u884C\u65F6</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--docker&quot;</span> <span class="token function">sh</span> -

<span class="token comment"># \u6307\u5B9A\u8FD0\u884C\u65F6\u5DE5\u5177</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--container-runtime-endpoint containerd&quot;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -


<span class="token comment"># \u8BBE\u7F6E\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u914D\u7F6E\u6587\u4EF6</span>
<span class="token comment"># \u9ED8\u8BA4\u914D\u7F6E\u6587\u4EF6: /etc/rancher/k3s/registries.yaml</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--private-registry xxx&quot;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u9488\u5BF9\u591A\u7F51\u5361\u4E3B\u673A\u5B89\u88C5K3s\u96C6\u7FA4</span>
<span class="token comment"># \u9ED8\u8BA4\u591A\u7F51\u5361\u4F1A\u4F7F\u7528\u9ED8\u8BA4\u7F51\u5173\u7684\u90A3\u4E2A\u5361</span>
route <span class="token parameter variable">-n</span>

<span class="token comment"># K3s server</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--node-ip=192.168.100.100&quot;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># K3s agent  K3S_URL=https:?</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://192.168.71.130:6443 <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>xxx <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--node-ip=192.168.71.131&quot;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># --tls-san</span>
<span class="token comment"># \u5728TLS\u8BC1\u4E66\u4E2D\u6DFB\u52A0\u5176\u4ED6\u4E3B\u673A\u540D\u6216IP\u4F5C\u4E3A\u4E3B\u673A\u5907\u7528\u540D\u79F0</span>
<span class="token comment"># \u5373\u5728\u516C\u7F51\u73AF\u5883\u4E0B\u5141\u8BB8\u901A\u8FC7\u516C\u7F51IP\u8BBF\u95EE\u63A7\u5236\u3001\u64CD\u4F5C\u8FDC\u7A0B\u96C6\u7FA4</span>
<span class="token comment"># \u6216\u8005\u90E8\u7F72\u591A\u4E2AServer\u5E76\u4F7F\u7528LB\u8FDB\u884C\u8D1F\u8D23\uFF0C\u5C31\u9700\u8981\u4FDD\u7559\u516C\u7F51\u5730\u5740</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--tls-san 1.1.1.1&quot;</span>  <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u83B7\u53D6\u914D\u7F6E</span>
kubectl get secret k3s-serving <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-o</span> yaml

<span class="token comment"># \u7136\u540E\u672C\u673A\u590D\u5236\u516C\u7F51\u4E3B\u8282\u70B9\u5BF9\u5E94\u7684yaml\u6587\u4EF6\u5373\u53EF\u672C\u5730\u64CD\u4F5C\u4E86</span>
<span class="token function">scp</span> ci@1.1.1.1:/etc/rancher/k3s/k3s.yaml ~/.kube/config

<span class="token comment"># \u4FEE\u6539\u542F\u52A8\u7684\u670D\u52A1\u5BF9\u5E94\u914D\u7F6E(\u8C03\u6574\u8282\u70B9\u7684\u542F\u52A8\u7684\u6700\u5927Pod\u6570\u91CF)</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--kubelet-arg=max-pods=200&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u4FEE\u6539\u542F\u52A8\u7684\u670D\u52A1\u5BF9\u5E94\u914D\u7F6E(\u4F7F\u7528ipvs\u4F5C\u4E3A\u670D\u52A1\u8C03\u5EA6\u5DE5\u5177)</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--kube-proxy-arg=proxy-mode=ipvs&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u4FEE\u6539\u542F\u52A8\u7684\u670D\u52A1\u5BF9\u5E94\u914D\u7F6E(\u8C03\u6574\u670D\u52A1\u542F\u52A8\u7684\u7AEF\u53E3\u8303\u56F4)</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--kube-apiserver-arg=service-node-port-range=40000-50000&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># kubelet-arg     --kubelet-arg</span>
<span class="token comment"># kube-apiserver  --kube-apiserver-arg</span>
<span class="token comment"># kube-proxy-arg  --kube-proxy-arg</span>
<span class="token comment"># kube-proxy-arg  --kube-proxy-arg=proxy-mode=ipvs</span>
<span class="token comment"># --data-dir</span>
<span class="token comment"># \u4FEE\u6539K3s\u6570\u636E\u5B58\u50A8\u76EE\u5F55</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--data-dir=/opt/k3s-data&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u7981\u7528\u7EC4\u4EF6</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--disable traefik&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u81EA\u5DF1\u52A0\u81EA\u5DF1\u9700\u8981\u7684\u670D\u52A1</span>
<span class="token function">ls</span> /var/lib/rancher/k3s/server/manifests
kubectl get pods <span class="token parameter variable">-A</span> <span class="token operator">|</span> <span class="token function">grep</span> traefik

<span class="token comment"># \u6DFB\u52A0label\u548Ctaint\u6807\u8BC6</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--node-label foo=bar,hello=world \\
        --node-taint key1=value1:NoExecute&#39;</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u67E5\u770B\u4E00\u4E0B</span>
kubectl describe nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="k3s-server-agent-\u6570\u636E\u5E93\u9009\u9879" tabindex="-1"><a class="header-anchor" href="#k3s-server-agent-\u6570\u636E\u5E93\u9009\u9879" aria-hidden="true">#</a> K3s Server/Agent - \u6570\u636E\u5E93\u9009\u9879</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u6307\u5B9A\u6570\u636E\u6E90\u540D\u79F0</span>
<span class="token comment"># \u6807\u5FD7\u4F4D: --datastore-endpoint&amp;nbsp;value</span>
<span class="token comment"># \u73AF\u5883\u53D8\u91CF: K3S_DATASTORE_ENDPOINT</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--datastore-endpoint&amp;nbsp;etcd&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -
    
 
<span class="token comment"># cron\u89C4\u8303\u4E2D\u7684\u5FEB\u7167\u95F4\u9694\u65F6\u95F4</span>
<span class="token comment"># --etcd-snapshot-schedule-cron&amp;nbsp;value</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--etcd-snapshot-schedule-cron *&amp;nbsp;*/5&amp;nbsp;*&amp;nbsp;*&amp;nbsp;*&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="k3s-\u5B89\u88C5\u4E8B\u9879-\u7F51\u7EDC\u9009\u9879" tabindex="-1"><a class="header-anchor" href="#k3s-\u5B89\u88C5\u4E8B\u9879-\u7F51\u7EDC\u9009\u9879" aria-hidden="true">#</a> K3s \u5B89\u88C5\u4E8B\u9879 - \u7F51\u7EDC\u9009\u9879</h3><p>\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C<code>K3s</code> \u5C06\u4EE5 <code>flannel</code> \u4F5C\u4E3A <code>CNI</code> \u8FD0\u884C\uFF0C\u4F7F\u7528 <code>VXLAN</code> \u4F5C\u4E3A\u9ED8\u8BA4\u540E\u7AEF\uFF0C<code>CNI</code> \u548C\u9ED8\u8BA4\u540E\u7AEF\u90FD\u53EF\u4EE5\u901A\u8FC7\u53C2\u6570\u4FEE\u6539\u3002\u8981\u542F\u7528\u52A0\u5BC6\uFF0C\u8BF7\u4F7F\u7528\u4E0B\u9762\u7684 <code>IPSec</code> \u6216 <code>WireGuard</code> \u9009\u9879\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u9ED8\u8BA4\u5B89\u88C5K3s\u4E4B\u540E\u7684\u7F51\u7EDC\u914D\u7F6E</span>
<span class="token function">sudo</span> <span class="token function">cat</span> /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;Network&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;10.42.0.0/16&quot;</span>,
    <span class="token string">&quot;EnableIPv6&quot;</span><span class="token builtin class-name">:</span> false,
    <span class="token string">&quot;EnableIPv4&quot;</span><span class="token builtin class-name">:</span> true,
    <span class="token string">&quot;IPv6Network&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;::/0&quot;</span>,
    <span class="token string">&quot;Backend&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;vxlan&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">CLI Flag \u548C Value</th><th style="text-align:left;">\u63CF\u8FF0</th></tr></thead><tbody><tr><td style="text-align:left;"><code>--flannel-backend=vxlan</code></td><td style="text-align:left;">\u4F7F\u7528 <code>VXLAN</code> \u540E\u7AEF(\u9ED8\u8BA4)</td></tr><tr><td style="text-align:left;"><code>--flannel-backend=host-gw</code></td><td style="text-align:left;">\u4F7F\u7528 <code>host-gw</code> \u540E\u7AEF</td></tr><tr><td style="text-align:left;"><code>--flannel-backend=ipsec</code></td><td style="text-align:left;">\u4F7F\u7528 <code>IPSEC</code> \u540E\u7AEF\uFF1B\u5BF9\u7F51\u7EDC\u6D41\u91CF\u8FDB\u884C\u52A0\u5BC6</td></tr><tr><td style="text-align:left;"><code>--flannel-backend=wireguard</code></td><td style="text-align:left;">\u4F7F\u7528 <code>WireGuard</code> \u540E\u7AEF\uFF1B\u5BF9\u7F51\u7EDC\u6D41\u91CF\u8FDB\u884C\u52A0\u5BC6</td></tr></tbody></table><p><strong>\u914D\u7F6E Flannel \u9009\u9879</strong></p><p>\u8FD9\u6837\uFF0C\u6211\u5C31\u53EF\u4EE5\u5728\u5B89\u88C5 <code>K3s</code> \u6216\u8005\u4E4B\u540E\u4FEE\u6539\u5BF9\u5E94\u914D\u7F6E\u6587\u4EF6\uFF0C\u6765\u4FEE\u6539 <code>Flannel</code> \u9ED8\u8BA4\u7684\u540E\u7AEF\u7F51\u7EDC\u914D\u7F6E\u9009\u9879(\u91CD\u542F\u4F1A\u8986\u76D6\u4E0D\u751F\u6548)\u4E86\u3002\u4E0B\u9762\uFF0C\u6211\u4EEC\u6F14\u793A\u4E0B\uFF0C\u5982\u4F55\u4FEE\u6539\u4E3A <code>host-gw</code> \u6A21\u5F0F\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u4E3B\u8282\u70B9</span>
<span class="token comment"># flannel-backend\u4F7F\u7528host-gw</span>
<span class="token comment"># \u8BE5\u6A21\u5F0F\u4F1A\u628A\u5BF9\u7AEF\u4E3B\u673A\u7684IP\u5F53\u505A\u9ED8\u8BA4\u7F51\u7BA1(\u591AServer\u60C5\u51B5)</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--flannel-backend=host-gw&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u5DE5\u4F5C\u8282\u70B9</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://192.168.100.100:6443 <span class="token punctuation">\\</span>
    <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>xxx <span class="token function">sh</span> -

<span class="token comment"># \u9ED8\u8BA4\u7684\u8DEF\u7531\u4FE1\u606F</span>
route <span class="token parameter variable">-n</span>
<span class="token number">0.0</span>.0.0         <span class="token number">172.16</span>.64.1     <span class="token number">0.0</span>.0.0         UG    <span class="token number">100</span>    <span class="token number">0</span>        <span class="token number">0</span> enp0s2
<span class="token number">10.42</span>.1.0       <span class="token number">172.16</span>.64.9     <span class="token number">255.255</span>.255.0   UG    <span class="token number">0</span>      <span class="token number">0</span>        <span class="token number">0</span> enp0s2

<span class="token comment"># \u67E5\u770B\u914D\u7F6E\u4E4B\u540E\u7684\u7F51\u7EDC\u914D\u7F6E</span>
<span class="token function">sudo</span> <span class="token function">cat</span> /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;Network&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;10.42.0.0/16&quot;</span>,
    <span class="token string">&quot;Backend&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;host-gw&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u542F\u7528 Directrouting \u7279\u6027</strong></p><p><strong>Flannel \u81EA\u8EAB\u7684\u7279\u6027</strong>\uFF1A\u5F53\u4E3B\u673A\u5728\u540C\u4E00\u5B50\u7F51\u65F6\uFF0C\u542F\u7528 <code>direct routes</code>(\u5982 <code>host-gw</code>)\u3002<code>vxlan</code> \u53EA\u7528\u4E8E\u5C06\u6570\u636E\u5305\u5C01\u88C5\u5230\u4E0D\u540C\u5B50\u7F51\u7684\u4E3B\u673A\u4E0A\uFF0C\u540C\u5B50\u7F51\u7684\u4E3B\u673A\u4E4B\u95F4\u4F7F\u7528 <code>host-gw</code>\uFF0C\u9ED8\u8BA4\u503C\u4E3A <code>false</code>\u3002</p><p>\u8981\u6DFB\u52A0\u6211\u4EEC\u5C31\u4E0D\u80FD\u4FEE\u6539\u5176\u5BF9\u5E94\u7684\u7F51\u7EDC\u914D\u7F6E\u6587\u4EF6\uFF0C\u56E0\u4E3A\u91CD\u65B0\u5B89\u88C5\u6216\u8005\u91CD\u542F\u90FD\u4F1A\u628A\u8FD9\u4E2A\u914D\u7F6E\u51B2\u6389(\u53D8\u6210\u9ED8\u8BA4\u914D\u7F6E)\uFF0C\u6240\u4EE5\u9700\u8981\u6298\u4E2D\u4E0B\u3002\u6211\u4EEC\u81EA\u5EFA\u4E00\u4E2A\u7F51\u7EDC\u914D\u7F6E\u6587\u4EF6\uFF0C\u7136\u540E\u5728\u542F\u52A8\u7684\u65F6\u5019\u6267\u884C\u4ECE\u54EA\u4E2A\u914D\u7F6E\u6587\u4EF6\u91CC\u9762\u52A0\u8F7D\u5BF9\u5E94\u914D\u7F6E\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># k3s\u7684master\u548Cagent</span>
<span class="token function">sudo</span> <span class="token function">cat</span> /etc/flannel/net-conf.json
<span class="token punctuation">{</span>
    <span class="token string">&quot;Network&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;10.42.0.0/16&quot;</span>,
    <span class="token string">&quot;Backend&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;Type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;vxlan&quot;</span>,
        <span class="token string">&quot;Directrouting&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># k3s master</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--flannel-backend=host-gw&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u81EA\u5B9A\u4E49 CNI</strong></p><p>\u4F7F\u7528 <code>--flannel-backend=none</code>(\u7981\u7528) \u8FD0\u884C <code>K3s</code>\uFF0C\u7136\u540E\u5728\u5B89\u88C5\u4F60\u9009\u62E9\u7684 <code>CNI</code>\u3002\u6309\u7167 Calico CNI \u63D2\u4EF6\u6307\u5357 \u6765\u4FEE\u6539 <code>Calico</code> \u7684 <code>YAML</code> \u914D\u7F6E\u6587\u4EF6\uFF0C\u5728 <code>container_settings</code> \u90E8\u5206\u4E2D\u5141\u8BB8 <code>IP</code> \u8F6C\u53D1\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u52A0\u5230Calico\u7684YAML\u6587\u4EF6\u4E2D</span>
<span class="token comment"># \u5141\u8BB8IP\u8F6C\u53D1(\u8FD9\u4E2A\u662FK3s\u7684\u4E00\u4E2A\u9650\u5236\uFF1B\u9700\u8981\u5F00\u542F)</span>
<span class="token string">&quot;container_settings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;allow_ip_forwarding&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

- name: CALICO_IPV4POOL_CIDR
  value: <span class="token string">&quot;192.168.200.0/24&quot;</span>

<span class="token comment"># \u901A\u8FC7\u5728\u4E3B\u673A\u4E0A\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF0C\u786E\u4FDD\u8BBE\u7F6E\u5DF2\u88AB\u5E94\u7528(true)</span>
<span class="token function">sudo</span> <span class="token function">cat</span> /etc/cni/net.d/10-canal.conflist

<span class="token comment"># calico</span>
<span class="token comment"># \u5176\u4E2D--cluster-cidr\u53EF\u4E0D\u8BBE\u7F6E</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--flannel-backend=none \\
        --cluster-cidr=192.168.200.0/24&quot;&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># \u542F\u52A8\u7F51\u7EDC\u670D\u52A1</span>
kubectl apply <span class="token parameter variable">-f</span> ./calico.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5916\u90E8\u6570\u636E\u5E93" tabindex="-1"><a class="header-anchor" href="#\u5916\u90E8\u6570\u636E\u5E93" aria-hidden="true">#</a> \u5916\u90E8\u6570\u636E\u5E93</h3><blockquote><p><strong>\u7406\u89E3 Server \u8282\u70B9\u7684\u5B89\u88C5\uFF0C\u4EE5\u53CA\u6CE8\u518C Agent \u8282\u70B9\u7684\u6B65\u9AA4\uFF01</strong></p></blockquote><p><strong>\u4F7F\u7528\u5916\u90E8\u6570\u636E\u5E93\u5B9E\u73B0\u9AD8\u53EF\u7528\u5B89\u88C5</strong></p><ul><li>\u4E24\u4E2A\u6216\u591A\u4E2A<code>server</code> \u8282\u70B9</li><li>\u96F6\u4E2A\u6216\u591A\u4E2A<code>agent</code> \u8282\u70B9</li><li>\u5916\u90E8\u6570\u636E\u5B58\u50A8(<code>Etcd/MySQL/PostgRES</code>)</li><li>\u56FA\u5B9A\u7684\u6CE8\u518C\u5730\u5740(<code>LB</code>)</li><li>\u8FD9\u5E94\u8BE5\u662F\u6700\u9002\u5408\u56FD\u5185\u7528\u6237\u7684 <strong>K3s HA</strong> \u65B9\u6848\uFF1A https://mp.weixin.qq.com/s/0Wk2MzfWqMqt8DfUK_2ICA</li></ul><p>\u867D\u7136\u5355\u8282\u70B9 <code>k3s server</code> \u96C6\u7FA4\u53EF\u4EE5\u6EE1\u8DB3\u5404\u79CD\u7528\u4F8B\uFF0C\u4F46\u662F\u5BF9\u4E8E\u9700\u8981\u7A33\u5B9A\u8FD0\u884C\u7684\u91CD\u8981\u73AF\u5883\uFF0C\u53EF\u4EE5\u5728 <code>HA</code> \u914D\u7F6E\u4E2D\u8FD0\u884C <code>K3s</code>\uFF0C\u5982\u4F55\u4F7F\u7528\u5916\u90E8\u6570\u636E\u5E93\u5B89\u88C5\u4E00\u4E2A\u9AD8\u53EF\u7528\u7684 <code>K3s</code> \u96C6\u7FA4\uFF1F</p><table><thead><tr><th style="text-align:left;">\u4E3B\u673A\u540D</th><th style="text-align:left;">\u89D2\u8272</th><th style="text-align:left;">IP</th></tr></thead><tbody><tr><td style="text-align:left;">k3s-server-1</td><td style="text-align:left;">k3s master</td><td style="text-align:left;">172.31.2.134</td></tr><tr><td style="text-align:left;">k3s-server-2</td><td style="text-align:left;">k3s master</td><td style="text-align:left;">172.31.2.42</td></tr><tr><td style="text-align:left;">k3s-db</td><td style="text-align:left;">DB</td><td style="text-align:left;">172.31.10.251</td></tr><tr><td style="text-align:left;">k3s-lb</td><td style="text-align:left;">LB</td><td style="text-align:left;">172.31.13.97</td></tr><tr><td style="text-align:left;">k3s-agent</td><td style="text-align:left;">k3s agent</td><td style="text-align:left;">172.31.15.130</td></tr></tbody></table><details class="custom-container details"><summary>\u5C55\u5F00\u67E5\u770B\u5B89\u88C5\u8FC7\u7A0B</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 1.\u521B\u5EFA\u4E00\u4E2A\u5916\u90E8\u6570\u636E\u5B58\u50A8</span>
<span class="token function">docker</span> run <span class="token parameter variable">--name</span> some-mysql <span class="token punctuation">\\</span>
    <span class="token parameter variable">--restart</span><span class="token operator">=</span>unless-stopped <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>password <span class="token parameter variable">-d</span> mysql:5.7

<span class="token comment"># 2.\u542F\u52A8k3s-server\u8282\u70B9(\u6709\u8BFB\u5199\u6743\u9650\u4E0D\u7528\u52A0\u5E93\u540D)</span>
<span class="token comment"># mysql://username:password@tcp(hostname:3306)/database-name</span>
<span class="token comment"># \u53EF\u52A0\u6C61\u70B9 --node-taint CriticalAddonsOnly=true:NoExecute</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token function">sh</span> - server <span class="token punctuation">\\</span>
    --datastore-endpoint<span class="token operator">=</span><span class="token string">&quot;mysql://root:password@ip:3306/k3s&quot;</span> <span class="token punctuation">\\</span>
    --tls-san <span class="token number">172.31</span>.13.97

<span class="token comment"># 3.\u914D\u7F6E\u56FA\u5B9A\u7684\u6CE8\u518C\u5730\u5740(k3s-lb\u8282\u70B9)</span>
<span class="token comment"># Agent\u8282\u70B9\u9700\u8981\u4E00\u4E2AURL\u6765\u6CE8\u518C(LB)</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/nginx.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
worker_processes 4;
worker_rlimit_nofile 40000;

events {
    worker_connections 8192;
}

stream {
    upstream k3s_api {
        least_conn;
        server 172.31.2.134:6443 max_fails=3 fail_timeout=5s;
        server 172.31.2.42:6443 max_fails=3 fail_timeout=5s;
    }
    server {
        listen     6443;
        proxy_pass k3s_api;
    }
}
EOF</span>

<span class="token comment"># \u542F\u52A8\u670D\u52A1</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--restart</span><span class="token operator">=</span>unless-stopped <span class="token punctuation">\\</span>
  <span class="token parameter variable">-p</span> <span class="token number">6443</span>:6443 <span class="token punctuation">\\</span>
  <span class="token parameter variable">-v</span> /etc/nginx.conf:/etc/nginx/nginx.conf <span class="token punctuation">\\</span>
  nginx:1.14

<span class="token comment"># 4.\u52A0\u5165Agent\u8282\u70B9</span>
<span class="token comment"># Agent\u4F1A\u4FDD\u5B58LB\u8282\u70B9\u548C\u6BCF\u4E2AServer\u8282\u70B9\u7684IP\u4FE1\u606F</span>
<span class="token comment"># cat /var/lib/rancher/k3s/agent/etc/k3s-agent-load-balancer.json</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn
    <span class="token assign-left variable">K3S_URL</span><span class="token operator">=</span>https://172.31.13.97:6443 <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>mynodetoken <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -

<span class="token comment"># 5.\u901A\u8FC7kubeconfig\u8BBF\u95EEK3s\u96C6\u7FA4</span>
kubectl get nodes
NAME           STATUS   ROLES                  AGE   VERSION
k3s-server-1   Ready    control-plane,master   68s   v1.20.7+k3s1
k3s-server-2   Ready    control-plane,master   66s   v1.20.7+k3s1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u5D4C\u5165\u5F0F DB \u7684\u9AD8\u53EF\u7528</strong></p><p>\u8981\u5728\u8FD9\u79CD\u6A21\u5F0F\u4E0B\u8FD0\u884C <code>K3s</code>\uFF0C\u4F60\u5FC5\u987B\u6709<strong>\u5947\u6570\u7684\u670D\u52A1\u5668\u8282\u70B9</strong>\uFF08raft)\uFF0C\u5EFA\u8BAE\u4ECE\u4E09\u4E2A\u8282\u70B9\u5F00\u59CB\u3002\u5728\u5D4C\u5165\u5F0F\u4E2D\uFF0C\u9ED8\u8BA4\u4F7F\u7528 <code>Etcd</code> \u4F5C\u4E3A\u9AD8\u53EF\u7528\u7684\u6570\u636E\u5E93\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u670D\u52A1\u5668\u8282\u70B9(\u542F\u52A8etcd\u96C6\u7FA4)</span>
<span class="token comment"># SECRET\u6211\u4EEC\u9884\u5B9A\u4E00\u4E2Akey\u503C</span>
<span class="token comment"># \u4F7F\u7528cluster-init\u6807\u5FD7\u6765\u542F\u7528\u96C6\u7FA4</span>
<span class="token comment"># \u5E76\u4F7F\u7528\u4E00\u4E2A\u6807\u8BB0\u4F5C\u4E3A\u5171\u4EAB\u7684\u5BC6\u94A5\u6765\u52A0\u5165\u5176\u4ED6\u670D\u52A1\u5668\u5230\u96C6\u7FA4\u4E2D</span>
root@cubnode02:/workspces<span class="token comment"># curl -sfL https://get.k3s.io | \\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>SECRET <span class="token punctuation">\\</span>
    <span class="token function">sh</span> <span class="token parameter variable">-s</span> - --cluster-init

<span class="token comment"># \u67E5\u770B\u7C7B\u578B</span>
root@cubnode02:/workspces<span class="token comment"># sudo  kubectl get nodes</span>
NAME    STATUS  ROLES                      AGE  VERSION
ip-xxx  Ready   control-plane,etcd,master  19h  v1.23.6+k3s1

<span class="token comment"># \u5176\u4ED6\u670D\u52A1\u5668\u8282\u70B9(2/3)</span>
root@cubnode02:/workspces<span class="token comment"># curl -sfL https://get.k3s.io | \\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token assign-left variable">K3S_TOKEN</span><span class="token operator">=</span>SECRET <span class="token punctuation">\\</span>
    <span class="token function">sh</span> <span class="token parameter variable">-s</span> - <span class="token parameter variable">--server</span> https://<span class="token operator">&lt;</span>ip-or-host-server<span class="token operator">&gt;</span>:6443

<span class="token comment"># \u67E5\u8BE2ETCD\u96C6\u7FA4\u72B6\u6001</span>
<span class="token comment"># etcd\u8BC1\u4E66\u9ED8\u8BA4\u76EE\u5F55\uFF1A/var/lib/rancher/k3s/server/tls/etcd</span>
<span class="token comment"># etcd\u6570\u636E\u9ED8\u8BA4\u76EE\u5F55\uFF1A/var/lib/rancher/k3s/server/db/etcd</span>
root@cubnode02:/workspces<span class="token comment"># ETCDCTL_ENDPOINTS=&#39;https://172.31.12.136:2379,\\</span>
    https://172.31.4.43:2379,<span class="token punctuation">\\</span>
    https://172.31.4.190:2379<span class="token string">&#39; \\
ETCDCTL_CACERT=&#39;</span>/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt<span class="token string">&#39; \\
ETCDCTL_CERT=&#39;</span>/var/lib/rancher/k3s/server/tls/etcd/server-client.crt<span class="token string">&#39;\\
ETCDCTL_KEY=&#39;</span>/var/lib/rancher/k3s/server/tls/etcd/server-client.key&#39; <span class="token punctuation">\\</span>
<span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl endpoint status --write-out<span class="token operator">=</span>table
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u96C6\u7FA4\u6570\u636E\u5B58\u50A8\u9009\u9879" tabindex="-1"><a class="header-anchor" href="#\u96C6\u7FA4\u6570\u636E\u5B58\u50A8\u9009\u9879" aria-hidden="true">#</a> \u96C6\u7FA4\u6570\u636E\u5B58\u50A8\u9009\u9879</h3><p>\u4F7F\u7528 <code>etcd</code> \u4EE5\u5916\u7684\u6570\u636E\u5B58\u50A8\u8FD0\u884C <code>K8S</code> \u7684\u80FD\u529B\u4F7F <code>K3s</code> \u533A\u522B\u4E8E\u5176\u4ED6 <code>K8S</code> \u53D1\u884C\u7248\u3002\u8BE5\u529F\u80FD\u4E3A <code>K8S</code> \u64CD\u4F5C\u8005\u63D0\u4F9B\u4E86\u7075\u6D3B\u6027\uFF0C\u53EF\u7528\u7684\u6570\u636E\u5B58\u50A8\u9009\u9879\u5141\u8BB8\u4F60\u9009\u62E9\u4E00\u4E2A\u6700\u9002\u5408\u7528\u4F8B\u7684\u6570\u636E\u5B58\u50A8\u3002</p><p>\u5982\u679C\u4F60\u7684\u56E2\u961F\u6CA1\u6709\u64CD\u4F5C <code>etcd</code> \u7684\u4E13\u4E1A\u77E5\u8BC6\uFF0C\u53EF\u4EE5\u9009\u62E9 <code>MySQL</code> \u6216 <code>PostgreSQL</code> \u7B49\u4F01\u4E1A\u7EA7 <code>SQL</code> \u6570\u636E\u5E93\u3002\u5982\u679C\u60A8\u9700\u8981\u5728 <code>CI/CD</code> \u73AF\u5883\u4E2D\u8FD0\u884C\u4E00\u4E2A\u7B80\u5355\u7684\u3001\u77ED\u6682\u7684\u96C6\u7FA4\uFF0C\u53EF\u4EE5\u4F7F\u7528\u5D4C\u5165\u5F0F <code>SQLite</code> \u6570\u636E\u5E93</p><p>\u5982\u679C\u4F60\u60F3\u4F7F\u7528\u5916\u90E8\u6570\u636E\u5B58\u50A8\uFF0C\u5982 <code>PostgreSQL</code>\u3001<code>MySQL</code> \u6216 <code>etcd</code>\uFF0C\u4F60\u5FC5\u987B\u8BBE\u7F6E <code>datastore-endpoint</code> \u53C2\u6570\uFF0C\u4EE5\u4FBF <code>K3s</code> \u77E5\u9053\u5982\u4F55\u8FDE\u63A5\u5230\u5B83\uFF0C\u4E5F\u53EF\u4EE5\u6307\u5B9A\u53C2\u6570\u6765\u914D\u7F6E\u8FDE\u63A5\u7684\u8BA4\u8BC1\u548C\u52A0\u5BC6\u3002\u4E0B\u8868\u603B\u7ED3\u4E86\u8FD9\u4E9B\u53C2\u6570\uFF0C\u5B83\u4EEC\u53EF\u4EE5\u4F5C\u4E3A <code>CLI</code> \u6807\u5FD7\u6216\u73AF\u5883\u53D8\u91CF\u4F20\u9012\u3002</p><table><thead><tr><th style="text-align:left;">CLI Flag</th><th style="text-align:left;">\u73AF\u5883\u53D8\u91CF</th><th style="text-align:left;">\u63CF\u8FF0</th></tr></thead><tbody><tr><td style="text-align:left;"><code>--datastore-endpoint</code></td><td style="text-align:left;"><code>K3S_DATASTORE_ENDPOINT</code></td><td style="text-align:left;">\u6307\u5B9A\u4E00\u4E2A PostgresSQL\u3001MySQL \u6216 etcd \u8FDE\u63A5\u5B57\u7B26\u4E32\u3002\u7528\u4E8E\u63CF\u8FF0\u4E0E\u6570\u636E\u5B58\u50A8\u7684\u8FDE\u63A5\u3002\u8FD9\u4E2A\u5B57\u7B26\u4E32\u7684\u7ED3\u6784\u662F\u7279\u5B9A\u4E8E\u6BCF\u4E2A\u540E\u7AEF\u7684\uFF0C\u8BE6\u60C5\u5982\u4E0B\u3002</td></tr><tr><td style="text-align:left;"><code>--datastore-cafile</code></td><td style="text-align:left;"><code>K3S_DATASTORE_CAFILE</code></td><td style="text-align:left;">TLS \u8BC1\u4E66\u9881\u53D1\u673A\u6784\uFF08CA\uFF09\u6587\u4EF6\uFF0C\u7528\u4E8E\u5E2E\u52A9\u786E\u4FDD\u4E0E\u6570\u636E\u5B58\u50A8\u7684\u901A\u4FE1\u5B89\u5168\u3002\u5982\u679C\u4F60\u7684\u6570\u636E\u5B58\u50A8\u901A\u8FC7 TLS \u670D\u52A1\u8BF7\u6C42\uFF0C\u4F7F\u7528\u7531\u81EA\u5B9A\u4E49\u8BC1\u4E66\u9881\u53D1\u673A\u6784\u7B7E\u7F72\u7684\u8BC1\u4E66\uFF0C\u4F60\u53EF\u4EE5\u4F7F\u7528\u8FD9\u4E2A\u53C2\u6570\u6307\u5B9A\u8BE5 CA\uFF0C\u8FD9\u6837 K3s \u5BA2\u6237\u7AEF\u5C31\u53EF\u4EE5\u6B63\u786E\u9A8C\u8BC1\u8BC1\u4E66\u3002</td></tr><tr><td style="text-align:left;"><code>--datastore-certfile</code></td><td style="text-align:left;"><code>K3S_DATASTORE_CERTFILE</code></td><td style="text-align:left;">TLS \u8BC1\u4E66\u6587\u4EF6\uFF0C\u7528\u4E8E\u5BF9\u6570\u636E\u5B58\u50A8\u8FDB\u884C\u57FA\u4E8E\u5BA2\u6237\u7AEF\u8BC1\u4E66\u7684\u9A8C\u8BC1\u3002\u8981\u4F7F\u7528\u8FD9\u4E2A\u529F\u80FD\uFF0C\u4F60\u7684\u6570\u636E\u5B58\u50A8\u5FC5\u987B\u88AB\u914D\u7F6E\u4E3A\u652F\u6301\u57FA\u4E8E\u5BA2\u6237\u7AEF\u8BC1\u4E66\u7684\u8BA4\u8BC1\u3002\u5982\u679C\u4F60\u6307\u5B9A\u4E86\u8FD9\u4E2A\u53C2\u6570\uFF0C\u4F60\u8FD8\u5FC5\u987B\u6307\u5B9A<code>datastore-keyfile</code>\u53C2\u6570\u3002</td></tr><tr><td style="text-align:left;"><code>--datastore-keyfile</code></td><td style="text-align:left;"><code>K3S_DATASTORE_KEYFILE</code></td><td style="text-align:left;">TLS \u5BC6\u94A5\u6587\u4EF6\uFF0C\u7528\u4E8E\u5BF9\u6570\u636E\u5B58\u50A8\u8FDB\u884C\u57FA\u4E8E\u5BA2\u6237\u7AEF\u8BC1\u4E66\u7684\u8BA4\u8BC1\u3002\u66F4\u591A\u7EC6\u8282\u8BF7\u53C2\u89C1\u524D\u9762\u7684<code>datastore-certfile</code>\u53C2\u6570\u3002</td></tr></tbody></table><p>\u4F5C\u4E3A\u6700\u4F73\u5B9E\u8DF5\uFF0C\u6211\u4EEC\u5EFA\u8BAE\u5C06\u8FD9\u4E9B\u53C2\u6570\u8BBE\u7F6E\u4E3A\u73AF\u5883\u53D8\u91CF\uFF0C\u800C\u4E0D\u662F\u547D\u4EE4\u884C\u53C2\u6570\uFF0C\u8FD9\u6837\u4F60\u7684\u6570\u636E\u5E93\u8BC1\u4E66\u6216\u5176\u4ED6\u654F\u611F\u4FE1\u606F\u5C31\u4E0D\u4F1A\u4F5C\u4E3A\u8FDB\u7A0B\u4FE1\u606F\u7684\u4E00\u90E8\u5206\u66B4\u9732\u51FA\u6765\u3002</p><h2 id="\u79C1\u6709\u955C\u50CF\u4ED3\u5E93" tabindex="-1"><a class="header-anchor" href="#\u79C1\u6709\u955C\u50CF\u4ED3\u5E93" aria-hidden="true">#</a> \u79C1\u6709\u955C\u50CF\u4ED3\u5E93</h2><p><code>K3s</code> \u9ED8\u8BA4\u4F7F\u7528 <code>containerd</code> \u4F5C\u4E3A\u5BB9\u5668\u8FD0\u884C\u65F6\uFF0C\u6240\u4EE5\u5728 <code>docker</code> \u4E0A\u914D\u7F6E\u955C\u50CF\u4ED3\u5E93\u662F\u4E0D\u751F\u6548\u7684\u3002<code>K3s</code> \u955C\u50CF\u4ED3\u5E93\u914D\u7F6E\u6587\u4EF6\u7531\u4E24\u5927\u90E8\u5206\u7EC4\u6210\uFF1A<code>mirrors</code> \u548C <code>configs</code>\u3002</p><ul><li><code>Mirrors</code> \u662F\u4E00\u4E2A\u7528\u4E8E\u5B9A\u4E49\u4E13\u7528\u955C\u50CF\u4ED3\u5E93\u7684\u540D\u79F0\u548C <code>endpoint</code> \u7684\u6307\u4EE4</li><li><code>Configs</code> \u90E8\u5206\u5B9A\u4E49\u4E86\u6BCF\u4E2A <code>mirror</code> \u7684 <code>TLS</code> \u548C\u8BC1\u4E66\u914D\u7F6E</li><li>\u5BF9\u4E8E\u6BCF\u4E2A <code>mirror</code>\uFF0C\u4F60\u53EF\u4EE5\u5B9A\u4E49 <code>auth</code> \u548C <code>/</code> \u6216 <code>tls</code></li></ul><p><code>K3s registry</code> \u914D\u7F6E\u76EE\u5F55\u4E3A\uFF1A <code>/etc/rancher/k3s/registries.yaml</code>\u3002<code>K3s</code> \u542F\u52A8\u65F6\u4F1A\u68C0\u67E5 <code>/etc/rancher/k3s/</code> \u4E2D\u662F\u5426\u5B58\u5728 <code>registries.yaml</code> \u6587\u4EF6\uFF0C\u5E76\u6307\u793A <code>containerd</code> \u4F7F\u7528\u6587\u4EF6\u4E2D\u5B9A\u4E49\u7684\u955C\u50CF\u4ED3\u5E93\u3002\u5982\u679C\u4F60\u60F3\u4F7F\u7528\u4E00\u4E2A\u79C1\u6709\u7684\u955C\u50CF\u4ED3\u5E93\uFF0C\u90A3\u4E48\u4F60\u9700\u8981\u5728\u6BCF\u4E2A\u4F7F\u7528\u955C\u50CF\u4ED3\u5E93\u7684\u8282\u70B9\u4E0A\u4EE5 <code>root</code> \u8EAB\u4EFD\u521B\u5EFA\u8FD9\u4E2A\u6587\u4EF6\u3002</p><p>\u8BF7\u6CE8\u610F\uFF0C<code>server</code> \u8282\u70B9\u9ED8\u8BA4\u662F\u53EF\u4EE5\u8C03\u5EA6\u7684\u3002\u5982\u679C\u4F60\u6CA1\u6709\u5728 <code>server</code> \u8282\u70B9\u4E0A\u8BBE\u7F6E\u6C61\u70B9\uFF0C\u90A3\u4E48\u5C06\u5728\u5B83\u4EEC\u4E0A\u8FD0\u884C\u5DE5\u4F5C\u8D1F\u8F7D\uFF0C\u8BF7\u786E\u4FDD\u5728\u6BCF\u4E2A <code>server</code> \u8282\u70B9\u4E0A\u521B\u5EFA <code>registries.yaml</code> \u6587\u4EF6\u3002</p><p><code>containerd</code> \u4F7F\u7528\u4E86\u7C7B\u4F3C <code>K8S</code> \u4E2D <code>svc</code> \u4E0E <code>endpoint</code> \u7684\u6982\u5FF5\uFF0C<code>svc</code> \u53EF\u4EE5\u7406\u89E3\u4E3A\u8BBF\u95EE\u540D\u79F0\uFF0C\u8FD9\u4E2A\u540D\u79F0\u4F1A\u89E3\u6790\u5230\u5BF9\u5E94\u7684 <code>endpoint</code> \u4E0A\u3002\u4E5F\u53EF\u4EE5\u7406\u89E3 <code>mirror</code> \u914D\u7F6E\u5C31\u662F\u4E00\u4E2A\u53CD\u5411\u4EE3\u7406\uFF0C\u5B83\u628A\u5BA2\u6237\u7AEF\u7684\u8BF7\u6C42\u4EE3\u7406\u5230 <code>endpoint</code> \u914D\u7F6E\u7684\u540E\u7AEF\u955C\u50CF\u4ED3\u5E93\u3002<code>mirror</code> \u540D\u79F0\u53EF\u4EE5\u968F\u610F\u586B\u5199\uFF0C\u4F46\u662F\u5FC5\u987B\u7B26\u5408 <code>IP</code> \u6216\u57DF\u540D\u7684\u5B9A\u4E49\u89C4\u5219\u3002\u5E76\u4E14\u53EF\u4EE5\u914D\u7F6E\u591A\u4E2A <code>endpoint</code>\uFF0C\u9ED8\u8BA4\u89E3\u6790\u5230\u7B2C\u4E00\u4E2A <code>endpoint</code>\uFF0C\u5982\u679C\u7B2C\u4E00\u4E2A <code>endpoint</code> \u6CA1\u6709\u8FD4\u56DE\u6570\u636E\uFF0C\u5219\u81EA\u52A8\u5207\u6362\u5230\u7B2C\u4E8C\u4E2A <code>endpoint</code>\uFF0C\u4EE5\u6B64\u7C7B\u63A8\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># /etc/rancher/k3s/registries.yaml</span>
<span class="token comment"># \u540C\u65F6\u53EF\u4EE5\u8BBE\u7F6E\u591A\u4E2Amirrors\u5730\u5740</span>
<span class="token comment"># \u53EF\u4EE5\u5BF9mirrors\u8BBE\u7F6E\u6743\u9650\u548C\u8BC1\u4E66</span>
mirrors:
  <span class="token string">&quot;172.31.6.200:5000&quot;</span><span class="token builtin class-name">:</span>
    endpoint:
      - <span class="token string">&quot;http://172.31.6.200:5000&quot;</span>
      - <span class="token string">&quot;http://x.x.x.x:5000&quot;</span>
      - <span class="token string">&quot;http://y.y.y.y:5000&quot;</span>
  <span class="token string">&quot;rancher.ksd.top:5000&quot;</span><span class="token builtin class-name">:</span>
    endpoint:
      - <span class="token string">&quot;http://172.31.6.200:5000&quot;</span>
  <span class="token string">&quot;docker.io&quot;</span><span class="token builtin class-name">:</span>
    endpoint:
      - <span class="token string">&quot;https://fogjl973.mirror.aliyuncs.com&quot;</span>
      - <span class="token string">&quot;https://registry-1.docker.io&quot;</span>

configs:
  <span class="token string">&quot;172.31.6.200:5000&quot;</span><span class="token builtin class-name">:</span>
    auth:
      username: admin
      password: Harbor@12345
    tls:
      cert_file: /home/ubuntu/harbor2.escapelife.site.cert
      key_file: /home/ubuntu/harbor2.escapelife.site.key
      ca_file: /home/ubuntu/ca.crt
<span class="token comment"># \u955C\u50CF\u90FD\u662F\u4ECE\u540C\u4E00\u4E2A\u4ED3\u5E93\u83B7\u53D6\u5230\u7684</span>
$ <span class="token function">sudo</span> systemctl restart k3s.service
$ <span class="token function">sudo</span> crictl pull <span class="token number">172.31</span>.6.200:5000/library/alpine
$ <span class="token function">sudo</span> crictl pull rancher.ksd.top:5000/library/alpine
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u6211\u4EEC\u4ECB\u7ECD\u4E0B\uFF0C\u5982\u4F55\u4F7F\u7528 <code>TLS</code> \u914D\u7F6E\u3002</p><details class="custom-container details"><summary>\u5C55\u5F00</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
<span class="token comment"># \u8BC1\u4E66\u9881\u53D1\u673A\u6784\u9881\u53D1\u7684\u8BC1\u4E66</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  &quot;harbor.escapelife.site&quot;:
    endpoint:
      - &quot;https://harbor.escapelife.site&quot;
configs:
  &quot;harbor.escapelife.site&quot;:
    auth:
      username: admin
      password: Harbor@12345
EOF</span>

<span class="token function">sudo</span> systemctl restart k3s

<span class="token comment"># \u81EA\u7B7E\u540D\u8BC1\u4E66</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  &quot;harbor2.escapelife.site&quot;:
    endpoint:
      - &quot;https://harbor2.escapelife.site&quot;
configs:
  &quot;harbor2.escapelife.site&quot;:
    auth:
      username: admin
      password: Harbor@12345
    tls:
      cert_file: /home/ubuntu/harbor2.escapelife.site.cert
      key_file:  /home/ubuntu/harbor2.escapelife.site.key
      ca_file:   /home/ubuntu/ca.crt
EOF</span>

<span class="token function">sudo</span> systemctl restart k3s

<span class="token comment"># \u4E0D\u4F7F\u7528TLS\u8BC1\u4E66</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  &quot;docker.io&quot;:
    endpoint:
      - &quot;https://fogjl973.mirror.aliyuncs.com&quot;
      - &quot;https://registry-1.docker.io&quot;
EOF</span>

<span class="token function">sudo</span> systemctl restart k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></details><p><code>K3s</code> \u5C06\u4F1A\u5728 <code>/var/lib/rancher/k3s/agent/etc/containerd/config.toml</code> \u4E2D\u4E3A <code>containerd</code> \u751F\u6210 <code>config.toml</code>\u3002\u5982\u679C\u8981\u5BF9\u8FD9\u4E2A\u6587\u4EF6\u8FDB\u884C\u9AD8\u7EA7\u8BBE\u7F6E\uFF0C\u4F60\u53EF\u4EE5\u5728\u540C\u4E00\u76EE\u5F55\u4E2D\u521B\u5EFA\u53E6\u4E00\u4E2A\u540D\u4E3A <code>config.toml.tmpl</code> \u7684\u6587\u4EF6\uFF0C\u6B64\u6587\u4EF6\u5C06\u4F1A\u4EE3\u66FF\u9ED8\u8BA4\u8BBE\u7F6E\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
<span class="token comment"># \u5B8C\u6574\u793A\u4F8B</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/rancher/k3s/registries.yaml
mirrors:
  <span class="token string">&quot;harbor.escapelife.site&quot;</span><span class="token builtin class-name">:</span>
     endpoint:
     - <span class="token string">&quot;https://harbor.escapelife.site&quot;</span>
  <span class="token string">&quot;harbor2.escapelife.site&quot;</span><span class="token builtin class-name">:</span>
     endpoint:
     - <span class="token string">&quot;https://harbor2.escapelife.site&quot;</span>
  <span class="token string">&quot;172.31.19.227:5000&quot;</span><span class="token builtin class-name">:</span>
     endpoint:
     - <span class="token string">&quot;http://172.31.19.227:5000&quot;</span>
  <span class="token string">&quot;docker.io&quot;</span><span class="token builtin class-name">:</span>
     endpoint:
     - <span class="token string">&quot;https://fogjl973.mirror.aliyuncs.com&quot;</span>
     - <span class="token string">&quot;https://registry-1.docker.io&quot;</span>

configs:
  <span class="token string">&quot;harbor.escapelife.site&quot;</span><span class="token builtin class-name">:</span>
     auth:
       username: admin
       password: Harbor@12345

  <span class="token string">&quot;harbor2.escapelife.site&quot;</span><span class="token builtin class-name">:</span>
     auth:
       username: admin
       password: Harbor@12345
     tls:
       cert_file: /home/ubuntu/harbor2.escapelife.site.cert
       key_file:  /home/ubuntu/harbor2.escapelife.site.key
       ca_file:   /home/ubuntu/ca.crt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5B89\u88C5\u4E8B\u9879-\u6CE8\u610F\u4E8B\u9879" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5\u4E8B\u9879-\u6CE8\u610F\u4E8B\u9879" aria-hidden="true">#</a> \u5B89\u88C5\u4E8B\u9879 - \u6CE8\u610F\u4E8B\u9879</h2><p><strong>Helm</strong></p><ul><li>\u5982\u679C\u9700\u8981\u4F7F\u7528 <code>helm</code> \u64CD\u4F5C <code>K3s</code> \u96C6\u7FA4\uFF0C\u9700\u8981\u521B\u5EFA <code>~/.kube/conf</code> \u76EE\u5F55</li><li>\u9700\u8981\u6267\u884C <code>cp /etc/rancher/k3s/k3s.yaml ~/.kube/config</code> \u547D\u4EE4</li></ul><p><strong>\u81EA\u52A8\u90E8\u7F72\u7684\u6E05\u5355</strong></p><ul><li>\u5C06\u7531 <code>rancher/helm-controller</code> \u5728\u8FD0\u884C\u65F6\u5B89\u88C5</li><li>\u76EE\u5F55\u8DEF\u5F84\uFF1A<code>/var/lib/rancher/k3s/server/manifests</code></li><li>\u76EE\u5F55\u4E0B\u9762\u7684\u6BCF\u4E2A <code>yaml</code> \u5C31\u4EE3\u8868\u8FD9\u4E2A\u4E00\u4E2A\u9700\u8981\u542F\u52A8\u7684\u670D\u52A1</li></ul><p>\u5BF9\u4E8E\u6211\u4EEC\u5E0C\u671B\u4F7F\u7528\u7684\u7EC4\u4EF6\uFF0C\u53EF\u4EE5\u5728\u542F\u52A8\u7684\u65F6\u5019\u7981\u7528\u9ED8\u8BA4\u7EC4\u4EF6\uFF0C\u5728\u624B\u52A8\u90E8\u7F72\u4F60\u9700\u8981\u7684\u4E00\u4E9B\u7EC4\u4EF6(\u901A\u5E38\u662F\u653E\u5230\u4E00\u4E2A\u6307\u5B9A\u76EE\u5F55\u4E0B\u9762\uFF0C\u968F\u7740\u670D\u52A1\u542F\u52A8\u81EA\u52A8\u62C9\u8D77)\uFF0C\u4ECE\u800C\u8FBE\u5230\u7075\u6D3B\u4F7F\u7528\u7684\u76EE\u7684\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u67E5\u770B\u6240\u6709Pod\u670D\u52A1</span>
<span class="token comment"># \u6BD4\u5982helm/coredns\u4E5F\u4E0D\u662F\u81EA\u5E26\u7684\u5C31\u662F\u901A\u8FC7\u8FD9\u4E2A\u65B9\u5F0F\u521B\u5EFA\u7684</span>
<span class="token function">sudo</span> kubectl get pods <span class="token parameter variable">-A</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6CE8\u518C Agent \u8282\u70B9</strong></p><ol><li>\u5DE5\u4F5C\u8282\u70B9\u5BC6\u7801\u5B58\u50A8\uFF1A<code>/etc/rancher/node/password</code></li><li>\u4E3B\u8282\u70B9\u7684\u5BC6\u7801\u5B58\u50A8\uFF1A<code>/var/lib/rancher/k3s/server/cred/node-passwd</code></li></ol><p>\u5728 <code>agent</code> \u8282\u70B9\u8FD0\u884C\u6CE8\u518C\u547D\u4EE4\uFF0C\u4F1A\u548C <code>server</code> \u8282\u70B9\u53D1\u8D77 <code>websocket</code> \u8FDE\u63A5\uFF0C\u7136\u540E\u4F1A\u5728\u5DE5\u4F5C\u8282\u70B9\u4E0A\u9762\u521B\u5EFA\u4E00\u4E2A\u968F\u673A\u7684\u5BC6\u7801\u3002\u7136\u540E\u4F1A\u62FF\u7740\u8FD9\u4E2A\u5BC6\u7801\u548C\u5DE5\u4F5C\u8282\u70B9\u7684\u4E3B\u673A\u540D\uFF0C\u53D1\u9001\u7ED9\u4E3B\u8282\u70B9\u3002\u7136\u540E\u4E3B\u8282\u70B9\u4F1A\u5C06\u8FD9\u4E2A\u4FE1\u606F\u5728\u4FDD\u5B58(<code>k8s secrets</code>)\u8D77\u6765\uFF0C\u968F\u540E\u7684\u4EFB\u4F55\u5C1D\u8BD5\u90FD\u5FC5\u987B\u4F7F\u7528\u76F8\u540C\u7684\u5BC6\u7801\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5DE5\u4F5C\u8282\u70B9\u7684\u5BC6\u7801\u4FE1\u606F(password+hostname)</span>
<span class="token function">sudo</span> <span class="token function">cat</span> /etc/rancher/node/password

<span class="token comment"># \u67E5\u770B\u4E3B\u8282\u70B9\u7684\u5BC6\u7801\u4FE1\u606F</span>
<span class="token comment"># https://docs.rancher.cn/docs/k3s/architecture/_index#\u6CE8\u518C-agent-\u8282\u70B9</span>
<span class="token function">sudo</span> kubectl get secret k3s2.node-password.k3s <span class="token parameter variable">-o</span> yaml <span class="token parameter variable">-n</span> kube-system

<span class="token comment"># \u53EF\u4EE5\u67E5\u770B\u65E5\u5FD7\u4FE1\u606F\u9A8C\u8BC1\u8FD9\u4E2A\u4FE1\u606F\u7684\u5B58\u5728</span>
<span class="token function">sudo</span> <span class="token function">tail</span> <span class="token parameter variable">-200f</span> /var/log/syslog <span class="token operator">|</span> <span class="token function">grep</span> k3s

<span class="token comment"># \u53D1\u73B0\u8282\u70B9\u4FE1\u606F\u63D0\u793ANotReady\u72B6\u6001</span>
<span class="token comment"># \u53EF\u4EE5\u5C1D\u8BD5\u5220\u9664\u8282\u70B9\u7684\u5BC6\u7801\u5B58\u50A8\u4FE1\u606F\uFF0C\u4E4B\u540E\u4F1A\u81EA\u52A8\u83B7\u53D6\u65B0\u7684</span>
<span class="token function">sudo</span> kubectl delete secret k3s2.node-password.k3s <span class="token parameter variable">-n</span> kube-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u81EA\u5B9A\u4E49\u5B58\u50A8\u7C7B\u578B</strong></p><p>\u96C6\u7FA4\u542F\u52A8\u4E4B\u540E\uFF0C\u9ED8\u8BA4\u4F1A\u542F\u52A8\u4E00\u4E2A <code>local-path</code> \u7684\u7EC4\u4EF6\uFF0C\u7528\u4E8E\u63D0\u4F9B\u670D\u52A1\u6302\u8F7D\u5B58\u50A8\u4F7F\u7528\uFF0C\u5176\u9ED8\u8BA4\u4EE5 <code>PVC</code> \u7684\u5F62\u5F0F\u3002\u4E4B\u540E\uFF0C\u5C06\u5176\u5B58\u50A8\u5728 <code>/var/lib/rancher/k3s/server/storageclass</code> \u76EE\u5F55\u4E0B\u9762\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u67E5\u770B\u7EC4\u4EF6</span>
<span class="token function">sudo</span> kubectl get pods <span class="token parameter variable">-A</span>

<span class="token comment"># \u67E5\u770B\u5BF9\u5E94\u5B58\u50A8</span>
<span class="token function">sudo</span> kubectl get storageclass

<span class="token comment"># \u53EF\u4EE5\u4F7F\u7528\u53C2\u6570\u4FEE\u6539\u9ED8\u8BA4\u5B58\u50A8\u5730\u5740</span>
<span class="token comment"># --default-local-storage-path&amp;nbsp;value</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn <span class="token punctuation">\\</span>
    <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&#39;--etcd-snapshot-schedule-cron *&amp;nbsp;*/5&amp;nbsp;*&amp;nbsp;*&amp;nbsp;*&#39;</span> <span class="token punctuation">\\</span>
    <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="k3s-\u96C6\u7FA4\u5347\u7EA7" tabindex="-1"><a class="header-anchor" href="#k3s-\u96C6\u7FA4\u5347\u7EA7" aria-hidden="true">#</a> K3s \u96C6\u7FA4\u5347\u7EA7</h2><blockquote><p><strong>\u624B\u52A8\u5347\u7EA7 + \u81EA\u52A8\u5347\u7EA7</strong></p></blockquote><p>\u5F53\u5347\u7EA7 <code>K3s</code> \u65F6\uFF0C<code>K3s</code> \u670D\u52A1\u4F1A\u91CD\u542F\u6216\u505C\u6B62\uFF0C\u4F46 <code>K3s</code> \u5BB9\u5668\u4F1A\u7EE7\u7EED\u8FD0\u884C\u3002\u8981\u505C\u6B62\u6240\u6709\u7684 <code>K3s</code> \u5BB9\u5668\u5E76\u91CD\u7F6E\u5BB9\u5668\u7684\u72B6\u6001\uFF0C\u53EF\u4EE5\u4F7F\u7528 <code>k3s-killall.sh</code> \u811A\u672C\u3002 <code>killall</code> \u811A\u672C\u6E05\u7406\u5BB9\u5668\u3001<code>K3s</code> \u76EE\u5F55\u548C\u7F51\u7EDC\u7EC4\u4EF6\uFF0C\u540C\u65F6\u4E5F\u5220\u9664\u4E86 <code>iptables</code> \u94FE\u548C\u6240\u6709\u76F8\u5173\u89C4\u5219\u3002\u96C6\u7FA4\u6570\u636E\u4E0D\u4F1A\u88AB\u5220\u9664\u3002</p><p><strong>\u624B\u52A8\u5347\u7EA7 - \u4F7F\u7528\u5B89\u88C5\u811A\u672C\u5347\u7EA7 K3s</strong></p><p>\u4F60\u53EF\u4EE5\u901A\u8FC7\u4F7F\u7528\u5B89\u88C5\u811A\u672C\u5347\u7EA7 <code>K3s</code>\uFF0C\u6216\u8005\u624B\u52A8\u5B89\u88C5\u6240\u9700\u7248\u672C\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5347\u7EA7\u5230\u6700\u65B0stable\u7248\u672C</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token function">sh</span> -

<span class="token comment"># \u5347\u7EA7\u5230latest\u7248\u672C</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_CHANNEL</span><span class="token operator">=</span>latest <span class="token function">sh</span> -

<span class="token comment"># \u5347\u7EA7\u5230v1.20\u7684\u6700\u65B0\u7248\u672C</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_CHANNEL</span><span class="token operator">=</span><span class="token string">&quot;v1.20&quot;</span> <span class="token function">sh</span> -

<span class="token comment"># \u5347\u7EA7\u5230\u6307\u5B9A\u7248\u672C</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_VERSION</span><span class="token operator">=</span>vX.Y.Z-rc1 <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u6CE8\u610F\u548Cdocker\u7684\u533A\u522B\uFF0C\u5173\u4E8E\u7248\u672C\u662F <code>+</code> \u8FD8\u662F <code>-</code></p></blockquote><p><strong>\u624B\u52A8\u5347\u7EA7 - \u4F7F\u7528\u4E8C\u8FDB\u5236\u6587\u4EF6\u624B\u52A8\u5347\u7EA7 K3s</strong></p><p>\u4F60\u53EF\u4EE5\u901A\u8FC7\u4F7F\u7528\u5B89\u88C5\u811A\u672C\u5347\u7EA7 <code>K3s</code>\uFF0C\u6216\u8005\u624B\u52A8\u5B89\u88C5\u6240\u9700\u7248\u672C\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u4ECE\u53D1\u5E03\u4E0B\u8F7D\u6240\u9700\u7248\u672C\u7684K3s\u4E8C\u8FDB\u5236\u6587\u4EF6</span>
https://github.com/rancher/k3s/releases

<span class="token comment"># \u5C06\u4E0B\u8F7D\u7684\u4E8C\u8FDB\u5236\u6587\u4EF6\u590D\u5236\u5230/usr/local/bin/k3s</span>
$ <span class="token function">mv</span> ./k3s /usr/local/bin/k3s

<span class="token comment"># \u505C\u6B62\u65E7\u7684K3s\u4E8C\u8FDB\u5236\u6587\u4EF6</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_CHANNEL</span><span class="token operator">=</span><span class="token string">&quot;v1.20&quot;</span> <span class="token function">sh</span> -

<span class="token comment"># \u542F\u52A8\u65B0\u7684K3s\u4E8C\u8FDB\u5236\u6587\u4EF6</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_VERSION</span><span class="token operator">=</span>vX.Y.Z-rc1 <span class="token function">sh</span> -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F60\u53EF\u4EE5\u4F7F\u7528 <code>Rancher</code> \u7684 <code>system-upgrad-controller</code> \u6765\u7BA1\u7406 <code>K3s</code> \u96C6\u7FA4\u5347\u7EA7\u3002\u8FD9\u662F\u4E00\u79CD <code>Kubernetes</code> \u539F\u751F\u7684\u96C6\u7FA4\u5347\u7EA7\u65B9\u6CD5\u3002\u5B83\u5229\u7528\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49(<code>CRD</code>)\u3001\u8BA1\u5212\u548C\u63A7\u5236\u5668\uFF0C\u6839\u636E\u914D\u7F6E\u7684\u8BA1\u5212\u5B89\u6392\u5347\u7EA7\u3002</p><p>\u63A7\u5236\u5668\u901A\u8FC7\u76D1\u63A7\u8BA1\u5212\u548C\u9009\u62E9\u8981\u5728\u5176\u4E0A\u8FD0\u884C\u5347\u7EA7 <code>job</code> \u7684\u8282\u70B9\u6765\u8C03\u5EA6\u5347\u7EA7\uFF0C\u8BA1\u5212\u901A\u8FC7\u6807\u7B7E\u9009\u62E9\u5668\u5B9A\u4E49\u54EA\u4E9B\u8282\u70B9\u5E94\u8BE5\u5347\u7EA7\u3002\u5F53\u4E00\u4E2A <code>job</code> \u6210\u529F\u8FD0\u884C\u5B8C\u6210\u540E\uFF0C\u63A7\u5236\u5668\u4F1A\u7ED9\u5B83\u8FD0\u884C\u7684\u8282\u70B9\u6253\u4E0A\u76F8\u5E94\u7684\u6807\u7B7E\u3002</p><p><strong>\u81EA\u52A8\u5347\u7EA7 - \u4F7F\u7528\u4E8C\u8FDB\u5236\u6587\u4EF6\u624B\u52A8\u5347\u7EA7 K3s</strong></p><ul><li>k3s-upgrade\uFF1Ahttps://github.com/k3s-io/k3s-upgrade</li><li>system-upgrade-controller\uFF1Ahttps://github.com/rancher/system-upgrade-controller</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5C06system-upgrade-controller\u5B89\u88C5\u5230\u60A8\u7684\u96C6\u7FA4\u4E2D</span>
kubectl apply <span class="token parameter variable">-f</span> https://github.com/rancher/system-upgrade-controller/releases/download/v0.6.2/system-upgrade-controller.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><details class="custom-container details"><summary>\u914D\u7F6E\u8BA1\u5212</summary><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u914D\u7F6E\u8BA1\u5212</span>
<span class="token comment"># \u5EFA\u8BAE\u60A8\u6700\u5C11\u521B\u5EFA\u4E24\u4E2A\u8BA1\u5212</span>
<span class="token comment"># \u5347\u7EA7server\u8282\u70B9\u7684\u8BA1\u5212\u548C\u5347\u7EA7agent\u8282\u70B9\u7684\u8BA1\u5212</span>

<span class="token comment"># Server plan</span>
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: server-plan
  namespace: system-upgrade
spec:
  concurrency: <span class="token number">1</span>
  cordon: <span class="token boolean">true</span>
  nodeSelector:
    matchExpressions:
    - key: node-role.kubernetes.io/master <span class="token comment"># \u9009\u62E9\u4E3B\u8282\u70B9</span>
      operator: In
      values:
      - <span class="token string">&quot;true&quot;</span>
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  version: v1.20.4+k3s1

<span class="token comment"># Agent plan</span>
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: agent-plan
  namespace: system-upgrade
spec:
  concurrency: <span class="token number">1</span>
  cordon: <span class="token boolean">true</span>
  nodeSelector:
    matchExpressions:
    - key: node-role.kubernetes.io/master <span class="token comment"># \u9009\u62E9\u5DE5\u4F5C\u8282\u70B9</span>
      operator: DoesNotExist
  prepare:
    args:
    - prepare
    - server-plan
    image: rancher/k3s-upgrade
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  version: v1.20.4+k3s1
<span class="token comment"># \u81EA\u52A8\u5347\u7EA7\u5230\u6700\u65B0\u7248\u672C(\u4E0D\u6307\u5B9A\u7248\u672C)</span>
apiVersion: upgrade.cattle.io/v1
kind: Plan
<span class="token punctuation">..</span>.
spec:
  <span class="token punctuation">..</span>.
  upgrade:
    image: rancher/k3s-upgrade
  channel: https://update.k3s.io/v1-release/channels/stable
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p><img src="http://sm.nsddd.top/smimage-20221126000754469.png" alt="image-20221126000754469"></p><h2 id="k3s-\u5907\u4EFD\u6062\u590D" tabindex="-1"><a class="header-anchor" href="#k3s-\u5907\u4EFD\u6062\u590D" aria-hidden="true">#</a> K3s \u5907\u4EFD\u6062\u590D</h2><blockquote><p><strong>SQLite + etcd + \u5916\u90E8\u6570\u636E\u5B58\u50A8</strong></p></blockquote><p><strong>\u4F7F\u7528\u5D4C\u5165\u5F0F SQLite \u6570\u636E\u5B58\u50A8\u8FDB\u884C\u5907\u4EFD\u548C\u6062\u590D</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u65B9\u5F0F1\uFF1A\u5907\u4EFD/\u6062\u590D\u6570\u636E\u76EE\u5F55</span>

<span class="token comment"># \u5907\u4EFD</span>
<span class="token function">cp</span> <span class="token parameter variable">-rf</span> /var/lib/rancher/k3s/server/db /opt/db

<span class="token comment"># \u6062\u590D</span>
systemctl stop k3s
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/rancher/k3s/server/db
<span class="token function">cp</span> <span class="token parameter variable">-rf</span> /opt/db /var/lib/rancher/k3s/server/db
systemctl start k3s


<span class="token comment"># \u65B9\u5F0F2\uFF1A\u901A\u8FC7 SQLite cli</span>

<span class="token comment"># \u5907\u4EFD</span>
sqlite3 /var/lib/rancher/k3s/server/db/state.db
SQLite version <span class="token number">3.22</span>.0 <span class="token number">2018</span>-01-22 <span class="token number">18</span>:45:57
Enter <span class="token string">&quot;.help&quot;</span> <span class="token keyword">for</span> usage hints.
sqlite<span class="token operator">&gt;</span> .backup <span class="token string">&quot;/opt/kine.db&quot;</span>
sqlite<span class="token operator">&gt;</span> .exit

<span class="token comment"># \u6062\u590D</span>
<span class="token function">sudo</span> systemctl stop k3s

sqlite3 /var/lib/rancher/k3s/server/db/state.db
SQLite version <span class="token number">3.22</span>.0 <span class="token number">2018</span>-01-22 <span class="token number">18</span>:45:57
Enter <span class="token string">&quot;.help&quot;</span> <span class="token keyword">for</span> usage hints.
sqlite<span class="token operator">&gt;</span> .restore <span class="token string">&#39;/opt/kine.db&#39;</span>
sqlite<span class="token operator">&gt;</span> .exit

<span class="token function">sudo</span> systemctl start k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F53\u4F7F\u7528\u5916\u90E8\u6570\u636E\u5B58\u50A8\u65F6\uFF0C\u5907\u4EFD\u548C\u6062\u590D\u64CD\u4F5C\u662F\u5728 <code>K3s</code> \u4E4B\u5916\u5904\u7406\u7684\u3002\u6570\u636E\u5E93\u7BA1\u7406\u5458\u9700\u8981\u5BF9\u5916\u90E8\u6570\u636E\u5E93\u8FDB\u884C\u5907\u4EFD\uFF0C\u6216\u8005\u4ECE\u5FEB\u7167\u6216\u8F6C\u50A8\u4E2D\u8FDB\u884C\u6062\u590D\u3002\u6211\u4EEC\u5EFA\u8BAE\u5C06\u6570\u636E\u5E93\u914D\u7F6E\u4E3A\u6267\u884C\u5B9A\u671F\u5FEB\u7167\u3002</p><p><strong>\u4F7F\u7528\u5916\u90E8\u6570\u636E\u5B58\u50A8\u8FDB\u884C\u5907\u4EFD\u548C\u6062\u590D</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5907\u4EFD</span>
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span> --all-databases --master-data <span class="token operator">&gt;</span> k3s-dbdump.db

<span class="token comment"># \u6062\u590D</span>
systemctl stop k3s
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>  <span class="token operator">&lt;</span> k3s-dbdump.db
systemctl start k3s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u4F7F\u7528\u5D4C\u5165\u5F0F etcd \u6570\u636E\u5B58\u50A8\u8FDB\u884C\u5907\u4EFD\u548C\u6062\u590D</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u521B\u5EFA\u5FEB\u7167(K3s\u9ED8\u8BA4\u542F\u7528\u5FEB\u7167)</span>
<span class="token comment"># \u5FEB\u7167\u76EE\u5F55\u9ED8\u8BA4: /var/lib/rancher/k3s/server/db/snapshots</span>

<span class="token comment"># \u8981\u914D\u7F6E\u5FEB\u7167\u95F4\u9694\u6216\u4FDD\u7559\u7684\u5FEB\u7167\u6570\u91CF</span>
--etcd-disable-snapshots       \u7981\u7528\u81EA\u52A8etcd\u5FEB\u7167
--etcd-snapshot-schedule-cron  \u5B9A\u65F6\u5FEB\u7167\u7684\u65F6\u95F4\u70B9\uFF1B\u8BA4\u503C\u4E3A\u6BCF12\u5C0F\u65F6\u89E6\u53D1\u4E00\u6B21
--etcd-snapshot-retention      \u4FDD\u7559\u7684\u5FEB\u7167\u6570\u91CF\uFF1B\u9ED8\u8BA4\u503C\u4E3A5
--etcd-snapshot-dir            \u4FDD\u5B58\u6570\u636E\u5E93\u5FEB\u7167\u7684\u76EE\u5F55\u8DEF\u5F84
--cluster-reset                \u5FD8\u8BB0\u6240\u6709\u7684\u5BF9\u7B49\u4F53\uFF1B\u6210\u4E3A\u65B0\u96C6\u7FA4\u7684\u552F\u4E00\u6210\u5458
--cluster-reset-restore-path   \u8981\u6062\u590D\u7684\u5FEB\u7167\u6587\u4EF6\u7684\u8DEF\u5F84
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F53 <code>K3s</code> \u4ECE\u5907\u4EFD\u4E2D\u6062\u590D\u65F6\uFF0C\u65E7\u7684\u6570\u636E\u76EE\u5F55\u5C06\u88AB\u79FB\u52A8\u5230<code>/var/lib/rancher/k3s/server/db/etcd-old/</code>\u3002\u7136\u540E <code>K3s</code> \u4F1A\u5C1D\u8BD5\u901A\u8FC7\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u6570\u636E\u76EE\u5F55\u6765\u6062\u590D\u5FEB\u7167\uFF0C\u7136\u540E\u4ECE\u4E00\u4E2A\u5E26\u6709\u4E00\u4E2A <code>etcd</code> \u6210\u5458\u7684\u65B0 <code>K3s</code> \u96C6\u7FA4\u542F\u52A8 <code>etcd</code>\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u4ECE\u5FEB\u7167\u6062\u590D\u96C6\u7FA4</span>
<span class="token comment"># \u4F7F\u7528--cluster-reset\u9009\u9879\u8FD0\u884CK3s</span>
<span class="token comment"># \u540C\u65F6\u7ED9\u51FA--cluster-reset-restore-path</span>
./k3s server <span class="token punctuation">\\</span>
    --cluster-reset <span class="token punctuation">\\</span>
    --cluster-reset-restore-path<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token environment constant">PATH</span>-TO-SNAPSHOT<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="k3s-\u5377\u548C\u5B58\u50A8" tabindex="-1"><a class="header-anchor" href="#k3s-\u5377\u548C\u5B58\u50A8" aria-hidden="true">#</a> K3s \u5377\u548C\u5B58\u50A8</h2><blockquote><p><strong>\u4ECB\u7ECD\u4E86\u5982\u4F55\u901A\u8FC7 local storage provider \u6216 Longhorn \u6765\u8BBE\u7F6E\u6301\u4E45\u5B58\u50A8\u3002</strong></p></blockquote><p>\u5F53\u90E8\u7F72\u4E00\u4E2A\u9700\u8981\u4FDD\u7559\u6570\u636E\u7684\u5E94\u7528\u7A0B\u5E8F\u65F6\uFF0C\u4F60\u9700\u8981\u521B\u5EFA\u6301\u4E45\u5B58\u50A8\u3002\u6301\u4E45\u5B58\u50A8\u5141\u8BB8\u60A8\u4ECE\u8FD0\u884C\u5E94\u7528\u7A0B\u5E8F\u7684 <code>pod</code> \u5916\u90E8\u5B58\u50A8\u5E94\u7528\u7A0B\u5E8F\u6570\u636E\u3002\u5373\u4F7F\u5E94\u7528\u7A0B\u5E8F\u7684 <code>pod</code> \u53D1\u751F\u6545\u969C\uFF0C\u8FD9\u79CD\u5B58\u50A8\u65B9\u5F0F\u4E5F\u53EF\u4EE5\u4F7F\u60A8\u7EF4\u62A4\u5E94\u7528\u7A0B\u5E8F\u6570\u636E\u3002</p><p><strong>\u8BBE\u7F6E Local Storage Provider \u652F\u6301</strong></p><p><code>K3s</code> \u81EA\u5E26 <code>Rancher</code> \u7684 <code>Local Path Provisioner</code>(<code>LPP</code>)\uFF0C\u8FD9\u4F7F\u5F97\u80FD\u591F\u4F7F\u7528\u5404\u81EA\u8282\u70B9\u4E0A\u7684\u672C\u5730\u5B58\u50A8\u6765\u5F00\u7BB1\u5373\u7528\u5730\u521B\u5EFA <code>pvc</code>\u3002\u6839\u636E\u7528\u6237\u914D\u7F6E\uFF0C<code>LPP</code> \u5C06\u81EA\u52A8\u5728\u8282\u70B9\u4E0A\u521B\u5EFA\u57FA\u4E8E <code>hostPath</code> \u7684\u6301\u4E45\u5377\u3002\u5B83\u5229\u7528\u4E86 <code>K8s</code> \u7684 <code>Local Persistent Volume</code> \u7279\u6027\u5F15\u5165\u7684\u7279\u6027\uFF0C\u4F46\u5B83\u6BD4 <code>K8s</code> \u4E2D\u5185\u7F6E\u7684 <code>local pv</code> \u7279\u6027\u66F4\u7B80\u5355\u7684\u89E3\u51B3\u65B9\u6848\u3002</p><details class="custom-container details"><summary>pvc.yaml</summary><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>path<span class="token punctuation">-</span>pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>path
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi

<span class="token comment"># pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>test
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>stable<span class="token punctuation">-</span>alpine
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volv
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volv
    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>path<span class="token punctuation">-</span>pvc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5E94\u7528yaml\u670D\u52A1</span>
kubectl create <span class="token parameter variable">-f</span> pvc.yaml pod.yaml

<span class="token comment"># \u786E\u8BA4PV\u548CPVC\u5DF2\u521B\u5EFA</span>
kubectl get <span class="token function">pv</span>
kubectl get pvc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u8BBE\u7F6E Longhorn \u652F\u6301</strong></p><p><code>K3s</code> \u652F\u6301 <code>Longhorn</code>(\u662F <code>K8s</code> \u7684\u4E00\u4E2A\u5F00\u6E90\u5206\u5E03\u5F0F\u5757\u5B58\u50A8\u7CFB\u7EDF)\u3002</p><details class="custom-container details"><summary>pvc.yaml</summary><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>
<span class="token comment"># \u5B89\u88C5Longhorn</span>
<span class="token comment"># \u5C06\u88AB\u5B89\u88C5\u5728\u547D\u540D\u7A7A\u95F4longhorn-system\u4E2D</span>
$ kubectl apply <span class="token punctuation">-</span>f https<span class="token punctuation">:</span>//raw.githubusercontent.com/longhorn/longhorn/master/deploy/longhorn.yaml

<span class="token comment"># pvc.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> longhorn<span class="token punctuation">-</span>volv<span class="token punctuation">-</span>pvc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> longhorn
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi

<span class="token comment"># pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volume<span class="token punctuation">-</span>test
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>stable<span class="token punctuation">-</span>alpine
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volv
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volv
    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> longhorn<span class="token punctuation">-</span>volv<span class="token punctuation">-</span>pvc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5E94\u7528yaml\u670D\u52A1</span>
kubectl create <span class="token parameter variable">-f</span> pvc.yaml pod.yaml

<span class="token comment"># \u786E\u8BA4PV\u548CPVC\u5DF2\u521B\u5EFA</span>
kubectl get <span class="token function">pv</span>
kubectl get pvc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="k3s-\u7F51\u7EDC\u76F8\u5173" tabindex="-1"><a class="header-anchor" href="#k3s-\u7F51\u7EDC\u76F8\u5173" aria-hidden="true">#</a> K3s \u7F51\u7EDC\u76F8\u5173</h2><p><strong>CoreDNS</strong></p><p><code>CoreDNS</code> \u662F\u5728 <code>agent</code> \u8282\u70B9\u542F\u52A8\u65F6\u90E8\u7F72\u7684\u3002\u8981\u7981\u7528\uFF0C\u8BF7\u5728\u6BCF\u53F0\u670D\u52A1\u5668\u4E0A\u8FD0\u884C <code>--disable coredns</code> \u9009\u9879\u3002\u5982\u679C\u4F60\u4E0D\u5B89\u88C5 <code>CoreDNS</code>\uFF0C\u4F60\u5C06\u9700\u8981\u81EA\u5DF1\u5B89\u88C5\u4E00\u4E2A\u96C6\u7FA4 <code>DNS</code> \u63D0\u4F9B\u5546\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5982\u4F55\u4FEE\u6539coredns\u53C2\u6570</span>
<span class="token comment"># /var/lib/rancher/k3s/server/manifests/coredns.yaml</span>
<span class="token comment"># \u8BE5\u6587\u4EF6\u91CD\u542FK3s\u670D\u52A1\u7684\u8BDD\u4F1A\u5BFC\u81F4coredns\u914D\u7F6E\u91CD\u65B0\u521D\u59CB\u5316</span>
<span class="token number">1</span>.\u5C06coredns.yaml\u4FDD\u5B58\u5230\u5176\u4ED6\u76EE\u5F55
<span class="token number">2</span>.\u901A\u8FC7 <span class="token parameter variable">--disable</span> coredns \u7981\u7528coredns
<span class="token number">3</span>.\u590D\u5236coredns.yaml\u5230/var/lib/rancher/k3s/server/manifests/\u76EE\u5F55\u5E76\u4FEE\u6539\u53C2\u6570
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Traefik Ingress Controller</strong></p><p>\u542F\u52A8 <code>server</code> \u65F6\uFF0C\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u4F1A\u90E8\u7F72 <code>Traefik</code>\uFF0C\u5BF9\u8BE5\u6587\u4EF6\u7684\u4EFB\u4F55\u4FEE\u6539\u90FD\u4F1A\u4EE5\u7C7B\u4F3C <code>kubectl apply</code> \u7684\u65B9\u5F0F\u81EA\u52A8\u90E8\u7F72\u5230 <code>Kubernetes</code> \u4E2D\uFF0C\u5C06\u4F7F\u7528\u4E3B\u673A\u4E0A\u7684 <code>80</code> \u548C <code>443</code> \u7AEF\u53E3\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># \u64CD\u4F5C\u548C\u4E0A\u9762\u57FA\u672C\u662F\u4E00\u81F4\u7684</span>
<span class="token comment"># \u8BF7\u4F7F\u7528 --disable traefik \u9009\u9879\u542F\u52A8\u6BCF\u4E2Aserver</span>
<span class="token comment"># /var/lib/rancher/k3s/server/manifests/traefik.yaml</span>
<span class="token comment"># \u5982\u4F55\u542F\u7528 treafik2 dashboard</span>
<span class="token comment"># http://traefik.example.com/dashboard</span>

<span class="token comment"># Note: in a kubernetes secret the string (e.g. generated by htpasswd) must be base64-encoded first.</span>
<span class="token comment"># To create an encoded user:password pair, the following command can be used:</span>
<span class="token comment"># htpasswd -nb admin admin | openssl base64</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> authsecret
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">users</span><span class="token punctuation">:</span> <span class="token punctuation">|</span>2
    YWRtaW46JGFwcjEkLkUweHd1Z0EkUjBmLi85WndJNXZWRFMyR2F2LmtELwoK

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> traefik.containo.us/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> IngressRoute
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> traefik<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span> Host(\`traefik.example.com\`) <span class="token important">&amp;&amp;</span> (PathPrefix(\`/api\`) <span class="token punctuation">|</span><span class="token punctuation">|</span> PathPrefix(\`/dashboard\`))
      <span class="token key atrule">kind</span><span class="token punctuation">:</span> Rule
      <span class="token key atrule">services</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> api@internal
          <span class="token key atrule">kind</span><span class="token punctuation">:</span> TraefikService
      <span class="token key atrule">middlewares</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> auth

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> traefik.containo.us/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Middleware
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auth
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">basicAuth</span><span class="token punctuation">:</span>
    <span class="token key atrule">secret</span><span class="token punctuation">:</span> authsecret <span class="token comment"># Kubernetes secret named &quot;secretName&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Service Load Balancer</strong></p><p><code>K3s</code> \u63D0\u4F9B\u4E86\u4E00\u4E2A\u540D\u4E3A <code>Klipper Load Balancer</code> \u7684\u8D1F\u8F7D\u5747\u8861\u5668\uFF0C\u5B83\u53EF\u4EE5\u4F7F\u7528\u53EF\u7528\u7684\u4E3B\u673A\u7AEF\u53E3\u3002\u5141\u8BB8\u521B\u5EFA <code>LoadBalancer</code> \u7C7B\u578B\u7684 <code>Service</code>\uFF0C\u4F46\u4E0D\u5305\u62EC <code>LB</code> \u7684\u5B9E\u73B0\u3002\u67D0\u4E9B <code>LB</code> \u670D\u52A1\u9700\u8981\u4E91\u63D0\u4F9B\u5546\uFF0C\u4F8B\u5982 <code>Amazon EC2</code>\u3002\u76F8\u6BD4\u4E4B\u4E0B\uFF0C<code>K3s service LB</code> \u4F7F\u5F97\u53EF\u4EE5\u5728\u6CA1\u6709\u4E91\u63D0\u4F9B\u5546\u7684\u60C5\u51B5\u4E0B\u4F7F\u7528 <code>LB</code> \u670D\u52A1\u3002</p><h2 id="helm-k3s" tabindex="-1"><a class="header-anchor" href="#helm-k3s" aria-hidden="true">#</a> helm(k3s)</h2><p><strong>K3s \u4E0E Helm</strong></p><blockquote><p><strong><code>Helm</code></strong> <strong>\u662F</strong> <strong><code>Kubernetes</code></strong> <strong>\u7684\u5305\u7BA1\u7406\u5DE5\u5177\uFF01</strong></p></blockquote><p><code>Helm</code> \u662F <code>Kubernetes</code> \u7684\u5305\u7BA1\u7406\u5DE5\u5177\u3002<code>Helm Chart</code> \u4E3A <code>Kubernetes YAML</code> \u6E05\u5355\u6587\u4EF6\u63D0\u4F9B\u4E86\u6A21\u677F\u5316\u8BED\u6CD5\uFF0C\u53EF\u4EE5\u901A\u8FC7 <code>Helm</code> \u5B89\u88C5\u5BF9\u5E94\u7684 <code>chart</code>\u3002<code>K3s</code> \u4E0D\u9700\u8981\u4EFB\u4F55\u7279\u6B8A\u7684\u914D\u7F6E\u5C31\u53EF\u4EE5\u4F7F\u7528 <code>Helm</code> \u547D\u4EE4\u884C\u5DE5\u5177\u3002</p><p><strong>\u81EA\u52A8\u90E8\u7F72 Helm charts</strong></p><p>\u5728 <code>/var/lib/rancher/k3s/server/manifests</code> \u4E2D\u627E\u5230\u7684\u4EFB\u4F55 <code>Kubernetes</code> \u6E05\u5355\u5C06\u4EE5\u7C7B\u4F3C <code>kubectl apply</code> \u7684\u65B9\u5F0F\u81EA\u52A8\u90E8\u7F72\u5230 <code>K3s</code>\u3002\u4EE5\u8FD9\u79CD\u65B9\u5F0F\u90E8\u7F72\u7684 <code>manifests</code> \u662F\u4F5C\u4E3A <code>AddOn</code> \u81EA\u5B9A\u4E49\u8D44\u6E90\u6765\u7BA1\u7406\u7684\u3002\u4F60\u4F1A\u53D1\u73B0\u6253\u5305\u7EC4\u4EF6\u7684 <code>AddOns</code>\uFF0C\u5982 <code>CoreDNS</code>\u3001<code>Local-Storage</code> \u7B49\u3002<code>AddOns</code> \u662F\u7531\u90E8\u7F72\u63A7\u5236\u5668\u81EA\u52A8\u521B\u5EFA\u7684\uFF0C\u5E76\u6839\u636E\u5B83\u4EEC\u5728 <code>manifests</code> \u76EE\u5F55\u4E0B\u7684\u6587\u4EF6\u540D\u547D\u540D\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u67E5\u770B\u8FD0\u884CAddOn\u8D44\u6E90</span>
$ kubectl get addon <span class="token parameter variable">-A</span>

<span class="token comment"># \u4E5F\u53EF\u4EE5\u5C06Helm-Chart\u4F5C\u4E3AAddOns\u90E8\u7F72</span>
https://github.com/rancher/helm-controller/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://sm.nsddd.top/smimage-20221126114506014.png" alt="image-20221126114506014"></p><p><strong>\u4F7F\u7528 Helm CRD</strong></p><p><code>HelmChart CRD</code> \u6355\u83B7\u4E86\u5927\u591A\u6570\u4F60\u901A\u5E38\u4F1A\u4F20\u9012\u7ED9 <code>helm</code> \u547D\u4EE4\u884C\u5DE5\u5177\u7684\u9009\u9879\u3002\u4E0B\u9762\u662F\u4E00\u4E2A\u4F8B\u5B50\uFF0C\u8BF4\u660E\u5982\u4F55\u4ECE\u9ED8\u8BA4\u7684 <code>Chart</code> \u8D44\u6E90\u5E93\u4E2D\u90E8\u7F72 <code>Grafana</code>\uFF0C\u8986\u76D6\u4E00\u4E9B\u9ED8\u8BA4\u7684 <code>Chart</code> \u503C\u3002\u8BF7\u6CE8\u610F\uFF0C<code>HelmChart</code> \u8D44\u6E90\u672C\u8EAB\u5728 <code>kube-system</code> \u547D\u540D\u7A7A\u95F4\uFF0C\u4F46 <code>Chart</code> \u8D44\u6E90\u5C06\u88AB\u90E8\u7F72\u5230 <code>monitoring</code> \u547D\u540D\u7A7A\u95F4\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> helm.cattle.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HelmChart
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">chart</span><span class="token punctuation">:</span> stable/grafana
  <span class="token key atrule">targetNamespace</span><span class="token punctuation">:</span> monitoring
  <span class="token key atrule">set</span><span class="token punctuation">:</span>
    <span class="token key atrule">adminPassword</span><span class="token punctuation">:</span> <span class="token string">&quot;NotVerySafePassword&quot;</span>
  <span class="token key atrule">valuesContent</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span>
      <span class="token key atrule">tag</span><span class="token punctuation">:</span> master
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token key atrule">GF_EXPLORE_ENABLED</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">adminUser</span><span class="token punctuation">:</span> admin
    <span class="token key atrule">sidecar</span><span class="token punctuation">:</span>
      <span class="token key atrule">datasources</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="k3s-\u9AD8\u7EA7\u9009\u9879" tabindex="-1"><a class="header-anchor" href="#k3s-\u9AD8\u7EA7\u9009\u9879" aria-hidden="true">#</a> K3s \u9AD8\u7EA7\u9009\u9879</h2><p><strong>\u8BC1\u4E66\u8F6E\u6362</strong></p><p>\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C<code>K3s</code> \u7684\u8BC1\u4E66\u5728 <code>12</code> \u4E2A\u6708\u5185\u8FC7\u671F\u3002\u5982\u679C\u8BC1\u4E66\u5DF2\u7ECF\u8FC7\u671F\u6216\u5269\u4F59\u7684\u65F6\u95F4\u4E0D\u8DB3 <code>90</code> \u5929\uFF0C\u5219\u5728 <code>K3s</code> \u91CD\u542F\u65F6\u8F6E\u6362\u8BC1\u4E66\u3002</p><p><strong>\u67E5\u8BE2 k3s \u8BC1\u4E66\u8FC7\u671F\u65F6\u95F4\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:/var/lib/rancher/k3s/server/manifests<span class="token comment">#  for i in \`ls /var/lib/rancher/k3s/server/tls/*.crt\`; \\</span>
<span class="token operator">&gt;</span>   <span class="token keyword">do</span> <span class="token punctuation">\\</span>
<span class="token operator">&gt;</span>     <span class="token builtin class-name">echo</span> <span class="token variable">$i</span><span class="token punctuation">;</span><span class="token punctuation">\\</span>
<span class="token operator">&gt;</span>     openssl x509 <span class="token parameter variable">-enddate</span> <span class="token parameter variable">-noout</span> <span class="token parameter variable">-in</span> <span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token punctuation">\\</span>
<span class="token operator">&gt;</span>   <span class="token keyword">done</span>
/var/lib/rancher/k3s/server/tls/client-admin.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
/var/lib/rancher/k3s/server/tls/client-ca.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">22</span> <span class="token number">14</span>:31:20 <span class="token number">2032</span> GMT
/var/lib/rancher/k3s/server/tls/client-controller.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
/var/lib/rancher/k3s/server/tls/client-k3s-cloud-controller.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
/var/lib/rancher/k3s/server/tls/client-k3s-controller.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
/var/lib/rancher/k3s/server/tls/client-kube-proxy.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
/var/lib/rancher/k3s/server/tls/client-scheduler.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
/var/lib/rancher/k3s/server/tls/request-header-ca.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">22</span> <span class="token number">14</span>:31:20 <span class="token number">2032</span> GMT
/var/lib/rancher/k3s/server/tls/server-ca.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">22</span> <span class="token number">14</span>:31:20 <span class="token number">2032</span> GMT
/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt
<span class="token assign-left variable">notAfter</span><span class="token operator">=</span>Nov <span class="token number">25</span> <span class="token number">14</span>:31:20 <span class="token number">2023</span> GMT
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u4FEE\u6539\u548C\u91CD\u542F\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u4FEE\u6539\u7CFB\u7EDF\u65F6\u95F4\u4E3A\u8BC1\u4E66\u8FC7\u671F\u524D90\u5929\u6216\u8BC1\u4E66\u8FC7\u671F\u540E</span>
timedatectl set-ntp no
<span class="token function">date</span> <span class="token parameter variable">-s</span> <span class="token number">20220807</span>

<span class="token comment"># \u91CD\u542FK3s\u670D\u52A1</span>
<span class="token function">service</span> k3s restart
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Red Hat \u548C CentOS \u7684\u989D\u5916\u51C6\u5907</strong></p><p>\u5EFA\u8BAE\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF0C\u5173\u95ED <code>firewalld</code> \u9632\u706B\u5899\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl disable firewalld <span class="token parameter variable">--now</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="\u6240\u9047\u5230\u7684\u95EE\u9898" tabindex="-1"><a class="header-anchor" href="#\u6240\u9047\u5230\u7684\u95EE\u9898" aria-hidden="true">#</a> \u6240\u9047\u5230\u7684\u95EE\u9898</h2><ul><li>\u5173\u4E8E k3s issue</li><li>\u5173\u4E8E \u8BA8\u8BBA</li></ul><div class="custom-container tip"><p class="custom-container-title">\u63D0\u793A</p><p>\u66F4\u591A\u7684\u8282\u70B9\u548C\u5B89\u88C5\u9009\u62E9\u95EE\u9898\u770B\u4E0B\u534A\u90E8\u5206\uFF08\u4E0B\u4E00\u8282\uFF09</p><blockquote><p>1.master\u8282\u70B9\u7684\u9632\u706B\u5899\u5168\u90E8\u5173\u6389\uFF0C\u8981\u4E0D\u7136worker\u53EF\u80FD\u8FDE\u4E0D\u4E0Amaster</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># systemctl stop firewalld &amp;&amp; systemctl disable firewalld &amp;&amp; iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>2.\u6709\u4E9B.worker\u53EF\u80FD\u8FDE\u4E0D\u4E0Amaster\uFF0C\u53EF\u80FD\u6709\u4E9Bworker\u7684iptables\u8868\u6DF7\u4E71\u4E86</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># systemctl stop k3s-agent
# systemctl stop docker
# iptables -F &amp;&amp; iptables -t nat -F  &amp;&amp; iptables -t mangle -F
# systemctl start docker
# systemctl stop k3s-agent
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>3.\u6709\u4E9B\u4E3B\u673A\u65E0\u6CD5\u6839\u636E\u4E0A\u9762\u7684\u547D\u4EE4\u4E0B\u8F7Ddocker\uFF0C\u63D0\u793A\u8BC1\u4E66\u8FC7\u671F</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>adding repo from: https://mydream.ink/utils/container/docker-ce.repo
grabbing file https://mydream.ink/utils/container/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo
Could not fetch/save url https://mydream.ink/utils/container/docker-ce.repo to file /etc/yum.repos.d/docker-ce.repo: [Errno 14] curl#60 - &quot;Peer&#39;s Certificate has expired.&quot;

\u56E0\u4E3A\u8FD9\u4E9B\u4E3B\u673A\u7684\u65F6\u95F4\u4E0D\u6B63\u786E\uFF0C\u7528ntp\u540C\u6B65\u65F6\u95F4\u5373\u53EF
# \u5B89\u88C5ntp\u670D\u52A1\u5668
# yum install -y ntp
# \u4E0E\u4E00\u4E2A\u5DF2\u77E5\u7684\u65F6\u95F4\u670D\u52A1\u5668\u540C\u6B65
# ntpdate time.nist.gov
# \u5220\u9664\u672C\u5730\u65F6\u95F4\u5E76\u8BBE\u7F6E\u65F6\u533A\u4E3A\u4E0A\u6D77
# rm -rf /etc/localtime
# ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>4.master \u914D\u7F6E --write-kubeconfig</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>--write-kubeconfig ~/.kube/config\u6548\u679C\u4E3A\u5C06\u914D\u7F6E\u6587\u4EF6\u5199\u5230k8s\u9ED8\u8BA4\u4F1A\u7528\u7684\u4F4D\u7F6E\uFF0C\u800C\u4E0D\u662Fk3s\u9ED8\u8BA4\u7684\u4F4D\u7F6E/etc/rancher/k3s/k3s.yaml\u3002\u540E\u8005\u4F1A\u5BFC\u81F4istio\u3001helm\u9700\u8981\u989D\u5916\u8BBE\u7F6E\u6216\u65E0\u6CD5\u8FD0\u884C\u3002
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>5.\u547D\u4EE4\u8865\u5168</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># yum install -y bash-completion
# source /usr/share/bash-completion/bash_completion
# source &lt;(kubectl completion bash)
# echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>6.\u63D0\u793A\u9700\u8981\u5B89\u88C5\u76F8\u5173\u8F6F\u4EF6\uFF0C\u6839\u636E\u63D0\u793A\u8FDB\u884C\u5B89\u88C5</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># yum install -y k3s-selinux-0.1.1-rc1.el7.noarch.rpm
# yum install -y container-selinux selinux-policy-base
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div><h2 id="end-\u94FE\u63A5" tabindex="-1"><a class="header-anchor" href="#end-\u94FE\u63A5" aria-hidden="true">#</a> END \u94FE\u63A5</h2>`,121),za={class:"custom-container tip"},Qa=i('<p class="custom-container-title">about k3s</p><ul><li><p>K3s \u4E2D\u6587\u6587\u6863 - \u56FD\u5916\uFF1Ahttps://mirror.rancher.cn/</p></li><li><p>K3s \u4E2D\u6587\u6587\u6863 - \u56FD\u5185\uFF1Ahttps://docs.rancher.cn/k3s/</p></li><li><p>K3s \u56FD\u5185\u955C\u50CF\u7AD9 - \u52A0\u901F\uFF1Ahttps://mirror.rancher.cn/</p></li><li><p>K3s \u7CFB\u5217\u6559\u7A0B - \u5B98\u65B9\u5236\u4F5C\uFF1Ahttps://github.com/kingsd041/k3s-tutorial</p></li></ul><p><strong>\u4EE3\u7801\u5730\u5740\uFF1A</strong></p><ul><li>K3s \u4ED3\u5E93\u5730\u5740 - Github\uFF1Ahttps://github.com/k3s-io</li></ul><p><strong>\u6269\u5C55(k3d)\uFF1A</strong></p>',5),ja={href:"https://github.com/inercia/vscode-k3d/",target:"_blank",rel:"noopener noreferrer"},Za=n("vscode-k3d"),Ya=n("\uFF1AVSCode \u6269\u5C55\uFF0C\u7528\u4E8E\u5904\u7406 VSCode \u4E2D\u7684 k3d \u96C6\u7FA4"),Ja={href:"https://github.com/inercia/k3x",target:"_blank",rel:"noopener noreferrer"},st=n("k3x"),nt=n("\uFF1Ak3d \u7684\u56FE\u5F62\u63A5\u53E3\uFF08\u7528\u4E8E Linux\uFF09\u3002"),et={href:"https://github.com/AbsaOSS/k3d-action",target:"_blank",rel:"noopener noreferrer"},at=n("AbsaOSS/k3d-action"),tt=n("\uFF1A\u5B8C\u5168\u53EF\u5B9A\u5236\u7684 GitHub Action \u6765\u8FD0\u884C\u8F7B\u91CF\u7EA7 Kubernetes \u96C6\u7FA4\u3002"),lt={href:"https://github.com/cnrancher/autok3s",target:"_blank",rel:"noopener noreferrer"},it=n("AutoK3s"),ot=n("\uFF1A\u4E00\u4E2A\u8F7B\u91CF\u7EA7\u5DE5\u5177\uFF0C\u53EF\u4EE5\u5E2E\u52A9\u5728\u4EFB\u4F55\u5730\u65B9\u8FD0\u884C K3s\uFF0C\u5305\u62EC k3d provider\u3002"),ct={href:"https://github.com/nolar/setup-k3d-k3s",target:"_blank",rel:"noopener noreferrer"},rt=n("nolar/setup-k3d-k3s"),dt=n("\uFF1A\u4E3A GitHub Actions \u8BBE\u7F6E K3d/K3s\u3002"),pt=s("p",null,[s("strong",null,"\u5468\u8FB9\u9879\u76EE\uFF1A")],-1),ut=i("<li><p><strong>K3s \u5468\u8FB9\u9879\u76EE - k3os</strong>\uFF1Ahttps://github.com/rancher/k3os</p><p>\u5B8C\u5168\u57FA\u4E8E <code>K8S</code> \u7BA1\u7406\u7684\u8F7B\u91CF\u7EA7\u64CD\u4F5C\u7CFB\u7EDF</p></li><li><p><strong>K3s \u5468\u8FB9\u9879\u76EE - autok3s</strong>\uFF1Ahttps://github.com/cnrancher/autok3s</p><p>\u7528\u4E8E\u7B80\u5316 <code>K3s</code> \u96C6\u7FA4\u90E8\u7F72\u548C\u7BA1\u7406\u7684\u8F7B\u91CF\u7EA7\u5DE5\u5177</p><p>\u5373\u5728\u963F\u91CC\u4E91\u548C <code>aws</code> \u7B49\u4E91\u670D\u52A1\u5668\u4E0A\u9762\u90E8\u7F72 <code>k3s</code></p></li>",2),vt=s("p",null,[s("strong",null,"K3s \u5468\u8FB9\u9879\u76EE - k3d"),n("\uFF1Ahttps://github.com/cnrancher/autok3s")],-1),kt=n("\u53EF\u4EE5\u5728 "),mt=s("code",null,"k3d",-1),bt=n(" \u521B\u5EFA\u5BB9\u5668\u5316\u7684 "),ht=s("code",null,"k3s",-1),gt=n(" \u96C6\u7FA4 k3d \u662F\u4E00\u4E2A\u8F7B\u91CF\u7EA7\u5305\u88C5\u5668\uFF0C\u7528\u4E8E\u5728 docker \u4E2D\u8FD0\u884C"),ft={href:"https://github.com/rancher/k3s",target:"_blank",rel:"noopener noreferrer"},_t=n("k3s"),yt=n("\uFF08Rancher Lab \u7684\u6700\u5C0F Kubernetes \u53D1\u884C\u7248\uFF09"),xt=s("p",null,[n("\u53EF\u4EE5\u4F7F\u7528\u5BB9\u5668\u5728\u5355\u53F0\u8BA1\u7B97\u673A\u4E0A\u542F\u52A8\u591A\u8282\u70B9 "),s("code",null,"k3s"),n(" \u96C6\u7FA4")],-1),Kt=i("<li><p><strong>K3s \u5468\u8FB9\u9879\u76EE - harvester</strong>\uFF1Ahttps://github.com/harvester/harvester</p><p>\u57FA\u4E8E <code>K8S</code> \u6784\u5EFA\u7684\u5F00\u6E90\u8D85\u878D\u5408\u57FA\u7840\u67B6\u6784(<code>HCI</code>)\u8F6F\u4EF6</p><p>\u65E8\u5728\u66FF\u6362 <code>vSphere</code> \u548C <code>Nutanix</code> \u7684\u5F00\u6E90\u66FF\u4EE3\u65B9\u6848</p></li><li><p><strong>K3s \u5468\u8FB9\u9879\u76EE - octopus</strong>\uFF1Ahttps://github.com/cnrancher/octopus</p><p>\u4E3B\u8981\u7528\u4E8E\u8FB9\u7F18\u8BA1\u7B97\u76F8\u5173</p><p>\u7528\u4E8E <code>K8S</code> \u548C <code>k3s</code> \u7684\u8F7B\u91CF\u7EA7\u4E91\u539F\u751F\u8BBE\u5907\u7BA1\u7406\u7CFB\u7EDF</p><p>\u96C6\u7FA4\u53EF\u4EE5\u5C06\u8FB9\u7F18\u8BBE\u5907\u4F5C\u4E3A\u81EA\u5B9A\u4E49 <code>k8s</code> \u8D44\u6E90\u8FDB\u884C\u7BA1\u7406</p></li>",2),St=s("p",null,[s("strong",null,"about\uFF1A")],-1),Lt=s("ul",null,[s("li",null,[s("div",null,[s("a",{href:"13.md",style:{float:"left"}},"\u2B06\uFE0F\u4E0A\u4E00\u8282\u{1F517} "),s("a",{href:"15.md",style:{float:"right"}}," \uFE0F\u4E0B\u4E00\u8282\u{1F517}")])])],-1),Et=n("\u24C2\uFE0F\u56DE\u5230\u76EE\u5F55\u{1F3E0}"),Nt={href:"https://nsddd.top/archives/contributors",target:"_blank",rel:"noopener noreferrer"},It=s("strong",null,"\u{1FAF5}\u53C2\u4E0E\u8D21\u732E\u{1F49E}\u2764\uFE0F\u200D\u{1F525}\u{1F496}",-1),qt=n(")"),At=n("\u2734\uFE0F\u7248\u6743\u58F0\u660E \xA9 \uFF1A\u672C\u4E66\u6240\u6709\u5185\u5BB9\u9075\u5FAA"),Ct={href:"http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC",target:"_blank",rel:"noopener noreferrer"},wt=n("CC-BY-SA 3.0\u534F\u8BAE\uFF08\u7F72\u540D-\u76F8\u540C\u65B9\u5F0F\u5171\u4EAB\uFF09\xA9");function Rt(Tt,Ot){const l=o("ExternalLinkIcon"),t=o("router-link"),c=o("CodeGroupItem"),r=o("CodeGroup"),d=o("RouterLink");return u(),v("div",null,[s("ul",null,[s("li",null,[s("a",m,[b,e(l)])])]),h,g,f,s("blockquote",null,[s("p",null,[_,s("a",y,[x,e(l)])])]),K,s("nav",S,[s("ul",null,[s("li",null,[e(t,{to:"#k3s\u4ECB\u7ECD"},{default:a(()=>[L]),_:1})]),s("li",null,[e(t,{to:"#k3s\u548Ck8s\u533A\u522B"},{default:a(()=>[E]),_:1})]),s("li",null,[e(t,{to:"#\u67B6\u6784"},{default:a(()=>[N]),_:1})]),s("li",null,[e(t,{to:"#sqlite-\u548C-dqlite"},{default:a(()=>[I]),_:1})]),s("li",null,[e(t,{to:"#\u65B0\u7248\u672C\u9ED8\u8BA4\u652F\u6301-etcd"},{default:a(()=>[q]),_:1})]),s("li",null,[e(t,{to:"#\u5728\u7EBF-docs-cloud-native-k8s-15-\u7B2C15\u8282-k3s-\u8865\u5145-\u811A\u672C\u5B89\u88C5-k3s"},{default:a(()=>[A]),_:1})]),s("li",null,[e(t,{to:"#\u5728\u7EBF\u5B89\u88C5\u7684\u89E3\u6790"},{default:a(()=>[C]),_:1}),s("ul",null,[s("li",null,[e(t,{to:"#\u5B89\u88C5\u5185\u5BB9"},{default:a(()=>[w]),_:1})]),s("li",null,[e(t,{to:"#\u6267\u884C\u64CD\u4F5C"},{default:a(()=>[R]),_:1})]),s("li",null,[e(t,{to:"#\u6307\u5B9A\u7248\u672C"},{default:a(()=>[T]),_:1})]),s("li",null,[e(t,{to:"#\u6307\u5B9A\u6570\u636E\u5E93"},{default:a(()=>[O]),_:1})]),s("li",null,[e(t,{to:"#\u6307\u5B9A\u5BB9\u5668\u8FD0\u884C\u65F6"},{default:a(()=>[P]),_:1})])])]),s("li",null,[e(t,{to:"#\u79BB\u7EBF\u5B89\u88C5\u89E3\u91CA"},{default:a(()=>[M]),_:1}),s("ul",null,[s("li",null,[e(t,{to:"#\u6B65\u9AA4"},{default:a(()=>[F]),_:1})]),s("li",null,[e(t,{to:"#\u524D\u63D0\u6761\u4EF6"},{default:a(()=>[D]),_:1})]),s("li",null,[e(t,{to:"#containerd-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F"},{default:a(()=>[B]),_:1})]),s("li",null,[e(t,{to:"#docker-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F"},{default:a(()=>[U]),_:1})]),s("li",null,[e(t,{to:"#containerd-\u624B\u52A8\u90E8\u7F72\u955C\u50CF\u65B9\u5F0F-1"},{default:a(()=>[G]),_:1})]),s("li",null,[e(t,{to:"#containerd-\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F"},{default:a(()=>[H]),_:1})]),s("li",null,[e(t,{to:"#docker-\u79C1\u6709\u955C\u50CF\u4ED3\u5E93\u65B9\u5F0F"},{default:a(()=>[V]),_:1})]),s("li",null,[e(t,{to:"#\u5355\u7ED3\u70B9\u9AD8\u53EF\u7528\u79BB\u7EBF\u5B89\u88C5"},{default:a(()=>[$]),_:1})])])]),s("li",null,[e(t,{to:"#\u4E3Akubelet-\u8BBE\u7F6E\u522B\u540D"},{default:a(()=>[X]),_:1})]),s("li",null,[e(t,{to:"#\u6269\u5C55work\u8282\u70B9"},{default:a(()=>[W]),_:1})]),s("li",null,[e(t,{to:"#cri-cni-csi"},{default:a(()=>[z]),_:1})]),s("li",null,[e(t,{to:"#\u5D4C\u5165\u5F0F\u6570\u636E\u5E93\u9AD8\u53EF\u7528"},{default:a(()=>[Q]),_:1})]),s("li",null,[e(t,{to:"#ha-\u90E8\u7F72\u5B9E\u9A8C"},{default:a(()=>[j]),_:1})]),s("li",null,[e(t,{to:"#\u5378\u8F7Dk3s"},{default:a(()=>[Z]),_:1}),s("ul",null,[s("li",null,[e(t,{to:"#\u9488\u5BF9-docker-cri"},{default:a(()=>[Y]),_:1})])])]),s("li",null,[e(t,{to:"#k3s-\u7684\u4E00\u4E9B\u91CD\u8981\u76EE\u5F55"},{default:a(()=>[J]),_:1}),s("ul",null,[s("li",null,[e(t,{to:"#var-lib-rancher-k3s"},{default:a(()=>[ss]),_:1})]),s("li",null,[e(t,{to:"#etc-rancher"},{default:a(()=>[ns]),_:1})]),s("li",null,[e(t,{to:"#var-run"},{default:a(()=>[es]),_:1})])])]),s("li",null,[e(t,{to:"#\u955C\u50CF\u52A0\u901F"},{default:a(()=>[as]),_:1})]),s("li",null,[e(t,{to:"#containerd"},{default:a(()=>[ts]),_:1}),s("ul",null,[s("li",null,[e(t,{to:"#\u67B6\u6784\u56FE"},{default:a(()=>[ls]),_:1})]),s("li",null,[e(t,{to:"#\u547D\u4EE4"},{default:a(()=>[is]),_:1})]),s("li",null,[e(t,{to:"#containerd\u7684\u914D\u7F6E\u7BA1\u7406"},{default:a(()=>[os]),_:1})])])]),s("li",null,[e(t,{to:"#\u4E8C\u8FDB\u5236\u5DE5\u5177"},{default:a(()=>[cs]),_:1})]),s("li",null,[e(t,{to:"#\u8FB9\u7F18\u8BA1\u7B97"},{default:a(()=>[rs]),_:1})]),s("li",null,[e(t,{to:"#\u5355\u8282\u70B9-sqlite-\u6269\u5C55\u4E3A-etcd-\u9AD8\u53EF\u7528"},{default:a(()=>[ds]),_:1})]),s("li",null,[e(t,{to:"#\u5B89\u88C5\u811A\u672C"},{default:a(()=>[ps]),_:1}),s("ul",null,[s("li",null,[e(t,{to:"#\u7406\u89E3\u5B89\u88C5\u7684\u6B65\u9AA4"},{default:a(()=>[us]),_:1})]),s("li",null,[e(t,{to:"#\u6807\u5FD7\u548C\u73AF\u5883\u53D8\u91CF"},{default:a(()=>[vs]),_:1})]),s("li",null,[e(t,{to:"#k3s-server-agent-\u5E38\u7528\u914D\u7F6E"},{default:a(()=>[ks]),_:1})]),s("li",null,[e(t,{to:"#k3s-server-agent-\u6570\u636E\u5E93\u9009\u9879"},{default:a(()=>[ms]),_:1})]),s("li",null,[e(t,{to:"#k3s-\u5B89\u88C5\u4E8B\u9879-\u7F51\u7EDC\u9009\u9879"},{default:a(()=>[bs]),_:1})]),s("li",null,[e(t,{to:"#\u5916\u90E8\u6570\u636E\u5E93"},{default:a(()=>[hs]),_:1})]),s("li",null,[e(t,{to:"#\u96C6\u7FA4\u6570\u636E\u5B58\u50A8\u9009\u9879"},{default:a(()=>[gs]),_:1})])])]),s("li",null,[e(t,{to:"#\u79C1\u6709\u955C\u50CF\u4ED3\u5E93"},{default:a(()=>[fs]),_:1})]),s("li",null,[e(t,{to:"#\u5B89\u88C5\u4E8B\u9879-\u6CE8\u610F\u4E8B\u9879"},{default:a(()=>[_s]),_:1})]),s("li",null,[e(t,{to:"#k3s-\u96C6\u7FA4\u5347\u7EA7"},{default:a(()=>[ys]),_:1})]),s("li",null,[e(t,{to:"#k3s-\u5907\u4EFD\u6062\u590D"},{default:a(()=>[xs]),_:1})]),s("li",null,[e(t,{to:"#k3s-\u5377\u548C\u5B58\u50A8"},{default:a(()=>[Ks]),_:1})]),s("li",null,[e(t,{to:"#k3s-\u7F51\u7EDC\u76F8\u5173"},{default:a(()=>[Ss]),_:1})]),s("li",null,[e(t,{to:"#helm-k3s"},{default:a(()=>[Ls]),_:1})]),s("li",null,[e(t,{to:"#k3s-\u9AD8\u7EA7\u9009\u9879"},{default:a(()=>[Es]),_:1})]),s("li",null,[e(t,{to:"#\u6240\u9047\u5230\u7684\u95EE\u9898"},{default:a(()=>[Ns]),_:1})]),s("li",null,[e(t,{to:"#end-\u94FE\u63A5"},{default:a(()=>[Is]),_:1})])])]),qs,As,s("div",Cs,[ws,Rs,s("ul",null,[s("li",null,[s("a",Ts,[Os,e(l)])]),s("li",null,[s("a",Ps,[Ms,e(l)])]),s("li",null,[s("a",Fs,[Ds,e(l)])])]),Bs]),Us,s("details",Gs,[Hs,s("p",null,[Vs,$s,Xs,s("a",Ws,[zs,e(l)]),Qs])]),js,s("p",null,[Zs,s("a",Ys,[Js,e(l)])]),sn,s("div",nn,[en,s("ul",null,[s("li",null,[s("a",an,[tn,e(l)])]),s("li",null,[s("a",ln,[on,e(l)])]),s("li",null,[s("a",cn,[rn,e(l)])]),s("li",null,[s("a",dn,[pn,e(l)])]),s("li",null,[s("a",un,[vn,e(l)])])]),kn,s("ul",null,[s("li",null,[s("a",mn,[bn,e(l)])])]),hn]),gn,s("div",fn,[_n,s("blockquote",null,[s("p",null,[s("strong",null,[yn,s("a",xn,[Kn,e(l)]),Sn])]),Ln])]),En,s("ol",null,[s("li",null,[s("p",null,[Nn,s("a",In,[qn,e(l)]),An,Cn,wn])]),Rn,s("li",null,[s("p",null,[Tn,On,Pn,s("a",Mn,[Fn,e(l)]),Dn])])]),Bn,s("ul",null,[s("li",null,[Un,s("a",Gn,[Hn,e(l)]),Vn,s("a",$n,[Xn,e(l)]),Wn]),s("li",null,[zn,s("a",Qn,[jn,e(l)]),Zn,Yn,Jn]),s("li",null,[se,s("a",ne,[ee,e(l)]),ae,te,le])]),ie,s("details",oe,[ce,s("p",null,[re,s("a",de,[pe,e(l)]),ue]),ve]),ke,s("p",null,[s("strong",null,[me,s("a",be,[he,e(l)]),ge])]),e(r,null,{default:a(()=>[e(c,{title:"\u5355\u7ED3\u70B9\u5B89\u88C5"},{default:a(()=>[fe,_e,ye]),_:1}),e(c,{title:"\u9AD8\u53EF\u7528\u5B89\u88C5"},{default:a(()=>[xe,Ke,Se,Le]),_:1})]),_:1}),Ee,s("p",null,[Ne,s("a",Ie,[qe,e(l)]),Ae]),Ce,s("ul",null,[we,Re,s("li",null,[s("a",Te,[Oe,e(l)]),Pe,Me,Fe])]),De,s("ul",null,[s("li",null,[s("a",Be,[Ue,e(l)])])]),Ge,e(r,null,{default:a(()=>[e(c,{title:"server\u7ED3\u70B9"},{default:a(()=>[He]),_:1}),e(c,{title:"agent\u7ED3\u70B9"},{default:a(()=>[Ve]),_:1})]),_:1}),$e,s("div",Xe,[We,s("ul",null,[s("li",null,[s("p",null,[ze,Qe,je,Ze,s("a",Ye,[Je,e(l)]),sa]),na]),ea])]),aa,s("ul",null,[s("li",null,[s("a",ta,[la,e(l)])])]),ia,s("table",null,[oa,s("tbody",null,[ca,ra,s("tr",null,[da,s("td",null,[pa,s("a",ua,[va,e(l)]),ka,ma,ba,ha,ga])]),s("tr",null,[fa,s("td",null,[_a,s("a",ya,[xa,e(l)]),Ka])]),s("tr",null,[Sa,s("td",null,[La,s("a",Ea,[Na,e(l)]),Ia])]),s("tr",null,[qa,s("td",null,[Aa,s("a",Ca,[wa,e(l)]),Ra])]),s("tr",null,[Ta,s("td",null,[Oa,s("a",Pa,[Ma,e(l)]),Fa])]),Da,Ba,Ua])]),Ga,s("ul",null,[s("li",null,[s("a",Ha,[Va,e(l)])]),s("li",null,[s("a",$a,[Xa,e(l)])])]),Wa,s("div",za,[Qa,s("ul",null,[s("li",null,[s("a",ja,[Za,e(l)]),Ya]),s("li",null,[s("a",Ja,[st,e(l)]),nt]),s("li",null,[s("a",et,[at,e(l)]),tt]),s("li",null,[s("a",lt,[it,e(l)]),ot]),s("li",null,[s("a",ct,[rt,e(l)]),dt])]),pt,s("ul",null,[ut,s("li",null,[vt,s("p",null,[kt,mt,bt,ht,gt,s("a",ft,[_t,e(l)]),yt]),xt]),Kt])]),St,Lt,s("ul",null,[s("li",null,[s("p",null,[e(d,{to:"/"},{default:a(()=>[Et]),_:1})])]),s("li",null,[s("p",null,[s("a",Nt,[It,e(l)]),qt])]),s("li",null,[s("p",null,[At,s("a",Ct,[wt,e(l)])])])])])}const Mt=p(k,[["render",Rt],["__file","14.html.vue"]]);export{Mt as default};
