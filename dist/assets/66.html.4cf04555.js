import{_ as c,r as o,o as i,c as l,a as n,b as a,w as u,e as s,d as t}from"./app.df617644.js";const r={},d={href:"http://nsddd.top",target:"_blank",rel:"noopener noreferrer"},k=s("author"),m=n("h1",{id:"\u7B2C66\u8282-kubernetes-\u4E8C\u6B21\u5F00\u53D1-crd-\u5B66\u4E60",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u7B2C66\u8282-kubernetes-\u4E8C\u6B21\u5F00\u53D1-crd-\u5B66\u4E60","aria-hidden":"true"},"#"),s(" \u7B2C66\u8282 Kubernetes \u4E8C\u6B21\u5F00\u53D1 CRD \u5B66\u4E60")],-1),v=n("div",null,[n("a",{href:"65.md",style:{float:"left"}},"\u2B06\uFE0F\u4E0A\u4E00\u8282\u{1F517} "),n("a",{href:"67.md",style:{float:"right"}}," \u2B07\uFE0F\u4E0B\u4E00\u8282\u{1F517}")],-1),b=n("br",null,null,-1),g=s("\u2764\uFE0F\u{1F495}\u{1F495}\u65B0\u65F6\u4EE3\u62E5\u62B1\u4E91\u539F\u751F\uFF0C\u4E91\u539F\u751F\u5177\u6709\u73AF\u5883\u7EDF\u4E00\u3001\u6309\u9700\u4ED8\u8D39\u3001\u5373\u5F00\u5373\u7528\u3001\u7A33\u5B9A\u6027\u5F3A\u7279\u70B9\u3002Myblog:"),h={href:"http://nsddd.top/",target:"_blank",rel:"noopener noreferrer"},f=s("http://nsddd.top"),y=n("hr",null,null,-1),q=n("p",null,"[TOC]",-1),w=n("h2",{id:"\u524D\u8A00",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u524D\u8A00","aria-hidden":"true"},"#"),s(" \u524D\u8A00")],-1),C=n("p",null,"sealos \u4F7F\u7528\u4E86\u5927\u91CF\u7684 CRD \u5BF9\u5176\u6269\u5C55\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528 CRD \u6765 Kubernetes",-1),S={href:"https://github.com/kubernetes-sigs/kubebuilder",target:"_blank",rel:"noopener noreferrer"},x=s("kubebuilder"),_={href:"https://book.kubebuilder.io/",target:"_blank",rel:"noopener noreferrer"},R=s("\u5B98\u65B9\u5B66\u4E60\u6587\u6863"),I=s("\u9664\u6B64\u4E4B\u5916\uFF0C\u8FD9\u91CC\u6709\u4E00\u4EFD\u5B98\u65B9 CRD "),D={href:"https://github.com/kubernetes/sample-controller",target:"_blank",rel:"noopener noreferrer"},E=s("\u6848\u4F8B ~"),A=t(`<p>CRD\u662FKubernetes\u4E3A\u63D0\u9AD8\u53EF\u6269\u5C55\u6027\uFF0C\u8BA9\u5F00\u53D1\u8005\u53BB\u81EA\u5B9A\u4E49\u8D44\u6E90\uFF08\u5982Deployment\uFF0CStatefulSet\u7B49\uFF09\u7684\u4E00\u79CD\u65B9\u6CD5\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Operator=CRD+Controller
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>CRD\u4EC5\u4EC5\u662F\u8D44\u6E90\u7684\u5B9A\u4E49\uFF0C\u800CController\u53EF\u4EE5\u53BB\u76D1\u542CCRD\u7684CRUD\u4E8B\u4EF6\u6765\u6DFB\u52A0\u81EA\u5B9A\u4E49\u4E1A\u52A1\u903B\u8F91\u3002</p><p>\u5982\u679C\u8BF4\u53EA\u662F\u5BF9CRD\u5B9E\u4F8B\u8FDB\u884C <code>CRUD</code> \u7684\u8BDD\uFF0C\u4E0D\u9700\u8981 <code>Controller</code> \u4E5F\u662F\u53EF\u4EE5\u5B9E\u73B0\u7684\uFF0C\u53EA\u662F\u53EA\u6709\u6570\u636E\uFF0C\u6CA1\u6709\u9488\u5BF9\u6570\u636E\u7684\u64CD\u4F5C\u3002</p><p>\u5C31\u62FF\u5B98\u65B9\u7684 CRD \u6848\u4F8B\uFF08sample-controller\uFF09\u6765\u8BF4\uFF0C\u5982\u679C\u6CA1\u6709\u8FD0\u884C\u8FD9\u4E2A\u7A0B\u5E8F\uFF0C\u4E5F\u53EF\u4EE5\u4F7F\u7528 examples \u6848\u4F8B\u4E2D\u7684 yaml \u6587\u4EF6\uFF0C\u521B\u5EFA CRD\uFF0C\u4EE5\u53CA CR\u3002\u53EA\u4E0D\u8FC7\u6CA1\u6709\u529E\u6CD5\u9488\u5BF9 Pod \u548C deployment \u7B49 \u5185\u7F6E\u7684 API \u8D44\u6E90\u5BF9\u8C61\u8FDB\u884C CRUD \u64CD\u4F5C\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F k get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           9h
\u276F ./ctrl <span class="token parameter variable">-kubeconfig</span> ~/.kube/config  <span class="token parameter variable">-logtostderr</span><span class="token operator">=</span>true
\u276F k get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
example-foo        <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           4s
nginx-deployment   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           9h
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u9879\u76EE-demo" tabindex="-1"><a class="header-anchor" href="#\u9879\u76EE-demo" aria-hidden="true">#</a> \u9879\u76EE demo</h3>`,7),j=s("review\uFF1A"),O={href:"https://github.com/muzi502",target:"_blank",rel:"noopener noreferrer"},N=s("@muzi502"),F=s("author: "),T={href:"https://github.com/cubxxw",target:"_blank",rel:"noopener noreferrer"},P=s("@cubxxw"),G=s("\u8FD9\u7BC7\u6587\u7AE0\u5C06\u53C2\u8003\u5404\u4E2A\u535A\u5BA2\u548C kubebuilder \u5B98\u65B9\u6587\u6863 \u4EE5\u53CA "),B={href:"https://github.com/kubernetes/sample-controller",target:"_blank",rel:"noopener noreferrer"},L=s("kubernetes/sample-controller"),K=s(" \u8FDB\u884C\u5B66\u4E60\uFF0C\u6700\u540E\u5B9E\u8DF5\u4E00\u4E2A\u9879\u76EE\u7684\u6B65\u9AA4\uFF0C\u5BF9\u9759\u6001\u535A\u5BA2\uFF08"),J={href:"https://docker.nsddd.top/",target:"_blank",rel:"noopener noreferrer"},V=s("docker.nsddd.top"),M=s(" \u6216\u8005 "),H={href:"https://go.nsddd.top/",target:"_blank",rel:"noopener noreferrer"},U=s("go.nsddd.top"),W=s(") \u8FDB\u884C CRD\uFF0C\u5F62\u6210\u5B66\u4E60\u95ED\u73AF~"),z=n("ol",null,[n("li",null,"\u521B\u5EFA\u81EA\u5B9A\u4E49API\u5BF9\u8C61\uFF08Custom Resource Definition\uFF09\uFF0C\u540D\u4E3ABlog\uFF1B"),n("li",null,"\u7528\u4EE3\u7801\u751F\u6210\u5DE5\u5177\u751F\u6210informer\u548Cclient\u76F8\u5173\u4EE3\u7801\uFF1B"),n("li",null,'\u521B\u5EFA\u5E76\u8FD0\u884C\u81EA\u5B9A\u4E49\u63A7\u5236\u5668\uFF0Ck8s\u73AF\u5883\u4E2D\u6240\u6709 Blog \u76F8\u5173\u7684"\u589E\u3001\u5220\u3001\u6539"\u64CD\u4F5C\u90FD\u4F1A\u88AB\u6B64\u63A7\u5236\u5668\u76D1\u542C\u5230\uFF0C\u53EF\u4EE5\u6839\u636E\u5B9E\u9645\u9700\u6C42\u5728\u63A7\u5236\u5668\u4E2D\u7F16\u5199\u4E1A\u52A1\u4EE3\u7801\uFF1B')],-1),$=t(`<h3 id="operator-\u529F\u80FD\u8BBE\u8BA1" tabindex="-1"><a class="header-anchor" href="#operator-\u529F\u80FD\u8BBE\u8BA1" aria-hidden="true">#</a> Operator \u529F\u80FD\u8BBE\u8BA1</h3><p>\u501F\u52A9 Operator \u5B8C\u6210\u548C\u4F01\u4E1A\u5185\u90E8\u6CE8\u518C\u4E2D\u5FC3\u7684\u6253\u901A</p><p><strong>Operator \u5F00\u53D1 SDK \u6709 2 \u4E2A\u9009\u62E9\uFF1A</strong></p><ul><li>kubebuilder</li><li>operator sdk</li></ul><p>\u6CE8\u610F\uFF1A\u5728\u672C\u8D28\u4E0A\u5176\u5B9E\u90FD\u662F\u5728 K8s \u63A7\u5236\u5668\u8FD0\u884C\u65F6\u4E0A\u7684\u5C01\u88C5\uFF0C\u4E3B\u8981\u90FD\u662F\u811A\u624B\u67B6\u7684\u751F\u6210\uFF0C\u4F7F\u7528\u4F53\u9A8C\u76F8\u5DEE\u4E0D\u5927\u3002</p><p>\u4F46\u662F\u6709\u610F\u601D\u7684\u662F\uFF0CKubebuilder \u7684\u7EF4\u62A4\u65B9\u662F\uFF1Akubernetes-sigs\uFF0C\u6240\u4EE5\u66F4\u53D7\u4EBA\u5173\u6CE8\u3002</p><p>\u5E95\u5C42\u90FD\u662F\u57FA\u4E8E k8s \u63A7\u5236\u5668\u8FD0\u884C\u65F6\u5C01\u88C5\uFF0C\u4E0D\u540C\u7684\u662F kubebuilder \u65E9\u671F\u5305\u542B CRD\u548C \u81EA\u5B9A\u4E49 Controller \u5F00\u53D1\u3002\u4F46\u662F operator-sdk \u65E9\u671F\u4E0D\u5305\u542B CRD \u5F00\u53D1\uFF0C\u4F46\u662F\u73B0\u5728\u4E5F\u662F\u878D\u5408\u4E86\u3002</p><p><strong>CRD \u5141\u8BB8\u4F60\u5B9A\u4E49\u81EA\u5DF1\u7684 Kubernetes API \u5BF9\u8C61\uFF0C\u800C\u81EA\u5B9A\u4E49\u63A7\u5236\u5668\u53EF\u4EE5\u76D1\u542C\u8FD9\u4E9B\u5BF9\u8C61\u7684\u4E8B\u4EF6\u5E76\u6267\u884C\u76F8\u5E94\u7684\u64CD\u4F5C\u3002</strong></p><h3 id="kubebuilder-\u67B6\u6784\u56FE" tabindex="-1"><a class="header-anchor" href="#kubebuilder-\u67B6\u6784\u56FE" aria-hidden="true">#</a> kubebuilder \u67B6\u6784\u56FE</h3><p><strong>\u56FE\u7247\u6765\u81EA\u5B98\u7F51\u7AD9\uFF1A</strong></p><p><img src="http://sm.nsddd.top/sm202304081027380.png" alt="image-20230408102740099"></p><h2 id="installation-kubebuilder" tabindex="-1"><a class="header-anchor" href="#installation-kubebuilder" aria-hidden="true">#</a> installation kubebuilder</h2><p>\u5B89\u88C5kubebuilder\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token parameter variable">-o</span> kubebuilder https://go.kubebuilder.io/dl/latest/<span class="token variable"><span class="token variable">$(</span>go <span class="token function">env</span> GOOS<span class="token variable">)</span></span>/<span class="token variable"><span class="token variable">$(</span>go <span class="token function">env</span> GOARCH<span class="token variable">)</span></span>

\u276F <span class="token function">chmod</span> +x kubebuilder <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> kubebuilder /usr/local/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6216\u8005\uFF0C\u4F7F\u7528 <code>make build</code> \uFF0C \u8FD9\u662F\u6211\u5F88\u559C\u6B22\u7684\u4E00\u79CD\u65B9\u5F0F\uFF0C\u65B9\u4FBF\u8D21\u732E\u548C\u9605\u8BFB\u6E90\u7801\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBEBUILDER</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/kubebuilder
\u276F <span class="token function">git</span> clone https://github.com/kubernetes-sigs/kubebuilder.git <span class="token variable">$KUBEBUILDER</span>  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$KUBEBUILDER</span><span class="token punctuation">;</span> <span class="token function">make</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> bin<span class="token punctuation">;</span> ./kubebuilder<span class="token punctuation">;</span> 
\u276F <span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$KUBEBUILDER</span>/bin<span class="token punctuation">;</span> kubebuilder
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="create-a-project" tabindex="-1"><a class="header-anchor" href="#create-a-project" aria-hidden="true">#</a> create a project</h2><p>\u5F88\u7B80\u5355\u7684\u884C\u4E3A\uFF0C\u6211\u4EEC\u53EA\u9700\u8981\u521B\u5EFA\u4E00\u4E2A\u76EE\u5F55\uFF0C\u5E76\u4E14\u4F7F\u7528 \u547D\u4EE4 \u521D\u59CB\u5316\u5C31\u591F\u4E86\uFF0C\u5728\u5E95\u5C42\u4E0A kubebuilder \u5E76\u4E0D\u5E0C\u671B\u6211\u4EEC\u77E5\u9053\u5B9E\u73B0\u7684\u7EC6\u8282~</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">mkdir</span> /tmp/guestbook -p<span class="token punctuation">;</span> <span class="token builtin class-name">cd</span> /tmp/guestbook
\u276F kubebuilder init <span class="token parameter variable">--domain</span> my.domain <span class="token parameter variable">--repo</span> my.domain/guestbook
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u4E2A\u76EE\u5F55\u5C31\u662F\u5F88\u795E\u5947\u4E86\uFF0C\u5C31\u50CF\u4EE3\u7801\u751F\u6210\u5668\u4E00\u6837\u751F\u6210\u4E86\u4E00\u4E2A\u6A21\u677F\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F tree <span class="token parameter variable">-L</span> <span class="token number">3</span>
<span class="token builtin class-name">.</span>
\u251C\u2500\u2500 Dockerfile
\u251C\u2500\u2500 Makefile
\u251C\u2500\u2500 PROJECT
\u251C\u2500\u2500 README.md
\u251C\u2500\u2500 cmd
\u2502   \u2514\u2500\u2500 main.go
\u251C\u2500\u2500 config
\u2502   \u251C\u2500\u2500 default
\u2502   \u2502   \u251C\u2500\u2500 kustomization.yaml
\u2502   \u2502   \u251C\u2500\u2500 manager_auth_proxy_patch.yaml
\u2502   \u2502   \u2514\u2500\u2500 manager_config_patch.yaml
\u2502   \u251C\u2500\u2500 manager
\u2502   \u2502   \u251C\u2500\u2500 kustomization.yaml
\u2502   \u2502   \u2514\u2500\u2500 manager.yaml
\u2502   \u251C\u2500\u2500 prometheus
\u2502   \u2502   \u251C\u2500\u2500 kustomization.yaml
\u2502   \u2502   \u2514\u2500\u2500 monitor.yaml
\u2502   \u2514\u2500\u2500 rbac
\u2502       \u251C\u2500\u2500 auth_proxy_client_clusterrole.yaml
\u2502       \u251C\u2500\u2500 auth_proxy_role.yaml
\u2502       \u251C\u2500\u2500 auth_proxy_role_binding.yaml
\u2502       \u251C\u2500\u2500 auth_proxy_service.yaml
\u2502       \u251C\u2500\u2500 kustomization.yaml
\u2502       \u251C\u2500\u2500 leader_election_role.yaml
\u2502       \u251C\u2500\u2500 leader_election_role_binding.yaml
\u2502       \u251C\u2500\u2500 role_binding.yaml
\u2502       \u2514\u2500\u2500 service_account.yaml
\u251C\u2500\u2500 go.mod
\u251C\u2500\u2500 go.sum
\u2514\u2500\u2500 hack
    \u2514\u2500\u2500 boilerplate.go.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u8FD9\u91CC\u6211\u501F\u52A9\u300AKubernetes operator \u5F00\u53D1\u8FDB\u9636\u300B\u8FD9\u672C\u4E66\uFF08\u4F46\u4E0D\u63A8\u8350\uFF09\u90E8\u5206\u89E3\u91CA\uFF1A</p><ul><li><code>Dockerfile</code>: \u7528\u4E8E\u6784\u5EFA Docker \u955C\u50CF\u7684\u6587\u4EF6\u3002</li><li><code>Makefile</code>: \u4E00\u4E2A Makefile\uFF0C\u5176\u4E2D\u5305\u542B\u4E86\u7528\u4E8E\u6784\u5EFA\u548C\u53D1\u5E03 Operator \u7684\u5E38\u7528\u547D\u4EE4\u3002</li><li><code>PROJECT</code>: \u9879\u76EE\u540D\u79F0\uFF0C\u4EE5\u53CA\u9879\u76EE\u4FE1\u606F\uFF0C\u8FD9\u91CC\u662F\u4E00\u4E9B metadata \u3002</li><li><code>README.md</code>: \u9879\u76EE\u7684\u8BF4\u660E\u6587\u6863\u3002</li><li><code>cmd/</code>: \u5305\u542B\u4E86 Operator \u7684\u5165\u53E3\u7A0B\u5E8F <code>main.go</code>\u3002</li><li><code>config/</code>: \u5305\u542B\u4E86 Operator \u7684\u914D\u7F6E\u6587\u4EF6\uFF0C\u5305\u62EC RBAC \u6743\u9650\u76F8\u5173\u7684 YAML \u6587\u4EF6\u3001Prometheus \u76D1\u63A7\u670D\u52A1\u53D1\u73B0\uFF08ServiceMonitor\uFF09\u76F8\u5173\u7684 Yaml \u6587\u4EF6\u3001\u63A7\u5236\u5668\uFF08Manager\uFF09\u90E8\u5206\u90E8\u7F72\u7684 Yaml \u6587\u4EF6\u3002 <ul><li><code>default/</code>: \u5305\u542B\u4E86\u9ED8\u8BA4\u7684\u914D\u7F6E\u6587\u4EF6\u3002 <ul><li><code>kustomization.yaml</code>: Kustomize \u914D\u7F6E\u6587\u4EF6\uFF0C\u6307\u5B9A\u4E86\u9700\u8981\u5E94\u7528\u7684 k8s \u8D44\u6E90\u7C7B\u578B\u548C\u540D\u79F0\u3002</li><li><code>manager_auth_proxy_patch.yaml</code>: \u5728 manager \u5BB9\u5668\u4E2D\u6DFB\u52A0\u4E86 auth-proxy \u5BB9\u5668\u7684\u76F8\u5173\u4FE1\u606F\u3002</li><li><code>manager_config_patch.yaml</code>: \u5728 manager \u5BB9\u5668\u4E2D\u6DFB\u52A0\u4E86\u4E0E Operator \u76F8\u5173\u7684\u914D\u7F6E\u4FE1\u606F\u3002</li></ul></li><li><code>manager/</code>: \u5305\u542B\u4E86\u90E8\u7F72 Operator \u6240\u9700\u7684 k8s \u8D44\u6E90\u6587\u4EF6\u3002 <ul><li><code>kustomization.yaml</code>: Kustomize \u914D\u7F6E\u6587\u4EF6\uFF0C\u6307\u5B9A\u4E86\u9700\u8981\u5E94\u7528\u7684 k8s \u8D44\u6E90\u7C7B\u578B\u548C\u540D\u79F0\u3002</li><li><code>manager.yaml</code>: \u90E8\u7F72 Operator \u6240\u9700\u7684 k8s \u8D44\u6E90\u6587\u4EF6\u3002</li></ul></li><li><code>prometheus/</code>: \u5305\u542B\u4E86 Prometheus \u76D1\u63A7 Operator \u6240\u9700\u7684 k8s \u8D44\u6E90\u6587\u4EF6\u3002 <ul><li><code>kustomization.yaml</code>: Kustomize \u914D\u7F6E\u6587\u4EF6\uFF0C\u6307\u5B9A\u4E86\u9700\u8981\u5E94\u7528\u7684 k8s \u8D44\u6E90\u7C7B\u578B\u548C\u540D\u79F0\u3002</li><li><code>monitor.yaml</code>: \u90E8\u7F72 Prometheus \u76D1\u63A7 Operator \u6240\u9700\u7684 k8s \u8D44\u6E90\u6587\u4EF6\u3002</li></ul></li><li><code>rbac/</code>: \u5305\u542B\u4E86 Operator \u6240\u9700\u7684 RBAC \u8D44\u6E90\u6587\u4EF6\u3002 <ul><li><code>auth_proxy_client_clusterrole.yaml</code>: \u914D\u7F6E\u4E86\u4E0E\u5BA2\u6237\u7AEF\u6388\u6743\u76F8\u5173\u7684 ClusterRole\u3002</li><li><code>auth_proxy_role.yaml</code>: \u914D\u7F6E\u4E86\u4E0E auth-proxy \u76F8\u5173\u7684 Role\u3002</li><li><code>auth_proxy_role_binding.yaml</code>: \u914D\u7F6E\u4E86\u4E0E auth-proxy \u76F8\u5173\u7684 RoleBinding\u3002</li><li><code>auth_proxy_service.yaml</code>: \u914D\u7F6E\u4E86\u4E0E auth-proxy \u76F8\u5173\u7684 Service\u3002</li><li><code>kustomization.yaml</code>: Kustomize \u914D\u7F6E\u6587\u4EF6\uFF0C\u6307\u5B9A\u4E86\u9700\u8981\u5E94\u7528\u7684 k8s \u8D44\u6E90\u7C7B\u578B\u548C\u540D\u79F0\u3002</li><li><code>leader_election_role.yaml</code>: \u914D\u7F6E\u4E86\u4E0E leader election \u76F8\u5173\u7684 Role\u3002</li><li><code>leader_election_role_binding.yaml</code>: \u914D\u7F6E\u4E86\u4E0E leader election \u76F8\u5173\u7684 RoleBinding\u3002</li><li><code>role_binding.yaml</code>: \u914D\u7F6E\u4E86\u4E0E Operator \u76F8\u5173\u7684 RoleBinding\u3002</li><li><code>service_account.yaml</code>: \u914D\u7F6E\u4E86\u4E0E Operator \u76F8\u5173\u7684 ServiceAccount\u3002</li></ul></li></ul></li><li><code>go.mod</code>: Go \u9879\u76EE\u7684\u6A21\u5757\u6587\u4EF6\u3002</li><li><code>go.sum</code>: Go \u9879\u76EE\u7684\u6A21\u5757\u4F9D\u8D56\u6587\u4EF6\u3002</li><li><code>hack/</code>: \u5305\u542B\u4E86\u751F\u6210\u4EE3\u7801\u548C\u6587\u6863\u7B49\u76F8\u5173\u7684\u811A\u672C\u548C\u6587\u4EF6\u3002 <ul><li><code>boilerplate.go.txt</code>: \u7528\u4E8E\u751F\u6210 Go \u9879\u76EE\u6587\u4EF6\u7684\u4EE3\u7801\u6A21\u677F\u3002</li></ul></li></ul><p>\u4E3A\u4E86\u65B9\u4FBF\u6211\u4EEC\u540E\u9762\u7684\u5B66\u4E60\uFF0C\u6211\u8FD9\u91CC\u7528 git \u8FDB\u884C\u7248\u672C\u63A7\u5236\uFF0C\u65B9\u4FBF\u89C2\u5BDF\u540E\u9762\u751F\u6210\u4E86\u54EA\u4E9B\u6587\u4EF6</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u276F git add .
\u276F git commit -a -s -m &quot;kubebuilder init&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="create-an-api" tabindex="-1"><a class="header-anchor" href="#create-an-api" aria-hidden="true">#</a> create an API</h2><p>\u8FD0\u884C\u4EE5\u4E0B\u547D\u4EE4\uFF0C\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684API\uFF08\u7EC4/\u7248\u672C\uFF09\u4E3A <code>webapp/v1</code> \uFF0C\u5E76\u5728\u5176\u4E0A\u521B\u5EFA\u65B0\u7684Kind\uFF08CRD\uFF09 <code>Guestbook</code> \uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F kubebuilder create api <span class="token parameter variable">--group</span> webapp <span class="token parameter variable">--version</span> v1 <span class="token parameter variable">--kind</span> Guestbook
Create Resource <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span>
y
Create Controller <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span>
y
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u{1F4DC} \u5BF9\u4E0A\u9762\u7684\u89E3\u91CA\uFF1A</p><blockquote><p>\u5982\u679C\u4F60\u6309\u4E0B <code>y</code> \u521B\u5EFA\u8D44\u6E90[y/n]\u548C\u521B\u5EFA\u63A7\u5236\u5668[y/n]\uFF0C\u5219\u8FD9\u5C06\u521B\u5EFA\u6587\u4EF6 <code>api/v1/guestbook_types.go</code> \uFF08\u5176\u4E2D\u5B9A\u4E49\u4E86API\uFF09\u548C <code>controllers/guestbook_controller.go</code> \uFF08\u5176\u4E2D\u5B9E\u73B0\u4E86\u6B64\u7C7B\uFF08CRD\uFF09\u7684\u534F\u8C03\u4E1A\u52A1\u903B\u8F91\uFF09\u3002</p></blockquote><p>\u8FD9\u4E2A\u65F6\u5019 kubebuilder \u53C8\u5077\u5077\u7684\u505A\u4E86\u4EC0\u4E48\uFF1F\u6211\u4EEC\u770B\u4E00\u4E0B git \u7684\u53D8\u52A8\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">git</span> status
On branch master
Changes not staged <span class="token keyword">for</span> commit:
  <span class="token punctuation">(</span>use <span class="token string">&quot;git add &lt;file&gt;...&quot;</span> to update what will be committed<span class="token punctuation">)</span>
  <span class="token punctuation">(</span>use <span class="token string">&quot;git restore &lt;file&gt;...&quot;</span> to discard changes <span class="token keyword">in</span> working directory<span class="token punctuation">)</span>
        modified:   PROJECT
        modified:   cmd/main.go
        modified:   go.mod
        modified:   go.sum

Untracked files:
  <span class="token punctuation">(</span>use <span class="token string">&quot;git add &lt;file&gt;...&quot;</span> to include <span class="token keyword">in</span> what will be committed<span class="token punctuation">)</span>
        api/
        config/crd/
        config/rbac/guestbook_editor_role.yaml
        config/rbac/guestbook_viewer_role.yaml
        config/samples/
        internal/

no changes added to commit <span class="token punctuation">(</span>use <span class="token string">&quot;git add&quot;</span> and/or <span class="token string">&quot;git commit -a&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u65B0\u589E\u76EE\u5F55\uFF1A</p><ul><li><code>api</code>\uFF1A\u5305\u542B\u521A\u521A\u6DFB\u52A0\u7684 API\uFF0C\u540E\u9762\u4F1A\u7ECF\u5E38\u7F16\u8F91\u8FD9\u91CC\u7684 <code>guestbook_types.go</code> \u6587\u4EF6\u3002\u8FD9\u4E2A\u6587\u4EF6\u662F CRD \u4EE3\u7801\u7684\u4E3B\u8981\u5B9A\u4E49\u6587\u4EF6\u3002</li><li><code>config/crd</code>\uFF1A\u5B58\u653E\u7684\u662F crd \u90E8\u7F72\u76F8\u5173\u7684 kustomize \u6587\u4EF6\u3002</li><li><code>config/rbac/</code>\uFF1A\u5206\u522B\u662F\u7F16\u8F91\u6743\u9650\u548C\u67E5\u8BE2\u6743\u9650\u7684 <code>ClusterRole</code></li><li><code>samples</code>\uFF1A\u5F88\u597D\u7406\u89E3\uFF0CCR \u793A\u4F8B\u6587\u4EF6</li><li><code>internal</code> \uFF1A\u5F88\u597D\u7406\u89E3\uFF0C\u5185\u90E8\u6838\u5FC3\u4EE3\u7801\uFF0C\u6211\u4EEC\u6253\u5F00\u770B\u770B <code>controllers</code></li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>\u276F cat internal<span class="token operator">/</span>controller<span class="token operator">/</span>guestbook_controller<span class="token punctuation">.</span><span class="token keyword">go</span>

<span class="token keyword">package</span> controller
<span class="token comment">//...</span>
<span class="token comment">// GuestbookReconciler reconciles a Guestbook object</span>
<span class="token keyword">type</span> GuestbookReconciler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span>Client
        Scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme
<span class="token punctuation">}</span>
<span class="token comment">//...</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>GuestbookReconciler<span class="token punctuation">)</span> <span class="token function">Reconcile</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req ctrl<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

        <span class="token comment">// TODO(user): your logic here</span>

        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// SetupWithManager sets up the controller with the Manager.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>GuestbookReconciler<span class="token punctuation">)</span> <span class="token function">SetupWithManager</span><span class="token punctuation">(</span>mgr ctrl<span class="token punctuation">.</span>Manager<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span><span class="token function">NewControllerManagedBy</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">For</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>webappv1<span class="token punctuation">.</span>Guestbook<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">Complete</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F88\u660E\u663E\uFF0C\u4E0A\u9762\u7684 Reconcile \u51FD\u6570\u662F\u4E00\u4E2A\u8C03\u8C10\u51FD\u6570\uFF0C\u8FD9\u662F\u8D2F\u7A7F\u59CB\u7EC8\u7684\u4E00\u4E2A\u8BCD\u8BED\uFF0C\u5728 \u663E\u773C\u7684\u63D0\u793A TODO \u4E2D\uFF0C\u6211\u4EEC\u53EF\u4EE5\u8865\u5145\u81EA\u5DF1\u7684\u903B\u8F91\u3002</p><p>\u6211\u4EEC\u5177\u4F53\u89C2\u5BDF\u4E00\u4E0B PROJECT \u6587\u4EF6\uFF0C\u5177\u4F53\u7684\u5143\u6570\u636E\u53D8\u5316\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">git</span> <span class="token function">diff</span> PROJECT
<span class="token function">diff</span> <span class="token parameter variable">--git</span> a/PROJECT b/PROJECT
index a18434c<span class="token punctuation">..</span>3ea38eb <span class="token number">100644</span>
--- a/PROJECT
+++ b/PROJECT
@@ -7,4 +7,14 @@ layout:
 - go.kubebuilder.io/v4
 projectName: guestbook
 repo: my.domain/guestbook
+resources:
+- api:
+    crdVersion: v1
+    namespaced: <span class="token boolean">true</span>
+  controller: <span class="token boolean">true</span>
+  domain: my.domain
+  group: webapp
+  kind: Guestbook
+  path: my.domain/guestbook/api/v1
+  version: v1
 version: <span class="token string">&quot;3&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C\u8981\u7F16\u8F91API\u5B9A\u4E49\uFF0C\u8BF7\u4F7F\u7528\u4EE5\u4E0B\u547D\u4EE4\u751F\u6210\u6E05\u5355\uFF0C\u5982\u81EA\u5B9A\u4E49\u8D44\u6E90\uFF08CR\uFF09\u6216\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49\uFF08CRD\uFF09</p><details class="custom-container details"><summary>CRD \u548C CR \u533A\u522B</summary><p>\u81EA\u5B9A\u4E49\u8D44\u6E90\uFF08CR\uFF09\u662F Kubernetes \u4E2D\u6269\u5C55 API \u8D44\u6E90\u7684\u4E00\u79CD\u65B9\u5F0F\uFF0C\u5B83\u5141\u8BB8\u7528\u6237\u81EA\u5B9A\u4E49 Kubernetes \u4E2D\u7684\u8D44\u6E90\u7C7B\u578B\uFF0C\u5E76\u4E3A\u5176\u521B\u5EFA\u81EA\u5DF1\u7684 API \u7AEF\u70B9\u3002\u7528\u6237\u53EF\u4EE5\u4F7F\u7528 kubectl \u547D\u4EE4\u884C\u5DE5\u5177\u6216 Kubernetes API \u4EE5\u7F16\u7A0B\u65B9\u5F0F\u64CD\u4F5C CR\u3002CR \u53EF\u4EE5\u7528\u4E8E\u4EFB\u4F55\u4E00\u79CD Kubernetes \u8D44\u6E90\u7684\u6269\u5C55\uFF0C\u4F8B\u5982 Pod\u3001Service \u6216 Deployment\u3002</p><p>\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49\uFF08CRD\uFF09\u7528\u4E8E\u5B9A\u4E49\u81EA\u5B9A\u4E49\u8D44\u6E90\uFF08CR\uFF09\u3002\u5B83\u5B9A\u4E49\u4E86 CR \u7684\u7ED3\u6784\uFF0C\u5373\u5B83\u7684 API \u89C4\u8303\u3002CRD \u7528\u4E8E\u5B9A\u4E49 Kubernetes \u4E2D\u7684\u65B0 API \u8D44\u6E90\u7C7B\u578B\u3002\u8FD9\u4E9B\u8D44\u6E90\u7C7B\u578B\u53EF\u4EE5\u7528\u4E8E\u6269\u5C55 Kubernetes\uFF0C\u4F7F\u5176\u652F\u6301\u66F4\u591A\u7684\u8D44\u6E90\u7C7B\u578B\u548C\u64CD\u4F5C\u3002CRD \u672C\u8EAB\u662F\u4E00\u4E2A Kubernetes \u8D44\u6E90\uFF0C\u5B83\u53EF\u4EE5\u88AB kubectl \u6216 Kubernetes API \u7528\u4E8E\u521B\u5EFA\u65B0\u7684 CR \u7C7B\u578B\u3002</p><p>\u56E0\u6B64\uFF0CCR \u662F\u7528\u6237\u521B\u5EFA\u7684 Kubernetes \u8D44\u6E90\u7C7B\u578B\uFF0C\u800C CRD \u662F\u5B9A\u4E49\u548C\u7BA1\u7406\u8FD9\u4E9B\u8D44\u6E90\u7C7B\u578B\u7684\u65B9\u5F0F\u3002</p></details><h3 id="api-\u5B9A\u4E49" tabindex="-1"><a class="header-anchor" href="#api-\u5B9A\u4E49" aria-hidden="true">#</a> API \u5B9A\u4E49</h3><p>Kubernetes \u7684\u8D44\u6E90\u672C\u8D28\u5C31\u662F\u4E00\u4E2A API \u5BF9\u8C61\uFF0C\u4E0D\u8FC7\u8FD9\u4E2A\u5BF9\u8C61\u7684 \u671F\u671B\u72B6\u6001 \u88AB API Service \u4FDD\u5B58\u5728\u4E86 ETCD \u4E2D\uFF08\u6216\u8005\u662F\u5BF9\u4E8E k3s \u6765\u8BF4\u53EF\u4EE5\u4FDD\u5B58\u5728\u5176\u4ED6\u7684\u6709\u72B6\u6001\u6570\u636E\u5E93\uFF0C\u5305\u62EC sqlite\u3001dqlite\u3001mysql\u2026)\uFF0C\u7136\u540E\u63D0\u4F9B RESTful \u63A5\u53E3\u7528\u4E8E \u66F4\u65B0\u8FD9\u4E9B\u5BF9\u8C61\u3002</p><p>\u6211\u4EEC\u5728\u4E0A\u9762\u8BB2\u8FC7\uFF0CCRD \u7684\u4EE3\u7801\u5B9A\u4E49\u4E3B\u8981\u5728 <code>api/</code> \u76EE\u5F55\u4E0B\u9762\uFF0C\u6211\u4EEC\u770B\u4E00\u4E0B\u4EE3\u7801\u7ED3\u6784\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F tree api
api
\u2514\u2500\u2500 v1
    \u251C\u2500\u2500 groupversion_info.go
    \u251C\u2500\u2500 guestbook_types.go
    \u2514\u2500\u2500 zz_generated.deepcopy.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>guestbook_types.go</code> \u6587\u4EF6\u4E3B\u8981\u7684\u5B9A\u4E49\uFF0C\u6211\u4EEC\u770B\u4E0B spec \u7ED3\u6784\u3002</p><details class="custom-container details"><summary>Spec \u7ED3\u5C3E\u7684\u7ED3\u6784\u4F53\u542B\u4E49</summary><p>\u5728Go\u8BED\u8A00\u4E2D\uFF0C\u7ED3\u6784\u4F53\u4EE5 spec \u7ED3\u5C3E\u8868\u793A\u8BE5\u7ED3\u6784\u4F53\u662F\u7528\u4E8E\u7279\u5B9A\u76EE\u7684\u7684\u89C4\u8303\u7ED3\u6784\u4F53\u3002\u8FD9\u79CD\u547D\u540D\u7EA6\u5B9A\u901A\u5E38\u7528\u4E8E\u63CF\u8FF0\u4E00\u4E2A\u7ED3\u6784\u4F53\u7684\u7528\u9014\u548C\u529F\u80FD\uFF0C\u4EE5\u4FBF\u5F00\u53D1\u4EBA\u5458\u66F4\u597D\u5730\u7406\u89E3\u548C\u4F7F\u7528\u5B83\u3002\u4F8B\u5982\uFF0C<code>GuestbookSpec</code>\u5B9A\u4E49\u4E86\u6240\u9700\u7684 <code>Guestbook</code> \u72B6\u6001</p></details><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// GuestbookSpec defines the desired state of Guestbook</span>
<span class="token keyword">type</span> GuestbookSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span>
        <span class="token comment">// Important: Run &quot;make&quot; to regenerate code after modifying this file</span>

        <span class="token comment">// Foo is an example field of Guestbook. Edit guestbook_types.go to remove/update</span>
        Foo <span class="token builtin">string</span> <span class="token string">\`json:&quot;foo,omitempty&quot;\`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u6CE8\u91CA\u5199\u7684\u5F88\u6E05\u695A\uFF0CFoo \u662F\u4E00\u4E2A\u793A\u4F8B\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5220\u9664\u6389\uFF0C\u7136\u540E\u6DFB\u52A0\u81EA\u5DF1\u9700\u8981\u7684\u914D\u7F6E\u3002</p><p>\u4FEE\u6539\u8FD9\u4E2A\u6587\u4EF6\u540E\u5229\u7528 Makefile \u91CD\u65B0\u751F\u6210\u4EE3\u7801\uFF0C\u{1F4A1}\u7B80\u5355\u7684\u4E00\u4E2A\u6848\u4F8B\u5982\u4E0B\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
	corev1 <span class="token string">&quot;k8s.io/api/core/v1&quot;</span>
    metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> GuestbookSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Replicas <span class="token builtin">int32</span>					<span class="token string">\`json:&quot;replicas,omitempty&quot;\`</span>
    Template corev1<span class="token punctuation">.</span>PodTemplateSpec	<span class="token string">\`json:&quot;template,omitempty&quot;\`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u5206\u522B\u5B9A\u4E49\u4E86 \u7528\u4E8E\u58F0\u660E Pod \u526F\u672C\u7684\u6570\u91CF\u3001\u548C\u7528\u4E8E\u751F\u6210 Pod \u6A21\u677F\u7684\u914D\u7F6E\u3002</p><p>\u6700\u540E\u6211\u4EEC\u4E5F\u8981\u8BB0\u5F55\u5230 git commit \u4E2D\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u276F git add .
\u276F git commit -a -s -m &quot;create api&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="crd-\u90E8\u7F72" tabindex="-1"><a class="header-anchor" href="#crd-\u90E8\u7F72" aria-hidden="true">#</a> CRD \u90E8\u7F72</h3><p><strong>\u63A5\u4E0B\u6765\u6211\u4EEC\u5C31\u53EF\u4EE5\u4F7F\u7528 <code>make manifests</code> \u547D\u4EE4\u751F\u6210 ClusterRole \u548C CustomResourceDefinition \u914D\u7F6E\u3002</strong></p><p><strong>\u68C0\u67E5 git \u7684\u66F4\u6539\u4FE1\u606F\uFF1A</strong></p><blockquote><p>\u5982\u679C\u8981\u7F16\u8F91API\u5B9A\u4E49\uFF0C\u8BF7\u4F7F\u7528\u4EE5\u4E0B\u547D\u4EE4\u751F\u6210\u6E05\u5355\uFF0C\u5982\u81EA\u5B9A\u4E49\u8D44\u6E90\uFF08CR\uFF09\u6216\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49\uFF08CRD\uFF09</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">git</span> status
On branch master
Untracked files:
  <span class="token punctuation">(</span>use <span class="token string">&quot;git add &lt;file&gt;...&quot;</span> to include <span class="token keyword">in</span> what will be committed<span class="token punctuation">)</span>
        config/crd/bases/
        config/rbac/role.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u53EF\u4EE5\u770B\u5230\u4E24\u4E2A\u76EE\u5F55\u6587\u4EF6\u7684\u53D8\u5316\uFF1A</p><ul><li><code>config/crd/bases/</code> \u76EE\u5F55\uFF1A\u65B0\u589E <code>webapp.my.domain_guestbooks.yaml</code> \u6587\u4EF6\uFF0C\u8FD9\u4E5F\u662F <code>guestbook</code> \u7C7B\u578B\u7684 CRD \u914D\u7F6E\u6587\u4EF6\u3002</li><li><code>config/rbac/role.yaml</code> \u5B9A\u4E49\u7684\u662F\u4E00\u4E2A ClusterRole\uFF0C\u4ECE\u540D\u5B57 manager-role \u4E0A\u5927\u81F4\u4E5F\u53EF\u4EE5\u731C\u51FA\u8FD9\u662F\u540E\u9762 Controller \u90E8\u7F72\u540E\u5C06\u5145\u5F53\u7684 \u201C<strong>\u89D2\u8272</strong>\u201D\uFF0C\u5B9A\u4E49\u4E86\u5BF9 <code>guestbook</code> \u8D44\u6E90\u7684 CURD \u64CD\u4F5C\u3002</li></ul><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u9700\u8981\u4E00\u4E2A Kubernetes \u7684\u73AF\u5883\uFF0C\u4E0D\u7BA1\u662F Kind &amp; minikube &amp; k3s \u4F5C\u4E3A\u6D4B\u8BD5\u73AF\u5883\u4E5F\u597D\uFF0C\u6211\u9009\u62E9\u4E86 Kind\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u276F kind version
kind v0.18.0-alpha+bc0526729cf900 go1.20.1 linux/amd64
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u26A0\uFE0F \u63A7\u5236\u5668\u5C06\u81EA\u52A8\u4F7F\u7528 kubeconfig\u6587\u4EF6\uFF08\u5373\u96C6\u7FA4<code>kubectl cluster-info</code>\u663E\u793A\u7684\u4EFB\u4F55\u5185\u5BB9\uFF09\u3002\u5982\u679C\u51FA\u73B0\u95EE\u9898\u6309\u7167\u5B98\u65B9\u7684\u65B9\u6CD5\u53EF\u4EE5\u81EA\u5DF1\u62F7\u8D1D kubeconfig \u6216\u8005\u662F \u8BBE\u7F6E \u73AF\u5883\u53D8\u91CF\u3002</p><p>\u6211\u4EEC\u53EF\u4EE5\u7528 <code>make install</code> \u5B8C\u6210 CRD \u7684\u90E8\u7F72\u8FC7\u7A0B\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">make</span> <span class="token function">install</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u{1F3AF} \u6211\u4EEC\u5E94\u8BE5\u68C0\u67E5\u4E00\u4E2A Makefile \u4E2D\u7684 <code>install target</code>\uFF0C\u6216\u8BB8\u53EF\u4EE5\u770B\u51FA\u6765 <code>install target</code> \u662F\u5305\u542B <code>make manifests</code> \u547D\u4EE4\u7684\uFF0C\u4E0D\u8FC7\u6211\u4EEC\u8FD8\u662F\u5206\u5F00\u64CD\u4F5C\u6709\u52A9\u4E8E\u4E86\u89E3\u6574\u4E2A\u8FC7\u7A0B\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># install   Install CRDs into the K8s cluster specified in ~/.kube/config.</span>
.PHONY: <span class="token function">install</span>
install: manifests kustomize <span class="token comment">## Install CRDs into the K8s cluster specified in ~/.kube/config.</span>
        <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE<span class="token variable">)</span></span> build config/crd <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -
      
<span class="token comment"># kustomize Download kustomize locally if necessary. If wrong version is installed, it will be removed before downloading.</span>
.PHONY: kustomize
kustomize: <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE<span class="token variable">)</span></span> <span class="token comment">## Download kustomize locally if necessary. If wrong version is installed, it will be removed before downloading.</span>
<span class="token variable"><span class="token variable">$(</span>KUSTOMIZE<span class="token variable">)</span></span><span class="token builtin class-name">:</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>
        @if <span class="token builtin class-name">test</span> <span class="token parameter variable">-x</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize version <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE_VERSION<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token punctuation">\\</span>
                <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize version is not expected <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE_VERSION<span class="token variable">)</span></span>. Removing it before installing.&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\\</span>
                <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize<span class="token punctuation">;</span> <span class="token punctuation">\\</span>
        <span class="token keyword">fi</span>
        <span class="token builtin class-name">test</span> <span class="token parameter variable">-s</span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span>/kustomize <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token function">curl</span> <span class="token parameter variable">-Ss</span> <span class="token variable"><span class="token variable">$(</span>KUSTOMIZE_INSTALL_SCRIPT<span class="token variable">)</span></span> <span class="token parameter variable">--output</span> install_kustomize.sh <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> install_kustomize.sh <span class="token variable"><span class="token variable">$(</span>subst v,,<span class="token punctuation">$(</span>KUSTOMIZE_VERSION<span class="token punctuation">)</span><span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>LOCALBIN<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token function">rm</span> install_kustomize.sh<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6821\u9A8C</strong>\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F k get crd <span class="token parameter variable">-A</span>
NAME                          CREATED AT
crontabs.stable.example.com   <span class="token number">2023</span>-04-07T09:17:55Z
guestbooks.webapp.my.domain   <span class="token number">2023</span>-04-07T15:42:22Z
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>guestbooks.webapp.my.domain</code> \u5DF2\u7ECF\u5B58\u5728\u4E86\uFF0C\u8FD9\u662F\u4E00\u4E2A\u81EA\u5B9A\u4E49\u8D44\u6E90\uFF0C\u610F\u5473\u7740\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7 <code>k get pod</code> \u7684\u65B9\u5F0F\u6765 <code>k get guestbooks</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F k get guestbooks.webapp.my.domain <span class="token parameter variable">-A</span>
No resources found
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u5E76\u6CA1\u51FA\u51FA\u73B0 error \uFF0C\u8BF4\u660E\u63D0\u793A\u7684\u662F kube-apiserver \u5DF2\u7ECF\u53EF\u4EE5\u8BC6\u522B\u8FD9\u4E2A\u8D44\u6E90\uFF0C\u53EA\u4E0D\u8FC7\u6CA1\u6709\u8FD9\u4E2A\u8D44\u6E90\u7684\u5177\u4F53\u5B9E\u4F8B\u3002</p><p>\u8FD0\u884C\u4F60\u7684\u63A7\u5236\u5668\uFF08\u8FD9\u5C06\u5728\u524D\u53F0\u8FD0\u884C\uFF0C\u6240\u4EE5\u5207\u6362\u5230\u4E00\u4E2A\u65B0\u7684 \u7EC8\u7AEF\uFF08\u5982\u679C\u4F60\u60F3\u8BA9\u5B83\u4FDD\u6301\u8FD0\u884C\uFF09\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> run
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u5B89\u88C5\u81EA\u5B9A\u4E49\u8D44\u6E90\u7684\u5B9E\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u5B89\u88C5\u81EA\u5B9A\u4E49\u8D44\u6E90\u7684\u5B9E\u4F8B" aria-hidden="true">#</a> \u5B89\u88C5\u81EA\u5B9A\u4E49\u8D44\u6E90\u7684\u5B9E\u4F8B</h3><p>\u5982\u679C\u4F60\u6309\u4E86<code>y</code>\u521B\u5EFA\u8D44\u6E90 <strong>[y/n]</strong>\uFF0C\u5219\u4F60\u5728\u793A\u4F8B\u4E2D\u4E3ACRD\u521B\u5EFA\u4E86CR\uFF08\u5982\u679C\u4F60\u66F4\u6539\u4E86 API\u5B9A\u4E49\uFF09\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> config/samples/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u5728\u96C6\u7FA4\u4E0A\u8FD0\u884C" tabindex="-1"><a class="header-anchor" href="#\u5728\u96C6\u7FA4\u4E0A\u8FD0\u884C" aria-hidden="true">#</a> \u5728\u96C6\u7FA4\u4E0A\u8FD0\u884C</h3><p>\u6784\u5EFA\u955C\u50CF\u5E76\u5C06\u5176\u63A8\u9001\u5230<code>IMG</code>\u6307\u5B9A\u7684\u4F4D\u7F6E\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> docker-build docker-push <span class="token assign-left variable">IMG</span><span class="token operator">=</span><span class="token operator">&lt;</span>some-registry<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>project-name<span class="token operator">&gt;</span>:tag
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4F7F\u7528<code>IMG</code>\u6307\u5B9A\u7684\u955C\u50CF\u5C06\u63A7\u5236\u5668\u90E8\u7F72\u5230\u96C6\u7FA4\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> deploy <span class="token assign-left variable">IMG</span><span class="token operator">=</span><span class="token operator">&lt;</span>some-registry<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>project-name<span class="token operator">&gt;</span>:tag
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u5378\u8F7Dcrd" tabindex="-1"><a class="header-anchor" href="#\u5378\u8F7Dcrd" aria-hidden="true">#</a> \u5378\u8F7DCRD</h3><p>\u8981\u4ECE\u7FA4\u96C6\u4E2D\u5220\u9664CRD\uFF0C\u8BF7\u6267\u884C\u4EE5\u4E0B\u64CD\u4F5C\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> uninstall
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u53D6\u6D88\u90E8\u7F72-controller" tabindex="-1"><a class="header-anchor" href="#\u53D6\u6D88\u90E8\u7F72-controller" aria-hidden="true">#</a> \u53D6\u6D88\u90E8\u7F72 controller</h3><p>\u5C06\u63A7\u5236\u5668\u53D6\u6D88\u90E8\u7F72\u5230\u7FA4\u96C6\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> undeploy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="cr-\u90E8\u7F72" tabindex="-1"><a class="header-anchor" href="#cr-\u90E8\u7F72" aria-hidden="true">#</a> CR \u90E8\u7F72</h2><p>\u6211\u4EEC\u4F7F\u7528 CRD \u5B9A\u4E49\u4E86\u4E00\u4E2A\u8D44\u6E90\uFF0CCR \u5C31\u50CF\u5199\u4E00\u4E2A Deployment \u4E00\u6837\uFF0C\u521B\u5EFA <code>guestbooks</code> \u540C\u6837\u9700\u8981\u4E00\u4E2A <code>yaml</code> \u6587\u4EF6\uFF0C\u5E76\u4E14\u7B26\u5408\u58F0\u660E\u5F0F\u3002</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>\u276F cat config/samples/webapp_v1_guestbook.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> webapp.my.domain/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Guestbook
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> guestbook
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> guestbook<span class="token punctuation">-</span>sample
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> guestbook
    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> kustomize
    <span class="token key atrule">app.kubernetes.io/created-by</span><span class="token punctuation">:</span> guestbook
  <span class="token key atrule">name</span><span class="token punctuation">:</span> guestbook<span class="token punctuation">-</span>sample
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># TODO(user): Add fields here</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

\u276F k apply <span class="token punctuation">-</span>f webapp_v1_guestbook.yaml
guestbook.webapp.my.domain/guestbook<span class="token punctuation">-</span>sample created

\u276F k get guestbooks.webapp.my.domain
NAME               AGE
guestbook<span class="token punctuation">-</span>sample   93s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u8868\u793A\u521B\u5EFA\u51FA\u6765\u4E86 <code>guestbook-sample </code> \u5BF9\u8C61\uFF0C\u4E0D\u8FC7\u8FD9\u4E2A\u65F6\u5019\u8FD8\u4E0D\u591F\uFF0C\u56E0\u4E3A Pod \u8FD8\u6CA1\u6709\u88AB\u521B\u5EFA\u51FA\u6765\uFF0C\u6211\u4EEC\u7EE7\u7EED\u5B9E\u73B0\u76F8\u5E94\u7684\u63A7\u5236\u5668\u903B\u8F91\u3002</p><h2 id="guestbook-\u751F\u6210\u7684\u4EE3\u7801\u548C\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#guestbook-\u751F\u6210\u7684\u4EE3\u7801\u548C\u7ED3\u6784" aria-hidden="true">#</a> guestbook \u751F\u6210\u7684\u4EE3\u7801\u548C\u7ED3\u6784</h2><p>\u6211\u4EEC\u8BE6\u7EC6\u89E3\u91CA\u4E00\u4E0B kubebuilder \u521D\u59CB\u5316CRD\u4EE5\u53CA\u76F8\u5173\u7684\u63A7\u5236\u5668\u6846\u67B6\u540E\uFF0C\u90E8\u5206\u7684\u4EE3\u7801\u7ED3\u6784\u548C\u6E90\u7801\u89E3\u6790\u3002\u9996\u5148\uFF0C\u6211\u4EEC\u5E94\u8BE5\u4ECE\u4E3B\u51FD\u6570\u5F00\u59CB\uFF1A main.go</p><h3 id="cmd" tabindex="-1"><a class="header-anchor" href="#cmd" aria-hidden="true">#</a> cmd</h3><p>main.go \u4F5C\u4E3A\u5165\u53E3\u51FD\u6570\uFF0C\u662F\u6211\u4EEC\u4E3B\u8981\u770B\u7684\u3002\u5F53\u7136\uFF0C\u8BB8\u53EF\u8BC1\u4FE1\u606F\u7701\u7565\u6389\u4E86~ \u6211\u4EEC\u5148\u770B\u4E00\u4E0B\u5934\u6587\u4EF6\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;os&quot;</span>

	<span class="token comment">// Import all Kubernetes client auth plugins (e.g. Azure, GCP, OIDC, etc.)</span>
	<span class="token comment">// to ensure that exec-entrypoint and run can make use of them.</span>
	<span class="token boolean">_</span> <span class="token string">&quot;k8s.io/client-go/plugin/pkg/client/auth&quot;</span>

	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
	utilruntime <span class="token string">&quot;k8s.io/apimachinery/pkg/util/runtime&quot;</span>
	clientgoscheme <span class="token string">&quot;k8s.io/client-go/kubernetes/scheme&quot;</span>
	ctrl <span class="token string">&quot;sigs.k8s.io/controller-runtime&quot;</span>
	<span class="token string">&quot;sigs.k8s.io/controller-runtime/pkg/healthz&quot;</span>
	<span class="token string">&quot;sigs.k8s.io/controller-runtime/pkg/log/zap&quot;</span>

	webappv1 <span class="token string">&quot;my.domain/guestbook/api/v1&quot;</span>
	<span class="token string">&quot;my.domain/guestbook/internal/controller&quot;</span>
	<span class="token comment">//+kubebuilder:scaffold:imports</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6BCF\u4E00\u7EC4\u63A7\u5236\u5668\u90FD\u9700\u8981\u4E00\u4E2AScheme\uFF0C\u5B83\u63D0\u4F9B\u4E86Kinds\u548C\u5B83\u4EEC\u5BF9\u5E94\u7684Go\u7C7B\u578B\u4E4B\u95F4\u7684\u6620\u5C04\u3002\u5728\u7F16\u5199API\u5B9A\u4E49\u65F6\uFF0C\u6211\u4EEC\u5C06\u66F4\u591A\u5730\u8BA8\u8BBAKinds\uFF0C\u6240\u4EE5\u7A0D\u540E\u8BF7\u8BB0\u4F4F\u8FD9\u4E00\u70B9\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	scheme   <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	setupLog <span class="token operator">=</span> ctrl<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">WithName</span><span class="token punctuation">(</span><span class="token string">&quot;setup&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	utilruntime<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>clientgoscheme<span class="token punctuation">.</span><span class="token function">AddToScheme</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>

	utilruntime<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>webappv1<span class="token punctuation">.</span><span class="token function">AddToScheme</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//+kubebuilder:scaffold:scheme</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>runtime.Scheme</code> \u662F Kubernetes \u4E2D\u5BF9\u8C61\u7684\u7F16\u89E3\u7801\u5668\u6CE8\u518C\u8868\uFF0C\u7528\u4E8E\u5C06\u5BF9\u8C61\u5E8F\u5217\u5316\u4E3A\u5B57\u8282\u6570\u7EC4\uFF0C\u5E76\u5C06\u5B57\u8282\u6570\u7EC4\u53CD\u5E8F\u5217\u5316\u4E3A\u5BF9\u8C61\u3002\u6240\u6709 Kubernetes API \u5BF9\u8C61\u90FD\u5FC5\u987B\u6CE8\u518C\u5230 <code>runtime.Scheme</code> \u4E2D\uFF0C\u4EE5\u4FBF\u5728\u5B58\u50A8\u5230 etcd \u6216\u53D1\u9001\u5230 API Server \u65F6\u8FDB\u884C\u6B63\u786E\u7684\u7F16\u89E3\u7801\u3002</p><p>\u53EF\u4EE5\u901A\u8FC7\u8C03\u7528 <code>scheme.AddKnownTypes()</code> \u65B9\u6CD5\u5411 <code>runtime.Scheme</code> \u4E2D\u6CE8\u518C\u65B0\u7684 API \u5BF9\u8C61\u7C7B\u578B\u3002</p><p>\u6211\u4EEC\u5B9E\u4F8B\u5316\u4E86\u4E24\u4E2A\u7BA1\u7406\u5668\uFF0C\u5B83\u8DDF\u8E2A\u6240\u6709\u63A7\u5236\u5668\u7684\u8FD0\u884C\u60C5\u51B5\uFF0C\u5E76\u4E3AAPI\u670D\u52A1\u5668\u8BBE\u7F6E\u5171\u4EAB\u7F13\u5B58\u548C\u5BA2\u6237\u673A\u3002</p><p>\u26A0\uFE0F \u6CE8\u610F\uFF1A\u8FD9\u91CC\u6709 <code>//+kubebuilder:scaffold:scheme</code> \uFF0C\u8FD9\u662F\u4E00\u4E2A\u6BD4\u8F83\u6709\u610F\u601D\u7684\u4E8B\u60C5\u3002</p><p>\u5269\u4E0B\u5C31\u662F\u6700\u6838\u5FC3\u7684 <code>main()</code> \u51FD\u6570\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> metricsAddr <span class="token builtin">string</span>
    <span class="token keyword">var</span> enableLeaderElection <span class="token builtin">bool</span>
    <span class="token keyword">var</span> probeAddr <span class="token builtin">string</span>
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>metricsAddr<span class="token punctuation">,</span> <span class="token string">&quot;metrics-bind-address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:8080&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;The address the metric endpoint binds to.&quot;</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>probeAddr<span class="token punctuation">,</span> <span class="token string">&quot;health-probe-bind-address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:8081&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;The address the probe endpoint binds to.&quot;</span><span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>enableLeaderElection<span class="token punctuation">,</span> <span class="token string">&quot;leader-elect&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token string">&quot;Enable leader election for controller manager. &quot;</span><span class="token operator">+</span>
            <span class="token string">&quot;Enabling this will ensure there is only one active controller manager.&quot;</span><span class="token punctuation">)</span>
    opts <span class="token operator">:=</span> zap<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
        Development<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    opts<span class="token punctuation">.</span><span class="token function">BindFlags</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    ctrl<span class="token punctuation">.</span><span class="token function">SetLogger</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">UseFlagOptions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    mgr<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span><span class="token function">GetConfigOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrl<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
        Scheme<span class="token punctuation">:</span>                 scheme<span class="token punctuation">,</span>
        MetricsBindAddress<span class="token punctuation">:</span>     metricsAddr<span class="token punctuation">,</span>
        Port<span class="token punctuation">:</span>                   <span class="token number">9443</span><span class="token punctuation">,</span>
        HealthProbeBindAddress<span class="token punctuation">:</span> probeAddr<span class="token punctuation">,</span>
        LeaderElection<span class="token punctuation">:</span>         enableLeaderElection<span class="token punctuation">,</span>
        LeaderElectionID<span class="token punctuation">:</span>       <span class="token string">&quot;80807133.tutorial.kubebuilder.io&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        setupLog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to start manager&quot;</span><span class="token punctuation">)</span>
        os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u524D\u9762\u65E0\u975E\u5C31\u662F\u5B9A\u4E49\u4E86\u4E00\u4E2A flag \u5E76\u4E14\u521D\u59CB\u5316\u3002\u5E76\u4E14\u4EA4\u7ED9<code>Parse</code>\u89E3\u6790<code>os.Args[1:]</code>\u4E2D\u7684\u547D\u4EE4\u884C\u6807\u5FD7\u3002</p><p>\u8BF7\u6CE8\u610F\uFF0C <code>Manager</code> \u53EF\u4EE5\u901A\u8FC7\u4EE5\u4E0B\u65B9\u5F0F\u9650\u5236\u6240\u6709\u63A7\u5236\u5668\u5C06\u76D1\u89C6\u8D44\u6E90\u7684\u547D\u540D\u7A7A\u95F4\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code> mgr<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span><span class="token function">GetConfigOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrl<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
     Scheme<span class="token punctuation">:</span>                 scheme<span class="token punctuation">,</span>
     Namespace<span class="token punctuation">:</span>              namespace<span class="token punctuation">,</span>
     MetricsBindAddress<span class="token punctuation">:</span>     metricsAddr<span class="token punctuation">,</span>
     Port<span class="token punctuation">:</span>                   <span class="token number">9443</span><span class="token punctuation">,</span>
     HealthProbeBindAddress<span class="token punctuation">:</span> probeAddr<span class="token punctuation">,</span>
     LeaderElection<span class="token punctuation">:</span>         enableLeaderElection<span class="token punctuation">,</span>
     LeaderElectionID<span class="token punctuation">:</span>       <span class="token string">&quot;80807133.tutorial.kubebuilder.io&quot;</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u7684\u793A\u4F8B\u5C06\u9879\u76EE\u7684\u8303\u56F4\u66F4\u6539\u4E3A\u5355\u4E2A <code>Namespace</code> \u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u6211\u4EEC\u8FD8\u5EFA\u8BAE\u5C06\u9ED8\u8BA4\u7684 <code>ClusterRole</code> \u548C <code>ClusterRoleBinding</code> \u5206\u522B\u66FF\u6362\u4E3A <code>Role</code> \u548C <code>RoleBinding</code> \uFF0C\u4ECE\u800C\u5C06\u63D0\u4F9B\u7684\u6388\u6743\u9650\u5236\u5728\u6B64\u547D\u540D\u7A7A\u95F4\u3002\u8FD9\u6837\u6765\u8BF4\u6743\u9650\u5C0F\u4E00\u4E9B\uFF0C\u5728 RBAC \u4E2D\u4ECB\u7ECD\u8FC7\u8FD9\u90E8\u5206\u3002</p><p>\u4E0D\u4EC5\u5982\u6B64\uFF0C\u6211\u4EEC\u8FD8\u53EF\u4EE5\u4F7F\u7528 <code>MultiNamespacedCacheBuilder</code> \u6765\u76D1\u89C6\u7279\u6027\u7684\u547D\u540D\u7A7A\u95F4\u5B50\u96C6\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> namespaces <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// List of Namespaces</span>

mgr<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span><span class="token function">NewManager</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span><span class="token function">GetConfigOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctrl<span class="token punctuation">.</span>Options<span class="token punctuation">{</span>
    Scheme<span class="token punctuation">:</span>                 scheme<span class="token punctuation">,</span>
    NewCache<span class="token punctuation">:</span>               cache<span class="token punctuation">.</span><span class="token function">MultiNamespacedCacheBuilder</span><span class="token punctuation">(</span>namespaces<span class="token punctuation">)</span><span class="token punctuation">,</span>
    MetricsBindAddress<span class="token punctuation">:</span>     fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d&quot;</span><span class="token punctuation">,</span> metricsHost<span class="token punctuation">,</span> metricsPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Port<span class="token punctuation">:</span>                   <span class="token number">9443</span><span class="token punctuation">,</span>
    HealthProbeBindAddress<span class="token punctuation">:</span> probeAddr<span class="token punctuation">,</span>
    LeaderElection<span class="token punctuation">:</span>         enableLeaderElection<span class="token punctuation">,</span>
    LeaderElectionID<span class="token punctuation">:</span>       <span class="token string">&quot;80807133.tutorial.kubebuilder.io&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u63A5\u4E0B\u6765\u7684\u90E8\u5206\uFF0C\u5C31\u662F\u4E00\u4E9B\u9519\u8BEF\u5904\u7406\uFF0C\u548C\u5F00\u59CB\u642D\u5EFA\u6211\u4EEC\u7684API\u4E86\uFF01</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// +kubebuilder:scaffold:builder</span>

<span class="token keyword">if</span> err <span class="token operator">:=</span> mgr<span class="token punctuation">.</span><span class="token function">AddHealthzCheck</span><span class="token punctuation">(</span><span class="token string">&quot;healthz&quot;</span><span class="token punctuation">,</span> healthz<span class="token punctuation">.</span>Ping<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    setupLog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to set up health check&quot;</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> mgr<span class="token punctuation">.</span><span class="token function">AddReadyzCheck</span><span class="token punctuation">(</span><span class="token string">&quot;readyz&quot;</span><span class="token punctuation">,</span> healthz<span class="token punctuation">.</span>Ping<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    setupLog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to set up ready check&quot;</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

setupLog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;starting manager&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> mgr<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    setupLog<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;problem running manager&quot;</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="groups-versions-kinds-and-resources" tabindex="-1"><a class="header-anchor" href="#groups-versions-kinds-and-resources" aria-hidden="true">#</a> groups, versions, kinds, and resources</h2><p>\u5F53\u6211\u4EEC\u8C08\u8BBAKubernetes\u4E2D\u7684API\u65F6\uFF0C\u6211\u4EEC\u7ECF\u5E38\u4F7F\u75284\u4E2A\u672F\u8BED\uFF1A\u7EC4\u3001\u7248\u672C\u3001\u79CD\u7C7B\u548C\u8D44\u6E90\u3002</p>`,115),Y=s("\u6CA1\u9519\uFF0C\u6211\u4EEC\u5728 "),Z={href:"https://docker.nsddd.top/Cloud-Native-k8s/",target:"_blank",rel:"noopener noreferrer"},X=s("https://docker.nsddd.top/Cloud-Native-k8s/"),Q=s(" \u4E2D\u4ECB\u7ECD\u8FC7\u5F88\u591A\u5173\u4E8E GVK \u548C GVR \u7684\u4ECB\u7ECD\uFF0C\u4E3A\u4EC0\u4E48\u5728 Kubebuilder \u4E2D\u5C24\u5176\u9700\u8981\u518D\u63D0\u4E00\u6B21\u3002"),nn=t(`<p>\u5F53\u6211\u4EEC\u5728\u4E00\u4E2A\u7279\u5B9A\u7684\u7EC4\u7248\u672C\u4E2D\u5F15\u7528\u4E00\u4E2A\u79CD\u7C7B\u65F6\uFF0C\u6211\u4EEC\u5C06\u5176\u79F0\u4E3AGroupVersionKind\uFF0C\u6216\u7B80\u79F0\u4E3AGVK\u3002\u8D44\u6E90\u548CGVR\u4E5F\u662F\u5982\u6B64\u3002\u6211\u4EEC\u5F88\u5FEB\u5C31\u4F1A\u770B\u5230\uFF0C\u6BCF\u4E2AGVK\u5BF9\u5E94\u4E8E\u5305\u4E2D\u7ED9\u5B9A\u7684 root Go type\u3002\u8D70\u8FDB\u6E90\u7801\uFF0C\u4F53\u4F1A\u8FD9\u79CD\u611F\u89C9~</p><h3 id="create-an-api-1" tabindex="-1"><a class="header-anchor" href="#create-an-api-1" aria-hidden="true">#</a> create an API</h3><p>\u6211\u4EEC\u5728\u524D\u9762\u521B\u5EFA\u8FC7 API \uFF0C<code>kubebuilder create api --group webapp --version v1 --kind Guestbook</code> \u547D\u4EE4\u521B\u5EFA\u4E86\u4E00\u4E2A \u7EC4\u4E3A <code>webapp</code>\uFF0C\u7248\u672C\u4E3A <code>v1</code>\uFF0C\u7C7B\u578B\u4E3A <code>Guestbook</code> \u7684API \u8D44\u6E90\u5BF9\u8C61\u3002</p><p>\u6211\u4EEC\u4F7F\u7528\u7684\u547D\u4EE4\u662F <code>create api</code>\uFF0C\u6B64\u547D\u4EE4\u7684\u76EE\u6807\u662F\u4E3A\u6211\u4EEC\u7684\u540C\u7C7B\u521B\u5EFA\u81EA\u5B9A\u4E49\u8D44\u6E90\uFF08CR\uFF09\u548C\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49\uFF08CRD\uFF09\u3002\u6211\u7FFB\u5F00\u4E86 Kubebuilder \u7684\u6E90\u7801\u90E8\u5206\uFF1A</p><p>\u5728 <code>pkg/cli</code> \u76EE\u5F55\u4E0B\u9762\uFF0C\u6211\u4EEC\u627E\u5230\u4E86\u5165\u53E3\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// addSubcommands returns a root command with a subcommand tree reflecting the</span>
<span class="token comment">// current project&#39;s state.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>CLI<span class="token punctuation">)</span> <span class="token function">addSubcommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// add the alpha command if it has any subcommands enabled</span>
	c<span class="token punctuation">.</span><span class="token function">addAlphaCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// kubebuilder completion</span>
	<span class="token comment">// Only add completion if requested</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>completionCommand <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newCompletionCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// kubebuilder create</span>
	createCmd <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">newCreateCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// kubebuilder create api</span>
	createCmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newCreateAPICmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	createCmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newCreateWebhookCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> createCmd<span class="token punctuation">.</span><span class="token function">HasSubCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>createCmd<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// kubebuilder edit</span>
	c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newEditCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// kubebuilder init</span>
	c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newInitCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// kubebuilder version</span>
	<span class="token comment">// Only add version if a version string was provided</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>version <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>cmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">newVersionCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u{1F4DC} \u5BF9\u4E0A\u9762\u7684\u89E3\u91CA\uFF1A</p><blockquote><p>\u901A\u8FC7 <code>newCreateCmd</code> \u521B\u5EFA\u4E86\u4E00\u4E2A <code>create</code> \u547D\u4EE4\uFF0C\u5E76\u4E14\u901A\u8FC7 <code>newCreateAPICmd</code> \u548C <code>newCreateWebhookCmd</code> \u7ED1\u5B9A\u4E86 <code>api</code> \u548C <code>webhook</code>.</p></blockquote><p><code>webhook</code> \u662F\u4E00\u4E2A\u94A9\u5B50\uFF0Chook \u5728 Kubernetes \u4E2D\u968F\u5904\u53EF\u89C1\uFF0C\u53EF\u4EE5\u4F7F\u7528 Webhook \u6765\u9A8C\u8BC1 CRD \u5BF9\u8C61\u7684\u89C4\u8303\u662F\u5426\u6B63\u786E\uFF0C\u5E76\u8BBE\u7F6E\u9ED8\u8BA4\u503C\uFF0C\u4EE5\u786E\u4FDD CRD \u5BF9\u8C61\u7684\u6B63\u786E\u6027\u3002</p><h3 id="\u4E3A\u4EC0\u4E48\u8981\u521B\u5EFA-api" tabindex="-1"><a class="header-anchor" href="#\u4E3A\u4EC0\u4E48\u8981\u521B\u5EFA-api" aria-hidden="true">#</a> \u4E3A\u4EC0\u4E48\u8981\u521B\u5EFA API\uFF1F</h3><p>\u65B0\u7684API\u662F\u6211\u4EEC\u5411Kubernetes\u6559\u6388\u81EA\u5B9A\u4E49\u5BF9\u8C61\u7684\u65B9\u5F0F\u3002Go\u7ED3\u6784\u4F53\u7528\u4E8E\u751F\u6210\u4E00\u4E2ACRD\uFF0C\u5176\u4E2D\u5305\u62EC\u6570\u636E\u7684\u6A21\u5F0F\u4EE5\u53CA\u8DDF\u8E2A\u6570\u636E\uFF0C\u4F8B\u5982\u6211\u4EEC\u7684\u65B0\u7C7B\u578B\u88AB\u79F0\u4E3A\u4EC0\u4E48\u3002</p><p>\u7136\u540E\uFF0C\u6211\u4EEC\u53EF\u4EE5\u521B\u5EFA\u6211\u4EEC\u7684\u81EA\u5B9A\u4E49\u5BF9\u8C61\u7684\u5B9E\u4F8B\uFF0C\u8FD9\u4E9B\u5BF9\u8C61\u5C06\u7531\u6211\u4EEC\u7684\u63A7\u5236\u5668\u7BA1\u7406\u3002</p><p>\u6211\u4EEC\u7684API\u548C\u8D44\u6E90\u4EE3\u8868\u6211\u4EEC\u5728\u96C6\u7FA4\u4E0A\u7684\u89E3\u51B3\u65B9\u6848\u3002\u57FA\u672C\u4E0A\uFF0CCRD\u662F\u6211\u4EEC\u5B9A\u5236\u5BF9\u8C61\u7684\u5B9A\u4E49\uFF0C\u800CCR\u662F\u5B83\u7684\u5B9E\u4F8B\u3002\u5C31\u6BD4\u5982\u8BF4\u4E0A\u9762 \u6211\u4EEC \u901A\u8FC7 kubebuilder \u5B9A\u4E49\u4E86\u4E00\u4E2A <code>guestbooks.webapp.my.domain</code> \u7684 CRD\uFF0C\u7136\u540E\u518D\u901A\u8FC7 \u58F0\u660E\u5F0F yaml \u6587\u4EF6\u7F16\u5199 CR\uFF0C\u5E76\u4E14\u521B\u5EFA CR\u3002</p><blockquote><p>\u5F53\u7136\u5B98\u65B9\u6709\u4E00\u4E2A\u66F4\u597D\u7406\u89E3\u7684\u4F8B\u5B50\uFF1A\u76EE\u6807\u662F\u8BA9\u5E94\u7528\u7A0B\u5E8F\u53CA\u5176\u6570\u636E\u5E93\u5728Kubernetes\u5E73\u53F0\u4E0A\u8FD0\u884C\u3002\u7136\u540E\uFF0C\u4E00\u4E2ACRD\u53EF\u4EE5\u8868\u793AApp\uFF0C\u800C\u53E6\u4E00\u4E2ACRD\u53EF\u4EE5\u8868\u793ADB\u3002</p><p>\u901A\u8FC7\u4F7F\u7528\u4E00\u4E2ACRD\u63CF\u8FF0\u5E94\u7528\u7A0B\u5E8F\uFF0C\u53E6\u4E00\u4E2ACRD\u63CF\u8FF0\u6570\u636E\u5E93\uFF0C\u6211\u4EEC\u4E0D\u4F1A\u635F\u5BB3\u5C01\u88C5\u3001\u5355\u4E00\u8D23\u4EFB\u539F\u5219\u548C\u5185\u805A\u7B49\u6982\u5FF5\u3002</p><p>\u7834\u574F\u8FD9\u4E9B\u6982\u5FF5\u53EF\u80FD\u4F1A\u5BFC\u81F4\u610F\u60F3\u4E0D\u5230\u7684\u526F\u4F5C\u7528\uFF0C\u4F8B\u5982\u96BE\u4EE5\u6269\u5C55\u3001\u91CD\u7528\u6216\u7EF4\u62A4\u7B49\u3002</p></blockquote><h3 id="single-group-to-multi-group" tabindex="-1"><a class="header-anchor" href="#single-group-to-multi-group" aria-hidden="true">#</a> Single Group to Multi-Group</h3><p>\u5728<code>Kubebuilder v2 scaffolding</code>\u7684\u521D\u59CB\u7248\u672C\u4E2D\uFF08\u4ECEKubebuilder v2.0.0\u5F00\u59CB\uFF09\u4E0D\u5B58\u5728\u591A\u7EC4<code>scaffolding</code>\u652F\u6301\u3002</p><p>\u8981\u66F4\u6539\u9879\u76EE\u7684\u5E03\u5C40\u4EE5\u652F\u6301\u591A\u7EC4\uFF0C\u8BF7\u8FD0\u884C\u547D\u4EE4 <code>kubebuilder edit --multigroup=true</code> \u3002\u4E00\u65E6\u5207\u6362\u5230\u591A\u7EC4\u5E03\u5C40\uFF0C\u65B0\u7684Kinds\u5C06\u5728\u65B0\u5E03\u5C40\u4E2D\u751F\u6210\uFF0C\u4F46\u9700\u8981\u989D\u5916\u7684\u624B\u52A8\u5DE5\u4F5C\u5C06\u65E7\u7684API\u7EC4\u79FB\u52A8\u5230\u65B0\u5E03\u5C40\u3002</p><p>\u7136\u540E\u6211\u4EEC\u5C31\u53EF\u4EE5\u6DFB\u52A0\u4E00\u4E2A <strong>\u65B0\u7684 API</strong></p><h3 id="add-new-api" tabindex="-1"><a class="header-anchor" href="#add-new-api" aria-hidden="true">#</a> add new api</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F kubebuilder create api <span class="token parameter variable">--group</span> batch <span class="token parameter variable">--version</span> v1 <span class="token parameter variable">--kind</span> CronJob
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6309\u4E0B <code>y</code> \u952E\uFF0C\u9009\u62E9\u201C\u521B\u5EFA\u8D44\u6E90\u201D\u548C\u201C\u521B\u5EFA\u63A7\u5236\u5668\u201D\u3002</p><p>\u7B2C\u4E00\u6B21\u4E3A\u6BCF\u4E2A\u7EC4\u7248\u672C\u8C03\u7528\u6B64\u547D\u4EE4\u65F6\uFF0C\u5B83\u5C06\u4E3A\u65B0\u7684\u7EC4\u7248\u672C\u521B\u5EFA\u4E00\u4E2A\u76EE\u5F55\u3002</p><p>\u5728\u672C\u4F8B\u4E2D\uFF0C\u521B\u5EFA\u4E86\u4E0E <code>batch.tutorial.kubebuilder.io/v1</code> \u5BF9\u5E94\u7684 <code>api/v1/</code> \u76EE\u5F55\uFF08\u8FD8\u8BB0\u5F97\u6211\u4EEC\u4E00\u5F00\u59CB\u7684 <code>--domain</code> --domain\u8BBE\u7F6E\u5417\uFF1F\uFF09\u3002</p><p>\u5B83\u8FD8\u4E3A\u6211\u4EEC\u7684 <code>CronJob</code> Kind\u6DFB\u52A0\u4E86\u4E00\u4E2A\u6587\u4EF6\uFF0C <code>api/v1/cronjob_types.go</code> \u3002\u6BCF\u6B21\u6211\u4EEC\u8C03\u7528\u4E0D\u540C\u7C7B\u578B\u7684\u547D\u4EE4\u65F6\uFF0C\u5B83\u90FD\u4F1A\u6DFB\u52A0\u4E00\u4E2A\u76F8\u5E94\u7684\u65B0\u6587\u4EF6\u3002</p><p>\u6211\u4EEC\u7684\u51FA\u53D1\u70B9\u5F88\u7B80\u5355\uFF1A\u6211\u4EEC\u5BFC\u5165 <code>meta/v1</code> API\u7EC4\uFF0C\u5B83\u901A\u5E38\u4E0D\u4F1A\u81EA\u5DF1\u66B4\u9732\uFF0C\u800C\u662F\u5305\u542B\u6240\u6709Kubernetes Kind\u901A\u7528\u7684\u5143\u6570\u636E\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> v1

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u4E3ASpec\u548CStatus of our Kind\u5B9A\u4E49\u7C7B\u578B\u3002<strong>Kubernetes\u7684\u529F\u80FD\u662F\u5C06\u671F\u671B\u7684\u72B6\u6001\uFF08 <code>Spec</code> \uFF09\u4E0E\u5B9E\u9645\u7684\u96C6\u7FA4\u72B6\u6001\uFF08\u5176\u4ED6\u5BF9\u8C61\u7684 <code>Status</code> \uFF09\u548C\u5916\u90E8\u72B6\u6001\u8FDB\u884C\u534F\u8C03\uFF0C\u7136\u540E\u8BB0\u5F55\u5B83\u6240\u89C2\u5BDF\u5230\u7684\uFF08 <code>Status</code> \uFF09</strong>\u3002\u56E0\u6B64\uFF0C\u6BCF\u4E2A\u51FD\u6570\u5BF9\u8C61\u90FD\u5305\u62ECspec\u548Cstatus\u3002\u4E00\u4E9B\u7C7B\u578B\uFF0C\u6BD4\u5982 <code>ConfigMap</code> \uFF0C\u4E0D\u9075\u5FAA\u8FD9\u79CD\u6A21\u5F0F\uFF0C\u56E0\u4E3A\u5B83\u4EEC\u4E0D\u7F16\u7801\u6240\u9700\u7684\u72B6\u6001\uFF0C\u4F46\u5927\u591A\u6570\u7C7B\u578B\u90FD\u662F\u8FD9\u6837\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// CronJobSpec defines the desired state of CronJob</span>
<span class="token keyword">type</span> CronJobSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span>
    <span class="token comment">// Important: Run &quot;make&quot; to regenerate code after modifying this file</span>
<span class="token punctuation">}</span>

<span class="token comment">// CronJobStatus defines the observed state of CronJob</span>
<span class="token keyword">type</span> CronJobStatus <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</span>
    <span class="token comment">// Important: Run &quot;make&quot; to regenerate code after modifying this file</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u5B9A\u4E49\u5BF9\u5E94\u4E8E\u5B9E\u9645Kind\u7684\u7C7B\u578B\uFF0C <code>CronJob</code> \u548C <code>CronJobList</code> \u3002 <code>CronJob</code> \u662F\u6211\u4EEC\u7684\u6839\u7C7B\u578B\uFF0C\u5B83\u63CF\u8FF0\u4E86 <code>CronJob</code> \u7C7B\u578B\u3002\u50CF\u6240\u6709Kubernetes\u5BF9\u8C61\u4E00\u6837\uFF0C\u5B83\u5305\u542B <code>TypeMeta</code> \uFF08\u63CF\u8FF0API\u7248\u672C\u548CKind\uFF09\uFF0C\u8FD8\u5305\u542B <code>ObjectMeta</code> \uFF0C\u5B83\u5305\u542B\u540D\u79F0\uFF0C\u547D\u540D\u7A7A\u95F4\u548C\u6807\u7B7E\u7B49\u5185\u5BB9\u3002</p><p><code>CronJobList</code> \u53EA\u662F\u591A\u4E2A <code>CronJob</code> \u7684\u5BB9\u5668\u3002\u5B83\u662F\u5728\u6279\u91CF\u64CD\u4F5C\u4E2D\u4F7F\u7528\u7684\u7C7B\u578B\uFF0C\u5982LIST\u3002</p><p>\u4E00\u822C\u6765\u8BF4\uFF0C\u6211\u4EEC\u4ECE\u4E0D\u4FEE\u6539\u8FD9\u4E24\u4E2A\u5C5E\u6027\u4E2D\u7684\u4EFB\u4F55\u4E00\u4E2A--\u6240\u6709\u4FEE\u6539\u90FD\u5728Spec\u6216Status\u4E2D\u3002</p><p>\u8FD9\u4E2A\u5C0F\u5C0F\u7684 <code>+kubebuilder:object:root</code> \u6CE8\u91CA\u88AB\u79F0\u4E3A\u6807\u8BB0\u3002\u6211\u4EEC\u5C06\u5728\u7A0D\u540E\u770B\u5230\u66F4\u591A\uFF0C\u4F46\u8981\u77E5\u9053\u5B83\u4EEC\u4F5C\u4E3A\u989D\u5916\u7684\u5143\u6570\u636E\uFF0C\u544A\u8BC9\u63A7\u5236\u5668\u5DE5\u5177\uFF08\u6211\u4EEC\u7684\u4EE3\u7801\u548CYAML\u751F\u6210\u5668\uFF09\u989D\u5916\u7684\u4FE1\u606F\u3002\u8FD9\u4E2A\u7279\u5B9A\u7684\u7C7B\u578B\u544A\u8BC9 <code>object</code> \u751F\u6210\u5668\u8FD9\u4E2A\u7C7B\u578B\u4EE3\u8868\u4E00\u4E2AKind\u3002\u7136\u540E\uFF0C <code>object</code> \u751F\u6210\u5668\u4E3A\u6211\u4EEC\u751F\u6210 <code>runtime.Object</code> \u63A5\u53E3\u7684\u5B9E\u73B0\uFF0C\u8FD9\u662F\u6240\u6709\u8868\u793AKinds\u7684\u7C7B\u578B\u90FD\u5FC5\u987B\u5B9E\u73B0\u7684\u6807\u51C6\u63A5\u53E3\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//+kubebuilder:object:root=true</span>
<span class="token comment">//+kubebuilder:subresource:status</span>

<span class="token comment">// CronJob is the Schema for the cronjobs API</span>
<span class="token keyword">type</span> CronJob <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    metav1<span class="token punctuation">.</span>TypeMeta   <span class="token string">\`json:&quot;,inline&quot;\`</span>
    metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">\`json:&quot;metadata,omitempty&quot;\`</span>

    Spec   CronJobSpec   <span class="token string">\`json:&quot;spec,omitempty&quot;\`</span>
    Status CronJobStatus <span class="token string">\`json:&quot;status,omitempty&quot;\`</span>
<span class="token punctuation">}</span>

<span class="token comment">//+kubebuilder:object:root=true</span>

<span class="token comment">// CronJobList contains a list of CronJob</span>
<span class="token keyword">type</span> CronJobList <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    metav1<span class="token punctuation">.</span>TypeMeta <span class="token string">\`json:&quot;,inline&quot;\`</span>
    metav1<span class="token punctuation">.</span>ListMeta <span class="token string">\`json:&quot;metadata,omitempty&quot;\`</span>
    Items           <span class="token punctuation">[</span><span class="token punctuation">]</span>CronJob <span class="token string">\`json:&quot;items&quot;\`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u540E\uFF0C\u6211\u4EEC\u5C06Go\u7C7B\u578B\u6DFB\u52A0\u5230API\u7EC4\u3002\u8FD9\u5141\u8BB8\u6211\u4EEC\u5C06\u6B64API\u7EC4\u4E2D\u7684\u7C7B\u578B\u6DFB\u52A0\u5230\u4EFB\u4F55 Scheme \u4E2D\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SchemeBuilder<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CronJob<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>CronJobList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="controller" tabindex="-1"><a class="header-anchor" href="#controller" aria-hidden="true">#</a> controller</h2><p>\u4E00\u53E5\u8BDD\u63CF\u8FF0\uFF1AControllers are the core of Kubernetes, and of any operator</p><p>\u63A7\u5236\u5668\u7684\u5DE5\u4F5C\u662F\u786E\u4FDD\uFF0C\u5BF9\u4E8E\u4EFB\u4F55\u7ED9\u5B9A\u7684\u5BF9\u8C61\uFF0C\u4E16\u754C\u7684\u5B9E\u9645\u72B6\u6001\uFF08\u5305\u62EC\u96C6\u7FA4\u72B6\u6001\uFF0C\u4EE5\u53CA\u6F5C\u5728\u7684\u5916\u90E8\u72B6\u6001\uFF0C\u5982Kubelet\u7684\u8FD0\u884C\u5BB9\u5668\u6216\u4E91\u63D0\u4F9B\u5546\u7684\u8D1F\u8F7D\u5747\u8861\u5668\uFF09\u4E0E\u5BF9\u8C61\u4E2D\u6240\u9700\u7684\u72B6\u6001\u76F8\u5339\u914D\u3002</p><p>\u6BCF\u4E2A\u63A7\u5236\u5668\u4E13\u6CE8\u4E8E\u4E00\u4E2A root Kind\uFF0C\u4F46\u53EF\u4EE5\u4E0E\u5176\u4ED6Kind\u4EA4\u4E92\u3002</p><p>\u6211\u4EEC\u79F0\u8FD9\u4E2A\u8FC7\u7A0B\u4E3A\u548C\u89E3\uFF08 <em>reconciling</em>\uFF09\u3002</p><p>\u5728controller-runtime\u4E2D\uFF0C\u5B9E\u73B0\u7279\u5B9A\u7C7B\u578B\u534F\u8C03\u7684\u903B\u8F91\u79F0\u4E3AReconciler\u3002reconciler\u83B7\u53D6\u5BF9\u8C61\u7684\u540D\u79F0\uFF0C\u5E76\u8FD4\u56DE\u662F\u5426\u9700\u8981\u91CD\u8BD5\uFF08\u4F8B\u5982\uFF0C\u5982\u679C\u51FA\u73B0\u9519\u8BEF\u6216\u5468\u671F\u6027\u63A7\u5236\u5668\uFF0C\u5982HorizontalPodAutoscaler\uFF09\u3002</p><p>\u9996\u5148\uFF0C\u6211\u4EEC\u4ECE\u4E00\u4E9B\u6807\u51C6\u7684\u5BFC\u5165\u5F00\u59CB\u3002\u548C\u524D\u9762\u4E00\u6837\uFF0C\u6211\u4EEC\u9700\u8981\u6838\u5FC3\u63A7\u5236\u5668\u8FD0\u884C\u65F6\u5E93\uFF0C\u4EE5\u53CA\u5BA2\u6237\u7AEF\u5305\u548CAPI\u7C7B\u578B\u7684\u5305\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> controllers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;context&quot;</span>

    <span class="token string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
    ctrl <span class="token string">&quot;sigs.k8s.io/controller-runtime&quot;</span>
    <span class="token string">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span>
    <span class="token string">&quot;sigs.k8s.io/controller-runtime/pkg/log&quot;</span>

    batchv1 <span class="token string">&quot;tutorial.kubebuilder.io/project/api/v1&quot;</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\uFF0Ckubebuilder\u4E3A\u6211\u4EEC\u642D\u5EFA\u4E86\u4E00\u4E2A\u57FA\u672C\u7684reconciler\u7ED3\u6784\u3002\u51E0\u4E4E\u6BCF\u4E2A\u534F\u8C03\u5668\u90FD\u9700\u8981\u65E5\u5FD7\uFF0C\u5E76\u4E14\u9700\u8981\u80FD\u591F\u83B7\u53D6\u5BF9\u8C61\uFF0C\u56E0\u6B64\u8FD9\u4E9B\u90FD\u662F\u5F00\u7BB1\u5373\u7528\u7684\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// CronJobReconciler reconciles a CronJob object</span>
<span class="token keyword">type</span> CronJobReconciler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span>Client
    Scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5927\u591A\u6570\u63A7\u5236\u5668\u6700\u7EC8\u90FD\u5728\u96C6\u7FA4\u4E0A\u8FD0\u884C\uFF0C\u56E0\u6B64\u5B83\u4EEC\u9700\u8981RBAC\u6743\u9650\uFF0C\u6211\u4EEC\u4F7F\u7528controller-tools RBAC\u6807\u8BB0\u6765\u6307\u5B9A\u8FD9\u4E9B\u6743\u9650\u3002\u8FD9\u4E9B\u662F\u8FD0\u884C\u6240\u9700\u7684\u6700\u4F4E\u6743\u9650\u3002\u5F53\u6211\u4EEC\u6DFB\u52A0\u66F4\u591A\u529F\u80FD\u65F6\uFF0C\u6211\u4EEC\u5C06\u9700\u8981\u91CD\u65B0\u8BBF\u95EE\u8FD9\u4E9B\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">// +kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F7F\u7528\u4EE5\u4E0B\u547D\u4EE4\u901A\u8FC7controller-gen\u4ECE\u4E0A\u8FF0\u6807\u8BB0\u751F\u6210 <code>config/rbac/role.yaml</code> \u5904\u7684 <code>ClusterRole</code> \u6E05\u5355\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">make</span> manifests
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u5B9E\u73B0-controller" tabindex="-1"><a class="header-anchor" href="#\u5B9E\u73B0-controller" aria-hidden="true">#</a> \u5B9E\u73B0 Controller</h3><p>\u6211\u4EEC\u901A\u8FC7\u5B9E\u73B0 Controller \u903B\u8F91\u53BB\u521B\u5EFA Pod\uFF0C\u5728 <code>internal/controller/guestbook_controller.go</code></p><p>\u6211\u4EEC\u7684CronJob\u63A7\u5236\u5668\u7684\u57FA\u672C\u903B\u8F91\u662F\u8FD9\u6837\u7684\uFF1A</p><ol><li>\u52A0\u8F7D\u547D\u540D\u7684 CronJob</li><li>\u5217\u51FA\u6240\u6709\u6D3B\u52A8 jobs \u5E76\u66F4\u65B0\u72B6\u6001</li><li>\u6839\u636E\u5386\u53F2\u9650\u5236\u6E05\u7406 history limits</li><li>\u68C0\u67E5\u6211\u4EEC\u662F\u5426\u88AB\u6682\u505C\uFF08\u5982\u679C\u662F\uFF0C\u4E0D\u8981\u505A\u4EFB\u4F55\u5176\u4ED6\u4E8B\u60C5\uFF09</li><li>\u83B7\u53D6\u4E0B\u4E00\u6B21\u8BA1\u5212\u8FD0\u884C</li><li>\u8FD0\u884C\u4E00\u4E2A\u65B0\u7684 job\uFF0C\u5982\u679C\u5B83\u662F\u6309\u8BA1\u5212\u8FDB\u884C\u7684\uFF0C\u6CA1\u6709\u8D85\u8FC7\u622A\u6B62\u65E5\u671F\uFF0C\u4E5F\u6CA1\u6709\u88AB\u6211\u4EEC\u7684\u5E76\u53D1\u7B56\u7565\u963B\u585E</li><li>\u5F53\u6211\u4EEC\u770B\u5230\u4E00\u4E2A\u6B63\u5728\u8FD0\u884C\u7684 job\uFF08\u81EA\u52A8\u5B8C\u6210\uFF09\u6216\u8005\u5230\u4E86\u4E0B\u4E00\u4E2A\u8BA1\u5212\u8FD0\u884C\u7684\u65F6\u95F4\u65F6\uFF0C\u91CD\u65B0\u6392\u961F\u3002</li></ol><p>\u6211\u4EEC\u5148\u4ECE\u8FDB\u53E3\u5F00\u59CB\u3002\u4E0B\u9762\u4F60\u4F1A\u770B\u5230\uFF0C\u6211\u4EEC\u9700\u8981\u6BD4\u90A3\u4E9B\u811A\u624B\u67B6\u66F4\u591A\u7684\u8FDB\u53E3\u3002\u6211\u4EEC\u5C06\u5728\u4F7F\u7528\u65F6\u8BA8\u8BBA\u6BCF\u4E00\u4E2A\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> controllers

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;context&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;sort&quot;</span>
    <span class="token string">&quot;time&quot;</span>

    <span class="token string">&quot;github.com/robfig/cron&quot;</span>
    kbatch <span class="token string">&quot;k8s.io/api/batch/v1&quot;</span>
    corev1 <span class="token string">&quot;k8s.io/api/core/v1&quot;</span>
    metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
    <span class="token string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
    ref <span class="token string">&quot;k8s.io/client-go/tools/reference&quot;</span>
    ctrl <span class="token string">&quot;sigs.k8s.io/controller-runtime&quot;</span>
    <span class="token string">&quot;sigs.k8s.io/controller-runtime/pkg/client&quot;</span>
    <span class="token string">&quot;sigs.k8s.io/controller-runtime/pkg/log&quot;</span>

    batchv1 <span class="token string">&quot;tutorial.kubebuilder.io/project/api/v1&quot;</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u9700\u8981\u4E00\u4E2A\u65F6\u949F\uFF0C\u8FD9\u5C06\u5141\u8BB8\u6211\u4EEC\u5728\u6D4B\u8BD5\u4E2D\u4F2A\u9020\u65F6\u95F4\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// CronJobReconciler reconciles a CronJob object</span>
<span class="token keyword">type</span> CronJobReconciler <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span>Client
    Scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme
    Clock
<span class="token punctuation">}</span>
<span class="token comment">// Clock</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u5C06\u6A21\u62DF\u65F6\u949F\uFF0C\u4EE5\u4FBF\u5728\u6D4B\u8BD5\u65F6\u66F4\u5BB9\u6613\u5728\u65F6\u95F4\u4E0A\u8DF3\u8DC3\uFF0C\u201C\u771F\u5B9E\u7684\u201D \u65F6\u949F\u53EA\u662F\u8C03\u7528 <code>time.Now</code> \u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> realClock <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token boolean">_</span> realClock<span class="token punctuation">)</span> <span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time <span class="token punctuation">{</span> <span class="token keyword">return</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token comment">// clock knows how to get the current time.</span>
<span class="token comment">// It can be used to fake out timing for testing.</span>
<span class="token keyword">type</span> Clock <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BF7\u6CE8\u610F\uFF0C\u6211\u4EEC\u8FD8\u9700\u8981\u4E00\u4E9BRBAC\u6743\u9650--\u56E0\u4E3A\u6211\u4EEC\u73B0\u5728\u6B63\u5728\u521B\u5EFA\u548C\u7BA1\u7406\u4F5C\u4E1A\uFF0C\u6240\u4EE5\u9700\u8981\u8FD9\u4E9B\u6743\u9650\uFF0C\u8FD9\u610F\u5473\u7740\u8981\u6DFB\u52A0\u4E00\u4E9B\u6807\u8BB0\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/status,verbs=get;update;patch</span>
<span class="token comment">//+kubebuilder:rbac:groups=batch.tutorial.kubebuilder.io,resources=cronjobs/finalizers,verbs=update</span>
<span class="token comment">//+kubebuilder:rbac:groups=batch,resources=jobs,verbs=get;list;watch;create;update;patch;delete</span>
<span class="token comment">//+kubebuilder:rbac:groups=batch,resources=jobs/status,verbs=get</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728\uFF0C\u6211\u4EEC\u8FDB\u5165\u63A7\u5236\u5668\u7684\u6838\u5FC3--\u534F\u8C03\u5668\u903B\u8F91\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
    scheduledTimeAnnotation <span class="token operator">=</span> <span class="token string">&quot;batch.tutorial.kubebuilder.io/scheduled-at&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// Reconcile is part of the main kubernetes reconciliation loop which aims to</span>
<span class="token comment">// move the current state of the cluster closer to the desired state.</span>
<span class="token comment">// TODO(user): Modify the Reconcile function to compare the state specified by</span>
<span class="token comment">// the CronJob object against the actual cluster state, and then</span>
<span class="token comment">// perform operations to make the cluster state reflect the state specified by</span>
<span class="token comment">// the user.</span>
<span class="token comment">//</span>
<span class="token comment">// For more details, check Reconcile and its Result here:</span>
<span class="token comment">// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.13.0/pkg/reconcile</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>CronJobReconciler<span class="token punctuation">)</span> <span class="token function">Reconcile</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req ctrl<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u6309\u540D\u79F0\u52A0\u8F7Dcronjob" tabindex="-1"><a class="header-anchor" href="#\u6309\u540D\u79F0\u52A0\u8F7Dcronjob" aria-hidden="true">#</a> \u6309\u540D\u79F0\u52A0\u8F7DCronJob</h3><p>\u6211\u4EEC\u5C06\u4F7F\u7528\u5BA2\u6237\u7AEF\u83B7\u53D6CronJob\u3002\u6240\u6709\u5BA2\u6237\u7AEF\u65B9\u6CD5\u90FD\u5C06\u4E0A\u4E0B\u6587\uFF08\u4EE5\u5141\u8BB8\u53D6\u6D88\uFF09\u4F5C\u4E3A\u5176\u7B2C\u4E00\u4E2A\u53C2\u6570\uFF0C\u5E76\u5C06\u6709\u95EE\u9898\u7684\u5BF9\u8C61\u4F5C\u4E3A\u5176\u6700\u540E\u4E00\u4E2A\u53C2\u6570\u3002Get\u6709\u70B9\u7279\u6B8A\uFF0C\u5B83\u5C06 <code>NamespacedName</code> \u4F5C\u4E3A\u4E2D\u95F4\u53C2\u6570\uFF08\u5927\u591A\u6570\u6CA1\u6709\u4E2D\u95F4\u53C2\u6570\uFF0C\u6211\u4EEC\u5C06\u5728\u4E0B\u9762\u770B\u5230\uFF09\u3002</p><p>\u8BB8\u591A\u5BA2\u6237\u7AEF\u65B9\u6CD5\u4E5F\u5728\u6700\u540E\u91C7\u7528\u53EF\u53D8\u53C2\u6570\u9009\u9879\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> cronJob batchv1<span class="token punctuation">.</span>CronJob
<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>NamespacedName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cronJob<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to fetch CronJob&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// we&#39;ll ignore not-found errors, since they can&#39;t be fixed by an immediate</span>
    <span class="token comment">// requeue (we&#39;ll need to wait for a new notification), and we can get them</span>
    <span class="token comment">// on deleted requests.</span>
    <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">IgnoreNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5217\u51FA\u6240\u6709\u6D3B\u52A8\u4F5C\u4E1A-\u5E76\u66F4\u65B0\u72B6\u6001" tabindex="-1"><a class="header-anchor" href="#\u5217\u51FA\u6240\u6709\u6D3B\u52A8\u4F5C\u4E1A-\u5E76\u66F4\u65B0\u72B6\u6001" aria-hidden="true">#</a> \u5217\u51FA\u6240\u6709\u6D3B\u52A8\u4F5C\u4E1A\uFF0C\u5E76\u66F4\u65B0\u72B6\u6001</h3><p>\u8981\u5B8C\u5168\u66F4\u65B0\u72B6\u6001\uFF0C\u6211\u4EEC\u9700\u8981\u5217\u51FA\u6B64\u547D\u540D\u7A7A\u95F4\u4E2D\u5C5E\u4E8E\u6B64CronJob\u7684\u6240\u6709\u5B50\u4F5C\u4E1A\u3002\u4E0EGet\u7C7B\u4F3C\uFF0C\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528List\u65B9\u6CD5\u5217\u51FA\u5B50\u4F5C\u4E1A\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>    <span class="token keyword">var</span> childJobs kbatch<span class="token punctuation">.</span>JobList
    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>childJobs<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">InNamespace</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span>MatchingFields<span class="token punctuation">{</span>jobOwnerKey<span class="token punctuation">:</span> req<span class="token punctuation">.</span>Name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to list child Jobs&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E00\u65E6\u6211\u4EEC\u62E5\u6709\u4E86\u6240\u6709\u7684\u4F5C\u4E1A\uFF0C\u6211\u4EEC\u5C06\u628A\u5B83\u4EEC\u5206\u6210\u6D3B\u52A8\u7684\u3001\u6210\u529F\u7684\u548C\u5931\u8D25\u7684\u4F5C\u4E1A\uFF0C\u8DDF\u8E2A\u6700\u8FD1\u7684\u8FD0\u884C\uFF0C\u4EE5\u4FBF\u6211\u4EEC\u53EF\u4EE5\u5728\u72B6\u6001\u4E2D\u8BB0\u5F55\u5B83\u3002</p><p>\u8BF7\u8BB0\u4F4F\uFF0C\u72B6\u6001\u5E94\u8BE5\u80FD\u591F\u4ECE\u4E16\u754C\u7684\u72B6\u6001\u4E2D\u91CD\u65B0\u6784\u5EFA\uFF0C\u56E0\u6B64\u901A\u5E38\u4ECE\u6839\u5BF9\u8C61\u7684\u72B6\u6001\u4E2D\u8BFB\u53D6\u4E0D\u662F\u4E00\u4E2A\u597D\u4E3B\u610F\u3002\u76F8\u53CD\uFF0C\u4F60\u5E94\u8BE5\u5728\u6BCF\u6B21\u8FD0\u884C\u65F6\u91CD\u65B0\u6784\u5EFA\u5B83\u3002\u8FD9\u5C31\u662F\u6211\u4EEC\u8981\u505A\u7684\u3002</p><p>\u6211\u4EEC\u53EF\u4EE5\u4F7F\u7528\u72B6\u6001\u6761\u4EF6\u68C0\u67E5\u4F5C\u4E1A\u662F\u5426\u201C\u5B8C\u6210\u201D\u4EE5\u53CA\u5B83\u662F\u6210\u529F\u8FD8\u662F\u5931\u8D25\u3002\u6211\u4EEC\u5C06\u628A\u8FD9\u4E2A\u903B\u8F91\u653E\u5728\u4E00\u4E2A\u5E2E\u52A9\u5668\u4E2D\uFF0C\u4EE5\u4F7F\u6211\u4EEC\u7684\u4EE3\u7801\u66F4\u6E05\u6670\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>    <span class="token comment">// find the active list of jobs</span>
    <span class="token keyword">var</span> activeJobs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>kbatch<span class="token punctuation">.</span>Job
    <span class="token keyword">var</span> successfulJobs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>kbatch<span class="token punctuation">.</span>Job
    <span class="token keyword">var</span> failedJobs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>kbatch<span class="token punctuation">.</span>Job
    <span class="token keyword">var</span> mostRecentTime <span class="token operator">*</span>time<span class="token punctuation">.</span>Time <span class="token comment">// find the last run so we can update the status</span>
<span class="token comment">// isJobFinished</span>
<span class="token comment">// getScheduledTimeForJob</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> job <span class="token operator">:=</span> <span class="token keyword">range</span> childJobs<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> finishedType <span class="token operator">:=</span> <span class="token function">isJobFinished</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>job<span class="token punctuation">)</span>
        <span class="token keyword">switch</span> finishedType <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">:</span> <span class="token comment">// ongoing</span>
            activeJobs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>activeJobs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>childJobs<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> kbatch<span class="token punctuation">.</span>JobFailed<span class="token punctuation">:</span>
            failedJobs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>childJobs<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> kbatch<span class="token punctuation">.</span>JobComplete<span class="token punctuation">:</span>
            successfulJobs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>childJobs<span class="token punctuation">.</span>Items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// We&#39;ll store the launch time in an annotation, so we&#39;ll reconstitute that from</span>
        <span class="token comment">// the active jobs themselves.</span>
        scheduledTimeForJob<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getScheduledTimeForJob</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>job<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to parse schedule time for child job&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>job<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> scheduledTimeForJob <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> mostRecentTime <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                mostRecentTime <span class="token operator">=</span> scheduledTimeForJob
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> mostRecentTime<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span><span class="token operator">*</span>scheduledTimeForJob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mostRecentTime <span class="token operator">=</span> scheduledTimeForJob
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> mostRecentTime <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>LastScheduleTime <span class="token operator">=</span> <span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>Time<span class="token punctuation">{</span>Time<span class="token punctuation">:</span> <span class="token operator">*</span>mostRecentTime<span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>LastScheduleTime <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Active <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> activeJob <span class="token operator">:=</span> <span class="token keyword">range</span> activeJobs <span class="token punctuation">{</span>
        jobRef<span class="token punctuation">,</span> err <span class="token operator">:=</span> ref<span class="token punctuation">.</span><span class="token function">GetReference</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> activeJob<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to make reference to active job&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> activeJob<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Active <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cronJob<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>Active<span class="token punctuation">,</span> <span class="token operator">*</span>jobRef<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u8FD9\u91CC\uFF0C\u6211\u4EEC\u5C06\u8BB0\u5F55\u6211\u4EEC\u5728\u7A0D\u9AD8\u7684\u65E5\u5FD7\u7EA7\u522B\u4E0A\u89C2\u5BDF\u5230\u7684\u4F5C\u4E1A\u6570\u91CF\uFF0C\u4EE5\u4FBF\u8FDB\u884C\u8C03\u8BD5\u3002\u8BF7\u6CE8\u610F\uFF0C\u6211\u4EEC\u4E0D\u662F\u4F7F\u7528\u683C\u5F0F\u5B57\u7B26\u4E32\uFF0C\u800C\u662F\u4F7F\u7528\u56FA\u5B9A\u6D88\u606F\uFF0C\u5E76\u9644\u52A0\u5E26\u6709\u989D\u5916\u4FE1\u606F\u7684\u952E\u503C\u5BF9\u3002\u8FD9\u4F7F\u5F97\u8FC7\u6EE4\u548C\u67E5\u8BE2\u65E5\u5FD7\u884C\u66F4\u52A0\u5BB9\u6613\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>    log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;job count&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;active jobs&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>activeJobs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;successful jobs&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;failed jobs&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4F7F\u7528\u6211\u4EEC\u6536\u96C6\u7684\u6570\u636E\uFF0C\u6211\u4EEC\u5C06\u66F4\u65B0CRD\u7684\u72B6\u6001\u3002\u5C31\u50CF\u4EE5\u524D\u4E00\u6837\uFF0C\u6211\u4EEC\u5229\u7528\u6211\u4EEC\u7684\u5BA2\u6237\u3002\u4E3A\u4E86\u4E13\u95E8\u66F4\u65B0\u72B6\u6001\u5B50\u8D44\u6E90\uFF0C\u6211\u4EEC\u5C06\u4F7F\u7528\u5BA2\u6237\u7AEF\u7684 <code>Status</code> \u90E8\u5206\u548C <code>Update</code> \u65B9\u6CD5\u3002</p><p>status\u5B50\u8D44\u6E90\u5FFD\u7565\u5BF9spec\u7684\u66F4\u6539\uFF0C\u56E0\u6B64\u5B83\u4E0D\u592A\u53EF\u80FD\u4E0E\u4EFB\u4F55\u5176\u4ED6\u66F4\u65B0\u51B2\u7A81\uFF0C\u5E76\u4E14\u53EF\u4EE5\u5177\u6709\u5355\u72EC\u7684\u6743\u9650\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cronJob<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to update CronJob status&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E00\u65E6\u6211\u4EEC\u66F4\u65B0\u4E86\u6211\u4EEC\u7684\u72B6\u6001\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u7EE7\u7EED\u786E\u4FDD\u4E16\u754C\u7684\u72B6\u6001\u4E0E\u6211\u4EEC\u5728\u89C4\u8303\u4E2D\u60F3\u8981\u7684\u76F8\u5339\u914D\u3002</p><h3 id="\u6839\u636E\u5386\u53F2\u9650\u5236\u6E05\u7406\u65E7\u4F5C\u4E1A" tabindex="-1"><a class="header-anchor" href="#\u6839\u636E\u5386\u53F2\u9650\u5236\u6E05\u7406\u65E7\u4F5C\u4E1A" aria-hidden="true">#</a> \u6839\u636E\u5386\u53F2\u9650\u5236\u6E05\u7406\u65E7\u4F5C\u4E1A</h3><p>\u9996\u5148\uFF0C\u6211\u4EEC\u5C06\u52AA\u529B\u6E05\u7406\u65E7\u7684\u5DE5\u4F5C\uFF0C\u8FD9\u6837\u6211\u4EEC\u5C31\u4E0D\u4F1A\u7559\u4E0B\u592A\u591A\u7684\u95F2\u7F6E\u5DE5\u4F5C\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// NB: deleting these are &quot;best effort&quot; -- if we fail on a particular one,</span>
    <span class="token comment">// we won&#39;t requeue just to finish the deleting.</span>
    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>FailedJobsHistoryLimit <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        sort<span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> failedJobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> failedJobs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime <span class="token operator">!=</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> failedJobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> job <span class="token operator">:=</span> <span class="token keyword">range</span> failedJobs <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token function">int32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>failedJobs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">*</span>cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>FailedJobsHistoryLimit <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> job<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">PropagationPolicy</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>DeletePropagationBackground<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> client<span class="token punctuation">.</span><span class="token function">IgnoreNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to delete old failed job&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;deleted old failed job&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>SuccessfulJobsHistoryLimit <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        sort<span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> successfulJobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> successfulJobs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime <span class="token operator">!=</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> successfulJobs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>Status<span class="token punctuation">.</span>StartTime<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> job <span class="token operator">:=</span> <span class="token keyword">range</span> successfulJobs <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token function">int32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>successfulJobs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">*</span>cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>SuccessfulJobsHistoryLimit <span class="token punctuation">{</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> job<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">PropagationPolicy</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>DeletePropagationBackground<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to delete old successful job&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;deleted old successful job&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u68C0\u67E5\u662F\u5426\u505C\u6B62" tabindex="-1"><a class="header-anchor" href="#\u68C0\u67E5\u662F\u5426\u505C\u6B62" aria-hidden="true">#</a> \u68C0\u67E5\u662F\u5426\u505C\u6B62</h3><p>\u5982\u679C\u8FD9\u4E2A\u5BF9\u8C61\u88AB\u6302\u8D77\uFF0C\u6211\u4EEC\u4E0D\u60F3\u8FD0\u884C\u4EFB\u4F55\u4F5C\u4E1A\uFF0C\u6240\u4EE5\u6211\u4EEC\u73B0\u5728\u505C\u6B62\u3002\u5982\u679C\u6211\u4EEC\u6B63\u5728\u8FD0\u884C\u7684\u4F5C\u4E1A\u51FA\u73B0\u6545\u969C\uFF0C\u5E76\u4E14\u6211\u4EEC\u5E0C\u671B\u6682\u505C\u8FD0\u884C\u4EE5\u8FDB\u884C\u8C03\u67E5\u6216\u5904\u7406\u96C6\u7FA4\uFF0C\u800C\u4E0D\u5220\u9664\u5BF9\u8C61\uFF0C\u5219\u6B64\u529F\u80FD\u975E\u5E38\u6709\u7528\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Suspend <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Suspend <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;cronjob suspended, skipping&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u83B7\u53D6\u4E0B\u4E00\u6B21\u8BA1\u5212\u8FD0\u884C" tabindex="-1"><a class="header-anchor" href="#\u83B7\u53D6\u4E0B\u4E00\u6B21\u8BA1\u5212\u8FD0\u884C" aria-hidden="true">#</a> \u83B7\u53D6\u4E0B\u4E00\u6B21\u8BA1\u5212\u8FD0\u884C</h3><p>\u5982\u679C\u6211\u4EEC\u6CA1\u6709\u6682\u505C\uFF0C\u6211\u4EEC\u5C06\u9700\u8981\u8BA1\u7B97\u4E0B\u4E00\u4E2A\u8BA1\u5212\u7684\u8FD0\u884C\uFF0C\u4EE5\u53CA\u6211\u4EEC\u662F\u5426\u6709\u4E00\u4E2A\u5C1A\u672A\u5904\u7406\u7684\u8FD0\u884C\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// getNextSchedule</span>
    <span class="token comment">// figure out the next times that we need to create</span>
    <span class="token comment">// jobs at (or anything we missed).</span>
    missedRun<span class="token punctuation">,</span> nextRun<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">getNextSchedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cronJob<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to figure out CronJob schedule&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">// we don&#39;t really care about requeuing until we get an update that</span>
        <span class="token comment">// fixes the schedule, so don&#39;t return an error</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u5C06\u51C6\u5907\u6700\u7EC8\u7684\u8BF7\u6C42\uFF0C\u4EE5\u4FBF\u5728\u4E0B\u4E00\u4E2A\u4F5C\u4E1A\u4E4B\u524D\u91CD\u65B0\u6392\u961F\uFF0C\u7136\u540E\u786E\u5B9A\u6211\u4EEC\u662F\u5426\u5B9E\u9645\u9700\u8981\u8FD0\u884C\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>    scheduledResult <span class="token operator">:=</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span>RequeueAfter<span class="token punctuation">:</span> nextRun<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token comment">// save this so we can re-use it elsewhere</span>
    log <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">WithValues</span><span class="token punctuation">(</span><span class="token string">&quot;now&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;next run&quot;</span><span class="token punctuation">,</span> nextRun<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5E76\u53D1\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#\u5E76\u53D1\u7B56\u7565" aria-hidden="true">#</a> \u5E76\u53D1\u7B56\u7565</h3><p><strong>\u8FD0\u884C\u4E00\u4E2A\u65B0\u7684\u4F5C\u4E1A\uFF0C\u5982\u679C\u5B83\u662F\u6309\u8BA1\u5212\u8FDB\u884C\u7684\uFF0C\u6CA1\u6709\u8D85\u8FC7\u622A\u6B62\u65E5\u671F\uFF0C\u4E5F\u6CA1\u6709\u88AB\u6211\u4EEC\u7684\u5E76\u53D1\u7B56\u7565\u963B\u585E</strong></p><p>\u5982\u679C\u6211\u4EEC\u9519\u8FC7\u4E86\u4E00\u4E2A\u8FD0\u884C\uFF0C\u5E76\u4E14\u6211\u4EEC\u4ECD\u7136\u5728\u5F00\u59CB\u5B83\u7684\u622A\u6B62\u65E5\u671F\u5185\uFF0C\u6211\u4EEC\u5C06\u9700\u8981\u8FD0\u884C\u4E00\u4E2A\u4F5C\u4E1A\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>    <span class="token keyword">if</span> missedRun<span class="token punctuation">.</span><span class="token function">IsZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;no upcoming scheduled times, sleeping until next&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// make sure we&#39;re not too late to start the run</span>
    log <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">WithValues</span><span class="token punctuation">(</span><span class="token string">&quot;current run&quot;</span><span class="token punctuation">,</span> missedRun<span class="token punctuation">)</span>
    tooLate <span class="token operator">:=</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>StartingDeadlineSeconds <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        tooLate <span class="token operator">=</span> missedRun<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token operator">*</span>cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>StartingDeadlineSeconds<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> tooLate <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;missed starting deadline for last run, sleeping till next&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">// TODO(directxman12): events</span>
        <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C\u6211\u4EEC\u5B9E\u9645\u4E0A\u5FC5\u987B\u8FD0\u884C\u4E00\u4E2A\u4F5C\u4E1A\uFF0C\u6211\u4EEC\u9700\u8981\u7B49\u5F85\u73B0\u6709\u7684\u4F5C\u4E1A\u5B8C\u6210\uFF0C\u66FF\u6362\u73B0\u6709\u7684\u4F5C\u4E1A\uFF0C\u6216\u8005\u53EA\u662F\u6DFB\u52A0\u65B0\u7684\u4F5C\u4E1A\u3002\u5982\u679C\u6211\u4EEC\u7684\u4FE1\u606F\u7531\u4E8E\u7F13\u5B58\u5EF6\u8FDF\u800C\u8FC7\u671F\uFF0C\u6211\u4EEC\u5C06\u5728\u83B7\u5F97\u6700\u65B0\u4FE1\u606F\u65F6\u91CD\u65B0\u6392\u961F\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>    <span class="token comment">// figure out how to run this job -- concurrency policy might forbid us from running</span>
    <span class="token comment">// multiple at the same time...</span>
    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ConcurrencyPolicy <span class="token operator">==</span> batchv1<span class="token punctuation">.</span>ForbidConcurrent <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>activeJobs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;concurrency policy blocks concurrent runs, skipping&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;num active&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>activeJobs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...or instruct us to replace existing ones...</span>
    <span class="token keyword">if</span> cronJob<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>ConcurrencyPolicy <span class="token operator">==</span> batchv1<span class="token punctuation">.</span>ReplaceConcurrent <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> activeJob <span class="token operator">:=</span> <span class="token keyword">range</span> activeJobs <span class="token punctuation">{</span>
            <span class="token comment">// we don&#39;t care if the job was already deleted</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> activeJob<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">PropagationPolicy</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>DeletePropagationBackground<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> client<span class="token punctuation">.</span><span class="token function">IgnoreNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to delete active job&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> activeJob<span class="token punctuation">)</span>
                <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E00\u65E6\u6211\u4EEC\u5F04\u6E05\u695A\u4E86\u5982\u4F55\u5904\u7406\u73B0\u6709\u7684\u5DE5\u4F5C\uFF0C\u6211\u4EEC\u5B9E\u9645\u4E0A\u5C31\u4F1A\u521B\u9020\u51FA\u6211\u4EEC\u60F3\u8981\u7684\u5DE5\u4F5C</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// constructJobForCronJob</span>
    <span class="token comment">// actually make the job...</span>
    job<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">constructJobForCronJob</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cronJob<span class="token punctuation">,</span> missedRun<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to construct job from template&quot;</span><span class="token punctuation">)</span>
        <span class="token comment">// don&#39;t bother requeuing until we get a change to the spec</span>
        <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...and create it on the cluster</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;unable to create Job for CronJob&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ctrl<span class="token punctuation">.</span>Result<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    log<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;created Job for CronJob run&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5F53\u6211\u4EEC\u770B\u5230\u4E00\u4E2A\u6B63\u5728\u8FD0\u884C\u7684\u4F5C\u4E1A\u6216\u8005\u5230\u4E86\u4E0B\u4E00\u4E2A\u8BA1\u5212\u8FD0\u884C\u7684\u65F6\u95F4\u65F6\u91CD\u65B0\u6392\u961F" tabindex="-1"><a class="header-anchor" href="#\u5F53\u6211\u4EEC\u770B\u5230\u4E00\u4E2A\u6B63\u5728\u8FD0\u884C\u7684\u4F5C\u4E1A\u6216\u8005\u5230\u4E86\u4E0B\u4E00\u4E2A\u8BA1\u5212\u8FD0\u884C\u7684\u65F6\u95F4\u65F6\u91CD\u65B0\u6392\u961F" aria-hidden="true">#</a> \u5F53\u6211\u4EEC\u770B\u5230\u4E00\u4E2A\u6B63\u5728\u8FD0\u884C\u7684\u4F5C\u4E1A\u6216\u8005\u5230\u4E86\u4E0B\u4E00\u4E2A\u8BA1\u5212\u8FD0\u884C\u7684\u65F6\u95F4\u65F6\u91CD\u65B0\u6392\u961F</h3><p>\u6700\u540E\uFF0C\u6211\u4EEC\u5C06\u8FD4\u56DE\u4E0A\u9762\u51C6\u5907\u7684\u7ED3\u679C\uFF0C\u5B83\u8868\u793A\u6211\u4EEC\u5E0C\u671B\u5728\u4E0B\u4E00\u6B21\u8FD0\u884C\u65F6\u91CD\u65B0\u6392\u961F\u3002</p><p>\u8FD9\u662F\u4E00\u4E2A\u6700\u5927\u7684\u671F\u9650--\u5982\u679C\u5728\u8FD9\u671F\u95F4\u53D1\u751F\u4E86\u5176\u4ED6\u53D8\u5316\uFF0C\u6BD4\u5982\u6211\u4EEC\u7684\u5DE5\u4F5C\u5F00\u59CB\u6216\u7ED3\u675F\uFF0C\u6211\u4EEC\u88AB\u4FEE\u6539\uFF0C\u7B49\u7B49\uFF0C\u6211\u4EEC\u53EF\u80FD\u4F1A\u66F4\u5FEB\u5730\u518D\u6B21\u534F\u8C03\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>    <span class="token comment">// we&#39;ll requeue once we see the running job, and update our status</span>
    <span class="token keyword">return</span> scheduledResult<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u542F\u52A8-controller" tabindex="-1"><a class="header-anchor" href="#\u542F\u52A8-controller" aria-hidden="true">#</a> \u542F\u52A8 Controller</h3><p>\u63A5\u4E0B\u6765\u6211\u4EEC\u53EF\u4EE5\u542F\u52A8\u8FD9\u4E2A Controller \u6765\u770B\u4E00\u4E0B\u6548\u679C</p><p>\u76F4\u63A5\u8FD0\u884C <code>make run</code> \u5373\u53EF\u8FD0\u884C\u4EE3\u7801\uFF0C\u518D\u7EC8\u7AEF\u4E2D\u53EF\u4EE5\u770B\u5230\u65E5\u5FD7\u8F93\u51FA\u3002</p><p>\u67E5\u770B Pod \u662F\u5426\u6210\u529F\u521B\u5EFA\u51FA\u6765\u4E86\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kubectl get pod 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u90E8\u7F72-controller" tabindex="-1"><a class="header-anchor" href="#\u90E8\u7F72-controller" aria-hidden="true">#</a> \u90E8\u7F72 Controller</h3><p>\u6211\u4EEC\u5C06\u5176\u90E8\u7F72\u4E86\u4E86\u4E00\u4E2A \u793A\u4F8B\uFF0C\u4E5F\u8FD0\u884C Controller \u770B\u5230\u4E86\u76F8\u5E94\u7684 \u526F\u672C Pod \u88AB\u521B\u5EFA\u51FA\u6765\u4E86\uFF0C\u73B0\u5728\u6211\u4EEC\u8FDB\u4E00\u6B65\u6A21\u62DF Operator \u5B9E\u9645\u4F7F\u7528\u65F6\u7684\u90E8\u7F72\u65B9\u5F0F\uFF0C\u628A Controller \u6253\u5305\u540E\u4EE5 container \u7684\u65B9\u5F0F\u90E8\u7F72\u5230 Kubernetes \u96C6\u7FA4\u73AF\u5883\u4E2D\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u6784\u5EFA\u955C\u50CF</span>
<span class="token function">make</span> docker-build <span class="token assign-left variable">IMG</span><span class="token operator">=</span>application-operator:v0.0.1

<span class="token comment"># \u63A8\u9001\u5230 Kind \u73AF\u5883</span>
kind load docker-image

<span class="token comment"># \u90E8\u7F72 controller </span>
<span class="token function">make</span> deploy <span class="token assign-left variable">IMG</span><span class="token operator">=</span>application-operator:v0.0.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u8865\u5145\uFF1A\u6211\u4EEC\u53EF\u4EE5\u5728 dockerfile \u4E2D\u89E3\u51B3Go\u8BED\u8A00\u7684\u4EE3\u7406\u95EE\u9898\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>ENV <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.op
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="\u8D44\u6E90\u6E05\u7406" tabindex="-1"><a class="header-anchor" href="#\u8D44\u6E90\u6E05\u7406" aria-hidden="true">#</a> \u8D44\u6E90\u6E05\u7406</h3><p>\u4E0A\u9762\u6709\u8BB2\u8FC7\uFF0C\u7528 Makefile \u547D\u4EE4\u6E05\u7406\u8FD8\u662F\u5F88\u65B9\u4FBF\u7684\uFF0C\u6211\u4EEC\u76F4\u63A5\u6E05\u7406\u5C31\u597D\u4E86\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u5378\u8F7D controller</span>
<span class="token function">make</span> undeploy

<span class="token comment"># \u5378\u8F7D CRD</span>
<span class="token function">make</span> uninstall
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="client-go" tabindex="-1"><a class="header-anchor" href="#client-go" aria-hidden="true">#</a> Client-go</h2><p>Kubeilder \u5DF2\u7ECF\u5C4F\u853D\u4E86 client-go \u7684\u7EC6\u8282\uFF0C\u4F46\u662F\u5982\u679C\u5E0C\u671B\u6DF1\u5165\u638C\u63E1 Operator \u5F00\u53D1\u673A\u5236\uFF0C\u8FD8\u662F\u9700\u8981\u5BF9 Client-go \u719F\u6089\u7684\u3002</p><p>\u8FD9\u662F\u4E00\u7BC7\u8FD8\u6CA1\u5165\u95E8\u7684\u6982\u5FF5\u4E86\u89E3\u7B14\u8BB0\uFF1A</p>`,119),sn={href:"https://docker.nsddd.top/Cloud-Native-k8s/35.html",target:"_blank",rel:"noopener noreferrer"},an=s("\u7B14\u8BB0\u90E8\u5206 ~"),en=n("p",null,"Kubernetes API\u662F\u4E00\u7EC4REST API\uFF0C\u7528\u4E8E\u4E0EKubernetes\u96C6\u7FA4\u4EA4\u4E92\u3002\u8FD9\u4E9BAPI\u5141\u8BB8\u5F00\u53D1\u4EBA\u5458\u6267\u884C\u5404\u79CD\u64CD\u4F5C\uFF0C\u5305\u62EC\u7BA1\u7406Pod\u3001Deployment\u3001Service\u3001Namespace\u7B49\u3002Kubernetes API\u7531\u4E00\u7EC4\u8D44\u6E90\u5BF9\u8C61\u8868\u793A\uFF0C\u4F8B\u5982Pod\u3001Service\u3001ReplicaSet\u7B49\u3002\u8FD9\u4E9B\u8D44\u6E90\u5BF9\u8C61\u7531Kubernetes API Server\u7BA1\u7406\uFF0C\u5E76\u53EF\u4EE5\u901A\u8FC7kubectl\u7B49\u5DE5\u5177\u8FDB\u884C\u67E5\u8BE2\u548C\u4FEE\u6539\u3002",-1),tn=n("thead",null,[n("tr",null,[n("th",null,"\u65B9\u5F0F"),n("th",null,"\u7279\u70B9"),n("th",null,"\u652F\u6301\u8005")])],-1),on=n("tr",null,[n("td",null,"Kubernetes dashboard"),n("td",null,"\u76F4\u63A5\u901A\u8FC7Web UI\u8FDB\u884C\u64CD\u4F5C\uFF0C\u7B80\u5355\u76F4\u63A5\uFF0C\u53EF\u5B9A\u5236\u5316\u7A0B\u5EA6\u4F4E"),n("td",null,"\u5B98\u65B9\u652F\u6301")],-1),pn=n("tr",null,[n("td",null,"kubectl"),n("td",null,"\u547D\u4EE4\u884C\u64CD\u4F5C\uFF0C\u529F\u80FD\u6700\u5168\uFF0C\u4F46\u662F\u6BD4\u8F83\u590D\u6742\uFF0C\u9002\u5408\u5BF9\u5176\u8FDB\u884C\u8FDB\u4E00\u6B65\u7684\u5206\u88C5\uFF0C\u5B9A\u5236\u529F\u80FD\uFF0C\u7248\u672C\u9002\u914D\u6700\u597D"),n("td",null,"\u5B98\u65B9\u652F\u6301")],-1),cn={href:"https://github.com/kubernetes/client-go",target:"_blank",rel:"noopener noreferrer"},ln=s("client-go"),un=n("td",null,"\u4ECEkubernetes\u7684\u4EE3\u7801\u4E2D\u62BD\u79BB\u51FA\u6765\u7684\u5BA2\u6237\u7AEF\u5305\uFF0C\u7B80\u5355\u6613\u7528\uFF0C\u4F46\u9700\u8981\u5C0F\u5FC3\u533A\u5206kubernetes\u7684API\u7248\u672C",-1),rn=n("td",null,"\u5B98\u65B9\u652F\u6301",-1),dn=t(`<blockquote><p>Kubernetes API Server \u63D0\u4F9B\u7684\u662F\u9ED8\u8BA4\u7684 HTTPS \u670D\u52A1\uFF0C\u800C\u4E14\u662F\u53CC\u5411\u7684 TLS \u8BA4\u8BC1\uFF0C\u800C\u6211\u4EEC\u76EE\u524D\u7684\u5173\u6CE8\u70B9\u662F API \u672C\u8EAB\uFF0C\u56E0\u6B64\u5148\u901A\u8FC7 Kubectl \u6765\u4EE3\u7406 API Server \u670D\u52A1\u3002</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F kubectl proxy <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">8080</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>\u63A5\u4E0B\u6765\u5C31\u53EF\u4EE5\u901A\u8FC7\u7B80\u5355\u7684 HTTP \u8BF7\u6C42\u6765\u548C API Server \u4EA4\u4E92\u4E86\uFF1A</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">curl</span> localhost:8080/version
<span class="token punctuation">{</span>
  <span class="token string">&quot;major&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
  <span class="token string">&quot;minor&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;19&quot;</span>,
  <span class="token string">&quot;gitVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1.19.16&quot;</span>,
  <span class="token string">&quot;gitCommit&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;e37e4ab4cc8dcda84f1344dda47a97bb1927d074&quot;</span>,
  <span class="token string">&quot;gitTreeState&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;clean&quot;</span>,
  <span class="token string">&quot;buildDate&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2022-10-26T15:40:32Z&quot;</span>,
  <span class="token string">&quot;goVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;go1.15.15&quot;</span>,
  <span class="token string">&quot;compiler&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;gc&quot;</span>,
  <span class="token string">&quot;platform&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;linux/amd64&quot;</span>
<span class="token punctuation">}</span><span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u53EF\u80FD\u8FD8\u9700\u8981\u4E00\u4E2A\u914D\u7F6E\u6587\u4EF6\u6765\u63CF\u8FF0 Deployment \u8D44\u6E90\uFF0C\u5728\u672C\u5730\u521B\u5EFA\u4E00\u4E2A <code>nginx-deploy.yaml</code> \u6587\u4EF6:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u521B\u5EFA\u5B83\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F kubectl create <span class="token parameter variable">-f</span> nginx-deploy.yaml
deployment.apps/nginx-deployment created
\u276F k get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
my-nginx-app       <span class="token number">0</span>/3     <span class="token number">3</span>            <span class="token number">0</span>           23h
nginx-deployment   <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           19s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Deployment \u521B\u5EFA\u7684 API \u548C \u5728 Kubernetes \u4E2D API \u7684\u8DEF\u5F84\u4E00\u6837\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>POST /apis/apps/v1/namespace/{namespace}/deployment
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>Kubernetes\u4E2D\u4F7F\u7528\u7684 RESTful \u63A5\u53E3\u66F4\u65B0\u8FD9\u4E9B\u5BF9\u8C61\uFF0C\u5305\u62EC\u64CD\u4F5C\uFF1A</p><div class="language-markdown ext-md line-numbers-mode"><pre class="language-markdown"><code><span class="token list punctuation">-</span> GET\uFF1A\u4ECE\u670D\u52A1\u5668\u8BFB\u53D6\u4E00\u4E2A\u8D44\u6E90\u3002
<span class="token list punctuation">-</span> POST\uFF1A\u5728\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u8D44\u6E90\u3002
<span class="token list punctuation">-</span> PUT\uFF1A\u5728\u670D\u52A1\u5668\u4E0A\u66F4\u65B0\u4E00\u4E2A\u8D44\u6E90\u3002
<span class="token list punctuation">-</span> DELETE\uFF1A\u4ECE\u670D\u52A1\u5668\u5220\u9664\u4E00\u4E2A\u8D44\u6E90\u3002
<span class="token list punctuation">-</span> HEAD\uFF1A\u4ECE\u670D\u52A1\u5668\u8BFB\u53D6\u4E00\u4E2A\u8D44\u6E90\u7684\u5934\u4FE1\u606F\u3002
<span class="token list punctuation">-</span> PATCH\uFF1A\u5728\u670D\u52A1\u5668\u4E0A\u90E8\u5206\u66F4\u65B0\u4E00\u4E2A\u8D44\u6E90\u3002
<span class="token list punctuation">-</span> OPTIONS\uFF1A\u5217\u51FA\u670D\u52A1\u5668\u652F\u6301\u7684\u65B9\u6CD5\u548C\u529F\u80FD\u3002
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><p>\u65E2\u7136\u60F3\u5C1D\u8BD5 kubectl\uFF0C\u90A3\u4E48\u6765\u70B9\u65B0\u82B1\u6837\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">curl</span> localhost:8080/apis/apps/v1/namespaces/default/deployments/nginx-deploymen
<span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Status&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>,
  <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>,
  <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Failure&quot;</span>,
  <span class="token string">&quot;message&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;deployments.apps <span class="token entity" title="\\&quot;">\\&quot;</span>nginx-deploymen<span class="token entity" title="\\&quot;">\\&quot;</span> not found&quot;</span>,
  <span class="token string">&quot;reason&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;NotFound&quot;</span>,
  <span class="token string">&quot;details&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;nginx-deploymen&quot;</span>,
    <span class="token string">&quot;group&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;apps&quot;</span>,
    <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;deployments&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;code&quot;</span><span class="token builtin class-name">:</span> <span class="token number">404</span>
<span class="token punctuation">}</span><span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u8D44\u6E90\u521B\u5EFA\uFF1A</strong></p><p>Depolyment \u7684\u521B\u5EFA API \u662F\uFF1A<code>apps/v1</code> \u4E2D\u7684 Deployment\u3002</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>POST /apis/apps/v1/namespaces/<span class="token punctuation">{</span>namespace<span class="token punctuation">}</span>/deployments
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6267\u884C\u4EE5\u4E0B\u547D\u4EE4\u5728 default \u547D\u540D\u7A7A\u95F4\u4E0B\u521B\u5EFA\u4E00\u4E2A deployment\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token parameter variable">--header</span> <span class="token string">&#39;Content-Type: application/yaml&#39;</span> --data-binary @nginx-deploy.yaml http://localhost:8080/apis/apps/v1/namespaces/default/deployments
<span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Status&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>,
  <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>,
  <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Failure&quot;</span>,
  <span class="token string">&quot;message&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;deployments.apps <span class="token entity" title="\\&quot;">\\&quot;</span>nginx-deployment<span class="token entity" title="\\&quot;">\\&quot;</span> already exists&quot;</span>,
  <span class="token string">&quot;reason&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;AlreadyExists&quot;</span>,
  <span class="token string">&quot;details&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;nginx-deployment&quot;</span>,
    <span class="token string">&quot;group&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;apps&quot;</span>,
    <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;deployments&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;code&quot;</span><span class="token builtin class-name">:</span> <span class="token number">409</span>
<span class="token punctuation">}</span><span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="sample-controller" tabindex="-1"><a class="header-anchor" href="#sample-controller" aria-hidden="true">#</a> sample-controller</h2><p>\u6211\u4EEC\u5C06\u7528\u4E8E\u5B9E\u9A8C\u521B\u5EFA\u64CD\u4F5C\u7B26\u7684\u7B2C\u4E00\u4E2A\u5DE5\u5177\u662Fsample-controller\uFF0C\u4F60\u53EF\u4EE5\u5728\u8FD9\u91CC\u627E\u5230\uFF1Ahttps://github.com/kubernetes/sample-controller\u3002</p><p>\u8FD9\u4E2A\u9879\u76EE\u4E3A <code>Foo</code> \u7C7B\u578B\u5B9E\u73B0\u4E86\u4E00\u4E2A\u7B80\u5355\u7684\u64CD\u4F5C\u7B26\uFF0C\u5F53\u6211\u4EEC\u521B\u5EFA\u4E00\u4E2A\u81EA\u5B9A\u4E49\u5BF9\u8C61 <code>foo</code> \u65F6\uFF0C\u5B83\u5C06\u521B\u5EFA\u4E00\u4E2A\u5E26\u6709\u4E00\u4E9B\u516C\u5171Docker\u955C\u50CF\u548C\u7279\u5B9A\u6570\u91CF\u526F\u672C\u7684\u90E8\u7F72\u3002</p><p>\u6211\u4EEC\u5728\u4E0A\u9762\u5DF2\u7ECF\u4E0B\u8F7D\u8FC7\uFF0C\u73B0\u5728\u6211\u5C1D\u8BD5\u7F16\u8BD1\u5B83\uFF1A</p><blockquote><p>go version: <code> gvm use go1.20</code></p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token builtin class-name">export</span> <span class="token assign-left variable">SAMPLE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>/sample-controller
\u276F <span class="token function">git</span> clone https://github.com/cubxxw/sample-controller.git <span class="token variable">$SAMPLE</span>  <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$SAMPLE</span><span class="token punctuation">;</span>
\u276F go build <span class="token parameter variable">-o</span> ctrl <span class="token builtin class-name">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u6211\u4EEC\u521B\u5EFA\u4E00\u4E2A CRD\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F kubectl apply <span class="token parameter variable">-f</span> artifacts/examples/crd-status-subresource.yaml
customresourcedefinition.apiextensions.k8s.io/foos.samplecontroller.k8s.io created
\u276F k get CustomResourceDefinition
NAME                           CREATED AT
crontabs.stable.example.com    <span class="token number">2023</span>-04-07T09:17:55Z
foos.samplecontroller.k8s.io   <span class="token number">2023</span>-04-08T12:09:46Z
guestbooks.webapp.my.domain    <span class="token number">2023</span>-04-07T15:42:22Z
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u6211\u4EEC\u8FD0\u884C\u63A7\u5236\u5668\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>./ctrl <span class="token parameter variable">-kubeconfig</span> ~/.kube/config  <span class="token parameter variable">-logtostderr</span><span class="token operator">=</span>true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p><code>-logtostderr=true</code>\uFF1A\u5C06\u65E5\u5FD7\u8BB0\u5F55\u5230\u6807\u51C6\u9519\u8BEF\u800C\u4E0D\u662F\u6587\u4EF6(\u9ED8\u8BA4\u4E3Atrue)</p></blockquote><p>\u73B0\u5728\uFF0C\u6211\u4EEC\u53EF\u4EE5\u5728\u53E6\u4E00\u4E2A\u7EC8\u7AEF\u4E0A\u64CD\u4F5C <code>Foo</code> \u5BF9\u8C61\uFF0C\u770B\u770B\u63A7\u5236\u5668\u4F1A\u53D1\u751F\u4EC0\u4E48\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F kubectl apply <span class="token parameter variable">-f</span> artifacts/examples/example-foo.yaml
foo.samplecontroller.k8s.io/example-foo created
\u276F k get Foo
NAME          AGE
example-foo   9s

<span class="token comment"># ----- \u5220\u9664 Foo -------</span>
\u276F kubectl delete <span class="token parameter variable">-f</span> artifacts/examples/example-foo.yaml
foo.samplecontroller.k8s.io <span class="token string">&quot;example-foo&quot;</span> deleted
\u276F k get pod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;Foo&quot;</span>
\u276F k get Foo
No resources found <span class="token keyword">in</span> default namespace.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u5728\u7F16\u5199\u548C\u4F7F\u7528Kubernetes 1.11.0\u65F6\uFF0C\u63A7\u5236\u5668\u5C06\u5728\u521B\u5EFA\u90E8\u7F72\u540E\u66F4\u65B0 <code>foo</code> \u5BF9\u8C61\u7684\u72B6\u6001\u65F6\u8FDB\u5165\u65E0\u9650\u5FAA\u73AF\uFF1A\u5728 <code>updateFooStatus</code> \u51FD\u6570\u4E2D\uFF0C\u4F60\u5FC5\u987B\u901A\u8FC7\u8C03\u7528 <code>UpdateStatus(fooCopy)</code> \u6765\u66F4\u6539\u5BF9 <code>Update(fooCopy)</code> \u7684\u8C03\u7528\u3002</p></blockquote><p><strong>\u5F88\u597D\u7406\u89E3\u4E0D\u662F\u5417\uFF0Capply \u58F0\u660E\u5F0F\u5728 controller \u4E2D\u4E5F\u662F\u901A\u8FC7 for \u5FAA\u73AF\u4E0D\u65AD\u7684\u8FDB\u884C\u6821\u9A8C\u3002\u68C0\u67E5 status \u548C spec \u7684\u533A\u522B\uFF0C\u662F\u5426\u8FBE\u6210\u4E00\u81F4\u3002</strong></p><p>\u6211\u627E\u51FA\u5B98\u65B9\u7684\u6700\u7B80\u5355\u7684\u6848\u4F8B\u62FF\u51FA\u6765\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">{</span>
  desired <span class="token operator">:=</span> <span class="token function">getDesiredState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">// \u671F\u671B\u72B6\u6001</span>
  current <span class="token operator">:=</span> <span class="token function">getCurrentState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">// \u5B9E\u9645\u72B6\u6001</span>
  <span class="token function">makeChanges</span><span class="token punctuation">(</span>desired<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token comment">// \u8C03\u8C10\u8FC7\u7A0B</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u53EF\u4EE5\u770B\u51FA\u672C\u8D28\u4E0A\u5C31\u662F\u4E00\u4E2A\u5FAA\u73AF\uFF0C\u901A\u8FC7 <code>getDesiredState()</code> \u83B7\u53D6\u5230 spec \u4E2D\u7684\u671F\u671B\u72B6\u6001\uFF0C\u901A\u8FC7 <code>getCurrentState()</code> \u83B7\u53D6\u5230 status \u5F53\u524D\u96C6\u7FA4\u7684\u5B9E\u9645\u72B6\u6001\uFF0C\u7136\u540E\u8FDB\u884C\u8C03\u8C10\u3002</p></blockquote><p>\u5230\u76EE\u524D\u4E3A\u6B62\u4E00\u5207\u987A\u5229\uFF0C\u63A7\u5236\u5668\u4F7F\u5DE5\u4F5C\uFF1A\u5F53\u6211\u4EEC\u521B\u5EFA <code>foo</code> \u5BF9\u8C61\u65F6\uFF0C\u5B83\u4F1A\u521B\u5EFA\u4E00\u4E2A\u90E8\u7F72\uFF0C\u5F53\u6211\u4EEC\u5220\u9664\u8BE5\u5BF9\u8C61\u65F6\uFF0C\u5B83\u4F1A\u505C\u6B62\u90E8\u7F72\u3002</p><p>\u73B0\u5728\u6211\u4EEC\u53EF\u4EE5\u8FDB\u4E00\u6B65\u8C03\u6574CRD\u548C\u63A7\u5236\u5668\uFF0C\u4EE5\u4F7F\u7528\u6211\u4EEC\u81EA\u5DF1\u7684\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49\u3002</p><p>\u5047\u8BBE\u6211\u4EEC\u7684\u76EE\u6807\u662F\u7F16\u5199\u4E00\u4E2A <code>operator</code> \uFF0C\u5B83 \u5C06\u5728\u96C6\u7FA4\u7684\u8282\u70B9\u4E0A\u90E8\u7F72\u4E00\u4E2A\u5B88\u62A4\u8FDB\u7A0B\u3002\u5B83\u5C06\u4F7F\u7528 <code>DaemonSet</code> \u5BF9\u8C61\u6765\u90E8\u7F72\u6B64\u5B88\u62A4\u8FDB\u7A0B\uFF0C\u6211\u4EEC\u5E0C\u671B\u80FD\u591F\u6307\u5B9A\u4E00\u4E2A\u6807\u7B7E\uFF0C\u4EE5\u4FBF\u4EC5\u5728\u6807\u8BB0\u6709\u6B64\u6807\u7B7E\u7684\u8282\u70B9\u4E0A\u90E8\u7F72\u5B88\u62A4\u8FDB\u7A0B\u3002\u6211\u4EEC\u8FD8\u5E0C\u671B\u80FD\u591F\u6307\u5B9A\u8981\u90E8\u7F72\u7684 Docker \u955C\u50CF\uFF0C\u800C\u4E0D\u662F\u50CF<code>sample-controller</code>\u90A3\u6837\u4F7F\u7528\u9759\u6001\u955C\u50CF\u3002</p><p>\u8BA9\u6211\u4EEC\u9996\u5148\u4E3A <code>GenericDaemon</code> \u7C7B\u578B\u521B\u5EFA\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>\u276F cat artifacts/generic<span class="token punctuation">-</span>daemon/crd.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> genericdaemons.mydomain.com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> mydomain.com
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1beta1
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Genericdaemon
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> genericdaemons
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
  <span class="token key atrule">validation</span><span class="token punctuation">:</span>
    <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span>
      <span class="token key atrule">properties</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">properties</span><span class="token punctuation">:</span>
            <span class="token key atrule">label</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
            <span class="token key atrule">image</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
          <span class="token key atrule">required</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> image
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0B\u9762\u662F\u8981\u90E8\u7F72\u7684\u5B88\u62A4\u8FDB\u7A0B\u7684\u7B2C\u4E00\u4E2A\u793A\u4F8B\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>// artifacts/generic<span class="token punctuation">-</span>daemon/syslog.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> mydomain.com/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Genericdaemon
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> syslog
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">label</span><span class="token punctuation">:</span> logs
  <span class="token key atrule">image</span><span class="token punctuation">:</span> mbessler/syslogdocker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728\u6211\u4EEC\u5FC5\u987B\u4E3AAPI\u6784\u5EFAgo\u6587\u4EF6\uFF0C\u4EE5\u4FBF\u4ECE\u64CD\u4F5C\u7B26\u8BBF\u95EE\u8FD9\u4E2A\u65B0\u7684\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49\u3002\u4E3A\u6B64\uFF0C\u8BA9\u6211\u4EEC\u521B\u5EFA\u4E00\u4E2A\u65B0\u76EE\u5F55 <code>pkg/apis/genericdaemon</code> \uFF0C\u6211\u4EEC\u5C06\u5728\u5176\u4E2D\u590D\u5236\u5728 <code>pkg/apis/samplecontroller</code> \u4E2D\u627E\u5230\u7684\u6587\u4EF6\uFF08\u4F46\u4E0D\u5305\u62EC <code>zz_generated.deepcopy.go</code> \uFF09</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>\u276F  tree pkg<span class="token operator">/</span>apis<span class="token operator">/</span>genericdaemon<span class="token operator">/</span>
pkg<span class="token operator">/</span>apis<span class="token operator">/</span>genericdaemon<span class="token operator">/</span>
\u251C\u2500\u2500 register<span class="token punctuation">.</span><span class="token keyword">go</span>
\u2514\u2500\u2500 v1alpha1
    \u251C\u2500\u2500 doc<span class="token punctuation">.</span><span class="token keyword">go</span>
    \u251C\u2500\u2500 register<span class="token punctuation">.</span><span class="token keyword">go</span>
    \u2514\u2500\u2500 types<span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5E76\u8C03\u6574\u5176\u5185\u5BB9\uFF08\u66F4\u6539\u7684\u90E8\u5206\u4EE5\u7C97\u4F53\u663E\u793A\uFF09\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">////////////////</span>
<span class="token comment">// register.go</span>
<span class="token comment">////////////////</span>
<span class="token keyword">package</span> genericdaemon
<span class="token keyword">const</span> <span class="token punctuation">(</span>
 GroupName <span class="token operator">=</span> <span class="token string">&quot;mydomain.com&quot;</span>
<span class="token punctuation">)</span>
<span class="token comment">/////////////////////</span>
<span class="token comment">// v1beta1/doc.go</span>
<span class="token comment">/////////////////////</span>
<span class="token comment">// +k8s:deepcopy-gen=package</span>
<span class="token comment">// Package v1beta1 is the v1beta1 version of the API.</span>
<span class="token comment">// +groupName=mydomain.com</span>
<span class="token keyword">package</span> v1beta1
<span class="token comment">/////////////////////////</span>
<span class="token comment">// v1beta1/register.go</span>
<span class="token comment">/////////////////////////</span>
<span class="token keyword">package</span> v1beta1
<span class="token keyword">import</span> <span class="token punctuation">(</span>
 metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
 <span class="token string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span>
 <span class="token string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span>
genericdaemon <span class="token string">&quot;k8s.io/sample-controller/pkg/apis/genericdaemon&quot;</span>
<span class="token punctuation">)</span>
<span class="token comment">// SchemeGroupVersion is group version used to register these objects</span>
<span class="token keyword">var</span> SchemeGroupVersion <span class="token operator">=</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> genericdaemon<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> <span class="token string">&quot;v1beta1&quot;</span><span class="token punctuation">}</span>
<span class="token comment">// Kind takes an unqualified kind and returns back a Group qualified GroupKind</span>
<span class="token keyword">func</span> <span class="token function">Kind</span><span class="token punctuation">(</span>kind <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupKind <span class="token punctuation">{</span>
 <span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Resource takes an unqualified resource and returns a Group qualified GroupResource</span>
<span class="token keyword">func</span> <span class="token function">Resource</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupResource <span class="token punctuation">{</span>
 <span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token punctuation">(</span>
 SchemeBuilder <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewSchemeBuilder</span><span class="token punctuation">(</span>addKnownTypes<span class="token punctuation">)</span>
 AddToScheme   <span class="token operator">=</span> SchemeBuilder<span class="token punctuation">.</span>AddToScheme
<span class="token punctuation">)</span>
<span class="token comment">// Adds the list of known types to Scheme.</span>
<span class="token keyword">func</span> <span class="token function">addKnownTypes</span><span class="token punctuation">(</span>scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
 scheme<span class="token punctuation">.</span><span class="token function">AddKnownTypes</span><span class="token punctuation">(</span>SchemeGroupVersion<span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>Genericdaemon<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>GenericdaemonList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">)</span>
 metav1<span class="token punctuation">.</span><span class="token function">AddToGroupVersion</span><span class="token punctuation">(</span>scheme<span class="token punctuation">,</span> SchemeGroupVersion<span class="token punctuation">)</span>
 <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">//////////////////////</span>
<span class="token comment">// v1beta1/types.go</span>
<span class="token comment">//////////////////////</span>
<span class="token keyword">package</span> v1beta1
<span class="token keyword">import</span> <span class="token punctuation">(</span>
 metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
<span class="token punctuation">)</span>
<span class="token comment">// +genclient</span>
<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="token comment">// Genericdaemon is a specification for a Generic Daemon resource</span>
<span class="token keyword">type</span> Genericdaemon <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 metav1<span class="token punctuation">.</span>TypeMeta   <span class="token string">\`json:&quot;,inline&quot;\`</span>
 metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">\`json:&quot;metadata,omitempty&quot;\`</span>
 Spec   GenericdaemonSpec   <span class="token string">\`json:&quot;spec&quot;\`</span>
 Status GenericdaemonStatus <span class="token string">\`json:&quot;status&quot;\`</span>
<span class="token punctuation">}</span>
<span class="token comment">// GenericDaemonSpec is the spec for a GenericDaemon resource</span>
<span class="token keyword">type</span> GenericdaemonSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 Label <span class="token builtin">string</span> <span class="token string">\`json:&quot;label&quot;\`</span>
 Image <span class="token builtin">string</span> <span class="token string">\`json:&quot;image&quot;\`</span>
<span class="token punctuation">}</span>
<span class="token comment">// GenericDaemonStatus is the status for a GenericDaemon resource</span>
<span class="token keyword">type</span> GenericdaemonStatus <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 Installed <span class="token builtin">int32</span> <span class="token string">\`json:&quot;installed&quot;\`</span>
<span class="token punctuation">}</span>
<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>
<span class="token comment">// GenericDaemonList is a list of GenericDaemon resources</span>
<span class="token keyword">type</span> GenericdaemonList <span class="token keyword">struct</span> <span class="token punctuation">{</span>
 metav1<span class="token punctuation">.</span>TypeMeta <span class="token string">\`json:&quot;,inline&quot;\`</span>
 metav1<span class="token punctuation">.</span>ListMeta <span class="token string">\`json:&quot;metadata&quot;\`</span>
Items <span class="token punctuation">[</span><span class="token punctuation">]</span>Genericdaemon <span class="token string">\`json:&quot;items&quot;\`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u518D\u6765\u770B\u770B\u5B83\u4E3A\u6211\u4EEC\u63D0\u4F9B\u4E86\u54EA\u4E9B\u53EF\u7528\u7684\u811A\u672C:</p>`,48),kn=s("\u5B83\u4F7F\u7528www.example.com\u4E2D\u7684\u751F\u6210\u5668"),mn={href:"https://github.com/kubernetes/code-generator",target:"_blank",rel:"noopener noreferrer"},vn=s("k8s.io/code-generator"),bn=s(" \u751F\u6210\u4E00\u4E2A\u7C7B\u578B\u5316\u7684\u5BA2\u6237\u7AEF\u3001informers\u3001listers\u548Cdeep-copy\u51FD\u6570\u3002\u4F60\u53EF\u4EE5\u4F7F\u7528"),gn=n("code",null,"./hack/update-codegen.sh",-1),hn=s("\u811A\u672C\u81EA\u5DF1\u6267\u884C\u6B64\u64CD\u4F5C\u3002"),fn=t('<h3 id="\u4EE3\u7801\u751F\u6210\u5668" tabindex="-1"><a class="header-anchor" href="#\u4EE3\u7801\u751F\u6210\u5668" aria-hidden="true">#</a> \u4EE3\u7801\u751F\u6210\u5668</h3><p><code>k8s.io/client-go</code> \u63D0\u4F9B\u4E86\u5BF9 k8s \u539F\u751F\u8D44\u6E90\u7684informer\u548Cclientset\u7B49\u7B49\uFF0C\u4F46\u5BF9\u4E8E\u81EA\u5B9A\u4E49\u8D44\u6E90\u7684\u64CD\u4F5C\u5219\u76F8\u5BF9\u4F4E\u6548\uFF0C\u9700\u8981\u4F7F\u7528 rest api \u548C <code>dynamic client</code> \u6765\u64CD\u4F5C\uFF0C\u5E76\u81EA\u5DF1\u5B9E\u73B0\u53CD\u5E8F\u5217\u5316\u7B49\u529F\u80FD\u3002</p><p>code-generator \u63D0\u4F9B\u4E86\u4EE5\u4E0B\u5DE5\u5177\u7528\u4E8E\u4E3Ak8s\u4E2D\u7684\u8D44\u6E90\u751F\u6210\u76F8\u5173\u4EE3\u7801\uFF0C\u53EF\u4EE5\u66F4\u52A0\u65B9\u4FBF\u7684\u64CD\u4F5C\u81EA\u5B9A\u4E49\u8D44\u6E90\uFF1A</p><p><code>deepcopy-gen</code>: \u751F\u6210\u6DF1\u5EA6\u62F7\u8D1D\u5BF9\u8C61\u65B9\u6CD5 ~</p><p><strong>\u4F7F\u7528\u65B9\u6CD5\uFF1A</strong></p><ul><li>\u5728\u6587\u4EF6\u4E2D\u6DFB\u52A0\u6CE8\u91CA<code>// +k8s:deepcopy-gen=package</code></li><li>\u4E3A\u5355\u4E2A\u7C7B\u578B\u6DFB\u52A0\u81EA\u52A8\u751F\u6210<code>// +k8s:deepcopy-gen=true</code></li><li>\u4E3A\u5355\u4E2A\u7C7B\u578B\u5173\u95ED\u81EA\u52A8\u751F\u6210<code>// +k8s:deepcopy-gen=false</code></li></ul><p><code>client-gen</code>: \u4E3A\u8D44\u6E90\u751F\u6210\u6807\u51C6\u7684\u64CD\u4F5C\u65B9\u6CD5(get; list; watch; create; update; patch; delete)</p><blockquote><p>\u5728 <code>pkg/apis/${GROUP}/${VERSION}/types.go</code>\u4E2D\u4F7F\u7528\uFF0C\u4F7F\u7528<code>// +genclient</code>\u6807\u8BB0\u5BF9\u5E94\u7C7B\u578B\u751F\u6210\u7684\u5BA2\u6237\u7AEF\uFF0C \u5982\u679C\u4E0E\u8BE5\u7C7B\u578B\u76F8\u5173\u8054\u7684\u8D44\u6E90\u4E0D\u662F\u547D\u540D\u7A7A\u95F4\u8303\u56F4\u7684(\u4F8B\u5982PersistentVolume), \u5219\u8FD8\u9700\u8981\u9644\u52A0<code>// + genclient\uFF1AnonNamespaced</code>\u6807\u8BB0\uFF0C</p></blockquote><ul><li><p><code>// +genclient</code> - \u751F\u6210\u9ED8\u8BA4\u7684\u5BA2\u6237\u7AEF\u52A8\u4F5C\u51FD\u6570\uFF08create, update, delete, get, list, update, patch, watch\u4EE5\u53CA \u662F\u5426\u751F\u6210updateStatus\u53D6\u51B3\u4E8E.Status\u5B57\u6BB5\u662F\u5426\u5B58\u5728\uFF09\u3002</p></li><li><p><code>// +genclient:nonNamespaced</code> - \u6240\u6709\u52A8\u4F5C\u51FD\u6570\u90FD\u662F\u5728\u6CA1\u6709\u540D\u79F0\u7A7A\u95F4\u7684\u60C5\u51B5\u4E0B\u751F\u6210</p></li><li><p><code>// +genclient:onlyVerbs=create,get</code> - \u6307\u5B9A\u7684\u52A8\u4F5C\u51FD\u6570\u88AB\u751F\u6210.</p></li><li><p><code>// +genclient:skipVerbs=watch</code> - \u751F\u6210watch\u4EE5\u5916\u6240\u6709\u7684\u52A8\u4F5C\u51FD\u6570.</p></li><li><p><code>// +genclient:noStatus</code> - \u5373\u4F7F.<code>Status</code>\u5B57\u6BB5\u5B58\u5728\u4E5F\u4E0D\u751F\u6210<code>updateStatus</code>\u52A8\u4F5C\u51FD\u6570</p></li></ul><p><code>informer-gen</code>: \u751F\u6210<code>informer</code>\uFF0C\u63D0\u4F9B\u4E8B\u4EF6\u673A\u5236(AddFunc,UpdateFunc,DeleteFunc)\u6765\u54CD\u5E94kubernetes\u7684event</p><p><code>lister-gen</code>: \u4E3A <code>get</code> \u548C <code>list</code> \u65B9\u6CD5\u63D0\u4F9B\u53EA\u8BFB\u7F13\u5B58\u5C42</p><p><code>conversion-gen</code>\u662F\u7528\u4E8E\u81EA\u52A8\u751F\u6210\u5728\u5185\u90E8\u548C\u5916\u90E8\u7C7B\u578B\u4E4B\u95F4\u8F6C\u6362\u7684\u51FD\u6570\u7684\u5DE5\u5177</p><p>\u4E00\u822C\u7684\u8F6C\u6362\u4EE3\u7801\u751F\u6210\u4EFB\u52A1\u6D89\u53CA\u4E09\u5957\u7A0B\u5E8F\u5305\uFF1A</p><ul><li>\u4E00\u5957\u5305\u542B\u5185\u90E8\u7C7B\u578B\u7684\u7A0B\u5E8F\u5305\u3002</li><li>\u4E00\u5957\u5305\u542B\u5916\u90E8\u7C7B\u578B\u7684\u7A0B\u5E8F\u5305\u3002</li><li>\u5355\u4E2A\u76EE\u6807\u7A0B\u5E8F\u5305\uFF08\u5373\uFF0C\u751F\u6210\u7684\u8F6C\u6362\u51FD\u6570\u6240\u5728\u7684\u4F4D\u7F6E\uFF0C\u4EE5\u53CA\u5F00\u53D1\u4EBA\u5458\u6388\u6743\u7684\u8F6C\u6362\u529F\u80FD\u6240\u5728\u7684\u4F4D\u7F6E\uFF09\u3002\u5305\u542B\u5185\u90E8\u7C7B\u578B\u7684\u5305\u5728 <code>Kubernetes</code> \u7684\u5E38\u89C4\u4EE3\u7801\u751F\u6210\u6846\u67B6\u4E2D\u626E\u6F14\u7740\u79F0\u4E3A<code>peer package</code>\u7684\u89D2\u8272\u3002</li></ul><p>\u4F7F\u7528\u65B9\u6CD5\uFF1A</p><ul><li>\u6807\u8BB0\u8F6C\u6362\u5185\u90E8\u8F6F\u4EF6\u5305 <code>// +k8s:conversion-gen=&lt;import-path-of-internal-package&gt;</code></li><li>\u6807\u8BB0\u8F6C\u6362\u5916\u90E8\u8F6F\u4EF6\u5305<code>// +k8s:conversion-gen-external-types=&lt;import-path-of-external-package&gt;</code></li><li>\u6807\u8BB0\u4E0D\u8F6C\u6362\u5BF9\u5E94\u6CE8\u91CA\u6216\u7ED3\u6784 <code>// +k8s:conversion-gen=false</code></li></ul><p><code>defaulter-gen</code> \u7528\u4E8E\u751F\u4EA7Defaulter\u51FD\u6570</p><ul><li>\u4E3A\u5305\u542B\u5B57\u6BB5\u7684\u6240\u6709\u7C7B\u578B\u521B\u5EFAdefaulters\uFF0C<code>// +k8s:defaulter-gen=&lt;field-name-to-flag&gt;</code></li><li>\u6240\u6709\u90FD\u751F\u6210<code>// +k8s:defaulter-gen=true|false</code></li></ul><p><code>go-to-protobuf</code> \u901A\u8FC7go struct\u751F\u6210 pb idl</p><p><code>import-boss</code> \u5728\u7ED9\u5B9A\u5B58\u50A8\u5E93\u4E2D\u5F3A\u5236\u6267\u884C\u5BFC\u5165\u9650\u5236</p><p><code>openapi-gen</code> \u751F\u6210openAPI\u5B9A\u4E49</p><p>\u4F7F\u7528\u65B9\u6CD5\uFF1A</p><ul><li><code>+k8s:openapi-gen=true</code> \u4E3A\u6307\u5B9A\u5305\u6216\u65B9\u6CD5\u5F00\u542F</li><li><code>+k8s:openapi-gen=false</code> \u6307\u5B9A\u5305\u5173\u95ED</li></ul><p><code>register-gen</code> \u751F\u6210<code>register</code></p><p><code>set-gen</code></p>',25),yn=s("code-generator\u6574\u5408\u4E86\u8FD9\u4E9Bgen\uFF0C\u4F7F\u7528\u811A\u672C"),qn={href:"https://github.com/kubernetes/code-generator/blob/master/generate-groups.sh",target:"_blank",rel:"noopener noreferrer"},wn=s("generate-groups.sh"),Cn=s("\u548C"),Sn={href:"https://github.com/kubernetes/code-generator/blob/master/generate-internal-groups.sh",target:"_blank",rel:"noopener noreferrer"},xn=s("generate-internal-groups.sh"),_n=s("\u53EF\u4EE5\u4E3A\u81EA\u5B9A\u4E49\u8D44\u6E90\u751F\u4EA7\u76F8\u5173\u4EE3\u7801\u3002"),Rn=t(`<h3 id="\u811A\u672C\u81EA\u52A8\u751F\u6210" tabindex="-1"><a class="header-anchor" href="#\u811A\u672C\u81EA\u52A8\u751F\u6210" aria-hidden="true">#</a> \u811A\u672C\u81EA\u52A8\u751F\u6210</h3><p>\u811A\u672C <code>hack/update-codegen.sh</code> \u53EF\u7528\u4E8E\u56F4\u7ED5\u6211\u4EEC\u4F7F\u7528\u8FD9\u4E9B\u5148\u524D\u6587\u4EF6\u5B9A\u4E49\u7684\u65B0\u81EA\u5B9A\u4E49\u8D44\u6E90\u5B9A\u4E49\u751F\u6210\u4EE3\u7801\u3002\u6211\u4EEC\u5C06\u4E0D\u5F97\u4E0D\u8C03\u6574\u8FD9\u4E2A\u811A\u672C\u6765\u4E3A\u6211\u4EEC\u7684\u65B0 <code>CRD</code> \u751F\u6210\u6587\u4EF6\uFF1A</p><p><code>update-codegen</code>\u811A\u672C\u5C06\u81EA\u52A8\u751F\u6210\u4EE5\u4E0B\u6587\u4EF6&amp; \u76EE\u5F55\uFF1A</p><ul><li><code>pkg/apis/samplecontroller/v1alpha1/zz_generated.deepcopy.go</code></li><li><code>pkg/generated/</code></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>// hack/update<span class="token punctuation">-</span>codegen.sh
<span class="token comment">#!/usr/bin/env bash</span>
set <span class="token punctuation">-</span>o errexit
set <span class="token punctuation">-</span>o nounset
set <span class="token punctuation">-</span>o pipefail

SCRIPT_ROOT=$(dirname &quot;$<span class="token punctuation">{</span>BASH_SOURCE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>&quot;)/..
CODEGEN_PKG=$<span class="token punctuation">{</span>CODEGEN_PKG<span class="token punctuation">:</span><span class="token punctuation">-</span>$(cd &quot;$<span class="token punctuation">{</span>SCRIPT_ROOT<span class="token punctuation">}</span>&quot;; ls <span class="token punctuation">-</span>d <span class="token punctuation">-</span>1 ./vendor/k8s.io/code<span class="token punctuation">-</span>generator 2<span class="token punctuation">&gt;</span>/dev/null <span class="token punctuation">|</span><span class="token punctuation">|</span> echo ../code<span class="token punctuation">-</span>generator)<span class="token punctuation">}</span>

<span class="token comment"># generate the code with:</span>
<span class="token comment"># --output-base    because this script should also be able to run inside the vendor dir of</span>
<span class="token comment">#                  k8s.io/kubernetes. The output-base is needed for the generators to output into the vendor dir</span>
<span class="token comment">#                  instead of the $GOPATH directly. For normal projects this can be dropped.</span>
echo &quot;===<span class="token punctuation">&gt;</span> Generating code<span class="token punctuation">...</span>&quot;
&quot;$<span class="token punctuation">{</span>CODEGEN_PKG<span class="token punctuation">}</span>/generate<span class="token punctuation">-</span>groups.sh&quot; &quot;deepcopy<span class="token punctuation">,</span>client<span class="token punctuation">,</span>informer<span class="token punctuation">,</span>lister&quot; \\
  k8s.io/sample<span class="token punctuation">-</span>controller/pkg/generated \\
  k8s.io/sample<span class="token punctuation">-</span>controller/pkg/apis \\
  samplecontroller<span class="token punctuation">:</span>v1alpha1 \\
  <span class="token punctuation">-</span><span class="token punctuation">-</span>output<span class="token punctuation">-</span>base &quot;$(dirname &quot;$<span class="token punctuation">{</span>BASH_SOURCE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>&quot;)/../../..&quot; \\
  <span class="token punctuation">-</span><span class="token punctuation">-</span>go<span class="token punctuation">-</span>header<span class="token punctuation">-</span>file &quot;$<span class="token punctuation">{</span>SCRIPT_ROOT<span class="token punctuation">}</span>&quot;/hack/boilerplate.go.txt
<span class="token comment"># To use your own boilerplate text append:</span>
<span class="token comment">#   --go-header-file &quot;\${SCRIPT_ROOT}&quot;/hack/custom-boilerplate.go.txt</span>

echo &quot;===<span class="token punctuation">&gt;</span> Generating genericdaemon code&quot;
&quot;$<span class="token punctuation">{</span>CODEGEN_PKG<span class="token punctuation">}</span>/generate<span class="token punctuation">-</span>groups.sh&quot; &quot;deepcopy<span class="token punctuation">,</span>client<span class="token punctuation">,</span>informer<span class="token punctuation">,</span>lister&quot; \\
  k8s.io/sample<span class="token punctuation">-</span>controller/pkg/generated \\
  k8s.io/sample<span class="token punctuation">-</span>controller/pkg/apis \\
  genericdaemon<span class="token punctuation">:</span>v1beta1 \\
  <span class="token punctuation">-</span><span class="token punctuation">-</span>output<span class="token punctuation">-</span>base &quot;$(dirname &quot;$<span class="token punctuation">{</span>BASH_SOURCE<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>&quot;)/../../..&quot; \\
  <span class="token punctuation">-</span><span class="token punctuation">-</span>go<span class="token punctuation">-</span>header<span class="token punctuation">-</span>file &quot;$<span class="token punctuation">{</span>SCRIPT_ROOT<span class="token punctuation">}</span>&quot;/hack/boilerplate.go.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u6267\u884C\u5B83\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F ./hack/update-codegen.sh 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6211\u4EEC\u73B0\u5728\u53EF\u4EE5\u8C03\u6574\u6211\u4EEC\u7684<code>operator</code> \u3002\u9996\u5148\uFF0C\u6211\u4EEC\u5FC5\u987B\u5C06\u6240\u6709\u5BF9\u524D\u4E00\u4E2A <code>Foo</code> \u7C7B\u578B\u7684\u5F15\u7528\u66F4\u6539\u4E3A <code>Genericdaemon</code> \u7C7B\u578B\u3002\u7B2C\u4E8C\uFF0C\u5F53\u521B\u5EFA\u65B0\u7684\u901A\u7528\u5B88\u62A4\u8FDB\u7A0B\u65F6\uFF0C\u6211\u4EEC\u5FC5\u987B\u521B\u5EFADaemonset\u800C\u4E0D\u662F\u90E8\u7F72\u3002</p><h3 id="\u5C06-operator-\u90E8\u7F72\u5230kubernetes\u96C6\u7FA4" tabindex="-1"><a class="header-anchor" href="#\u5C06-operator-\u90E8\u7F72\u5230kubernetes\u96C6\u7FA4" aria-hidden="true">#</a> \u5C06 operator \u90E8\u7F72\u5230Kubernetes\u96C6\u7FA4</h3><p>\u5F53\u6211\u4EEC\u6839\u636E\u9700\u8981\u4FEE\u6539\u5B8Csample-controller\u540E\uFF0C\u6211\u4EEC\u9700\u8981\u5C06\u5176\u90E8\u7F72\u5230kubernetes\u96C6\u7FA4\u3002\u4E8B\u5B9E\u4E0A\uFF0C\u5728\u8FD9\u4E2A\u65F6\u5019\uFF0C\u6211\u4EEC\u5DF2\u7ECF\u901A\u8FC7\u4F7F\u7528\u6211\u4EEC\u7684\u51ED\u8BC1\u4ECE\u6211\u4EEC\u7684\u5F00\u53D1\u7CFB\u7EDF\u8FD0\u884C\u5B83\u6765\u6D4B\u8BD5\u5B83\u3002</p><p>\u4E0B\u9762\u662F\u4E00\u4E2A\u7B80\u5355\u7684Dockerfile\uFF0C\u7528\u4E8E\u4F7F\u7528<code>operator</code>\u6784\u5EFADocker\u955C\u50CF\uFF08\u4F60\u5FC5\u987B\u4ECE\u539F\u59CB\u7684<code>sample-controller</code>\u4E2D\u5220\u9664\u6240\u6709\u4EE3\u7801\u624D\u80FD\u6784\u5EFA\u955C\u50CF\uFF09\uFF1A</p><div class="language-docker ext-docker line-numbers-mode"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> golang</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p /go/src/k8s.io/sample-controller</span>
<span class="token instruction"><span class="token keyword">ADD</span> . /go/src/k8s.io/sample-controller</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /go</span>
<span class="token instruction"><span class="token keyword">RUN</span> go get ./...</span>
<span class="token instruction"><span class="token keyword">RUN</span> go install -v ./...</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;/go/bin/sample-controller&quot;</span>]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u73B0\u5728\u53EF\u4EE5\u6784\u5EFA\u955C\u50CF\u5E76\u5C06\u5176\u63A8\u9001\u5230Docker Hub\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">docker</span> build <span class="token builtin class-name">.</span> <span class="token parameter variable">-t</span> cubxxw/genericdaemon
\u276F <span class="token function">docker</span> push cubxxw/genericdaemon
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u26A0\uFE0F \u6700\u5F00\u59CB\u4F7F\u7528 <code>buildpacks</code> \u6765\u6784\u5EFA\u7684\uFF0C\u592A\u79BB\u8C31\u4E86\uFF0C\u653E\u5F03\u4E86~</p></blockquote><p>\u6700\u540E\uFF0C\u4F7F\u7528\u6B64\u65B0\u6620\u50CF\u542F\u52A8\u90E8\u7F72\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>// deploy.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sample<span class="token punctuation">-</span>controller
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> sample
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> sample
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sample
        <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">&quot;cubxxw/genericdaemon:latest&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>and <code>kubectl apply -f deploy.yaml</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F k get deployment
NAME                READY   UP-TO-DATE   AVAILABLE   AGE
my-nginx-app        <span class="token number">0</span>/3     <span class="token number">3</span>            <span class="token number">0</span>           29h
nginx-deployment    <span class="token number">3</span>/3     <span class="token number">3</span>            <span class="token number">3</span>           5h42m
sample-controller   <span class="token number">0</span>/1     <span class="token number">1</span>            <span class="token number">0</span>           34s

\u276F k get pod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> sample-controller
sample-controller-779777db4b-xh74l   <span class="token number">0</span>/1     CrashLoopBackOff   <span class="token number">5</span>          6m20s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>operator</code> \u73B0\u5728\u6B63\u5728\u8FD0\u884C\uFF0C\u4F46\u662F\u5982\u679C\u6211\u4EEC\u68C0\u67E5 pod \u7684\u65E5\u5FD7\uFF0C\u6211\u4EEC\u53EF\u4EE5\u770B\u5230\u6388\u6743\u5B58\u5728\u95EE\u9898;POD\u4E0D\u83B7\u5F97\u5BF9\u4E0D\u540C\u8D44\u6E90\u7684\u8BBF\u95EE\u6743\u9650\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F kubectl logs sample-controller-779777db4b-xh74l
E0721 <span class="token number">14</span>:34:50.499584       <span class="token number">1</span> reflector.go:134<span class="token punctuation">]</span> k8s.io/sample-controller/pkg/client/informers/externalversions/factory.go:117: Failed to list *v1beta1.Genericdaemon: genericdaemons.mydomain.com is forbidden: User <span class="token string">&quot;system:serviceaccount:default:default&quot;</span> cannot list genericdaemons.mydomain.com at the cluster scope
E0721 <span class="token number">14</span>:34:50.500385       <span class="token number">1</span> reflector.go:134<span class="token punctuation">]</span> k8s.io/client-go/informers/factory.go:131: Failed to list *v1.DaemonSet: daemonsets.apps is forbidden: User <span class="token string">&quot;system:serviceaccount:default:default&quot;</span> cannot list daemonsets.apps at the cluster scope
<span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u9700\u8981\u521B\u5EFA\u4E00\u4E2A <code>ClusterRole</code> \u548C\u4E00\u4E2A <code>ClusterRoleBinding</code> \u6765\u7ED9\u4E88<code>operator</code> \u5FC5\u8981\u7684\u6743\u9650\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>// rbac_role.yaml
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> operator<span class="token punctuation">-</span>role
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> apps
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> daemonsets
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> delete
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mydomain.com
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> genericdaemons
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> delete

// rbac_role_binding.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> operator<span class="token punctuation">-</span>rolebinding
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> operator<span class="token punctuation">-</span>role
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u90E8\u7F72\uFF1A</p><div class="language-bash&#39; ext-bash&#39; line-numbers-mode"><pre class="language-bash&#39;"><code>\u276F kubectl apply -f rbac_role.yaml
\u276F kubectl delete -f deploy.yaml
\u276F kubectl apply -f deploy.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sample-controller-crd-\u8D44\u6E90\u5B9A\u4E49\u6E90\u7801" tabindex="-1"><a class="header-anchor" href="#sample-controller-crd-\u8D44\u6E90\u5B9A\u4E49\u6E90\u7801" aria-hidden="true">#</a> sample-controller CRD \u8D44\u6E90\u5B9A\u4E49\u6E90\u7801</h3><p>\u9996\u5148\uFF0C\u6700\u5F00\u59CB\u770B\u7684\u8FD8\u662F CRD \u7684\u8D44\u6E90\u5B9A\u4E49\u90E8\u5206\uFF08sample-controller/artifacts/examples/crd.yaml\uFF09\uFF1A</p>`,27),In={href:"https://github.com/kubernetes/enhancements/blob/master/keps/sig-api-machinery/2337-k8s.io-group-protection/README.md",target:"_blank",rel:"noopener noreferrer"},Dn=s("\u5B98\u65B9\u63CF\u8FF0~"),En=t(`<div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment"># \u540D\u5B57\u5FC5\u9700\u4E0E\u4E0B\u9762\u7684 spec \u5B57\u6BB5\u5339\u914D\uFF0C\u5E76\u4E14\u683C\u5F0F\u4E3A &#39;&lt;\u540D\u79F0\u7684\u590D\u6570\u5F62\u5F0F&gt;.&lt;\u7EC4\u540D&gt;&#39;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foos.samplecontroller.k8s.io
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># \u7EC4\u540D\u79F0\uFF0C\u7528\u4E8E REST API: /apis/&lt;\u7EC4&gt;/&lt;\u7248\u672C&gt;</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> samplecontroller.k8s.io
  <span class="token comment"># \u5217\u4E3E\u6B64 CustomResourceDefinition \u6240\u652F\u6301\u7684\u7248\u672C</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1alpha1
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token comment"># kind \u901A\u5E38\u662F\u5355\u6570\u5F62\u5F0F\u7684\u9A7C\u5CF0\u7F16\u7801\uFF08CamelCased\uFF09\u5F62\u5F0F\u3002\u4F60\u7684\u8D44\u6E90\u6E05\u5355\u4F1A\u4F7F\u7528\u8FD9\u4E00\u5F62\u5F0F\u3002</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Foo
    <span class="token comment"># \u540D\u79F0\u7684\u590D\u6570\u5F62\u5F0F\uFF0C\u7528\u4E8E URL\uFF1A/apis/&lt;\u7EC4&gt;/&lt;\u7248\u672C&gt;/&lt;\u540D\u79F0\u7684\u590D\u6570\u5F62\u5F0F&gt;</span>
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> foos
    <span class="token comment"># \u540D\u79F0\u7684\u5355\u6570\u5F62\u5F0F\uFF0C\u4F5C\u4E3A\u547D\u4EE4\u884C\u4F7F\u7528\u65F6\u548C\u663E\u793A\u65F6\u7684\u522B\u540D</span>
    <span class="token key atrule">singular</span><span class="token punctuation">:</span> crontab
    <span class="token comment"># shortNames \u5141\u8BB8\u4F60\u5728\u547D\u4EE4\u884C\u4F7F\u7528\u8F83\u77ED\u7684\u5B57\u7B26\u4E32\u6765\u5339\u914D\u8D44\u6E90</span>
    <span class="token key atrule">shortNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> f
  <span class="token comment"># \u53EF\u4EE5\u662F Namespaced \u6216 Cluster</span>
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u8BE5\u5B9A\u4E49\u6587\u4EF6\uFF0C\u58F0\u660E\u4E86\u4E00\u79CD\u540D\u4E3A Foo \u7684\u8D44\u6E90\uFF0C\u544A\u8BC9 API Server\uFF0C\u6709\u4E00\u79CD\u8D44\u6E90\u53EB\u505A Foo</li><li>\u8BE5 Foo \u8D44\u6E90\u5C06\u88AB sample-controller \u6240\u76D1\u542C\uFF0C\u5E76\u5BF9\u5176\u76F8\u5173\u4E8B\u4EF6\u8FDB\u884C\u5904\u7406</li><li>CRD \u53EF\u4EE5\u662F\u540D\u5B57\u7A7A\u95F4\u4F5C\u7528\u57DF\u7684\uFF0C\u4E5F\u53EF\u4EE5 \u662F\u96C6\u7FA4\u4F5C\u7528\u57DF\u7684\uFF0C\u53D6\u51B3\u4E8E CRD \u7684 <code>scope</code> \u5B57\u6BB5\u8BBE\u7F6E\u3002</li><li>\u81EA\u52A8\u4EE3\u7801\u751F\u6210\u5DE5\u5177\uFF08\u4E0A\u9762\u8BB2\u7684update-codegen\uFF09 \u5C06controller\u4E4B\u5916\u7684\u4E8B\u60C5\u90FD\u505A\u597D\u4E86\uFF0C\u6211\u4EEC\u53EA\u8981\u4E13\u6CE8\u4E8Econtroller\u7684\u5F00\u53D1\u5C31\u597D\u3002</li></ul><p><strong>\u81EA\u5DF1\u7F16\u5199controller\u6709\u4E09\u6B65\uFF1A</strong></p><ul><li><p>\u5B9A\u4E49CRD</p></li><li><p>\u751F\u6210\u81EA\u5B9A\u4E49\u8D44\u6E90\u7684Clientset\u3001Informers\u3001Listers\u7B49</p><ul><li>Clientset \u7528\u4E8E\u548C Kubernetes \u8FDB\u884C\u4EA4\u4E92</li><li>Informers \u673A\u5236\u7528\u4E8E \u76D1\u542C Kubernetes \u4E2D API Server \u7684\u8D44\u6E90\u53D8\u5316\uFF0C\u4E00\u822C\u548C WOrksSqueue \u7ED3\u5408\u4F7F\u7528\uFF0C\u4E00\u4E2A\u662F\u76D1\u542C\uFF0C\u4E00\u4E2A\u662F\u7F13\u5B58\u5230\u6392\u961F\u961F\u5217\u4E2D\uFF08\u4E09\u79CD\u63A5\u53E3\u5B9E\u73B0\uFF09</li><li>Listers \u662F Kubernetes \u4E2D\u7684\u53E6\u4E00\u79CD\u673A\u5236\uFF0C\u7528\u4E8E\u4ECE Informers \u7F13\u5B58\u4E2D\u83B7\u53D6\u8D44\u6E90\u5BF9\u8C61\u7684\u5217\u8868\u3002</li></ul></li><li><p>\u7F16\u5199Controller\u7B49\u4EE3\u7801</p></li></ul><h3 id="foo-\u8D44\u6E90\u7684-yaml-\u5B9A\u4E49" tabindex="-1"><a class="header-anchor" href="#foo-\u8D44\u6E90\u7684-yaml-\u5B9A\u4E49" aria-hidden="true">#</a> Foo \u8D44\u6E90\u7684 yaml \u5B9A\u4E49</h3><p>\u6E90\u6587\u4EF6\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>\u276F cat  artifacts/examples/example<span class="token punctuation">-</span>foo.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> samplecontroller.k8s.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Foo
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>foo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">deploymentName</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>foo
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u{1F4DC} \u5BF9\u4E0A\u9762\u7684\u89E3\u91CA\uFF1A</p><ul><li>\u8BE5\u6587\u4EF6\u58F0\u660E\u8981\u521B\u5EFA\u7684\u8D44\u6E90\u4E3A Foo \u7C7B\u578B\uFF0C\u526F\u672C\u6570\u4E3A 1</li><li>\u8FD9\u4E2A\u521B\u5EFA\u4E8B\u4EF6\u4F1A\u88AB <code>sample-controller</code> \u62E6\u622A\u548C\u5904\u7406</li></ul><h3 id="\u5206\u6790-controller-\u7684\u5B9E\u73B0\u903B\u8F91" tabindex="-1"><a class="header-anchor" href="#\u5206\u6790-controller-\u7684\u5B9E\u73B0\u903B\u8F91" aria-hidden="true">#</a> \u5206\u6790 Controller \u7684\u5B9E\u73B0\u903B\u8F91</h3><p>\u65E2\u7136\u662F\u4ECE <code>main.go</code> \u5F00\u59CB\u7684\uFF0C\u90A3\u4E48\u6211\u4EEC\u4E3B\u8981\u7684\u903B\u8F91\u5728\u8FD9\u91CC\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">InitFlags</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// set up signals so we handle the shutdown signal gracefully</span>
	ctx <span class="token operator">:=</span> signals<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

	cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span>masterURL<span class="token punctuation">,</span> kubeconfig<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error building kubeconfig&quot;</span><span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">FlushAndExit</span><span class="token punctuation">(</span>klog<span class="token punctuation">.</span>ExitFlushTimeout<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	kubeClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubernetes<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error building kubernetes clientset&quot;</span><span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">FlushAndExit</span><span class="token punctuation">(</span>klog<span class="token punctuation">.</span>ExitFlushTimeout<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	exampleClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error building kubernetes clientset&quot;</span><span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">FlushAndExit</span><span class="token punctuation">(</span>klog<span class="token punctuation">.</span>ExitFlushTimeout<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	kubeInformerFactory <span class="token operator">:=</span> kubeinformers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>kubeClient<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>
	exampleInformerFactory <span class="token operator">:=</span> informers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>exampleClient<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>

	controller <span class="token operator">:=</span> <span class="token function">NewController</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> kubeClient<span class="token punctuation">,</span> exampleClient<span class="token punctuation">,</span>
		kubeInformerFactory<span class="token punctuation">.</span><span class="token function">Apps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		exampleInformerFactory<span class="token punctuation">.</span><span class="token function">Samplecontroller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1alpha1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Foos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// notice that there is no need to run Start methods in a separate goroutine. (i.e. go kubeInformerFactory.Start(ctx.done())</span>
	<span class="token comment">// Start method is non-blocking and runs all registered informers in a dedicated goroutine.</span>
	kubeInformerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	exampleInformerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">=</span> controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error running controller&quot;</span><span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">FlushAndExit</span><span class="token punctuation">(</span>klog<span class="token punctuation">.</span>ExitFlushTimeout<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u{1F4DC} \u5927\u81F4\u6D41\u7A0B\u5BF9\u4E0A\u9762\u7684\u89E3\u91CA\uFF1A</strong></p><ul><li><p>\u8BFB\u53D6 kubeconfig \u914D\u7F6E\uFF0C\u6784\u9020\u7528\u4E8E\u4E8B\u4EF6\u76D1\u542C\u7684 <code>Kubernetes Client</code>\u3002</p><blockquote><p>\u8FD9\u91CC\u521B\u5EFA\u4E86\u4E24\u4E2A\uFF0C\u4E00\u4E2A\u76D1\u542C\u666E\u901A\u4E8B\u4EF6\uFF0C\u4E00\u4E2A\u76D1\u542C Foo \u4E8B\u4EF6\u3002</p></blockquote></li><li><p>\u57FA\u4E8E <code>Client</code> \u6784\u9020\u76D1\u542C\u76F8\u5173\u7684 <code>informer</code>\u3002</p></li><li><p>\u57FA\u4E8E <code>Client</code>\u3001<code>Informer</code> \u521D\u59CB\u5316\u81EA\u5B9A\u4E49 <code>Controller</code>\uFF0C\u76D1\u542C <code>Deployment</code> \u4EE5\u53CA <code>Foos</code> \u8D44\u6E90\u53D8\u5316\u3002</p></li><li><p>\u5F00\u542F <code>Controller</code>\u3002</p></li></ul><p>\u90A3\u4E48\u63A5\u4E0B\u6765\u5C31\u662F\u6700\u4E3B\u8981\u7684\uFF0C\u5C31\u662F <code>controller</code> \u7684\u5B9E\u73B0\u903B\u8F91\u4E86(controller.go)</p><p><code>Controller</code> \u7684\u7ED3\u6784\u4F53\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Controller is the controller implementation for Foo resources</span>
<span class="token keyword">type</span> Controller <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// kubeclientset is a standard kubernetes clientset</span>
	kubeclientset kubernetes<span class="token punctuation">.</span>Interface
	<span class="token comment">// sampleclientset is a clientset for our own API group</span>
	sampleclientset clientset<span class="token punctuation">.</span>Interface

	deploymentsLister appslisters<span class="token punctuation">.</span>DeploymentLister
	deploymentsSynced cache<span class="token punctuation">.</span>InformerSynced
	foosLister        listers<span class="token punctuation">.</span>FooLister
	foosSynced        cache<span class="token punctuation">.</span>InformerSynced

	<span class="token comment">// workqueue is a rate limited work queue. This is used to queue work to be</span>
	<span class="token comment">// processed instead of performing it as soon as a change happens. This</span>
	<span class="token comment">// means we can ensure we only process a fixed amount of resources at a</span>
	<span class="token comment">// time, and makes it easy to ensure we are never processing the same item</span>
	<span class="token comment">// simultaneously in two different workers.</span>
	workqueue workqueue<span class="token punctuation">.</span>RateLimitingInterface
	<span class="token comment">// recorder is an event recorder for recording Event resources to the</span>
	<span class="token comment">// Kubernetes API.</span>
	recorder record<span class="token punctuation">.</span>EventRecorder
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u{1F4DC} \u5BF9\u4E0A\u9762\u7684\u89E3\u91CA\uFF1A</p><ul><li>Controller \u7684\u5173\u952E\u6210\u5458\u5373\u4E24\u4E2A\u4E8B\u4EF6\u7684 Listener\uFF08<code>appslisters.DeploymentLister</code>\u3001<code>listers.FooLister</code>\uFF09\u8FD9\u4E24\u4E2A\u6210\u5458\u5C06\u7531 main \u51FD\u6570\u4F20\u5165\u53C2\u6570\u8FDB\u884C\u521D\u59CB\u5316</li><li>\u6B64\u5916\uFF0C\u4E3A\u4E86\u7F13\u51B2\u4E8B\u4EF6\u5904\u7406\uFF0C\u8FD9\u91CC\u4F7F\u7528\u961F\u5217\u6682\u5B58\u4E8B\u4EF6\uFF0C\u76F8\u5173\u6210\u5458\u5373\u4E3A <code>workqueue.RateLimitingInterface</code></li><li><code>kubeclientset</code>\u662F\u4E00\u4E2A\u6807\u51C6\u7684 Kubernetes \u5BA2\u6237\u7AEF\u96C6\uFF0C\u7528\u4E8E\u4E0E Kubernetes API \u8FDB\u884C\u4EA4\u4E92\u3002</li><li><code>sampleclientset</code>\u662F\u6211\u4EEC\u81EA\u5DF1\u7684 API \u7EC4\u7684\u5BA2\u6237\u7AEF\u96C6\uFF0C\u7528\u4E8E\u4E0E\u6211\u4EEC\u7684\u81EA\u5B9A\u4E49API\u8D44\u6E90\u8FDB\u884C\u4EA4\u4E92\u3002</li><li><code>deploymentsLister</code>\u662F\u4E00\u4E2A Deployment \u7684 Lister \u63A5\u53E3\uFF0C\u7528\u4E8E\u83B7\u53D6Deployment\u8D44\u6E90\u7684\u5217\u8868\u4FE1\u606F\u3002</li><li><code>deploymentsSynced</code>\u662F\u4E00\u4E2A Deployment \u7684 InformerSynced \u63A5\u53E3\uFF0C\u7528\u4E8E\u786E\u5B9ADeployment\u8D44\u6E90\u662F\u5426\u5DF2\u7ECF\u540C\u6B65\u5B8C\u6BD5\u3002</li><li><code>foosLister</code>\u662F\u4E00\u4E2A Foo \u7684<code>Lister</code>\u63A5\u53E3\uFF0C\u7528\u4E8E\u83B7\u53D6Foo\u8D44\u6E90\u7684\u5217\u8868\u4FE1\u606F\u3002</li><li><code>foosSynced</code>\u662F\u4E00\u4E2A Foo \u7684<code>InformerSynced</code>\u63A5\u53E3\uFF0C\u7528\u4E8E\u786E\u5B9AFoo\u8D44\u6E90\u662F\u5426\u5DF2\u7ECF\u540C\u6B65\u5B8C\u6BD5\u3002</li><li><code>workqueue</code>\u662F\u4E00\u4E2A\u901F\u7387\u9650\u5236\u7684\u5DE5\u4F5C\u961F\u5217\uFF0C\u7528\u4E8E\u5904\u7406\u5DE5\u4F5C\u9879\u3002\u901A\u8FC7\u4F7F\u7528\u5DE5\u4F5C\u961F\u5217\uFF0C\u6211\u4EEC\u53EF\u4EE5\u786E\u4FDD\u4E00\u6B21\u53EA\u5904\u7406\u4E00\u5B9A\u6570\u91CF\u7684\u8D44\u6E90\uFF0C\u5E76\u4E14\u53EF\u4EE5\u8F7B\u677E\u786E\u4FDD\u6211\u4EEC\u4E0D\u4F1A\u540C\u65F6\u5728\u4E24\u4E2A\u4E0D\u540C\u7684\u5DE5\u4F5C\u8005\u4E2D\u5904\u7406\u540C\u4E00\u9879\u8D44\u6E90\u3002</li><li><code>recorder</code>\u662F\u4E8B\u4EF6\u8BB0\u5F55\u5668\uFF0C\u7528\u4E8E\u8BB0\u5F55 Event \u8D44\u6E90\u5230 Kubernetes API \u4E2D\u3002</li></ul><blockquote><p>\u63A7\u5236\u5668\u7684\u5B9E\u73B0\u8FC7\u7A0B\u4E2D\uFF0C\u4F7F\u7528\u4E86 informer \u548C workqueue \u4E24\u4E2A\u91CD\u8981\u7684\u7EC4\u4EF6\uFF0C\u5B83\u4EEC\u5206\u522B\u7528\u4E8E\u76D1\u542C\u8D44\u6E90\u7684\u53D8\u5316\u548C\u5904\u7406\u4EFB\u52A1\u3002\u5F53\u67D0\u4E2A\u8D44\u6E90\u53D1\u751F\u53D8\u5316\u65F6\uFF0Cinformer \u4F1A\u5C06\u8BE5\u8D44\u6E90\u52A0\u5165 workqueue \u4E2D\u7B49\u5F85\u5904\u7406\u3002\u5904\u7406\u4EFB\u52A1\u65F6\uFF0CsyncHandler \u51FD\u6570\u4F1A\u83B7\u53D6\u4EFB\u52A1\u5BF9\u5E94\u7684 Foo \u548C Deployment \u8D44\u6E90\uFF0C\u5E76\u6BD4\u8F83\u5B83\u4EEC\u7684\u72B6\u6001\u662F\u5426\u4E00\u81F4\uFF0C\u5982\u679C\u4E0D\u4E00\u81F4\u5219\u8FDB\u884C\u540C\u6B65\uFF0C\u540C\u6B65\u6210\u529F\u540E\u66F4\u65B0\u72B6\u6001\u3002\u6574\u4E2A\u8FC7\u7A0B\u4E2D\uFF0C\u4F7F\u7528\u4E86 Kubernetes \u4E2D\u7684\u4E8B\u4EF6\u8BB0\u5F55\u5668\u5C06\u4E8B\u4EF6\u8BB0\u5F55\u5230 Kubernetes API \u4E2D\uFF0C\u4EE5\u4FBF\u4E8E\u8C03\u8BD5\u548C\u76D1\u63A7\u3002</p></blockquote><p><strong>\u63A5\u7740</strong>\uFF0C\u5206\u6790 Controller \u7684\u6784\u9020\u8FC7\u7A0B\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewController</span><span class="token punctuation">(</span>
	kubeclientset kubernetes<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	sampleclientset clientset<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	deploymentInformer appsinformers<span class="token punctuation">.</span>DeploymentInformer<span class="token punctuation">,</span>
	fooInformer informers<span class="token punctuation">.</span>FooInformer<span class="token punctuation">)</span> <span class="token operator">*</span>Controller <span class="token punctuation">{</span>
 
	<span class="token comment">// Create event broadcaster</span>
	<span class="token comment">// Add sample-controller types to the default Kubernetes Scheme so Events can be</span>
	<span class="token comment">// logged for sample-controller types.</span>
	utilruntime<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>samplescheme<span class="token punctuation">.</span><span class="token function">AddToScheme</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Creating event broadcaster&quot;</span><span class="token punctuation">)</span>
	eventBroadcaster <span class="token operator">:=</span> record<span class="token punctuation">.</span><span class="token function">NewBroadcaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	eventBroadcaster<span class="token punctuation">.</span><span class="token function">StartLogging</span><span class="token punctuation">(</span>klog<span class="token punctuation">.</span>Infof<span class="token punctuation">)</span>
	eventBroadcaster<span class="token punctuation">.</span><span class="token function">StartRecordingToSink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>typedcorev1<span class="token punctuation">.</span>EventSinkImpl<span class="token punctuation">{</span>Interface<span class="token punctuation">:</span> kubeclientset<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Events</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	recorder <span class="token operator">:=</span> eventBroadcaster<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> corev1<span class="token punctuation">.</span>EventSource<span class="token punctuation">{</span>Component<span class="token punctuation">:</span> controllerAgentName<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
	controller <span class="token operator">:=</span> <span class="token operator">&amp;</span>Controller<span class="token punctuation">{</span>
		kubeclientset<span class="token punctuation">:</span>     kubeclientset<span class="token punctuation">,</span>
		sampleclientset<span class="token punctuation">:</span>   sampleclientset<span class="token punctuation">,</span>
		deploymentsLister<span class="token punctuation">:</span> deploymentInformer<span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		deploymentsSynced<span class="token punctuation">:</span> deploymentInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">,</span>
		foosLister<span class="token punctuation">:</span>        fooInformer<span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		foosSynced<span class="token punctuation">:</span>        fooInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">,</span>
		workqueue<span class="token punctuation">:</span>         workqueue<span class="token punctuation">.</span><span class="token function">NewNamedRateLimitingQueue</span><span class="token punctuation">(</span>workqueue<span class="token punctuation">.</span><span class="token function">DefaultControllerRateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Foos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		recorder<span class="token punctuation">:</span>          recorder<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
 
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Setting up event handlers&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// Set up an event handler for when Foo resources change</span>
	fooInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
		AddFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>enqueueFoo<span class="token punctuation">,</span>
		UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			controller<span class="token punctuation">.</span><span class="token function">enqueueFoo</span><span class="token punctuation">(</span><span class="token builtin">new</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// Set up an event handler for when Deployment resources change. This</span>
	<span class="token comment">// handler will lookup the owner of the given Deployment, and if it is</span>
	<span class="token comment">// owned by a Foo resource will enqueue that Foo resource for</span>
	<span class="token comment">// processing. This way, we don&#39;t need to implement custom logic for</span>
	<span class="token comment">// handling Deployment resources. More info on this pattern:</span>
	<span class="token comment">// https://github.com/kubernetes/community/blob/8cafef897a22026d42f5e5bb3f104febe7e29830/contributors/devel/controllers.md</span>
	deploymentInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
		AddFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>handleObject<span class="token punctuation">,</span>
		UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			newDepl <span class="token operator">:=</span> <span class="token builtin">new</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span>
			oldDepl <span class="token operator">:=</span> old<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span>
			<span class="token keyword">if</span> newDepl<span class="token punctuation">.</span>ResourceVersion <span class="token operator">==</span> oldDepl<span class="token punctuation">.</span>ResourceVersion <span class="token punctuation">{</span>
				<span class="token comment">// Periodic resync will send update events for all known Deployments.</span>
				<span class="token comment">// Two different versions of the same Deployment will always have different RVs.</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			controller<span class="token punctuation">.</span><span class="token function">handleObject</span><span class="token punctuation">(</span><span class="token builtin">new</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		DeleteFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>handleObject<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
 
	<span class="token keyword">return</span> controller
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u662F\u4E00\u4E2A\u521D\u59CB\u5316\u7684\u8FC7\u7A0B\uFF0C\u4E5F\u662F\u5728 <code>main.go</code> \u4E2D\u8C03\u7528\u7684\u3002</p><ul><li><p>\u5C06 <code>sample-controller</code> \u7684\u7C7B\u578B\u4FE1\u606F\uFF08Foo\uFF09\u6DFB\u52A0\u5230\u9ED8\u8BA4 Kubernetes Scheme\uFF0C\u4EE5\u4FBF\u80FD\u591F\u8BB0\u5F55\u5230\u5176\u4E8B\u4EF6\u3002</p></li><li><p>\u57FA\u4E8E\u65B0 <code>Scheme</code> \u521B\u5EFA\u4E00\u4E2A\u4E8B\u4EF6\u8BB0\u5F55 <code>recorder</code> \uFF0C\u7528\u4E8E\u8BB0\u5F55\u6765\u81EA \u201Csample-controller\u201D \u7684\u4E8B\u4EF6\u3002</p></li><li><p>\u57FA\u4E8E\u51FD\u6570\u5165\u53C2\u53CA\u521A\u521A\u6784\u9020\u7684 <code>recorder</code>\uFF0C\u521D\u59CB\u5316 Controller\u3002</p></li><li><p>\u8BBE\u7F6E\u5BF9 <code>Foo</code> \u8D44\u6E90\u53D8\u5316\u7684\u4E8B\u4EF6\u5904\u7406\u51FD\u6570\uFF08Add\u3001Update \u5747\u901A\u8FC7 enqueueFoo \u5904\u7406\uFF09</p></li><li><p>\u8BBE\u7F6E\u5BF9 <code>Deployment</code> \u8D44\u6E90\u53D8\u5316\u7684\u4E8B\u4EF6\u5904\u7406\u51FD\u6570\uFF08Add\u3001Update\u3001Delete \u5747\u901A\u8FC7 handleObject \u5904\u7406\uFF09</p></li><li><p>\u8FD4\u56DE\u521D\u59CB\u5316\u7684 <code>Controller</code>\u3002</p></li></ul><p><strong>\u8FDB\u4E00\u6B65</strong>\uFF0C\u5206\u6790 <code>enqueueFoo</code> \u4EE5\u53CA <code>handleObject</code> \u7684\u5B9E\u73B0</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// enqueueFoo takes a Foo resource and converts it into a namespace/name</span>
<span class="token comment">// string which is then put onto the work queue. This method should *not* be</span>
<span class="token comment">// passed resources of any type other than Foo.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">enqueueFoo</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> key <span class="token builtin">string</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	<span class="token keyword">if</span> key<span class="token punctuation">,</span> err <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">MetaNamespaceKeyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">AddRateLimited</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// handleObject will take any resource implementing metav1.Object and attempt</span>
<span class="token comment">// to find the Foo resource that &#39;owns&#39; it. It does this by looking at the</span>
<span class="token comment">// objects metadata.ownerReferences field for an appropriate OwnerReference.</span>
<span class="token comment">// It then enqueues that Foo resource to be processed. If the object does not</span>
<span class="token comment">// have an appropriate OwnerReference, it will simply be skipped.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">handleObject</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> object metav1<span class="token punctuation">.</span>Object
	<span class="token keyword">var</span> ok <span class="token builtin">bool</span>
	<span class="token keyword">if</span> object<span class="token punctuation">,</span> ok <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		tombstone<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>DeletedFinalStateUnknown<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error decoding object, invalid type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		object<span class="token punctuation">,</span> ok <span class="token operator">=</span> tombstone<span class="token punctuation">.</span>Obj<span class="token punctuation">.</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error decoding object tombstone, invalid type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Recovered deleted object &#39;%s&#39; from tombstone&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Processing object: %s&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ownerRef <span class="token operator">:=</span> metav1<span class="token punctuation">.</span><span class="token function">GetControllerOf</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span> ownerRef <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// If this object is not owned by a Foo, we should not do anything more</span>
		<span class="token comment">// with it.</span>
		<span class="token keyword">if</span> ownerRef<span class="token punctuation">.</span>Kind <span class="token operator">!=</span> <span class="token string">&quot;Foo&quot;</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
 
		foo<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>foosLister<span class="token punctuation">.</span><span class="token function">Foos</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ownerRef<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;ignoring orphaned object &#39;%s&#39; of foo &#39;%s&#39;&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span><span class="token function">GetSelfLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ownerRef<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
 
		c<span class="token punctuation">.</span><span class="token function">enqueueFoo</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u{1F4DC} \u5BF9\u4E0A\u9762\u7684\u89E3\u91CA\uFF1A</p><ul><li>enqueueFoo \u5C31\u662F\u89E3\u6790 Foo \u8D44\u6E90\u4E3A <code>namespace/name</code> \u5F62\u5F0F\u7684\u5B57\u7B26\u4E32\uFF0C\u7136\u540E\u5165\u961F</li><li>handleObject \u76D1\u542C\u4E86\u6240\u6709\u5B9E\u73B0\u4E86 <code>metav1</code> \u7684\u8D44\u6E90\uFF0C\u4F46\u53EA\u8FC7\u6EE4\u51FA <code>owner</code> \u662F <code>Foo</code> \u7684\uFF0C\u5C06\u5176\u89E3\u6790\u4E3A <code>namespace/name</code> \u5165\u961F</li></ul><p>\u5728\u6784\u9020 Controller \u65F6\u5C31\u5DF2\u7ECF\u521D\u59CB\u5316\u597D\u4E8B\u4EF6\u6536\u96C6\u8FD9\u90E8\u5206\u7684\u5DE5\u4F5C\u4E86, \u90A3\u5982\u4F55\u5904\u7406\u961F\u5217\u91CC\u7684\u8FD9\u4E9B\u4E8B\u4EF6\u5462\uFF1F\u90A3\u5C31\u662F Run \u51FD\u6570\u7684\u64CD\u4F5C\u8FC7\u7A0B\uFF1A</p><p><strong>Run \u51FD\u6570\u64CD\u4F5C\uFF1A</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Run will set up the event handlers for types we are interested in, as well</span>
<span class="token comment">// as syncing informer caches and starting workers. It will block until stopCh</span>
<span class="token comment">// is closed, at which point it will shutdown the workqueue and wait for</span>
<span class="token comment">// workers to finish processing their current work items.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>threadiness <span class="token builtin">int</span><span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> utilruntime<span class="token punctuation">.</span><span class="token function">HandleCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">ShutDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
	<span class="token comment">// Start the informer factories to begin populating the informer caches</span>
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting Foo controller&quot;</span><span class="token punctuation">)</span>
 
	<span class="token comment">// Wait for the caches to be synced before starting workers</span>
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting for informer caches to sync&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">WaitForCacheSync</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">,</span> c<span class="token punctuation">.</span>deploymentsSynced<span class="token punctuation">,</span> c<span class="token punctuation">.</span>foosSynced<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to wait for caches to sync&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting workers&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// Launch two workers to process Foo resources</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadiness<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>runWorker<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Started workers&quot;</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>stopCh
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down workers&quot;</span><span class="token punctuation">)</span>
 
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span class="token comment">// Run will set up the event handlers for types we are interested in, as well</span>
<span class="token comment">// as syncing informer caches and starting workers. It will block until stopCh</span>
<span class="token comment">// is closed, at which point it will shutdown the workqueue and wait for</span>
<span class="token comment">// workers to finish processing their current work items.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>threadiness <span class="token builtin">int</span><span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> utilruntime<span class="token punctuation">.</span><span class="token function">HandleCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">ShutDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
	<span class="token comment">// Start the informer factories to begin populating the informer caches</span>
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting Foo controller&quot;</span><span class="token punctuation">)</span>
 
	<span class="token comment">// Wait for the caches to be synced before starting workers</span>
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting for informer caches to sync&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">WaitForCacheSync</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">,</span> c<span class="token punctuation">.</span>deploymentsSynced<span class="token punctuation">,</span> c<span class="token punctuation">.</span>foosSynced<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to wait for caches to sync&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting workers&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// Launch two workers to process Foo resources</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadiness<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>runWorker<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Started workers&quot;</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>stopCh
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down workers&quot;</span><span class="token punctuation">)</span>
 
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Run \u51FD\u6570\u7684\u6267\u884C\u8FC7\u7A0B\u5927\u4F53\u5982\u4E0B\uFF1A</strong></p><ul><li>\u7B49\u5F85 Informer \u540C\u6B65\u5B8C\u6210\uFF0C</li><li>\u5E76\u53D1 runWorker\uFF0C\u5904\u7406\u961F\u5217\u5185\u4E8B\u4EF6</li></ul><p><strong>runWorker \u7684\u5B9A\u4E49</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runWorker is a long-running function that will continually call the</span>
<span class="token comment">// processNextWorkItem function in order to read and process a message on the</span>
<span class="token comment">// workqueue.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> c<span class="token punctuation">.</span><span class="token function">processNextWorkItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// processNextWorkItem will read a single work item off the workqueue and</span>
<span class="token comment">// attempt to process it, by calling the syncHandler.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">processNextWorkItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	obj<span class="token punctuation">,</span> shutdown <span class="token operator">:=</span> c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 
	<span class="token keyword">if</span> shutdown <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">// We wrap this block in a func so we can defer c.workqueue.Done.</span>
	err <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">// We call Done here so the workqueue knows we have finished</span>
		<span class="token comment">// processing this item. We also must remember to call Forget if we</span>
		<span class="token comment">// do not want this work item being re-queued. For example, we do</span>
		<span class="token comment">// not call Forget if a transient error occurs, instead the item is</span>
		<span class="token comment">// put back on the workqueue and attempted again after a back-off</span>
		<span class="token comment">// period.</span>
		<span class="token keyword">defer</span> c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
		<span class="token keyword">var</span> key <span class="token builtin">string</span>
		<span class="token keyword">var</span> ok <span class="token builtin">bool</span>
		<span class="token comment">// We expect strings to come off the workqueue. These are of the</span>
		<span class="token comment">// form namespace/name. We do this as the delayed nature of the</span>
		<span class="token comment">// workqueue means the items in the informer cache may actually be</span>
		<span class="token comment">// more up to date that when the item was initially put onto the</span>
		<span class="token comment">// workqueue.</span>
		<span class="token keyword">if</span> key<span class="token punctuation">,</span> ok <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// As the item in the workqueue is actually invalid, we call</span>
			<span class="token comment">// Forget here else we&#39;d go into a loop of attempting to</span>
			<span class="token comment">// process a work item that is invalid.</span>
			c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">Forget</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;expected string in workqueue but got %#v&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Run the syncHandler, passing it the namespace/name string of the</span>
		<span class="token comment">// Foo resource to be synced.</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">syncHandler</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token comment">// Put the item back on the workqueue to handle any transient errors.</span>
			c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">AddRateLimited</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error syncing &#39;%s&#39;: %s, requeuing&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Finally, if no error occurs we Forget this item so it does not</span>
		<span class="token comment">// get queued again until another change happens.</span>
		c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">Forget</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Successfully synced &#39;%s&#39;&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
 
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>processNextWorkItem \u7684\u5904\u7406\u6D41\u7A0B\u5927\u4F53\u5982\u4E0B\uFF1A</strong></p><ul><li>\u4ECE\u961F\u5217\u53D6\u51FA\u5F85\u5904\u7406\u5BF9\u8C61</li><li>\u8C03\u7528 <code>syncHandler</code> \u5904\u7406</li></ul><p><strong>\u518D\u6765\u5206\u6790 syncHandler \u7684\u5904\u7406\u7EC6\u8282:</strong></p><p><code>syncHandler</code> \u5C31\u662F\u4E00\u4E2A\u6700\u6838\u5FC3\u7684\u5B9E\u73B0\u4E86\uFF0C\u8FD9\u4E2A\u5B9E\u73B0\u4E5F\u662F\u6BD4\u8F83\u6709\u610F\u601D\u7684\uFF0C\u8BE5\u51FD\u6570\u6BD4\u8F83\u5B9E\u9645\u72B6\u6001\u548C\u671F\u671B\u72B6\u6001\uFF0C\u5E76\u5C1D\u8BD5\u5C06\u4E24\u8005\u878D\u5408\u3002\u7136\u540E\uFF0C\u5B83\u66F4\u65B0 Foo \u8D44\u6E90\u7684 Status \u5757\u4EE5\u53CD\u6620\u8D44\u6E90\u7684\u5F53\u524D\u72B6\u6001\u3002\u6240\u4EE5\u6838\u5FC3\u6B65\u9AA4\u5C31\u662F\u4E24\u4E2A\u6B65\u9AA4</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// syncHandler compares the actual state with the desired, and attempts to</span>
<span class="token comment">// converge the two. It then updates the Status block of the Foo resource</span>
<span class="token comment">// with the current status of the resource.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">syncHandler</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// Convert the namespace/name string into a distinct namespace and name</span>
	namespace<span class="token punctuation">,</span> name<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">SplitMetaNamespaceKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid resource key: %s&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">// Get the Foo resource with this namespace/name</span>
	foo<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>foosLister<span class="token punctuation">.</span><span class="token function">Foos</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// The Foo resource may no longer exist, in which case we stop</span>
		<span class="token comment">// processing.</span>
		<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;foo &#39;%s&#39; in work queue no longer exists&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
 
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
 
	deploymentName <span class="token operator">:=</span> foo<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>DeploymentName
	<span class="token keyword">if</span> deploymentName <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token comment">// We choose to absorb the error here as the worker would requeue the</span>
		<span class="token comment">// resource otherwise. Instead, the next time the resource is updated</span>
		<span class="token comment">// the resource will be queued again.</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: deployment name must be specified&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">// Get the deployment with the name specified in Foo.spec</span>
	deployment<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>deploymentsLister<span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>deploymentName<span class="token punctuation">)</span>
	<span class="token comment">// If the resource doesn&#39;t exist, we&#39;ll create it</span>
	<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		deployment<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span>kubeclientset<span class="token punctuation">.</span><span class="token function">AppsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token function">newDeployment</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">// If an error occurs during Get/Create, we&#39;ll requeue the item so we can</span>
	<span class="token comment">// attempt processing again later. This could have been caused by a</span>
	<span class="token comment">// temporary network failure, or any other transient reason.</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
 
	<span class="token comment">// If the Deployment is not controlled by this Foo resource, we should log</span>
	<span class="token comment">// a warning to the event recorder and ret</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>metav1<span class="token punctuation">.</span><span class="token function">IsControlledBy</span><span class="token punctuation">(</span>deployment<span class="token punctuation">,</span> foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>MessageResourceExists<span class="token punctuation">,</span> deployment<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>recorder<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> corev1<span class="token punctuation">.</span>EventTypeWarning<span class="token punctuation">,</span> ErrResourceExists<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">// If this number of the replicas on the Foo resource is specified, and the</span>
	<span class="token comment">// number does not equal the current desired replicas on the Deployment, we</span>
	<span class="token comment">// should update the Deployment resource.</span>
	<span class="token keyword">if</span> foo<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>foo<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas <span class="token operator">!=</span> <span class="token operator">*</span>deployment<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Foo %s replicas: %d, deployment replicas: %d&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">*</span>foo<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas<span class="token punctuation">,</span> <span class="token operator">*</span>deployment<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas<span class="token punctuation">)</span>
		deployment<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span>kubeclientset<span class="token punctuation">.</span><span class="token function">AppsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token function">newDeployment</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
 
	<span class="token comment">// If an error occurs during Update, we&#39;ll requeue the item so we can</span>
	<span class="token comment">// attempt processing again later. THis could have been caused by a</span>
	<span class="token comment">// temporary network failure, or any other transient reason.</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
 
	<span class="token comment">// Finally, we update the status block of the Foo resource to reflect the</span>
	<span class="token comment">// current state of the world</span>
	err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">updateFooStatus</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> deployment<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
 
	c<span class="token punctuation">.</span>recorder<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> corev1<span class="token punctuation">.</span>EventTypeNormal<span class="token punctuation">,</span> SuccessSynced<span class="token punctuation">,</span> MessageResourceSynced<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>syncHandler \u7684\u5904\u7406\u903B\u8F91\u5927\u4F53\u5982\u4E0B\uFF1A</p><ul><li><p>\u6839\u636E <code>namespace/name</code> \u83B7\u53D6 foo \u8D44\u6E90</p></li><li><p>\u6839\u636E <code>foo</code>\uFF0C\u83B7\u53D6\u5176 <code>Deployment</code> \u540D\u79F0\uFF0C\u8FDB\u800C\u83B7\u53D6 deployment \u8D44\u6E90\uFF08\u6CA1\u6709\u5C31\u4E3A\u5176\u521B\u5EFA\uFF09</p></li><li><p>\u6839\u636E <code>foo</code> \u7684 <code>Replicas</code> \u66F4\u65B0 <code>deployment</code> \u7684 <code>Replicas</code>\uFF08\u5982\u679C\u4E0D\u5339\u914D\uFF09</p></li><li><p>\u66F4\u65B0 <code>foo</code> \u8D44\u6E90\u7684\u72B6\u6001\u4E3A\u6700\u65B0 <code>deployment</code> \u7684\u72B6\u6001\uFF08\u5176\u5B9E\u5C31\u662F <code>AvailableReplicas</code>\uFF09</p></li></ul><p>\u7531\u6B64\uFF0C\u53EF\u77E5 foo \u7684\u5B9E\u73B0\u5B9E\u4F53\u5176\u5B9E\u5C31\u662F <code>deployment</code></p><blockquote><p>\u8FD9\u91CC\u4E5F\u6709\u4E00\u4E2A\u6BD4\u8F83\u6709\u610F\u601D\u7684\u73B0\u8C61\uFF0C\u6211\u4EEC\u5B66\u4E60 Kubernetes \u7684\u65F6\u5019\u4E5F\u77E5\u9053 Deployment \u63A7\u5236 Pod \u662F\u901A\u8FC7\u4E24\u5C42\u63A7\u5236\u5668\u6765\u5B9E\u73B0\u7684\uFF0CDeployment \u63A7\u5236\u5668\u4F7F\u7528 ReplicaSet \u63A7\u5236\u5668\u6765\u786E\u4FDD\u6307\u5B9A\u6570\u91CF\u7684 Pod \u59CB\u7EC8\u5728\u8FD0\u884C\u3002\u5F53 Deployment \u63A7\u5236\u5668\u68C0\u6D4B\u5230 Pod \u6570\u91CF\u4E0D\u8DB3\u6216 Pod \u4E0D\u5B58\u5728\u65F6\uFF0C\u5B83\u4F1A\u542F\u52A8\u4E00\u4E2A\u65B0\u7684 ReplicaSet\uFF0C\u4EE5\u4FBF\u786E\u4FDD\u6307\u5B9A\u6570\u91CF\u7684 Pod \u59CB\u7EC8\u5728\u8FD0\u884C\u3002\u7136\u540E\uFF0C\u5B83\u9010\u6B65\u5C06\u65B0\u7684 ReplicaSet \u4E2D\u7684 Pod \u66FF\u6362\u4E3A\u65E7\u7684 ReplicaSet \u4E2D\u7684 Pod\uFF0C\u76F4\u5230\u65E7\u7684 ReplicaSet \u4E2D\u7684\u6240\u6709 Pod \u90FD\u88AB\u66FF\u6362\u4E3A\u6B62\u3002\u8FD9\u6837\uFF0CDeployment \u63A7\u5236\u5668\u5C31\u53EF\u4EE5\u5B9E\u73B0\u65E0\u5B95\u673A\u66F4\u65B0\u548C\u56DE\u6EDA\u64CD\u4F5C\uFF0C\u4ECE\u800C\u786E\u4FDD\u5E94\u7528\u7A0B\u5E8F\u7684\u9AD8\u53EF\u7528\u6027\u548C\u53EF\u9760\u6027\u3002</p></blockquote><p><strong>\u770B\u4E0B <code>deployment</code> \u7684\u5B9E\u73B0\u4EE3\u7801\uFF1A</strong></p><blockquote><p>\u8FD9\u91CC\u4E5F\u5C31\u662F controller \u7684\u6700\u7EC8\u90E8\u5206\u4E86\uFF0C\u521B\u5EFA\u4E86\u4E00\u4E2A Deployment \u5BF9\u8C61\uFF0C\u5F53\u7136\u5728\u540E\u9762\u4F1A\u66F4\u65B0\u5B9E\u9645\u72B6\u6001\u3002</p></blockquote><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// newDeployment creates a new Deployment for a Foo resource. It also sets</span>
<span class="token comment">// the appropriate OwnerReferences on the resource so handleObject can discover</span>
<span class="token comment">// the Foo resource that &#39;owns&#39; it.</span>
<span class="token keyword">func</span> <span class="token function">newDeployment</span><span class="token punctuation">(</span>foo <span class="token operator">*</span>samplev1alpha1<span class="token punctuation">.</span>Foo<span class="token punctuation">)</span> <span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment <span class="token punctuation">{</span>
	labels <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
		<span class="token string">&quot;app&quot;</span><span class="token punctuation">:</span>        <span class="token string">&quot;nginx&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;controller&quot;</span><span class="token punctuation">:</span> foo<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">{</span>
		ObjectMeta<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">{</span>
			Name<span class="token punctuation">:</span>      foo<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>DeploymentName<span class="token punctuation">,</span>
			Namespace<span class="token punctuation">:</span> foo<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
			OwnerReferences<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>metav1<span class="token punctuation">.</span>OwnerReference<span class="token punctuation">{</span>
				<span class="token operator">*</span>metav1<span class="token punctuation">.</span><span class="token function">NewControllerRef</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">{</span>
					Group<span class="token punctuation">:</span>   samplev1alpha1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">.</span>Group<span class="token punctuation">,</span>
					Version<span class="token punctuation">:</span> samplev1alpha1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">.</span>Version<span class="token punctuation">,</span>
					Kind<span class="token punctuation">:</span>    <span class="token string">&quot;Foo&quot;</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		Spec<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>DeploymentSpec<span class="token punctuation">{</span>
			Replicas<span class="token punctuation">:</span> foo<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas<span class="token punctuation">,</span>
			Selector<span class="token punctuation">:</span> <span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">{</span>
				MatchLabels<span class="token punctuation">:</span> labels<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			Template<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>PodTemplateSpec<span class="token punctuation">{</span>
				ObjectMeta<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">{</span>
					Labels<span class="token punctuation">:</span> labels<span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				Spec<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>PodSpec<span class="token punctuation">{</span>
					Containers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>corev1<span class="token punctuation">.</span>Container<span class="token punctuation">{</span>
						<span class="token punctuation">{</span>
							Name<span class="token punctuation">:</span>  <span class="token string">&quot;nginx&quot;</span><span class="token punctuation">,</span>
							Image<span class="token punctuation">:</span> <span class="token string">&quot;nginx:latest&quot;</span><span class="token punctuation">,</span>
						<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u7B80\u5355\u903B\u8F91\u5C31\u662F\u6839\u636E foo \u8D44\u6E90\u7684 namespace\u3001name\u3001deploymentname\u3001replicas \u4FE1\u606F</strong></p><p>\u521B\u5EFA <code>nginx deployment</code> \u800C\u5DF2\u3002</p><p>\u9700\u8981\u6CE8\u610F\u7684\u662F OwnerReferences \u91CC\u9700\u8981\u4E0E Foo \u7C7B\u578B\u7ED1\u5B9A\uFF08Group\u3001Version\u3001Kind\uFF09\uFF0C\u4E3B\u8981\u662F\u8981\u4E0E\u91C7\u96C6\u5904\u5339\u914D\uFF0C\u56E0\u4E3A handleObject \u4E2D\u7684\u7B5B\u9009 Foo \u8D44\u6E90\u4EE3\u7801\u662F\u6839\u636E Kind \u503C\u505A\u7684</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> ownerRef<span class="token punctuation">.</span>Kind <span class="token operator">!=</span> <span class="token string">&quot;Foo&quot;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u81EA\u5B9A\u4E49 Controller \u662F\u5982\u4F55\u4E0E crd.yaml \u5B9A\u4E49\u5173\u8054\u7684\uFF1F</strong></p><p>\u6211\u4EEC\u77E5\u9053\uFF0C\u4E00\u5F00\u59CB\u662F\u901A\u8FC7 <code>crd.yaml</code> \u6765\u901A\u544A kubernetes \u6211\u4EEC\u81EA\u5B9A\u4E49\u8D44\u6E90\u7684 scheme \u7684\uFF0C\u8FD9\u91CC\u5728\u8865\u5145\u4E00\u70B9\uFF0C\u867D\u7136\u4EE3\u7801\u751F\u6210\u5668\u7684\u903B\u8F91\u5B9E\u73B0\u4E00\u76F4\u6709\u95EE\u9898\uFF0C\u4F46\u662F\u592A\u5E95\u5C42\u7684\u529F\u80FD\uFF0C\u5927\u90E8\u5206\u65F6\u5019\u90FD\u4E0D\u4F1A\u76F4\u63A5\u53BB\u7528\u3002\u9002\u5F53\u7684\u7406\u89E3\u5E95\u5C42\u5B9E\u73B0\uFF08informer\uFF09\u7684\u5DE7\u5999\u4E4B\u540E\uFF0C\u770B\u4E00\u4E0B controller-runtime\u7684\u4EE3\u7801\uFF0C\u77E5\u9053\u600E\u4E48\u7528\u5B83\u5C01\u88C5\u7684cache\u3002\u7136\u540E\u5C31\u662F\u5173\u6CE8\u5728 \u5E94\u7528\u8981\u505A\u7684\u4E8B\u60C5\u4E0A\uFF0C\u505A\u8FD9\u90E8\u5206\u7684\u5B9E\u73B0\u5C31\u591F\u4E86\u3002\u6709\u4E00\u4E2A\u7279\u6B8A\u60C5\u51B5\u5C31\u662F\uFF0C\u5728\u8FD9\u4E2A\u8FC7\u7A0B\u4E2D\uFF0C\u4F60\u7684\u4EE3\u7801\u8981\u7528\u53E6\u5916\u7684CRD\uFF0C\u8FD9\u4E2A\u65F6\u5019\u4F1A\u9EBB\u70E6\u4E00\u70B9\u3002\u65E9\u671F\u7684\u65F6\u5019\uFF0C\u9700\u8981\u641E\u51E0\u6B65\u751F\u6210\u4EE3\u7801\u7684\u64CD\u4F5C\u3002\u4F46\u662F\u73B0\u5728\u53EA\u8981\u662Fkubebuilder\u6846\u67B6\u751F\u6210\u7684CRD\uFF0C\u6846\u67B6\u751F\u6210\u7684\u4EE3\u7801\u91CC\u4F1A\u6709 addtoscheme \u7684\u5B9E\u73B0\uFF0C\u53EA\u9700\u8981import \u4E4B\u540E\uFF0Cregistry\u4E00\u4E0B\uFF0C\u5C31\u5B8C\u4E8B\u513F\u4E86\u3002</p><ul><li>\u90A3\u662F\u5982\u4F55\u4E0E Controller \u5173\u8054\u7684\u5462\uFF1F\u5176\u5B9E\u5C31\u5728\u4E8E <code>pkg/apis</code> \u76EE\u5F55\u4E0B\uFF0C\u6EE1\u6EE1\u4E5F\u90FD\u662F Kubernetes \u7684\u5473\u9053\uFF0C\u5728\u8D44\u6E90\u5B9A\u4E49\u4E2D\uFF0C\u4E0D\u7BA1\u662F k3s\u3001k0s\u3001\u8FD8\u662F Kubernetes\uFF0C\u603B\u662F\u4E0D\u53EF\u5FFD\u89C6\u7684\u662F pkg/apis \u76EE\u5F55\u3002</li><li><code>pkg/apis</code> \u4E0B\u5B9A\u4E49\u4E86\u81EA\u5B9A\u4E49\u8D44\u6E90\u7684\u76F8\u5173\u5C5E\u6027\u4FE1\u606F\uFF0C\u6211\u4EEC\u7B80\u5355\u770B\u4E0B\uFF1A</li><li><code>pkg/samplecontroller/v1alpha1/register.go</code>\uFF08\u5904\u7406\u7C7B\u578B Schema\uFF09</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// SchemeGroupVersion is group version used to register these objects</span>
<span class="token keyword">var</span> SchemeGroupVersion <span class="token operator">=</span> schema<span class="token punctuation">.</span>GroupVersion<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> samplecontroller<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Version<span class="token punctuation">:</span> <span class="token string">&quot;v1alpha1&quot;</span><span class="token punctuation">}</span>
 
<span class="token comment">// Kind takes an unqualified kind and returns back a Group qualified GroupKind</span>
<span class="token keyword">func</span> <span class="token function">Kind</span><span class="token punctuation">(</span>kind <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupKind <span class="token punctuation">{</span>
	<span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithKind</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// Resource takes an unqualified resource and returns a Group qualified GroupResource</span>
<span class="token keyword">func</span> <span class="token function">Resource</span><span class="token punctuation">(</span>resource <span class="token builtin">string</span><span class="token punctuation">)</span> schema<span class="token punctuation">.</span>GroupResource <span class="token punctuation">{</span>
	<span class="token keyword">return</span> SchemeGroupVersion<span class="token punctuation">.</span><span class="token function">WithResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GroupResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">var</span> <span class="token punctuation">(</span>
	SchemeBuilder <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewSchemeBuilder</span><span class="token punctuation">(</span>addKnownTypes<span class="token punctuation">)</span>
	AddToScheme   <span class="token operator">=</span> SchemeBuilder<span class="token punctuation">.</span>AddToScheme
<span class="token punctuation">)</span>
 
<span class="token comment">// Adds the list of known types to Scheme.</span>
<span class="token keyword">func</span> <span class="token function">addKnownTypes</span><span class="token punctuation">(</span>scheme <span class="token operator">*</span>runtime<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	scheme<span class="token punctuation">.</span><span class="token function">AddKnownTypes</span><span class="token punctuation">(</span>SchemeGroupVersion<span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>Foo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token operator">&amp;</span>FooList<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	metav1<span class="token punctuation">.</span><span class="token function">AddToGroupVersion</span><span class="token punctuation">(</span>scheme<span class="token punctuation">,</span> SchemeGroupVersion<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u4E0E\u4E4B\u524D\u7684 crd \u5B9A\u4E49\u5BF9\u6BD4\u4E0B:</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> foos.samplecontroller.k8s.io
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> samplecontroller.k8s.io
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1alpha1
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Foo
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> foos
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F1A\u53D1\u73B0 controller \u4E0E crd \u4E24\u8005\u7684 group\u3001version \u90FD\u662F\u4E00\u81F4\u7684\uFF0C\u8FD9\u610F\u5473\u7740\u4EC0\u4E48\uFF1F</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>var SchemeGroupVersion <span class="token operator">=</span> schema.GroupVersion<span class="token punctuation">{</span>Group: samplecontroller.GroupName, Version: <span class="token string">&quot;v1alpha1&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5728 Kubernetes \u4E2D\uFF0Cnamespace \u548C name \u53EF\u4EE5\u552F\u4E00\u6807\u8BC6\u4E00\u4E2A\u8D44\u6E90\uFF0C\u901A\u8FC7 group \u548C version\uFF0C\u53EF\u4EE5\u552F\u4E00\u6807\u8BC6 Kubernetes API \u4E2D\u7684\u4E00\u4E2A API \u8D44\u6E90\u3002</p><p>\u800C\u4E14 metadata \u7684 name \u662F\u7B26\u5408 <code>&lt;plural&gt;.&lt;group&gt;</code> \u89C4\u8303\u7684\uFF0C\u90A3\u4E48\u56DE\u5230\u5F00\u5934\u7684\u89E3\u91CA\uFF0C\u5728 k8s \u7CFB\u7EDF\u4E2D\uFF0C\u4E00\u65E6\u521B\u5EFA\u4E86 CRD\uFF0C\u5BF9\u8BE5 CRD \u7684\u589E\u5220\u6539\u67E5\u5176\u5B9E\u5C31\u5DF2\u7ECF\u88AB\u652F\u6301\u4E86\uFF0C\u6211\u4EEC\u7684 Controller \u53EA\u662F\u76D1\u542C\u81EA\u5DF1\u611F\u5174\u8DA3\u7684\u8D44\u6E90\u4E8B\u4EF6\uFF0C\u505A\u51FA\u771F\u5B9E\u7684\u90E8\u7F72\u3001\u66F4\u65B0\u3001\u79FB\u9664\u7B49\u52A8\u4F5C\u3002</p><p>\u5728\u6700\u540E\uFF0C\u6211\u4EEC\u4E5F\u4F1A\u6269\u5C55\u81EA\u5DF1\u7684 \u7C7B\u578B blog\u3002</p><h2 id="kubebuilder" tabindex="-1"><a class="header-anchor" href="#kubebuilder" aria-hidden="true">#</a> Kubebuilder</h2><p>\u5FEB\u901F\u521B\u5EFA\u4E00\u4E2A mydemo:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F go mod init mydemo
go: creating new go.mod: module mydemo
\u276F kubebuilder init <span class="token parameter variable">--domain</span> mydomain.com
\u276F tree <span class="token parameter variable">-L</span> <span class="token number">2</span>
<span class="token builtin class-name">.</span>
\u251C\u2500\u2500 Dockerfile
\u251C\u2500\u2500 Makefile
\u251C\u2500\u2500 PROJECT
\u251C\u2500\u2500 README.md
\u251C\u2500\u2500 cmd
\u2502   \u2514\u2500\u2500 main.go
\u251C\u2500\u2500 config
\u2502   \u251C\u2500\u2500 default
\u2502   \u251C\u2500\u2500 manager
\u2502   \u251C\u2500\u2500 prometheus
\u2502   \u2514\u2500\u2500 rbac
\u251C\u2500\u2500 go.mod
\u251C\u2500\u2500 go.sum
\u2514\u2500\u2500 hack
    \u2514\u2500\u2500 boilerplate.go.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6700\u540E\u521B\u5EFACRD\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F kubebuilder create api <span class="token parameter variable">--group</span> mygroup <span class="token parameter variable">--version</span> v1beta1 <span class="token parameter variable">--kind</span> GenericDaemon
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>kubebuilder</code> \u4E3A\u6211\u4EEC\u521B\u5EFA\u4E86API\u7684\u6E90\uFF0C\u4EE5\u8BBF\u95EE <code>api/v1beta1</code> \u4E0B\u7684CRD\u3002\u60A8\u53EF\u4EE5\u770B\u5230\u521B\u5EFA\u7684\u6587\u4EF6\u4E0E\u6211\u4EEC\u4E4B\u524D\u5728 sample-controller \u4E2D\u7F16\u8F91\u7684\u6587\u4EF6\u7C7B\u4F3C\u3002</p><p><strong>\u5199\u4E00\u4E9B\u4EE3\u7801:</strong></p><p>\u6211\u4EEC\u9700\u8981\u4FEE\u6539 <code>GenericDaemon</code> \u7684\u7ED3\u6784\uFF0C\u4E3A\u6211\u4EEC\u7684\u5BF9\u8C61\u6DFB\u52A0\u5FC5\u8981\u7684\u5B57\u6BB5\u3002\u4E0D\u8981\u5FD8\u8BB0\u8BB0\u5F55\u5B57\u6BB5\uFF0C\u4EE5\u4FBF\u6587\u6863\u751F\u6210\u5668\u53EF\u4EE5\u521B\u5EFA\u826F\u597D\u7684\u6587\u6863\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// api/v1beta1/genericdaemon_types.go</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token comment">// GenericDaemonSpec defines the desired state of GenericDaemon</span>
<span class="token keyword">type</span> GenericDaemonSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">// Label is the value of the &#39;daemon=&#39; label to set on a node that should run the daemon</span>
  Label <span class="token builtin">string</span> <span class="token string">\`json:&quot;label&quot;\`</span>
  <span class="token comment">// Image is the Docker image to run for the daemon</span>
  Image <span class="token builtin">string</span> <span class="token string">\`json:&quot;image&quot;\`</span>
<span class="token punctuation">}</span>
<span class="token comment">// GenericDaemonStatus defines the observed state of GenericDaemon</span>
<span class="token keyword">type</span> GenericDaemonStatus <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token comment">// Count is the number of nodes the daemon is deployed to</span>
  Count <span class="token builtin">int32</span> <span class="token string">\`json:&quot;count&quot;\`</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u8BA9\u6211\u4EEC\u6309\u7167 <code>genericdaemon_controller.go</code> \u6587\u4EF6\u4E2D\u7684TODO\u8BF4\u660E\u8FDB\u884C\u64CD\u4F5C\u3002\u9996\u5148\u5728 <code>add</code> \u51FD\u6570\u4E2D\uFF0C\u8BA9\u6211\u4EEC\u542C <code>DaemonSet</code> \u800C\u4E0D\u662F <code>Deployment</code> \uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// pkg/controller/genericdaemon/genericdaemon_controller.go</span>
<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>mgr manager<span class="token punctuation">.</span>Manager<span class="token punctuation">,</span> r reconcile<span class="token punctuation">.</span>Reconciler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
  <span class="token comment">// watch a Daemonset created by GenericDaemon</span>
  err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>source<span class="token punctuation">.</span>Kind<span class="token punctuation">{</span>Type<span class="token punctuation">:</span> <span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>DaemonSet<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>handler<span class="token punctuation">.</span>EnqueueRequestForOwner<span class="token punctuation">{</span>
    IsController<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    OwnerType<span class="token punctuation">:</span>    <span class="token operator">&amp;</span>mygroupv1beta1<span class="token punctuation">.</span>GenericDaemon<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7B2C\u4E8C\uFF0C\u8BA9\u6211\u4EEC\u7F16\u5199 <code>Reconcile</code> \u51FD\u6570\u7684\u4EE3\u7801\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// ...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>\u90E8\u7F72\u548C play</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u276F make
\u276F make docker-build IMG=cubxxw/genericdaemon
\u276F make docker-push IMG=cubxxw/genericdaemon
\u276F make deploy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C\u60A8\u68C0\u67E5 <code>make deploy</code> \u547D\u4EE4\u7684\u8F93\u51FA\uFF0C\u60A8\u53EF\u4EE5\u770B\u5230\u8BE5\u547D\u4EE4\u4E3A<code>operator</code> \u90E8\u7F72\u4E86CRD\u3001RBAC\u89D2\u8272\u548C\u89D2\u8272\u7ED1\u5B9A\u4EE5\u8BBF\u95EE\u5FC5\u8981\u7684\u5BF9\u8C61\uFF0C\u4E3A<code>operator</code> \u521B\u5EFA\u4E86\u547D\u540D\u7A7A\u95F4\uFF0C\u4E3A<code>operator</code> \u521B\u5EFA\u4E86\u670D\u52A1\u548Cstatefulset\u3002</p><p>\u6B64\u65F6\uFF0C<code>operator</code> \u5E94\u8FD0\u884C\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u276F kubectl get pods --namespace=mygroup-system
\u276F kubectl logs mygroup-controller-manager-6bdb7f7f88-vnhhb --namespace=mygroup-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u73B0\u5728\u53EF\u4EE5\u4E2A\u6027\u5316\u751F\u6210\u7684 <code>GenericDaemon</code> \u6837\u672C\uFF1A</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>\u276F cat config/samples/mygroup_v1beta1_genericdaemon.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> mygroup.mydomain.com/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> GenericDaemon
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> genericdaemon
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> genericdaemon<span class="token punctuation">-</span>sample
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> mygroup
    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> kustomize
    <span class="token key atrule">app.kubernetes.io/created-by</span><span class="token punctuation">:</span> mygroup
  <span class="token key atrule">name</span><span class="token punctuation">:</span> genericdaemon<span class="token punctuation">-</span>sample
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">label</span><span class="token punctuation">:</span> http
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5E76\u521B\u5EFA\u5B83\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u276F kubectl apply -f config/samples/mygroup_v1beta1_genericdaemon.yaml
genericdaemon.mygroup.mydomain.com/genericdaemon-sample created
\u276F kubectl get genericdaemon
NAME                   AGE
genericdaemon-sample   11s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u535A\u5BA2\u5143\u6570\u636E" tabindex="-1"><a class="header-anchor" href="#\u535A\u5BA2\u5143\u6570\u636E" aria-hidden="true">#</a> \u535A\u5BA2\u5143\u6570\u636E</h2>`,85),An=s("\u53EF\u4EE5\u5C06Sample-Controller\u7528\u4E8E\u7BA1\u7406 \u6211\u7684\u535A\u5BA2\uFF08"),jn={href:"https://docker.nsddd.top/",target:"_blank",rel:"noopener noreferrer"},On=s("docker.nsddd.top"),Nn=s(" OR "),Fn={href:"https://go.nsddd.top/",target:"_blank",rel:"noopener noreferrer"},Tn=s("go.nsddd.top"),Pn=s("\uFF09 \u7684\u5143\u6570\u636E\u3002"),Gn={href:"https://github.com/cubxxw/sample-controller/pull/7",target:"_blank",rel:"noopener noreferrer"},Bn=s("\u5BF9\u5E94\u7684 PR \u8BF7\u6C42"),Ln={href:"https://github.com/cubxxw/sample-controller/",target:"_blank",rel:"noopener noreferrer"},Kn=s("\u4ED3\u5E93\u5730\u5740"),Jn=t(`<p>\u6309\u7167\u4E0A\u9762\u5B66\u4E60\u7F16\u5199 controller \u7684\u903B\u8F91\uFF0C\u6211\u628A\u6B65\u9AA4\u5206\u4E3A\u4E09\u6B65\uFF08\u9488\u5BF9 kubebuilder \uFF09\uFF1A</p><ol><li>Create CRD and CR object</li><li>Write controller code</li><li>Deploy controller</li></ol><p>\u4E0D\u4EC5\u5982\u6B64\uFF0C\u6211\u5E0C\u671B\u5C06 Kubebuilder \u548C code-generator \u76F8\u7ED3\u5408\uFF0C\u4F7F\u7528Kubebuilder\u751F\u6210CRD\u548C\u4E00\u6574\u5957\u63A7\u5236\u5668\u67B6\u6784\uFF0C\u518D\u4F7F\u7528 code-generator \u751F\u6210 <code>informers</code>\u3001<code>listers</code>\u3001<code>clientsets</code>\u7B49\u3002</p><p>\u9488\u5BF9\u901A\u8FC7\u4EE3\u7801\u751F\u6210\u5668\u5199 controller:</p><ul><li>\u5B9A\u4E49CRD</li><li>\u751F\u6210\u81EA\u5B9A\u4E49\u8D44\u6E90\u7684Clientset\u3001Informers\u3001Listers\u7B49</li><li>\u7F16\u5199Controller\u7B49\u4EE3\u7801</li></ul><h3 id="\u5B9A\u4E49\u81EA\u5B9A\u4E49\u63CF\u8FF0" tabindex="-1"><a class="header-anchor" href="#\u5B9A\u4E49\u81EA\u5B9A\u4E49\u63CF\u8FF0" aria-hidden="true">#</a> \u5B9A\u4E49\u81EA\u5B9A\u4E49\u63CF\u8FF0</h3><p>\u53D6\u540D\u4E3A\uFF1A<code>cat crd-blog.yaml</code></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>\u276F cat artifacts/examples/crd<span class="token punctuation">-</span>blog.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> blogs.controller.nsddd.top
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> controller.nsddd.top
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1beta1
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Blog
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> blogs
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u90E8\u7F72\u8BE5\u8D44\u6E90\u5B9A\u4E49:</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F k apply <span class="token parameter variable">-f</span>  artifacts/examples/crd-blog.yaml
customresourcedefinition.apiextensions.k8s.io/blogs.controller.nsddd.top created
\u276F k get crd
NAME                                  CREATED AT
blogs.controller.nsddd.top            <span class="token number">2023</span>-04-09T04:13:15Z
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6784\u5EFA examples <code>example-blog.yaml</code>\uFF1A</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token function">cat</span> example-blog.yaml
apiVersion: controller.nsddd.top/v1beta1
kind: Blog
metadata:
  name: example-blog
spec:
  deploymentName: example-blog
  replicas: <span class="token number">1</span>
  title: <span class="token string">&quot;example blog&quot;</span>
  author: <span class="token string">&quot;Xinwei Xiong&quot;</span>
  content: <span class="token string">&quot;blog content&quot;</span>
  lastUpdate: <span class="token string">&quot;2023-04-09&quot;</span>
  prev: <span class="token string">&quot;&quot;</span>
  next: <span class="token string">&quot;&quot;</span>

\u276F k apply <span class="token parameter variable">-f</span>  artifacts/examples/example-blog.yaml
blog.controller.nsddd.top/example-blog created

\u276F k get Blog
NAME           AGE
example-blog   61s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F53\u7136\u8FD9\u8FD8\u8FDC\u8FDC\u4E0D\u591F\uFF0C\u6CA1\u6709 controller\u3002</p><h3 id="\u5F00\u53D1\u5173\u4E8E-blog-\u8D44\u6E90\u64CD\u63A7\u7684-controller-\u7AEF\u4EE3\u7801" tabindex="-1"><a class="header-anchor" href="#\u5F00\u53D1\u5173\u4E8E-blog-\u8D44\u6E90\u64CD\u63A7\u7684-controller-\u7AEF\u4EE3\u7801" aria-hidden="true">#</a> \u5F00\u53D1\u5173\u4E8E blog \u8D44\u6E90\u64CD\u63A7\u7684 controller \u7AEF\u4EE3\u7801</h3><p>\u9996\u5148\u5728 <code>pkg/apis</code> \u4E0B\u521B\u5EFA\u76EE\u5F55 <code>nsdddcontroller</code>\uFF0C\u7136\u540E\u5C06 <code>samplecontroller</code> \u91CC\u7684\u6240\u6709\u6587\u4EF6\u590D\u5236\u5230 <code>nsdddcontroller</code>\uFF0C\u6211\u4EEC\u5728\u5B66\u4E60 <code>sample-controller</code> \u7684\u65F6\u5019\u6F14\u793A\u8FC7\u6848\u4F8B<code>genericdaemon</code>\u3002</p><blockquote><p>\u4E3A\u4E86 \u7B26\u5408 Kubernetes \u7684\u7248\u672C\u89C4\u8303\uFF0C\u6211\u4EEC\u5C06\u5176\u4F5C\u4E3A bate \u7248\u672C\uFF0C\u53EF\u4EE5\u5BF9\u5916\u63D0\u4F9B~</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F tree nsdddcontroller
nsdddcontroller
\u251C\u2500\u2500 register.go
\u2514\u2500\u2500 v1beta1
    \u251C\u2500\u2500 doc.go
    \u251C\u2500\u2500 register.go
    \u2514\u2500\u2500 types.go
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4FEE\u6539\u6CE8\u518C\u8868\u7684\u914D\u7F6E\uFF1A</p><ul><li><code>pkg/apis/nsdddcontroller/register.go</code></li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> nsdddcontroller

<span class="token comment">// GroupName is the group name used in this package</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	GroupName <span class="token operator">=</span> <span class="token string">&quot;nsdddcontroller.k8s.io&quot;</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4FEE\u6539 type \u6587\u4EF6\uFF1A</p><ul><li><code>pkg/apis/nsdddcontroller/v1bate1/types.go</code></li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> v1beta1

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// +genclient</span>
<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>

<span class="token comment">// Blog is a specification for a Blog resource</span>
<span class="token keyword">type</span> Blog <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	metav1<span class="token punctuation">.</span>TypeMeta   <span class="token string">\`json:&quot;,inline&quot;\`</span>
	metav1<span class="token punctuation">.</span>ObjectMeta <span class="token string">\`json:&quot;metadata,omitempty&quot;\`</span>

	Spec   BlogSpec   <span class="token string">\`json:&quot;spec&quot;\`</span>
	Status BlogStatus <span class="token string">\`json:&quot;status&quot;\`</span>
<span class="token punctuation">}</span>

<span class="token comment">// BlogSpec is the spec for a Blog resource</span>
<span class="token keyword">type</span> BlogSpec <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	DeploymentName <span class="token builtin">string</span> <span class="token string">\`json:&quot;deploymentName&quot;\`</span>
	Replicas       <span class="token operator">*</span><span class="token builtin">int32</span> <span class="token string">\`json:&quot;replicas&quot;\`</span>
	Title          <span class="token builtin">string</span> <span class="token string">\`json:&quot;title&quot;\`</span>
	Author         <span class="token builtin">string</span> <span class="token string">\`json:&quot;author&quot;\`</span>
	Content        <span class="token builtin">string</span> <span class="token string">\`json:&quot;content&quot;\`</span>
	LastUpdate     <span class="token builtin">string</span> <span class="token string">\`json:&quot;lastUpdate&quot;\`</span>
	Prev           <span class="token builtin">string</span> <span class="token string">\`json:&quot;prev&quot;\`</span>
	Next           <span class="token builtin">string</span> <span class="token string">\`json:&quot;next&quot;\`</span>
<span class="token punctuation">}</span>

<span class="token comment">// BlogStatus is the status for a Blog resource</span>
<span class="token keyword">type</span> BlogStatus <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	AvailableReplicas <span class="token builtin">int32</span> <span class="token string">\`json:&quot;availableReplicas&quot;\`</span>
<span class="token punctuation">}</span>

<span class="token comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span>

<span class="token comment">// BlogList is a list of Blog resources</span>
<span class="token keyword">type</span> BlogList <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	metav1<span class="token punctuation">.</span>TypeMeta <span class="token string">\`json:&quot;,inline&quot;\`</span>
	metav1<span class="token punctuation">.</span>ListMeta <span class="token string">\`json:&quot;metadata&quot;\`</span>

	Items <span class="token punctuation">[</span><span class="token punctuation">]</span>Blog <span class="token string">\`json:&quot;items&quot;\`</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u4EE3\u7801\u751F\u6210\u5668-1" tabindex="-1"><a class="header-anchor" href="#\u4EE3\u7801\u751F\u6210\u5668-1" aria-hidden="true">#</a> \u4EE3\u7801\u751F\u6210\u5668</h3><p>\u4FEE\u6539 <code>hack/update-codegen.sh</code>\uFF0C\u589E\u52A0\u5BF9 Blog \u7684\u4EE3\u7801\u751F\u6210\u547D\u4EE4\uFF08\u5BF9 nsdddcontroller \u5305\u7684\u4EE3\u7801\u751F\u6210\uFF09</p><blockquote><p>\u5728\u6B64\u4E4B\u524D\u4F60\u5E94\u8BE5\u7528 git \u5907\u4EFD\u4E00\u4E0B\uFF0C\u5E76\u4E14\u51C6\u5907\u4EE3\u7801\u751F\u6210\u5668\u811A\u672C\u6216\u8005\u4E8C\u8FDB\u5236 <code>code-generator</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F go mod vendor
\u276F <span class="token function">chmod</span> +x vendor/k8s.io/code-generator/generate-groups.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;===&gt; Generating genericdaemon code for Blog&quot;</span>
<span class="token string">&quot;<span class="token variable">\${CODEGEN_PKG}</span>&quot;</span>/generate-groups.sh <span class="token string">&quot;deepcopy,client,informer,lister&quot;</span> <span class="token punctuation">\\</span>
  k8s.io/sample-controller/pkg/client_Blog <span class="token punctuation">\\</span> 
  k8s.io/sample-controller/pkg/apis <span class="token punctuation">\\</span>
  nsdddcontroller:v1Bate1 <span class="token punctuation">\\</span>
  --output-base <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">&quot;<span class="token variable">\${<span class="token environment constant">BASH_SOURCE</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span>}</span>&quot;</span><span class="token variable">)</span></span>/../../..&quot;</span> <span class="token punctuation">\\</span>
  --go-header-file <span class="token string">&quot;<span class="token variable">\${SCRIPT_ROOT}</span>&quot;</span>/hack/boilerplate.go.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u26A0\uFE0F \u8FD9\u91CC\u6709\u4E2A\u5751\u8BB0\u5F55\u4E0B\uFF0C\u6211\u7528\u4EE3\u7801\u751F\u6210\u5668\u751F\u6210\u7684\u4E00\u76F4\u6709\u95EE\u9898\uFF0C\u4F7F\u7528\u7684\u662F <code>GO111MODULE=on</code> \u6A21\u5757\u3002\u4FEE\u6539\u540E\u7684\u811A\u672C\u5982\u4E0B\uFF1A</p>`,28),Vn={href:"https://github.com/kubernetes/kubernetes/issues/117181",target:"_blank",rel:"noopener noreferrer"},Mn=s("\u8FD9\u91CC\u6211\u5728 Kubernetes \u4E2D\u63D0 issue \u7684\u8BB0\u5F55\uFF0C\u4F1A\u8BB0\u5F55\u6240\u6709 \u4EE3\u7801\u751F\u6210\u5668 \u51FA\u73B0\u7684\u95EE\u9898\uFF0C\u8FD9\u4E2A\u6587\u7AE0\u5C31\u4E0D\u8865\u5145\u4E86\u3002"),Hn=t(`<p>\u83B7\u53D6 \u8BB8\u53EF\u8BC1\u5934\u6587\u4EF6\u7684\u53D8\u91CF\u548C \u83B7\u53D6\u5305\u7684\u8DEF\u5F84\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">SCRIPT_ROOT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">&quot;<span class="token variable">\${<span class="token environment constant">BASH_SOURCE</span><span class="token punctuation">[</span>0<span class="token punctuation">]</span>}</span>&quot;</span><span class="token variable">)</span></span>/<span class="token punctuation">..</span>
<span class="token assign-left variable">CODEGEN_PKG</span><span class="token operator">=</span><span class="token variable">\${CODEGEN_PKG<span class="token operator">:-</span>$(cd &quot;\${SCRIPT_ROOT}</span>&quot;<span class="token punctuation">;</span> <span class="token function">ls</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-1</span> ./vendor/k8s.io/code-generator <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token punctuation">..</span>/code-generator<span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u811A\u672C\u5C06<code>SCRIPT_ROOT</code>\u53D8\u91CF\u8BBE\u7F6E\u4E3A\u811A\u672C\u6587\u4EF6\u7684\u76EE\u5F55\u540D\u79F0\uFF0C\u7136\u540E\u5C06<code>CODEGEN_PKG</code>\u53D8\u91CF\u8BBE\u7F6E\u4E3A<code>code-generator</code>\u8F6F\u4EF6\u5305\u7684\u8DEF\u5F84\u3002\u5982\u679C\u672A\u8BBE\u7F6E<code>CODEGEN_PKG</code>\u73AF\u5883\u53D8\u91CF\uFF0C\u5219\u811A\u672C\u4F1A\u68C0\u67E5<code>SCRIPT_ROOT</code>\u8DEF\u5F84\u7684vendor\u76EE\u5F55\u4E2D\u662F\u5426\u5B89\u88C5\u4E86<code>code-generator</code>\u8F6F\u4EF6\u5305\uFF0C\u5E76\u76F8\u5E94\u5730\u8BBE\u7F6E<code>CODEGEN_PKG</code>\u53D8\u91CF\u3002</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\u276F <span class="token builtin class-name">pwd</span>
/root/workspaces/sample-controller

\u276F vendor/k8s.io/code-generator/generate-groups.sh <span class="token punctuation">\\</span>
<span class="token string">&quot;deepcopy,client,informer,lister&quot;</span> <span class="token punctuation">\\</span>
  k8s.io/sample-controller/pkg/generated_blog <span class="token punctuation">\\</span>
  k8s.io/sample-controller/pkg/apis <span class="token punctuation">\\</span>
  nsdddcontroller:v1Bate1 <span class="token punctuation">\\</span>
  --output-base <span class="token string">&quot;/root/workspaces&quot;</span> <span class="token punctuation">\\</span>
  --go-header-file <span class="token string">&quot;hack/boilerplate.go.txt&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u5199-controller" tabindex="-1"><a class="header-anchor" href="#\u5199-controller" aria-hidden="true">#</a> \u5199 controller</h3><p>\u89C4\u8303\u6027\u7684\u5C06 controller \u653E\u5165\u5230 <code>pkg</code> \u4E2D\uFF0C\u800C\u4E0D\u662F <code>rootfs</code>\uFF0C\u53D6\u540D\u4E3A <code>pkg/blog_controller.go</code></p><p>\u6574\u4E2A\u63A7\u5236\u5668\u903B\u8F91\u90FD\u5199\u51FA\u6765\u4F1A\u6709\u4E9B\u6DF7\u4E71\uFF0C\u4E3A\u4E86\u6709\u52A9\u4E8E\u7406\u89E3\uFF0C\u6211\u4EEC\u7EE7\u627F\u7B2C\u4E00\u6B21\u9605\u8BFB controller.go \u7684\u65F6\u5019\u7684\u903B\u8F91\uFF0C\u518D\u5BF9 controller \u8FDB\u884C\u4E00\u6B21\u6DF1\u5165\u9605\u8BFB\u548C\u7F16\u5199\u3002</p><p>Controller \u7ED3\u6784\u4F53\u7684\u5B9A\u4E49\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// BlogController is the controller implementation for Blog resources</span>
<span class="token keyword">type</span> BlogController <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// kubeclientset is a standard kubernetes clientset</span>
	kubeclientset kubernetes<span class="token punctuation">.</span>Interface
	<span class="token comment">// shidaclientset is a clientset for our own API group</span>
	nsdddclientset clientset<span class="token punctuation">.</span>Interface
	deploymentsLister appslisters<span class="token punctuation">.</span>DeploymentLister
	deploymentsSynced cache<span class="token punctuation">.</span>InformerSynced
	blogsLister        listers<span class="token punctuation">.</span>BlogLister
	blogsSynced        cache<span class="token punctuation">.</span>InformerSynced
	workqueue workqueue<span class="token punctuation">.</span>RateLimitingInterface
	recorder record<span class="token punctuation">.</span>EventRecorder
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u5B9A\u4E49\u4E86\u4E00\u4E9B Clientset\uFF0C\u7528\u6765\u5BF9 Kubernetes \u7684 API Server \u8FDB\u884C\u4EA4\u4E92\uFF0C\u8FD9\u91CC\u4E5F\u5B9A\u4E49\u4E86\u4E00\u4E9B Lister\uFF0C\u7528\u6765\u83B7\u53D6 Kubernetes \u7684 API \u7684\u4FE1\u606F\uFF0C\u5728 Lister \u4E2D\u5229\u7528\u7F13\u5B58\u4E5F\u80FD\u51CF\u5C11\u5BF9 API Server \u7684\u8BBF\u95EE\u538B\u529B\u3002</p><p>workqueue \u548C Informer \u5171\u540C\u5B8C\u6210 Kubernetes controller \u7684\u6838\u5FC3\uFF1A\u8C03\u8C10\u7684\u6B65\u9AA4</p><p>\u7EE7\u7EED\uFF0C\u627E\u5230\u521D\u59CB\u5316 Controller \u7684\u5730\u65B9(<code>NewBlogController</code>)\uFF0C\u8FD9\u4E2A\u903B\u8F91\u4F5C\u4E3A\u5165\u53E3\u4F9B main.go \u521D\u59CB\u5316\uFF0C\u6240\u4EE5\u548C <code>Run()</code> \u7528\u5927\u5199\u8C03\u7528\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewBlogController</span><span class="token punctuation">(</span>
	kubeclientset kubernetes<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	nsdddcclientset clientset<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	deploymentInformer appsinformers<span class="token punctuation">.</span>DeploymentInformer<span class="token punctuation">,</span>
	blogInformer informers<span class="token punctuation">.</span>BlogInformer<span class="token punctuation">)</span> <span class="token operator">*</span>BlogController <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Creating event broadcaster&quot;</span><span class="token punctuation">)</span>
	eventBroadcaster <span class="token operator">:=</span> record<span class="token punctuation">.</span><span class="token function">NewBroadcaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	eventBroadcaster<span class="token punctuation">.</span><span class="token function">StartLogging</span><span class="token punctuation">(</span>klog<span class="token punctuation">.</span>Infof<span class="token punctuation">)</span>
	eventBroadcaster<span class="token punctuation">.</span><span class="token function">StartRecordingToSink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>typedcorev1<span class="token punctuation">.</span>EventSinkImpl<span class="token punctuation">{</span>Interface<span class="token punctuation">:</span> kubeclientset<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Events</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	recorder <span class="token operator">:=</span> eventBroadcaster<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> corev1<span class="token punctuation">.</span>EventSource<span class="token punctuation">{</span>Component<span class="token punctuation">:</span> blogControllerAgentName<span class="token punctuation">}</span><span class="token punctuation">)</span>

	controller <span class="token operator">:=</span> <span class="token operator">&amp;</span>BlogController<span class="token punctuation">{</span>
		kubeclientset<span class="token punctuation">:</span>     kubeclientset<span class="token punctuation">,</span>
		nsdddcclientset<span class="token punctuation">:</span>   nsdddcclientset<span class="token punctuation">,</span>
		deploymentsLister<span class="token punctuation">:</span> deploymentInformer<span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		deploymentsSynced<span class="token punctuation">:</span> deploymentInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">,</span>
		blogsLister<span class="token punctuation">:</span>        blogInformer<span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		blogsSynced<span class="token punctuation">:</span>        blogInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">,</span>
		workqueue<span class="token punctuation">:</span>         workqueue<span class="token punctuation">.</span><span class="token function">NewNamedRateLimitingQueue</span><span class="token punctuation">(</span>workqueue<span class="token punctuation">.</span><span class="token function">DefaultControllerRateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Blogs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		recorder<span class="token punctuation">:</span>          recorder<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Setting up event handlers&quot;</span><span class="token punctuation">)</span>
	blogInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
		AddFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>enqueueBlog<span class="token punctuation">,</span>
		UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			controller<span class="token punctuation">.</span><span class="token function">enqueueBlog</span><span class="token punctuation">(</span><span class="token builtin">new</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	deploymentInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
		AddFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>handleObject<span class="token punctuation">,</span>
		UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			newDepl <span class="token operator">:=</span> <span class="token builtin">new</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span>
			oldDepl <span class="token operator">:=</span> old<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span>
			<span class="token keyword">if</span> newDepl<span class="token punctuation">.</span>ResourceVersion <span class="token operator">==</span> oldDepl<span class="token punctuation">.</span>ResourceVersion <span class="token punctuation">{</span>
				<span class="token comment">// Periodic resync will send update events for all known Deployments.</span>
				<span class="token comment">// Two different versions of the same Deployment will always have different RVs.</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			controller<span class="token punctuation">.</span><span class="token function">handleObject</span><span class="token punctuation">(</span><span class="token builtin">new</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		DeleteFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>handleObject<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> controller
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AddToScheme</code> \u7528\u4E8E\u5411 <code>runtime.Scheme</code> \u4E2D\u6DFB\u52A0\u65B0\u7684 API \u5BF9\u8C61\u3002<code>runtime.Scheme</code> \u662F\u4E00\u4E2A\u5B58\u50A8 Kubernetes API \u5BF9\u8C61 Schema \u7684\u5BF9\u8C61\uFF0C\u7528\u4E8E\u8DE8 API \u7248\u672C\u548C API \u7EC4\u5171\u4EAB\u7C7B\u578B\u4FE1\u606F\u3002\u901A\u8FC7\u4F7F\u7528 AddToScheme \u65B9\u6CD5\uFF0C\u60A8\u53EF\u4EE5\u5C06\u81EA\u5B9A\u4E49 API \u5BF9\u8C61\u6DFB\u52A0\u5230 <code>runtime.Scheme</code> \u4E2D\uFF0C\u4EE5\u4FBF\u5728 Kubernetes API \u4E2D\u4F7F\u7528\u81EA\u5B9A\u4E49 API \u5BF9\u8C61\u3002</p><blockquote><p>Scheme \u662F\u4E00\u4E2A\u7528\u4E8E\u5B58\u50A8 Kubernetes API \u5BF9\u8C61 Schema \u7684\u5BF9\u8C61\uFF0C\u5B83\u662F Kubernetes API \u7684\u4E00\u90E8\u5206\uFF0C\u7528\u4E8E\u8DE8 API \u7248\u672C\u548C API \u7EC4\u5171\u4EAB\u7C7B\u578B\u4FE1\u606F\u3002\u5B83\u5141\u8BB8\u6CE8\u518C\u548C\u7BA1\u7406\u81EA\u5B9A\u4E49 API \u5BF9\u8C61\uFF0C\u5E76\u4E14\u8FD8\u63D0\u4F9B\u4E86\u4E00\u4E9B\u8F85\u52A9\u65B9\u6CD5\uFF0C\u4F8B\u5982\u5E8F\u5217\u5316\u548C\u53CD\u5E8F\u5217\u5316 Kubernetes \u5BF9\u8C61\u3002</p></blockquote><p>\u6211\u4EEC\u77E5\u9053\u4E86 <code>Informer</code> \u662F\u7528\u4E8EInformer \u76D1\u89C6\u67D0\u4E9B\u8D44\u6E90\u7684\u5BF9\u8C61\uFF0C\u5B83\u4F1A\u5728\u8D44\u6E90\u53D1\u751F\u53D8\u5316\u65F6\u901A\u77E5\u63A7\u5236\u5668\u3002\u90A3\u4E48 \u5B9A\u4E49\u7684 <code>HasSynced</code> \u662F\u4EC0\u4E48\uFF0C\u6211\u4EEC\u53EF\u4EE5\u770B\u4E0B\u5B9A\u4E49\uFF1A</p><blockquote><p>HasSynced \u662F\u4E00\u4E2A\u51FD\u6570\uFF0C\u7528\u4E8E\u68C0\u67E5 Informer \u662F\u5426\u5DF2\u7ECF\u5B8C\u6210\u4E86\u8D44\u6E90\u7684\u540C\u6B65\u3002\u5F53\u8C03\u7528 Informer \u7684 HasSynced \u51FD\u6570\u65F6\uFF0C\u5982\u679C\u6240\u6709\u76D1\u63A7\u7684\u8D44\u6E90\u90FD\u5DF2\u7ECF\u540C\u6B65\u5B8C\u6210\uFF0C\u51FD\u6570\u5C06\u8FD4\u56DE true\u3002</p></blockquote><p><code>AddEventHandler</code> \u662F\u4E00\u4E2A\u4E3A Informer \u6CE8\u518C\u4E8B\u4EF6\u5904\u7406\u51FD\u6570\u3002</p><p>\u5176\u4ED6\u7684\u5B9A\u4E49\u90E8\u5206\uFF1A</p><details class="custom-container details"><summary>\u5C55\u5F00\u4EE3\u7801\u5757</summary><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">/*
Copyright 2017 The Kubernetes Authors.
Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>

	appsv1 <span class="token string">&quot;k8s.io/api/apps/v1&quot;</span>
	corev1 <span class="token string">&quot;k8s.io/api/core/v1&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/api/errors&quot;</span>
	metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span>
	utilruntime <span class="token string">&quot;k8s.io/apimachinery/pkg/util/runtime&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/util/wait&quot;</span>
	appsinformers <span class="token string">&quot;k8s.io/client-go/informers/apps/v1&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/kubernetes&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/kubernetes/scheme&quot;</span>
	typedcorev1 <span class="token string">&quot;k8s.io/client-go/kubernetes/typed/core/v1&quot;</span>
	appslisters <span class="token string">&quot;k8s.io/client-go/listers/apps/v1&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/tools/cache&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/tools/record&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/util/workqueue&quot;</span>
	<span class="token string">&quot;k8s.io/klog/v2&quot;</span>

	nsdddv1beta1 <span class="token string">&quot;k8s.io/sample-controller/pkg/apis/nsdddcontroller/v1beta1&quot;</span>
	clientset <span class="token string">&quot;k8s.io/sample-controller/pkg/generated_blog/clientset/versioned&quot;</span>
	samplescheme <span class="token string">&quot;k8s.io/sample-controller/pkg/generated_blog/clientset/versioned/scheme&quot;</span>
	informers <span class="token string">&quot;k8s.io/sample-controller/pkg/generated_blog/informers/externalversions/nsdddcontroller/v1beta1&quot;</span>
	listers <span class="token string">&quot;k8s.io/sample-controller/pkg/generated_blog/listers/nsdddcontroller/v1beta1&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> blogControllerAgentName <span class="token operator">=</span> <span class="token string">&quot;nsddd-controller&quot;</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token comment">// BlogSuccessSynced is used as part of the Event &#39;reason&#39; when a Blog is synced</span>
	BlogSuccessSynced <span class="token operator">=</span> <span class="token string">&quot;Synced&quot;</span>
	<span class="token comment">// BlogErrResourceExists is used as part of the Event &#39;reason&#39; when a Blog fails</span>
	<span class="token comment">// to sync due to a Deployment of the same name already existing.</span>
	BlogErrResourceExists <span class="token operator">=</span> <span class="token string">&quot;ErrResourceExists&quot;</span>

	<span class="token comment">// BlogMessageResourceExists is the message used for Events when a resource</span>
	<span class="token comment">// fails to sync due to a Deployment already existing</span>
	BlogMessageResourceExists <span class="token operator">=</span> <span class="token string">&quot;Resource %q already exists and is not managed by Blog&quot;</span>
	<span class="token comment">// BlogMessageResourceSynced is the message used for an Event fired when a Blog</span>
	<span class="token comment">// is synced successfully</span>
	BlogMessageResourceSynced <span class="token operator">=</span> <span class="token string">&quot;Blog synced successfully&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// BlogController is the controller implementation for Blog resources</span>
<span class="token keyword">type</span> BlogController <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// kubeclientset is a standard kubernetes clientset</span>
	kubeclientset kubernetes<span class="token punctuation">.</span>Interface
	<span class="token comment">// nsdddclientset is a clientset for our own API group</span>
	nsdddclientset clientset<span class="token punctuation">.</span>Interface

	deploymentsLister appslisters<span class="token punctuation">.</span>DeploymentLister
	deploymentsSynced cache<span class="token punctuation">.</span>InformerSynced
	blogsLister       listers<span class="token punctuation">.</span>BlogLister
	blogsSynced       cache<span class="token punctuation">.</span>InformerSynced

	<span class="token comment">// workqueue is a rate limited work queue. This is used to queue work to be</span>
	<span class="token comment">// processed instead of performing it as soon as a change happens. This</span>
	<span class="token comment">// means we can ensure we only process a fixed amount of resources at a</span>
	<span class="token comment">// time, and makes it easy to ensure we are never processing the same item</span>
	<span class="token comment">// simultaneously in two different workers.</span>
	workqueue workqueue<span class="token punctuation">.</span>RateLimitingInterface
	<span class="token comment">// recorder is an event recorder for recording Event resources to the</span>
	<span class="token comment">// Kubernetes API.</span>
	recorder record<span class="token punctuation">.</span>EventRecorder
<span class="token punctuation">}</span>

<span class="token comment">// NewBlogController returns a new sample controller</span>
<span class="token keyword">func</span> <span class="token function">NewBlogController</span><span class="token punctuation">(</span>
	kubeclientset kubernetes<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	nsdddclientset clientset<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span>
	deploymentInformer appsinformers<span class="token punctuation">.</span>DeploymentInformer<span class="token punctuation">,</span>
	blogInformer informers<span class="token punctuation">.</span>BlogInformer<span class="token punctuation">)</span> <span class="token operator">*</span>BlogController <span class="token punctuation">{</span>

	<span class="token comment">// Create event broadcaster</span>
	<span class="token comment">// Add sample-controller types to the default Kubernetes Scheme so Events can be</span>
	<span class="token comment">// logged for sample-controller types.</span>
	utilruntime<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>samplescheme<span class="token punctuation">.</span><span class="token function">AddToScheme</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Creating event broadcaster&quot;</span><span class="token punctuation">)</span>
	eventBroadcaster <span class="token operator">:=</span> record<span class="token punctuation">.</span><span class="token function">NewBroadcaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	eventBroadcaster<span class="token punctuation">.</span><span class="token function">StartLogging</span><span class="token punctuation">(</span>klog<span class="token punctuation">.</span>Infof<span class="token punctuation">)</span>
	eventBroadcaster<span class="token punctuation">.</span><span class="token function">StartRecordingToSink</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>typedcorev1<span class="token punctuation">.</span>EventSinkImpl<span class="token punctuation">{</span>Interface<span class="token punctuation">:</span> kubeclientset<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Events</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	recorder <span class="token operator">:=</span> eventBroadcaster<span class="token punctuation">.</span><span class="token function">NewRecorder</span><span class="token punctuation">(</span>scheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> corev1<span class="token punctuation">.</span>EventSource<span class="token punctuation">{</span>Component<span class="token punctuation">:</span> blogControllerAgentName<span class="token punctuation">}</span><span class="token punctuation">)</span>

	controller <span class="token operator">:=</span> <span class="token operator">&amp;</span>BlogController<span class="token punctuation">{</span>
		kubeclientset<span class="token punctuation">:</span>     kubeclientset<span class="token punctuation">,</span>
		nsdddclientset<span class="token punctuation">:</span>    nsdddclientset<span class="token punctuation">,</span>
		deploymentsLister<span class="token punctuation">:</span> deploymentInformer<span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		deploymentsSynced<span class="token punctuation">:</span> deploymentInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">,</span>
		blogsLister<span class="token punctuation">:</span>       blogInformer<span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		blogsSynced<span class="token punctuation">:</span>       blogInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HasSynced<span class="token punctuation">,</span>
		workqueue<span class="token punctuation">:</span>         workqueue<span class="token punctuation">.</span><span class="token function">NewNamedRateLimitingQueue</span><span class="token punctuation">(</span>workqueue<span class="token punctuation">.</span><span class="token function">DefaultControllerRateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Blogs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		recorder<span class="token punctuation">:</span>          recorder<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Setting up event handlers&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// Set up an event handler for when Blog resources change</span>
	blogInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
		AddFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>enqueueBlog<span class="token punctuation">,</span>
		UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			controller<span class="token punctuation">.</span><span class="token function">enqueueBlog</span><span class="token punctuation">(</span><span class="token builtin">new</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// Set up an event handler for when Deployment resources change. This</span>
	<span class="token comment">// handler will lookup the owner of the given Deployment, and if it is</span>
	<span class="token comment">// owned by a Blog resource will enqueue that Blog resource for</span>
	<span class="token comment">// processing. This way, we don&#39;t need to implement custom logic for</span>
	<span class="token comment">// handling Deployment resources. More info on this pattern:</span>
	<span class="token comment">// https://github.com/kubernetes/community/blob/8cafef897a22026d42f5e5bb3f104febe7e29830/contributors/devel/controllers.md</span>
	deploymentInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
		AddFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>handleObject<span class="token punctuation">,</span>
		UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			newDepl <span class="token operator">:=</span> <span class="token builtin">new</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span>
			oldDepl <span class="token operator">:=</span> old<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span>
			<span class="token keyword">if</span> newDepl<span class="token punctuation">.</span>ResourceVersion <span class="token operator">==</span> oldDepl<span class="token punctuation">.</span>ResourceVersion <span class="token punctuation">{</span>
				<span class="token comment">// Periodic resync will send update events for all known Deployments.</span>
				<span class="token comment">// Two different versions of the same Deployment will always have different RVs.</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			controller<span class="token punctuation">.</span><span class="token function">handleObject</span><span class="token punctuation">(</span><span class="token builtin">new</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		DeleteFunc<span class="token punctuation">:</span> controller<span class="token punctuation">.</span>handleObject<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> controller
<span class="token punctuation">}</span>

<span class="token comment">// Run will set up the event handlers for types we are interested in, as well</span>
<span class="token comment">// as syncing informer caches and starting workers. It will block until stopCh</span>
<span class="token comment">// is closed, at which point it will shutdown the workqueue and wait for</span>
<span class="token comment">// workers to finish processing their current work items.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BlogController<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>threadiness <span class="token builtin">int</span><span class="token punctuation">,</span> stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> utilruntime<span class="token punctuation">.</span><span class="token function">HandleCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">ShutDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Start the informer factories to begin populating the informer caches</span>
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting Blog controller&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// Wait for the caches to be synced before starting workers</span>
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting for informer caches to sync&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">WaitForCacheSync</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">,</span> c<span class="token punctuation">.</span>deploymentsSynced<span class="token punctuation">,</span> c<span class="token punctuation">.</span>blogsSynced<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to wait for caches to sync&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Starting workers&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// Launch two workers to process Blog resources</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadiness<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>runWorker<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Started workers&quot;</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>stopCh
	klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down workers&quot;</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// runWorker is a long-running function that will continually call the</span>
<span class="token comment">// processNextWorkItem function in order to read and process a message on the</span>
<span class="token comment">// workqueue.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BlogController<span class="token punctuation">)</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> c<span class="token punctuation">.</span><span class="token function">processNextWorkItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// processNextWorkItem will read a single work item off the workqueue and</span>
<span class="token comment">// attempt to process it, by calling the syncHandler.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BlogController<span class="token punctuation">)</span> <span class="token function">processNextWorkItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	obj<span class="token punctuation">,</span> shutdown <span class="token operator">:=</span> c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> shutdown <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// We wrap this block in a func so we can defer c.workqueue.Done.</span>
	err <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		<span class="token comment">// We call Done here so the workqueue knows we have finished</span>
		<span class="token comment">// processing this item. We also must remember to call Forget if we</span>
		<span class="token comment">// do not want this work item being re-queued. For example, we do</span>
		<span class="token comment">// not call Forget if a transient error occurs, instead the item is</span>
		<span class="token comment">// put back on the workqueue and attempted again after a back-off</span>
		<span class="token comment">// period.</span>
		<span class="token keyword">defer</span> c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
		<span class="token keyword">var</span> key <span class="token builtin">string</span>
		<span class="token keyword">var</span> ok <span class="token builtin">bool</span>
		<span class="token comment">// We expect strings to come off the workqueue. These are of the</span>
		<span class="token comment">// form namespace/name. We do this as the delayed nature of the</span>
		<span class="token comment">// workqueue means the items in the informer cache may actually be</span>
		<span class="token comment">// more up to date that when the item was initially put onto the</span>
		<span class="token comment">// workqueue.</span>
		<span class="token keyword">if</span> key<span class="token punctuation">,</span> ok <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// As the item in the workqueue is actually invalid, we call</span>
			<span class="token comment">// Forget here else we&#39;d go into a loop of attempting to</span>
			<span class="token comment">// process a work item that is invalid.</span>
			c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">Forget</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;expected string in workqueue but got %#v&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Run the syncHandler, passing it the namespace/name string of the</span>
		<span class="token comment">// Blog resource to be synced.</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">syncHandler</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token comment">// Put the item back on the workqueue to handle any transient errors.</span>
			c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">AddRateLimited</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error syncing &#39;%s&#39;: %s, requeuing&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// Finally, if no error occurs we Forget this item so it does not</span>
		<span class="token comment">// get queued again until another change happens.</span>
		c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">Forget</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Successfully synced &#39;%s&#39;&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">// syncHandler compares the actual state with the desired, and attempts to</span>
<span class="token comment">// converge the two. It then updates the Status block of the Blog resource</span>
<span class="token comment">// with the current status of the resource.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BlogController<span class="token punctuation">)</span> <span class="token function">syncHandler</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// Convert the namespace/name string into a distinct namespace and name</span>
	namespace<span class="token punctuation">,</span> name<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">SplitMetaNamespaceKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid resource key: %s&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Get the Blog resource with this namespace/name</span>
	blog<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>blogsLister<span class="token punctuation">.</span><span class="token function">Blogs</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// The Blog resource may no longer exist, in which case we stop</span>
		<span class="token comment">// processing.</span>
		<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;blog &#39;%s&#39; in work queue no longer exists&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	deploymentName <span class="token operator">:=</span> blog<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>DeploymentName
	<span class="token keyword">if</span> deploymentName <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token comment">// We choose to absorb the error here as the worker would requeue the</span>
		<span class="token comment">// resource otherwise. Instead, the next time the resource is updated</span>
		<span class="token comment">// the resource will be queued again.</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: deployment name must be specified&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Get the deployment with the name specified in Blog.spec</span>
	deployment<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>deploymentsLister<span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>deploymentName<span class="token punctuation">)</span>
	<span class="token comment">// If the resource doesn&#39;t exist, we&#39;ll create it</span>
	<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		deployment<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span>kubeclientset<span class="token punctuation">.</span><span class="token function">AppsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">newBlogDeployment</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>CreateOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// If an error occurs during Get/Create, we&#39;ll requeue the item so we can</span>
	<span class="token comment">// attempt processing again later. This could have been caused by a</span>
	<span class="token comment">// temporary network failure, or any other transient reason.</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// If the Deployment is not controlled by this Blog resource, we should log</span>
	<span class="token comment">// a warning to the event recorder and ret</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>metav1<span class="token punctuation">.</span><span class="token function">IsControlledBy</span><span class="token punctuation">(</span>deployment<span class="token punctuation">,</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>BlogMessageResourceExists<span class="token punctuation">,</span> deployment<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>recorder<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span>blog<span class="token punctuation">,</span> corev1<span class="token punctuation">.</span>EventTypeWarning<span class="token punctuation">,</span> BlogErrResourceExists<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// If this number of the replicas on the Blog resource is specified, and the</span>
	<span class="token comment">// number does not equal the current desired replicas on the Deployment, we</span>
	<span class="token comment">// should update the Deployment resource.</span>
	<span class="token keyword">if</span> blog<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>blog<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas <span class="token operator">!=</span> <span class="token operator">*</span>deployment<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Blog %s replicas: %d, deployment replicas: %d&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">*</span>blog<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas<span class="token punctuation">,</span> <span class="token operator">*</span>deployment<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas<span class="token punctuation">)</span>
		deployment<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span>kubeclientset<span class="token punctuation">.</span><span class="token function">AppsV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">newBlogDeployment</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>UpdateOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// If an error occurs during Update, we&#39;ll requeue the item so we can</span>
	<span class="token comment">// attempt processing again later. THis could have been caused by a</span>
	<span class="token comment">// temporary network failure, or any other transient reason.</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// Finally, we update the status block of the Blog resource to reflect the</span>
	<span class="token comment">// current state of the world</span>
	err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">updateBlogStatus</span><span class="token punctuation">(</span>blog<span class="token punctuation">,</span> deployment<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	c<span class="token punctuation">.</span>recorder<span class="token punctuation">.</span><span class="token function">Event</span><span class="token punctuation">(</span>blog<span class="token punctuation">,</span> corev1<span class="token punctuation">.</span>EventTypeNormal<span class="token punctuation">,</span> BlogSuccessSynced<span class="token punctuation">,</span> BlogMessageResourceSynced<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BlogController<span class="token punctuation">)</span> <span class="token function">updateBlogStatus</span><span class="token punctuation">(</span>blog <span class="token operator">*</span>nsdddv1beta1<span class="token punctuation">.</span>Blog<span class="token punctuation">,</span> deployment <span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// NEVER modify objects from the store. It&#39;s a read-only, local cache.</span>
	<span class="token comment">// You can use DeepCopy() to make a deep copy of original object and modify this copy</span>
	<span class="token comment">// Or create a copy manually for better performance</span>
	blogCopy <span class="token operator">:=</span> blog<span class="token punctuation">.</span><span class="token function">DeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	blogCopy<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>AvailableReplicas <span class="token operator">=</span> deployment<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>AvailableReplicas
	<span class="token comment">// If the CustomResourceSubresources feature gate is not enabled,</span>
	<span class="token comment">// we must use Update instead of UpdateStatus to update the Status block of the Blog resource.</span>
	<span class="token comment">// UpdateStatus will not allow changes to the Spec of the resource,</span>
	<span class="token comment">// which is ideal for ensuring nothing other than resource status has been updated.</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>nsdddclientset<span class="token punctuation">.</span><span class="token function">ControllerV1beta1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Blogs</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UpdateStatus</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> blogCopy<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>UpdateOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>

<span class="token comment">// enqueueBlog takes a Blog resource and converts it into a namespace/name</span>
<span class="token comment">// string which is then put onto the work queue. This method should *not* be</span>
<span class="token comment">// passed resources of any type other than Blog.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BlogController<span class="token punctuation">)</span> <span class="token function">enqueueBlog</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> key <span class="token builtin">string</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	<span class="token keyword">if</span> key<span class="token punctuation">,</span> err <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">MetaNamespaceKeyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>workqueue<span class="token punctuation">.</span><span class="token function">AddRateLimited</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// handleObject will take any resource implementing metav1.Object and attempt</span>
<span class="token comment">// to find the Blog resource that &#39;owns&#39; it. It does this by looking at the</span>
<span class="token comment">// objects metadata.ownerReferences field for an appropriate OwnerReference.</span>
<span class="token comment">// It then enqueues that Blog resource to be processed. If the object does not</span>
<span class="token comment">// have an appropriate OwnerReference, it will simply be skipped.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BlogController<span class="token punctuation">)</span> <span class="token function">handleObject</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> object metav1<span class="token punctuation">.</span>Object
	<span class="token keyword">var</span> ok <span class="token builtin">bool</span>
	<span class="token keyword">if</span> object<span class="token punctuation">,</span> ok <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		tombstone<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>DeletedFinalStateUnknown<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error decoding object, invalid type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		object<span class="token punctuation">,</span> ok <span class="token operator">=</span> tombstone<span class="token punctuation">.</span>Obj<span class="token punctuation">.</span><span class="token punctuation">(</span>metav1<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;error decoding object tombstone, invalid type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Recovered deleted object &#39;%s&#39; from tombstone&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Processing object: %s&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ownerRef <span class="token operator">:=</span> metav1<span class="token punctuation">.</span><span class="token function">GetControllerOf</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span> ownerRef <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// If this object is not owned by a Blog, we should not do anything more</span>
		<span class="token comment">// with it.</span>
		<span class="token keyword">if</span> ownerRef<span class="token punctuation">.</span>Kind <span class="token operator">!=</span> <span class="token string">&quot;Blog&quot;</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		blog<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>blogsLister<span class="token punctuation">.</span><span class="token function">Blogs</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ownerRef<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;ignoring orphaned object &#39;%s&#39; of blog &#39;%s&#39;&quot;</span><span class="token punctuation">,</span> object<span class="token punctuation">.</span><span class="token function">GetSelfLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ownerRef<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		c<span class="token punctuation">.</span><span class="token function">enqueueBlog</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// newBlogDeployment creates a new Deployment for a Blog resource. It also sets</span>
<span class="token comment">// the appropriate OwnerReferences on the resource so handleObject can discover</span>
<span class="token comment">// the Blog resource that &#39;owns&#39; it.</span>
<span class="token keyword">func</span> <span class="token function">newBlogDeployment</span><span class="token punctuation">(</span>blog <span class="token operator">*</span>nsdddv1beta1<span class="token punctuation">.</span>Blog<span class="token punctuation">)</span> <span class="token operator">*</span>appsv1<span class="token punctuation">.</span>Deployment <span class="token punctuation">{</span>
	labels <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
		<span class="token string">&quot;app&quot;</span><span class="token punctuation">:</span>        <span class="token string">&quot;nginx&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;controller&quot;</span><span class="token punctuation">:</span> blog<span class="token punctuation">.</span>Name<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>appsv1<span class="token punctuation">.</span>Deployment<span class="token punctuation">{</span>
		ObjectMeta<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">{</span>
			Name<span class="token punctuation">:</span>      blog<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>DeploymentName<span class="token punctuation">,</span>
			Namespace<span class="token punctuation">:</span> blog<span class="token punctuation">.</span>Namespace<span class="token punctuation">,</span>
			OwnerReferences<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>metav1<span class="token punctuation">.</span>OwnerReference<span class="token punctuation">{</span>
				<span class="token operator">*</span>metav1<span class="token punctuation">.</span><span class="token function">NewControllerRef</span><span class="token punctuation">(</span>blog<span class="token punctuation">,</span> schema<span class="token punctuation">.</span>GroupVersionKind<span class="token punctuation">{</span>
					Group<span class="token punctuation">:</span>   nsdddv1beta1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">.</span>Group<span class="token punctuation">,</span>
					Version<span class="token punctuation">:</span> nsdddv1beta1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">.</span>Version<span class="token punctuation">,</span>
					Kind<span class="token punctuation">:</span>    <span class="token string">&quot;Blog&quot;</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		Spec<span class="token punctuation">:</span> appsv1<span class="token punctuation">.</span>DeploymentSpec<span class="token punctuation">{</span>
			Replicas<span class="token punctuation">:</span> blog<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Replicas<span class="token punctuation">,</span>
			Selector<span class="token punctuation">:</span> <span class="token operator">&amp;</span>metav1<span class="token punctuation">.</span>LabelSelector<span class="token punctuation">{</span>
				MatchLabels<span class="token punctuation">:</span> labels<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			Template<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>PodTemplateSpec<span class="token punctuation">{</span>
				ObjectMeta<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">{</span>
					Labels<span class="token punctuation">:</span> labels<span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				Spec<span class="token punctuation">:</span> corev1<span class="token punctuation">.</span>PodSpec<span class="token punctuation">{</span>
					Containers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>corev1<span class="token punctuation">.</span>Container<span class="token punctuation">{</span>
						<span class="token punctuation">{</span>
							Name<span class="token punctuation">:</span>  <span class="token string">&quot;nginx&quot;</span><span class="token punctuation">,</span>
							Image<span class="token punctuation">:</span> <span class="token string">&quot;nginx:latest&quot;</span><span class="token punctuation">,</span>
						<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="\u542F\u52A8\u63A7\u5236\u5668" tabindex="-1"><a class="header-anchor" href="#\u542F\u52A8\u63A7\u5236\u5668" aria-hidden="true">#</a> \u542F\u52A8\u63A7\u5236\u5668</h3><p>\u6700\u540E\uFF0C\u5728 <code>pkg/main.go</code> \u91CC\u521B\u5EFA\u6211\u4EEC\u7684 Blog Controller\uFF0C\u5E76\u542F\u52A8\u63A7\u5236\u5668</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">/*
Copyright 2017 The Kubernetes Authors.
Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;time&quot;</span>

	kubeinformers <span class="token string">&quot;k8s.io/client-go/informers&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/kubernetes&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span>
	<span class="token string">&quot;k8s.io/klog/v2&quot;</span>

	<span class="token comment">// Uncomment the following line to load the gcp plugin (only required to authenticate against GKE clusters).</span>
	<span class="token comment">// _ &quot;k8s.io/client-go/plugin/pkg/client/auth/gcp&quot;</span>

	clientset <span class="token string">&quot;k8s.io/sample-controller/pkg/generated/clientset/versioned&quot;</span>
	informers <span class="token string">&quot;k8s.io/sample-controller/pkg/generated/informers/externalversions&quot;</span>

	blogclientset <span class="token string">&quot;k8s.io/sample-controller/pkg/generated_blog/clientset/versioned&quot;</span>
	bloginformers <span class="token string">&quot;k8s.io/sample-controller/pkg/generated_blog/informers/externalversions&quot;</span>
	<span class="token string">&quot;k8s.io/sample-controller/pkg/signals&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	masterURL  <span class="token builtin">string</span>
	kubeconfig <span class="token builtin">string</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// set up signals so we handle the shutdown signal gracefully</span>
	ctx <span class="token operator">:=</span> signals<span class="token punctuation">.</span><span class="token function">SetupSignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	logger <span class="token operator">:=</span> klog<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>

	cfg<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span>masterURL<span class="token punctuation">,</span> kubeconfig<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error building kubeconfig&quot;</span><span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Error building kubeconfig: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	kubeClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubernetes<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error building kubernetes clientset&quot;</span><span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Error building kubernetes clientset: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	exampleClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error building exampleClient is clientset&quot;</span><span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Error building example clientset: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	blogClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> blogclientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">&quot;Error building blogClient is clientset&quot;</span><span class="token punctuation">)</span>
		klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Error building blog clientset: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	kubeInformerFactory <span class="token operator">:=</span> kubeinformers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>kubeClient<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>
	exampleInformerFactory <span class="token operator">:=</span> informers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>exampleClient<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>
	blogInformerFactory <span class="token operator">:=</span> bloginformers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>blogClient<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>

	blogController <span class="token operator">:=</span> <span class="token function">NewBlogController</span><span class="token punctuation">(</span>kubeClient<span class="token punctuation">,</span> blogClient<span class="token punctuation">,</span>
		kubeInformerFactory<span class="token punctuation">.</span><span class="token function">Apps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Deployments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		blogInformerFactory<span class="token punctuation">.</span><span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1beta1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Blogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// notice that there is no need to run Start methods in a separate goroutine. (i.e. go kubeInformerFactory.Start(ctx.Done())</span>
	<span class="token comment">// Start method is non-blocking and runs all registered informers in a dedicated goroutine.</span>
	kubeInformerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	exampleInformerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	blogInformerFactory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		err <span class="token operator">=</span> blogController<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Error running controller: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">=</span> blogController<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Error running controller: %s&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>kubeconfig<span class="token punctuation">,</span> <span class="token string">&quot;kubeconfig&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Path to a kubeconfig. Only required if out-of-cluster.&quot;</span><span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>masterURL<span class="token punctuation">,</span> <span class="token string">&quot;master&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u9A8C\u8BC1" tabindex="-1"><a class="header-anchor" href="#\u9A8C\u8BC1" aria-hidden="true">#</a> \u9A8C\u8BC1</h3><p><strong>\u91CD\u65B0\u7F16\u8BD1 sample-controller \u9879\u76EE\uFF0C\u5E76\u8FD0\u884C sample-controller CRD \u63A7\u5236\u5668</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># assumes you have a working kubeconfig, not required if operating in-cluster</span>
go build <span class="token parameter variable">-o</span> sample-controller <span class="token builtin class-name">.</span>
./sample-controller <span class="token parameter variable">-kubeconfig</span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/.kube/config

<span class="token comment"># create a CustomResourceDefinition</span>
kubectl create <span class="token parameter variable">-f</span> artifacts/examples/crd-status-subresource.yaml

<span class="token comment"># create a custom resource of type Foo</span>
kubectl create <span class="token parameter variable">-f</span> artifacts/examples/example-foo.yaml

<span class="token comment"># check deployments created through the custom resource</span>
kubectl get deployments
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u4F7F\u7528-kubebuilder-\u6784\u5EFA" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528-kubebuilder-\u6784\u5EFA" aria-hidden="true">#</a> \u4F7F\u7528 Kubebuilder \u6784\u5EFA</h2><h2 id="end-\u94FE\u63A5" tabindex="-1"><a class="header-anchor" href="#end-\u94FE\u63A5" aria-hidden="true">#</a> END \u94FE\u63A5</h2><ul><li><div><a href="65.md" style="float:left;">\u2B06\uFE0F\u4E0A\u4E00\u8282\u{1F517} </a><a href="67.md" style="float:right;"> \uFE0F\u4E0B\u4E00\u8282\u{1F517}</a></div></li></ul>`,29),Un=s("\u24C2\uFE0F\u56DE\u5230\u76EE\u5F55\u{1F3E0}"),Wn={href:"https://nsddd.top/archives/contributors",target:"_blank",rel:"noopener noreferrer"},zn=n("strong",null,"\u{1FAF5}\u53C2\u4E0E\u8D21\u732E\u{1F49E}\u2764\uFE0F\u200D\u{1F525}\u{1F496}",-1),$n=s(")"),Yn=s("\u2734\uFE0F\u7248\u6743\u58F0\u660E \xA9 \uFF1A\u672C\u4E66\u6240\u6709\u5185\u5BB9\u9075\u5FAA"),Zn={href:"http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC",target:"_blank",rel:"noopener noreferrer"},Xn=s("CC-BY-SA 3.0\u534F\u8BAE\uFF08\u7F72\u540D-\u76F8\u540C\u65B9\u5F0F\u5171\u4EAB\uFF09\xA9"),Qn=n("p",null,[n("strong",null,"\u5173\u4E8ECRD\u6709\u4E00\u4E9B\u94FE\u63A5:")],-1),ns=n("li",null,"\u5B98\u65B9\u6587\u6863\uFF1Ahttps://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/",-1),ss=n("li",null,"\u5B98\u65B9\u89E3\u91CA\uFF1Ahttps://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#create-a-customresourcedefinition",-1),as=n("li",null,"CRD Yaml\u7684Schema\uFF1Ahttps://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#customresourcedefinition-v1beta1-apiextensions-k8s-io",-1),es=n("li",null,"https://kubernetes.feisky.xyz/cha-jian-kuo-zhan/api/customresourcedefinition",-1),ts=n("li",null,"https://book.kubebuilder.io/",-1),os={href:"https://github.com/kubernetes/community/blob/8cafef897a22026d42f5e5bb3f104febe7e29830/contributors/devel/controllers.md",target:"_blank",rel:"noopener noreferrer"},ps=s("kubernetes write controller"),cs=n("li",null,"\u4E66\u7C4D\uFF1A\u300AKubernetes Operator \u5F00\u53D1\u8FDB\u9636 - \u80E1\u6D9B\u300B \u4F46\u4E0D\u63A8\u8350\u8D2D\u4E70~",-1),is=n("p",null,[n("strong",null,"\u8FD9\u7BC7\u6587\u7AE0\u53C2\u8003\u7684\u535A\u5BA2\u8FDE\u63A5\uFF1A")],-1),ls={href:"https://xieys.club/code-generator-crd/",target:"_blank",rel:"noopener noreferrer"},us=s("\u4F7F\u7528code-generator\u751F\u6210crd\u7684clientset\u3001informer\u3001listers"),rs={href:"https://sq.163yun.com/blog/article/174980128954048512",target:"_blank",rel:"noopener noreferrer"},ds=s("kubernetes1.9\u7BA1\u4E2D\u7AA5\u8C79-CRD\u6982\u5FF5\u3001\u4F7F\u7528\u573A\u666F\u53CA\u5B9E\u4F8B"),ks={href:"https://segmentfault.com/a/1190000039706356",target:"_blank",rel:"noopener noreferrer"},ms=s("\u7ED3\u5408Kubebuilder\u4E0Ecode-generator\u5F00\u53D1Operator"),vs={href:"https://lailin.xyz/post/operator-kubebuilder-clientset.html",target:"_blank",rel:"noopener noreferrer"},bs=s("kubebuilder \u80FD\u5426\u751F\u6210\u7C7B\u4F3C client-go \u7684 sdk?"),gs={href:"https://blog.csdn.net/boling_cavalry/article/details/88917818",target:"_blank",rel:"noopener noreferrer"},hs=s("k8s\u81EA\u5B9A\u4E49controller\u4E09\u90E8\u66F2\u4E4B\u4E00:\u521B\u5EFACRD\uFF08Custom Resource Definition\uFF09"),fs={href:"http://www.asznl.com/post/43",target:"_blank",rel:"noopener noreferrer"},ys=s("sample-controller \u5B9E\u73B0\u81EA\u5B9A\u4E49 CRD"),qs={href:"https://itnext.io/building-an-operator-for-kubernetes-with-the-sample-controller-b4204be9ad56",target:"_blank",rel:"noopener noreferrer"},ws=s("sample-controller"),Cs=n("li",null,"\u8FD9\u662F\u7B2C\u4E00\u7BC7\u6587\u7AE0\uFF0C\u5C06\u63A2\u8BA8sample-controller\u3002",-1),Ss={href:"https://medium.com/p/17cbd3f07761",target:"_blank",rel:"noopener noreferrer"},xs=s("\u672C\u7CFB\u5217\u7684\u7B2C\u4E8C\u7BC7\u6587\u7AE0"),_s=s("\u5C06\u63A2\u7D22kubebuilder\u3002"),Rs={href:"https://medium.com/p/40a029ea056",target:"_blank",rel:"noopener noreferrer"},Is=s("\u672C\u7CFB\u5217\u7684\u7B2C\u4E09\u7BC7\u6587\u7AE0"),Ds=s("\u5C06\u63A2\u8BA8operator-sdk\u3002");function Es(As,js){const e=o("ExternalLinkIcon"),p=o("RouterLink");return i(),l("div",null,[n("ul",null,[n("li",null,[n("a",d,[k,a(e)])])]),m,v,b,n("blockquote",null,[n("p",null,[g,n("a",h,[f,a(e)])])]),y,q,w,C,n("ul",null,[n("li",null,[n("a",S,[x,a(e)])]),n("li",null,[n("a",_,[R,a(e)])])]),n("p",null,[I,n("a",D,[E,a(e)])]),A,n("p",null,[j,n("a",O,[N,a(e)])]),n("p",null,[F,n("a",T,[P,a(e)])]),n("blockquote",null,[n("p",null,[G,n("a",B,[L,a(e)]),K,n("a",J,[V,a(e)]),M,n("a",H,[U,a(e)]),W]),z]),$,n("p",null,[Y,n("a",Z,[X,a(e)]),Q]),nn,n("ul",null,[n("li",null,[n("a",sn,[an,a(e)])])]),en,n("table",null,[tn,n("tbody",null,[on,pn,n("tr",null,[n("td",null,[n("a",cn,[ln,a(e)])]),un,rn])])]),dn,n("p",null,[kn,n("a",mn,[vn,a(e)]),bn,gn,hn]),fn,n("p",null,[yn,n("a",qn,[wn,a(e)]),Cn,n("a",Sn,[xn,a(e)]),_n]),Rn,n("ul",null,[n("li",null,[n("a",In,[Dn,a(e)])])]),En,n("p",null,[An,n("a",jn,[On,a(e)]),Nn,n("a",Fn,[Tn,a(e)]),Pn]),n("ul",null,[n("li",null,[n("a",Gn,[Bn,a(e)])]),n("li",null,[n("a",Ln,[Kn,a(e)])])]),Jn,n("ul",null,[n("li",null,[n("a",Vn,[Mn,a(e)])])]),Hn,n("ul",null,[n("li",null,[n("p",null,[a(p,{to:"/"},{default:u(()=>[Un]),_:1})])]),n("li",null,[n("p",null,[n("a",Wn,[zn,a(e)]),$n])]),n("li",null,[n("p",null,[Yn,n("a",Zn,[Xn,a(e)])])])]),Qn,n("ul",null,[ns,ss,as,es,ts,n("li",null,[n("a",os,[ps,a(e)])]),cs]),is,n("ul",null,[n("li",null,[n("p",null,[n("a",ls,[us,a(e)])])]),n("li",null,[n("p",null,[n("a",rs,[ds,a(e)])])]),n("li",null,[n("p",null,[n("a",ks,[ms,a(e)])])]),n("li",null,[n("p",null,[n("a",vs,[bs,a(e)])])]),n("li",null,[n("p",null,[n("a",gs,[hs,a(e)])])]),n("li",null,[n("p",null,[n("a",fs,[ys,a(e)])])]),n("li",null,[n("p",null,[n("a",qs,[ws,a(e)])])])]),n("blockquote",null,[n("ul",null,[Cs,n("li",null,[n("a",Ss,[xs,a(e)]),_s]),n("li",null,[n("a",Rs,[Is,a(e)]),Ds])])])])}const Ns=c(r,[["render",Es],["__file","66.html.vue"]]);export{Ns as default};
