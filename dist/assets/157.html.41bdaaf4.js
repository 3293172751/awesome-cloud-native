import{_ as n,o as s,c as a,d as t}from"./app.9f3e6cab.js";const e={},p=t(`<h1 id="openim-mongo-\u66FF\u6362-mysql" tabindex="-1"><a class="header-anchor" href="#openim-mongo-\u66FF\u6362-mysql" aria-hidden="true">#</a> OpenIM Mongo \u66FF\u6362 Mysql</h1><h2 id="\u76EE\u6807" tabindex="-1"><a class="header-anchor" href="#\u76EE\u6807" aria-hidden="true">#</a> \u76EE\u6807</h2><p>\u5B8C\u6210 <code>openim-rpc-friend</code> \u7684 Mysql -&gt; Mongo \u7684\u66FF\u6362\u3002</p><p><strong>\u6709\u4E9B\u63A5\u53E3\u5B9E\u73B0\u4E86\uFF0C\u6CA1\u6709\u8C03\u7528\u5C31\u53EF\u4EE5\u5220\u4E86</strong></p><h2 id="\u9605\u8BFB" tabindex="-1"><a class="header-anchor" href="#\u9605\u8BFB" aria-hidden="true">#</a> \u9605\u8BFB</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> conversationServer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	groupRpcClient                 <span class="token operator">*</span>rpcclient<span class="token punctuation">.</span>GroupRpcClient
	conversationDatabase           controller<span class="token punctuation">.</span>ConversationDatabase
	conversationNotificationSender <span class="token operator">*</span>notification<span class="token punctuation">.</span>ConversationNotificationSender
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><code>groupRpcClient</code>: \u8FD9\u4E2A\u5B57\u6BB5\u662F\u6307\u5411 <code>rpcclient.GroupRpcClient</code> \u7C7B\u578B\u7684\u6307\u9488\u3002\u5728Go\u4E2D\uFF0C\u6307\u9488\u662F\u7528\u4E8E\u5B58\u50A8\u53E6\u4E00\u4E2A\u53D8\u91CF\u7684\u5185\u5B58\u5730\u5740\u7684\u53D8\u91CF\u3002<code>rpcclient.GroupRpcClient</code> \u5F88\u53EF\u80FD\u662F\u4E00\u4E2A\u7528\u4E8ERPC\uFF08\u8FDC\u7A0B\u8FC7\u7A0B\u8C03\u7528\uFF09\u901A\u4FE1\u7684\u5BA2\u6237\u7AEF\u7C7B\u578B\u3002\u5B83\u53EF\u80FD\u88AB\u7528\u6765\u4E0E\u8FDC\u7A0B\u670D\u52A1\u6216\u670D\u52A1\u5668\u7EC4\u8FDB\u884C\u4EA4\u4E92\u3002</li><li><code>conversationDatabase</code>: \u8FD9\u4E2A\u5B57\u6BB5\u7684\u7C7B\u578B\u662F <code>controller.ConversationDatabase</code>\u3002\u8FD9\u8868\u660E <code>conversationDatabase</code> \u662F\u7528\u6765\u5904\u7406\u4E0E\u4F1A\u8BDD\u6570\u636E\u5E93\u76F8\u5173\u7684\u64CD\u4F5C\u7684\u3002\u8FD9\u53EF\u80FD\u5305\u62EC\u67E5\u8BE2\u3001\u66F4\u65B0\u3001\u5220\u9664\u4F1A\u8BDD\u6570\u636E\u7B49\u3002</li><li><code>conversationNotificationSender</code>: \u8FD9\u662F\u6307\u5411 <code>notification.ConversationNotificationSender</code> \u7C7B\u578B\u7684\u6307\u9488\u3002\u8FD9\u4E2A\u5B57\u6BB5\u5F88\u53EF\u80FD\u88AB\u7528\u6765\u53D1\u9001\u4E0E\u4F1A\u8BDD\u76F8\u5173\u7684\u901A\u77E5\u3002\u4F8B\u5982\uFF0C\u5728\u4F1A\u8BDD\u4E2D\u6DFB\u52A0\u65B0\u6D88\u606F\u65F6\uFF0C\u53EF\u80FD\u9700\u8981\u901A\u77E5\u76F8\u5173\u7528\u6237\u3002</li><li><code>notification</code>: \u8FD9\u4E2A\u5B57\u6BB5\u5E76\u4E0D\u76F4\u63A5\u51FA\u73B0\u5728\u7ED3\u6784\u4F53\u5B9A\u4E49\u4E2D\uFF0C\u4F46\u4ECE <code>conversationNotificationSender</code> \u5B57\u6BB5\u53EF\u4EE5\u63A8\u6D4B\uFF0C<code>notification</code> \u53EF\u80FD\u662F\u4E00\u4E2A\u5305\u542B\u4E86\u4E0E\u901A\u77E5\u53D1\u9001\u76F8\u5173\u529F\u80FD\u7684\u5305\uFF08package\uFF09\u3002</li></ol><p>start \u521D\u59CB\u5316\u548C\u542F\u52A8\u4E0E\u4F1A\u8BDD\uFF08\u5982\u804A\u5929\u5E94\u7528\u4E2D\u7684\u4F1A\u8BDD\uFF09\u76F8\u5173\u7684\u670D\u52A1\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>client discoveryregistry<span class="token punctuation">.</span>SvcDiscoveryRegistry<span class="token punctuation">,</span> server <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
    <span class="token comment">// db, err := relation.NewGormDB(): \u521D\u59CB\u5316\u4E00\u4E2AGORM\u6570\u636E\u5E93\u5B9E\u4F8B\u3002GORM\u662F\u4E00\u4E2A\u6D41\u884C\u7684Go ORM\u5E93\uFF0C\u7528\u4E8E\u4E0ESQL\u6570\u636E\u5E93\u4EA4\u4E92\u3002</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> relation<span class="token punctuation">.</span><span class="token function">NewGormDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
    
    <span class="token comment">// \u4F7F\u7528GORM\u7684\u81EA\u52A8\u8FC1\u79FB\u529F\u80FD\u6765\u521B\u5EFA\u6216\u66F4\u65B0\u4F1A\u8BDD\u6A21\u578B\u7684\u6570\u636E\u5E93\u8868</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tablerelation<span class="token punctuation">.</span>ConversationModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
    
    <span class="token comment">// \u521D\u59CB\u5316\u4E00\u4E2ARedis\u7F13\u5B58\u5B9E\u4F8B\u3002Redis\u901A\u5E38\u7528\u4E8E\u5FEB\u901F\u7F13\u5B58\u6570\u636E\u3002</span>
	rdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
    
    <span class="token comment">// \u521D\u59CB\u5316\u4E00\u4E2AMongoDB\u6570\u636E\u5E93\u5B9E\u4F8B\u3002</span>
	mongo<span class="token punctuation">,</span> err <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
    
    <span class="token comment">// \u4F7F\u7528MongoDB\u521B\u5EFA\u4E00\u4E2A\u4E13\u95E8\u5904\u7406\u4F1A\u8BDD\u6570\u636E\u7684\u6570\u636E\u5E93\u5B9E\u4F8B\u3002</span>
	conversationDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> newmgo<span class="token punctuation">.</span><span class="token function">NewConversationMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
    
    <span class="token comment">// \u521D\u59CB\u5316\u4E00\u4E2A\u7528\u4E8E\u7FA4\u7EC4\u64CD\u4F5C\u7684RPC\u5BA2\u6237\u7AEF\u3002</span>
	groupRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewGroupRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    
    <span class="token comment">// \u521D\u59CB\u5316\u4E00\u4E2A\u7528\u4E8E\u6D88\u606F\u64CD\u4F5C\u7684RPC\u5BA2\u6237\u7AEF\u3002</span>
	msgRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewMessageRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
    
    <span class="token comment">// \u5728gRPC\u670D\u52A1\u5668\u4E0A\u6CE8\u518C\u4E00\u4E2A\u65B0\u7684\u4F1A\u8BDD\u670D\u52A1\uFF0C\u4F20\u5165\u4E4B\u524D\u521D\u59CB\u5316\u7684\u5404\u79CD\u7EC4\u4EF6\u3002</span>
	pbconversation<span class="token punctuation">.</span><span class="token function">RegisterConversationServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token operator">&amp;</span>conversationServer<span class="token punctuation">{</span>
		conversationNotificationSender<span class="token punctuation">:</span> notification<span class="token punctuation">.</span><span class="token function">NewConversationNotificationSender</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msgRpcClient<span class="token punctuation">)</span><span class="token punctuation">,</span>
		groupRpcClient<span class="token punctuation">:</span>                 <span class="token operator">&amp;</span>groupRpcClient<span class="token punctuation">,</span>
		conversationDatabase<span class="token punctuation">:</span>           controller<span class="token punctuation">.</span><span class="token function">NewConversationDatabase</span><span class="token punctuation">(</span>conversationDB<span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">NewConversationRedis</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">GetDefaultOpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> conversationDB<span class="token punctuation">)</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">NewGorm</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u8BE6\u7EC6\u4ECB\u7ECD-gorm-\u7684-automigrate" tabindex="-1"><a class="header-anchor" href="#\u8BE6\u7EC6\u4ECB\u7ECD-gorm-\u7684-automigrate" aria-hidden="true">#</a> \u8BE6\u7EC6\u4ECB\u7ECD GORM \u7684 AutoMigrate</h3><p>GORM \u7684 <code>AutoMigrate</code> \u65B9\u6CD5\u662F\u4E00\u4E2A\u5728Go\u8BED\u8A00\u4E2D\u4F7F\u7528GORM\u5E93\u65F6\u975E\u5E38\u6709\u7528\u7684\u529F\u80FD\uFF0C\u4E3B\u8981\u7528\u4E8E\u6570\u636E\u5E93\u8FC1\u79FB\u3002\u4EE5\u4E0B\u662F\u5BF9\u8FD9\u4E2A\u65B9\u6CD5\u7684\u8BE6\u7EC6\u89E3\u6790\uFF1A</p><h4 id="\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u529F\u80FD" aria-hidden="true">#</a> \u529F\u80FD</h4><ul><li><strong>\u81EA\u52A8\u8FC1\u79FB</strong>\uFF1A<code>AutoMigrate</code> \u4F1A\u81EA\u52A8\u6839\u636E\u4F60\u7684Go\u7ED3\u6784\u4F53\uFF08\u901A\u5E38\u7528\u4E8E\u8868\u793A\u6570\u636E\u5E93\u4E2D\u7684\u8868\uFF09\u6765\u521B\u5EFA\u6216\u4FEE\u6539\u6570\u636E\u5E93\u8868\u3002\u8FD9\u610F\u5473\u7740\u5B83\u53EF\u4EE5\u6839\u636E\u7ED3\u6784\u4F53\u7684\u5B9A\u4E49\u6765\u521B\u5EFA\u65B0\u7684\u8868\uFF0C\u6216\u8005\u6839\u636E\u7ED3\u6784\u4F53\u7684\u4FEE\u6539\u6765\u8C03\u6574\u73B0\u6709\u7684\u8868\uFF08\u5982\u6DFB\u52A0\u3001\u5220\u9664\u6216\u4FEE\u6539\u5B57\u6BB5\uFF09\u3002</li></ul><h4 id="\u5DE5\u4F5C\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#\u5DE5\u4F5C\u539F\u7406" aria-hidden="true">#</a> \u5DE5\u4F5C\u539F\u7406</h4><ul><li><p><strong>\u4E0E\u7ED3\u6784\u4F53\u540C\u6B65</strong>\uFF1A<code>AutoMigrate</code> \u63A5\u6536\u4E00\u4E2A\u6216\u591A\u4E2A\u7ED3\u6784\u4F53\u4F5C\u4E3A\u53C2\u6570\uFF0C\u5E76\u6839\u636E\u8FD9\u4E9B\u7ED3\u6784\u4F53\u7684\u5B9A\u4E49\u5728\u6570\u636E\u5E93\u4E2D\u521B\u5EFA\u6216\u66F4\u65B0\u8868\u3002\u4F8B\u5982\uFF0C\u5982\u679C\u4F60\u6709\u4E00\u4E2A\u5982\u4E0B\u6240\u793A\u7684\u7ED3\u6784\u4F53\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    gorm<span class="token punctuation">.</span>Model
    Name <span class="token builtin">string</span>
    Age  <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AutoMigrate(&amp;User{})</code> \u4F1A\u5728\u6570\u636E\u5E93\u4E2D\u521B\u5EFA\u4E00\u4E2A\u540D\u4E3A <code>users</code> \u7684\u8868\uFF08GORM\u9ED8\u8BA4\u4F7F\u7528\u7ED3\u6784\u4F53\u540D\u79F0\u7684\u590D\u6570\u5F62\u5F0F\u4F5C\u4E3A\u8868\u540D\uFF09\uFF0C\u5176\u4E2D\u5305\u542B <code>name</code> \u548C <code>age</code> \u5B57\u6BB5\uFF0C\u4EE5\u53CAGORM\u6A21\u578B\u4E2D\u7684\u9ED8\u8BA4\u5B57\u6BB5\uFF08\u5982 <code>ID</code>, <code>CreatedAt</code>, <code>UpdatedAt</code>, <code>DeletedAt</code>\uFF09\u3002</p></li><li><p><strong>\u5B89\u5168\u6027</strong>\uFF1A<code>AutoMigrate</code> \u901A\u5E38\u53EA\u4F1A\u6DFB\u52A0\u7F3A\u5931\u7684\u5B57\u6BB5\u3001\u521B\u5EFA\u7F3A\u5931\u7684\u7D22\u5F15\u6216\u5916\u952E\uFF0C\u5E76\u4E0D\u4F1A\u5220\u9664\u6216\u4FEE\u6539\u73B0\u6709\u5B57\u6BB5\u3002\u8FD9\u610F\u5473\u7740\u5B83\u662F\u4E00\u4E2A\u76F8\u5BF9\u5B89\u5168\u7684\u64CD\u4F5C\uFF0C\u4E0D\u4F1A\u5BFC\u81F4\u6570\u636E\u4E22\u5931\u3002</p></li></ul><h4 id="\u4F7F\u7528\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528\u573A\u666F" aria-hidden="true">#</a> \u4F7F\u7528\u573A\u666F</h4><ul><li><strong>\u5E94\u7528\u7A0B\u5E8F\u542F\u52A8\u65F6</strong>\uFF1A\u901A\u5E38\u5728\u5E94\u7528\u7A0B\u5E8F\u542F\u52A8\u65F6\u8C03\u7528 <code>AutoMigrate</code>\uFF0C\u4EE5\u786E\u4FDD\u6570\u636E\u5E93\u7ED3\u6784\u4E0E\u5E94\u7528\u7A0B\u5E8F\u7684\u6700\u65B0\u7ED3\u6784\u4F53\u5B9A\u4E49\u4FDD\u6301\u540C\u6B65\u3002</li><li><strong>\u5F00\u53D1\u8FC7\u7A0B\u4E2D</strong>\uFF1A\u5728\u5F00\u53D1\u8FC7\u7A0B\u4E2D\uFF0C\u5F53\u4F60\u4FEE\u6539\u4E86\u7ED3\u6784\u4F53\u7684\u5B9A\u4E49\u540E\uFF0C\u53EF\u4EE5\u4F7F\u7528 <code>AutoMigrate</code> \u6765\u5FEB\u901F\u66F4\u65B0\u6570\u636E\u5E93\u7ED3\u6784\uFF0C\u800C\u4E0D\u9700\u8981\u624B\u52A8\u8FDB\u884C\u6570\u636E\u5E93\u8FC1\u79FB\u3002</li></ul><h4 id="\u6CE8\u610F\u4E8B\u9879" tabindex="-1"><a class="header-anchor" href="#\u6CE8\u610F\u4E8B\u9879" aria-hidden="true">#</a> \u6CE8\u610F\u4E8B\u9879</h4><ul><li><strong>\u4E0D\u662F\u6570\u636E\u5E93\u7248\u672C\u63A7\u5236\u5DE5\u5177</strong>\uFF1A\u867D\u7136 <code>AutoMigrate</code> \u5F88\u65B9\u4FBF\uFF0C\u4F46\u5B83\u4E0D\u5E94\u8BE5\u88AB\u89C6\u4E3A\u4E00\u4E2A\u5B8C\u6574\u7684\u6570\u636E\u5E93\u7248\u672C\u63A7\u5236\u89E3\u51B3\u65B9\u6848\u3002\u5BF9\u4E8E\u66F4\u590D\u6742\u7684\u6570\u636E\u5E93\u8FC1\u79FB\u548C\u7248\u672C\u63A7\u5236\uFF0C\u53EF\u80FD\u9700\u8981\u4F7F\u7528\u4E13\u95E8\u7684\u8FC1\u79FB\u5DE5\u5177\uFF0C\u5982 <code>golang-migrate/migrate</code>\u3002</li><li><strong>\u8C28\u614E\u4F7F\u7528</strong>\uFF1A\u5728\u751F\u4EA7\u73AF\u5883\u4E2D\u4F7F\u7528 <code>AutoMigrate</code> \u65F6\u5E94\u683C\u5916\u5C0F\u5FC3\uFF0C\u56E0\u4E3A\u9519\u8BEF\u7684\u4F7F\u7528\u53EF\u80FD\u4F1A\u5BFC\u81F4\u6570\u636E\u4E22\u5931\u6216\u8868\u7ED3\u6784\u7684\u610F\u5916\u53D8\u5316\u3002</li></ul><h3 id="\u521D\u59CB\u5316-mongo" tabindex="-1"><a class="header-anchor" href="#\u521D\u59CB\u5316-mongo" aria-hidden="true">#</a> \u521D\u59CB\u5316 mongo</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// NewMongo Initialize MongoDB connection.</span>
<span class="token keyword">func</span> <span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Mongo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	specialerror<span class="token punctuation">.</span><span class="token function">AddReplace</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span>ErrNoDocuments<span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrRecordNotFound<span class="token punctuation">)</span>
	uri <span class="token operator">:=</span> <span class="token string">&quot;mongodb://sample.host:27017/?maxPoolSize=20&amp;w=majority&quot;</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Uri <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		uri <span class="token operator">=</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Uri
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		mongodbHosts <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Address <span class="token punctuation">{</span>
			<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
				mongodbHosts <span class="token operator">+=</span> v
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				mongodbHosts <span class="token operator">+=</span> v <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Password <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Username <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			uri <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://%s:%s@%s/%s?maxPoolSize=%d&amp;authSource=admin&quot;</span><span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Password<span class="token punctuation">,</span> mongodbHosts<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Database<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>MaxPoolSize<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			uri <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://%s/%s/?maxPoolSize=%d&amp;authSource=admin&quot;</span><span class="token punctuation">,</span>
				mongodbHosts<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>Database<span class="token punctuation">,</span>
				config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Mongo<span class="token punctuation">.</span>MaxPoolSize<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;mongo:&quot;</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span>
	<span class="token keyword">var</span> mongoClient <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Client
	<span class="token keyword">var</span> err <span class="token builtin">error</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> maxRetry<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		mongoClient<span class="token punctuation">,</span> err <span class="token operator">=</span> mongo<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ApplyURI</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token operator">&amp;</span>Mongo<span class="token punctuation">{</span>db<span class="token punctuation">:</span> mongoClient<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> cmdErr<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span>CommandError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> cmdErr<span class="token punctuation">.</span>Code <span class="token operator">==</span> <span class="token number">13</span> <span class="token operator">||</span> cmdErr<span class="token punctuation">.</span>Code <span class="token operator">==</span> <span class="token number">18</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to connect to MongoDB: %s\\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>specialerror.AddReplace(mongo.ErrNoDocuments, errs.ErrRecordNotFound)</code>: \u8FD9\u884C\u4EE3\u7801\u5C06MongoDB\u7684 <code>ErrNoDocuments</code> \u9519\u8BEF\u66FF\u6362\u4E3A\u81EA\u5B9A\u4E49\u9519\u8BEF <code>ErrRecordNotFound</code>\u3002\u8FD9\u901A\u5E38\u7528\u4E8E\u7EDF\u4E00\u9519\u8BEF\u5904\u7406\u3002</p></li><li><p>\u5728 URL \u6784\u5EFA\u4E2D</p><ul><li>\u51FD\u6570\u9996\u5148\u5B9A\u4E49\u4E86\u4E00\u4E2A\u9ED8\u8BA4\u7684MongoDB URI\u3002</li><li>\u5982\u679C <code>config.Config.Mongo.Uri</code> \u975E\u7A7A\uFF0C\u5219\u4F7F\u7528\u8FD9\u4E2A\u4F5C\u4E3AURI\u3002</li><li>\u5982\u679C\u4E3A\u7A7A\uFF0C\u5219\u6839\u636E\u914D\u7F6E (<code>config.Config.Mongo.Address</code> \u7B49) \u6784\u5EFAURI\u3002\u5982\u679C\u63D0\u4F9B\u4E86\u7528\u6237\u540D\u548C\u5BC6\u7801\uFF0C\u5219\u5728URI\u4E2D\u5305\u542B\u8FD9\u4E9B\u51ED\u636E\uFF1B\u5426\u5219\uFF0C\u4E0D\u5305\u542B\u3002</li></ul></li><li><p>\u6570\u636E\u5E93\u5C1D\u8BD5\u94FE\u63A5</p><ul><li>\u4F7F\u7528 <code>for</code> \u5FAA\u73AF\u548C\u91CD\u8BD5\u903B\u8F91\uFF08\u7531 <code>maxRetry</code> \u63A7\u5236\uFF09\u6765\u5C1D\u8BD5\u8FDE\u63A5\u6570\u636E\u5E93\u3002</li><li><code>context.WithTimeout(context.Background(), time.Second*10)</code>: \u521B\u5EFA\u4E00\u4E2A\u6700\u591A10\u79D2\u7684\u8D85\u65F6\u4E0A\u4E0B\u6587\uFF0C\u786E\u4FDD\u8FDE\u63A5\u5C1D\u8BD5\u4E0D\u4F1A\u65E0\u9650\u671F\u7B49\u5F85\u3002</li><li><code>mongo.Connect(ctx, options.Client().ApplyURI(uri))</code>: \u5C1D\u8BD5\u4F7F\u7528\u4E0A\u9762\u6784\u5EFA\u7684URI\u8FDE\u63A5MongoDB\u3002</li><li>\u5982\u679C\u8FDE\u63A5\u6210\u529F\uFF0C\u8FD4\u56DE\u4E00\u4E2A\u5C01\u88C5\u4E86 <code>mongoClient</code> \u7684 <code>Mongo</code> \u5B9E\u4F8B\u3002</li></ul></li></ul><p><strong>\u89E3\u6790\u4E0B\u9762\u7684<code>PopulateGroupMember</code>\uFF1A</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func (g *GroupNotificationSender) PopulateGroupMember(ctx context.Context, members ...*relation.GroupMemberModel) error {
	if len(members) == 0 {
		return nil
	}
	emptyUserIDs := make(map[string]struct{})
	for _, member := range members {
		if member.Nickname == &quot;&quot; || member.FaceURL == &quot;&quot; {
			emptyUserIDs[member.UserID] = struct{}{}
		}
	}
	if len(emptyUserIDs) &gt; 0 {
		users, err := g.getUsersInfo(ctx, utils.Keys(emptyUserIDs))
		if err != nil {
			return err
		}
		userMap := make(map[string]CommonUser)
		for i, user := range users {
			userMap[user.GetUserID()] = users[i]
		}
		for i, member := range members {
			user, ok := userMap[member.UserID]
			if !ok {
				continue
			}
			if member.Nickname == &quot;&quot; {
				members[i].Nickname = user.GetNickname()
			}
			if member.FaceURL == &quot;&quot; {
				members[i].FaceURL = user.GetFaceURL()
			}
		}
	}
	return nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4F5C\u7528\u662F\u5728\u4E00\u4E2A\u7FA4\u7EC4\u901A\u77E5\u53D1\u9001\u5668(<code>GroupNotificationSender</code>)\u4E2D\u586B\u5145\u7FA4\u7EC4\u6210\u5458\u7684\u4FE1\u606F\u3002\u4EE3\u7801\u7684\u4E3B\u8981\u903B\u8F91\u5982\u4E0B\uFF1A</p><ol><li><strong>\u65B9\u6CD5\u5B9A\u4E49</strong>\uFF1A<code>PopulateGroupMember</code>\u662F<code>GroupNotificationSender</code>\u7C7B\u578B\u7684\u4E00\u4E2A\u65B9\u6CD5\uFF0C\u5B83\u63A5\u53D7\u4E00\u4E2A<code>context.Context</code>\u548C\u591A\u4E2A<code>*relation.GroupMemberModel</code>\u7C7B\u578B\u7684\u53C2\u6570\u3002</li><li><strong>\u68C0\u67E5\u6210\u5458\u5217\u8868\u662F\u5426\u4E3A\u7A7A</strong>\uFF1A\u9996\u5148\u68C0\u67E5\u4F20\u5165\u7684\u7FA4\u7EC4\u6210\u5458(<code>members</code>)\u662F\u5426\u4E3A\u7A7A\u3002\u5982\u679C\u6CA1\u6709\u6210\u5458\uFF0C\u5219\u76F4\u63A5\u8FD4\u56DE\uFF0C\u4E0D\u6267\u884C\u4EFB\u4F55\u64CD\u4F5C\u3002</li><li><strong>\u67E5\u627E\u7A7A\u4FE1\u606F\u7684\u7528\u6237</strong>\uFF1A\u4F7F\u7528\u4E00\u4E2A\u5FAA\u73AF\u904D\u5386\u6240\u6709\u6210\u5458\u3002\u5982\u679C\u6210\u5458\u7684\u6635\u79F0(<code>Nickname</code>)\u6216\u5934\u50CFURL(<code>FaceURL</code>)\u4E3A\u7A7A\uFF0C\u5219\u5C06\u5176\u7528\u6237ID(<code>UserID</code>)\u6DFB\u52A0\u5230\u4E00\u4E2A\u540D\u4E3A<code>emptyUserIDs</code>\u7684map\u4E2D\u3002\u8FD9\u4E2Amap\u7528\u4E8E\u5B58\u50A8\u9700\u8981\u66F4\u65B0\u4FE1\u606F\u7684\u7528\u6237ID\u3002</li><li><strong>\u83B7\u53D6\u7528\u6237\u4FE1\u606F</strong>\uFF1A\u5982\u679C<code>emptyUserIDs</code>\u4E2D\u6709\u6570\u636E\uFF0C\u5373\u5B58\u5728\u9700\u8981\u66F4\u65B0\u4FE1\u606F\u7684\u7528\u6237\uFF0C\u5C31\u8C03\u7528<code>g.getUsersInfo</code>\u65B9\u6CD5\uFF0C\u83B7\u53D6\u8FD9\u4E9B\u7528\u6237\u7684\u8BE6\u7EC6\u4FE1\u606F\u3002\u8FD9\u4E2A\u65B9\u6CD5\u9700\u8981\u4E0A\u4E0B\u6587(<code>ctx</code>)\u548C\u7528\u6237ID\u5217\u8868\u3002</li><li><strong>\u9519\u8BEF\u5904\u7406</strong>\uFF1A\u5982\u679C\u5728\u83B7\u53D6\u7528\u6237\u4FE1\u606F\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF\uFF0C\u8BE5\u65B9\u6CD5\u4F1A\u8FD4\u56DE\u76F8\u5E94\u7684\u9519\u8BEF\u3002</li><li><strong>\u66F4\u65B0\u6210\u5458\u4FE1\u606F</strong>\uFF1A\u4F7F\u7528\u83B7\u53D6\u5230\u7684\u7528\u6237\u4FE1\u606F\u66F4\u65B0\u7FA4\u7EC4\u6210\u5458\u7684\u4FE1\u606F\u3002\u9996\u5148\uFF0C\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684map(<code>userMap</code>)\uFF0C\u7528\u4E8E\u5C06\u7528\u6237ID\u6620\u5C04\u5230\u7528\u6237\u4FE1\u606F\u3002\u7136\u540E\uFF0C\u904D\u5386\u6BCF\u4E2A\u6210\u5458\uFF0C\u5982\u679C\u5728<code>userMap</code>\u4E2D\u627E\u5230\u5BF9\u5E94\u7684\u7528\u6237\u4FE1\u606F\uFF0C\u5E76\u4E14\u8BE5\u6210\u5458\u7684\u6635\u79F0\u6216\u5934\u50CFURL\u4E3A\u7A7A\uFF0C\u5219\u7528\u83B7\u53D6\u5230\u7684\u7528\u6237\u4FE1\u606F\u8FDB\u884C\u66F4\u65B0\u3002</li><li><strong>\u8FD4\u56DE</strong>\uFF1A\u6700\u540E\uFF0C\u5982\u679C\u6574\u4E2A\u8FC7\u7A0B\u987A\u5229\uFF0C\u8BE5\u65B9\u6CD5\u8FD4\u56DE<code>nil</code>\uFF0C\u8868\u793A\u6CA1\u6709\u9519\u8BEF\u53D1\u751F\u3002</li></ol><h2 id="\u4E3B\u8981\u7684\u53D8\u5316\u90E8\u5206" tabindex="-1"><a class="header-anchor" href="#\u4E3B\u8981\u7684\u53D8\u5316\u90E8\u5206" aria-hidden="true">#</a> \u4E3B\u8981\u7684\u53D8\u5316\u90E8\u5206</h2><p>\u6240\u6709\u7684 <code>interface{}</code> \u90FD\u53D8\u6210\u4E86 <code>any</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>conversationDB :<span class="token operator">=</span> relation.NewConversationGorm<span class="token punctuation">(</span>db<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u66FF\u6362\u4E3A\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>	mongo<span class="token punctuation">,</span> err <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	conversationDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> newmgo<span class="token punctuation">.</span><span class="token function">NewConversationMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>User \u4E2D\uFF1A</strong></p><p>\u4EE5\u524D\u7684\u903B\u8F91\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>userDB := relation.NewUserGorm(db)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u66F4\u65B0\u4E3A\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>userDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> newmgo<span class="token punctuation">.</span><span class="token function">NewUserMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u524D\u7684\u903B\u8F91\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>user <span class="token operator">:=</span> convert<span class="token punctuation">.</span><span class="token function">UserPb2DB</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>UserInfo<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u66F4\u65B0\u4E3A\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>data <span class="token operator">:=</span> convert<span class="token punctuation">.</span><span class="token function">UserPb2DBMap</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>UserInfo<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrArgs<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span><span class="token string">&quot;no data to update&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">UpdateByMap</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>UserID<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D <code>UserPb2DB</code> \u51FD\u6570\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">UserPb2DB</span><span class="token punctuation">(</span>user <span class="token operator">*</span>sdkws<span class="token punctuation">.</span>UserInfo<span class="token punctuation">)</span> <span class="token operator">*</span>relationtb<span class="token punctuation">.</span>UserModel <span class="token punctuation">{</span>
	<span class="token keyword">var</span> userDB relationtb<span class="token punctuation">.</span>UserModel
	userDB<span class="token punctuation">.</span>UserID <span class="token operator">=</span> user<span class="token punctuation">.</span>UserID
	userDB<span class="token punctuation">.</span>Nickname <span class="token operator">=</span> user<span class="token punctuation">.</span>Nickname
	userDB<span class="token punctuation">.</span>FaceURL <span class="token operator">=</span> user<span class="token punctuation">.</span>FaceURL
	userDB<span class="token punctuation">.</span>Ex <span class="token operator">=</span> user<span class="token punctuation">.</span>Ex
	userDB<span class="token punctuation">.</span>CreateTime <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">UnixMilli</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>CreateTime<span class="token punctuation">)</span>
	userDB<span class="token punctuation">.</span>AppMangerLevel <span class="token operator">=</span> user<span class="token punctuation">.</span>AppMangerLevel
	userDB<span class="token punctuation">.</span>GlobalRecvMsgOpt <span class="token operator">=</span> user<span class="token punctuation">.</span>GlobalRecvMsgOpt
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>userDB
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D <code>UserPb2DBMap</code> \u51FD\u6570\u7684\u903B\u8F91\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">UserPb2DBMap</span><span class="token punctuation">(</span>user <span class="token operator">*</span>sdkws<span class="token punctuation">.</span>UserInfo<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any <span class="token punctuation">{</span>
	<span class="token keyword">if</span> user <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	val <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">)</span>
	<span class="token keyword">if</span> user<span class="token punctuation">.</span>Nickname <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		val<span class="token punctuation">[</span><span class="token string">&quot;nickname&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>Nickname
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> user<span class="token punctuation">.</span>FaceURL <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		val<span class="token punctuation">[</span><span class="token string">&quot;face_url&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>FaceURL
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> user<span class="token punctuation">.</span>Ex <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		val<span class="token punctuation">[</span><span class="token string">&quot;ex&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>FaceURL
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> user<span class="token punctuation">.</span>AppMangerLevel <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		val<span class="token punctuation">[</span><span class="token string">&quot;app_manger_level&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>AppMangerLevel
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> user<span class="token punctuation">.</span>GlobalRecvMsgOpt <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		val<span class="token punctuation">[</span><span class="token string">&quot;global_recv_msg_opt&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">.</span>GlobalRecvMsgOpt
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> val
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u521D\uFF0C\u4F7F\u7528 <code>relation.NewUserGorm(db)</code> \u5EFA\u7ACB\u5230\u6570\u636E\u5E93\u7684\u57FA\u4E8EVMM\u7684\u8FDE\u63A5\u3002</p><p><code>convert.UserPb2DB</code> \u51FD\u6570\u5C06\u7528\u6237\u4FE1\u606F\u4ECE\u534F\u8BAE\u7F13\u51B2\u533A\uFF08protobuf\uFF09\u683C\u5F0F\u8F6C\u6362\u4E3A\u4E0EIBM\u517C\u5BB9\u7684\u6570\u636E\u5E93\u6A21\u578B\u3002</p><p>\u66F4\u65B0\u540E\u7684\u7528\u6237\u6570\u636E\u968F\u540E\u88AB\u4F20\u9012\u7ED9\u670D\u52A1\u7684 <code>Update</code> \u65B9\u6CD5\u3002</p><p>\u4EE3\u7801\u73B0\u5728\u4F7F\u7528 <code>newmgo.NewUserMongo(mongo.GetDatabase())</code> \u5EFA\u7ACB\u5230MongoDB\u7684\u8FDE\u63A5\u3002\u8FD9\u8868\u660E\u4ECE\u5173\u7CFB\u6570\u636E\u5E93\u65B9\u6CD5\uFF08RIMM\uFF09\u5230NoSQL\u65B9\u6CD5\uFF08MongoDB\uFF09\u7684\u8F6C\u53D8\u3002</p><p>\u66F4\u65B0\u6548\u7387\uFF1A\u4F7F\u7528 <code>UserPb2DBMap</code> \u7684\u65B0\u903B\u8F91\u5141\u8BB8\u90E8\u5206\u66F4\u65B0\uFF0C\u56E0\u4E3A\u53EA\u6709\u66F4\u6539\u7684\u5B57\u6BB5\u624D\u5305\u542B\u5728\u6620\u5C04\u4E2D\u3002\u8FD9\u6BD4\u5173\u7CFB\u6A21\u578B\u66F4\u6709\u6548\uFF0C\u56E0\u4E3A\u5173\u7CFB\u6A21\u578B\u53EF\u80FD\u9700\u8981\u66F4\u65B0\u6574\u884C\u3002</p><h2 id="\u4EE5\u524D-mysql-\u7684\u903B\u8F91" tabindex="-1"><a class="header-anchor" href="#\u4EE5\u524D-mysql-\u7684\u903B\u8F91" aria-hidden="true">#</a> \u4EE5\u524D Mysql \u7684\u903B\u8F91</h2><p>\u6211\u6B63\u5728\u9605\u8BFB\u548C\u5B66\u4E60\u6E90\u7801\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func Start(client registry.SvcDiscoveryRegistry, server *grpc.Server) error {
	rdb, err := cache.NewRedis()
	if err != nil {
		return err
	}
	mongo, err := unrelation.NewMongo()
	if err != nil {
		return err
	}
	users := make([]*tablerelation.UserModel, 0)
	if len(config.Config.Manager.UserID) != len(config.Config.Manager.Nickname) {
		return errors.New(&quot;len(config.Config.Manager.AppManagerUid) != len(config.Config.Manager.Nickname)&quot;)
	}
	for k, v := range config.Config.Manager.UserID {
		users = append(users, &amp;tablerelation.UserModel{UserID: v, Nickname: config.Config.Manager.Nickname[k], AppMangerLevel: constant.AppAdmin})
	}
	userDB, err := newmgo.NewUserMongo(mongo.GetDatabase())
	if err != nil {
		return err
	}
	tx, err := tx2.NewAuto(context.Background(), mongo.GetClient())
	if err != nil {
		return err
	}
	cache := cache.NewUserCacheRedis(rdb, userDB, cache.GetDefaultOpt())
	userMongoDB := unrelation.NewUserMongoDriver(mongo.GetDatabase())
	database := controller.NewUserDatabase(userDB, cache, tx, userMongoDB)
	friendRpcClient := rpcclient.NewFriendRpcClient(client)
	groupRpcClient := rpcclient.NewGroupRpcClient(client)
	msgRpcClient := rpcclient.NewMessageRpcClient(client)
	u := &amp;userServer{
		UserDatabase:             database,
		RegisterCenter:           client,
		friendRpcClient:          &amp;friendRpcClient,
		groupRpcClient:           &amp;groupRpcClient,
		friendNotificationSender: notification.NewFriendNotificationSender(&amp;msgRpcClient, notification.WithDBFunc(database.FindWithError)),
		userNotificationSender:   notification.NewUserNotificationSender(&amp;msgRpcClient, notification.WithUserFunc(database.FindWithError)),
	}
	pbuser.RegisterUserServer(server, u)
	return u.UserDatabase.InitOnce(context.Background(), users)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5E2E\u6211\u8BB2\u89E3\u8FD9\u6BB5\u6E90\u7801\u7684\u5B9E\u73B0\uFF0C\u6B65\u9AA4\uFF0C\u4EE5\u53CA\u8BBE\u8BA1\u5B9E\u73B0\uFF0C\u4EE5\u53CA\u53EF\u4EE5\u6539\u8FDB\u7684\u601D\u8DEF</p><p>\u5FAE\u670D\u52A1\u6216\u670D\u52A1\u7AEF\u5E94\u7528\u7A0B\u5E8F\u7684\u542F\u52A8\u51FD\u6570\u3002\u5B83\u521D\u59CB\u5316\u5404\u79CD\u670D\u52A1\u548C\u6570\u636E\u5E93\u8FDE\u63A5\uFF0C\u7136\u540E\u5C06\u670D\u52A1\u6CE8\u518C\u5230\u4E00\u4E2AgRPC\u670D\u52A1\u5668\u3002</p><h3 id="\u4EE3\u7801\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#\u4EE3\u7801\u5206\u6790" aria-hidden="true">#</a> \u4EE3\u7801\u5206\u6790</h3><ol><li><strong>\u521D\u59CB\u5316Redis\u7F13\u5B58</strong>: <code>cache.NewRedis()</code> \u521B\u5EFA\u4E00\u4E2A\u65B0\u7684Redis\u7F13\u5B58\u5B9E\u4F8B\u3002</li><li><strong>\u521D\u59CB\u5316MongoDB\u8FDE\u63A5</strong>: <code>unrelation.NewMongo()</code> \u7528\u4E8E\u521B\u5EFA\u548C\u914D\u7F6EMongoDB\u8FDE\u63A5\u3002</li><li><strong>\u68C0\u67E5\u7528\u6237ID\u548C\u6635\u79F0\u914D\u7F6E</strong>: \u4EE3\u7801\u786E\u4FDD\u914D\u7F6E\u4E2D\u7684\u7528\u6237ID\u6570\u91CF\u4E0E\u6635\u79F0\u6570\u91CF\u76F8\u7B49\uFF0C\u5982\u679C\u4E0D\u76F8\u7B49\uFF0C\u5219\u8FD4\u56DE\u9519\u8BEF\u3002</li><li><strong>\u6784\u9020\u7528\u6237\u6A21\u578B</strong>: \u904D\u5386\u914D\u7F6E\u4E2D\u7684\u7528\u6237ID\u548C\u6635\u79F0\uFF0C\u521B\u5EFA\u7528\u6237\u6A21\u578B\u6570\u7EC4\u3002</li><li><strong>\u521B\u5EFA\u7528\u6237\u6570\u636E\u5E93\u5B9E\u4F8B</strong>: <code>newmgo.NewUserMongo(mongo.GetDatabase())</code> \u7528\u4E8E\u521D\u59CB\u5316\u7528\u6237\u6570\u636E\u5E93\u64CD\u4F5C\u7684MongoDB\u5B9E\u73B0\u3002</li><li><strong>\u521B\u5EFA\u4E8B\u52A1\u5904\u7406\u5668</strong>: <code>tx2.NewAuto(context.Background(), mongo.GetClient())</code> \u7528\u4E8EMongoDB\u7684\u4E8B\u52A1\u5904\u7406\u3002</li><li><strong>\u521B\u5EFA\u7F13\u5B58\u5B9E\u4F8B</strong>: \u7ED3\u5408Redis\u7F13\u5B58\u548C\u7528\u6237\u6570\u636E\u5E93\uFF0C\u521B\u5EFA\u7528\u6237\u7F13\u5B58\u3002</li><li><strong>\u521B\u5EFA\u7528\u6237MongoDB\u9A71\u52A8</strong>: <code>unrelation.NewUserMongoDriver(mongo.GetDatabase())</code> \u7528\u4E8E\u64CD\u4F5C\u7528\u6237\u6570\u636E\u3002</li><li><strong>\u521D\u59CB\u5316\u63A7\u5236\u5668</strong>: <code>controller.NewUserDatabase(userDB, cache, tx, userMongoDB)</code> \u521B\u5EFA\u4E00\u4E2A\u63A7\u5236\u5668\uFF0C\u96C6\u6210\u4E86\u7528\u6237\u6570\u636E\u5E93\u3001\u7F13\u5B58\u3001\u4E8B\u52A1\u5904\u7406\u5668\u548CMongoDB\u9A71\u52A8\u3002</li><li><strong>\u521D\u59CB\u5316RPC\u5BA2\u6237\u7AEF</strong>: \u521B\u5EFA\u7528\u4E8E\u4E0E\u597D\u53CB\u3001\u7FA4\u7EC4\u548C\u6D88\u606F\u670D\u52A1\u901A\u4FE1\u7684RPC\u5BA2\u6237\u7AEF\u3002</li><li><strong>\u8BBE\u7F6E\u7528\u6237\u670D\u52A1\u5668</strong>: \u521B\u5EFA\u4E00\u4E2A\u7528\u6237\u670D\u52A1\u5668\u5B9E\u4F8B\uFF0C\u5E76\u6CE8\u518C\u5230gRPC\u670D\u52A1\u5668\u3002</li><li><strong>\u521D\u59CB\u5316\u7528\u6237\u6570\u636E\u5E93</strong>: \u4F7F\u7528\u521D\u59CB\u7528\u6237\u6A21\u578B\u6570\u636E\u521D\u59CB\u5316\u6570\u636E\u5E93\u3002</li></ol><h3 id="\u8BBE\u8BA1\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#\u8BBE\u8BA1\u5B9E\u73B0" aria-hidden="true">#</a> \u8BBE\u8BA1\u5B9E\u73B0</h3><ul><li><strong>\u6A21\u5757\u5316\u8BBE\u8BA1</strong>: \u6BCF\u4E2A\u529F\u80FD\uFF08\u5982\u6570\u636E\u5E93\u8BBF\u95EE\u3001\u7F13\u5B58\u3001RPC\u901A\u4FE1\uFF09\u90FD\u88AB\u5206\u89E3\u4E3A\u72EC\u7ACB\u7684\u6A21\u5757\uFF0C\u6709\u52A9\u4E8E\u4EE3\u7801\u7684\u7EF4\u62A4\u548C\u6269\u5C55\u3002</li><li><strong>\u9519\u8BEF\u5904\u7406</strong>: \u5728\u6BCF\u4E2A\u91CD\u8981\u6B65\u9AA4\u4E4B\u540E\u90FD\u6709\u9519\u8BEF\u68C0\u67E5\uFF0C\u786E\u4FDD\u5728\u51FA\u73B0\u95EE\u9898\u65F6\u80FD\u591F\u53CA\u65F6\u8FD4\u56DE\u9519\u8BEF\u3002</li><li><strong>\u914D\u7F6E\u9A8C\u8BC1</strong>: \u68C0\u67E5\u914D\u7F6E\u7684\u6709\u6548\u6027\uFF0C\u4F8B\u5982\u7528\u6237ID\u548C\u6635\u79F0\u7684\u6570\u91CF\u5339\u914D\u3002</li></ul><h3 id="\u6539\u8FDB\u601D\u8DEF" tabindex="-1"><a class="header-anchor" href="#\u6539\u8FDB\u601D\u8DEF" aria-hidden="true">#</a> \u6539\u8FDB\u601D\u8DEF</h3><ol><li><strong>\u914D\u7F6E\u548C\u9519\u8BEF\u5904\u7406</strong>: \u53EF\u4EE5\u4F7F\u7528\u66F4\u5148\u8FDB\u7684\u914D\u7F6E\u7BA1\u7406\u548C\u9519\u8BEF\u5904\u7406\u5E93\u6765\u7B80\u5316\u4EE3\u7801\u548C\u589E\u5F3A\u53EF\u8BFB\u6027\u3002</li><li><strong>\u4F9D\u8D56\u6CE8\u5165</strong>: \u4F7F\u7528\u4F9D\u8D56\u6CE8\u5165\u6846\u67B6\u53EF\u4EE5\u66F4\u597D\u5730\u7BA1\u7406\u5BF9\u8C61\u7684\u521B\u5EFA\u548C\u4F9D\u8D56\u5173\u7CFB\uFF0C\u51CF\u5C11\u4EE3\u7801\u8026\u5408\u3002</li><li><strong>\u65E5\u5FD7\u8BB0\u5F55</strong>: \u5728\u5173\u952E\u6B65\u9AA4\u4E2D\u6DFB\u52A0\u66F4\u8BE6\u7EC6\u7684\u65E5\u5FD7\u8BB0\u5F55\uFF0C\u6709\u52A9\u4E8E\u8C03\u8BD5\u548C\u8DDF\u8E2A\u95EE\u9898\u3002</li><li><strong>\u4EE3\u7801\u91CD\u6784</strong>: \u67D0\u4E9B\u4EE3\u7801\u5757\uFF08\u4F8B\u5982RPC\u5BA2\u6237\u7AEF\u521D\u59CB\u5316\uFF09\u53EF\u4EE5\u8FDB\u4E00\u6B65\u62BD\u8C61\u548C\u5C01\u88C5\uFF0C\u4EE5\u51CF\u5C11\u91CD\u590D\u4EE3\u7801\u3002</li><li><strong>\u5F02\u6B65\u5904\u7406</strong>: \u8003\u8651\u5728\u9002\u5F53\u7684\u5730\u65B9\u5F15\u5165\u5F02\u6B65\u5904\u7406\uFF0C\u4EE5\u63D0\u9AD8\u6027\u80FD\u548C\u54CD\u5E94\u901F\u5EA6\u3002</li><li><strong>\u5355\u5143\u6D4B\u8BD5</strong>: \u52A0\u5F3A\u5355\u5143\u6D4B\u8BD5\uFF0C\u786E\u4FDD\u4EE3\u7801\u7684\u53EF\u9760\u6027\u548C\u672A\u6765\u7684\u53EF\u7EF4\u62A4\u6027\u3002</li><li><strong>\u914D\u7F6E\u5916\u90E8\u5316</strong>: \u5C06\u914D\u7F6E\u6587\u4EF6\u5916\u90E8\u5316\uFF0C\u800C\u4E0D\u662F\u786C\u7F16\u7801\u5728\u4EE3\u7801\u4E2D\uFF0C\u4EE5\u589E\u5F3A\u7075\u6D3B\u6027\u548C\u53EF\u914D\u7F6E\u6027\u3002</li></ol><h3 id="\u521B\u5EFA\u6570\u636E\u5E93\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#\u521B\u5EFA\u6570\u636E\u5E93\u4E8B\u52A1" aria-hidden="true">#</a> \u521B\u5EFA\u6570\u636E\u5E93\u4E8B\u52A1</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewAuto</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cli <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> <span class="token punctuation">(</span>tx<span class="token punctuation">.</span>CtxTx<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> res <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any
	<span class="token keyword">if</span> err <span class="token operator">:=</span> cli<span class="token punctuation">.</span><span class="token function">Database</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RunCommand</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bson<span class="token punctuation">.</span>M<span class="token punctuation">{</span><span class="token string">&quot;isMaster&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> res<span class="token punctuation">[</span><span class="token string">&quot;setName&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">NewMongoTx</span><span class="token punctuation">(</span>cli<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">NewInvalidTx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5177\u4F53\u9488\u5BF9MongoDB\u3002\u8BA9\u6211\u4EEC\u9010\u6B65\u5206\u6790\u8FD9\u4E2A\u51FD\u6570\uFF1A</p><h3 id="\u51FD\u6570-newauto-\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#\u51FD\u6570-newauto-\u5206\u6790" aria-hidden="true">#</a> \u51FD\u6570 <code>NewAuto</code> \u5206\u6790</h3><ol><li><strong>\u51FD\u6570\u7B7E\u540D</strong>: <ul><li><code>NewAuto(ctx context.Context, cli *mongo.Client) (tx.CtxTx, error)</code>: \u8FD9\u4E2A\u51FD\u6570\u63A5\u6536\u4E00\u4E2A\u4E0A\u4E0B\u6587\uFF08<code>context.Context</code>\uFF09\u548C\u4E00\u4E2AMongoDB\u5BA2\u6237\u7AEF\uFF08<code>*mongo.Client</code>\uFF09\uFF0C\u8FD4\u56DE\u4E00\u4E2A\u4E8B\u52A1\u5904\u7406\u5668\u63A5\u53E3\uFF08<code>tx.CtxTx</code>\uFF09\u548C\u4E00\u4E2A\u9519\u8BEF\uFF08<code>error</code>\uFF09\u3002</li></ul></li><li><strong>\u8FD0\u884CMongoDB\u547D\u4EE4</strong>: <ul><li><code>cli.Database(&quot;admin&quot;).RunCommand(ctx, bson.M{&quot;isMaster&quot;: 1}).Decode(&amp;res)</code>: \u8FD9\u884C\u4EE3\u7801\u5411MongoDB\u7684admin\u6570\u636E\u5E93\u53D1\u9001\u4E00\u4E2A\u547D\u4EE4\uFF08<code>isMaster: 1</code>\uFF09\uFF0C\u6765\u68C0\u67E5\u5F53\u524D\u8FDE\u63A5\u7684MongoDB\u8282\u70B9\u662F\u5426\u662F\u4E3B\u8282\u70B9\uFF08master\uFF09\u3002\u8FD9\u4E2A\u547D\u4EE4\u7684\u54CD\u5E94\u88AB\u89E3\u7801\u5230\u53D8\u91CF <code>res</code> \u4E2D\u3002</li></ul></li><li><strong>\u68C0\u67E5\u54CD\u5E94</strong>: <ul><li><code>if _, ok := res[&quot;setName&quot;]; ok { ... }</code>: \u68C0\u67E5\u54CD\u5E94\u4E2D\u662F\u5426\u5305\u542B\u952E <code>setName</code>\u3002<code>setName</code> \u5B58\u5728\u8868\u660E\u5F53\u524DMongoDB\u5B9E\u4F8B\u662F\u4E00\u4E2A\u590D\u5236\u96C6\u7684\u4E00\u90E8\u5206\u3002</li></ul></li><li><strong>\u8FD4\u56DE\u9002\u5F53\u7684\u4E8B\u52A1\u5904\u7406\u5668</strong>: <ul><li>\u5982\u679C\u662F\u590D\u5236\u96C6\uFF0C\u4F7F\u7528 <code>NewMongoTx(cli)</code> \u8FD4\u56DE\u4E00\u4E2A\u9002\u5408MongoDB\u590D\u5236\u96C6\u7684\u4E8B\u52A1\u5904\u7406\u5668\u3002</li><li>\u5982\u679C\u4E0D\u662F\u590D\u5236\u96C6\uFF0C\u4F7F\u7528 <code>NewInvalidTx()</code> \u8FD4\u56DE\u4E00\u4E2A\u65E0\u6548\u7684\u4E8B\u52A1\u5904\u7406\u5668\u3002</li></ul></li></ol><h3 id="\u8BBE\u8BA1\u610F\u56FE" tabindex="-1"><a class="header-anchor" href="#\u8BBE\u8BA1\u610F\u56FE" aria-hidden="true">#</a> \u8BBE\u8BA1\u610F\u56FE</h3><ul><li><strong>\u52A8\u6001\u68C0\u6D4B</strong>: \u901A\u8FC7\u68C0\u67E5MongoDB\u7684\u914D\u7F6E\uFF08\u662F\u5426\u662F\u590D\u5236\u96C6\uFF09\uFF0C\u52A8\u6001\u5730\u786E\u5B9A\u4F7F\u7528\u54EA\u79CD\u7C7B\u578B\u7684\u4E8B\u52A1\u5904\u7406\u5668\u3002</li><li><strong>\u7075\u6D3B\u6027\u548C\u517C\u5BB9\u6027</strong>: \u4EE3\u7801\u53EF\u4EE5\u5904\u7406\u4E0D\u540C\u7684MongoDB\u90E8\u7F72\u914D\u7F6E\uFF08\u5355\u8282\u70B9\u6216\u590D\u5236\u96C6\uFF09\uFF0C\u63D0\u9AD8\u4E86\u901A\u7528\u6027\u3002</li></ul><h3 id="\u53EF\u80FD\u7684\u6539\u8FDB" tabindex="-1"><a class="header-anchor" href="#\u53EF\u80FD\u7684\u6539\u8FDB" aria-hidden="true">#</a> \u53EF\u80FD\u7684\u6539\u8FDB</h3><ol><li><strong>\u66F4\u8BE6\u7EC6\u7684\u9519\u8BEF\u5904\u7406</strong>: \u5F53 <code>RunCommand</code> \u5931\u8D25\u65F6\uFF0C\u9664\u4E86\u8FD4\u56DE\u9519\u8BEF\u5916\uFF0C\u4E5F\u53EF\u4EE5\u8BB0\u5F55\u66F4\u591A\u5173\u4E8E\u9519\u8BEF\u7684\u4E0A\u4E0B\u6587\u4FE1\u606F\uFF0C\u4EE5\u4FBF\u66F4\u597D\u5730\u7406\u89E3\u9519\u8BEF\u53D1\u751F\u7684\u539F\u56E0\u3002</li><li><strong>\u914D\u7F6E\u68C0\u67E5\u4F18\u5316</strong>: \u5982\u679C\u8FD9\u4E2A\u51FD\u6570\u7ECF\u5E38\u88AB\u8C03\u7528\uFF0C\u9891\u7E41\u5730\u8FD0\u884C <code>isMaster</code> \u547D\u4EE4\u53EF\u80FD\u4F1A\u5F71\u54CD\u6027\u80FD\u3002\u53EF\u4EE5\u8003\u8651\u7F13\u5B58\u8FD9\u4E2A\u4FE1\u606F\u6216\u8005\u5728\u521D\u59CB\u5316\u65F6\u786E\u5B9A\u8FD9\u4E2A\u8BBE\u7F6E\u3002</li><li><strong>\u589E\u52A0\u65E5\u5FD7\u8BB0\u5F55</strong>: \u5728\u5173\u952E\u6B65\u9AA4\uFF08\u5982\u547D\u4EE4\u6267\u884C\u3001\u5224\u65AD\u903B\u8F91\uFF09\u6DFB\u52A0\u65E5\u5FD7\u8BB0\u5F55\uFF0C\u6709\u52A9\u4E8E\u8C03\u8BD5\u548C\u8DDF\u8E2A\u95EE\u9898\u3002</li><li><strong>\u5F02\u5E38\u60C5\u51B5\u5904\u7406</strong>: \u5728\u65E0\u6CD5\u786E\u5B9A\u4E8B\u52A1\u5904\u7406\u5668\u7C7B\u578B\u65F6\uFF0C\u9664\u4E86\u8FD4\u56DE\u4E00\u4E2A\u65E0\u6548\u7684\u4E8B\u52A1\u5904\u7406\u5668\u5916\uFF0C\u8FD8\u53EF\u4EE5\u8003\u8651\u63D0\u4F9B\u4E00\u79CD\u9ED8\u8BA4\u7684\u5904\u7406\u7B56\u7565\u6216\u8005\u66F4\u660E\u786E\u7684\u9519\u8BEF\u63D0\u793A\u3002</li></ol><h2 id="\u542F\u52A8-rpc" tabindex="-1"><a class="header-anchor" href="#\u542F\u52A8-rpc" aria-hidden="true">#</a> \u542F\u52A8 RPC</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>fnc <span class="token punctuation">(</span>a <span class="token operator">*</span>RpcCmd<span class="token punctuation">)</span> <span class="token function">StartSvr</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> rpcFn <span class="token keyword">func</span><span class="token punctuation">(</span>discov discoveryregistry<span class="token punctuation">.</span>SvcDiscoveryRegistry<span class="token punctuation">,</span> server <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> a<span class="token punctuation">.</span><span class="token function">GetPortFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;port is required&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> startrpc<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">GetPortFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">GetPrometheusPortFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rpcFn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u51FD\u6570-startsvr-\u5206\u6790" tabindex="-1"><a class="header-anchor" href="#\u51FD\u6570-startsvr-\u5206\u6790" aria-hidden="true">#</a> \u51FD\u6570 <code>StartSvr</code> \u5206\u6790</h3><ol><li><strong>\u51FD\u6570\u7B7E\u540D</strong>: <ul><li><code>func (a *RpcCmd) StartSvr(name string, rpcFn func(discoveryregistry.SvcDiscoveryRegistry, *grpc.Server) error) error</code>: \u8FD9\u4E2A\u51FD\u6570\u662F <code>RpcCmd</code> \u7ED3\u6784\u4F53\u7684\u4E00\u4E2A\u65B9\u6CD5\u3002\u5B83\u63A5\u6536\u4E00\u4E2A\u670D\u52A1\u540D\u79F0 <code>name</code> \u548C\u4E00\u4E2A\u51FD\u6570 <code>rpcFn</code>\uFF0C\u8FD9\u4E2A\u51FD\u6570\u81EA\u8EAB\u63A5\u6536\u4E00\u4E2A\u670D\u52A1\u53D1\u73B0\u6CE8\u518C\u8868\u548C\u4E00\u4E2AgRPC\u670D\u52A1\u5668\uFF0C\u5E76\u8FD4\u56DE\u4E00\u4E2A\u9519\u8BEF\u3002<code>StartSvr</code> \u51FD\u6570\u4E5F\u8FD4\u56DE\u4E00\u4E2A\u9519\u8BEF\u3002</li></ul></li><li><strong>\u68C0\u67E5\u7AEF\u53E3</strong>: <ul><li><code>if a.GetPortFlag() == 0 { return errors.New(&quot;port is required&quot;) }</code>: \u8FD9\u884C\u4EE3\u7801\u68C0\u67E5\u662F\u5426\u5DF2\u7ECF\u6307\u5B9A\u4E86\u7AEF\u53E3\u53F7\uFF08\u901A\u8FC7 <code>GetPortFlag()</code> \u65B9\u6CD5\uFF09\u3002\u5982\u679C\u6CA1\u6709\u6307\u5B9A\u7AEF\u53E3\u53F7\uFF08\u5373\u7AEF\u53E3\u4E3A0\uFF09\uFF0C\u5219\u8FD4\u56DE\u4E00\u4E2A\u9519\u8BEF\uFF0C\u8868\u660E\u7AEF\u53E3\u662F\u5FC5\u9700\u7684\u3002</li></ul></li><li><strong>\u542F\u52A8RPC\u670D\u52A1</strong>: <ul><li><code>return startrpc.Start(a.GetPortFlag(), name, a.GetPrometheusPortFlag(), rpcFn)</code>: \u5982\u679C\u7AEF\u53E3\u53F7\u5B58\u5728\uFF0C\u8BE5\u884C\u4EE3\u7801\u4F7F\u7528\u63D0\u4F9B\u7684\u7AEF\u53E3\u53F7\u3001\u670D\u52A1\u540D\u79F0\u3001Prometheus\u7AEF\u53E3\uFF08\u7528\u4E8E\u76D1\u63A7\uFF09\u548CRPC\u51FD\u6570\u6765\u542F\u52A8RPC\u670D\u52A1\u3002</li></ul></li></ol><h3 id="\u8BBE\u8BA1\u610F\u56FE-1" tabindex="-1"><a class="header-anchor" href="#\u8BBE\u8BA1\u610F\u56FE-1" aria-hidden="true">#</a> \u8BBE\u8BA1\u610F\u56FE</h3><ul><li><strong>\u53C2\u6570\u9A8C\u8BC1</strong>: \u901A\u8FC7\u68C0\u67E5\u7AEF\u53E3\u53F7\uFF0C\u786E\u4FDD\u5728\u542F\u52A8\u670D\u52A1\u524D\u6240\u6709\u5FC5\u9700\u7684\u914D\u7F6E\u90FD\u5DF2\u8BBE\u7F6E\u3002</li><li><strong>\u6A21\u5757\u5316</strong>: \u5C06RPC\u670D\u52A1\u7684\u542F\u52A8\u903B\u8F91\u5C01\u88C5\u5728\u4E00\u4E2A\u5355\u72EC\u7684\u51FD\u6570\u4E2D\uFF0C\u6709\u52A9\u4E8E\u4EE3\u7801\u7684\u91CD\u7528\u548C\u7EF4\u62A4\u3002</li><li><strong>\u7075\u6D3B\u6027</strong>: \u901A\u8FC7\u5C06RPC\u542F\u52A8\u903B\u8F91\u4F5C\u4E3A\u4E00\u4E2A\u51FD\u6570\u53C2\u6570\u4F20\u9012\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u53EF\u4EE5\u542F\u52A8\u4E0D\u540C\u7C7B\u578B\u7684RPC\u670D\u52A1\u3002</li></ul><h2 id="mongo-\u4E2D\u7684\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#mongo-\u4E2D\u7684\u4E8B\u52A1" aria-hidden="true">#</a> Mongo \u4E2D\u7684\u4E8B\u52A1</h2><p>\u5728\u4E00\u6B21\u4E1A\u52A1\u5B9E\u8DF5\u4E2D\u9700\u8981\u5728 MongoDB \u4E2D\u4F7F\u7528\u81EA\u589E ID\uFF0C\u800C MongoDB \u672C\u8EAB\u5E76\u4E0D\u652F\u6301\u81EA\u589E ID\u3002\u6211\u4EEC\u9700\u8981\u901A\u8FC7\u4E00\u4E2A\u5355\u72EC\u7684\u96C6\u5408\u4FDD\u5B58 ID\uFF0C\u4F7F\u7528 <code>FindOneAndUpdate</code> \u548C <code>$inc</code> \u64CD\u4F5C\u7B26\u5B9E\u73B0 ID \u7684\u81EA\u589E.</p><p>\u7136\u800C\u6B64\u65F6\u9700\u8981\u64CD\u4F5C\u4E24\u4E2A\u96C6\u5408\uFF0C\u56E0 MongoDB \u7684\u539F\u5B50\u6027\u53EA\u662F\u9488\u5BF9\u5355\u6587\u6863\u7684\uFF0C\u6545\u4F1A\u51FA\u73B0 ID \u589E\u52A0\u800C\u63D2\u5165\u5931\u8D25\u7684\u60C5\u51B5\u3002</p><p>\u597D\u5728 MongoDB \u5728 4.0 \u4E2D\uFF0C\u652F\u6301\u4E86\u526F\u672C\u96C6\u4E0A\u7684\u591A\u6587\u6863\u4E8B\u52A1\uFF0C\u5728\u7248\u672C 4.2 \u4E2D\uFF0C\u5F15\u5165\u4E86\u5206\u5E03\u5F0F\u4E8B\u52A1\uFF0C\u8FD9\u589E\u52A0\u4E86\u5BF9\u5206\u7247\u7FA4\u96C6\u4E0A\u7684\u591A\u6587\u6863\u4E8B\u52A1\u7684\u652F\u6301\uFF0C\u5E76\u5408\u5E76\u4E86\u5BF9\u526F\u672C\u96C6\u4E0A\u591A\u6587\u6863\u4E8B\u52A1\u7684\u73B0\u6709\u652F\u6301\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//\u5F00\u542F\u4E00\u4E2A\u4F1A\u8BDD</span>
sess <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">getMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//\u5F00\u542F\u4E8B\u52A1</span>
sess<span class="token punctuation">.</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//\u56DE\u6EDA</span>
sess<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//\u63D0\u4EA4</span>
sess<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//\u7ED3\u675F\u4F1A\u8BDD</span>
sess<span class="token punctuation">.</span><span class="token function">endSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u91CD\u6784\u540E\u7684-mongo-\u7684\u903B\u8F91" tabindex="-1"><a class="header-anchor" href="#\u91CD\u6784\u540E\u7684-mongo-\u7684\u903B\u8F91" aria-hidden="true">#</a> \u91CD\u6784\u540E\u7684 Mongo \u7684\u903B\u8F91</h2><p>\u53C2\u8003 user \u6A21\u5757 mysql \u91CD\u6784\u4E3A mongo \u4EE3\u7801:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func Start(client registry.SvcDiscoveryRegistry, server *grpc.Server) error {
	db, err := relation.NewGormDB()
	if err != nil {
		return err
	}
	rdb, err := cache.NewRedis()
	if err != nil {
		return err
	}
	mongo, err := unrelation.NewMongo()
	if err != nil {
		return err
	}
	if err := db.AutoMigrate(&amp;tablerelation.UserModel{}); err != nil {
		return err
	}
	users := make([]*tablerelation.UserModel, 0)
	if len(config.Config.Manager.UserID) != len(config.Config.Manager.Nickname) {
		return errors.New(&quot;len(config.Config.Manager.AppManagerUid) != len(config.Config.Manager.Nickname)&quot;)
	}
	for k, v := range config.Config.Manager.UserID {
		users = append(users, &amp;tablerelation.UserModel{UserID: v, Nickname: config.Config.Manager.Nickname[k], AppMangerLevel: constant.AppAdmin})
	}
	userDB := relation.NewUserGorm(db)
	cache := cache.NewUserCacheRedis(rdb, userDB, cache.GetDefaultOpt())
	userMongoDB := unrelation.NewUserMongoDriver(mongo.GetDatabase())
	database := controller.NewUserDatabase(userDB, cache, tx.NewGorm(db), userMongoDB)
	friendRpcClient := rpcclient.NewFriendRpcClient(client)
	groupRpcClient := rpcclient.NewGroupRpcClient(client)
	msgRpcClient := rpcclient.NewMessageRpcClient(client)
	u := &amp;userServer{
		UserDatabase:             database,
		RegisterCenter:           client,
		friendRpcClient:          &amp;friendRpcClient,
		groupRpcClient:           &amp;groupRpcClient,
		friendNotificationSender: notification.NewFriendNotificationSender(&amp;msgRpcClient, notification.WithDBFunc(database.FindWithError)),
		userNotificationSender:   notification.NewUserNotificationSender(&amp;msgRpcClient, notification.WithUserFunc(database.FindWithError)),
	}
	pbuser.RegisterUserServer(server, u)
	return u.UserDatabase.InitOnce(context.Background(), users)
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0B\u9762\u662F user\u91CD\u6784\u540E\u7684\u4EE3\u7801\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>client registry<span class="token punctuation">.</span>SvcDiscoveryRegistry<span class="token punctuation">,</span> server <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> relation<span class="token punctuation">.</span><span class="token function">NewGormDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	rdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	mongo<span class="token punctuation">,</span> err <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">AutoMigrate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tablerelation<span class="token punctuation">.</span>UserModel<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tablerelation<span class="token punctuation">.</span>UserModel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>UserID<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>Nickname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;len(config.Config.Manager.AppManagerUid) != len(config.Config.Manager.Nickname)&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>UserID <span class="token punctuation">{</span>
		users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tablerelation<span class="token punctuation">.</span>UserModel<span class="token punctuation">{</span>UserID<span class="token punctuation">:</span> v<span class="token punctuation">,</span> Nickname<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>Nickname<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> AppMangerLevel<span class="token punctuation">:</span> constant<span class="token punctuation">.</span>AppAdmin<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	userDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> newmgo<span class="token punctuation">.</span><span class="token function">NewUserMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	cache <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewUserCacheRedis</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span> userDB<span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">GetDefaultOpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	userMongoDB <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewUserMongoDriver</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	database <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">NewUserDatabase</span><span class="token punctuation">(</span>userDB<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userMongoDB<span class="token punctuation">)</span>
	friendRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewFriendRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	groupRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewGroupRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	msgRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewMessageRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	u <span class="token operator">:=</span> <span class="token operator">&amp;</span>userServer<span class="token punctuation">{</span>
		UserDatabase<span class="token punctuation">:</span>             database<span class="token punctuation">,</span>
		RegisterCenter<span class="token punctuation">:</span>           client<span class="token punctuation">,</span>
		friendRpcClient<span class="token punctuation">:</span>          <span class="token operator">&amp;</span>friendRpcClient<span class="token punctuation">,</span>
		groupRpcClient<span class="token punctuation">:</span>           <span class="token operator">&amp;</span>groupRpcClient<span class="token punctuation">,</span>
		friendNotificationSender<span class="token punctuation">:</span> notification<span class="token punctuation">.</span><span class="token function">NewFriendNotificationSender</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msgRpcClient<span class="token punctuation">,</span> notification<span class="token punctuation">.</span><span class="token function">WithDBFunc</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span>FindWithError<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		userNotificationSender<span class="token punctuation">:</span>   notification<span class="token punctuation">.</span><span class="token function">NewUserNotificationSender</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msgRpcClient<span class="token punctuation">,</span> notification<span class="token punctuation">.</span><span class="token function">WithUserFunc</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span>FindWithError<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	pbuser<span class="token punctuation">.</span><span class="token function">RegisterUserServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
	<span class="token keyword">return</span> u<span class="token punctuation">.</span>UserDatabase<span class="token punctuation">.</span><span class="token function">InitOnce</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> users<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5E2E\u6211\u6A21\u4EFF\u91CD\u6784 friend \u4EE3\u7801\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func Start(client registry.SvcDiscoveryRegistry, server *grpc.Server) error {
	db, err := relation.NewGormDB()
	if err != nil {
		return err
	}
	if err := db.AutoMigrate(&amp;tablerelation.FriendModel{}, &amp;tablerelation.FriendRequestModel{}, &amp;tablerelation.BlackModel{}); err != nil {
		return err
	}
	rdb, err := cache.NewRedis()
	if err != nil {
		return err
	}
	blackDB := relation.NewBlackGorm(db)
	friendDB := relation.NewFriendGorm(db)
	userRpcClient := rpcclient.NewUserRpcClient(client)
	msgRpcClient := rpcclient.NewMessageRpcClient(client)
	notificationSender := notification.NewFriendNotificationSender(
		&amp;msgRpcClient,
		notification.WithRpcFunc(userRpcClient.GetUsersInfo),
	)
	pbfriend.RegisterFriendServer(server, &amp;friendServer{
		friendDatabase: controller.NewFriendDatabase(
			friendDB,
			relation.NewFriendRequestGorm(db),
			cache.NewFriendCacheRedis(rdb, friendDB, cache.GetDefaultOpt()),
			tx.NewGorm(db),
		),
		blackDatabase: controller.NewBlackDatabase(
			blackDB,
			cache.NewBlackCacheRedis(rdb, blackDB, cache.GetDefaultOpt()),
		),
		userRpcClient:         &amp;userRpcClient,
		notificationSender:    notificationSender,
		RegisterCenter:        client,
		conversationRpcClient: rpcclient.NewConversationRpcClient(client),
	})
	return nil
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7ED9\u51FA\u6539\u8FDB\u540E\u7684\u4EE3\u7801</p><h2 id="\u901F\u8BFB\u4E00\u904D" tabindex="-1"><a class="header-anchor" href="#\u901F\u8BFB\u4E00\u904D" aria-hidden="true">#</a> \u901F\u8BFB\u4E00\u904D</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rpcCmd <span class="token operator">:=</span> cmd<span class="token punctuation">.</span><span class="token function">NewRpcCmd</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>RpcUserServer<span class="token punctuation">)</span>
	rpcCmd<span class="token punctuation">.</span><span class="token function">AddPortFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rpcCmd<span class="token punctuation">.</span><span class="token function">AddPrometheusPortFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> rpcCmd<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> rpcCmd<span class="token punctuation">.</span><span class="token function">StartSvr</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>RpcRegisterName<span class="token punctuation">.</span>OpenImUserName<span class="token punctuation">,</span> user<span class="token punctuation">.</span>Start<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p><strong>\u521B\u5EFARPC\u547D\u4EE4\u5BF9\u8C61</strong>:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rpcCmd := cmd.NewRpcCmd(cmd.RpcUserServer)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8FD9\u884C\u4EE3\u7801\u8C03\u7528\u4E86<code>cmd</code>\u5305\u4E2D\u7684<code>NewRpcCmd</code>\u51FD\u6570\uFF0C\u521B\u5EFA\u4E86\u4E00\u4E2ARPC\u547D\u4EE4\u5BF9\u8C61\u3002\u4F20\u9012\u7ED9\u8FD9\u4E2A\u51FD\u6570\u7684\u53C2\u6570<code>cmd.RpcUserServer</code>\u53EF\u80FD\u662F\u4E00\u4E2A\u914D\u7F6E\u6216\u8005\u5E38\u91CF\uFF0C\u7528\u4E8E\u6307\u5B9ARPC\u670D\u52A1\u7684\u7C7B\u578B\u6216\u914D\u7F6E\u3002</p></li><li><p><strong>\u6DFB\u52A0\u7AEF\u53E3\u6807\u5FD7</strong>:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rpcCmd.AddPortFlag()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8FD9\u884C\u4EE3\u7801\u5BF9<code>rpcCmd</code>\u5BF9\u8C61\u8C03\u7528<code>AddPortFlag</code>\u65B9\u6CD5\u3002\u8FD9\u4E2A\u65B9\u6CD5\u53EF\u80FD\u7528\u4E8E\u6DFB\u52A0\u6216\u914D\u7F6E\u4E0ERPC\u670D\u52A1\u76D1\u542C\u7AEF\u53E3\u76F8\u5173\u7684\u547D\u4EE4\u884C\u53C2\u6570\u3002</p></li><li><p><strong>\u6DFB\u52A0\u666E\u7F57\u7C73\u4FEE\u65AF\u7AEF\u53E3\u6807\u5FD7</strong>:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rpcCmd.AddPrometheusPortFlag()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u7C7B\u4F3C\u4E8E\u4E0A\u9762\u7684\u7AEF\u53E3\u6807\u5FD7\u6DFB\u52A0\uFF0C\u8FD9\u884C\u4EE3\u7801\u53EF\u80FD\u662F\u4E3A\u4E86\u914D\u7F6EPrometheus\uFF08\u4E00\u4E2A\u5F00\u6E90\u76D1\u63A7\u7CFB\u7EDF\uFF09\u7AEF\u53E3\u7684\u76F8\u5173\u53C2\u6570\u3002</p></li><li><p><strong>\u6267\u884CRPC\u547D\u4EE4</strong>:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>if err := rpcCmd.Exec(); err != nil {
    panic(err.Error())
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u8FD9\u91CC\uFF0C<code>Exec</code>\u65B9\u6CD5\u88AB\u8C03\u7528\u4EE5\u6267\u884CRPC\u547D\u4EE4\u3002\u5982\u679C\u6267\u884C\u4E2D\u51FA\u73B0\u9519\u8BEF\uFF0C\u7A0B\u5E8F\u4F1A\u89E6\u53D1panic\uFF0C\u6253\u5370\u9519\u8BEF\u4FE1\u606F\u5E76\u7EC8\u6B62\u3002</p></li><li><p><strong>\u542F\u52A8RPC\u670D\u52A1</strong>:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>if err := rpcCmd.StartSvr(config.Config.RpcRegisterName.OpenImUserName, user.Start); err != nil {
    panic(err.Error())
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u540E\uFF0C<code>StartSvr</code>\u65B9\u6CD5\u88AB\u8C03\u7528\u6765\u542F\u52A8RPC\u670D\u52A1\u3002\u8FD9\u4E2A\u65B9\u6CD5\u63A5\u53D7\u4E24\u4E2A\u53C2\u6570\uFF1A\u4E00\u662F\u914D\u7F6E\u4E2D\u7684RPC\u6CE8\u518C\u540D\uFF08\u53EF\u80FD\u662F\u670D\u52A1\u540D\u79F0\uFF09\uFF0C\u4E8C\u662F\u542F\u52A8\u670D\u52A1\u65F6\u8C03\u7528\u7684\u51FD\u6570\uFF08\u5728\u8FD9\u4E2A\u4F8B\u5B50\u4E2D\u662F<code>user.Start</code>\uFF09\u3002</p></li></ol><p><strong>\u7EE7\u7EED\u6765\u770B\u542F\u52A8\u51FD\u6570\uFF1A</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>client registry<span class="token punctuation">.</span>SvcDiscoveryRegistry<span class="token punctuation">,</span> server <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	rdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	mongo<span class="token punctuation">,</span> err <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tablerelation<span class="token punctuation">.</span>UserModel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>UserID<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>Nickname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;len(config.Config.Manager.AppManagerUid) != len(config.Config.Manager.Nickname)&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>UserID <span class="token punctuation">{</span>
		users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tablerelation<span class="token punctuation">.</span>UserModel<span class="token punctuation">{</span>UserID<span class="token punctuation">:</span> v<span class="token punctuation">,</span> Nickname<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>Nickname<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> AppMangerLevel<span class="token punctuation">:</span> constant<span class="token punctuation">.</span>AppAdmin<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	userDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewUserMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx2<span class="token punctuation">.</span><span class="token function">NewAuto</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mongo<span class="token punctuation">.</span><span class="token function">GetClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	cache <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewUserCacheRedis</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span> userDB<span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">GetDefaultOpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	userMongoDB <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewUserMongoDriver</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	database <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">NewUserDatabase</span><span class="token punctuation">(</span>userDB<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> userMongoDB<span class="token punctuation">)</span>
	friendRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewFriendRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	groupRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewGroupRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	msgRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewMessageRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	u <span class="token operator">:=</span> <span class="token operator">&amp;</span>userServer<span class="token punctuation">{</span>
		UserDatabase<span class="token punctuation">:</span>             database<span class="token punctuation">,</span>
		RegisterCenter<span class="token punctuation">:</span>           client<span class="token punctuation">,</span>
		friendRpcClient<span class="token punctuation">:</span>          <span class="token operator">&amp;</span>friendRpcClient<span class="token punctuation">,</span>
		groupRpcClient<span class="token punctuation">:</span>           <span class="token operator">&amp;</span>groupRpcClient<span class="token punctuation">,</span>
		friendNotificationSender<span class="token punctuation">:</span> notification<span class="token punctuation">.</span><span class="token function">NewFriendNotificationSender</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msgRpcClient<span class="token punctuation">,</span> notification<span class="token punctuation">.</span><span class="token function">WithDBFunc</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span>FindWithError<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		userNotificationSender<span class="token punctuation">:</span>   notification<span class="token punctuation">.</span><span class="token function">NewUserNotificationSender</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msgRpcClient<span class="token punctuation">,</span> notification<span class="token punctuation">.</span><span class="token function">WithUserFunc</span><span class="token punctuation">(</span>database<span class="token punctuation">.</span>FindWithError<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	pbuser<span class="token punctuation">.</span><span class="token function">RegisterUserServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
	<span class="token keyword">return</span> u<span class="token punctuation">.</span>UserDatabase<span class="token punctuation">.</span><span class="token function">InitOnce</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> users<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p><strong>\u521D\u59CB\u5316\u7F13\u5B58\u548C\u6570\u636E\u5E93\u8FDE\u63A5</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>coderdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mongo<span class="token punctuation">,</span> err <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u4E24\u884C\u4EE3\u7801\u5206\u522B\u521D\u59CB\u5316Redis\u7F13\u5B58\u548CMongo\u6570\u636E\u5E93\u7684\u8FDE\u63A5\u3002\u5982\u679C\u5176\u4E2D\u4EFB\u4F55\u4E00\u4E2A\u521D\u59CB\u5316\u8FC7\u7A0B\u51FA\u73B0\u9519\u8BEF\uFF0C\u51FD\u6570\u5C06\u8FD4\u56DE\u8BE5\u9519\u8BEF\u3002</p></li><li><p><strong>\u914D\u7F6E\u7BA1\u7406\u5458\u7528\u6237</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>tablerelation<span class="token punctuation">.</span>UserModel<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Manager<span class="token punctuation">.</span>UserID <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u6BB5\u4EE3\u7801\u521B\u5EFA\u4E86\u4E00\u4E2A\u7528\u6237\u6A21\u578B\u7684\u5207\u7247\uFF0C\u5E76\u57FA\u4E8E\u914D\u7F6E\u4E2D\u7684\u7BA1\u7406\u5458\u7528\u6237ID\u548C\u6635\u79F0\u586B\u5145\u8FD9\u4E2A\u5207\u7247\u3002\u5B83\u8FD8\u68C0\u67E5ID\u548C\u6635\u79F0\u6570\u91CF\u662F\u5426\u5339\u914D\uFF0C\u4E0D\u5339\u914D\u5219\u8FD4\u56DE\u9519\u8BEF\u3002</p></li><li><p><strong>\u521B\u5EFA\u6570\u636E\u5E93\u548C\u4E8B\u52A1\u5B9E\u4F8B</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>userDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewUserMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx2<span class="token punctuation">.</span><span class="token function">NewAuto</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mongo<span class="token punctuation">.</span><span class="token function">GetClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u521D\u59CB\u5316\u4E86\u7528\u6237\u6570\u636E\u5E93\u7684Mongo\u5B9E\u4F8B\u548C\u4E00\u4E2A\u81EA\u52A8\u4E8B\u52A1\u5904\u7406\u5668\u3002</p></li><li><p><strong>\u521B\u5EFA\u7F13\u5B58\u548C\u6570\u636E\u5E93\u8BBF\u95EE\u5C42</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>cache <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewUserCacheRedis</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span> userDB<span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">GetDefaultOpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
userMongoDB <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewUserMongoDriver</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
database <span class="token operator">:=</span> controller<span class="token punctuation">.</span><span class="token function">NewUserDatabase</span><span class="token punctuation">(</span>userDB<span class="token punctuation">,</span> cache<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> userMongoDB<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u90E8\u5206\u4EE3\u7801\u8BBE\u7F6E\u4E86\u7528\u6237\u7F13\u5B58\uFF0C\u5E76\u521B\u5EFA\u4E86\u4E00\u4E2A\u6570\u636E\u5E93\u8BBF\u95EE\u5C42\uFF0C\u5B83\u7ED3\u5408\u4E86Redis\u7F13\u5B58\u3001Mongo\u6570\u636E\u5E93\u548C\u4E8B\u52A1\u5904\u7406\u5668\u3002</p></li><li><p><strong>\u521D\u59CB\u5316RPC\u5BA2\u6237\u7AEF</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>friendRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewFriendRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
groupRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewGroupRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
msgRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewMessageRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u521B\u5EFA\u4E86\u51E0\u4E2ARPC\u5BA2\u6237\u7AEF\uFF0C\u7528\u4E8E\u4E0E\u5176\u4ED6\u670D\u52A1\uFF08\u5982\u670B\u53CB\u670D\u52A1\u3001\u7FA4\u7EC4\u670D\u52A1\u548C\u6D88\u606F\u670D\u52A1\uFF09\u8FDB\u884C\u901A\u4FE1\u3002</p></li><li><p><strong>\u914D\u7F6E\u7528\u6237\u670D\u52A1</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>u <span class="token operator">:=</span> <span class="token operator">&amp;</span>userServer<span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u8FD9\u4E00\u6B65\uFF0C\u521B\u5EFA\u4E86\u4E00\u4E2A<code>userServer</code>\u5B9E\u4F8B\uFF0C\u5B83\u5C01\u88C5\u4E86\u4E0A\u9762\u521B\u5EFA\u7684\u6240\u6709\u7EC4\u4EF6\u548C\u670D\u52A1\u3002</p></li><li><p><strong>\u6CE8\u518CRPC\u670D\u52A1\u548C\u521D\u59CB\u5316\u6570\u636E\u5E93</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>pbuser<span class="token punctuation">.</span><span class="token function">RegisterUserServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
<span class="token keyword">return</span> u<span class="token punctuation">.</span>UserDatabase<span class="token punctuation">.</span><span class="token function">InitOnce</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> users<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u540E\uFF0C\u8FD9\u4E2A<code>userServer</code>\u5B9E\u4F8B\u88AB\u6CE8\u518C\u4E3A\u4E00\u4E2ARPC\u670D\u52A1\uFF0C\u5E76\u4E14\u8C03\u7528<code>InitOnce</code>\u65B9\u6CD5\u6765\u521D\u59CB\u5316\u7528\u6237\u6570\u636E\u5E93\u3002</p></li></ol><p><strong>Third</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>client discoveryregistry<span class="token punctuation">.</span>SvcDiscoveryRegistry<span class="token punctuation">,</span> server <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	mongo<span class="token punctuation">,</span> err <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	logdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewLogMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	s3db<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewS3Mongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	apiURL <span class="token operator">:=</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Object<span class="token punctuation">.</span>ApiURL
	<span class="token keyword">if</span> apiURL <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;api url is empty&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Object<span class="token punctuation">.</span>ApiURL<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> apiURL<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>apiURL<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">&#39;/&#39;</span> <span class="token punctuation">{</span>
		apiURL <span class="token operator">+=</span> <span class="token string">&quot;/&quot;</span>
	<span class="token punctuation">}</span>
	apiURL <span class="token operator">+=</span> <span class="token string">&quot;object/&quot;</span>
	rdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// \u6839\u636E\u914D\u7F6E\u6587\u4EF6\u7B56\u7565\u9009\u62E9 oss \u65B9\u5F0F</span>
	enable <span class="token operator">:=</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Object<span class="token punctuation">.</span>Enable
	<span class="token keyword">var</span> o s3<span class="token punctuation">.</span>Interface
	<span class="token keyword">switch</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Object<span class="token punctuation">.</span>Enable <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token string">&quot;minio&quot;</span><span class="token punctuation">:</span>
		o<span class="token punctuation">,</span> err <span class="token operator">=</span> minio<span class="token punctuation">.</span><span class="token function">NewMinio</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">NewMinioCache</span><span class="token punctuation">(</span>rdb<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token string">&quot;cos&quot;</span><span class="token punctuation">:</span>
		o<span class="token punctuation">,</span> err <span class="token operator">=</span> cos<span class="token punctuation">.</span><span class="token function">NewCos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token string">&quot;oss&quot;</span><span class="token punctuation">:</span>
		o<span class="token punctuation">,</span> err <span class="token operator">=</span> oss<span class="token punctuation">.</span><span class="token function">NewOSS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid object enable: %s&quot;</span><span class="token punctuation">,</span> enable<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	third<span class="token punctuation">.</span><span class="token function">RegisterThirdServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thirdServer<span class="token punctuation">{</span>
		apiURL<span class="token punctuation">:</span>        apiURL<span class="token punctuation">,</span>
		thirdDatabase<span class="token punctuation">:</span> controller<span class="token punctuation">.</span><span class="token function">NewThirdDatabase</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">NewMsgCacheModel</span><span class="token punctuation">(</span>rdb<span class="token punctuation">)</span><span class="token punctuation">,</span> logdb<span class="token punctuation">)</span><span class="token punctuation">,</span>
		userRpcClient<span class="token punctuation">:</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewUserRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span>
		s3dataBase<span class="token punctuation">:</span>    controller<span class="token punctuation">.</span><span class="token function">NewS3Database</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span> o<span class="token punctuation">,</span> s3db<span class="token punctuation">)</span><span class="token punctuation">,</span>
		defaultExpire<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Hour <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p><strong>\u521D\u59CB\u5316Mongo\u6570\u636E\u5E93\u8FDE\u63A5</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>mongo<span class="token punctuation">,</span> err <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8FD9\u4E00\u884C\u521D\u59CB\u5316Mongo\u6570\u636E\u5E93\u7684\u8FDE\u63A5\u3002\u5982\u679C\u51FA\u73B0\u9519\u8BEF\uFF0C\u5219\u51FD\u6570\u8FD4\u56DE\u8BE5\u9519\u8BEF\u3002</p></li><li><p><strong>\u521B\u5EFA\u65E5\u5FD7\u548CS3\u6570\u636E\u5E93\u5B9E\u4F8B</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>logdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewLogMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s3db<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewS3Mongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u4E24\u884C\u4EE3\u7801\u5206\u522B\u521D\u59CB\u5316\u65E5\u5FD7\u6570\u636E\u5E93\u548CS3\u6570\u636E\u5E93\u7684\u5B9E\u4F8B\u3002</p></li><li><p><strong>\u914D\u7F6E\u548C\u9A8C\u8BC1API URL</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>apiURL <span class="token operator">:=</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Object<span class="token punctuation">.</span>ApiURL
<span class="token operator">...</span>
<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Object<span class="token punctuation">.</span>ApiURL<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
<span class="token punctuation">}</span>
<span class="token operator">...</span>
apiURL <span class="token operator">+=</span> <span class="token string">&quot;object/&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u90E8\u5206\u4EE3\u7801\u83B7\u53D6API URL\u7684\u914D\u7F6E\uFF0C\u68C0\u67E5\u5176\u6709\u6548\u6027\uFF0C\u5E76\u5BF9\u5176\u8FDB\u884C\u5FC5\u8981\u7684\u683C\u5F0F\u8C03\u6574\u3002</p></li><li><p><strong>\u521D\u59CB\u5316Redis\u7F13\u5B58</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>rdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8FD9\u884C\u4EE3\u7801\u521D\u59CB\u5316Redis\u7F13\u5B58\u3002\u5982\u679C\u521D\u59CB\u5316\u5931\u8D25\uFF0C\u51FD\u6570\u5C06\u8FD4\u56DE\u9519\u8BEF\u3002</p></li><li><p><strong>\u914D\u7F6E\u5BF9\u8C61\u5B58\u50A8\u670D\u52A1\uFF08OSS\uFF09</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> o s3<span class="token punctuation">.</span>Interface
<span class="token keyword">switch</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Object<span class="token punctuation">.</span>Enable <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;minio&quot;</span><span class="token punctuation">:</span>
        <span class="token operator">...</span>
    <span class="token keyword">case</span> <span class="token string">&quot;cos&quot;</span><span class="token punctuation">:</span>
        <span class="token operator">...</span>
    <span class="token keyword">case</span> <span class="token string">&quot;oss&quot;</span><span class="token punctuation">:</span>
        <span class="token operator">...</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6839\u636E\u914D\u7F6E\uFF0C\u8FD9\u6BB5\u4EE3\u7801\u9009\u62E9\u5E76\u521D\u59CB\u5316\u76F8\u5E94\u7684\u5BF9\u8C61\u5B58\u50A8\u670D\u52A1\uFF0C\u4F8B\u5982Minio\u3001COS\u6216OSS\u3002</p></li><li><p><strong>\u6CE8\u518CRPC\u670D\u52A1\u548C\u521D\u59CB\u5316\u6570\u636E\u5E93</strong>:</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>third<span class="token punctuation">.</span><span class="token function">RegisterThirdServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thirdServer<span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u540E\uFF0C\u8FD9\u4E2A<code>thirdServer</code>\u5B9E\u4F8B\u88AB\u6CE8\u518C\u4E3A\u4E00\u4E2ARPC\u670D\u52A1\u3002\u8FD9\u4E2A\u5B9E\u4F8B\u96C6\u6210\u4E86API URL\u3001\u6570\u636E\u5E93\u3001\u7F13\u5B58\u4EE5\u53CA\u7528\u6237RPC\u5BA2\u6237\u7AEF\u3002</p></li></ol><p><strong>Friend:</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Start</span><span class="token punctuation">(</span>client registry<span class="token punctuation">.</span>SvcDiscoveryRegistry<span class="token punctuation">,</span> server <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// Initialize MongoDB</span>
	mongo<span class="token punctuation">,</span> err <span class="token operator">:=</span> unrelation<span class="token punctuation">.</span><span class="token function">NewMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// Initialize Redis</span>
	rdb<span class="token punctuation">,</span> err <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	friendMongoDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewFriendMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	friendRequestMongoDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewFriendRequestMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	blackMongoDB<span class="token punctuation">,</span> err <span class="token operator">:=</span> mgo<span class="token punctuation">.</span><span class="token function">NewBlackMongo</span><span class="token punctuation">(</span>mongo<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token comment">// Initialize RPC clients</span>
	userRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewUserRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
	msgRpcClient <span class="token operator">:=</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewMessageRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>

	<span class="token comment">// Initialize notification sender</span>
	notificationSender <span class="token operator">:=</span> notification<span class="token punctuation">.</span><span class="token function">NewFriendNotificationSender</span><span class="token punctuation">(</span>
		<span class="token operator">&amp;</span>msgRpcClient<span class="token punctuation">,</span>
		notification<span class="token punctuation">.</span><span class="token function">WithRpcFunc</span><span class="token punctuation">(</span>userRpcClient<span class="token punctuation">.</span>GetUsersInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> tx2<span class="token punctuation">.</span><span class="token function">NewAuto</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mongo<span class="token punctuation">.</span><span class="token function">GetClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// Register Friend server with refactored MongoDB and Redis integrations</span>
	pbfriend<span class="token punctuation">.</span><span class="token function">RegisterFriendServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token operator">&amp;</span>friendServer<span class="token punctuation">{</span>
		friendDatabase<span class="token punctuation">:</span> controller<span class="token punctuation">.</span><span class="token function">NewFriendDatabase</span><span class="token punctuation">(</span>
			friendMongoDB<span class="token punctuation">,</span>
			friendRequestMongoDB<span class="token punctuation">,</span>
			cache<span class="token punctuation">.</span><span class="token function">NewFriendCacheRedis</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span> friendMongoDB<span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">GetDefaultOpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			tx<span class="token punctuation">,</span>
		<span class="token punctuation">)</span><span class="token punctuation">,</span>
		blackDatabase<span class="token punctuation">:</span> controller<span class="token punctuation">.</span><span class="token function">NewBlackDatabase</span><span class="token punctuation">(</span>
			blackMongoDB<span class="token punctuation">,</span>
			cache<span class="token punctuation">.</span><span class="token function">NewBlackCacheRedis</span><span class="token punctuation">(</span>rdb<span class="token punctuation">,</span> blackMongoDB<span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">GetDefaultOpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span><span class="token punctuation">,</span>
		userRpcClient<span class="token punctuation">:</span>         <span class="token operator">&amp;</span>userRpcClient<span class="token punctuation">,</span>
		notificationSender<span class="token punctuation">:</span>    notificationSender<span class="token punctuation">,</span>
		RegisterCenter<span class="token punctuation">:</span>        client<span class="token punctuation">,</span>
		conversationRpcClient<span class="token punctuation">:</span> rpcclient<span class="token punctuation">.</span><span class="token function">NewConversationRpcClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><strong>\u521D\u59CB\u5316MongoDB\u548CRedis</strong>: <ul><li>\u8FD9\u90E8\u5206\u4EE3\u7801\u521D\u59CB\u5316MongoDB\u548CRedis\u8FDE\u63A5\u3002MongoDB\u7528\u4E8E\u5B58\u50A8\u6570\u636E\uFF0C\u800CRedis\u53EF\u80FD\u7528\u4E8E\u7F13\u5B58\u4EE5\u63D0\u9AD8\u6027\u80FD\u3002</li></ul></li><li><strong>\u521B\u5EFA\u4E0D\u540C\u7C7B\u578B\u7684MongoDB\u5B9E\u4F8B</strong>: <ul><li><code>friendMongoDB</code>, <code>friendRequestMongoDB</code>, <code>blackMongoDB</code>\u5206\u522B\u521D\u59CB\u5316\u4E86\u9488\u5BF9\u670B\u53CB\u5173\u7CFB\u3001\u670B\u53CB\u8BF7\u6C42\u548C\u9ED1\u540D\u5355\u7684MongoDB\u5B9E\u4F8B\u3002</li></ul></li><li><strong>\u521D\u59CB\u5316RPC\u5BA2\u6237\u7AEF</strong>: <ul><li><code>userRpcClient</code> \u548C <code>msgRpcClient</code> \u5206\u522B\u521D\u59CB\u5316\u4E86\u7528\u6237\u548C\u6D88\u606F\u7684RPC\u5BA2\u6237\u7AEF\uFF0C\u8FD9\u8868\u660E<code>Friend</code>\u670D\u52A1\u9700\u8981\u4E0E\u7528\u6237\u670D\u52A1\u548C\u6D88\u606F\u670D\u52A1\u8FDB\u884C\u901A\u4FE1\u3002</li></ul></li><li><strong>\u521D\u59CB\u5316\u901A\u77E5\u53D1\u9001\u5668</strong>: <ul><li><code>notificationSender</code> \u521D\u59CB\u5316\u4E86\u4E00\u4E2A\u670B\u53CB\u901A\u77E5\u53D1\u9001\u5668\uFF0C\u5B83\u53EF\u80FD\u7528\u4E8E\u5728\u670B\u53CB\u5173\u7CFB\u7684\u5404\u79CD\u64CD\u4F5C\uFF08\u5982\u6DFB\u52A0\u670B\u53CB\u3001\u670B\u53CB\u8BF7\u6C42\u7B49\uFF09\u65F6\u53D1\u9001\u901A\u77E5\u3002</li></ul></li><li><strong>\u521D\u59CB\u5316\u4E8B\u52A1\u5904\u7406\u5668</strong>: <ul><li><code>tx</code> \u8868\u793A\u4E00\u4E2A\u81EA\u52A8\u4E8B\u52A1\u5904\u7406\u5668\uFF0C\u5B83\u53EF\u80FD\u7528\u4E8E\u5904\u7406\u6D89\u53CA\u591A\u4E2A\u6570\u636E\u5E93\u64CD\u4F5C\u7684\u590D\u6742\u4E8B\u52A1\u3002</li></ul></li><li><strong>\u6CE8\u518CFriend\u670D\u52A1</strong>: <ul><li><code>pbfriend.RegisterFriendServer</code> \u8FD9\u884C\u4EE3\u7801\u5C06<code>friendServer</code>\u5B9E\u4F8B\u6CE8\u518C\u4E3A\u4E00\u4E2AgRPC\u670D\u52A1\u3002\u8FD9\u4E2A\u670D\u52A1\u5305\u62EC\u670B\u53CB\u6570\u636E\u5E93\u3001\u9ED1\u540D\u5355\u6570\u636E\u5E93\u3001RPC\u5BA2\u6237\u7AEF\u4EE5\u53CA\u901A\u77E5\u53D1\u9001\u5668\u3002</li></ul></li><li><strong>\u670D\u52A1\u529F\u80FD</strong>: <ul><li>\u6839\u636E\u8FD9\u6BB5\u4EE3\u7801\uFF0C<code>Friend</code>\u670D\u52A1\u53EF\u80FD\u8D1F\u8D23\u7BA1\u7406\u7528\u6237\u95F4\u7684\u670B\u53CB\u5173\u7CFB\uFF0C\u5904\u7406\u670B\u53CB\u8BF7\u6C42\uFF0C\u7EF4\u62A4\u9ED1\u540D\u5355\uFF0C\u4EE5\u53CA\u5904\u7406\u4E0E\u8FD9\u4E9B\u529F\u80FD\u76F8\u5173\u7684\u901A\u77E5\u548C\u901A\u4FE1\u3002</li></ul></li></ol><p>\u603B\u4F53\u6765\u770B\uFF0C<code>Friend</code>\u670D\u52A1\u4F3C\u4E4E\u662F\u4E00\u4E2A\u4E13\u95E8\u5904\u7406\u7528\u6237\u793E\u4EA4\u5173\u7CFB\uFF08\u5982\u670B\u53CB\u5173\u7CFB\u3001\u670B\u53CB\u8BF7\u6C42\u548C\u9ED1\u540D\u5355\uFF09\u7684\u540E\u7AEF\u670D\u52A1\u3002\u5B83\u901A\u8FC7RPC\u5BA2\u6237\u7AEF\u4E0E\u5176\u4ED6\u670D\u52A1\uFF08\u5982\u7528\u6237\u670D\u52A1\u548C\u6D88\u606F\u670D\u52A1\uFF09\u4EA4\u4E92\uFF0C\u5E76\u5229\u7528MongoDB\u548CRedis\u8FDB\u884C\u6570\u636E\u5B58\u50A8\u548C\u7F13\u5B58\u7BA1\u7406\u3002\u8FD9\u6837\u7684\u670D\u52A1\u5BF9\u4E8E\u793E\u4EA4\u7F51\u7EDC\u3001\u901A\u8BAF\u5E94\u7528\u6216\u4EFB\u4F55\u6D89\u53CA\u7528\u6237\u95F4\u4EA4\u4E92\u7684\u5E73\u53F0\u6765\u8BF4\u90FD\u662F\u975E\u5E38\u91CD\u8981\u7684\u3002</p><p><strong>\u7EE7\u7EED\u89E3\u8BFB\uFF1A</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// NewUserRpcClient initializes a UserRpcClient based on the provided service discovery registry.</span>
<span class="token keyword">func</span> <span class="token function">NewUserRpcClient</span><span class="token punctuation">(</span>client discoveryregistry<span class="token punctuation">.</span>SvcDiscoveryRegistry<span class="token punctuation">)</span> UserRpcClient <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">UserRpcClient</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token function">NewUser</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// UserRpcClient represents the structure for a User RPC client.</span>
<span class="token keyword">type</span> UserRpcClient User

<span class="token comment">// NewUser initializes and returns a User instance based on the provided service discovery registry.</span>
<span class="token keyword">func</span> <span class="token function">NewUser</span><span class="token punctuation">(</span>discov discoveryregistry<span class="token punctuation">.</span>SvcDiscoveryRegistry<span class="token punctuation">)</span> <span class="token operator">*</span>User <span class="token punctuation">{</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> discov<span class="token punctuation">.</span><span class="token function">GetConn</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>RpcRegisterName<span class="token punctuation">.</span>OpenImUserName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	client <span class="token operator">:=</span> user<span class="token punctuation">.</span><span class="token function">NewUserClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Discov<span class="token punctuation">:</span> discov<span class="token punctuation">,</span> Client<span class="token punctuation">:</span> client<span class="token punctuation">,</span> conn<span class="token punctuation">:</span> conn<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	conn   grpc<span class="token punctuation">.</span>ClientConnInterface
	Client user<span class="token punctuation">.</span>UserClient
	Discov discoveryregistry<span class="token punctuation">.</span>SvcDiscoveryRegistry
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><strong><code>NewUserRpcClient</code>\u51FD\u6570</strong>: <ul><li>\u8FD9\u4E2A\u51FD\u6570\u63A5\u53D7\u4E00\u4E2A\u670D\u52A1\u53D1\u73B0\u6CE8\u518C\u8868\u5BF9\u8C61\uFF08<code>discoveryregistry.SvcDiscoveryRegistry</code>\uFF09\u3002</li><li>\u5B83\u8C03\u7528<code>NewUser</code>\u51FD\u6570\u6765\u521B\u5EFA\u4E00\u4E2A<code>User</code>\u5B9E\u4F8B\uFF0C\u5E76\u5C06\u5176\u8F6C\u6362\u4E3A<code>UserRpcClient</code>\u7C7B\u578B\u3002</li><li>\u8FD9\u79CD\u8BBE\u8BA1\u6A21\u5F0F\u8868\u660E\uFF0C<code>UserRpcClient</code>\u662F<code>User</code>\u7684\u5305\u88C5\u6216\u522B\u540D\uFF0C\u53EF\u80FD\u7528\u4E8E\u63D0\u4F9B\u66F4\u5177\u4F53\u7684\u6216\u9644\u52A0\u7684\u529F\u80FD\u3002</li></ul></li><li><strong><code>UserRpcClient</code>\u7C7B\u578B</strong>: <ul><li><code>UserRpcClient</code>\u88AB\u5B9A\u4E49\u4E3A<code>User</code>\u7C7B\u578B\u7684\u522B\u540D\u3002</li><li>\u8FD9\u610F\u5473\u7740\u5B83\u7EE7\u627F\u4E86<code>User</code>\u7C7B\u578B\u7684\u6240\u6709\u5B57\u6BB5\u548C\u65B9\u6CD5\uFF0C\u4F46\u4E5F\u53EF\u4EE5\u5B9A\u4E49\u989D\u5916\u7684\u65B9\u6CD5\u6216\u8986\u76D6\u73B0\u6709\u7684\u65B9\u6CD5\u3002</li></ul></li><li><strong><code>NewUser</code>\u51FD\u6570</strong>: <ul><li>\u8FD9\u4E2A\u51FD\u6570\u540C\u6837\u63A5\u53D7\u670D\u52A1\u53D1\u73B0\u6CE8\u518C\u8868\u5BF9\u8C61\u3002</li><li>\u5B83\u4F7F\u7528\u8FD9\u4E2A\u6CE8\u518C\u8868\u6765\u83B7\u53D6\u4E0E\u7528\u6237\u670D\u52A1\u7684\u8FDE\u63A5\uFF08\u901A\u8FC7<code>discov.GetConn</code>\u65B9\u6CD5\uFF09\u3002</li><li>\u5982\u679C\u83B7\u53D6\u8FDE\u63A5\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF\uFF0C\u51FD\u6570\u4F1A\u89E6\u53D1panic\uFF0C\u8FD9\u8868\u660E\u65E0\u6CD5\u8FDE\u63A5\u81F3\u7528\u6237\u670D\u52A1\u662F\u4E00\u4E2A\u4E25\u91CD\u7684\u9519\u8BEF\u60C5\u51B5\u3002</li><li>\u4E00\u65E6\u8FDE\u63A5\u88AB\u5EFA\u7ACB\uFF0C\u5B83\u4F7F\u7528\u8FD9\u4E2A\u8FDE\u63A5\u6765\u521B\u5EFA\u4E00\u4E2AgRPC\u5BA2\u6237\u7AEF\uFF08<code>user.NewUserClient</code>\uFF09\u3002</li></ul></li><li><strong><code>User</code>\u7ED3\u6784\u4F53</strong>: <ul><li><code>User</code>\u7ED3\u6784\u4F53\u5305\u542B\u4E09\u4E2A\u5B57\u6BB5\uFF1A<code>conn</code>\uFF08gRPC\u8FDE\u63A5\uFF09\uFF0C<code>Client</code>\uFF08\u7528\u6237\u670D\u52A1\u7684gRPC\u5BA2\u6237\u7AEF\uFF09\uFF0C\u548C<code>Discov</code>\uFF08\u670D\u52A1\u53D1\u73B0\u6CE8\u518C\u8868\uFF09\u3002</li><li>\u8FD9\u4E2A\u7ED3\u6784\u4F53\u5C01\u88C5\u4E86\u4E0E\u7528\u6237\u670D\u52A1\u901A\u4FE1\u6240\u9700\u7684\u6240\u6709\u5143\u7D20\u3002</li></ul></li></ol><h2 id="s3-\u6A21\u5757\u5B66\u4E60" tabindex="-1"><a class="header-anchor" href="#s3-\u6A21\u5757\u5B66\u4E60" aria-hidden="true">#</a> s3 \u6A21\u5757\u5B66\u4E60</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">CompleteUpload</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> uploadID <span class="token builtin">string</span><span class="token punctuation">,</span> partHashs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>UploadResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> log<span class="token punctuation">.</span><span class="token function">ZDebug</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;return&quot;</span><span class="token punctuation">)</span>
	upload<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">parseMultipartUploadID</span><span class="token punctuation">(</span>uploadID<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> md5Sum <span class="token operator">:=</span> md5<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>partHashs<span class="token punctuation">,</span> partSeparator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>md5Sum<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> upload<span class="token punctuation">.</span>Hash <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;md5 mismatching&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> info<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">StatObject</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">HashPath</span><span class="token punctuation">(</span>upload<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>UploadResult<span class="token punctuation">{</span>
			Key<span class="token punctuation">:</span>  info<span class="token punctuation">.</span>Key<span class="token punctuation">,</span>
			Size<span class="token punctuation">:</span> info<span class="token punctuation">.</span>Size<span class="token punctuation">,</span>
			Hash<span class="token punctuation">:</span> info<span class="token punctuation">.</span>ETag<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">IsNotFound</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	cleanObject <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> cleanObject <span class="token punctuation">{</span>
			<span class="token boolean">_</span> <span class="token operator">=</span> c<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token function">DeleteObject</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> targetKey <span class="token builtin">string</span>
	<span class="token keyword">switch</span> upload<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> UploadTypeMultipart<span class="token punctuation">:</span>
		parts <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>s3<span class="token punctuation">.</span>Part<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>partHashs<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> part <span class="token operator">:=</span> <span class="token keyword">range</span> partHashs <span class="token punctuation">{</span>
			parts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s3<span class="token punctuation">.</span>Part<span class="token punctuation">{</span>
				PartNumber<span class="token punctuation">:</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
				ETag<span class="token punctuation">:</span>       part<span class="token punctuation">,</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// todo: \u9A8C\u8BC1\u5927\u5C0F</span>
		result<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token function">CompleteMultipartUpload</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> upload<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> upload<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> parts<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		targetKey <span class="token operator">=</span> result<span class="token punctuation">.</span>Key
	<span class="token keyword">case</span> UploadTypePresigned<span class="token punctuation">:</span>
		uploadInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">StatObject</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> upload<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		cleanObject<span class="token punctuation">[</span>uploadInfo<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token keyword">if</span> uploadInfo<span class="token punctuation">.</span>Size <span class="token operator">!=</span> upload<span class="token punctuation">.</span>Size <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;upload size mismatching&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		md5Sum <span class="token operator">:=</span> md5<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>uploadInfo<span class="token punctuation">.</span>ETag<span class="token punctuation">}</span><span class="token punctuation">,</span> partSeparator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> md5val <span class="token operator">:=</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>md5Sum<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> md5val <span class="token operator">!=</span> upload<span class="token punctuation">.</span>Hash <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errs<span class="token punctuation">.</span>ErrArgs<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;md5 mismatching %s != %s&quot;</span><span class="token punctuation">,</span> md5val<span class="token punctuation">,</span> upload<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// \u9632\u6B62\u5728\u8FD9\u4E2A\u65F6\u5019\uFF0C\u5E76\u53D1\u64CD\u4F5C\uFF0C\u5BFC\u81F4\u6587\u4EF6\u88AB\u8986\u76D6</span>
		copyInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token function">CopyObject</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> uploadInfo<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> upload<span class="token punctuation">.</span>Key<span class="token operator">+</span><span class="token string">&quot;.&quot;</span><span class="token operator">+</span>c<span class="token punctuation">.</span><span class="token function">UUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		cleanObject<span class="token punctuation">[</span>copyInfo<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token keyword">if</span> copyInfo<span class="token punctuation">.</span>ETag <span class="token operator">!=</span> uploadInfo<span class="token punctuation">.</span>ETag <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;[concurrency]copy md5 mismatching&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		hashCopyInfo<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token function">CopyObject</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> copyInfo<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">HashPath</span><span class="token punctuation">(</span>upload<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">ZInfo</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;hashCopyInfo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%+v&quot;</span><span class="token punctuation">,</span> hashCopyInfo<span class="token punctuation">)</span><span class="token punctuation">)</span>
		targetKey <span class="token operator">=</span> hashCopyInfo<span class="token punctuation">.</span>Key
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;invalid upload id type&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">DelS3Key</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token function">Engine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ExecDel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>UploadResult<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>  targetKey<span class="token punctuation">,</span>
		Size<span class="token punctuation">:</span> upload<span class="token punctuation">.</span>Size<span class="token punctuation">,</span>
		Hash<span class="token punctuation">:</span> upload<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u7B2C\u4E00\u90E8\u5206-\u8DEF\u7531\u5B9A\u4E49" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E00\u90E8\u5206-\u8DEF\u7531\u5B9A\u4E49" aria-hidden="true">#</a> \u7B2C\u4E00\u90E8\u5206\uFF1A\u8DEF\u7531\u5B9A\u4E49</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>objectGroup<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">&quot;/complete_multipart_upload&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>CompleteMultipartUpload<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>\u8FD9\u4E00\u884C\u5B9A\u4E49\u4E86\u4E00\u4E2AHTTP POST\u8DEF\u7531\uFF0C\u5F53\u5BA2\u6237\u7AEF\u5411<code>/complete_multipart_upload</code>\u53D1\u9001POST\u8BF7\u6C42\u65F6\uFF0C\u4F1A\u8C03\u7528<code>CompleteMultipartUpload</code>\u65B9\u6CD5\u3002</li></ul><h3 id="\u7B2C\u4E8C\u90E8\u5206-\u5904\u7406\u8BF7\u6C42" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E8C\u90E8\u5206-\u5904\u7406\u8BF7\u6C42" aria-hidden="true">#</a> \u7B2C\u4E8C\u90E8\u5206\uFF1A\u5904\u7406\u8BF7\u6C42</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>ThirdApi<span class="token punctuation">)</span> <span class="token function">CompleteMultipartUpload</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a2r<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>third<span class="token punctuation">.</span>ThirdClient<span class="token punctuation">.</span>CompleteMultipartUpload<span class="token punctuation">,</span> o<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u8FD9\u4E2A\u51FD\u6570\u662F\u4E00\u4E2A\u8DEF\u7531\u5904\u7406\u5668\uFF0C\u5B83\u4F7F\u7528<code>gin.Context</code>\u6765\u5904\u7406HTTP\u8BF7\u6C42\u3002\u5B83\u8C03\u7528<code>a2r.Call</code>\u65B9\u6CD5\uFF0C\u5C06\u8BF7\u6C42\u8F6C\u53D1\u7ED9\u5B9E\u9645\u5904\u7406\u51FD\u6570\u3002</li></ul><h3 id="\u7B2C\u4E09\u90E8\u5206-\u4E1A\u52A1\u903B\u8F91" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E09\u90E8\u5206-\u4E1A\u52A1\u903B\u8F91" aria-hidden="true">#</a> \u7B2C\u4E09\u90E8\u5206\uFF1A\u4E1A\u52A1\u903B\u8F91</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>thirdServer<span class="token punctuation">)</span> <span class="token function">CompleteMultipartUpload</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>third<span class="token punctuation">.</span>CompleteMultipartUploadReq<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>third<span class="token punctuation">.</span>CompleteMultipartUploadResp<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u8FD9\u662F\u6838\u5FC3\u7684\u4E1A\u52A1\u903B\u8F91\u51FD\u6570\u3002\u5B83\u9996\u5148\u8FDB\u884C\u4E00\u4E9B\u68C0\u67E5\uFF0C\u7136\u540E\u8C03\u7528<code>s3Database</code>\u7684<code>CompleteMultipartUpload</code>\u65B9\u6CD5\u6765\u5B8C\u6210\u4E0A\u4F20\u3002\u63A5\u7740\uFF0C\u5B83\u521B\u5EFA\u4E00\u4E2A\u5BF9\u8C61\u6A21\u578B\u5E76\u4FDD\u5B58\u5230\u6570\u636E\u5E93\u3002\u6700\u540E\u8FD4\u56DE\u4E00\u4E2A\u54CD\u5E94\u3002</li></ul><h3 id="\u7B2C\u56DB\u90E8\u5206-\u5B8C\u6210\u4E0A\u4F20" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u56DB\u90E8\u5206-\u5B8C\u6210\u4E0A\u4F20" aria-hidden="true">#</a> \u7B2C\u56DB\u90E8\u5206\uFF1A\u5B8C\u6210\u4E0A\u4F20</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>s3Database<span class="token punctuation">)</span> <span class="token function">CompleteMultipartUpload</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> uploadID <span class="token builtin">string</span><span class="token punctuation">,</span> parts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>cont<span class="token punctuation">.</span>UploadResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> s<span class="token punctuation">.</span>s3<span class="token punctuation">.</span><span class="token function">CompleteUpload</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> uploadID<span class="token punctuation">,</span> parts<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u8FD9\u4E2A\u51FD\u6570\u5B9E\u9645\u4E0A\u53EA\u662F\u4E00\u4E2A\u7B80\u5355\u7684\u5C01\u88C5\uFF0C\u8C03\u7528\u53E6\u4E00\u4E2A<code>CompleteUpload</code>\u51FD\u6570\u6765\u5B8C\u6210\u4E0A\u4F20\u3002</li></ul><h3 id="\u7B2C\u4E94\u90E8\u5206-\u5B8C\u6210\u4E0A\u4F20\u7684\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#\u7B2C\u4E94\u90E8\u5206-\u5B8C\u6210\u4E0A\u4F20\u7684\u5B9E\u73B0" aria-hidden="true">#</a> \u7B2C\u4E94\u90E8\u5206\uFF1A\u5B8C\u6210\u4E0A\u4F20\u7684\u5B9E\u73B0</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Controller<span class="token punctuation">)</span> <span class="token function">CompleteUpload</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> uploadID <span class="token builtin">string</span><span class="token punctuation">,</span> partHashs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>UploadResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u8FD9\u662F\u4E00\u4E2A\u66F4\u590D\u6742\u7684\u51FD\u6570\uFF0C\u5305\u542B\u5B9E\u9645\u5B8C\u6210\u4E0A\u4F20\u7684\u903B\u8F91\u3002\u5B83\u5904\u7406\u591A\u90E8\u5206\u4E0A\u4F20\u7684\u4E0D\u540C\u573A\u666F\uFF08\u5982\u591A\u90E8\u5206\u4E0A\u4F20\u3001\u9884\u7B7E\u540D\u4E0A\u4F20\u7B49\uFF09\uFF0C\u9A8C\u8BC1MD5\u503C\uFF0C\u5904\u7406\u6587\u4EF6\u590D\u5236\u548C\u79FB\u52A8\uFF0C\u6700\u540E\u8FD4\u56DE\u4E0A\u4F20\u7ED3\u679C\u3002</li></ul><h3 id="\u5173\u952E\u70B9" tabindex="-1"><a class="header-anchor" href="#\u5173\u952E\u70B9" aria-hidden="true">#</a> \u5173\u952E\u70B9</h3><ol><li><strong>\u9519\u8BEF\u5904\u7406</strong>\uFF1A\u5728\u6BCF\u4E2A\u51FD\u6570\u4E2D\uFF0C\u9519\u8BEF\u60C5\u51B5\u90FD\u88AB\u4ED4\u7EC6\u5904\u7406\uFF0C\u5E76\u8FD4\u56DE\u76F8\u5E94\u7684\u9519\u8BEF\u4FE1\u606F\u3002</li><li><strong>MD5\u9A8C\u8BC1</strong>\uFF1A\u4EE3\u7801\u5728\u591A\u4E2A\u5730\u65B9\u9A8C\u8BC1\u4E0A\u4F20\u90E8\u5206\u7684MD5\u54C8\u5E0C\u503C\uFF0C\u786E\u4FDD\u6570\u636E\u7684\u4E00\u81F4\u6027\u548C\u5B8C\u6574\u6027\u3002</li><li><strong>\u5E76\u53D1\u5904\u7406</strong>\uFF1A\u5728\u5904\u7406\u4E0A\u4F20\u7684\u6700\u540E\u9636\u6BB5\uFF0C\u4EE3\u7801\u8003\u8651\u4E86\u5E76\u53D1\u64CD\u4F5C\u7684\u60C5\u51B5\uFF0C\u786E\u4FDD\u6570\u636E\u7684\u4E00\u81F4\u6027\u3002</li></ol><p>\u6574\u4F53\u800C\u8A00\uFF0C\u8FD9\u662F\u4E00\u6BB5\u5904\u7406\u6587\u4EF6\u4E0A\u4F20\u7684\u540E\u7AEF\u670D\u52A1\u4EE3\u7801\uFF0C\u7279\u522B\u5173\u6CE8\u4E8E\u591A\u90E8\u5206\u4E0A\u4F20\u7684\u5B8C\u6210\u548C\u9A8C\u8BC1\u3002\u4EE3\u7801\u7ED3\u6784\u6E05\u6670\uFF0C\u6709\u9002\u5F53\u7684\u9519\u8BEF\u5904\u7406\u548C\u65E5\u5FD7\u8BB0\u5F55\uFF0C\u7B26\u5408\u73B0\u4EE3\u540E\u7AEF\u5F00\u53D1\u7684\u6807\u51C6\u3002</p><h3 id="\u590D\u5236\u5BF9\u8C61\u5B58\u50A8" tabindex="-1"><a class="header-anchor" href="#\u590D\u5236\u5BF9\u8C61\u5B58\u50A8" aria-hidden="true">#</a> \u590D\u5236\u5BF9\u8C61\u5B58\u50A8</h3><p><strong>\u7EE7\u7EED\u5F00\u59CB\u770B\u770B\u590D\u5236\u5BF9\u8C61\u5B58\u50A8\u662F\u5982\u4F55\u505A\u7684\uFF1A</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>OSS<span class="token punctuation">)</span> <span class="token function">CopyObject</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> src <span class="token builtin">string</span><span class="token punctuation">,</span> dst <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>s3<span class="token punctuation">.</span>CopyObjectInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	result<span class="token punctuation">,</span> err <span class="token operator">:=</span> o<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span><span class="token function">CopyObject</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>s3<span class="token punctuation">.</span>CopyObjectInfo<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>  dst<span class="token punctuation">,</span>
		ETag<span class="token punctuation">:</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>ETag<span class="token punctuation">,</span> <span class="token string">\`&quot;\`</span><span class="token punctuation">,</span> <span class="token string">\`\`</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u51FD\u6570\u5B9A\u4E49" tabindex="-1"><a class="header-anchor" href="#\u51FD\u6570\u5B9A\u4E49" aria-hidden="true">#</a> \u51FD\u6570\u5B9A\u4E49</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func (o *OSS) CopyObject(ctx context.Context, src string, dst string) (*s3.CopyObjectInfo, error) {
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><code>o *OSS</code>: \u8FD9\u4E2A\u51FD\u6570\u662F<code>OSS</code>\u7ED3\u6784\u4F53\u7684\u4E00\u4E2A\u65B9\u6CD5\uFF0C\u5176\u4E2D<code>OSS</code>\u53EF\u80FD\u662F\u5BF9\u67D0\u4E2A\u5BF9\u8C61\u5B58\u50A8\u670D\u52A1\u7684\u5C01\u88C5\u3002</li><li><code>ctx context.Context</code>: \u4F20\u5165\u7684\u4E0A\u4E0B\u6587\uFF0C\u7528\u4E8E\u63A7\u5236\u51FD\u6570\u7684\u6267\u884C\u548C\u53D6\u6D88\u3002</li><li><code>src string</code>: \u6E90\u5BF9\u8C61\u7684\u8DEF\u5F84\u6216\u6807\u8BC6\u7B26\u3002</li><li><code>dst string</code>: \u76EE\u6807\u5BF9\u8C61\u7684\u8DEF\u5F84\u6216\u6807\u8BC6\u7B26\u3002</li><li>\u8FD4\u56DE\u503C\uFF1A\u8FD4\u56DE\u4E00\u4E2A\u6307\u5411<code>s3.CopyObjectInfo</code>\u7684\u6307\u9488\u548C\u4E00\u4E2A\u9519\u8BEF\u3002\u5982\u679C\u590D\u5236\u6210\u529F\uFF0C\u9519\u8BEF\u5C06\u662F<code>nil</code>\uFF0C\u5426\u5219\u4F1A\u5305\u542B\u9519\u8BEF\u4FE1\u606F\u3002</li></ul><h3 id="\u51FD\u6570\u4F53" tabindex="-1"><a class="header-anchor" href="#\u51FD\u6570\u4F53" aria-hidden="true">#</a> \u51FD\u6570\u4F53</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>result, err := o.bucket.CopyObject(src, dst)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>\u8FD9\u4E00\u884C\u8C03\u7528<code>o.bucket.CopyObject</code>\u65B9\u6CD5\u6765\u5B9E\u9645\u6267\u884C\u590D\u5236\u64CD\u4F5C\uFF0C\u5176\u4E2D<code>src</code>\u662F\u6E90\u5BF9\u8C61\uFF0C<code>dst</code>\u662F\u76EE\u6807\u5BF9\u8C61\u3002</li><li>\u5982\u679C\u590D\u5236\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF\uFF0C<code>err</code>\u5C06\u88AB\u8D4B\u503C\uFF0C\u5E76\u4E14\u8BE5\u51FD\u6570\u5C06\u8FD4\u56DE\u9519\u8BEF\u3002</li></ul><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>return &amp;s3.CopyObjectInfo{
	Key:  dst,
	ETag: strings.ToLower(strings.ReplaceAll(result.ETag, \`&quot;\`, \`\`)),
}, nil
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u5982\u679C\u590D\u5236\u6210\u529F\uFF0C\u51FD\u6570\u8FD4\u56DE\u4E00\u4E2A\u65B0\u7684<code>s3.CopyObjectInfo</code>\u5B9E\u4F8B\u3002\u8FD9\u4E2A\u5B9E\u4F8B\u5305\u542B\u76EE\u6807\u5BF9\u8C61\u7684\u952E\uFF08<code>Key</code>\uFF09\u548C\u7ECF\u8FC7\u5904\u7406\u7684ETag\u3002</li><li><code>ETag</code>\u662F\u4E00\u79CD\u6807\u8BB0\uFF0C\u901A\u5E38\u7528\u4E8E\u9A8C\u8BC1\u5BF9\u8C61\u7684\u5B8C\u6574\u6027\u3002\u8FD9\u91CC\u7684<code>ETag</code>\u88AB\u8F6C\u6362\u4E3A\u5C0F\u5199\uFF0C\u5E76\u4E14\u53BB\u9664\u4E86\u6240\u6709\u7684\u53CC\u5F15\u53F7\u3002</li></ul><p><strong>Minio</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Minio<span class="token punctuation">)</span> <span class="token function">CopyObject</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> src <span class="token builtin">string</span><span class="token punctuation">,</span> dst <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>s3<span class="token punctuation">.</span>CopyObjectInfo<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">initMinio</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	result<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">CopyObject</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> minio<span class="token punctuation">.</span>CopyDestOptions<span class="token punctuation">{</span>
		Bucket<span class="token punctuation">:</span> m<span class="token punctuation">.</span>bucket<span class="token punctuation">,</span>
		Object<span class="token punctuation">:</span> dst<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> minio<span class="token punctuation">.</span>CopySrcOptions<span class="token punctuation">{</span>
		Bucket<span class="token punctuation">:</span> m<span class="token punctuation">.</span>bucket<span class="token punctuation">,</span>
		Object<span class="token punctuation">:</span> src<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>s3<span class="token punctuation">.</span>CopyObjectInfo<span class="token punctuation">{</span>
		Key<span class="token punctuation">:</span>  dst<span class="token punctuation">,</span>
		ETag<span class="token punctuation">:</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>ETag<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u51FD\u6570\u5B9A\u4E49-1" tabindex="-1"><a class="header-anchor" href="#\u51FD\u6570\u5B9A\u4E49-1" aria-hidden="true">#</a> \u51FD\u6570\u5B9A\u4E49</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>func (m *Minio) CopyObject(ctx context.Context, src string, dst string) (*s3.CopyObjectInfo, error) {
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><code>m *Minio</code>: \u8FD9\u662F<code>Minio</code>\u7ED3\u6784\u4F53\u7684\u4E00\u4E2A\u65B9\u6CD5\u3002<code>Minio</code>\u7ED3\u6784\u4F53\u53EF\u80FD\u4EE3\u8868\u4E86\u5BF9Minio\u670D\u52A1\u7684\u5C01\u88C5\u3002</li><li><code>ctx context.Context</code>: \u4F20\u5165\u7684\u4E0A\u4E0B\u6587\uFF0C\u7528\u4E8E\u63A7\u5236\u51FD\u6570\u7684\u6267\u884C\u548C\u53D6\u6D88\u3002</li><li><code>src string</code>: \u6E90\u5BF9\u8C61\u7684\u8DEF\u5F84\u6216\u6807\u8BC6\u7B26\u3002</li><li><code>dst string</code>: \u76EE\u6807\u5BF9\u8C61\u7684\u8DEF\u5F84\u6216\u6807\u8BC6\u7B26\u3002</li><li>\u8FD4\u56DE\u503C\uFF1A\u8FD4\u56DE\u4E00\u4E2A\u6307\u5411<code>s3.CopyObjectInfo</code>\u7684\u6307\u9488\u548C\u4E00\u4E2A\u9519\u8BEF\u3002\u5982\u679C\u590D\u5236\u6210\u529F\uFF0C\u9519\u8BEF\u5C06\u662F<code>nil</code>\uFF0C\u5426\u5219\u4F1A\u5305\u542B\u9519\u8BEF\u4FE1\u606F\u3002</li></ul><h3 id="\u51FD\u6570\u4F53-1" tabindex="-1"><a class="header-anchor" href="#\u51FD\u6570\u4F53-1" aria-hidden="true">#</a> \u51FD\u6570\u4F53</h3><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">initMinio</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u8FD9\u4E00\u884C\u8C03\u7528<code>m.initMinio</code>\u65B9\u6CD5\u6765\u521D\u59CB\u5316Minio\u5BA2\u6237\u7AEF\u3002\u5982\u679C\u521D\u59CB\u5316\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF\uFF0C\u5C06\u8FD4\u56DE\u9519\u8BEF\u3002</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>result<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Client<span class="token punctuation">.</span><span class="token function">CopyObject</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> minio<span class="token punctuation">.</span>CopyDestOptions<span class="token punctuation">{</span>
	Bucket<span class="token punctuation">:</span> m<span class="token punctuation">.</span>bucket<span class="token punctuation">,</span>
	Object<span class="token punctuation">:</span> dst<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> minio<span class="token punctuation">.</span>CopySrcOptions<span class="token punctuation">{</span>
	Bucket<span class="token punctuation">:</span> m<span class="token punctuation">.</span>bucket<span class="token punctuation">,</span>
	Object<span class="token punctuation">:</span> src<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u8FD9\u91CC\u5B9E\u9645\u6267\u884C\u590D\u5236\u64CD\u4F5C\uFF0C\u4F7F\u7528<code>CopyObject</code>\u65B9\u6CD5\u3002\u65B9\u6CD5\u63A5\u53D7\u76EE\u6807\u548C\u6E90\u7684\u9009\u9879\uFF0C\u5305\u62EC\u5B58\u50A8\u6876\u540D\u79F0\uFF08<code>Bucket</code>\uFF09\u548C\u5BF9\u8C61\u540D\u79F0\uFF08<code>Object</code>\uFF09\u3002</li><li>\u5982\u679C\u590D\u5236\u8FC7\u7A0B\u4E2D\u53D1\u751F\u9519\u8BEF\uFF0C<code>err</code>\u5C06\u88AB\u8D4B\u503C\uFF0C\u5E76\u4E14\u8BE5\u51FD\u6570\u5C06\u8FD4\u56DE\u9519\u8BEF\u3002</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">return</span> <span class="token operator">&amp;</span>s3<span class="token punctuation">.</span>CopyObjectInfo<span class="token punctuation">{</span>
	Key<span class="token punctuation">:</span>  dst<span class="token punctuation">,</span>
	ETag<span class="token punctuation">:</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>ETag<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u5982\u679C\u590D\u5236\u6210\u529F\uFF0C\u51FD\u6570\u8FD4\u56DE\u4E00\u4E2A\u65B0\u7684<code>s3.CopyObjectInfo</code>\u5B9E\u4F8B\u3002\u8FD9\u4E2A\u5B9E\u4F8B\u5305\u542B\u76EE\u6807\u5BF9\u8C61\u7684\u952E\uFF08<code>Key</code>\uFF09\u548CETag\uFF08\u7528\u4E8E\u9A8C\u8BC1\u5BF9\u8C61\u7684\u5B8C\u6574\u6027\uFF09\u3002</li><li><code>ETag</code>\u88AB\u8F6C\u6362\u4E3A\u5C0F\u5199\u3002</li></ul>`,147),o=[p];function c(i,l){return s(),a("div",null,o)}const r=n(e,[["render",c],["__file","157.html.vue"]]);export{r as default};
